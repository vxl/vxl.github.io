<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
"http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
  <title>contrib/brl/bseg/sdet/sdet_nms.cxx Source File</title>
  <link href="doxygen.css" rel="stylesheet" type="text/css" />
  <link href="tabs.css" rel="stylesheet" type="text/css" />
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
</head>
<body>
<!-- Generated by Doxygen 1.7.5.1 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<div class="title">contrib/brl/bseg/sdet/sdet_nms.cxx</div>  </div>
</div>
<div class="contents">
<a href="sdet__nms_8cxx.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">// This is brl/bseg/sdet/sdet_nms.cxx</span>
<a name="l00002"></a>00002 <span class="preprocessor">#include &quot;<a class="code" href="sdet__nms_8h.html" title="A NMS class that can work with the sdet_edge_map class.">sdet_nms.h</a>&quot;</span>
<a name="l00003"></a>00003 <span class="comment">//:</span>
<a name="l00004"></a>00004 <span class="comment">// \file</span>
<a name="l00005"></a>00005 
<a name="l00006"></a>00006 <span class="preprocessor">#include &lt;vcl_cstdio.h&gt;</span>
<a name="l00007"></a>00007 <span class="preprocessor">#include &lt;vcl_cstdlib.h&gt;</span>   <span class="comment">// for vcl_abs(int) and vcl_sqrt()</span>
<a name="l00008"></a>00008 <span class="preprocessor">#include &lt;<a class="codeRef" doxygen="core_vnl.tag:../../../../../core/vnl/html" href="../../../../../core/vnl/html/vnl__matrix_8h.html">vnl/vnl_matrix.h</a>&gt;</span>
<a name="l00009"></a>00009 <span class="preprocessor">#include &lt;<a class="codeRef" doxygen="core_vnl.tag:../../../../../core/vnl/html" href="../../../../../core/vnl/html/vnl__svd_8h.html">vnl/algo/vnl_svd.h</a>&gt;</span>
<a name="l00010"></a>00010 <span class="preprocessor">#include &lt;<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/vgl__homg__point__2d_8h.html">vgl/vgl_homg_point_2d.h</a>&gt;</span>
<a name="l00011"></a>00011 <span class="preprocessor">#include &lt;<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/vgl__homg__line__2d_8h.html">vgl/vgl_homg_line_2d.h</a>&gt;</span>
<a name="l00012"></a>00012 <span class="preprocessor">#include &lt;<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/vgl__homg__operators__2d_8h.html">vgl/algo/vgl_homg_operators_2d.h</a>&gt;</span>
<a name="l00013"></a>00013 
<a name="l00014"></a>00014 <span class="comment">//---------------------------------------------------------------</span>
<a name="l00015"></a>00015 <span class="comment">// Constructors</span>
<a name="l00016"></a>00016 <span class="comment">//----------------------------------------------------------------</span>
<a name="l00017"></a>00017 
<a name="l00018"></a>00018 <span class="comment">//: default constructor</span>
<a name="l00019"></a><a class="code" href="classsdet__nms.html#ab5a48877d468ab0b38815be088d86a1a">00019</a> <a class="code" href="classsdet__nms.html#ab5a48877d468ab0b38815be088d86a1a" title="default constructor is not to be used.">sdet_nms::sdet_nms</a>():
<a name="l00020"></a>00020   thresh_(0.0),
<a name="l00021"></a>00021   parabola_fit_type_(<a class="code" href="classsdet__nms__params.html" title="parameters for NMS.">sdet_nms_params</a>::<a class="code" href="sdet__nonmax__suppression__params_8h.html#a06fc87d81c62e9abb8790b6e5713c55bafb488edc0e87e30eaa16d650452b83b5">PFIT_3_POINTS</a>),
<a name="l00022"></a>00022   margin_(1),
<a name="l00023"></a>00023   rel_thresh_(2.5),
<a name="l00024"></a>00024   use_adaptive_thresh_(true),
<a name="l00025"></a>00025   dir_x_(<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view</a>&lt;double&gt;(0,0,1)), <span class="comment">// FIXME: this does not make sense: reference member is initialized to a temporary that doesn&#39;t persist after the constructor exits</span>
<a name="l00026"></a>00026   dir_y_(<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view</a>&lt;double&gt;(0,0,1)), <span class="comment">// idem</span>
<a name="l00027"></a>00027   grad_mag_(<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view</a>&lt;double&gt;(0,0,1)), <span class="comment">// idem</span>
<a name="l00028"></a>00028   x_(0,0, 0.0),
<a name="l00029"></a>00029   y_(0,0, 0.0),
<a name="l00030"></a>00030   dir_(0,0, 0.0),
<a name="l00031"></a>00031   mag_(0,0, 0.0),
<a name="l00032"></a>00032   deriv_(0,0, 0.0)
<a name="l00033"></a>00033 {
<a name="l00034"></a>00034 }
<a name="l00035"></a>00035 
<a name="l00036"></a>00036 <span class="comment">//: Constructor from a parameter block, gradient magnitudes given as an image and directions given as component image</span>
<a name="l00037"></a><a class="code" href="classsdet__nms.html#a5d4752802e569797411a030258c3d854">00037</a> <a class="code" href="classsdet__nms.html#ab5a48877d468ab0b38815be088d86a1a" title="default constructor is not to be used.">sdet_nms::sdet_nms</a>(<span class="keyword">const</span> <a class="code" href="classsdet__nms__params.html" title="parameters for NMS.">sdet_nms_params</a>&amp; nsp, <span class="keyword">const</span> <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;double&gt;</a>&amp; dir_x,
<a name="l00038"></a>00038                    <span class="keyword">const</span> <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;double&gt;</a>&amp; dir_y, <span class="keyword">const</span> <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;double&gt;</a>&amp; grad_mag) :
<a name="l00039"></a>00039   thresh_(nsp.thresh_),
<a name="l00040"></a>00040   parabola_fit_type_(nsp.pfit_type_),
<a name="l00041"></a>00041   margin_(nsp.margin_),
<a name="l00042"></a>00042   rel_thresh_(nsp.rel_thresh_),
<a name="l00043"></a>00043   use_adaptive_thresh_(nsp.use_adaptive_thresh_),
<a name="l00044"></a>00044   dir_x_(dir_x),
<a name="l00045"></a>00045   dir_y_(dir_y),
<a name="l00046"></a>00046   grad_mag_(grad_mag),
<a name="l00047"></a>00047   x_(grad_mag.nj(), grad_mag.ni(), 0.0),
<a name="l00048"></a>00048   y_(grad_mag.nj(), grad_mag.ni(), 0.0),
<a name="l00049"></a>00049   dir_(grad_mag.nj(), grad_mag.ni(), 0.0),
<a name="l00050"></a>00050   mag_(grad_mag.nj(), grad_mag.ni(), 0.0),
<a name="l00051"></a>00051   deriv_(grad_mag.nj(), grad_mag.ni(), 0.0)
<a name="l00052"></a>00052 {
<a name="l00053"></a>00053 }
<a name="l00054"></a>00054 
<a name="l00055"></a>00055 <span class="comment">//-------------------------------------------------------------------------</span>
<a name="l00056"></a>00056 
<a name="l00057"></a>00057 <span class="comment">// backward compatible method</span>
<a name="l00058"></a><a class="code" href="classsdet__nms.html#a0060fdc3ef36abe52460c27f043e8e53">00058</a> <span class="keywordtype">void</span> <a class="code" href="classsdet__nms.html#ad2cfa41ea595356d461b5a98638c9ff7" title="apply NMS to the given data (do not collect any edgel tokens).">sdet_nms::apply</a>(<span class="keywordtype">bool</span> collect_tokens,
<a name="l00059"></a>00059                      vcl_vector&lt;<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__point__2d.html">vgl_point_2d&lt;double&gt;</a> &gt;&amp; loc,
<a name="l00060"></a>00060                      vcl_vector&lt;double&gt;&amp; orientation,
<a name="l00061"></a>00061                      vcl_vector&lt;double&gt;&amp; mag)
<a name="l00062"></a>00062 {
<a name="l00063"></a>00063   vcl_vector&lt;double&gt; d2f;
<a name="l00064"></a>00064   vcl_vector&lt;vgl_point_2d&lt;int&gt; &gt; pix_loc;
<a name="l00065"></a>00065 
<a name="l00066"></a>00066   <span class="comment">//call the main method</span>
<a name="l00067"></a>00067   <a class="code" href="classsdet__nms.html#ad2cfa41ea595356d461b5a98638c9ff7" title="apply NMS to the given data (do not collect any edgel tokens).">apply</a>(collect_tokens, loc, orientation, mag, d2f, pix_loc);
<a name="l00068"></a>00068 }
<a name="l00069"></a>00069 
<a name="l00070"></a><a class="code" href="classsdet__nms.html#aa98b25d2949062370a8da4a0b834dc74">00070</a> <span class="keywordtype">void</span> <a class="code" href="classsdet__nms.html#ad2cfa41ea595356d461b5a98638c9ff7" title="apply NMS to the given data (do not collect any edgel tokens).">sdet_nms::apply</a>(<span class="keywordtype">bool</span> collect_tokens,
<a name="l00071"></a>00071                      vcl_vector&lt;<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__point__2d.html">vgl_point_2d&lt;double&gt;</a> &gt;&amp; loc,
<a name="l00072"></a>00072                      vcl_vector&lt;double&gt;&amp; orientation,
<a name="l00073"></a>00073                      vcl_vector&lt;double&gt;&amp; mag,
<a name="l00074"></a>00074                      vcl_vector&lt;double&gt;&amp; d2f)
<a name="l00075"></a>00075 {
<a name="l00076"></a>00076   vcl_vector&lt;vgl_point_2d&lt;int&gt; &gt; pix_loc;
<a name="l00077"></a>00077 
<a name="l00078"></a>00078   <span class="comment">//call the main method</span>
<a name="l00079"></a>00079   <a class="code" href="classsdet__nms.html#ad2cfa41ea595356d461b5a98638c9ff7" title="apply NMS to the given data (do not collect any edgel tokens).">apply</a>(collect_tokens, loc, orientation, mag, d2f, pix_loc);
<a name="l00080"></a>00080 }
<a name="l00081"></a>00081 
<a name="l00082"></a>00082 <span class="comment">//: Apply the algorithm</span>
<a name="l00083"></a><a class="code" href="classsdet__nms.html#a8b437818bda073feb7da3dab8b467dea">00083</a> <span class="keywordtype">void</span> <a class="code" href="classsdet__nms.html#ad2cfa41ea595356d461b5a98638c9ff7" title="apply NMS to the given data (do not collect any edgel tokens).">sdet_nms::apply</a>(<span class="keywordtype">bool</span> collect_tokens,
<a name="l00084"></a>00084                      vcl_vector&lt;<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__point__2d.html">vgl_point_2d&lt;double&gt;</a> &gt;&amp; loc,
<a name="l00085"></a>00085                      vcl_vector&lt;double&gt;&amp; orientation,
<a name="l00086"></a>00086                      vcl_vector&lt;double&gt;&amp; mag,
<a name="l00087"></a>00087                      vcl_vector&lt;double&gt;&amp; d2f,
<a name="l00088"></a>00088                      vcl_vector&lt;<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__point__2d.html">vgl_point_2d&lt;int&gt;</a> &gt;&amp; pix_loc)
<a name="l00089"></a>00089 {
<a name="l00090"></a>00090   <span class="keywordtype">double</span> f[3], s_list[3];
<a name="l00091"></a>00091 
<a name="l00092"></a>00092   <span class="comment">// run non-maximum suppression at every point inside the margins</span>
<a name="l00093"></a>00093   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> x = <a class="code" href="classsdet__nms.html#a71dcb6c967f178ff0fe5402cbf3acb52" title="margin size">margin_</a>; x &lt; <a class="code" href="classsdet__nms.html#ab6c1588de9f147ef6348cb3f25a5982a">grad_mag_</a>.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a9ea9ad565387a61dccf38fc80a266c2a">ni</a>()-<a class="code" href="classsdet__nms.html#a71dcb6c967f178ff0fe5402cbf3acb52" title="margin size">margin_</a>; x++) {
<a name="l00094"></a>00094     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> y = <a class="code" href="classsdet__nms.html#a71dcb6c967f178ff0fe5402cbf3acb52" title="margin size">margin_</a>; y &lt; <a class="code" href="classsdet__nms.html#ab6c1588de9f147ef6348cb3f25a5982a">grad_mag_</a>.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a44859c72206da7d18728cb2bbf8ae829">nj</a>()-<a class="code" href="classsdet__nms.html#a71dcb6c967f178ff0fe5402cbf3acb52" title="margin size">margin_</a>; y++)
<a name="l00095"></a>00095     {
<a name="l00096"></a>00096       <span class="keywordflow">if</span> (<a class="code" href="classsdet__nms.html#ab6c1588de9f147ef6348cb3f25a5982a">grad_mag_</a>(x,y) &lt; <a class="code" href="classsdet__nms.html#a59e26ebb57b5edbc41f7837e76b727b9" title="threshold">thresh_</a>) <span class="comment">//threshold by gradient magnitude</span>
<a name="l00097"></a>00097         <span class="keywordflow">continue</span>;
<a name="l00098"></a>00098 
<a name="l00099"></a>00099       <span class="keywordtype">double</span> gx = <a class="code" href="classsdet__nms.html#a25c246513d87919b04c1f3a26af622cf">dir_x_</a>(x,y);
<a name="l00100"></a>00100       <span class="keywordtype">double</span> gy = <a class="code" href="classsdet__nms.html#a9e3f6588da0ad9017f90c47c12ce8f35">dir_y_</a>(x,y);
<a name="l00101"></a>00101       <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__2d.html">vgl_vector_2d&lt;double&gt;</a> direction(gx,gy);
<a name="l00102"></a>00102       <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/vgl__vector__2d_8h.html#ac4986a4b72b1d54b872d5863ac35d3e8">normalize</a>(direction);
<a name="l00103"></a>00103 
<a name="l00104"></a>00104       <span class="comment">//The gradient has to be non-degenerate</span>
<a name="l00105"></a>00105       <span class="keywordflow">if</span> (vcl_abs(direction.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__2d.html#acc1b6069f02b8f8da2e1662f07abdd17">x</a>()) &lt; 10e-6 &amp;&amp; vcl_abs(direction.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__2d.html#a642daa8ef893f47ddf5d5c7f408efcda">y</a>()) &lt; 10e-6)
<a name="l00106"></a>00106         <span class="keywordflow">continue</span>;
<a name="l00107"></a>00107 
<a name="l00108"></a>00108       <span class="comment">//now compute the values orthogonal to the edge and fit a parabola</span>
<a name="l00109"></a>00109       <span class="keywordtype">int</span> face_num = <a class="code" href="classsdet__nms.html#ae6686a9f6777fcd8990f29610e3877a4">intersected_face_number</a>(direction); assert(face_num != -1);
<a name="l00110"></a>00110       <span class="keywordtype">double</span> s = <a class="code" href="classsdet__nms.html#a2556dac7ddca9304c28d7981d23d66d7">intersection_parameter</a>(direction, face_num); assert(s != -1000);
<a name="l00111"></a>00111       <a class="code" href="classsdet__nms.html#a4cc86254d7d55e658fed690410456860">f_values</a>(x, y, direction, s, face_num, f);
<a name="l00112"></a>00112       s_list[0] = -s; s_list[1] = 0.0; s_list[2] = s;
<a name="l00113"></a>00113 
<a name="l00114"></a>00114       <span class="comment">//Amir: removed this maximum check because, there can be a maxima between f- and f+ even when f&lt;f- or f&lt;f+</span>
<a name="l00115"></a>00115 <span class="comment"></span>
<a name="l00116"></a>00116 <span class="comment">      ////Maximum check</span>
<a name="l00117"></a>00117 <span class="comment"></span>      <span class="comment">//if ( (f[1]-f[0])&gt;1e-2 &amp;&amp; (f[1]-f[2])&gt;1e-2) //epsilon checks instead of absolute</span>
<a name="l00118"></a>00118       <span class="comment">//{</span>
<a name="l00119"></a>00119         <span class="comment">//fit a parabola to the data</span>
<a name="l00120"></a>00120         <span class="keywordtype">double</span> max_val = f[1]; <span class="comment">//default (should be updated by parabola fit)</span>
<a name="l00121"></a>00121         <span class="keywordtype">double</span> grad_val = 0.0; <span class="comment">//should be updated by parabola fit</span>
<a name="l00122"></a>00122 
<a name="l00123"></a>00123         <span class="comment">//compute location of extrema</span>
<a name="l00124"></a>00124         <span class="keywordtype">double</span> s_star = (<a class="code" href="classsdet__nms.html#a142a56c8b2e75b324b70fb689646f4e7" title="flag for parabola fit method">parabola_fit_type_</a> == <a class="code" href="sdet__nonmax__suppression__params_8h.html#a06fc87d81c62e9abb8790b6e5713c55bafb488edc0e87e30eaa16d650452b83b5">sdet_nms_params::PFIT_3_POINTS</a>) ?
<a name="l00125"></a>00125                             <a class="code" href="classsdet__nms.html#a689f626092709d318cab041c11528875">subpixel_s</a>(s_list, f, max_val, grad_val) : <a class="code" href="classsdet__nms.html#a689f626092709d318cab041c11528875">subpixel_s</a>(x, y, direction, max_val);
<a name="l00126"></a>00126 
<a name="l00127"></a>00127         <span class="keywordflow">if</span> (vcl_fabs(s_star)&lt; 0.7)
<a name="l00128"></a>00128         {
<a name="l00129"></a>00129           <span class="comment">//record this edgel</span>
<a name="l00130"></a>00130           <a class="code" href="classsdet__nms.html#a83d8add8e8ffac1647ac9fd478c95d35" title="to store the x coordinate of the subpixel token">x_</a>(y,x) = x + s_star * direction.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__2d.html#acc1b6069f02b8f8da2e1662f07abdd17">x</a>();
<a name="l00131"></a>00131           <a class="code" href="classsdet__nms.html#a892260ecf79929f95bc8a0f1b8244263" title="to store the y coordinate of the subpixel token">y_</a>(y,x) = y + s_star * direction.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__2d.html#a642daa8ef893f47ddf5d5c7f408efcda">y</a>();
<a name="l00132"></a>00132           <a class="code" href="classsdet__nms.html#a8e9c72b0764ed0028dddda0e4e4e2173" title="to store the orientation of the subpixel token (this might be redundant)">dir_</a>(y,x) = vcl_atan2(direction.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__2d.html#acc1b6069f02b8f8da2e1662f07abdd17">x</a>(), -direction.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__2d.html#a642daa8ef893f47ddf5d5c7f408efcda">y</a>());
<a name="l00133"></a>00133           <a class="code" href="classsdet__nms.html#a7f026f1f1fa27ad47177aeeaeabc9c29" title="to store the magnitude of the maxima points (also doubles as a marker of edge pixels)">mag_</a>(y,x) = max_val; <span class="comment">//the mag at the max of the parabola</span>
<a name="l00134"></a>00134           <a class="code" href="classsdet__nms.html#a2683663af5c607210ef5aa935f2577db" title="to store the second derivative of the maxima points">deriv_</a>(y,x) = grad_val;
<a name="l00135"></a>00135         }
<a name="l00136"></a>00136       <span class="comment">//}</span>
<a name="l00137"></a>00137     }
<a name="l00138"></a>00138   }
<a name="l00139"></a>00139 
<a name="l00140"></a>00140   <span class="comment">//post-process the NMS edgel map to reduce the occurrence of duplicate edgels</span>
<a name="l00141"></a>00141   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> x = <a class="code" href="classsdet__nms.html#a71dcb6c967f178ff0fe5402cbf3acb52" title="margin size">margin_</a>; x &lt; <a class="code" href="classsdet__nms.html#ab6c1588de9f147ef6348cb3f25a5982a">grad_mag_</a>.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a9ea9ad565387a61dccf38fc80a266c2a">ni</a>()-<a class="code" href="classsdet__nms.html#a71dcb6c967f178ff0fe5402cbf3acb52" title="margin size">margin_</a>; x++) {
<a name="l00142"></a>00142     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> y = <a class="code" href="classsdet__nms.html#a71dcb6c967f178ff0fe5402cbf3acb52" title="margin size">margin_</a>; y &lt; <a class="code" href="classsdet__nms.html#ab6c1588de9f147ef6348cb3f25a5982a">grad_mag_</a>.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a44859c72206da7d18728cb2bbf8ae829">nj</a>()-<a class="code" href="classsdet__nms.html#a71dcb6c967f178ff0fe5402cbf3acb52" title="margin size">margin_</a>; y++)
<a name="l00143"></a>00143     {
<a name="l00144"></a>00144       <span class="keywordflow">if</span> (<a class="code" href="classsdet__nms.html#a7f026f1f1fa27ad47177aeeaeabc9c29" title="to store the magnitude of the maxima points (also doubles as a marker of edge pixels)">mag_</a>(y,x)==0.0)
<a name="l00145"></a>00145         <span class="keywordflow">continue</span>;
<a name="l00146"></a>00146 
<a name="l00147"></a>00147       <span class="comment">//use the orientation of the edgel to determine the closest neighbors that could produce a duplicate edgel</span>
<a name="l00148"></a>00148 
<a name="l00149"></a>00149       <span class="comment">//Hack: for now just look over all the 8-neighbors</span>
<a name="l00150"></a>00150       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> ii=-1; ii&lt;2; ii++) {
<a name="l00151"></a>00151         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> jj=-1; jj&lt;2; jj++) {
<a name="l00152"></a>00152 
<a name="l00153"></a>00153           <span class="keywordflow">if</span> (ii==0 &amp;&amp; jj==0) <span class="keywordflow">continue</span>;
<a name="l00154"></a>00154 
<a name="l00155"></a>00155           <span class="comment">//if there is an edgel at this location, compute the distance to the current edgel</span>
<a name="l00156"></a>00156           <span class="keywordflow">if</span> (<a class="code" href="classsdet__nms.html#a7f026f1f1fa27ad47177aeeaeabc9c29" title="to store the magnitude of the maxima points (also doubles as a marker of edge pixels)">mag_</a>(y+jj,x+ii)&gt;0.0) {
<a name="l00157"></a>00157             <span class="keywordtype">double</span> dx = <a class="code" href="classsdet__nms.html#a83d8add8e8ffac1647ac9fd478c95d35" title="to store the x coordinate of the subpixel token">x_</a>(y+jj,x+ii) - <a class="code" href="classsdet__nms.html#a83d8add8e8ffac1647ac9fd478c95d35" title="to store the x coordinate of the subpixel token">x_</a>(y,x);
<a name="l00158"></a>00158             <span class="keywordtype">double</span> dy = <a class="code" href="classsdet__nms.html#a892260ecf79929f95bc8a0f1b8244263" title="to store the y coordinate of the subpixel token">y_</a>(y+jj,x+ii) - <a class="code" href="classsdet__nms.html#a892260ecf79929f95bc8a0f1b8244263" title="to store the y coordinate of the subpixel token">y_</a>(y,x);
<a name="l00159"></a>00159 
<a name="l00160"></a>00160             <span class="keywordflow">if</span> ((dx*dx+dy*dy)&lt;0.1) { <span class="comment">//closeness threshold, may be made into a parameter if anyone cares</span>
<a name="l00161"></a>00161               <a class="code" href="classsdet__nms.html#a7f026f1f1fa27ad47177aeeaeabc9c29" title="to store the magnitude of the maxima points (also doubles as a marker of edge pixels)">mag_</a>(y,x)=0.0; <span class="comment">//kill the current edgel</span>
<a name="l00162"></a>00162               <span class="keywordflow">continue</span>;
<a name="l00163"></a>00163             }
<a name="l00164"></a>00164           }
<a name="l00165"></a>00165         }
<a name="l00166"></a>00166       }
<a name="l00167"></a>00167     }
<a name="l00168"></a>00168   }
<a name="l00169"></a>00169 
<a name="l00170"></a>00170   <span class="comment">//if seeking tokens, form tokens from the remaining edgels</span>
<a name="l00171"></a>00171   <span class="keywordflow">if</span> (collect_tokens) {
<a name="l00172"></a>00172     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> x = <a class="code" href="classsdet__nms.html#a71dcb6c967f178ff0fe5402cbf3acb52" title="margin size">margin_</a>; x &lt; <a class="code" href="classsdet__nms.html#ab6c1588de9f147ef6348cb3f25a5982a">grad_mag_</a>.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a9ea9ad565387a61dccf38fc80a266c2a">ni</a>()-<a class="code" href="classsdet__nms.html#a71dcb6c967f178ff0fe5402cbf3acb52" title="margin size">margin_</a>; x++) {
<a name="l00173"></a>00173       <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> y = <a class="code" href="classsdet__nms.html#a71dcb6c967f178ff0fe5402cbf3acb52" title="margin size">margin_</a>; y &lt; <a class="code" href="classsdet__nms.html#ab6c1588de9f147ef6348cb3f25a5982a">grad_mag_</a>.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a44859c72206da7d18728cb2bbf8ae829">nj</a>()-<a class="code" href="classsdet__nms.html#a71dcb6c967f178ff0fe5402cbf3acb52" title="margin size">margin_</a>; y++)
<a name="l00174"></a>00174       {
<a name="l00175"></a>00175         <span class="keywordflow">if</span> (<a class="code" href="classsdet__nms.html#a7f026f1f1fa27ad47177aeeaeabc9c29" title="to store the magnitude of the maxima points (also doubles as a marker of edge pixels)">mag_</a>(y,x)==0.0)
<a name="l00176"></a>00176           <span class="keywordflow">continue</span>;
<a name="l00177"></a>00177 
<a name="l00178"></a>00178         loc.push_back(<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__point__2d.html">vgl_point_2d&lt;double&gt;</a>(<a class="code" href="classsdet__nms.html#a83d8add8e8ffac1647ac9fd478c95d35" title="to store the x coordinate of the subpixel token">x_</a>(y,x), <a class="code" href="classsdet__nms.html#a892260ecf79929f95bc8a0f1b8244263" title="to store the y coordinate of the subpixel token">y_</a>(y,x)));
<a name="l00179"></a>00179         orientation.push_back(<a class="code" href="classsdet__nms.html#a8e9c72b0764ed0028dddda0e4e4e2173" title="to store the orientation of the subpixel token (this might be redundant)">dir_</a>(y,x));
<a name="l00180"></a>00180         mag.push_back(<a class="code" href="classsdet__nms.html#a7f026f1f1fa27ad47177aeeaeabc9c29" title="to store the magnitude of the maxima points (also doubles as a marker of edge pixels)">mag_</a>(y,x));
<a name="l00181"></a>00181         d2f.push_back(<a class="code" href="classsdet__nms.html#a2683663af5c607210ef5aa935f2577db" title="to store the second derivative of the maxima points">deriv_</a>(y,x));
<a name="l00182"></a>00182 
<a name="l00183"></a>00183         <span class="comment">//also return the pixel location so that they can be used for tracing algorithms</span>
<a name="l00184"></a>00184         pix_loc.push_back(<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__point__2d.html">vgl_point_2d&lt;int&gt;</a>(x, y));
<a name="l00185"></a>00185       }
<a name="l00186"></a>00186     }
<a name="l00187"></a>00187   }
<a name="l00188"></a>00188 }
<a name="l00189"></a>00189 
<a name="l00190"></a><a class="code" href="classsdet__nms.html#ae6686a9f6777fcd8990f29610e3877a4">00190</a> <span class="keywordtype">int</span> <a class="code" href="classsdet__nms.html#ae6686a9f6777fcd8990f29610e3877a4">sdet_nms::intersected_face_number</a>(<span class="keyword">const</span> <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__2d.html">vgl_vector_2d&lt;double&gt;</a>&amp; direction)
<a name="l00191"></a>00191 {
<a name="l00192"></a>00192   <span class="keywordflow">if</span> (direction.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__2d.html#acc1b6069f02b8f8da2e1662f07abdd17">x</a>() &gt;= 0 &amp;&amp; direction.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__2d.html#a642daa8ef893f47ddf5d5c7f408efcda">y</a>() &gt;= 0)
<a name="l00193"></a>00193   {
<a name="l00194"></a>00194     <span class="keywordflow">if</span> (direction.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__2d.html#acc1b6069f02b8f8da2e1662f07abdd17">x</a>() &gt;= direction.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__2d.html#a642daa8ef893f47ddf5d5c7f408efcda">y</a>())
<a name="l00195"></a>00195       <span class="keywordflow">return</span> 1;
<a name="l00196"></a>00196     <span class="keywordflow">else</span>
<a name="l00197"></a>00197       <span class="keywordflow">return</span> 2;
<a name="l00198"></a>00198   }
<a name="l00199"></a>00199   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (direction.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__2d.html#acc1b6069f02b8f8da2e1662f07abdd17">x</a>() &lt; 0 &amp;&amp; direction.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__2d.html#a642daa8ef893f47ddf5d5c7f408efcda">y</a>() &gt;= 0)
<a name="l00200"></a>00200   {
<a name="l00201"></a>00201     <span class="keywordflow">if</span> (vcl_abs(direction.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__2d.html#acc1b6069f02b8f8da2e1662f07abdd17">x</a>()) &lt; direction.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__2d.html#a642daa8ef893f47ddf5d5c7f408efcda">y</a>())
<a name="l00202"></a>00202       <span class="keywordflow">return</span> 3;
<a name="l00203"></a>00203     <span class="keywordflow">else</span>
<a name="l00204"></a>00204       <span class="keywordflow">return</span> 4;
<a name="l00205"></a>00205   }
<a name="l00206"></a>00206   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (direction.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__2d.html#acc1b6069f02b8f8da2e1662f07abdd17">x</a>() &lt; 0 &amp;&amp; direction.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__2d.html#a642daa8ef893f47ddf5d5c7f408efcda">y</a>() &lt; 0)
<a name="l00207"></a>00207   {
<a name="l00208"></a>00208     <span class="keywordflow">if</span> (vcl_abs(direction.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__2d.html#acc1b6069f02b8f8da2e1662f07abdd17">x</a>()) &gt;= vcl_abs(direction.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__2d.html#a642daa8ef893f47ddf5d5c7f408efcda">y</a>()))
<a name="l00209"></a>00209       <span class="keywordflow">return</span> 5;
<a name="l00210"></a>00210     <span class="keywordflow">else</span>
<a name="l00211"></a>00211       <span class="keywordflow">return</span> 6;
<a name="l00212"></a>00212   }
<a name="l00213"></a>00213   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (direction.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__2d.html#acc1b6069f02b8f8da2e1662f07abdd17">x</a>() &gt;= 0 &amp;&amp; direction.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__2d.html#a642daa8ef893f47ddf5d5c7f408efcda">y</a>() &lt; 0)
<a name="l00214"></a>00214   {
<a name="l00215"></a>00215     <span class="keywordflow">if</span> (direction.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__2d.html#acc1b6069f02b8f8da2e1662f07abdd17">x</a>() &lt; vcl_abs(direction.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__2d.html#a642daa8ef893f47ddf5d5c7f408efcda">y</a>()))
<a name="l00216"></a>00216       <span class="keywordflow">return</span> 7;
<a name="l00217"></a>00217     <span class="keywordflow">else</span>
<a name="l00218"></a>00218       <span class="keywordflow">return</span> 8;
<a name="l00219"></a>00219   }
<a name="l00220"></a>00220   <span class="keywordflow">return</span> -1;
<a name="l00221"></a>00221 }
<a name="l00222"></a>00222 
<a name="l00223"></a><a class="code" href="classsdet__nms.html#a2556dac7ddca9304c28d7981d23d66d7">00223</a> <span class="keywordtype">double</span> <a class="code" href="classsdet__nms.html#a2556dac7ddca9304c28d7981d23d66d7">sdet_nms::intersection_parameter</a>(<span class="keyword">const</span> <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__2d.html">vgl_vector_2d&lt;double&gt;</a>&amp; direction, <span class="keywordtype">int</span> face_num)
<a name="l00224"></a>00224 {
<a name="l00225"></a>00225   <span class="keywordflow">if</span> (face_num == 1 || face_num == 8)
<a name="l00226"></a>00226     <span class="keywordflow">return</span> 1.0/direction.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__2d.html#acc1b6069f02b8f8da2e1662f07abdd17">x</a>();
<a name="l00227"></a>00227   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (face_num == 2 || face_num == 3)
<a name="l00228"></a>00228     <span class="keywordflow">return</span> 1.0/direction.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__2d.html#a642daa8ef893f47ddf5d5c7f408efcda">y</a>();
<a name="l00229"></a>00229   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (face_num == 4 || face_num == 5)
<a name="l00230"></a>00230     <span class="keywordflow">return</span> -1.0/direction.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__2d.html#acc1b6069f02b8f8da2e1662f07abdd17">x</a>();
<a name="l00231"></a>00231   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (face_num == 6 || face_num == 7)
<a name="l00232"></a>00232     <span class="keywordflow">return</span> -1.0/direction.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__2d.html#a642daa8ef893f47ddf5d5c7f408efcda">y</a>();
<a name="l00233"></a>00233   <span class="keywordflow">return</span> -1000.0;
<a name="l00234"></a>00234 }
<a name="l00235"></a>00235 
<a name="l00236"></a><a class="code" href="classsdet__nms.html#a4cc86254d7d55e658fed690410456860">00236</a> <span class="keywordtype">void</span> <a class="code" href="classsdet__nms.html#a4cc86254d7d55e658fed690410456860">sdet_nms::f_values</a>(<span class="keywordtype">int</span> x, <span class="keywordtype">int</span> y, <span class="keyword">const</span> <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__2d.html">vgl_vector_2d&lt;double&gt;</a>&amp; direction, <span class="keywordtype">double</span> s, <span class="keywordtype">int</span> face_num, <span class="keywordtype">double</span> *f)
<a name="l00237"></a>00237 {
<a name="l00238"></a>00238   <span class="keywordtype">int</span> corners[4];
<a name="l00239"></a>00239   <a class="code" href="classsdet__nms.html#a5d760c76b03fe7ddac5896e28c345ad7">get_relative_corner_coordinates</a>(face_num, corners);
<a name="l00240"></a>00240 
<a name="l00241"></a>00241   <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__2d.html">vgl_vector_2d&lt;double&gt;</a> intersection_point = s * direction;
<a name="l00242"></a>00242   <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__2d.html">vgl_vector_2d&lt;double&gt;</a> corner1(corners[0], corners[1]); <span class="comment">//have to convert to double for subtraction</span>
<a name="l00243"></a>00243   <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__2d.html">vgl_vector_2d&lt;double&gt;</a> corner2(corners[2], corners[3]); <span class="comment">//have to convert to double for subtraction</span>
<a name="l00244"></a>00244   <span class="keywordtype">double</span> distance1 = <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/vgl__vector__2d_8h.html#a31c7db8164e71d411a1a821525102dc3">length</a>(intersection_point - corner1);
<a name="l00245"></a>00245   <span class="keywordtype">double</span> distance2 = <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/vgl__vector__2d_8h.html#a31c7db8164e71d411a1a821525102dc3">length</a>(intersection_point - corner2);
<a name="l00246"></a>00246   <span class="keywordtype">double</span> value1 = <a class="code" href="classsdet__nms.html#ab6c1588de9f147ef6348cb3f25a5982a">grad_mag_</a>(x+corners[0], y+corners[1]);
<a name="l00247"></a>00247   <span class="keywordtype">double</span> value2 = <a class="code" href="classsdet__nms.html#ab6c1588de9f147ef6348cb3f25a5982a">grad_mag_</a>(x+corners[2], y+corners[3]);
<a name="l00248"></a>00248   <span class="keywordtype">double</span> f_plus = value1 * distance2 + value2 * distance1;
<a name="l00249"></a>00249 
<a name="l00250"></a>00250   intersection_point = -s * direction;
<a name="l00251"></a>00251   corner1.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__2d.html#a44a3140f4d06bafdde0f5eb5fe9fedaa">set</a>(-corners[0], -corners[1]); <span class="comment">//have to convert to double for subtraction</span>
<a name="l00252"></a>00252   corner2.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__2d.html#a44a3140f4d06bafdde0f5eb5fe9fedaa">set</a>(-corners[2], -corners[3]); <span class="comment">//have to convert to double for subtraction</span>
<a name="l00253"></a>00253   distance1 = <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/vgl__vector__2d_8h.html#a31c7db8164e71d411a1a821525102dc3">length</a>(intersection_point - corner1);
<a name="l00254"></a>00254   distance2 = <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/vgl__vector__2d_8h.html#a31c7db8164e71d411a1a821525102dc3">length</a>(intersection_point - corner2);
<a name="l00255"></a>00255   value1 = <a class="code" href="classsdet__nms.html#ab6c1588de9f147ef6348cb3f25a5982a">grad_mag_</a>(x-corners[0], y-corners[1]);
<a name="l00256"></a>00256   value2 = <a class="code" href="classsdet__nms.html#ab6c1588de9f147ef6348cb3f25a5982a">grad_mag_</a>(x-corners[2], y-corners[3]);
<a name="l00257"></a>00257   <span class="keywordtype">double</span> f_minus = value1 * distance2 + value2 * distance1;
<a name="l00258"></a>00258 
<a name="l00259"></a>00259   f[0] = f_minus;
<a name="l00260"></a>00260   f[1] = <a class="code" href="classsdet__nms.html#ab6c1588de9f147ef6348cb3f25a5982a">grad_mag_</a>(x,y);
<a name="l00261"></a>00261   f[2] = f_plus;
<a name="l00262"></a>00262 }
<a name="l00263"></a>00263 
<a name="l00264"></a><a class="code" href="classsdet__nms.html#a5d760c76b03fe7ddac5896e28c345ad7">00264</a> <span class="keywordtype">void</span> <a class="code" href="classsdet__nms.html#a5d760c76b03fe7ddac5896e28c345ad7">sdet_nms::get_relative_corner_coordinates</a>(<span class="keywordtype">int</span> face_num, <span class="keywordtype">int</span> *corners)
<a name="l00265"></a>00265 {
<a name="l00266"></a>00266   <span class="keywordflow">switch</span> (face_num)
<a name="l00267"></a>00267   {
<a name="l00268"></a>00268    <span class="keywordflow">case</span> 1:
<a name="l00269"></a>00269      corners[0] = 1;
<a name="l00270"></a>00270      corners[1] = 0;
<a name="l00271"></a>00271      corners[2] = 1;
<a name="l00272"></a>00272      corners[3] = 1;
<a name="l00273"></a>00273      <span class="keywordflow">break</span>;
<a name="l00274"></a>00274    <span class="keywordflow">case</span> 2:
<a name="l00275"></a>00275      corners[0] = 1;
<a name="l00276"></a>00276      corners[1] = 1;
<a name="l00277"></a>00277      corners[2] = 0;
<a name="l00278"></a>00278      corners[3] = 1;
<a name="l00279"></a>00279      <span class="keywordflow">break</span>;
<a name="l00280"></a>00280    <span class="keywordflow">case</span> 3:
<a name="l00281"></a>00281      corners[0] = 0;
<a name="l00282"></a>00282      corners[1] = 1;
<a name="l00283"></a>00283      corners[2] = -1;
<a name="l00284"></a>00284      corners[3] = 1;
<a name="l00285"></a>00285     <span class="keywordflow">break</span>;
<a name="l00286"></a>00286    <span class="keywordflow">case</span> 4:
<a name="l00287"></a>00287      corners[0] = -1;
<a name="l00288"></a>00288      corners[1] = 1;
<a name="l00289"></a>00289      corners[2] = -1;
<a name="l00290"></a>00290      corners[3] = 0;
<a name="l00291"></a>00291     <span class="keywordflow">break</span>;
<a name="l00292"></a>00292    <span class="keywordflow">case</span> 5:
<a name="l00293"></a>00293      corners[0] = -1;
<a name="l00294"></a>00294      corners[1] = 0;
<a name="l00295"></a>00295      corners[2] = -1;
<a name="l00296"></a>00296      corners[3] = -1;
<a name="l00297"></a>00297     <span class="keywordflow">break</span>;
<a name="l00298"></a>00298    <span class="keywordflow">case</span> 6:
<a name="l00299"></a>00299      corners[0] = -1;
<a name="l00300"></a>00300      corners[1] = -1;
<a name="l00301"></a>00301      corners[2] = 0;
<a name="l00302"></a>00302      corners[3] = -1;
<a name="l00303"></a>00303     <span class="keywordflow">break</span>;
<a name="l00304"></a>00304    <span class="keywordflow">case</span> 7:
<a name="l00305"></a>00305      corners[0] = 0;
<a name="l00306"></a>00306      corners[1] = -1;
<a name="l00307"></a>00307      corners[2] = 1;
<a name="l00308"></a>00308      corners[3] = -1;
<a name="l00309"></a>00309     <span class="keywordflow">break</span>;
<a name="l00310"></a>00310    <span class="keywordflow">case</span> 8:
<a name="l00311"></a>00311      corners[0] = 1;
<a name="l00312"></a>00312      corners[1] = -1;
<a name="l00313"></a>00313      corners[2] = 1;
<a name="l00314"></a>00314      corners[3] = 0;
<a name="l00315"></a>00315     <span class="keywordflow">break</span>;
<a name="l00316"></a>00316    <span class="keywordflow">default</span>:
<a name="l00317"></a>00317      corners[0] = 0;
<a name="l00318"></a>00318      corners[1] = 0;
<a name="l00319"></a>00319      corners[2] = 0;
<a name="l00320"></a>00320      corners[3] = 0;
<a name="l00321"></a>00321   }
<a name="l00322"></a>00322 }
<a name="l00323"></a>00323 
<a name="l00324"></a><a class="code" href="classsdet__nms.html#a689f626092709d318cab041c11528875">00324</a> <span class="keywordtype">double</span> <a class="code" href="classsdet__nms.html#a689f626092709d318cab041c11528875">sdet_nms::subpixel_s</a>(<span class="keywordtype">double</span> *s, <span class="keywordtype">double</span> *f, <span class="keywordtype">double</span> &amp;max_f, <span class="keywordtype">double</span> &amp;max_d)
<a name="l00325"></a>00325 {
<a name="l00326"></a>00326   <span class="comment">//double A = f[2] / ((s[2]-s[0])*(s[2]-s[1]));</span>
<a name="l00327"></a>00327   <span class="comment">//double B = f[1] / ((s[1]-s[0])*(s[1]-s[2]));</span>
<a name="l00328"></a>00328   <span class="comment">//double C = f[0] / ((s[0]-s[1])*(s[0]-s[2]));</span>
<a name="l00329"></a>00329   <span class="comment">//double s_star = ((A+B)*s[0] + (A+C)*s[1] + (B+C)*s[2]) / (2*(A+B+C));</span>
<a name="l00330"></a>00330 
<a name="l00331"></a>00331 
<a name="l00332"></a>00332   <span class="comment">//new version: assumes s[1]=0 and s[2]=-s[0]</span>
<a name="l00333"></a>00333   <span class="keywordtype">double</span> A = -(f[1] - (f[0]+f[2])/2.0)/(s[2]*s[2]);
<a name="l00334"></a>00334   <span class="keywordtype">double</span> B = -(f[0]-f[2])/(2*s[2]);
<a name="l00335"></a>00335   <span class="keywordtype">double</span> C = f[1];
<a name="l00336"></a>00336 
<a name="l00337"></a>00337   <span class="keywordtype">double</span> s_star = -B/(2*A);
<a name="l00338"></a>00338 
<a name="l00339"></a>00339   max_f = A*s_star*s_star + B*s_star + C;
<a name="l00340"></a>00340 
<a name="l00341"></a>00341   <span class="comment">//second derivative</span>
<a name="l00342"></a>00342   <span class="keywordtype">double</span> d2f = 2*A;
<a name="l00343"></a>00343   max_d = d2f;
<a name="l00344"></a>00344 
<a name="l00345"></a>00345   <span class="keywordflow">if</span> (A&lt;0) { <span class="comment">//make sure this is a maximum</span>
<a name="l00346"></a>00346     <span class="keywordflow">if</span> (<a class="code" href="classsdet__nms.html#a3bc257ed13005539b778cdd440e482d6" title="use reliable threshold or not">use_adaptive_thresh_</a>) {
<a name="l00347"></a>00347 <span class="preprocessor">#if 0 // no longer used...</span>
<a name="l00348"></a>00348 <span class="preprocessor"></span>      <span class="comment">//derivatives at f+ and f-</span>
<a name="l00349"></a>00349       <span class="keywordtype">double</span> d2fp = 2*A*s[2] + B;
<a name="l00350"></a>00350       <span class="keywordtype">double</span> d2fm = 2*A*s[0] + B;
<a name="l00351"></a>00351       <span class="keywordflow">if</span> (vcl_fabs(d2fp)&gt;<a class="code" href="classsdet__nms.html#ae2dfd62b67ed8a2c66da70eb64283d3c" title="reliable threshold (depends on sensor noise and sigma)">rel_thresh_</a> || vcl_fabs(d2fm)&gt;<a class="code" href="classsdet__nms.html#ae2dfd62b67ed8a2c66da70eb64283d3c" title="reliable threshold (depends on sensor noise and sigma)">rel_thresh_</a>)
<a name="l00352"></a>00352 #endif <span class="comment">// 0</span>
<a name="l00353"></a>00353       <span class="keywordflow">if</span> (d2f&lt;-<a class="code" href="classsdet__nms.html#ae2dfd62b67ed8a2c66da70eb64283d3c" title="reliable threshold (depends on sensor noise and sigma)">rel_thresh_</a>)<span class="comment">//d2f is always negative at a maxima</span>
<a name="l00354"></a>00354         <span class="keywordflow">return</span> s_star;
<a name="l00355"></a>00355       <span class="keywordflow">else</span>
<a name="l00356"></a>00356         <span class="keywordflow">return</span> 5.0; <span class="comment">//not reliable</span>
<a name="l00357"></a>00357     }
<a name="l00358"></a>00358     <span class="keywordflow">else</span>
<a name="l00359"></a>00359       <span class="keywordflow">return</span> s_star;
<a name="l00360"></a>00360   }
<a name="l00361"></a>00361   <span class="keywordflow">else</span>
<a name="l00362"></a>00362     <span class="keywordflow">return</span> 5.0; <span class="comment">//not a maximum</span>
<a name="l00363"></a>00363 
<a name="l00364"></a>00364 <span class="comment">//From gevd NMS</span>
<a name="l00365"></a>00365 <span class="preprocessor">#if 0</span>
<a name="l00366"></a>00366 <span class="preprocessor"></span>  <span class="comment">// Fit a parabola through 3 points with strict local max/min.</span>
<a name="l00367"></a>00367   <span class="comment">// Return the offset location, and value of the maximum/minimum.</span>
<a name="l00368"></a>00368   <span class="keywordtype">float</span>
<a name="l00369"></a>00369   gevd_float_operators::InterpolateParabola(<span class="keywordtype">float</span> y_1, <span class="keywordtype">float</span> y_0, <span class="keywordtype">float</span> y_2,
<a name="l00370"></a>00370                                             <span class="keywordtype">float</span>&amp;y)
<a name="l00371"></a>00371   {
<a name="l00372"></a>00372     <span class="keywordtype">float</span> diff1 = y_2 - y_1;      <span class="comment">// first derivative</span>
<a name="l00373"></a>00373     <span class="keywordtype">float</span> diff2 = 2 * y_0 - y_1 - y_2; <span class="comment">// second derivative</span>
<a name="l00374"></a>00374     y = y_0 + diff1 * diff1 / (8 * diff2);        <span class="comment">// interpolate y as max/min</span>
<a name="l00375"></a>00375     <span class="keywordflow">return</span> diff1 / (2 * diff2);   <span class="comment">// interpolate x offset</span>
<a name="l00376"></a>00376 }
<a name="l00377"></a>00377 <span class="preprocessor">#endif // 0</span>
<a name="l00378"></a>00378 <span class="preprocessor"></span>}
<a name="l00379"></a>00379 
<a name="l00380"></a><a class="code" href="classsdet__nms.html#acf9dd6b7b9e278546826a8149fcc6331">00380</a> <span class="keywordtype">double</span> <a class="code" href="classsdet__nms.html#a689f626092709d318cab041c11528875">sdet_nms::subpixel_s</a>(<span class="keywordtype">int</span> x, <span class="keywordtype">int</span> y, <span class="keyword">const</span> <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__2d.html">vgl_vector_2d&lt;double&gt;</a>&amp; direction, <span class="keywordtype">double</span> &amp;max_f)
<a name="l00381"></a>00381 {
<a name="l00382"></a>00382   <span class="keywordtype">double</span> d;
<a name="l00383"></a>00383   <span class="keywordtype">double</span> s;
<a name="l00384"></a>00384   <span class="keywordtype">double</span> f;
<a name="l00385"></a>00385   <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__point__2d.html">vgl_homg_point_2d&lt;double&gt;</a> p1(0.0, 0.0);
<a name="l00386"></a>00386   <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__point__2d.html">vgl_homg_point_2d&lt;double&gt;</a> p2(direction.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__2d.html#acc1b6069f02b8f8da2e1662f07abdd17">x</a>(), direction.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__2d.html#a642daa8ef893f47ddf5d5c7f408efcda">y</a>());
<a name="l00387"></a>00387   <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__line__2d.html">vgl_homg_line_2d&lt;double&gt;</a> line1(p1,p2);
<a name="l00388"></a>00388   <span class="comment">//construct the matrices</span>
<a name="l00389"></a>00389   <a class="codeRef" doxygen="core_vnl.tag:../../../../../core/vnl/html" href="../../../../../core/vnl/html/classvnl__matrix.html">vnl_matrix&lt;double&gt;</a> A(9, 3);
<a name="l00390"></a>00390   <a class="codeRef" doxygen="core_vnl.tag:../../../../../core/vnl/html" href="../../../../../core/vnl/html/classvnl__matrix.html">vnl_matrix&lt;double&gt;</a> B(9, 1);
<a name="l00391"></a>00391   <a class="codeRef" doxygen="core_vnl.tag:../../../../../core/vnl/html" href="../../../../../core/vnl/html/classvnl__matrix.html">vnl_matrix&lt;double&gt;</a> P(3, 1);
<a name="l00392"></a>00392   <span class="keywordtype">int</span> index = 0;
<a name="l00393"></a>00393   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = -1; j &lt;= 1; j++)
<a name="l00394"></a>00394   {
<a name="l00395"></a>00395     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = -1; i &lt;= 1; i++)
<a name="l00396"></a>00396     {
<a name="l00397"></a>00397       <a class="code" href="classsdet__nms.html#a1c6dbbb696af3ed11202de4186d5ae53">find_distance_s_and_f_for_point</a>(i, j, line1, d, s, direction);
<a name="l00398"></a>00398       f = <a class="code" href="classsdet__nms.html#ab6c1588de9f147ef6348cb3f25a5982a">grad_mag_</a>(x+i,y+j);
<a name="l00399"></a>00399       A(index, 0) = vcl_pow(s,2.0);
<a name="l00400"></a>00400       A(index, 1) = s;
<a name="l00401"></a>00401       A(index, 2) = 1.0;
<a name="l00402"></a>00402       B(index, 0) = f;
<a name="l00403"></a>00403       index++;
<a name="l00404"></a>00404     }
<a name="l00405"></a>00405   }
<a name="l00406"></a>00406 <span class="comment">//  vnl_matrix&lt;double&gt; A_trans = A.transpose();</span>
<a name="l00407"></a>00407 <span class="comment">//  vnl_matrix&lt;double&gt; temp = vnl_matrix_inverse&lt;double&gt; (A_trans*A);</span>
<a name="l00408"></a>00408 <span class="comment">//  vnl_matrix&lt;double&gt; temp2 = temp * A_trans;</span>
<a name="l00409"></a>00409 <span class="comment">//  P = temp2 * B;</span>
<a name="l00410"></a>00410   <a class="codeRef" doxygen="core_vnl.tag:../../../../../core/vnl/html" href="../../../../../core/vnl/html/classvnl__svd.html">vnl_svd&lt;double&gt;</a> svd(A);
<a name="l00411"></a>00411   P = svd.<a class="codeRef" doxygen="core_vnl.tag:../../../../../core/vnl/html" href="../../../../../core/vnl/html/classvnl__svd.html#ac2cbab9e5659cebda7829337d285fbcc">solve</a>(B);
<a name="l00412"></a>00412   <span class="keywordtype">double</span> s_star = -P(1,0)/(2*P(0,0));
<a name="l00413"></a>00413 
<a name="l00414"></a>00414 
<a name="l00415"></a>00415   max_f = P(0,0)*s_star*s_star + P(1,0)*s_star + P(2,0);
<a name="l00416"></a>00416 
<a name="l00417"></a>00417   <span class="keywordflow">if</span> (P(0,0)&lt;0)
<a name="l00418"></a>00418     <span class="keywordflow">return</span> s_star;
<a name="l00419"></a>00419   <span class="keywordflow">else</span>
<a name="l00420"></a>00420     <span class="keywordflow">return</span> 5.0; <span class="comment">//not a maxima</span>
<a name="l00421"></a>00421 }
<a name="l00422"></a>00422 
<a name="l00423"></a><a class="code" href="classsdet__nms.html#a1c6dbbb696af3ed11202de4186d5ae53">00423</a> <span class="keywordtype">void</span> <a class="code" href="classsdet__nms.html#a1c6dbbb696af3ed11202de4186d5ae53">sdet_nms::find_distance_s_and_f_for_point</a>(<span class="keywordtype">int</span> x, <span class="keywordtype">int</span> y, <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__line__2d.html">vgl_homg_line_2d&lt;double&gt;</a> line,
<a name="l00424"></a>00424                                                <span class="keywordtype">double</span> &amp;d, <span class="keywordtype">double</span> &amp;s, <span class="keyword">const</span> <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__2d.html">vgl_vector_2d&lt;double&gt;</a>&amp; direction)
<a name="l00425"></a>00425 {
<a name="l00426"></a>00426   <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__point__2d.html">vgl_homg_point_2d&lt;double&gt;</a> point(x,y);
<a name="l00427"></a>00427   <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__line__2d.html">vgl_homg_line_2d&lt;double&gt;</a> perp_line = <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__operators__2d.html">vgl_homg_operators_2d&lt;double&gt;::perp_line_through_point</a>(line, point);
<a name="l00428"></a>00428   <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__point__2d.html">vgl_homg_point_2d&lt;double&gt;</a> intersection_point_homg = <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__operators__2d.html">vgl_homg_operators_2d&lt;double&gt;::intersection</a>(line, perp_line);
<a name="l00429"></a>00429   <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__point__2d.html">vgl_point_2d&lt;double&gt;</a> intersection_point(intersection_point_homg);
<a name="l00430"></a>00430   <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__2d.html">vgl_vector_2d&lt;double&gt;</a> d_helper(x-intersection_point.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__point__2d.html#a3d0455536dcb130f284c3eeaba1ae960">x</a>(), y-intersection_point.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__point__2d.html#a25dfe52017f7614103d028639125ff91">y</a>());
<a name="l00431"></a>00431   d = <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/vgl__vector__2d_8h.html#a31c7db8164e71d411a1a821525102dc3">length</a>(d_helper);
<a name="l00432"></a>00432   s = intersection_point.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__point__2d.html#a3d0455536dcb130f284c3eeaba1ae960">x</a>() / direction.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__2d.html#acc1b6069f02b8f8da2e1662f07abdd17">x</a>();
<a name="l00433"></a>00433 }
<a name="l00434"></a>00434 
<a name="l00435"></a>00435 <span class="comment">//----------------------------------------------------------</span>
<a name="l00436"></a>00436 <span class="comment">//: Clear internal storage</span>
<a name="l00437"></a>00437 <span class="comment">//</span>
<a name="l00438"></a><a class="code" href="classsdet__nms.html#a9019d6a341fbaca86f36a53157567ef0">00438</a> <span class="keywordtype">void</span> <a class="code" href="classsdet__nms.html#a9019d6a341fbaca86f36a53157567ef0" title="Clear internal storage.">sdet_nms::clear</a>()
<a name="l00439"></a>00439 {
<a name="l00440"></a>00440   <a class="code" href="classsdet__nms.html#a7f026f1f1fa27ad47177aeeaeabc9c29" title="to store the magnitude of the maxima points (also doubles as a marker of edge pixels)">mag_</a>.<a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__array__2d.html#a1095c9a7ea0f577c35e10bee8eed2bb7">clear</a>();
<a name="l00441"></a>00441 }
</pre></div></div>
</div>


<hr class="footer"/><address class="footer"><small>
Generated on Thu May 2 2013 08:53:32 for contrib/brl/bseg/sdet by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.7.5.1
</small></address>

</body>
</html>
