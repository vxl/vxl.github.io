<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
"http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
  <title>contrib/brl/bseg/sdet/sdet_grid_finder.cxx Source File</title>
  <link href="doxygen.css" rel="stylesheet" type="text/css" />
  <link href="tabs.css" rel="stylesheet" type="text/css" />
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
</head>
<body>
<!-- Generated by Doxygen 1.7.5.1 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<div class="title">contrib/brl/bseg/sdet/sdet_grid_finder.cxx</div>  </div>
</div>
<div class="contents">
<a href="sdet__grid__finder_8cxx.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">// This is brl/bseg/sdet/sdet_grid_finder.cxx</span>
<a name="l00002"></a>00002 <span class="preprocessor">#include &quot;<a class="code" href="sdet__grid__finder_8h.html" title="a processor for finding a grid of orthogonal lines in an image">sdet_grid_finder.h</a>&quot;</span>
<a name="l00003"></a>00003 <span class="comment">//:</span>
<a name="l00004"></a>00004 <span class="comment">// \file</span>
<a name="l00005"></a>00005 <span class="comment">//</span>
<a name="l00006"></a>00006 <span class="comment">// \verbatim</span>
<a name="l00007"></a>00007 <span class="comment">//  Modifications</span>
<a name="l00008"></a>00008 <span class="comment">//  Bing Yu 1/18/2008</span>
<a name="l00009"></a>00009 <span class="comment">//    - removed unnecessary check on line length in compute_affine_homography()</span>
<a name="l00010"></a>00010 <span class="comment">//    - bug fixed: n_lines_x_/n_lines_y were switched when computing</span>
<a name="l00011"></a>00011 <span class="comment">//      grid offset in compute_homography_linear_chamfer(),</span>
<a name="l00012"></a>00012 <span class="comment">//      writing grid points in init_output_file(), and write_image_points()</span>
<a name="l00013"></a>00013 <span class="comment">//    - bug fixed in iterator over &quot;squares&quot; in a few places in</span>
<a name="l00014"></a>00014 <span class="comment">//      get_square_pixel_stats()</span>
<a name="l00015"></a>00015 <span class="comment">// \endverbatim</span>
<a name="l00016"></a>00016 
<a name="l00017"></a>00017 <span class="preprocessor">#include &lt;vcl_fstream.h&gt;</span>
<a name="l00018"></a>00018 <span class="preprocessor">#include &lt;vcl_algorithm.h&gt;</span> <span class="comment">// for vcl_sort() and vcl_find()</span>
<a name="l00019"></a>00019 <span class="preprocessor">#include &lt;<a class="codeRef" doxygen="core_vnl.tag:../../../../../core/vnl/html" href="../../../../../core/vnl/html/vnl__matrix__fixed_8h.html">vnl/vnl_matrix_fixed.h</a>&gt;</span>
<a name="l00020"></a>00020 <span class="preprocessor">#include &lt;<a class="codeRef" doxygen="core_vnl.tag:../../../../../core/vnl/html" href="../../../../../core/vnl/html/vnl__numeric__traits_8h.html">vnl/vnl_numeric_traits.h</a>&gt;</span>
<a name="l00021"></a>00021 <span class="preprocessor">#include &lt;<a class="codeRef" doxygen="core_vnl.tag:../../../../../core/vnl/html" href="../../../../../core/vnl/html/vnl__math_8h.html">vnl/vnl_math.h</a>&gt;</span>
<a name="l00022"></a>00022 <span class="preprocessor">#include &lt;<a class="codeRef" doxygen="core_vnl.tag:../../../../../core/vnl/html" href="../../../../../core/vnl/html/vnl__det_8h.html">vnl/vnl_det.h</a>&gt;</span>
<a name="l00023"></a>00023 <span class="preprocessor">#include &lt;<a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/vbl__bounding__box_8h.html">vbl/vbl_bounding_box.h</a>&gt;</span>
<a name="l00024"></a>00024 <span class="preprocessor">#include &lt;<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/vgl__homg__line__2d_8h.html">vgl/vgl_homg_line_2d.h</a>&gt;</span>
<a name="l00025"></a>00025 <span class="preprocessor">#include &lt;<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/vgl__homg__point__2d_8h.html">vgl/vgl_homg_point_2d.h</a>&gt;</span>
<a name="l00026"></a>00026 <span class="preprocessor">#include &lt;<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/vgl__point__2d_8h.html">vgl/vgl_point_2d.h</a>&gt;</span>
<a name="l00027"></a>00027 <span class="preprocessor">#include &lt;<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/vgl__vector__2d_8h.html">vgl/vgl_vector_2d.h</a>&gt;</span>
<a name="l00028"></a>00028 <span class="preprocessor">#include &lt;<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/vgl__homg__operators__2d_8h.html">vgl/algo/vgl_homg_operators_2d.h</a>&gt;</span>
<a name="l00029"></a>00029 <span class="preprocessor">#include &lt;<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/vgl__h__matrix__2d__compute__4point_8h.html">vgl/algo/vgl_h_matrix_2d_compute_4point.h</a>&gt;</span>
<a name="l00030"></a>00030 <span class="preprocessor">#include &lt;<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/vgl__h__matrix__2d__compute__linear_8h.html">vgl/algo/vgl_h_matrix_2d_compute_linear.h</a>&gt;</span>
<a name="l00031"></a>00031 <span class="preprocessor">#include &lt;<a class="codeRef" doxygen="contrib_gel_vsol.tag:../../../../../contrib/gel/vsol/html" href="../../../../../contrib/gel/vsol/html/vsol__point__2d_8h.html">vsol/vsol_point_2d.h</a>&gt;</span>
<a name="l00032"></a>00032 <span class="preprocessor">#include &lt;<a class="codeRef" doxygen="contrib_gel_vsol.tag:../../../../../contrib/gel/vsol/html" href="../../../../../contrib/gel/vsol/html/vsol__line__2d_8h.html">vsol/vsol_line_2d.h</a>&gt;</span>
<a name="l00033"></a>00033 <span class="preprocessor">#include &lt;<a class="codeRef" doxygen="contrib_brl_bbas_bsol.tag:../../../../../contrib/brl/bbas/bsol/html" href="../../../../../contrib/brl/bbas/bsol/html/bsol__hough__line__index_8h.html">bsol/bsol_hough_line_index.h</a>&gt;</span>
<a name="l00034"></a>00034 <span class="preprocessor">#include &lt;<a class="codeRef" doxygen="contrib_brl_bbas_bsol.tag:../../../../../contrib/brl/bbas/bsol/html" href="../../../../../contrib/brl/bbas/bsol/html/bsol__algs_8h.html">bsol/bsol_algs.h</a>&gt;</span>
<a name="l00035"></a>00035 <span class="preprocessor">#include &lt;<a class="codeRef" doxygen="contrib_brl_bbas_bsol.tag:../../../../../contrib/brl/bbas/bsol/html" href="../../../../../contrib/brl/bbas/bsol/html/bsol__distance__histogram_8h.html">bsol/bsol_distance_histogram.h</a>&gt;</span>
<a name="l00036"></a>00036 <span class="preprocessor">#include &lt;<a class="codeRef" doxygen="core_vnl.tag:../../../../../core/vnl/html" href="../../../../../core/vnl/html/vnl__convolve_8h.html">vnl/algo/vnl_convolve.h</a>&gt;</span>
<a name="l00037"></a>00037 <span class="preprocessor">#include &lt;gevd/gevd_bufferxy.h&gt;</span>
<a name="l00038"></a>00038 <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">double</span> collection_grid_radius = 15;
<a name="l00039"></a>00039 <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">double</span> grid_radius = 15;
<a name="l00040"></a>00040 
<a name="l00041"></a>00041 <span class="keyword">static</span> <span class="keywordtype">void</span> print_lines(vcl_vector&lt;vsol_line_2d_sptr&gt;&amp; lines)
<a name="l00042"></a>00042 {
<a name="l00043"></a>00043   <span class="keywordflow">for</span> (vcl_vector&lt;vsol_line_2d_sptr&gt;::iterator lit = lines.begin(); lit != lines.end();
<a name="l00044"></a>00044        lit++)
<a name="l00045"></a>00045   {
<a name="l00046"></a>00046     <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__line__2d.html">vgl_homg_line_2d&lt;double&gt;</a> <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/vgl__homg__line__2d_8h.html#a1cb503ddd20ff3cf9588d2b5abd202d8">l</a> = (*lit)-&gt;vgl_hline_2d();
<a name="l00047"></a>00047     l.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__line__2d.html#a9cface519ff2e18c6ebc9c4293bd41fa">normalize</a>();
<a name="l00048"></a>00048     vcl_cout &lt;&lt; l &lt;&lt; <span class="charliteral">&#39;\n&#39;</span>;
<a name="l00049"></a>00049   }
<a name="l00050"></a>00050 }
<a name="l00051"></a>00051 
<a name="l00052"></a>00052 
<a name="l00053"></a>00053 <span class="comment">// Gives a sort on signed distance of the</span>
<a name="l00054"></a>00054 <span class="comment">// line from the origin along the line normal.</span>
<a name="l00055"></a>00055 <span class="comment">// note that for line, hl, distance = -hl.c()</span>
<a name="l00056"></a>00056 <span class="keyword">static</span> <span class="keywordtype">bool</span> line_distance(<span class="keyword">const</span> <a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__smart__ptr.html">vsol_line_2d_sptr</a> &amp; l1,
<a name="l00057"></a>00057                           <span class="keyword">const</span> <a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__smart__ptr.html">vsol_line_2d_sptr</a> &amp; l2)
<a name="l00058"></a>00058 {
<a name="l00059"></a>00059   <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__line__2d.html">vgl_homg_line_2d&lt;double&gt;</a> hl1 = l1-&gt;vgl_hline_2d();
<a name="l00060"></a>00060   <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__line__2d.html">vgl_homg_line_2d&lt;double&gt;</a> hl2 = l2-&gt;vgl_hline_2d();
<a name="l00061"></a>00061   hl1.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__line__2d.html#a9cface519ff2e18c6ebc9c4293bd41fa">normalize</a>(); hl2.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__line__2d.html#a9cface519ff2e18c6ebc9c4293bd41fa">normalize</a>();
<a name="l00062"></a>00062   <span class="keywordflow">return</span> hl1.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__line__2d.html#a9fb1d3fe8edd8f30c8d190f721b160a6">c</a>() &gt; hl2.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__line__2d.html#a9fb1d3fe8edd8f30c8d190f721b160a6">c</a>();
<a name="l00063"></a>00063 }
<a name="l00064"></a>00064 
<a name="l00065"></a>00065 <span class="preprocessor">#if 0</span>
<a name="l00066"></a>00066 <span class="preprocessor"></span>line_chamfer_1d::line_chamfer_1d()
<a name="l00067"></a>00067 {
<a name="l00068"></a>00068   size_=0;
<a name="l00069"></a>00069   dmin_=0;
<a name="l00070"></a>00070   dmax_=0;
<a name="l00071"></a>00071 }
<a name="l00072"></a>00072 
<a name="l00073"></a>00073 line_chamfer_1d::~line_chamfer_1d()
<a name="l00074"></a>00074 {
<a name="l00075"></a>00075   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i&lt;size_; i++)
<a name="l00076"></a>00076     <span class="keyword">delete</span> line_index_[i];
<a name="l00077"></a>00077 }
<a name="l00078"></a>00078 
<a name="l00079"></a>00079 <span class="keywordtype">bool</span> line_chamfer_1d::insert_lines(vcl_vector&lt;vsol_line_2d_sptr&gt; <span class="keyword">const</span>&amp; lines,
<a name="l00080"></a>00080                                    <span class="keywordtype">bool</span> horizontal_lines)
<a name="l00081"></a>00081 {
<a name="l00082"></a>00082   <span class="keywordflow">if</span> (!lines.size())
<a name="l00083"></a>00083     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00084"></a>00084   dmin_ = vnl_numeric_traits&lt;double&gt;::maxval;
<a name="l00085"></a>00085   dmax_ = -dmin_;
<a name="l00086"></a>00086   distances_.clear();
<a name="l00087"></a>00087 
<a name="l00088"></a>00088   <span class="keywordflow">for</span> (vcl_vector&lt;vsol_line_2d_sptr&gt;::const_iterator lit = lines.begin();
<a name="l00089"></a>00089        lit != lines.end(); lit++)
<a name="l00090"></a>00090   {
<a name="l00091"></a>00091     <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__line__2d.html">vgl_homg_line_2d&lt;double&gt;</a> l = (*lit)-&gt;vgl_hline_2d();
<a name="l00092"></a>00092     l.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__line__2d.html#a9cface519ff2e18c6ebc9c4293bd41fa">normalize</a>();
<a name="l00093"></a>00093     <span class="keywordtype">double</span> d = -l.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__line__2d.html#a9fb1d3fe8edd8f30c8d190f721b160a6">c</a>(); <span class="comment">// perpendicular distance</span>
<a name="l00094"></a>00094     distances_.push_back(d);
<a name="l00095"></a>00095     dmin_ = <a class="codeRef" doxygen="core_vnl.tag:../../../../../core/vnl/html" href="../../../../../core/vnl/html/vnl__decnum_8h.html#ac7064c7fc83d5d457e5f903eacac9f73">vnl_math_min</a>(d,dmin_);
<a name="l00096"></a>00096     dmax_ = <a class="codeRef" doxygen="core_vnl.tag:../../../../../core/vnl/html" href="../../../../../core/vnl/html/vnl__decnum_8h.html#a17c47eb693cfd88c7b181b162eca8dec">vnl_math_max</a>(d,dmax_);
<a name="l00097"></a>00097   }
<a name="l00098"></a>00098   <span class="keywordflow">if</span> (!(dmax_&gt;=dmin_))
<a name="l00099"></a>00099     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00100"></a>00100   size_=(int)(dmax_-dmin_ +1);
<a name="l00101"></a>00101   index_.resize(size_, <a class="codeRef" doxygen="core_vnl.tag:../../../../../core/vnl/html" href="../../../../../core/vnl/html/classvnl__numeric__traits_3_01int_01_4.html#ac6ad36b5e5346b1db8942e6d74c6b3d3">vnl_numeric_traits&lt;int&gt;::maxval</a>);
<a name="l00102"></a>00102 
<a name="l00103"></a>00103   line_index_.resize(size_);
<a name="l00104"></a>00104   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i&lt;size_; i++)
<a name="l00105"></a>00105     line_index_[i]= <span class="keyword">new</span> vcl_vector&lt;vsol_line_2d_sptr&gt;;
<a name="l00106"></a>00106 
<a name="l00107"></a>00107   <span class="keywordtype">int</span> line = 0;
<a name="l00108"></a>00108   <span class="keywordflow">for</span> (vcl_vector&lt;double&gt;::iterator dit = distances_.begin();
<a name="l00109"></a>00109        dit != distances_.end(); dit++, line++)
<a name="l00110"></a>00110   {
<a name="l00111"></a>00111     <span class="keywordtype">int</span> <span class="keywordtype">id</span> = (int)((*dit)-dmin_);
<a name="l00112"></a>00112     index_[id]=0;
<a name="l00113"></a>00113     line_index_[id]-&gt;push_back(lines[line]);
<a name="l00114"></a>00114   }
<a name="l00115"></a>00115   this-&gt;forward_champher();
<a name="l00116"></a>00116   this-&gt;backward_champher();
<a name="l00117"></a>00117 <span class="preprocessor">#ifdef DEBUG</span>
<a name="l00118"></a>00118 <span class="preprocessor"></span>   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i&lt;size_; i++)
<a name="l00119"></a>00119      vcl_cout &lt;&lt; <span class="stringliteral">&quot;line_index_[&quot;</span>&lt;&lt;i+(<span class="keywordtype">int</span>)dmin_&lt;&lt;<span class="stringliteral">&quot;]=&quot;</span>&lt;&lt;line_index_[i]-&gt;size() &lt;&lt; <span class="charliteral">&#39;\n&#39;</span>;
<a name="l00120"></a>00120 <span class="preprocessor">#endif</span>
<a name="l00121"></a>00121 <span class="preprocessor"></span>  <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00122"></a>00122 }
<a name="l00123"></a>00123 
<a name="l00124"></a>00124 <span class="keywordtype">void</span> line_chamfer_1d::forward_champher()
<a name="l00125"></a>00125 {
<a name="l00126"></a>00126   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 1; i&lt;size_; i++)
<a name="l00127"></a>00127     <span class="keywordflow">if</span> (index_[i-1]+1&lt;=index_[i])
<a name="l00128"></a>00128       index_[i]=index_[i-1]+1;
<a name="l00129"></a>00129 }
<a name="l00130"></a>00130 
<a name="l00131"></a>00131 <span class="keywordtype">void</span> line_chamfer_1d::backward_champher()
<a name="l00132"></a>00132 {
<a name="l00133"></a>00133   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = size_-2; i&gt;=0; i--)
<a name="l00134"></a>00134     <span class="keywordflow">if</span> (index_[i]&gt;index_[i+1]+1)
<a name="l00135"></a>00135       index_[i]=index_[i+1]+1;
<a name="l00136"></a>00136 }
<a name="l00137"></a>00137 
<a name="l00138"></a>00138 <span class="keywordtype">double</span> line_chamfer_1d::distance(<span class="keywordtype">double</span> x)<span class="keyword"> const</span>
<a name="l00139"></a>00139 <span class="keyword"></span>{
<a name="l00140"></a>00140   <span class="keywordflow">if</span> (x&lt;dmin_)
<a name="l00141"></a>00141     <span class="keywordflow">return</span> vnl_numeric_traits&lt;double&gt;::maxval;
<a name="l00142"></a>00142   <span class="keywordflow">if</span> (x&gt;dmax_)
<a name="l00143"></a>00143     <span class="keywordflow">return</span> vnl_numeric_traits&lt;double&gt;::maxval;
<a name="l00144"></a>00144   <span class="keywordtype">int</span> i = (int)(x-dmin_);
<a name="l00145"></a>00145   <span class="keywordflow">return</span> index_[i];
<a name="l00146"></a>00146 }
<a name="l00147"></a>00147 
<a name="l00148"></a>00148 <span class="keywordtype">bool</span>
<a name="l00149"></a>00149 line_chamfer_1d::get_lines_in_interval(<span class="keyword">const</span> <span class="keywordtype">double</span> x,
<a name="l00150"></a>00150                                        <span class="keyword">const</span> <span class="keywordtype">double</span> radius,
<a name="l00151"></a>00151                                        vcl_vector&lt;vsol_line_2d_sptr&gt;&amp; lines)<span class="keyword"> const</span>
<a name="l00152"></a>00152 <span class="keyword"></span>{
<a name="l00153"></a>00153   lines.clear();
<a name="l00154"></a>00154   <span class="keywordflow">if</span> (x&lt;dmin_)
<a name="l00155"></a>00155     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00156"></a>00156   <span class="keywordflow">if</span> (x&gt;dmax_)
<a name="l00157"></a>00157     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00158"></a>00158   <span class="keywordtype">double</span> x0 = x - dmin_;
<a name="l00159"></a>00159   <span class="keywordtype">int</span> lo = (int)(x0 - radius);
<a name="l00160"></a>00160   <span class="keywordtype">int</span> hi = (int)(x0 + radius);
<a name="l00161"></a>00161   <span class="keywordflow">if</span> (lo&lt;0)
<a name="l00162"></a>00162     lo=0;
<a name="l00163"></a>00163   <span class="keywordflow">if</span> (hi&gt;(size_-1))
<a name="l00164"></a>00164     hi = size_ - 1;
<a name="l00165"></a>00165   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> d = lo; d&lt;=hi; d++)
<a name="l00166"></a>00166     <span class="keywordflow">if</span> (line_index_[d])
<a name="l00167"></a>00167       <span class="keywordflow">for</span> (vcl_vector&lt;vsol_line_2d_sptr&gt;::iterator lit=line_index_[d]-&gt;begin();
<a name="l00168"></a>00168            lit != line_index_[d]-&gt;end(); lit++)
<a name="l00169"></a>00169         lines.push_back(*lit);
<a name="l00170"></a>00170   <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00171"></a>00171 }
<a name="l00172"></a>00172 <span class="preprocessor">#endif</span>
<a name="l00173"></a>00173 <span class="preprocessor"></span>
<a name="l00174"></a>00174 <span class="comment">// DEC - use total length of lines within radius instead of distance to nearest</span>
<a name="l00175"></a><a class="code" href="classgrid__profile__matcher.html#acc0ad5b273aeb2caa5503fdc0da706d7">00175</a> <a class="code" href="classgrid__profile__matcher.html#acc0ad5b273aeb2caa5503fdc0da706d7">grid_profile_matcher::grid_profile_matcher</a>()
<a name="l00176"></a>00176 {
<a name="l00177"></a>00177   size_=0;
<a name="l00178"></a>00178   dmin_=0;
<a name="l00179"></a>00179   <a class="code" href="classgrid__profile__matcher.html#ab7edcdabfab052a74a2e8a4c3208b988">dmax_</a>=0;
<a name="l00180"></a>00180 }
<a name="l00181"></a>00181 
<a name="l00182"></a><a class="code" href="classgrid__profile__matcher.html#a25eb5a5636292cf4396aeebc68158d4f">00182</a> <a class="code" href="classgrid__profile__matcher.html#a25eb5a5636292cf4396aeebc68158d4f">grid_profile_matcher::~grid_profile_matcher</a>()
<a name="l00183"></a>00183 {
<a name="l00184"></a>00184   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i&lt;<a class="code" href="classgrid__profile__matcher.html#aaf4bfd03e97011813fc3cb211211aab5">size_</a>; i++)
<a name="l00185"></a>00185     <span class="keyword">delete</span> <a class="code" href="classgrid__profile__matcher.html#a701c416214deb5b03a2929b2b11f02eb">line_index_</a>[i];
<a name="l00186"></a>00186 }
<a name="l00187"></a>00187 
<a name="l00188"></a><a class="code" href="classgrid__profile__matcher.html#af53289908e1c451ba78fc7e20e09be32">00188</a> <span class="keywordtype">bool</span> <a class="code" href="classgrid__profile__matcher.html#af53289908e1c451ba78fc7e20e09be32">grid_profile_matcher::insert_lines</a>(vcl_vector&lt;vsol_line_2d_sptr&gt; <span class="keyword">const</span>&amp; lines,
<a name="l00189"></a>00189                                         <span class="keywordtype">bool</span> horizontal_lines)
<a name="l00190"></a>00190 {
<a name="l00191"></a>00191   <span class="keywordflow">if</span> (!lines.size())
<a name="l00192"></a>00192     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00193"></a>00193   dmin_ = vnl_numeric_traits&lt;double&gt;::maxval;
<a name="l00194"></a>00194   <a class="code" href="classgrid__profile__matcher.html#ab7edcdabfab052a74a2e8a4c3208b988">dmax_</a> = -<a class="code" href="classgrid__profile__matcher.html#ab651bb6e52ee6e5b96e96fd4a2812c57">dmin_</a>;
<a name="l00195"></a>00195   <a class="code" href="classgrid__profile__matcher.html#acde42929771958640ade9a0268843e8b">distances_</a>.clear();
<a name="l00196"></a>00196   <span class="keywordflow">for</span> (vcl_vector&lt;vsol_line_2d_sptr&gt;::const_iterator lit = lines.begin();
<a name="l00197"></a>00197        lit != lines.end(); lit++)
<a name="l00198"></a>00198   {
<a name="l00199"></a>00199     <span class="keywordtype">double</span> d;
<a name="l00200"></a>00200 <span class="preprocessor">#ifdef USE_C_FOR_DISTANCE</span>
<a name="l00201"></a>00201 <span class="preprocessor"></span>    <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__line__2d.html">vgl_homg_line_2d&lt;double&gt;</a> l = (*lit)-&gt;vgl_hline_2d();
<a name="l00202"></a>00202     l.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__line__2d.html#a9cface519ff2e18c6ebc9c4293bd41fa">normalize</a>();
<a name="l00203"></a>00203     d = -l.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__line__2d.html#a9fb1d3fe8edd8f30c8d190f721b160a6">c</a>(); <span class="comment">// perpendicular distance</span>
<a name="l00204"></a>00204 <span class="preprocessor">#else</span>
<a name="l00205"></a>00205 <span class="preprocessor"></span>    <a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__smart__ptr.html">vsol_point_2d_sptr</a> mid = (*lit)-&gt;middle();
<a name="l00206"></a>00206     <span class="keywordflow">if</span> (horizontal_lines)
<a name="l00207"></a>00207       d = mid-&gt;y();
<a name="l00208"></a>00208     <span class="keywordflow">else</span>
<a name="l00209"></a>00209       d = mid-&gt;x();
<a name="l00210"></a>00210 <span class="preprocessor">#endif</span>
<a name="l00211"></a>00211 <span class="preprocessor"></span>    <a class="code" href="classgrid__profile__matcher.html#acde42929771958640ade9a0268843e8b">distances_</a>.push_back(d);
<a name="l00212"></a>00212     dmin_ = <a class="codeRef" doxygen="core_vnl.tag:../../../../../core/vnl/html" href="../../../../../core/vnl/html/vnl__decnum_8h.html#ac7064c7fc83d5d457e5f903eacac9f73">vnl_math_min</a>(d,dmin_);
<a name="l00213"></a>00213     <a class="code" href="classgrid__profile__matcher.html#ab7edcdabfab052a74a2e8a4c3208b988">dmax_</a> = <a class="codeRef" doxygen="core_vnl.tag:../../../../../core/vnl/html" href="../../../../../core/vnl/html/vnl__decnum_8h.html#a17c47eb693cfd88c7b181b162eca8dec">vnl_math_max</a>(d,<a class="code" href="classgrid__profile__matcher.html#ab7edcdabfab052a74a2e8a4c3208b988">dmax_</a>);
<a name="l00214"></a>00214   }
<a name="l00215"></a>00215   <span class="keywordflow">if</span> (!(<a class="code" href="classgrid__profile__matcher.html#ab7edcdabfab052a74a2e8a4c3208b988">dmax_</a>&gt;=dmin_))
<a name="l00216"></a>00216     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00217"></a>00217   size_=(int)(<a class="code" href="classgrid__profile__matcher.html#ab7edcdabfab052a74a2e8a4c3208b988">dmax_</a>-dmin_ +1);
<a name="l00218"></a>00218   <a class="code" href="classgrid__profile__matcher.html#a81cd5b5cf3f82dbe793e577857548196">image_profile_</a>.<a class="codeRef" doxygen="core_vnl.tag:../../../../../core/vnl/html" href="../../../../../core/vnl/html/classvnl__vector.html#ae34b3cfb08e104f2ac81a74dc91537cc">set_size</a>(size_);
<a name="l00219"></a>00219   <a class="code" href="classgrid__profile__matcher.html#a81cd5b5cf3f82dbe793e577857548196">image_profile_</a>.<a class="codeRef" doxygen="core_vnl.tag:../../../../../core/vnl/html" href="../../../../../core/vnl/html/classvnl__vector.html#a9939177982a578e13b05cc5e80f96a14">fill</a>(0.0);
<a name="l00220"></a>00220 
<a name="l00221"></a>00221   <a class="code" href="classgrid__profile__matcher.html#a701c416214deb5b03a2929b2b11f02eb">line_index_</a>.resize(size_);
<a name="l00222"></a>00222   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i&lt;<a class="code" href="classgrid__profile__matcher.html#aaf4bfd03e97011813fc3cb211211aab5">size_</a>; i++)
<a name="l00223"></a>00223     <a class="code" href="classgrid__profile__matcher.html#a701c416214deb5b03a2929b2b11f02eb">line_index_</a>[i]= <span class="keyword">new</span> vcl_vector&lt;vsol_line_2d_sptr&gt;;
<a name="l00224"></a>00224 
<a name="l00225"></a>00225   <span class="keywordtype">int</span> line = 0;
<a name="l00226"></a>00226   <span class="keywordflow">for</span> (vcl_vector&lt;double&gt;::iterator dit = <a class="code" href="classgrid__profile__matcher.html#acde42929771958640ade9a0268843e8b">distances_</a>.begin();
<a name="l00227"></a>00227        dit != <a class="code" href="classgrid__profile__matcher.html#acde42929771958640ade9a0268843e8b">distances_</a>.end(); dit++, line++)
<a name="l00228"></a>00228   {
<a name="l00229"></a>00229     <span class="keywordtype">int</span> <span class="keywordtype">id</span> = (int)((*dit)-<a class="code" href="classgrid__profile__matcher.html#ab651bb6e52ee6e5b96e96fd4a2812c57">dmin_</a>);
<a name="l00230"></a>00230     <a class="code" href="classgrid__profile__matcher.html#a81cd5b5cf3f82dbe793e577857548196">image_profile_</a>[id] += lines[line]-&gt;length();
<a name="l00231"></a>00231     <a class="code" href="classgrid__profile__matcher.html#a701c416214deb5b03a2929b2b11f02eb">line_index_</a>[id]-&gt;push_back(lines[line]);
<a name="l00232"></a>00232   }
<a name="l00233"></a>00233 
<a name="l00234"></a>00234   <span class="keywordflow">if</span> (<span class="keyword">false</span>)
<a name="l00235"></a>00235   {
<a name="l00236"></a>00236     <span class="keywordflow">if</span> (horizontal_lines)
<a name="l00237"></a>00237       vcl_cout &lt;&lt; <span class="stringliteral">&quot;------horizontal profile: ---------\n&quot;</span>;
<a name="l00238"></a>00238     <span class="keywordflow">else</span>
<a name="l00239"></a>00239       vcl_cout &lt;&lt; <span class="stringliteral">&quot;------vertical profile: -----------\n&quot;</span>;
<a name="l00240"></a>00240     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="classgrid__profile__matcher.html#aaf4bfd03e97011813fc3cb211211aab5">size_</a>; i++)
<a name="l00241"></a>00241     {
<a name="l00242"></a>00242       vcl_cout &lt;&lt;<span class="stringliteral">&quot;profile[&quot;</span>&lt;&lt;int(i+dmin_)&lt;&lt;<span class="stringliteral">&quot;] =  &quot;</span>&lt;&lt;<a class="code" href="classgrid__profile__matcher.html#a81cd5b5cf3f82dbe793e577857548196">image_profile_</a>[i]&lt;&lt;<span class="charliteral">&#39;\n&#39;</span>;
<a name="l00243"></a>00243     }
<a name="l00244"></a>00244   }
<a name="l00245"></a>00245   <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00246"></a>00246 }
<a name="l00247"></a>00247 
<a name="l00248"></a>00248 <span class="keywordtype">bool</span>
<a name="l00249"></a><a class="code" href="classgrid__profile__matcher.html#a113460f59a988d1f4c8873ca3aa8ce9c">00249</a> <a class="code" href="classgrid__profile__matcher.html#a113460f59a988d1f4c8873ca3aa8ce9c">grid_profile_matcher::get_lines_in_interval</a>(<span class="keyword">const</span> <span class="keywordtype">double</span> x,
<a name="l00250"></a>00250                                             <span class="keyword">const</span> <span class="keywordtype">double</span> radius,
<a name="l00251"></a>00251                                             vcl_vector&lt;vsol_line_2d_sptr&gt;&amp; lines)<span class="keyword"> const</span>
<a name="l00252"></a>00252 <span class="keyword"></span>{
<a name="l00253"></a>00253   lines.clear();
<a name="l00254"></a>00254   <span class="keywordflow">if</span> (x&lt;dmin_)
<a name="l00255"></a>00255     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00256"></a>00256   <span class="keywordflow">if</span> (x&gt;<a class="code" href="classgrid__profile__matcher.html#ab7edcdabfab052a74a2e8a4c3208b988">dmax_</a>)
<a name="l00257"></a>00257     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00258"></a>00258   <span class="keywordtype">double</span> x0 = x - <a class="code" href="classgrid__profile__matcher.html#ab651bb6e52ee6e5b96e96fd4a2812c57">dmin_</a>;
<a name="l00259"></a>00259   <span class="keywordtype">int</span> lo = (int)(x0 - radius);
<a name="l00260"></a>00260   <span class="keywordtype">int</span> hi = (int)(x0 + radius);
<a name="l00261"></a>00261   <span class="keywordflow">if</span> (lo&lt;0)
<a name="l00262"></a>00262     lo=0;
<a name="l00263"></a>00263   <span class="keywordflow">if</span> (hi&gt;(size_-1))
<a name="l00264"></a>00264     hi = size_ - 1;
<a name="l00265"></a>00265   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> d = lo; d&lt;=hi; d++)
<a name="l00266"></a>00266     <span class="keywordflow">if</span> (<a class="code" href="classgrid__profile__matcher.html#a701c416214deb5b03a2929b2b11f02eb">line_index_</a>[d])
<a name="l00267"></a>00267       <span class="keywordflow">for</span> (vcl_vector&lt;vsol_line_2d_sptr&gt;::iterator lit=<a class="code" href="classgrid__profile__matcher.html#a701c416214deb5b03a2929b2b11f02eb">line_index_</a>[d]-&gt;begin();
<a name="l00268"></a>00268            lit != <a class="code" href="classgrid__profile__matcher.html#a701c416214deb5b03a2929b2b11f02eb">line_index_</a>[d]-&gt;end(); lit++)
<a name="l00269"></a>00269         lines.push_back(*lit);
<a name="l00270"></a>00270   <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00271"></a>00271 }
<a name="l00272"></a>00272 
<a name="l00273"></a><a class="code" href="classgrid__profile__matcher.html#acb8dc8122fb13221f593fcb6d5dacfa3">00273</a> <span class="keywordtype">double</span> <a class="code" href="classgrid__profile__matcher.html#acb8dc8122fb13221f593fcb6d5dacfa3">grid_profile_matcher::calculate_grid_offset</a>(<span class="keywordtype">int</span> n_grid_lines, <span class="keywordtype">double</span> spacing)
<a name="l00274"></a>00274 {
<a name="l00275"></a>00275   <span class="comment">// construct grid profile vector</span>
<a name="l00276"></a>00276   <span class="keywordtype">int</span> grid_profile_len = int((n_grid_lines+1) * spacing) + 1;
<a name="l00277"></a>00277   <a class="codeRef" doxygen="core_vnl.tag:../../../../../core/vnl/html" href="../../../../../core/vnl/html/classvnl__vector.html">vnl_vector&lt;double&gt;</a> grid_profile(grid_profile_len,0.0);
<a name="l00278"></a>00278   <span class="keywordtype">int</span> max_offset = int(grid_radius);
<a name="l00279"></a>00279 <span class="preprocessor">#ifdef DEBUG</span>
<a name="l00280"></a>00280 <span class="preprocessor"></span>  vcl_cout &lt;&lt;<span class="stringliteral">&quot;max_offset = &quot;</span>&lt;&lt;max_offset&lt;&lt;<span class="charliteral">&#39;\n&#39;</span>;
<a name="l00281"></a>00281 <span class="preprocessor">#endif</span>
<a name="l00282"></a>00282 <span class="preprocessor"></span>  <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 1; i &lt;= n_grid_lines; i++)
<a name="l00283"></a>00283   {
<a name="l00284"></a>00284     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="classgrid__profile__matcher.html#ac7bd612cf42ff443a3b63076d75ebc1b">offset</a> = -max_offset; <a class="code" href="classgrid__profile__matcher.html#ac7bd612cf42ff443a3b63076d75ebc1b">offset</a> &lt; max_offset; <a class="code" href="classgrid__profile__matcher.html#ac7bd612cf42ff443a3b63076d75ebc1b">offset</a>++)
<a name="l00285"></a>00285     {
<a name="l00286"></a>00286       grid_profile[int(i*spacing)+<a class="code" href="classgrid__profile__matcher.html#ac7bd612cf42ff443a3b63076d75ebc1b">offset</a>] = ((double)(max_offset -
<a name="l00287"></a>00287                                                       vcl_abs(<span class="keywordtype">double</span>(<a class="code" href="classgrid__profile__matcher.html#ac7bd612cf42ff443a3b63076d75ebc1b">offset</a>))))/(max_offset);
<a name="l00288"></a>00288     }
<a name="l00289"></a>00289   }
<a name="l00290"></a>00290 <span class="preprocessor">#ifdef DEBUG</span>
<a name="l00291"></a>00291 <span class="preprocessor"></span>    vcl_cout &lt;&lt; <span class="stringliteral">&quot;___GRID PROFILE__\n&quot;</span>;
<a name="l00292"></a>00292     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; grid_profile_len; i++)
<a name="l00293"></a>00293       vcl_cout &lt;&lt; <span class="stringliteral">&quot;grid_profile[&quot;</span>&lt;&lt;i&lt;&lt;<span class="stringliteral">&quot;] = &quot;</span>&lt;&lt;grid_profile[i]&lt;&lt;<span class="charliteral">&#39;\n&#39;</span>;
<a name="l00294"></a>00294 <span class="preprocessor">#endif</span>
<a name="l00295"></a>00295 <span class="preprocessor"></span>  <span class="comment">// now convolve with image profile</span>
<a name="l00296"></a>00296   <a class="codeRef" doxygen="core_vnl.tag:../../../../../core/vnl/html" href="../../../../../core/vnl/html/classvnl__vector.html">vnl_vector&lt;double&gt;</a> convolution = <a class="codeRef" doxygen="core_vnl.tag:../../../../../core/vnl/html" href="../../../../../core/vnl/html/vnl__convolve_8h.html#ab5ae26b46411a846c62865594be91f42">vnl_convolve</a>(<a class="code" href="classgrid__profile__matcher.html#a81cd5b5cf3f82dbe793e577857548196">image_profile_</a>,grid_profile,0);
<a name="l00297"></a>00297   <span class="comment">// max value in convolution should correspond to best grid offset</span>
<a name="l00298"></a>00298   <span class="keywordtype">double</span> max_value = -vnl_numeric_traits&lt;double&gt;::maxval;
<a name="l00299"></a>00299   <span class="keywordtype">int</span> max_index = -1;
<a name="l00300"></a>00300 <span class="preprocessor">#ifdef DEBUG</span>
<a name="l00301"></a>00301 <span class="preprocessor"></span>  vcl_cout &lt;&lt; <span class="stringliteral">&quot;__CONVOLUTION__\n&quot;</span>;
<a name="l00302"></a>00302 <span class="preprocessor">#endif</span>
<a name="l00303"></a>00303 <span class="preprocessor"></span>  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; convolution.<a class="codeRef" doxygen="core_vnl.tag:../../../../../core/vnl/html" href="../../../../../core/vnl/html/classvnl__vector.html#a11191c91a1dbb4e1d8423dad8b110712">size</a>(); i++)
<a name="l00304"></a>00304   {
<a name="l00305"></a>00305 <span class="preprocessor">#ifdef DEBUG</span>
<a name="l00306"></a>00306 <span class="preprocessor"></span>    vcl_cout &lt;&lt; <span class="stringliteral">&quot;convolution[&quot;</span>&lt;&lt;i-grid_profile_len+spacing+dmin_&lt;&lt;<span class="stringliteral">&quot;] = &quot;</span>&lt;&lt;convolution[i]&lt;&lt;<span class="charliteral">&#39;\n&#39;</span>;
<a name="l00307"></a>00307 <span class="preprocessor">#endif</span>
<a name="l00308"></a>00308 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (convolution[i] &gt; max_value)
<a name="l00309"></a>00309     {
<a name="l00310"></a>00310       max_index = i;
<a name="l00311"></a>00311       max_value = convolution[i];
<a name="l00312"></a>00312     }
<a name="l00313"></a>00313   }
<a name="l00314"></a>00314   <span class="keywordflow">return</span> max_index - grid_profile_len + spacing + <a class="code" href="classgrid__profile__matcher.html#ab651bb6e52ee6e5b96e96fd4a2812c57">dmin_</a>;
<a name="l00315"></a>00315 }
<a name="l00316"></a>00316 
<a name="l00317"></a>00317 <span class="comment">//---------------------------------------------------------------</span>
<a name="l00318"></a>00318 <span class="comment">// Constructors</span>
<a name="l00319"></a>00319 <span class="comment">//</span>
<a name="l00320"></a>00320 <span class="comment">//----------------------------------------------------------------</span>
<a name="l00321"></a>00321 
<a name="l00322"></a>00322 <span class="comment">//: constructor from a parameter block (the only way)</span>
<a name="l00323"></a>00323 <span class="comment">//</span>
<a name="l00324"></a><a class="code" href="classsdet__grid__finder.html#afed6483607c26031f149c12e129ef0be">00324</a> <a class="code" href="classsdet__grid__finder.html#afed6483607c26031f149c12e129ef0be" title="constructor from a parameter block (the only way).">sdet_grid_finder::sdet_grid_finder</a>(<a class="code" href="classsdet__grid__finder__params.html">sdet_grid_finder_params</a>&amp; gfp)
<a name="l00325"></a>00325   : <a class="code" href="classsdet__grid__finder__params.html">sdet_grid_finder_params</a>(gfp),
<a name="l00326"></a>00326     length_threshold_(15.0)
<a name="l00327"></a>00327 {
<a name="l00328"></a>00328   <a class="code" href="classsdet__grid__finder.html#a93a647068795e241d0431fe2a4851a15" title="members.">groups_valid_</a> = <span class="keyword">false</span>;
<a name="l00329"></a>00329   <a class="code" href="classsdet__grid__finder.html#adc791552e6af41cd5255d5266828256d">vanishing_points_valid_</a>=<span class="keyword">false</span>;
<a name="l00330"></a>00330   <a class="code" href="classsdet__grid__finder.html#adf5ce6ac42e5f286f57acd43be27ed94">projective_homography_valid_</a> = <span class="keyword">false</span>;
<a name="l00331"></a>00331   <a class="code" href="classsdet__grid__finder.html#a4e263ed701ac653df5ba092d1b0cc957">affine_homography_valid_</a> = <span class="keyword">false</span>;
<a name="l00332"></a>00332   <a class="code" href="classsdet__grid__finder.html#aaa6f3265f9273ea468a69cd33c9906ea">homography_valid_</a> = <span class="keyword">false</span>;
<a name="l00333"></a>00333   <a class="code" href="classsdet__grid__finder.html#a2482080001360cf04ad30549ad078ffa">index_</a> = 0;
<a name="l00334"></a>00334 }
<a name="l00335"></a>00335 
<a name="l00336"></a>00336 <span class="comment">//:Default Destructor</span>
<a name="l00337"></a><a class="code" href="classsdet__grid__finder.html#ae5504e289228d33790fd1dd309115198">00337</a> <a class="code" href="classsdet__grid__finder.html#ae5504e289228d33790fd1dd309115198" title="Default Destructor.">sdet_grid_finder::~sdet_grid_finder</a>()
<a name="l00338"></a>00338 {
<a name="l00339"></a>00339 }
<a name="l00340"></a>00340 
<a name="l00341"></a>00341 <span class="keyword">static</span> <span class="keywordtype">void</span> group_angle_stats(vcl_vector&lt;vsol_line_2d_sptr&gt; <span class="keyword">const</span> &amp; group,
<a name="l00342"></a>00342                               <span class="keyword">const</span> <span class="keywordtype">double</span> angle_tol,
<a name="l00343"></a>00343                               <span class="keywordtype">double</span> &amp; avg_angle, <span class="keywordtype">double</span>&amp; min_angle,
<a name="l00344"></a>00344                               <span class="keywordtype">double</span>&amp; max_angle)
<a name="l00345"></a>00345 {
<a name="l00346"></a>00346   min_angle = 360;
<a name="l00347"></a>00347   max_angle = -360;
<a name="l00348"></a>00348   <span class="keywordtype">int</span> n_lines = 0;
<a name="l00349"></a>00349   avg_angle=0;
<a name="l00350"></a>00350 
<a name="l00351"></a>00351   <span class="keywordflow">for</span> (vcl_vector&lt;vsol_line_2d_sptr&gt;::const_iterator lit = group.begin();
<a name="l00352"></a>00352        lit != group.end(); lit++)
<a name="l00353"></a>00353   {
<a name="l00354"></a>00354     <span class="keywordtype">double</span> ang = (*lit)-&gt;tangent_angle();
<a name="l00355"></a>00355     <span class="keywordflow">if</span> (ang&gt;180)
<a name="l00356"></a>00356       ang -= 180.0;
<a name="l00357"></a>00357     <span class="keywordflow">if</span> (ang&lt;min_angle)
<a name="l00358"></a>00358       min_angle = ang;
<a name="l00359"></a>00359     <span class="keywordflow">if</span> (ang&gt;max_angle)
<a name="l00360"></a>00360       max_angle = ang;
<a name="l00361"></a>00361   }
<a name="l00362"></a>00362   <span class="comment">// See if we are on the 180-0 cut</span>
<a name="l00363"></a>00363   <span class="keywordtype">double</span> cut_thresh = 3.0*angle_tol + 15.0;
<a name="l00364"></a>00364   <span class="keywordtype">bool</span> on_cut = (max_angle-min_angle)&gt;cut_thresh;
<a name="l00365"></a>00365   <span class="keywordflow">if</span> (on_cut)
<a name="l00366"></a>00366     vcl_cout &lt;&lt; <span class="stringliteral">&quot;On cut [&quot;</span> &lt;&lt; min_angle &lt;&lt; <span class="charliteral">&#39; &#39;</span> &lt;&lt; max_angle &lt;&lt; <span class="stringliteral">&quot;] &gt;&quot;</span>
<a name="l00367"></a>00367              &lt;&lt; cut_thresh &lt;&lt; <span class="charliteral">&#39;\n&#39;</span>;
<a name="l00368"></a>00368   <span class="keywordflow">for</span> (vcl_vector&lt;vsol_line_2d_sptr&gt;::const_iterator lit = group.begin();
<a name="l00369"></a>00369        lit != group.end(); lit++, n_lines++)
<a name="l00370"></a>00370   {
<a name="l00371"></a>00371     <span class="keywordtype">double</span> ang = (*lit)-&gt;tangent_angle();
<a name="l00372"></a>00372     <span class="keywordflow">if</span> (ang&gt;180.0)
<a name="l00373"></a>00373       ang-=180.0;
<a name="l00374"></a>00374     <span class="keywordflow">if</span> (on_cut&amp;&amp;ang&gt;90)
<a name="l00375"></a>00375       ang -=180;
<a name="l00376"></a>00376     avg_angle += ang;
<a name="l00377"></a>00377   }
<a name="l00378"></a>00378   <span class="keywordflow">if</span> (n_lines)
<a name="l00379"></a>00379   {
<a name="l00380"></a>00380     avg_angle /= n_lines;
<a name="l00381"></a>00381   }
<a name="l00382"></a>00382   <span class="keywordflow">else</span>
<a name="l00383"></a>00383     avg_angle=0;
<a name="l00384"></a>00384 }
<a name="l00385"></a>00385 
<a name="l00386"></a>00386 <span class="comment">//-------------------------------------------------------------------------</span>
<a name="l00387"></a>00387 <span class="comment">//: Set the edges to be processed</span>
<a name="l00388"></a>00388 <span class="comment">//</span>
<a name="l00389"></a><a class="code" href="classsdet__grid__finder.html#a3789179d7a65dda7914d0d6171376a3e">00389</a> <span class="keywordtype">bool</span> <a class="code" href="classsdet__grid__finder.html#a3789179d7a65dda7914d0d6171376a3e" title="if there are less than 2 dominant groups then return false.">sdet_grid_finder::set_lines</a>(<span class="keyword">const</span> <span class="keywordtype">float</span> xsize, <span class="keyword">const</span> <span class="keywordtype">float</span> ysize,
<a name="l00390"></a>00390                                  vcl_vector&lt;vsol_line_2d_sptr&gt; <span class="keyword">const</span>&amp; lines)
<a name="l00391"></a>00391 {
<a name="l00392"></a>00392   <a class="code" href="classsdet__grid__finder.html#aa9d28ec6718fcfab52eaa2eef52a9fdf">debug_lines_</a>.clear();
<a name="l00393"></a>00393   <a class="code" href="classsdet__grid__finder.html#a433d404aac637bbba94656ecec0f5e47">debug_grid_lines_</a>.clear();
<a name="l00394"></a>00394   <a class="code" href="classsdet__grid__finder.html#af8741f73fabae9955adedb5a086e7333">display_lines_</a>.clear();
<a name="l00395"></a>00395   <a class="code" href="classsdet__grid__finder.html#ade4391e462f73ecad1afe151d2e2667a">matched_lines_</a>.clear();
<a name="l00396"></a>00396   <a class="code" href="classsdet__grid__finder.html#a93a647068795e241d0431fe2a4851a15" title="members.">groups_valid_</a> = <span class="keyword">false</span>;
<a name="l00397"></a>00397   <a class="code" href="classsdet__grid__finder.html#adc791552e6af41cd5255d5266828256d">vanishing_points_valid_</a>=<span class="keyword">false</span>;
<a name="l00398"></a>00398   <a class="code" href="classsdet__grid__finder.html#adf5ce6ac42e5f286f57acd43be27ed94">projective_homography_valid_</a>=<span class="keyword">false</span>;
<a name="l00399"></a>00399   <a class="code" href="classsdet__grid__finder.html#a4e263ed701ac653df5ba092d1b0cc957">affine_homography_valid_</a> = <span class="keyword">false</span>;
<a name="l00400"></a>00400   <a class="code" href="classsdet__grid__finder.html#aaa6f3265f9273ea468a69cd33c9906ea">homography_valid_</a>=<span class="keyword">false</span>;
<a name="l00401"></a>00401   <a class="code" href="classsdet__grid__finder.html#a608f15023fda070d4d78b4be814d761e">lines_</a>=lines;
<a name="l00402"></a>00402   <a class="code" href="classsdet__grid__finder.html#ad325353cc9baf5e924f1b81f68ee3768">xmax_</a> = xsize;
<a name="l00403"></a>00403   <a class="code" href="classsdet__grid__finder.html#a50136d3369c6ee46d833749bd054988b">ymax_</a> = ysize;
<a name="l00404"></a>00404   <a class="code" href="classsdet__grid__finder.html#a2482080001360cf04ad30549ad078ffa">index_</a> = <span class="keyword">new</span> <a class="codeRef" doxygen="contrib_brl_bbas_bsol.tag:../../../../../contrib/brl/bbas/bsol/html" href="../../../../../contrib/brl/bbas/bsol/html/classbsol__hough__line__index.html">bsol_hough_line_index</a>(0,0,xsize, ysize);
<a name="l00405"></a>00405   <span class="keywordflow">for</span> (vcl_vector&lt;vsol_line_2d_sptr&gt;::const_iterator lit = lines.begin();
<a name="l00406"></a>00406        lit != lines.end(); lit++)
<a name="l00407"></a>00407     <a class="code" href="classsdet__grid__finder.html#a2482080001360cf04ad30549ad078ffa">index_</a>-&gt;index(*lit);
<a name="l00408"></a>00408   vcl_vector&lt;vcl_vector&lt;vsol_line_2d_sptr&gt; &gt; groups;
<a name="l00409"></a>00409   <span class="keywordflow">if</span> (<a class="code" href="classsdet__grid__finder.html#a2482080001360cf04ad30549ad078ffa">index_</a>-&gt;dominant_line_groups(<a class="code" href="classsdet__grid__finder__params.html#a22a735955b4cf212be71020208f29961" title="bin threshold for dominant orientation groups">thresh_</a>, <a class="code" href="classsdet__grid__finder__params.html#a34be0ab7f5161a773fbe2f6a01842e2d" title="angle tolerance for a dominant group">angle_tol_</a>, groups)&lt;2)
<a name="l00410"></a>00410     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00411"></a>00411   <a class="code" href="classsdet__grid__finder.html#ad8a429c543106c95c815b0437a6ae54a">group0_</a> = groups[0];
<a name="l00412"></a>00412   <a class="code" href="classsdet__grid__finder.html#a8d406335913151a3efb8cd6568900666">group1_</a> = groups[1];
<a name="l00413"></a>00413   <a class="code" href="classsdet__grid__finder.html#a93a647068795e241d0431fe2a4851a15" title="members.">groups_valid_</a> = <span class="keyword">true</span>;
<a name="l00414"></a>00414   <span class="keywordflow">if</span> (<a class="code" href="classsdet__grid__finder__params.html#ac564d24cb4fcfd8407a8cf391faff9df" title="general purpose debug state">debug_state_</a>==<a class="code" href="classsdet__grid__finder__params.html#ad4baa1d37da291f4ed5f70ab8b279d05a07b258816b54c7121ce4a5ec47bd6e9b">VANISHING_POINT</a>)
<a name="l00415"></a>00415   {
<a name="l00416"></a>00416     <span class="keywordflow">for</span> (vcl_vector&lt;vsol_line_2d_sptr&gt;::const_iterator lit = groups[0].begin();
<a name="l00417"></a>00417          lit != groups[0].end(); lit++)
<a name="l00418"></a>00418       <a class="code" href="classsdet__grid__finder.html#aa9d28ec6718fcfab52eaa2eef52a9fdf">debug_lines_</a>.push_back(*lit);
<a name="l00419"></a>00419     <span class="keywordflow">for</span> (vcl_vector&lt;vsol_line_2d_sptr&gt;::const_iterator lit = groups[1].begin();
<a name="l00420"></a>00420          lit != groups[1].end(); lit++)
<a name="l00421"></a>00421       <a class="code" href="classsdet__grid__finder.html#aa9d28ec6718fcfab52eaa2eef52a9fdf">debug_lines_</a>.push_back(*lit);
<a name="l00422"></a>00422   }
<a name="l00423"></a>00423   <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00424"></a>00424 }
<a name="l00425"></a>00425 
<a name="l00426"></a>00426 <span class="keywordtype">bool</span> <a class="code" href="classsdet__grid__finder.html#a3d81b7f1a6af3f042c8afdf607f2677c" title="the vanishing point of a line bundle.">sdet_grid_finder::</a>
<a name="l00427"></a><a class="code" href="classsdet__grid__finder.html#a3d81b7f1a6af3f042c8afdf607f2677c">00427</a> <a class="code" href="classsdet__grid__finder.html#a3d81b7f1a6af3f042c8afdf607f2677c" title="the vanishing point of a line bundle.">get_vanishing_point</a>(vcl_vector&lt;vsol_line_2d_sptr&gt; <span class="keyword">const</span> &amp; para_lines,
<a name="l00428"></a>00428                     <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__point__2d.html">vgl_homg_point_2d&lt;double&gt;</a>&amp; vp)
<a name="l00429"></a>00429 {
<a name="l00430"></a>00430   vcl_vector&lt;vgl_homg_line_2d&lt;double&gt; &gt; vlines, tvlines, stvlines;
<a name="l00431"></a>00431 
<a name="l00432"></a>00432   <span class="keywordtype">int</span> <a class="codeRef" doxygen="contrib_brl_bbas_bsol.tag:../../../../../contrib/brl/bbas/bsol/html" href="../../../../../contrib/brl/bbas/bsol/html/classnlines.html">nlines</a> =0;
<a name="l00433"></a>00433   <span class="keywordtype">double</span> tx = 0, ty =0;
<a name="l00434"></a>00434   <span class="comment">//</span>
<a name="l00435"></a>00435   <span class="comment">// convert the input lines to vgl_homg_line(s)</span>
<a name="l00436"></a>00436   <span class="comment">// and get the average distance of the intersection of the perpendicular</span>
<a name="l00437"></a>00437   <span class="comment">// line from the origin with each line.  This point set defines the</span>
<a name="l00438"></a>00438   <span class="comment">// translation offset for the lines.</span>
<a name="l00439"></a>00439   <span class="comment">//</span>
<a name="l00440"></a>00440   <span class="keywordflow">for</span> (vcl_vector&lt;vsol_line_2d_sptr&gt;::const_iterator lit = para_lines.begin();
<a name="l00441"></a>00441        lit != para_lines.end(); lit++)
<a name="l00442"></a>00442   {
<a name="l00443"></a>00443     <span class="keywordflow">if</span> ((*lit)-&gt;length() &lt; <a class="code" href="classsdet__grid__finder.html#a1186c07235a04a50647031807598d7b5" title="minimum length of line segments used to estimate the vanishing point.">length_threshold_</a>)
<a name="l00444"></a>00444     {
<a name="l00445"></a>00445       vcl_cout &lt;&lt; <span class="stringliteral">&quot;discarding line with length &lt; &quot;</span>&lt;&lt;<a class="code" href="classsdet__grid__finder.html#a1186c07235a04a50647031807598d7b5" title="minimum length of line segments used to estimate the vanishing point.">length_threshold_</a>&lt;&lt;<span class="charliteral">&#39;\n&#39;</span>;
<a name="l00446"></a>00446       <span class="keywordflow">continue</span>;
<a name="l00447"></a>00447     }
<a name="l00448"></a>00448     <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__line__2d.html">vgl_homg_line_2d&lt;double&gt;</a> l= (*lit)-&gt;vgl_hline_2d();
<a name="l00449"></a>00449     l.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__line__2d.html#a9cface519ff2e18c6ebc9c4293bd41fa">normalize</a>();
<a name="l00450"></a>00450     tx -= l.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__line__2d.html#a481ccab9a7babd3828c81e45cb46695c">a</a>()*l.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__line__2d.html#a9fb1d3fe8edd8f30c8d190f721b160a6">c</a>();
<a name="l00451"></a>00451     ty -= l.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__line__2d.html#ac239fb51fba33d2e1d61cf880384255b">b</a>()*l.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__line__2d.html#a9fb1d3fe8edd8f30c8d190f721b160a6">c</a>();
<a name="l00452"></a>00452     vlines.push_back(l);
<a name="l00453"></a>00453     nlines++;
<a name="l00454"></a>00454   }
<a name="l00455"></a>00455   <span class="keywordflow">if</span> (nlines&lt;2)
<a name="l00456"></a>00456     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00457"></a>00457   tx /=nlines;
<a name="l00458"></a>00458   ty /=nlines;
<a name="l00459"></a>00459   <span class="comment">// Offset the lines with the translation</span>
<a name="l00460"></a>00460   <span class="keywordflow">for</span> (vcl_vector&lt;<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__line__2d.html">vgl_homg_line_2d&lt;double&gt;</a> &gt;::iterator lit = vlines.begin();
<a name="l00461"></a>00461        lit != vlines.end(); lit++)
<a name="l00462"></a>00462   {
<a name="l00463"></a>00463     <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__line__2d.html">vgl_homg_line_2d&lt;double&gt;</a>&amp; l = (*lit);
<a name="l00464"></a>00464     <span class="keywordtype">double</span> c = l.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__line__2d.html#a9fb1d3fe8edd8f30c8d190f721b160a6">c</a>();
<a name="l00465"></a>00465     c -= l.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__line__2d.html#a481ccab9a7babd3828c81e45cb46695c">a</a>()*tx + l.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__line__2d.html#ac239fb51fba33d2e1d61cf880384255b">b</a>()*ty;
<a name="l00466"></a>00466     l.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__line__2d.html#ae82f9b6be84db17eb50872525b44b65a">set</a>(l.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__line__2d.html#a481ccab9a7babd3828c81e45cb46695c">a</a>(), l.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__line__2d.html#ac239fb51fba33d2e1d61cf880384255b">b</a>(), c);
<a name="l00467"></a>00467     tvlines.push_back(l);
<a name="l00468"></a>00468   }
<a name="l00469"></a>00469   <span class="comment">// Scale the lines so that the mean squared distance from the origin is one.</span>
<a name="l00470"></a>00470   <span class="keywordtype">double</span> c_sq = 0;
<a name="l00471"></a>00471   <span class="keywordflow">for</span> (vcl_vector&lt;<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__line__2d.html">vgl_homg_line_2d&lt;double&gt;</a> &gt;::iterator lit = tvlines.begin();
<a name="l00472"></a>00472        lit != tvlines.end(); lit++)
<a name="l00473"></a>00473   {
<a name="l00474"></a>00474     <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__line__2d.html">vgl_homg_line_2d&lt;double&gt;</a>&amp; l = (*lit);
<a name="l00475"></a>00475     c_sq += l.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__line__2d.html#a9fb1d3fe8edd8f30c8d190f721b160a6">c</a>()*l.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__line__2d.html#a9fb1d3fe8edd8f30c8d190f721b160a6">c</a>();
<a name="l00476"></a>00476   }
<a name="l00477"></a>00477   c_sq /=nlines;
<a name="l00478"></a>00478   <span class="keywordtype">double</span> sigma_c = vcl_sqrt(c_sq);
<a name="l00479"></a>00479   <span class="keywordflow">for</span> (vcl_vector&lt;<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__line__2d.html">vgl_homg_line_2d&lt;double&gt;</a> &gt;::iterator lit = tvlines.begin();
<a name="l00480"></a>00480        lit != tvlines.end(); lit++)
<a name="l00481"></a>00481   {
<a name="l00482"></a>00482     <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__line__2d.html">vgl_homg_line_2d&lt;double&gt;</a>&amp; l = (*lit);
<a name="l00483"></a>00483     <span class="keywordtype">double</span> c = l.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__line__2d.html#a9fb1d3fe8edd8f30c8d190f721b160a6">c</a>();
<a name="l00484"></a>00484     <span class="keywordflow">if</span> (sigma_c&gt;1e-8)
<a name="l00485"></a>00485       c /= sigma_c;
<a name="l00486"></a>00486     l.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__line__2d.html#ae82f9b6be84db17eb50872525b44b65a">set</a>(l.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__line__2d.html#a481ccab9a7babd3828c81e45cb46695c">a</a>(), l.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__line__2d.html#ac239fb51fba33d2e1d61cf880384255b">b</a>(), c);
<a name="l00487"></a>00487     stvlines.push_back(l);
<a name="l00488"></a>00488   }
<a name="l00489"></a>00489   <span class="comment">// Compute the intersection of the normalized lines to define the vanishing point</span>
<a name="l00490"></a>00490   vp = <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__operators__2d.html">vgl_homg_operators_2d&lt;double&gt;::lines_to_point</a>(stvlines);
<a name="l00491"></a>00491 
<a name="l00492"></a>00492   <span class="comment">// restore normalizing transform</span>
<a name="l00493"></a>00493   <span class="comment">// scale factor;</span>
<a name="l00494"></a>00494   <span class="keywordtype">double</span> lambda = vp.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__point__2d.html#ab452fbf6dec9591ff07c0ebb7b05f1e1">w</a>()/sigma_c;
<a name="l00495"></a>00495   vp.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__point__2d.html#ad09a7a39599211ec304cfcaa3e98ff17">set</a>((vp.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__point__2d.html#a1d928ee2aae43e7cc7bec7e2db2ad989">x</a>()+lambda*tx), (vp.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__point__2d.html#a098f0121fa0b75d2f4171d00a1bf7f31">y</a>()+lambda*ty), lambda);
<a name="l00496"></a>00496 
<a name="l00497"></a>00497   vcl_cout &lt;&lt; <span class="stringliteral">&quot;returning from get_vanishing_point()\n&quot;</span>;
<a name="l00498"></a>00498 
<a name="l00499"></a>00499   <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00500"></a>00500 }
<a name="l00501"></a>00501 
<a name="l00502"></a><a class="code" href="classsdet__grid__finder.html#a0f16eb4b29bd888b5900022ab0a78ccf">00502</a> <span class="keywordtype">bool</span> <a class="code" href="classsdet__grid__finder.html#a0f16eb4b29bd888b5900022ab0a78ccf" title="vanishing points of the grid lines.">sdet_grid_finder::compute_vanishing_points</a>()
<a name="l00503"></a>00503 {
<a name="l00504"></a>00504   <span class="keywordflow">if</span> (!<a class="code" href="classsdet__grid__finder.html#a93a647068795e241d0431fe2a4851a15" title="members.">groups_valid_</a>)
<a name="l00505"></a>00505     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00506"></a>00506   <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__point__2d.html">vgl_homg_point_2d&lt;double&gt;</a> vp0, vp1;
<a name="l00507"></a>00507   <span class="keywordflow">if</span> (!<a class="code" href="classsdet__grid__finder.html#a3d81b7f1a6af3f042c8afdf607f2677c" title="the vanishing point of a line bundle.">get_vanishing_point</a>(<a class="code" href="classsdet__grid__finder.html#ad8a429c543106c95c815b0437a6ae54a">group0_</a>, vp0))
<a name="l00508"></a>00508     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00509"></a>00509   <span class="keywordflow">if</span> (!<a class="code" href="classsdet__grid__finder.html#a3d81b7f1a6af3f042c8afdf607f2677c" title="the vanishing point of a line bundle.">get_vanishing_point</a>(<a class="code" href="classsdet__grid__finder.html#a8d406335913151a3efb8cd6568900666">group1_</a>, vp1))
<a name="l00510"></a>00510     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00511"></a>00511   <span class="comment">// if the x component of the first vanishing point is more horizontal then</span>
<a name="l00512"></a>00512   <span class="comment">// make it the horizontal vanishing point</span>
<a name="l00513"></a>00513   <span class="keywordflow">if</span> (vcl_fabs(vp0.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__point__2d.html#a1d928ee2aae43e7cc7bec7e2db2ad989">x</a>())&gt;vcl_fabs(vp0.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__point__2d.html#a098f0121fa0b75d2f4171d00a1bf7f31">y</a>()))
<a name="l00514"></a>00514   {
<a name="l00515"></a>00515     <a class="code" href="classsdet__grid__finder.html#a57e308c80a0805d6c64e14f6ab2fada5">vp0_</a>= vp0;
<a name="l00516"></a>00516     <a class="code" href="classsdet__grid__finder.html#a0dcf45518db4c5106e480e8d6bfabc88">vp90_</a>= vp1;
<a name="l00517"></a>00517   }
<a name="l00518"></a>00518   <span class="keywordflow">else</span>
<a name="l00519"></a>00519   {
<a name="l00520"></a>00520     <a class="code" href="classsdet__grid__finder.html#a57e308c80a0805d6c64e14f6ab2fada5">vp0_</a> = vp1;
<a name="l00521"></a>00521     <a class="code" href="classsdet__grid__finder.html#a0dcf45518db4c5106e480e8d6bfabc88">vp90_</a>=vp0;
<a name="l00522"></a>00522   }
<a name="l00523"></a>00523   <a class="code" href="classsdet__grid__finder.html#adc791552e6af41cd5255d5266828256d">vanishing_points_valid_</a> = <span class="keyword">true</span>;
<a name="l00524"></a>00524   vcl_cout &lt;&lt; <span class="stringliteral">&quot;returning from compute_vanishing_points()\n&quot;</span>;
<a name="l00525"></a>00525   <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00526"></a>00526 }
<a name="l00527"></a>00527 
<a name="l00528"></a>00528 <span class="comment">//--------------------------------------------------------------------------</span>
<a name="l00529"></a>00529 <span class="comment">//: find the grid in the set of line segments</span>
<a name="l00530"></a><a class="code" href="classsdet__grid__finder.html#a4702ae84cf24bbb06951675a37906d32">00530</a> <span class="keywordtype">bool</span> <a class="code" href="classsdet__grid__finder.html#a4702ae84cf24bbb06951675a37906d32" title="find the grid in the set of line segments.">sdet_grid_finder::match_grid</a>()
<a name="l00531"></a>00531 {
<a name="l00532"></a>00532   <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00533"></a>00533 }
<a name="l00534"></a>00534 
<a name="l00535"></a>00535 <span class="comment">//-------------------------------------------------------------------------</span>
<a name="l00536"></a>00536 <span class="comment">//: Compute a projective homography that sends the two major group vanishing points to the x and y directions</span>
<a name="l00537"></a><a class="code" href="classsdet__grid__finder.html#a52a72012dbda86415be3a9a4aee6fe3a">00537</a> <span class="keywordtype">bool</span> <a class="code" href="classsdet__grid__finder.html#a52a72012dbda86415be3a9a4aee6fe3a" title="Compute a projective homography that sends the two major group vanishing points to the x and y direct...">sdet_grid_finder::compute_projective_homography</a>()
<a name="l00538"></a>00538 {
<a name="l00539"></a>00539   <span class="keywordflow">if</span> (<a class="code" href="classsdet__grid__finder.html#adf5ce6ac42e5f286f57acd43be27ed94">projective_homography_valid_</a>)
<a name="l00540"></a>00540     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00541"></a>00541 
<a name="l00542"></a>00542   <span class="keywordflow">if</span> (!this-&gt;<a class="code" href="classsdet__grid__finder.html#a0f16eb4b29bd888b5900022ab0a78ccf" title="vanishing points of the grid lines.">compute_vanishing_points</a>())
<a name="l00543"></a>00543   {
<a name="l00544"></a>00544     vcl_cout&lt;&lt; <span class="stringliteral">&quot;In sdet_grid_finder::compute_projective_homography() -&quot;</span>
<a name="l00545"></a>00545             &lt;&lt; <span class="stringliteral">&quot; vanishing point computation failed\n&quot;</span>;
<a name="l00546"></a>00546     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00547"></a>00547   }
<a name="l00548"></a>00548   <a class="code" href="classsdet__grid__finder.html#a4e263ed701ac653df5ba092d1b0cc957">affine_homography_valid_</a> = <span class="keyword">false</span>;
<a name="l00549"></a>00549   <a class="code" href="classsdet__grid__finder.html#aaa6f3265f9273ea468a69cd33c9906ea">homography_valid_</a> = <span class="keyword">false</span>;
<a name="l00550"></a>00550   <span class="keywordflow">if</span> (<a class="code" href="classsdet__grid__finder__params.html#add98f5848c934edf71a214b9500c590a" title="print informative debug output">verbose_</a>)
<a name="l00551"></a>00551   {
<a name="l00552"></a>00552     vcl_cout &lt;&lt; <span class="stringliteral">&quot;VP0 &quot;</span> &lt;&lt; <a class="code" href="classsdet__grid__finder.html#a57e308c80a0805d6c64e14f6ab2fada5">vp0_</a> &lt;&lt; <span class="charliteral">&#39;\n&#39;</span>
<a name="l00553"></a>00553              &lt;&lt; <span class="stringliteral">&quot;VP90 &quot;</span> &lt;&lt; <a class="code" href="classsdet__grid__finder.html#a0dcf45518db4c5106e480e8d6bfabc88">vp90_</a> &lt;&lt; <span class="charliteral">&#39;\n&#39;</span>;
<a name="l00554"></a>00554   }
<a name="l00555"></a>00555 
<a name="l00556"></a>00556   <span class="comment">// Keep the sense of the axes pointing to infinity</span>
<a name="l00557"></a>00557   <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__point__2d.html">vgl_homg_point_2d&lt;double&gt;</a> x_inf(1,0,0), x_minus_inf(-1,0,0);
<a name="l00558"></a>00558   <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__point__2d.html">vgl_homg_point_2d&lt;double&gt;</a> y_inf(0,1,0), y_minus_inf(0,-1,0);
<a name="l00559"></a>00559   <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__point__2d.html">vgl_homg_point_2d&lt;double&gt;</a> origin(0,0,1);
<a name="l00560"></a>00560   <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__point__2d.html">vgl_homg_point_2d&lt;double&gt;</a> x_finite(<a class="code" href="classsdet__grid__finder.html#ad325353cc9baf5e924f1b81f68ee3768">xmax_</a>,0,1), y_finite(0,<a class="code" href="classsdet__grid__finder.html#a50136d3369c6ee46d833749bd054988b">ymax_</a>,1);
<a name="l00561"></a>00561   <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__point__2d.html">vgl_homg_point_2d&lt;double&gt;</a> max_corner(<a class="code" href="classsdet__grid__finder.html#ad325353cc9baf5e924f1b81f68ee3768">xmax_</a>,<a class="code" href="classsdet__grid__finder.html#a50136d3369c6ee46d833749bd054988b">ymax_</a>,1);
<a name="l00562"></a>00562 
<a name="l00563"></a>00563   <span class="comment">// compute a point homography that maps the</span>
<a name="l00564"></a>00564   <span class="comment">// vanishing points to infinity and leaves the corners of the image invariant</span>
<a name="l00565"></a>00565   vcl_vector&lt;vgl_homg_point_2d&lt;double&gt; &gt; image;
<a name="l00566"></a>00566   vcl_vector&lt;vgl_homg_point_2d&lt;double&gt; &gt; grid;
<a name="l00567"></a>00567   <span class="comment">// First, if the vanishing points are already quite close to infinity</span>
<a name="l00568"></a>00568   <span class="comment">// then just form an identity transform, otherwise map to the vanishing pts</span>
<a name="l00569"></a>00569   <span class="keywordtype">double</span> at_infinity = 1.0e-8;
<a name="l00570"></a>00570   <span class="keywordflow">if</span> (vcl_fabs(<a class="code" href="classsdet__grid__finder.html#a57e308c80a0805d6c64e14f6ab2fada5">vp0_</a>.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__point__2d.html#ab452fbf6dec9591ff07c0ebb7b05f1e1">w</a>())&lt;at_infinity)
<a name="l00571"></a>00571   {
<a name="l00572"></a>00572     image.push_back(x_finite);
<a name="l00573"></a>00573     grid.push_back(x_finite);
<a name="l00574"></a>00574   }
<a name="l00575"></a>00575   <span class="keywordflow">else</span>
<a name="l00576"></a>00576   {
<a name="l00577"></a>00577     image.push_back(<a class="code" href="classsdet__grid__finder.html#a57e308c80a0805d6c64e14f6ab2fada5">vp0_</a>);
<a name="l00578"></a>00578     <span class="keywordflow">if</span> (<a class="code" href="classsdet__grid__finder.html#a57e308c80a0805d6c64e14f6ab2fada5">vp0_</a>.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__point__2d.html#a1d928ee2aae43e7cc7bec7e2db2ad989">x</a>()/<a class="code" href="classsdet__grid__finder.html#a57e308c80a0805d6c64e14f6ab2fada5">vp0_</a>.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__point__2d.html#ab452fbf6dec9591ff07c0ebb7b05f1e1">w</a>()&gt;0)
<a name="l00579"></a>00579       grid.push_back(x_inf);
<a name="l00580"></a>00580     <span class="keywordflow">else</span>
<a name="l00581"></a>00581       grid.push_back(x_minus_inf);
<a name="l00582"></a>00582   }
<a name="l00583"></a>00583 
<a name="l00584"></a>00584   <span class="keywordflow">if</span> (vcl_fabs(<a class="code" href="classsdet__grid__finder.html#a0dcf45518db4c5106e480e8d6bfabc88">vp90_</a>.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__point__2d.html#ab452fbf6dec9591ff07c0ebb7b05f1e1">w</a>())&lt;at_infinity)
<a name="l00585"></a>00585   {
<a name="l00586"></a>00586     image.push_back(y_finite);
<a name="l00587"></a>00587     grid.push_back(y_finite);
<a name="l00588"></a>00588   }
<a name="l00589"></a>00589   <span class="keywordflow">else</span>
<a name="l00590"></a>00590   {
<a name="l00591"></a>00591     image.push_back(<a class="code" href="classsdet__grid__finder.html#a0dcf45518db4c5106e480e8d6bfabc88">vp90_</a>);
<a name="l00592"></a>00592     <span class="keywordflow">if</span> (<a class="code" href="classsdet__grid__finder.html#a0dcf45518db4c5106e480e8d6bfabc88">vp90_</a>.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__point__2d.html#a098f0121fa0b75d2f4171d00a1bf7f31">y</a>()/<a class="code" href="classsdet__grid__finder.html#a0dcf45518db4c5106e480e8d6bfabc88">vp90_</a>.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__point__2d.html#ab452fbf6dec9591ff07c0ebb7b05f1e1">w</a>()&gt;0)
<a name="l00593"></a>00593       grid.push_back(y_inf);
<a name="l00594"></a>00594     <span class="keywordflow">else</span>
<a name="l00595"></a>00595       grid.push_back(y_minus_inf);
<a name="l00596"></a>00596   }
<a name="l00597"></a>00597 
<a name="l00598"></a>00598   image.push_back(origin); image.push_back(max_corner);
<a name="l00599"></a>00599   grid.push_back(origin); grid.push_back(max_corner);
<a name="l00600"></a>00600   <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__h__matrix__2d__compute__4point.html">vgl_h_matrix_2d_compute_4point</a> comp_4pt;
<a name="l00601"></a>00601   <span class="keywordflow">if</span> (!comp_4pt.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__h__matrix__2d__compute.html#a31168dffd34306e67edba7618a9139ed">compute</a>(image, grid, <a class="code" href="classsdet__grid__finder.html#a5e7bf51b6a873f81167e28cd5c9626d6">projective_homography_</a>))
<a name="l00602"></a>00602     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00603"></a>00603   <span class="keywordflow">if</span> (<a class="code" href="classsdet__grid__finder__params.html#add98f5848c934edf71a214b9500c590a" title="print informative debug output">verbose_</a>)
<a name="l00604"></a>00604     vcl_cout &lt;&lt; <span class="stringliteral">&quot;The projective homography\n&quot;</span> &lt;&lt; <a class="code" href="classsdet__grid__finder.html#a5e7bf51b6a873f81167e28cd5c9626d6">projective_homography_</a> &lt;&lt; <span class="charliteral">&#39;\n&#39;</span>;
<a name="l00605"></a>00605   <a class="code" href="classsdet__grid__finder.html#adf5ce6ac42e5f286f57acd43be27ed94">projective_homography_valid_</a> = <span class="keyword">true</span>;
<a name="l00606"></a>00606   <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00607"></a>00607 }
<a name="l00608"></a>00608 
<a name="l00609"></a>00609 <span class="comment">//---------------------------------------------------------------</span>
<a name="l00610"></a>00610 <span class="comment">//:</span>
<a name="l00611"></a>00611 <span class="comment">//  Remove any remaining skew by finding an affine transformation</span>
<a name="l00612"></a>00612 <span class="comment">//  the maps horizontally inclined lines (angle ah) to zero degrees</span>
<a name="l00613"></a>00613 <span class="comment">//  and vertically inclined lines (angle av) to 90 degrees.</span>
<a name="l00614"></a>00614 <span class="comment">//  That is, find a transformation of the line normals</span>
<a name="l00615"></a>00615 <span class="comment">// \verbatim</span>
<a name="l00616"></a>00616 <span class="comment">//  |q00  q01 ||-sin(av) -sin(ah)|    |-1 0|</span>
<a name="l00617"></a>00617 <span class="comment">//  |q10  q11 || cos(av)  cos(ah)|  = | 0 1|</span>
<a name="l00618"></a>00618 <span class="comment">// \endverbatim</span>
<a name="l00619"></a>00619 <span class="comment">//  The point transformation,Q, is then the inverse transpose of q</span>
<a name="l00620"></a>00620 <span class="comment">// \verbatim</span>
<a name="l00621"></a>00621 <span class="comment">//      | sin(av) -cos(av)|</span>
<a name="l00622"></a>00622 <span class="comment">//  Q = |-sin(ah)  cos(ah)|  = [q]^-t</span>
<a name="l00623"></a>00623 <span class="comment">// \endverbatim</span>
<a name="l00624"></a>00624 <span class="keyword">static</span> vnl_matrix_fixed&lt;double, 3,3&gt; skew_transform(<span class="keyword">const</span> <span class="keywordtype">double</span> ah,
<a name="l00625"></a>00625                                                     <span class="keyword">const</span> <span class="keywordtype">double</span> av)
<a name="l00626"></a>00626 {
<a name="l00627"></a>00627   vnl_matrix_fixed&lt;double, 3, 3&gt; Q;
<a name="l00628"></a>00628   Q.put(0, 0, vcl_sin(av)); Q.put(0,1, -vcl_cos(av)); Q.put(0,2,0);
<a name="l00629"></a>00629   Q.put(1, 0, -vcl_sin(ah)); Q.put(1,1, vcl_cos(ah)); Q.put(1,2,0);
<a name="l00630"></a>00630   Q.put(2, 0, 0); Q.put(2,1, 0); Q.put(2,2,1);
<a name="l00631"></a>00631   <span class="keywordflow">return</span> Q;
<a name="l00632"></a>00632 }
<a name="l00633"></a>00633 
<a name="l00634"></a>00634 <span class="comment">//------------------------------------------------------------------------</span>
<a name="l00635"></a>00635 <span class="comment">//:Form a histogram of all pairwise distances of lines from the origin.</span>
<a name="l00636"></a>00636 <span class="comment">// h_i is the count, d_i is the average distance in a bin</span>
<a name="l00637"></a>00637 <span class="comment">// The first peak is the distance between grid lines in the horizontal (gh)</span>
<a name="l00638"></a>00638 <span class="comment">// and vertical (gv) directions. The transformation makes each of these</span>
<a name="l00639"></a>00639 <span class="comment">// distances equal to spacing. The result is returned in S.</span>
<a name="l00640"></a>00640 
<a name="l00641"></a><a class="code" href="classsdet__grid__finder.html#a72eeb18493d23211cfb73c8a8972ac74">00641</a> <span class="keywordtype">bool</span> <a class="code" href="classsdet__grid__finder.html#a72eeb18493d23211cfb73c8a8972ac74" title="Form a histogram of all pairwise distances of lines from the origin.">sdet_grid_finder::scale_transform</a>(<span class="keyword">const</span> <span class="keywordtype">double</span> <span class="comment">/* max_distance */</span>,
<a name="l00642"></a>00642                                        vcl_vector&lt;vsol_line_2d_sptr&gt; <span class="keyword">const</span>&amp; gh,
<a name="l00643"></a>00643                                        vcl_vector&lt;vsol_line_2d_sptr&gt; <span class="keyword">const</span>&amp; gv,
<a name="l00644"></a>00644                                        vnl_matrix_fixed&lt;double, 3, 3&gt;&amp; S)
<a name="l00645"></a>00645 {
<a name="l00646"></a>00646   <span class="keywordtype">int</span> nbins = 100;
<a name="l00647"></a>00647   <a class="codeRef" doxygen="contrib_brl_bbas_bsol.tag:../../../../../contrib/brl/bbas/bsol/html" href="../../../../../contrib/brl/bbas/bsol/html/classbsol__distance__histogram.html">bsol_distance_histogram</a> Hh(nbins, gh), Hv(nbins, gv);
<a name="l00648"></a>00648   <span class="keywordtype">double</span> hp1=0, hp2=0, vp1=0, vp2=0;
<a name="l00649"></a>00649 
<a name="l00650"></a>00650 <span class="preprocessor">#undef DEC_DEBUG</span>
<a name="l00651"></a>00651 <span class="preprocessor"></span><span class="preprocessor">#ifdef DEC_DEBUG</span>
<a name="l00652"></a>00652 <span class="preprocessor"></span>  vcl_cout &lt;&lt; <span class="stringliteral">&quot;\nHorizontal Distances\n&quot;</span>
<a name="l00653"></a>00653            &lt;&lt; <span class="stringliteral">&quot;*********************************\n&quot;</span>;
<a name="l00654"></a>00654   <span class="keywordflow">for</span> (vcl_vector&lt;vsol_line_2d_sptr&gt;::const_iterator lit = gh.begin();
<a name="l00655"></a>00655        lit != gh.end(); lit++)
<a name="l00656"></a>00656   {
<a name="l00657"></a>00657     <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__line__2d.html">vgl_homg_line_2d&lt;double&gt;</a> hline = (*lit)-&gt;vgl_hline_2d();
<a name="l00658"></a>00658     hline.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__line__2d.html#a9cface519ff2e18c6ebc9c4293bd41fa">normalize</a>();
<a name="l00659"></a>00659     vcl_cout &lt;&lt; hline.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__line__2d.html#a9fb1d3fe8edd8f30c8d190f721b160a6">c</a>() &lt;&lt; <span class="charliteral">&#39;\n&#39;</span>;
<a name="l00660"></a>00660   }
<a name="l00661"></a>00661   vcl_cout &lt;&lt; <span class="stringliteral">&quot;********************************\n\n&quot;</span>
<a name="l00662"></a>00662            &lt;&lt; <span class="stringliteral">&quot;Vertical Distances\n&quot;</span>
<a name="l00663"></a>00663            &lt;&lt; <span class="stringliteral">&quot;*********************************\n&quot;</span>;
<a name="l00664"></a>00664   <span class="keywordflow">for</span> (vcl_vector&lt;vsol_line_2d_sptr&gt;::const_iterator lit = gv.begin();
<a name="l00665"></a>00665        lit != gv.end(); lit++)
<a name="l00666"></a>00666   {
<a name="l00667"></a>00667     <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__line__2d.html">vgl_homg_line_2d&lt;double&gt;</a> hline = (*lit)-&gt;vgl_hline_2d();
<a name="l00668"></a>00668     hline.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__line__2d.html#a9cface519ff2e18c6ebc9c4293bd41fa">normalize</a>();
<a name="l00669"></a>00669     vcl_cout &lt;&lt; hline.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__line__2d.html#a9fb1d3fe8edd8f30c8d190f721b160a6">c</a>() &lt;&lt; <span class="charliteral">&#39;\n&#39;</span>;
<a name="l00670"></a>00670   }
<a name="l00671"></a>00671   vcl_cout &lt;&lt; <span class="stringliteral">&quot;********************************\n\n&quot;</span>;
<a name="l00672"></a>00672 <span class="preprocessor">#endif</span>
<a name="l00673"></a>00673 <span class="preprocessor"></span>  <span class="keywordflow">if</span> (<a class="code" href="classsdet__grid__finder__params.html#add98f5848c934edf71a214b9500c590a" title="print informative debug output">verbose_</a>)
<a name="l00674"></a>00674   {
<a name="l00675"></a>00675     vcl_cout &lt;&lt; <span class="stringliteral">&quot;Horizontal Histogram\n&quot;</span> &lt;&lt; Hh &lt;&lt; <span class="stringliteral">&quot;\n\n&quot;</span>
<a name="l00676"></a>00676              &lt;&lt; <span class="stringliteral">&quot;Vertical Histogram\n&quot;</span> &lt;&lt; Hv &lt;&lt; <span class="stringliteral">&quot;\n\n&quot;</span>;
<a name="l00677"></a>00677   }
<a name="l00678"></a>00678   <span class="keywordflow">if</span> (!Hh.distance_peaks(hp1, hp2))
<a name="l00679"></a>00679   {
<a name="l00680"></a>00680     vcl_cout &lt;&lt; <span class="stringliteral">&quot;In sdet_grid_finder::scale_transform(.) - failed&quot;</span>
<a name="l00681"></a>00681              &lt;&lt; <span class="stringliteral">&quot; to find horizontal distance peaks\n&quot;</span>;
<a name="l00682"></a>00682     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00683"></a>00683   }
<a name="l00684"></a>00684   <span class="keywordflow">if</span> (!Hv.<a class="codeRef" doxygen="contrib_brl_bbas_bsol.tag:../../../../../contrib/brl/bbas/bsol/html" href="../../../../../contrib/brl/bbas/bsol/html/classbsol__distance__histogram.html#a0c92615d37ceba906d5c468c5f9b5acf">distance_peaks</a>(vp1, vp2))
<a name="l00685"></a>00685   {
<a name="l00686"></a>00686     vcl_cout &lt;&lt; <span class="stringliteral">&quot;In sdet_grid_finder::scale_transform(.) - failed&quot;</span>
<a name="l00687"></a>00687              &lt;&lt; <span class="stringliteral">&quot; to find vertical distance peaks\n&quot;</span>;
<a name="l00688"></a>00688     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00689"></a>00689   }
<a name="l00690"></a>00690   <span class="keywordtype">double</span> ph = (hp2-hp1), pv = (vp2-vp1);
<a name="l00691"></a>00691   <span class="keywordflow">if</span> (<a class="code" href="classsdet__grid__finder__params.html#add98f5848c934edf71a214b9500c590a" title="print informative debug output">verbose_</a>)
<a name="l00692"></a>00692   {
<a name="l00693"></a>00693     vcl_cout &lt;&lt; <span class="stringliteral">&quot;Horizontal Peaks &quot;</span> &lt;&lt; hp1 &lt;&lt; <span class="charliteral">&#39; &#39;</span> &lt;&lt; hp2 &lt;&lt; <span class="charliteral">&#39;\n&#39;</span>
<a name="l00694"></a>00694              &lt;&lt; <span class="stringliteral">&quot;Vertical Peaks &quot;</span> &lt;&lt; vp1 &lt;&lt; <span class="charliteral">&#39; &#39;</span> &lt;&lt; vp2 &lt;&lt; <span class="charliteral">&#39;\n&#39;</span>
<a name="l00695"></a>00695              &lt;&lt; <span class="stringliteral">&quot;Horizontal Dist &quot;</span> &lt;&lt; ph &lt;&lt; <span class="charliteral">&#39;\n&#39;</span>
<a name="l00696"></a>00696              &lt;&lt; <span class="stringliteral">&quot;Vertical Dist &quot;</span> &lt;&lt; pv &lt;&lt; <span class="charliteral">&#39;\n&#39;</span>;
<a name="l00697"></a>00697   }
<a name="l00698"></a>00698   <span class="comment">// failed to find peaks</span>
<a name="l00699"></a>00699   <span class="keywordflow">if</span> (ph&lt;0||pv&lt;0)
<a name="l00700"></a>00700     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00701"></a>00701 
<a name="l00702"></a>00702   <span class="comment">// adjust the spacing to be equal.</span>
<a name="l00703"></a>00703   S.put(0, 0, <a class="code" href="classsdet__grid__finder__params.html#a68f253a0739973bf648cb8fada037c7f" title="spacing between lines">spacing_</a>/pv); S.put(0,1, 0); S.put(0,2,0);
<a name="l00704"></a>00704   S.put(1, 0, 0); S.put(1,1, <a class="code" href="classsdet__grid__finder__params.html#a68f253a0739973bf648cb8fada037c7f" title="spacing between lines">spacing_</a>/ph); S.put(1,2,0);
<a name="l00705"></a>00705   S.put(2, 0, 0); S.put(2,1, 0); S.put(2,2,1);
<a name="l00706"></a>00706   <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00707"></a>00707 }
<a name="l00708"></a>00708 
<a name="l00709"></a><a class="code" href="classsdet__grid__finder.html#a8d34869604adf73e0cfd85029b282944">00709</a> <span class="keywordtype">bool</span> <a class="code" href="classsdet__grid__finder.html#a8d34869604adf73e0cfd85029b282944">sdet_grid_finder::compute_affine_homography</a>()
<a name="l00710"></a>00710 {
<a name="l00711"></a>00711   <span class="keywordflow">if</span> (!<a class="code" href="classsdet__grid__finder.html#adf5ce6ac42e5f286f57acd43be27ed94">projective_homography_valid_</a>)
<a name="l00712"></a>00712     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00713"></a>00713   <span class="keywordflow">if</span> (<a class="code" href="classsdet__grid__finder.html#a4e263ed701ac653df5ba092d1b0cc957">affine_homography_valid_</a>)
<a name="l00714"></a>00714     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00715"></a>00715   <span class="keywordtype">float</span> affine_angle_factor = 3.0; <span class="comment">// more tolerance for line groups for affine processing</span>
<a name="l00716"></a>00716 
<a name="l00717"></a>00717   <span class="comment">// transform all the lines using the projective homography defined</span>
<a name="l00718"></a>00718   <span class="comment">// by vanishing points</span>
<a name="l00719"></a>00719   vcl_vector&lt;vsol_line_2d_sptr&gt; affine_lines;
<a name="l00720"></a>00720   <span class="keywordflow">for</span> (vcl_vector&lt;vsol_line_2d_sptr&gt;::const_iterator lit = <a class="code" href="classsdet__grid__finder.html#a608f15023fda070d4d78b4be814d761e">lines_</a>.begin();
<a name="l00721"></a>00721        lit != <a class="code" href="classsdet__grid__finder.html#a608f15023fda070d4d78b4be814d761e">lines_</a>.end(); lit++)
<a name="l00722"></a>00722   {
<a name="l00723"></a>00723     <a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__smart__ptr.html">vsol_line_2d_sptr</a> pline = this-&gt;<a class="code" href="classsdet__grid__finder.html#a1e9152e3f3fb0e0d60823dde70616408" title="transform a vsol line by transforming the end points.">transform_line</a>(<a class="code" href="classsdet__grid__finder.html#a5e7bf51b6a873f81167e28cd5c9626d6">projective_homography_</a>,*lit);
<a name="l00724"></a>00724     <span class="keywordflow">if</span> (<a class="code" href="classsdet__grid__finder__params.html#add98f5848c934edf71a214b9500c590a" title="print informative debug output">verbose_</a>)
<a name="l00725"></a>00725     {
<a name="l00726"></a>00726       vcl_cout &lt;&lt; <span class="stringliteral">&quot;*lit = [&quot;</span>&lt;&lt;(*lit)-&gt;p0()-&gt;x()&lt;&lt;<span class="charliteral">&#39;,&#39;</span>&lt;&lt;(*lit)-&gt;p0()-&gt;y()&lt;&lt;<span class="stringliteral">&quot;] [&quot;</span>
<a name="l00727"></a>00727                &lt;&lt; (*lit)-&gt;p1()-&gt;x()&lt;&lt;<span class="charliteral">&#39;,&#39;</span>&lt;&lt;(*lit)-&gt;p1()-&gt;y()&lt;&lt;<span class="stringliteral">&quot;]\n&quot;</span>
<a name="l00728"></a>00728                &lt;&lt; <span class="stringliteral">&quot;pline = [&quot;</span>&lt;&lt;pline-&gt;p0()-&gt;x()&lt;&lt;<span class="charliteral">&#39;,&#39;</span>&lt;&lt;pline-&gt;p0()-&gt;y()&lt;&lt;<span class="stringliteral">&quot;] [&quot;</span>
<a name="l00729"></a>00729                &lt;&lt; pline-&gt;p1()-&gt;x()&lt;&lt;<span class="charliteral">&#39;,&#39;</span>&lt;&lt;pline-&gt;p1()-&gt;y()&lt;&lt;<span class="stringliteral">&quot;]\n&quot;</span>;
<a name="l00730"></a>00730     }
<a name="l00731"></a>00731     <span class="comment">// weed out lines with _huge_ coordinates</span>
<a name="l00732"></a>00732     <span class="keywordflow">if</span> ( (vcl_abs(pline-&gt;p0()-&gt;x()) &gt; 10000) ||
<a name="l00733"></a>00733          (vcl_abs(pline-&gt;p0()-&gt;y()) &gt; 10000) ||
<a name="l00734"></a>00734          (vcl_abs(pline-&gt;p1()-&gt;x()) &gt; 10000) ||
<a name="l00735"></a>00735          (vcl_abs(pline-&gt;p1()-&gt;y()) &gt; 10000) )
<a name="l00736"></a>00736       <span class="keywordflow">continue</span>;
<a name="l00737"></a>00737     affine_lines.push_back(pline);
<a name="l00738"></a>00738   }
<a name="l00739"></a>00739 
<a name="l00740"></a>00740   <span class="comment">// Get the bounds of the affine lines (lines with vpoints at infinity)</span>
<a name="l00741"></a>00741   <a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__bounding__box.html">vbl_bounding_box&lt;double, 2&gt;</a> b = <a class="codeRef" doxygen="contrib_brl_bbas_bsol.tag:../../../../../contrib/brl/bbas/bsol/html" href="../../../../../contrib/brl/bbas/bsol/html/classbsol__algs.html#a0ecf904e9c6c62f6a99e771de5839bf9">bsol_algs::bounding_box</a>(affine_lines);
<a name="l00742"></a>00742   <a class="code" href="classsdet__grid__finder.html#a2482080001360cf04ad30549ad078ffa">index_</a> = <span class="keyword">new</span> <a class="codeRef" doxygen="contrib_brl_bbas_bsol.tag:../../../../../contrib/brl/bbas/bsol/html" href="../../../../../contrib/brl/bbas/bsol/html/classbsol__hough__line__index.html">bsol_hough_line_index</a>(b);
<a name="l00743"></a>00743 
<a name="l00744"></a>00744   <span class="keywordflow">for</span> (vcl_vector&lt;vsol_line_2d_sptr&gt;::iterator lit = affine_lines.begin();
<a name="l00745"></a>00745        lit != affine_lines.end(); lit++)
<a name="l00746"></a>00746     <a class="code" href="classsdet__grid__finder.html#a2482080001360cf04ad30549ad078ffa">index_</a>-&gt;index(*lit);
<a name="l00747"></a>00747 
<a name="l00748"></a>00748   vcl_vector&lt;vcl_vector&lt;vsol_line_2d_sptr&gt; &gt; groups;
<a name="l00749"></a>00749   <span class="keywordflow">if</span> (<a class="code" href="classsdet__grid__finder.html#a2482080001360cf04ad30549ad078ffa">index_</a>-&gt;dominant_line_groups(<a class="code" href="classsdet__grid__finder__params.html#a22a735955b4cf212be71020208f29961" title="bin threshold for dominant orientation groups">thresh_</a>,
<a name="l00750"></a>00750                                    affine_angle_factor*<a class="code" href="classsdet__grid__finder__params.html#a34be0ab7f5161a773fbe2f6a01842e2d" title="angle tolerance for a dominant group">angle_tol_</a>,
<a name="l00751"></a>00751                                    groups)&lt;2)
<a name="l00752"></a>00752     <span class="keywordflow">return</span> <span class="keyword">false</span>; <span class="comment">// failed to find enough groups.</span>
<a name="l00753"></a>00753 
<a name="l00754"></a>00754   <a class="code" href="classsdet__grid__finder.html#a5479c1f6a506fdf43bc6fbe696fd662f">afgroup0_</a> = groups[0];
<a name="l00755"></a>00755   <a class="code" href="classsdet__grid__finder.html#af4800373678d26472254c8e3d1c6914d">afgroup1_</a> = groups[1];
<a name="l00756"></a>00756   <span class="keywordflow">if</span> (<a class="code" href="classsdet__grid__finder__params.html#ac564d24cb4fcfd8407a8cf391faff9df" title="general purpose debug state">debug_state_</a>==<a class="code" href="classsdet__grid__finder__params.html#ad4baa1d37da291f4ed5f70ab8b279d05a080f557f2ad995b5d3c6336006ba7ad3">AFFINE_GROUP_BEFORE_SKEW_SCALE</a>)
<a name="l00757"></a>00757   {
<a name="l00758"></a>00758     <span class="keywordflow">for</span> (vcl_vector&lt;vsol_line_2d_sptr&gt;::const_iterator lit = <a class="code" href="classsdet__grid__finder.html#a5479c1f6a506fdf43bc6fbe696fd662f">afgroup0_</a>.begin();
<a name="l00759"></a>00759          lit != <a class="code" href="classsdet__grid__finder.html#a5479c1f6a506fdf43bc6fbe696fd662f">afgroup0_</a>.end(); lit++)
<a name="l00760"></a>00760       <a class="code" href="classsdet__grid__finder.html#aa9d28ec6718fcfab52eaa2eef52a9fdf">debug_lines_</a>.push_back(*lit);
<a name="l00761"></a>00761     <span class="keywordflow">for</span> (vcl_vector&lt;vsol_line_2d_sptr&gt;::const_iterator lit = <a class="code" href="classsdet__grid__finder.html#af4800373678d26472254c8e3d1c6914d">afgroup1_</a>.begin();
<a name="l00762"></a>00762          lit != <a class="code" href="classsdet__grid__finder.html#af4800373678d26472254c8e3d1c6914d">afgroup1_</a>.end(); lit++)
<a name="l00763"></a>00763       <a class="code" href="classsdet__grid__finder.html#aa9d28ec6718fcfab52eaa2eef52a9fdf">debug_lines_</a>.push_back(*lit);
<a name="l00764"></a>00764   }
<a name="l00765"></a>00765 
<a name="l00766"></a>00766   <span class="keywordtype">double</span> avg_angle0=0, avg_angle1=0, min_angle0=0, max_angle0=0,
<a name="l00767"></a>00767     min_angle1=0, max_angle1=0;
<a name="l00768"></a>00768 
<a name="l00769"></a>00769   group_angle_stats(<a class="code" href="classsdet__grid__finder.html#a5479c1f6a506fdf43bc6fbe696fd662f">afgroup0_</a>, angle_tol_,avg_angle0, min_angle0, max_angle0);
<a name="l00770"></a>00770   group_angle_stats(<a class="code" href="classsdet__grid__finder.html#af4800373678d26472254c8e3d1c6914d">afgroup1_</a>, angle_tol_,avg_angle1, min_angle1, max_angle1);
<a name="l00771"></a>00771 
<a name="l00772"></a>00772   <span class="keywordflow">if</span> (<a class="code" href="classsdet__grid__finder__params.html#add98f5848c934edf71a214b9500c590a" title="print informative debug output">verbose_</a>)
<a name="l00773"></a>00773   {
<a name="l00774"></a>00774     vcl_cout &lt;&lt; <span class="stringliteral">&quot;Affine angles\n&quot;</span>
<a name="l00775"></a>00775              &lt;&lt; <span class="stringliteral">&quot;G[&quot;</span> &lt;&lt; <a class="code" href="classsdet__grid__finder.html#a5479c1f6a506fdf43bc6fbe696fd662f">afgroup0_</a>.size() &lt;&lt; <span class="stringliteral">&quot;] avg_angle = &quot;</span> &lt;&lt; avg_angle0
<a name="l00776"></a>00776              &lt;&lt; <span class="stringliteral">&quot; min_angle = &quot;</span> &lt;&lt; min_angle0 &lt;&lt; <span class="stringliteral">&quot; max_angle = &quot;</span>
<a name="l00777"></a>00777              &lt;&lt; max_angle0 &lt;&lt; <span class="charliteral">&#39;\n&#39;</span>
<a name="l00778"></a>00778              &lt;&lt; <span class="stringliteral">&quot;G[&quot;</span> &lt;&lt; <a class="code" href="classsdet__grid__finder.html#af4800373678d26472254c8e3d1c6914d">afgroup1_</a>.size() &lt;&lt; <span class="stringliteral">&quot;] avg_angle = &quot;</span> &lt;&lt; avg_angle1
<a name="l00779"></a>00779              &lt;&lt; <span class="stringliteral">&quot; min_angle = &quot;</span> &lt;&lt; min_angle1 &lt;&lt; <span class="stringliteral">&quot; max_angle = &quot;</span>
<a name="l00780"></a>00780              &lt;&lt; max_angle1 &lt;&lt; <span class="charliteral">&#39;\n&#39;</span>;
<a name="l00781"></a>00781   }
<a name="l00782"></a>00782   <span class="comment">// Get the orientation of roughly vertical and horizontal lines</span>
<a name="l00783"></a>00783   <span class="comment">// ang0 is the horizontal direction and ang1 is the vertical direction</span>
<a name="l00784"></a>00784   <span class="keywordtype">double</span> deg_to_rad = vnl_math::pi_over_180;
<a name="l00785"></a>00785   <span class="keywordtype">double</span> ang0 =0, ang90=0;
<a name="l00786"></a>00786   <span class="keywordtype">bool</span> zero_is_zero=<span class="keyword">true</span>;;
<a name="l00787"></a>00787   <span class="keywordflow">if</span> (vcl_fabs(vcl_fabs(avg_angle0)-90)&gt;vcl_fabs(vcl_fabs(avg_angle1)-90))
<a name="l00788"></a>00788   {
<a name="l00789"></a>00789     ang0 = avg_angle0*deg_to_rad;
<a name="l00790"></a>00790     ang90= avg_angle1*deg_to_rad;
<a name="l00791"></a>00791     zero_is_zero = <span class="keyword">true</span>;
<a name="l00792"></a>00792   }
<a name="l00793"></a>00793   <span class="keywordflow">else</span>
<a name="l00794"></a>00794   {
<a name="l00795"></a>00795     ang0 = avg_angle1*deg_to_rad;
<a name="l00796"></a>00796     ang90 = avg_angle0*deg_to_rad;
<a name="l00797"></a>00797     zero_is_zero = <span class="keyword">false</span>;
<a name="l00798"></a>00798   }
<a name="l00799"></a>00799   <span class="comment">// lines should be along the positive x axis.</span>
<a name="l00800"></a>00800   <span class="keywordflow">if</span> (ang0&gt;vnl_math::pi_over_2)
<a name="l00801"></a>00801     ang0-=vnl_math::pi;
<a name="l00802"></a>00802   <span class="comment">// lines should be along the positive y axis.</span>
<a name="l00803"></a>00803   <span class="keywordflow">if</span> (ang90&lt;0)
<a name="l00804"></a>00804     ang90+=vnl_math::pi;
<a name="l00805"></a>00805   <span class="comment">// Need to have skew angle at least 60 deg.</span>
<a name="l00806"></a>00806   <span class="keywordflow">if</span> ((vcl_fabs(ang90)-vcl_fabs(ang0))&lt; vnl_math::pi/3.0)
<a name="l00807"></a>00807   {
<a name="l00808"></a>00808     vcl_cout &lt;&lt; <span class="stringliteral">&quot;In sdet_grid_finder::compute_affine_homography() -&quot;</span>
<a name="l00809"></a>00809              &lt;&lt; <span class="stringliteral">&quot; failed to find dominant groups with at least 60 deg&quot;</span>
<a name="l00810"></a>00810              &lt;&lt; <span class="stringliteral">&quot; orientation\n&quot;</span>;
<a name="l00811"></a>00811     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00812"></a>00812   }
<a name="l00813"></a>00813   vnl_matrix_fixed&lt;double, 3,3&gt; Q = skew_transform(ang0, ang90);
<a name="l00814"></a>00814 
<a name="l00815"></a>00815   <span class="keywordflow">if</span> (<a class="code" href="classsdet__grid__finder__params.html#add98f5848c934edf71a214b9500c590a" title="print informative debug output">verbose_</a>)
<a name="l00816"></a>00816     vcl_cout &lt;&lt; <span class="stringliteral">&quot;The skew transform\n&quot;</span> &lt;&lt; Q &lt;&lt; <span class="charliteral">&#39;\n&#39;</span>;
<a name="l00817"></a>00817 
<a name="l00818"></a>00818   <span class="comment">// max distance for distance histogram</span>
<a name="l00819"></a>00819   <span class="comment">// the distance could be larger but unlikely</span>
<a name="l00820"></a>00820   <span class="keywordtype">double</span> dx = vcl_fabs(b.<a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__bounding__box__base.html#aadc63437cf501b3b5d7deb036e15c406">xmax</a>()-b.<a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__bounding__box__base.html#a3d9bceb91ad76a739ae72451e1b491cd">xmin</a>()), dy = vcl_fabs(b.<a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__bounding__box__base.html#a3ed2812c5a93f963f49f73d74e010d81">ymax</a>()-b.<a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__bounding__box__base.html#a41d5be71d0b7497f98bdfcff4f061837">ymin</a>());
<a name="l00821"></a>00821   <span class="keywordtype">double</span> max_distance = dx;
<a name="l00822"></a>00822   <span class="keywordflow">if</span> (dx&lt;dy)
<a name="l00823"></a>00823     max_distance = dy;
<a name="l00824"></a>00824   vnl_matrix_fixed&lt;double, 3, 3&gt; S;
<a name="l00825"></a>00825   <span class="keywordflow">if</span> (zero_is_zero)
<a name="l00826"></a>00826   {
<a name="l00827"></a>00827     <span class="keywordflow">if</span> (!<a class="code" href="classsdet__grid__finder.html#a72eeb18493d23211cfb73c8a8972ac74" title="Form a histogram of all pairwise distances of lines from the origin.">scale_transform</a>(max_distance, <a class="code" href="classsdet__grid__finder.html#a5479c1f6a506fdf43bc6fbe696fd662f">afgroup0_</a>, <a class="code" href="classsdet__grid__finder.html#af4800373678d26472254c8e3d1c6914d">afgroup1_</a>, S))
<a name="l00828"></a>00828       <span class="keywordflow">return</span> <span class="keyword">false</span>; <span class="comment">// failed to find a first distance peak</span>
<a name="l00829"></a>00829   }
<a name="l00830"></a>00830   <span class="keywordflow">else</span>
<a name="l00831"></a>00831     <span class="keywordflow">if</span> (!<a class="code" href="classsdet__grid__finder.html#a72eeb18493d23211cfb73c8a8972ac74" title="Form a histogram of all pairwise distances of lines from the origin.">scale_transform</a>(max_distance, <a class="code" href="classsdet__grid__finder.html#af4800373678d26472254c8e3d1c6914d">afgroup1_</a>, <a class="code" href="classsdet__grid__finder.html#a5479c1f6a506fdf43bc6fbe696fd662f">afgroup0_</a>, S))
<a name="l00832"></a>00832       <span class="keywordflow">return</span> <span class="keyword">false</span>; <span class="comment">// failed to find a first distance peak</span>
<a name="l00833"></a>00833   <span class="keywordflow">if</span> (<a class="code" href="classsdet__grid__finder__params.html#add98f5848c934edf71a214b9500c590a" title="print informative debug output">verbose_</a>)
<a name="l00834"></a>00834     vcl_cout &lt;&lt; <span class="stringliteral">&quot;The scale transform\n&quot;</span> &lt;&lt; S &lt;&lt; <span class="charliteral">&#39;\n&#39;</span>;
<a name="l00835"></a>00835 
<a name="l00836"></a>00836   <a class="code" href="classsdet__grid__finder.html#af8ffa23de41ab9c460c00acfe9967270">affine_homography_</a> = <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__h__matrix__2d.html">vgl_h_matrix_2d&lt;double&gt;</a>(S*Q);
<a name="l00837"></a>00837 
<a name="l00838"></a>00838   <span class="comment">// Finally we translate until the first row and column of lines are at (0,0)</span>
<a name="l00839"></a>00839 <span class="preprocessor">#if 0 // Hack! needs to be removed JLM</span>
<a name="l00840"></a>00840 <span class="preprocessor"></span>  <span class="keywordtype">double</span> length_threshold = 7.0;
<a name="l00841"></a>00841 <span class="preprocessor">#endif</span>
<a name="l00842"></a>00842 <span class="preprocessor"></span>  vcl_vector&lt;vsol_line_2d_sptr&gt; grid_lines0, grid_lines90;
<a name="l00843"></a>00843   <span class="keywordflow">for</span> (vcl_vector&lt;vsol_line_2d_sptr&gt;::iterator lit = <a class="code" href="classsdet__grid__finder.html#a5479c1f6a506fdf43bc6fbe696fd662f">afgroup0_</a>.begin();
<a name="l00844"></a>00844        lit != <a class="code" href="classsdet__grid__finder.html#a5479c1f6a506fdf43bc6fbe696fd662f">afgroup0_</a>.end(); lit++)
<a name="l00845"></a>00845   {
<a name="l00846"></a>00846 <span class="preprocessor">#if 0 // Hack! needs to be removed JLM</span>
<a name="l00847"></a>00847 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ((*lit)-&gt;length()&lt;length_threshold)
<a name="l00848"></a>00848       <span class="keywordflow">continue</span>;
<a name="l00849"></a>00849 <span class="preprocessor">#endif</span>
<a name="l00850"></a>00850 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (zero_is_zero)
<a name="l00851"></a>00851       grid_lines0.push_back(this-&gt;<a class="code" href="classsdet__grid__finder.html#a1e9152e3f3fb0e0d60823dde70616408" title="transform a vsol line by transforming the end points.">transform_line</a>(<a class="code" href="classsdet__grid__finder.html#af8ffa23de41ab9c460c00acfe9967270">affine_homography_</a>,*lit));
<a name="l00852"></a>00852     <span class="keywordflow">else</span>
<a name="l00853"></a>00853       grid_lines90.push_back(this-&gt;<a class="code" href="classsdet__grid__finder.html#a1e9152e3f3fb0e0d60823dde70616408" title="transform a vsol line by transforming the end points.">transform_line</a>(<a class="code" href="classsdet__grid__finder.html#af8ffa23de41ab9c460c00acfe9967270">affine_homography_</a>,*lit));
<a name="l00854"></a>00854   }
<a name="l00855"></a>00855   <span class="keywordflow">for</span> (vcl_vector&lt;vsol_line_2d_sptr&gt;::iterator lit = <a class="code" href="classsdet__grid__finder.html#af4800373678d26472254c8e3d1c6914d">afgroup1_</a>.begin();
<a name="l00856"></a>00856        lit != <a class="code" href="classsdet__grid__finder.html#af4800373678d26472254c8e3d1c6914d">afgroup1_</a>.end(); lit++)
<a name="l00857"></a>00857   {
<a name="l00858"></a>00858 <span class="preprocessor">#if 0 // Hack! needs to be removed JLM</span>
<a name="l00859"></a>00859 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ((*lit)-&gt;length()&lt;length_threshold)
<a name="l00860"></a>00860       <span class="keywordflow">continue</span>;
<a name="l00861"></a>00861 <span class="preprocessor">#endif</span>
<a name="l00862"></a>00862 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (zero_is_zero)
<a name="l00863"></a>00863       grid_lines90.push_back(this-&gt;<a class="code" href="classsdet__grid__finder.html#a1e9152e3f3fb0e0d60823dde70616408" title="transform a vsol line by transforming the end points.">transform_line</a>(<a class="code" href="classsdet__grid__finder.html#af8ffa23de41ab9c460c00acfe9967270">affine_homography_</a>,*lit));
<a name="l00864"></a>00864     <span class="keywordflow">else</span>
<a name="l00865"></a>00865       grid_lines0.push_back(this-&gt;<a class="code" href="classsdet__grid__finder.html#a1e9152e3f3fb0e0d60823dde70616408" title="transform a vsol line by transforming the end points.">transform_line</a>(<a class="code" href="classsdet__grid__finder.html#af8ffa23de41ab9c460c00acfe9967270">affine_homography_</a>,*lit));
<a name="l00866"></a>00866   }
<a name="l00867"></a>00867   <span class="keywordflow">if</span> ( (<a class="code" href="classsdet__grid__finder__params.html#ac564d24cb4fcfd8407a8cf391faff9df" title="general purpose debug state">debug_state_</a>==<a class="code" href="classsdet__grid__finder__params.html#ad4baa1d37da291f4ed5f70ab8b279d05a569eb7384f690776047fa6a9ce8b9244">AFFINE_GROUP_AFTER_SKEW_SCALE</a>) ||
<a name="l00868"></a>00868        (<a class="code" href="classsdet__grid__finder__params.html#ac564d24cb4fcfd8407a8cf391faff9df" title="general purpose debug state">debug_state_</a>==<a class="code" href="classsdet__grid__finder__params.html#ad4baa1d37da291f4ed5f70ab8b279d05abc063922ae6fbdce87cff02c97711aa5">TRANS_PERIM_LINES</a>) )
<a name="l00869"></a>00869   {
<a name="l00870"></a>00870     <span class="keywordflow">for</span> (vcl_vector&lt;vsol_line_2d_sptr&gt;::const_iterator lit =
<a name="l00871"></a>00871          grid_lines0.begin(); lit != grid_lines0.end(); lit++)
<a name="l00872"></a>00872       <a class="code" href="classsdet__grid__finder.html#aa9d28ec6718fcfab52eaa2eef52a9fdf">debug_lines_</a>.push_back(*lit);
<a name="l00873"></a>00873     <span class="keywordflow">for</span> (vcl_vector&lt;vsol_line_2d_sptr&gt;::const_iterator lit =
<a name="l00874"></a>00874          grid_lines90.begin(); lit != grid_lines90.end(); lit++)
<a name="l00875"></a>00875       <a class="code" href="classsdet__grid__finder.html#aa9d28ec6718fcfab52eaa2eef52a9fdf">debug_lines_</a>.push_back(*lit);
<a name="l00876"></a>00876   }
<a name="l00877"></a>00877 
<a name="l00878"></a>00878   vcl_sort(grid_lines0.begin(), grid_lines0.end(), line_distance);
<a name="l00879"></a>00879   vcl_sort(grid_lines90.begin(), grid_lines90.end(), line_distance);
<a name="l00880"></a>00880 
<a name="l00881"></a>00881 <span class="preprocessor">#ifdef DEBUG</span>
<a name="l00882"></a>00882 <span class="preprocessor"></span>    vcl_cout &lt;&lt;  <span class="stringliteral">&quot;Grid Lines 0\n&quot;</span>
<a name="l00883"></a>00883 <span class="preprocessor">#endif</span>
<a name="l00884"></a>00884 <span class="preprocessor"></span>  <span class="keywordflow">if</span> (!<a class="code" href="classsdet__grid__finder.html#a47be4de5ae943b7d0654518ade0f6866">chamf0_</a>.<a class="code" href="classgrid__profile__matcher.html#af53289908e1c451ba78fc7e20e09be32">insert_lines</a>(grid_lines0,<span class="keyword">true</span>))
<a name="l00885"></a>00885     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00886"></a>00886 
<a name="l00887"></a>00887 <span class="preprocessor">#ifdef DEBUG</span>
<a name="l00888"></a>00888 <span class="preprocessor"></span>    vcl_cout &lt;&lt;  <span class="stringliteral">&quot;Grid Lines 90\n&quot;</span>
<a name="l00889"></a>00889 <span class="preprocessor">#endif</span>
<a name="l00890"></a>00890 <span class="preprocessor"></span>  <span class="keywordflow">if</span> (!<a class="code" href="classsdet__grid__finder.html#a100d886c27561158c8d647188565a8a3">chamf90_</a>.<a class="code" href="classgrid__profile__matcher.html#af53289908e1c451ba78fc7e20e09be32">insert_lines</a>(grid_lines90,<span class="keyword">false</span>))
<a name="l00891"></a>00891     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00892"></a>00892 
<a name="l00893"></a>00893   <span class="keywordflow">if</span> (<span class="keyword">false</span>)
<a name="l00894"></a>00894   {
<a name="l00895"></a>00895     vcl_cout &lt;&lt; <span class="stringliteral">&quot;Grid Lines 0\n&quot;</span>;
<a name="l00896"></a>00896     print_lines(grid_lines0);
<a name="l00897"></a>00897     vcl_cout &lt;&lt; <span class="stringliteral">&quot;\n\nGrid Lines 90\n&quot;</span>;
<a name="l00898"></a>00898     print_lines(grid_lines90);
<a name="l00899"></a>00899   }
<a name="l00900"></a>00900   <span class="keywordflow">for</span> (vcl_vector&lt;vsol_line_2d_sptr&gt;::iterator lit = grid_lines0.begin();
<a name="l00901"></a>00901        lit != grid_lines0.end(); lit++)
<a name="l00902"></a>00902     <a class="code" href="classsdet__grid__finder.html#af8741f73fabae9955adedb5a086e7333">display_lines_</a>.push_back(*lit);
<a name="l00903"></a>00903 
<a name="l00904"></a>00904   <span class="keywordflow">for</span> (vcl_vector&lt;vsol_line_2d_sptr&gt;::iterator lit = grid_lines90.begin();
<a name="l00905"></a>00905        lit != grid_lines90.end(); lit++)
<a name="l00906"></a>00906     <a class="code" href="classsdet__grid__finder.html#af8741f73fabae9955adedb5a086e7333">display_lines_</a>.push_back(*lit);
<a name="l00907"></a>00907 
<a name="l00908"></a>00908   <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__h__matrix__2d.html">vgl_h_matrix_2d&lt;double&gt;</a> T;
<a name="l00909"></a>00909   this-&gt;<a class="code" href="classsdet__grid__finder.html#adfff542ac34d5fa21ef4f3a76691549b" title="Assumes that a set of lines have been binned in the 1-d chamfer index.">compute_homography_linear_chamfer</a>(T);
<a name="l00910"></a>00910   <a class="code" href="classsdet__grid__finder.html#af8ffa23de41ab9c460c00acfe9967270">affine_homography_</a> = T*<a class="code" href="classsdet__grid__finder.html#af8ffa23de41ab9c460c00acfe9967270">affine_homography_</a>;
<a name="l00911"></a>00911   <span class="keywordflow">if</span> (<a class="code" href="classsdet__grid__finder__params.html#add98f5848c934edf71a214b9500c590a" title="print informative debug output">verbose_</a>)
<a name="l00912"></a>00912     vcl_cout &lt;&lt; <span class="stringliteral">&quot;The affine homography\n&quot;</span> &lt;&lt; affine_homography_ &lt;&lt; <span class="charliteral">&#39;\n&#39;</span>;
<a name="l00913"></a>00913   <a class="code" href="classsdet__grid__finder.html#a4e263ed701ac653df5ba092d1b0cc957">affine_homography_valid_</a> = <span class="keyword">true</span>;
<a name="l00914"></a>00914   <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00915"></a>00915 }
<a name="l00916"></a>00916 
<a name="l00917"></a>00917 
<a name="l00918"></a>00918 <span class="comment">//------------------------------------------------------</span>
<a name="l00919"></a>00919 <span class="comment">//: Assumes that a set of lines have been binned in the 1-d chamfer index</span>
<a name="l00920"></a>00920 <span class="comment">//  Assumes that dindex0_ are vertical lines and dindex90_ are horizontal</span>
<a name="l00921"></a>00921 <span class="keywordtype">bool</span> <a class="code" href="classsdet__grid__finder.html#adfff542ac34d5fa21ef4f3a76691549b" title="Assumes that a set of lines have been binned in the 1-d chamfer index.">sdet_grid_finder::</a>
<a name="l00922"></a><a class="code" href="classsdet__grid__finder.html#adfff542ac34d5fa21ef4f3a76691549b">00922</a> <a class="code" href="classsdet__grid__finder.html#adfff542ac34d5fa21ef4f3a76691549b" title="Assumes that a set of lines have been binned in the 1-d chamfer index.">compute_homography_linear_chamfer</a>(<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__h__matrix__2d.html">vgl_h_matrix_2d&lt;double&gt;</a> &amp; H)
<a name="l00923"></a>00923 {
<a name="l00924"></a>00924   <span class="keywordtype">double</span> transx=0, transy=0;
<a name="l00925"></a>00925 
<a name="l00926"></a>00926   transx = <a class="code" href="classsdet__grid__finder.html#a100d886c27561158c8d647188565a8a3">chamf90_</a>.<a class="code" href="classgrid__profile__matcher.html#acb8dc8122fb13221f593fcb6d5dacfa3">calculate_grid_offset</a>(<a class="code" href="classsdet__grid__finder__params.html#a5f247d928fac91521ad77f20a81442c7" title="number of vertical grid lines">n_lines_y_</a>,<a class="code" href="classsdet__grid__finder__params.html#a68f253a0739973bf648cb8fada037c7f" title="spacing between lines">spacing_</a>);
<a name="l00927"></a>00927   transy = <a class="code" href="classsdet__grid__finder.html#a47be4de5ae943b7d0654518ade0f6866">chamf0_</a>.<a class="code" href="classgrid__profile__matcher.html#acb8dc8122fb13221f593fcb6d5dacfa3">calculate_grid_offset</a>(<a class="code" href="classsdet__grid__finder__params.html#a46958d023680a9c790b3af4155297bf5" title="number of horizontal grid lines">n_lines_x_</a>,<a class="code" href="classsdet__grid__finder__params.html#a68f253a0739973bf648cb8fada037c7f" title="spacing between lines">spacing_</a>);
<a name="l00928"></a>00928 
<a name="l00929"></a>00929   <span class="keywordflow">if</span> (<a class="code" href="classsdet__grid__finder__params.html#add98f5848c934edf71a214b9500c590a" title="print informative debug output">verbose_</a>)
<a name="l00930"></a>00930     vcl_cout &lt;&lt; <span class="stringliteral">&quot; Translation (&quot;</span> &lt;&lt; transx &lt;&lt; <span class="charliteral">&#39; &#39;</span> &lt;&lt; transy &lt;&lt; <span class="stringliteral">&quot;)\n&quot;</span>;
<a name="l00931"></a>00931 
<a name="l00932"></a>00932   <span class="keywordflow">if</span> (<a class="code" href="classsdet__grid__finder__params.html#ac564d24cb4fcfd8407a8cf391faff9df" title="general purpose debug state">debug_state_</a> == <a class="code" href="classsdet__grid__finder__params.html#ad4baa1d37da291f4ed5f70ab8b279d05abc063922ae6fbdce87cff02c97711aa5">TRANS_PERIM_LINES</a>)
<a name="l00933"></a>00933   {
<a name="l00934"></a>00934     <span class="keywordtype">float</span> xmin = 0, ymin = 0;
<a name="l00935"></a>00935     <span class="keywordtype">float</span> xmax = 2000, ymax = 2000;
<a name="l00936"></a>00936     <span class="comment">// vertical lines</span>
<a name="l00937"></a>00937     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="classsdet__grid__finder__params.html#a5f247d928fac91521ad77f20a81442c7" title="number of vertical grid lines">n_lines_y_</a>; i++)
<a name="l00938"></a>00938     {
<a name="l00939"></a>00939       <a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__smart__ptr.html">vsol_point_2d_sptr</a> p0 = <span class="keyword">new</span> <a class="codeRef" doxygen="contrib_gel_vsol.tag:../../../../../contrib/gel/vsol/html" href="../../../../../contrib/gel/vsol/html/classvsol__point__2d.html">vsol_point_2d</a>(i*<a class="code" href="classsdet__grid__finder__params.html#a68f253a0739973bf648cb8fada037c7f" title="spacing between lines">spacing_</a>+transx,ymin);
<a name="l00940"></a>00940       <a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__smart__ptr.html">vsol_point_2d_sptr</a> p1 = <span class="keyword">new</span> <a class="codeRef" doxygen="contrib_gel_vsol.tag:../../../../../contrib/gel/vsol/html" href="../../../../../contrib/gel/vsol/html/classvsol__point__2d.html">vsol_point_2d</a>(i*<a class="code" href="classsdet__grid__finder__params.html#a68f253a0739973bf648cb8fada037c7f" title="spacing between lines">spacing_</a>+transx,ymax);
<a name="l00941"></a>00941       <a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__smart__ptr.html">vsol_line_2d_sptr</a> line = <span class="keyword">new</span> <a class="codeRef" doxygen="contrib_gel_vsol.tag:../../../../../contrib/gel/vsol/html" href="../../../../../contrib/gel/vsol/html/classvsol__line__2d.html">vsol_line_2d</a>(p0,p1);
<a name="l00942"></a>00942       <a class="code" href="classsdet__grid__finder.html#a433d404aac637bbba94656ecec0f5e47">debug_grid_lines_</a>.push_back(line);
<a name="l00943"></a>00943     }
<a name="l00944"></a>00944     <span class="comment">// horizontal lines</span>
<a name="l00945"></a>00945     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="classsdet__grid__finder__params.html#a46958d023680a9c790b3af4155297bf5" title="number of horizontal grid lines">n_lines_x_</a>; i++)
<a name="l00946"></a>00946     {
<a name="l00947"></a>00947       <a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__smart__ptr.html">vsol_point_2d_sptr</a> p0 = <span class="keyword">new</span> <a class="codeRef" doxygen="contrib_gel_vsol.tag:../../../../../contrib/gel/vsol/html" href="../../../../../contrib/gel/vsol/html/classvsol__point__2d.html">vsol_point_2d</a>(xmin,i*<a class="code" href="classsdet__grid__finder__params.html#a68f253a0739973bf648cb8fada037c7f" title="spacing between lines">spacing_</a>+transy);
<a name="l00948"></a>00948       <a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__smart__ptr.html">vsol_point_2d_sptr</a> p1 = <span class="keyword">new</span> <a class="codeRef" doxygen="contrib_gel_vsol.tag:../../../../../contrib/gel/vsol/html" href="../../../../../contrib/gel/vsol/html/classvsol__point__2d.html">vsol_point_2d</a>(xmax,i*<a class="code" href="classsdet__grid__finder__params.html#a68f253a0739973bf648cb8fada037c7f" title="spacing between lines">spacing_</a>+transy);
<a name="l00949"></a>00949       <a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__smart__ptr.html">vsol_line_2d_sptr</a> line = <span class="keyword">new</span> <a class="codeRef" doxygen="contrib_gel_vsol.tag:../../../../../contrib/gel/vsol/html" href="../../../../../contrib/gel/vsol/html/classvsol__line__2d.html">vsol_line_2d</a>(p0,p1);
<a name="l00950"></a>00950       <a class="code" href="classsdet__grid__finder.html#a433d404aac637bbba94656ecec0f5e47">debug_grid_lines_</a>.push_back(line);
<a name="l00951"></a>00951     }
<a name="l00952"></a>00952   }
<a name="l00953"></a>00953 
<a name="l00954"></a>00954   <span class="comment">// compute new homography so we can double check matched lines</span>
<a name="l00955"></a>00955   vnl_matrix_fixed&lt;double, 3, 3&gt; T;
<a name="l00956"></a>00956   T.put(0, 0, 1); T.put(0,1, 0); T.put(0,2,-transx);
<a name="l00957"></a>00957   T.put(1, 0, 0); T.put(1,1, 1); T.put(1,2,-transy);
<a name="l00958"></a>00958   T.put(2, 0, 0); T.put(2,1, 0); T.put(2,2,1);
<a name="l00959"></a>00959   <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__h__matrix__2d.html">vgl_h_matrix_2d&lt;double&gt;</a> Htrans(T);
<a name="l00960"></a>00960   <span class="keywordtype">double</span> min_x_offset = -10.0, max_x_offset =(<a class="code" href="classsdet__grid__finder__params.html#a5f247d928fac91521ad77f20a81442c7" title="number of vertical grid lines">n_lines_y_</a>-1)*<a class="code" href="classsdet__grid__finder__params.html#a68f253a0739973bf648cb8fada037c7f" title="spacing between lines">spacing_</a> + 10;
<a name="l00961"></a>00961   <span class="keywordtype">double</span> min_y_offset = -10.0, max_y_offset =(<a class="code" href="classsdet__grid__finder__params.html#a46958d023680a9c790b3af4155297bf5" title="number of horizontal grid lines">n_lines_x_</a>-1)*<a class="code" href="classsdet__grid__finder__params.html#a68f253a0739973bf648cb8fada037c7f" title="spacing between lines">spacing_</a> + 10;
<a name="l00962"></a>00962   vcl_vector&lt;vgl_homg_line_2d&lt;double&gt; &gt; lines_grid, lines_image;
<a name="l00963"></a>00963   vcl_vector&lt;double&gt; weights;
<a name="l00964"></a>00964   <span class="comment">// insert horizontal line correspondences</span>
<a name="l00965"></a>00965   <span class="keywordtype">double</span> length_sum = 0;
<a name="l00966"></a>00966   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i0 = 0; i0&lt; <a class="code" href="classsdet__grid__finder__params.html#a46958d023680a9c790b3af4155297bf5" title="number of horizontal grid lines">n_lines_x_</a>; i0++)
<a name="l00967"></a>00967   {
<a name="l00968"></a>00968     <span class="keywordtype">double</span> dy = i0*<a class="code" href="classsdet__grid__finder__params.html#a68f253a0739973bf648cb8fada037c7f" title="spacing between lines">spacing_</a>;
<a name="l00969"></a>00969     <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__line__2d.html">vgl_homg_line_2d&lt;double&gt;</a> lh(0.0, 1.0, -dy);
<a name="l00970"></a>00970     dy += transy;
<a name="l00971"></a>00971     vcl_vector&lt;vsol_line_2d_sptr&gt; h_lines;
<a name="l00972"></a>00972     <a class="code" href="classsdet__grid__finder.html#a47be4de5ae943b7d0654518ade0f6866">chamf0_</a>.<a class="code" href="classgrid__profile__matcher.html#a113460f59a988d1f4c8873ca3aa8ce9c">get_lines_in_interval</a>(dy, collection_grid_radius, h_lines);
<a name="l00973"></a>00973 
<a name="l00974"></a>00974     <span class="keywordflow">if</span> (!h_lines.size())
<a name="l00975"></a>00975       <span class="keywordflow">continue</span>;
<a name="l00976"></a>00976     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j0 = 0; j0&lt;h_lines.size(); j0++)
<a name="l00977"></a>00977     {
<a name="l00978"></a>00978       <a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__smart__ptr.html">vsol_line_2d_sptr</a> l0 = h_lines[j0];
<a name="l00979"></a>00979 
<a name="l00980"></a>00980       <span class="comment">// check x offset</span>
<a name="l00981"></a>00981       <a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__smart__ptr.html">vsol_line_2d_sptr</a> l0_xformed = this-&gt;<a class="code" href="classsdet__grid__finder.html#a1e9152e3f3fb0e0d60823dde70616408" title="transform a vsol line by transforming the end points.">transform_line</a>(Htrans,l0);
<a name="l00982"></a>00982       <a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__smart__ptr.html">vsol_point_2d_sptr</a> mid = l0_xformed-&gt;middle();
<a name="l00983"></a>00983 <span class="preprocessor">#ifdef DEBUG</span>
<a name="l00984"></a>00984 <span class="preprocessor"></span>      vcl_cout &lt;&lt; <span class="stringliteral">&quot;horizontal, p=(&quot;</span>&lt;&lt;mid-&gt;x()&lt;&lt;<span class="charliteral">&#39;,&#39;</span>&lt;&lt;mid-&gt;y()&lt;&lt;<span class="stringliteral">&quot;)\n&quot;</span>;
<a name="l00985"></a>00985 <span class="preprocessor">#endif</span>
<a name="l00986"></a>00986 <span class="preprocessor"></span>      <span class="keywordflow">if</span> ( (mid-&gt;x() &lt; min_x_offset) || (mid-&gt;x() &gt; max_x_offset) )
<a name="l00987"></a>00987       {
<a name="l00988"></a>00988 <span class="preprocessor">#ifdef DEBUG</span>
<a name="l00989"></a>00989 <span class="preprocessor"></span>        vcl_cout &lt;&lt; <span class="stringliteral">&quot;discarding line with offset &quot;</span>&lt;&lt;mid-&gt;x()&lt;&lt;<span class="charliteral">&#39;\n&#39;</span>;
<a name="l00990"></a>00990 <span class="preprocessor">#endif</span>
<a name="l00991"></a>00991 <span class="preprocessor"></span>        <span class="keywordflow">continue</span>;
<a name="l00992"></a>00992       }
<a name="l00993"></a>00993       <span class="comment">// line passes: add to set of correspondences</span>
<a name="l00994"></a>00994       lines_grid.push_back(lh);
<a name="l00995"></a>00995       <a class="code" href="classsdet__grid__finder.html#ade4391e462f73ecad1afe151d2e2667a">matched_lines_</a>.push_back(l0);
<a name="l00996"></a>00996       <span class="keywordflow">if</span> (<a class="code" href="classsdet__grid__finder__params.html#ac564d24cb4fcfd8407a8cf391faff9df" title="general purpose debug state">debug_state_</a>==<a class="code" href="classsdet__grid__finder__params.html#ad4baa1d37da291f4ed5f70ab8b279d05ad805c9f461e322d4797fc0d26c73f143">AFFINE_GROUP_AFTER_TRANS</a>)
<a name="l00997"></a>00997         <a class="code" href="classsdet__grid__finder.html#aa9d28ec6718fcfab52eaa2eef52a9fdf">debug_lines_</a>.push_back(l0);
<a name="l00998"></a>00998       <span class="keywordtype">double</span> <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/vgl__vector__2d_8h.html#a31c7db8164e71d411a1a821525102dc3">length</a> = l0-&gt;length();
<a name="l00999"></a>00999       length_sum += length;
<a name="l01000"></a>01000       weights.push_back(length);
<a name="l01001"></a>01001       <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__line__2d.html">vgl_homg_line_2d&lt;double&gt;</a> homgl = l0-&gt;vgl_hline_2d();
<a name="l01002"></a>01002       homgl.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__line__2d.html#a9cface519ff2e18c6ebc9c4293bd41fa">normalize</a>();
<a name="l01003"></a>01003 <span class="preprocessor">#ifdef DEBUG</span>
<a name="l01004"></a>01004 <span class="preprocessor"></span>      vcl_cout &lt;&lt; homgl &lt;&lt; <span class="charliteral">&#39;\n&#39;</span>;
<a name="l01005"></a>01005 <span class="preprocessor">#endif</span>
<a name="l01006"></a>01006 <span class="preprocessor"></span>      lines_image.push_back(homgl);
<a name="l01007"></a>01007     }
<a name="l01008"></a>01008   }
<a name="l01009"></a>01009 
<a name="l01010"></a>01010   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i90 = 0; i90&lt; <a class="code" href="classsdet__grid__finder__params.html#a5f247d928fac91521ad77f20a81442c7" title="number of vertical grid lines">n_lines_y_</a>; i90++)
<a name="l01011"></a>01011   {
<a name="l01012"></a>01012     <span class="keywordtype">double</span> dx = i90*<a class="code" href="classsdet__grid__finder__params.html#a68f253a0739973bf648cb8fada037c7f" title="spacing between lines">spacing_</a>;
<a name="l01013"></a>01013     <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__line__2d.html">vgl_homg_line_2d&lt;double&gt;</a> lv(1.0, 0.0, -dx);
<a name="l01014"></a>01014     dx += transx;
<a name="l01015"></a>01015     vcl_vector&lt;vsol_line_2d_sptr&gt; v_lines;
<a name="l01016"></a>01016     <a class="code" href="classsdet__grid__finder.html#a100d886c27561158c8d647188565a8a3">chamf90_</a>.<a class="code" href="classgrid__profile__matcher.html#a113460f59a988d1f4c8873ca3aa8ce9c">get_lines_in_interval</a>(dx, collection_grid_radius, v_lines);
<a name="l01017"></a>01017     <span class="keywordflow">if</span> (!v_lines.size())
<a name="l01018"></a>01018       <span class="keywordflow">continue</span>;
<a name="l01019"></a>01019     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j90 = 0; j90&lt;v_lines.size(); j90++)
<a name="l01020"></a>01020     {
<a name="l01021"></a>01021       <a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__smart__ptr.html">vsol_line_2d_sptr</a> l90 = v_lines[j90];
<a name="l01022"></a>01022       <span class="comment">// check y offset</span>
<a name="l01023"></a>01023       <a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__smart__ptr.html">vsol_line_2d_sptr</a> l90_xformed = this-&gt;<a class="code" href="classsdet__grid__finder.html#a1e9152e3f3fb0e0d60823dde70616408" title="transform a vsol line by transforming the end points.">transform_line</a>(Htrans,l90);
<a name="l01024"></a>01024       <a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__smart__ptr.html">vsol_point_2d_sptr</a> mid = l90_xformed-&gt;middle();
<a name="l01025"></a>01025 <span class="preprocessor">#ifdef DEBUG</span>
<a name="l01026"></a>01026 <span class="preprocessor"></span>      vcl_cout &lt;&lt; <span class="stringliteral">&quot;vertical, p=(&quot;</span>&lt;&lt;mid-&gt;x()&lt;&lt;<span class="charliteral">&#39;,&#39;</span>&lt;&lt;mid-&gt;y()&lt;&lt;<span class="stringliteral">&quot;)\n&quot;</span>;
<a name="l01027"></a>01027 <span class="preprocessor">#endif</span>
<a name="l01028"></a>01028 <span class="preprocessor"></span>      <span class="keywordflow">if</span> ( (mid-&gt;y() &lt; min_y_offset) || (mid-&gt;y() &gt; max_y_offset) )
<a name="l01029"></a>01029       {
<a name="l01030"></a>01030 <span class="preprocessor">#ifdef DEBUG</span>
<a name="l01031"></a>01031 <span class="preprocessor"></span>        vcl_cout &lt;&lt; <span class="stringliteral">&quot;discarding line with offset &quot;</span>&lt;&lt;mid-&gt;y()&lt;&lt;<span class="charliteral">&#39;\n&#39;</span>;
<a name="l01032"></a>01032 <span class="preprocessor">#endif</span>
<a name="l01033"></a>01033 <span class="preprocessor"></span>        <span class="keywordflow">continue</span>;
<a name="l01034"></a>01034       }
<a name="l01035"></a>01035       <span class="comment">// line passes: add to set of correspondences</span>
<a name="l01036"></a>01036       lines_grid.push_back(lv);
<a name="l01037"></a>01037 
<a name="l01038"></a>01038       <a class="code" href="classsdet__grid__finder.html#ade4391e462f73ecad1afe151d2e2667a">matched_lines_</a>.push_back(l90);
<a name="l01039"></a>01039       <span class="keywordflow">if</span> (<a class="code" href="classsdet__grid__finder__params.html#ac564d24cb4fcfd8407a8cf391faff9df" title="general purpose debug state">debug_state_</a>==<a class="code" href="classsdet__grid__finder__params.html#ad4baa1d37da291f4ed5f70ab8b279d05ad805c9f461e322d4797fc0d26c73f143">AFFINE_GROUP_AFTER_TRANS</a>)
<a name="l01040"></a>01040         <a class="code" href="classsdet__grid__finder.html#aa9d28ec6718fcfab52eaa2eef52a9fdf">debug_lines_</a>.push_back(l90);
<a name="l01041"></a>01041       <span class="keywordtype">double</span> <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/vgl__vector__2d_8h.html#a31c7db8164e71d411a1a821525102dc3">length</a> = l90-&gt;length();
<a name="l01042"></a>01042       length_sum += length;
<a name="l01043"></a>01043       weights.push_back(length);
<a name="l01044"></a>01044       <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__line__2d.html">vgl_homg_line_2d&lt;double&gt;</a>  homgl = l90-&gt;vgl_hline_2d();
<a name="l01045"></a>01045       homgl.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__line__2d.html#a9cface519ff2e18c6ebc9c4293bd41fa">normalize</a>();
<a name="l01046"></a>01046 <span class="preprocessor">#ifdef DEBUG</span>
<a name="l01047"></a>01047 <span class="preprocessor"></span>       vcl_cout &lt;&lt; homgl &lt;&lt; <span class="charliteral">&#39;\n&#39;</span>;
<a name="l01048"></a>01048 <span class="preprocessor">#endif</span>
<a name="l01049"></a>01049 <span class="preprocessor"></span>      lines_image.push_back(homgl);
<a name="l01050"></a>01050     }
<a name="l01051"></a>01051   }
<a name="l01052"></a>01052   <span class="keywordflow">if</span> (<a class="code" href="classsdet__grid__finder__params.html#ac564d24cb4fcfd8407a8cf391faff9df" title="general purpose debug state">debug_state_</a>==<a class="code" href="classsdet__grid__finder__params.html#ad4baa1d37da291f4ed5f70ab8b279d05ad805c9f461e322d4797fc0d26c73f143">AFFINE_GROUP_AFTER_TRANS</a>)
<a name="l01053"></a>01053   {
<a name="l01054"></a>01054     vnl_matrix_fixed&lt;double, 3, 3&gt; T;
<a name="l01055"></a>01055     T.put(0, 0, 1); T.put(0,1, 0); T.put(0,2,-transx);
<a name="l01056"></a>01056     T.put(1, 0, 0); T.put(1,1, 1); T.put(1,2,-transy);
<a name="l01057"></a>01057     T.put(2, 0, 0); T.put(2,1, 0); T.put(2,2,1);
<a name="l01058"></a>01058     <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__h__matrix__2d.html">vgl_h_matrix_2d&lt;double&gt;</a> h(T);
<a name="l01059"></a>01059     vcl_vector&lt;vsol_line_2d_sptr&gt; temp;
<a name="l01060"></a>01060     <span class="keywordflow">for</span> (vcl_vector&lt;vsol_line_2d_sptr&gt;::iterator lit = <a class="code" href="classsdet__grid__finder.html#aa9d28ec6718fcfab52eaa2eef52a9fdf">debug_lines_</a>.begin();
<a name="l01061"></a>01061          lit != <a class="code" href="classsdet__grid__finder.html#aa9d28ec6718fcfab52eaa2eef52a9fdf">debug_lines_</a>.end(); lit++)
<a name="l01062"></a>01062     {
<a name="l01063"></a>01063       <a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__smart__ptr.html">vsol_line_2d_sptr</a> l = this-&gt;<a class="code" href="classsdet__grid__finder.html#a1e9152e3f3fb0e0d60823dde70616408" title="transform a vsol line by transforming the end points.">transform_line</a>(h,*lit);
<a name="l01064"></a>01064       temp.push_back(l);
<a name="l01065"></a>01065     }
<a name="l01066"></a>01066     <a class="code" href="classsdet__grid__finder.html#aa9d28ec6718fcfab52eaa2eef52a9fdf">debug_lines_</a>.clear();
<a name="l01067"></a>01067     <a class="code" href="classsdet__grid__finder.html#aa9d28ec6718fcfab52eaa2eef52a9fdf">debug_lines_</a> = temp;
<a name="l01068"></a>01068   }
<a name="l01069"></a>01069 
<a name="l01070"></a>01070   <span class="keywordflow">if</span> (length_sum)
<a name="l01071"></a>01071     <span class="keywordflow">for</span> (vcl_vector&lt;double&gt;::iterator wit = weights.begin();
<a name="l01072"></a>01072          wit != weights.end(); wit++)
<a name="l01073"></a>01073       (*wit)/=length_sum;
<a name="l01074"></a>01074 
<a name="l01075"></a>01075   <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__h__matrix__2d__compute__linear.html">vgl_h_matrix_2d_compute_linear</a> hcl;
<a name="l01076"></a>01076 <span class="preprocessor">#if 0</span>
<a name="l01077"></a>01077 <span class="preprocessor"></span>  <span class="keywordtype">double</span> error_term = -1;
<a name="l01078"></a>01078 <span class="preprocessor">#endif</span>
<a name="l01079"></a>01079 <span class="preprocessor"></span>  H = hcl.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__h__matrix__2d__compute.html#a31168dffd34306e67edba7618a9139ed">compute</a>(lines_image, lines_grid, weights <span class="comment">/* , error_term */</span>);
<a name="l01080"></a>01080   vcl_cout &lt;&lt; <span class="stringliteral">&quot;Translation\n&quot;</span> &lt;&lt; H &lt;&lt; <span class="charliteral">&#39;\n&#39;</span>;
<a name="l01081"></a>01081 <span class="preprocessor">#if 0</span>
<a name="l01082"></a>01082 <span class="preprocessor"></span>  vcl_cout &lt;&lt; <span class="stringliteral">&quot;Error Term = &quot;</span> &lt;&lt; error_term &lt;&lt; <span class="stringliteral">&quot;\n\n&quot;</span>;
<a name="l01083"></a>01083 <span class="preprocessor">#endif</span>
<a name="l01084"></a>01084 <span class="preprocessor"></span>
<a name="l01085"></a>01085   <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l01086"></a>01086 }
<a name="l01087"></a>01087 
<a name="l01088"></a>01088 <span class="comment">//: The user will select the four corners of the grid in order to provide</span>
<a name="l01089"></a>01089 <span class="comment">//  a rough estimate of the homography, then grid lines will be used to</span>
<a name="l01090"></a>01090 <span class="comment">//  calculate a fine-tuned homography</span>
<a name="l01091"></a><a class="code" href="classsdet__grid__finder.html#a3d32565798a3c545fdc9edd52a55bc33">01091</a> <span class="keywordtype">bool</span> <a class="code" href="classsdet__grid__finder.html#a3d32565798a3c545fdc9edd52a55bc33" title="The user will select the four corners of the grid in order to provide.">sdet_grid_finder::compute_manual_homography</a>(<a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__smart__ptr.html">vsol_point_2d_sptr</a> ul,
<a name="l01092"></a>01092                                                  <a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__smart__ptr.html">vsol_point_2d_sptr</a> ur,
<a name="l01093"></a>01093                                                  <a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__smart__ptr.html">vsol_point_2d_sptr</a> lr,
<a name="l01094"></a>01094                                                  <a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__smart__ptr.html">vsol_point_2d_sptr</a> ll)
<a name="l01095"></a>01095 {
<a name="l01096"></a>01096   <span class="comment">// compute initial homography estimate based on manually picked points</span>
<a name="l01097"></a>01097   vcl_vector&lt;vgl_homg_point_2d&lt;double&gt; &gt; image_pts, grid_pts;
<a name="l01098"></a>01098   <span class="comment">// manually selected image points</span>
<a name="l01099"></a>01099   <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__point__2d.html">vgl_homg_point_2d&lt;double&gt;</a> im_ul(ul-&gt;x(), ul-&gt;y());
<a name="l01100"></a>01100   <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__point__2d.html">vgl_homg_point_2d&lt;double&gt;</a> im_ur(ur-&gt;x(), ur-&gt;y());
<a name="l01101"></a>01101   <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__point__2d.html">vgl_homg_point_2d&lt;double&gt;</a> im_lr(lr-&gt;x(), lr-&gt;y());
<a name="l01102"></a>01102   <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__point__2d.html">vgl_homg_point_2d&lt;double&gt;</a> im_ll(ll-&gt;x(), ll-&gt;y());
<a name="l01103"></a>01103   image_pts.push_back(im_ul);
<a name="l01104"></a>01104   image_pts.push_back(im_ur);
<a name="l01105"></a>01105   image_pts.push_back(im_lr);
<a name="l01106"></a>01106   image_pts.push_back(im_ll);
<a name="l01107"></a>01107   <span class="comment">// grid corners</span>
<a name="l01108"></a>01108   <span class="keywordtype">double</span> min_x = 0, min_y = 0;
<a name="l01109"></a>01109   <span class="keywordtype">double</span> max_x = (<a class="code" href="classsdet__grid__finder__params.html#a46958d023680a9c790b3af4155297bf5" title="number of horizontal grid lines">n_lines_x_</a> - 1) * <a class="code" href="classsdet__grid__finder__params.html#a68f253a0739973bf648cb8fada037c7f" title="spacing between lines">spacing_</a>;
<a name="l01110"></a>01110   <span class="keywordtype">double</span> max_y = (<a class="code" href="classsdet__grid__finder__params.html#a5f247d928fac91521ad77f20a81442c7" title="number of vertical grid lines">n_lines_y_</a> - 1) * <a class="code" href="classsdet__grid__finder__params.html#a68f253a0739973bf648cb8fada037c7f" title="spacing between lines">spacing_</a>;
<a name="l01111"></a>01111   <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__point__2d.html">vgl_homg_point_2d&lt;double&gt;</a> gr_ul(min_x, min_y);
<a name="l01112"></a>01112   <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__point__2d.html">vgl_homg_point_2d&lt;double&gt;</a> gr_ur(max_x, min_y);
<a name="l01113"></a>01113   <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__point__2d.html">vgl_homg_point_2d&lt;double&gt;</a> gr_lr(max_x, max_y);
<a name="l01114"></a>01114   <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__point__2d.html">vgl_homg_point_2d&lt;double&gt;</a> gr_ll(min_x, max_y);
<a name="l01115"></a>01115   grid_pts.push_back(gr_ul);
<a name="l01116"></a>01116   grid_pts.push_back(gr_ur);
<a name="l01117"></a>01117   grid_pts.push_back(gr_lr);
<a name="l01118"></a>01118   grid_pts.push_back(gr_ll);
<a name="l01119"></a>01119   <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__h__matrix__2d__compute__linear.html">vgl_h_matrix_2d_compute_linear</a> hcl;
<a name="l01120"></a>01120   <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__h__matrix__2d.html">vgl_h_matrix_2d&lt;double&gt;</a> H = hcl.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__h__matrix__2d__compute.html#a31168dffd34306e67edba7618a9139ed">compute</a>(image_pts, grid_pts);
<a name="l01121"></a>01121   vcl_cout &lt;&lt; <span class="stringliteral">&quot;initial homography estimate\n&quot;</span> &lt;&lt; H &lt;&lt; <span class="charliteral">&#39;\n&#39;</span>;
<a name="l01122"></a>01122   <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__h__matrix__2d.html">vgl_h_matrix_2d&lt;double&gt;</a> Hinv = H.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__h__matrix__2d.html#a54ecf67a21fc3a3dc03d4760c8958ded">get_inverse</a>();
<a name="l01123"></a>01123   vcl_cout &lt;&lt; <span class="stringliteral">&quot;initial homography estimate inverse\n&quot;</span> &lt;&lt; Hinv &lt;&lt; <span class="charliteral">&#39;\n&#39;</span>;
<a name="l01124"></a>01124 
<a name="l01125"></a>01125   <span class="comment">// associate image lines with grid lines and compute fine-tuned homography</span>
<a name="l01126"></a>01126   <span class="keywordtype">double</span> bound_x_min = min_x - 5;
<a name="l01127"></a>01127   <span class="keywordtype">double</span> bound_x_max = max_x + 5;
<a name="l01128"></a>01128   <span class="keywordtype">double</span> bound_y_min = min_y - 5;
<a name="l01129"></a>01129   <span class="keywordtype">double</span> bound_y_max = max_y + 5;
<a name="l01130"></a>01130   vcl_vector&lt;vgl_homg_line_2d&lt;double&gt; &gt; grid_lines, image_lines;
<a name="l01131"></a>01131   vcl_vector&lt;double&gt; weights;
<a name="l01132"></a>01132   <span class="keywordtype">double</span> length_sum = 0;
<a name="l01133"></a>01133 
<a name="l01134"></a>01134   <span class="keywordflow">for</span> (vcl_vector&lt;vsol_line_2d_sptr&gt;::const_iterator lit = <a class="code" href="classsdet__grid__finder.html#a608f15023fda070d4d78b4be814d761e">lines_</a>.begin();
<a name="l01135"></a>01135        lit != <a class="code" href="classsdet__grid__finder.html#a608f15023fda070d4d78b4be814d761e">lines_</a>.end(); lit++)
<a name="l01136"></a>01136   {
<a name="l01137"></a>01137     <span class="comment">// make sure line is correctly defined</span>
<a name="l01138"></a>01138     <span class="keywordflow">if</span> ( *((*lit)-&gt;p0()) == *((*lit)-&gt;p1()) )
<a name="l01139"></a>01139       <span class="keywordflow">continue</span>;
<a name="l01140"></a>01140 
<a name="l01141"></a>01141     <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__line__2d.html">vgl_homg_line_2d&lt;double&gt;</a> homgl = (*lit)-&gt;vgl_hline_2d();
<a name="l01142"></a>01142     homgl.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__line__2d.html#a9cface519ff2e18c6ebc9c4293bd41fa">normalize</a>();
<a name="l01143"></a>01143     <span class="comment">// use homography estimate to transform line</span>
<a name="l01144"></a>01144     <a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__smart__ptr.html">vsol_line_2d_sptr</a> tline = this-&gt;<a class="code" href="classsdet__grid__finder.html#a1e9152e3f3fb0e0d60823dde70616408" title="transform a vsol line by transforming the end points.">transform_line</a>(H,*lit);
<a name="l01145"></a>01145 
<a name="l01146"></a>01146 <span class="preprocessor">#ifdef USE_HTLINE // currently not active</span>
<a name="l01147"></a>01147 <span class="preprocessor"></span>    <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__line__2d.html">vgl_homg_line_2d&lt;double&gt;</a> htline = tline-&gt;vgl_hline_2d();
<a name="l01148"></a>01148     htline.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__line__2d.html#a9cface519ff2e18c6ebc9c4293bd41fa">normalize</a>();
<a name="l01149"></a>01149 <span class="preprocessor">#endif</span>
<a name="l01150"></a>01150 <span class="preprocessor"></span>    <span class="comment">// weed out lines not in bounding box of grid</span>
<a name="l01151"></a>01151     <span class="keywordflow">if</span> ( (tline-&gt;p0()-&gt;x() &gt; bound_x_max) || (tline-&gt;p0()-&gt;x() &lt; bound_x_min) ||
<a name="l01152"></a>01152          (tline-&gt;p0()-&gt;y() &gt; bound_y_max) || (tline-&gt;p0()-&gt;y() &lt; bound_y_min) ||
<a name="l01153"></a>01153          (tline-&gt;p1()-&gt;y() &gt; bound_x_max) || (tline-&gt;p1()-&gt;x() &lt; bound_x_min) ||
<a name="l01154"></a>01154          (tline-&gt;p1()-&gt;y() &gt; bound_y_max) || (tline-&gt;p1()-&gt;y() &lt; bound_y_min) )
<a name="l01155"></a>01155       <span class="keywordflow">continue</span>;
<a name="l01156"></a>01156     <span class="comment">// weed out lines not close to 0 or 90 degrees</span>
<a name="l01157"></a>01157     <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__2d.html">vgl_vector_2d&lt;double&gt;</a> direction = tline-&gt;direction();
<a name="l01158"></a>01158     <span class="comment">// normalize direction vector</span>
<a name="l01159"></a>01159     <span class="keywordtype">double</span> direction_len = direction.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__2d.html#aed47e3f5def159a13acc89f8182bf356">length</a>();
<a name="l01160"></a>01160     direction.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__2d.html#a44a3140f4d06bafdde0f5eb5fe9fedaa">set</a>(direction.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__2d.html#acc1b6069f02b8f8da2e1662f07abdd17">x</a>()/direction_len,
<a name="l01161"></a>01161                   direction.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__2d.html#a642daa8ef893f47ddf5d5c7f408efcda">y</a>()/direction_len);
<a name="l01162"></a>01162     <span class="keywordtype">double</span> max_orthog_component = 0.1;
<a name="l01163"></a>01163 
<a name="l01164"></a>01164     <span class="keywordflow">if</span> (vcl_fabs(direction.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__2d.html#a642daa8ef893f47ddf5d5c7f408efcda">y</a>()) &lt; max_orthog_component)
<a name="l01165"></a>01165     {
<a name="l01166"></a>01166       <span class="comment">// horizontal line</span>
<a name="l01167"></a>01167       <span class="comment">// find closest grid line</span>
<a name="l01168"></a>01168       <span class="keywordtype">double</span> <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/vgl__vector__2d_8h.html#a31c7db8164e71d411a1a821525102dc3">length</a> = (*lit)-&gt;length();
<a name="l01169"></a>01169 <span class="preprocessor">#ifdef USE_HTLINE // currently not active</span>
<a name="l01170"></a>01170 <span class="preprocessor"></span>      <span class="keywordtype">int</span> closest_line = <a class="codeRef" doxygen="core_vnl.tag:../../../../../core/vnl/html" href="../../../../../core/vnl/html/vnl__math_8h.html#aa8bc35f122f05f3d17e622ba80161361">vnl_math_rnd</a>(-htline.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__line__2d.html#a9fb1d3fe8edd8f30c8d190f721b160a6">c</a>() / <a class="code" href="classsdet__grid__finder__params.html#a68f253a0739973bf648cb8fada037c7f" title="spacing between lines">spacing_</a>);
<a name="l01171"></a>01171 <span class="preprocessor">#else</span>
<a name="l01172"></a>01172 <span class="preprocessor"></span>      <span class="keywordtype">int</span> closest_line = <a class="codeRef" doxygen="core_vnl.tag:../../../../../core/vnl/html" href="../../../../../core/vnl/html/vnl__math_8h.html#aa8bc35f122f05f3d17e622ba80161361">vnl_math_rnd</a>(tline-&gt;middle()-&gt;y() / <a class="code" href="classsdet__grid__finder__params.html#a68f253a0739973bf648cb8fada037c7f" title="spacing between lines">spacing_</a>);
<a name="l01173"></a>01173 <span class="preprocessor">#endif</span>
<a name="l01174"></a>01174 <span class="preprocessor"></span>      <span class="comment">// TODO: weed out lines not close enough to closest grid line</span>
<a name="l01175"></a>01175       <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__line__2d.html">vgl_homg_line_2d&lt;double&gt;</a> gl(0.0, 1.0, -<a class="code" href="classsdet__grid__finder__params.html#a68f253a0739973bf648cb8fada037c7f" title="spacing between lines">spacing_</a>*closest_line);
<a name="l01176"></a>01176       grid_lines.push_back(gl);
<a name="l01177"></a>01177       length_sum += length;
<a name="l01178"></a>01178       weights.push_back(length);
<a name="l01179"></a>01179       image_lines.push_back(homgl);
<a name="l01180"></a>01180       <span class="keywordflow">if</span> (<a class="code" href="classsdet__grid__finder__params.html#ac564d24cb4fcfd8407a8cf391faff9df" title="general purpose debug state">debug_state_</a>==<a class="code" href="classsdet__grid__finder__params.html#ad4baa1d37da291f4ed5f70ab8b279d05abc063922ae6fbdce87cff02c97711aa5">TRANS_PERIM_LINES</a>)
<a name="l01181"></a>01181         <a class="code" href="classsdet__grid__finder.html#aa9d28ec6718fcfab52eaa2eef52a9fdf">debug_lines_</a>.push_back(*lit);
<a name="l01182"></a>01182       <span class="keywordflow">if</span> (<a class="code" href="classsdet__grid__finder__params.html#ac564d24cb4fcfd8407a8cf391faff9df" title="general purpose debug state">debug_state_</a>==<a class="code" href="classsdet__grid__finder__params.html#ad4baa1d37da291f4ed5f70ab8b279d05ad805c9f461e322d4797fc0d26c73f143">AFFINE_GROUP_AFTER_TRANS</a>)
<a name="l01183"></a>01183         <a class="code" href="classsdet__grid__finder.html#aa9d28ec6718fcfab52eaa2eef52a9fdf">debug_lines_</a>.push_back(tline);
<a name="l01184"></a>01184     }
<a name="l01185"></a>01185     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (vcl_fabs(direction.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__2d.html#acc1b6069f02b8f8da2e1662f07abdd17">x</a>()) &lt; max_orthog_component)
<a name="l01186"></a>01186     {
<a name="l01187"></a>01187       <span class="comment">// vertical line</span>
<a name="l01188"></a>01188       <span class="comment">// find closest grid line</span>
<a name="l01189"></a>01189       <span class="keywordtype">double</span> <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/vgl__vector__2d_8h.html#a31c7db8164e71d411a1a821525102dc3">length</a> = (*lit)-&gt;length();
<a name="l01190"></a>01190       <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__line__2d.html">vgl_homg_line_2d&lt;double&gt;</a> homgl = (*lit)-&gt;vgl_hline_2d();
<a name="l01191"></a>01191       homgl.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__line__2d.html#a9cface519ff2e18c6ebc9c4293bd41fa">normalize</a>();
<a name="l01192"></a>01192 <span class="preprocessor">#ifdef USE_HTLINE // currently not active</span>
<a name="l01193"></a>01193 <span class="preprocessor"></span>      <span class="keywordtype">int</span> closest_line = <a class="codeRef" doxygen="core_vnl.tag:../../../../../core/vnl/html" href="../../../../../core/vnl/html/vnl__math_8h.html#aa8bc35f122f05f3d17e622ba80161361">vnl_math_rnd</a>(-htline.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__line__2d.html#a9fb1d3fe8edd8f30c8d190f721b160a6">c</a>() / <a class="code" href="classsdet__grid__finder__params.html#a68f253a0739973bf648cb8fada037c7f" title="spacing between lines">spacing_</a>);
<a name="l01194"></a>01194 <span class="preprocessor">#else</span>
<a name="l01195"></a>01195 <span class="preprocessor"></span>      <span class="keywordtype">int</span> closest_line = <a class="codeRef" doxygen="core_vnl.tag:../../../../../core/vnl/html" href="../../../../../core/vnl/html/vnl__math_8h.html#aa8bc35f122f05f3d17e622ba80161361">vnl_math_rnd</a>(tline-&gt;middle()-&gt;x() / <a class="code" href="classsdet__grid__finder__params.html#a68f253a0739973bf648cb8fada037c7f" title="spacing between lines">spacing_</a>);
<a name="l01196"></a>01196 <span class="preprocessor">#endif</span>
<a name="l01197"></a>01197 <span class="preprocessor"></span>      <span class="comment">// TODO: weed out lines not close enough to closest grid line</span>
<a name="l01198"></a>01198       <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__line__2d.html">vgl_homg_line_2d&lt;double&gt;</a> gl(1.0, 0.0, -<a class="code" href="classsdet__grid__finder__params.html#a68f253a0739973bf648cb8fada037c7f" title="spacing between lines">spacing_</a>*closest_line);
<a name="l01199"></a>01199       grid_lines.push_back(gl);
<a name="l01200"></a>01200       length_sum += length;
<a name="l01201"></a>01201       weights.push_back(length);
<a name="l01202"></a>01202       image_lines.push_back(homgl);
<a name="l01203"></a>01203       <span class="keywordflow">if</span> (<a class="code" href="classsdet__grid__finder__params.html#ac564d24cb4fcfd8407a8cf391faff9df" title="general purpose debug state">debug_state_</a>==<a class="code" href="classsdet__grid__finder__params.html#ad4baa1d37da291f4ed5f70ab8b279d05abc063922ae6fbdce87cff02c97711aa5">TRANS_PERIM_LINES</a>)
<a name="l01204"></a>01204         <a class="code" href="classsdet__grid__finder.html#aa9d28ec6718fcfab52eaa2eef52a9fdf">debug_lines_</a>.push_back(*lit);
<a name="l01205"></a>01205       <span class="keywordflow">if</span> (<a class="code" href="classsdet__grid__finder__params.html#ac564d24cb4fcfd8407a8cf391faff9df" title="general purpose debug state">debug_state_</a>==<a class="code" href="classsdet__grid__finder__params.html#ad4baa1d37da291f4ed5f70ab8b279d05ad805c9f461e322d4797fc0d26c73f143">AFFINE_GROUP_AFTER_TRANS</a>)
<a name="l01206"></a>01206         <a class="code" href="classsdet__grid__finder.html#aa9d28ec6718fcfab52eaa2eef52a9fdf">debug_lines_</a>.push_back(tline);
<a name="l01207"></a>01207     }
<a name="l01208"></a>01208   }
<a name="l01209"></a>01209   <span class="keywordflow">if</span> (length_sum)
<a name="l01210"></a>01210     <span class="keywordflow">for</span> (vcl_vector&lt;double&gt;::iterator wit = weights.begin();
<a name="l01211"></a>01211          wit != weights.end(); wit++)
<a name="l01212"></a>01212       (*wit)/=length_sum;
<a name="l01213"></a>01213 
<a name="l01214"></a>01214 <span class="preprocessor">#if 0</span>
<a name="l01215"></a>01215 <span class="preprocessor"></span>  <span class="keywordtype">double</span> error_term = -1;
<a name="l01216"></a>01216 <span class="preprocessor">#endif</span>
<a name="l01217"></a>01217 <span class="preprocessor"></span>  H = hcl.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__h__matrix__2d__compute.html#a31168dffd34306e67edba7618a9139ed">compute</a>(image_lines, grid_lines, weights <span class="comment">/*, error_term */</span>);
<a name="l01218"></a>01218   vcl_cout &lt;&lt; <span class="stringliteral">&quot;fine tuned homography\n&quot;</span> &lt;&lt; H &lt;&lt; <span class="charliteral">&#39;\n&#39;</span>;
<a name="l01219"></a>01219   Hinv = H.get_inverse();
<a name="l01220"></a>01220   vcl_cout &lt;&lt; <span class="stringliteral">&quot;inverse H =\n&quot;</span> &lt;&lt; Hinv &lt;&lt; <span class="charliteral">&#39;\n&#39;</span>;
<a name="l01221"></a>01221 <span class="preprocessor">#if 0</span>
<a name="l01222"></a>01222 <span class="preprocessor"></span>  vcl_cout &lt;&lt; <span class="stringliteral">&quot;Error Term = &quot;</span> &lt;&lt; error_term &lt;&lt; <span class="stringliteral">&quot;\n\n&quot;</span>;
<a name="l01223"></a>01223 <span class="preprocessor">#endif</span>
<a name="l01224"></a>01224 <span class="preprocessor"></span>
<a name="l01225"></a>01225   <a class="code" href="classsdet__grid__finder.html#a4ece8008f9422b907ec3ffa291571bda">homography_</a> = H;
<a name="l01226"></a>01226 
<a name="l01227"></a>01227   <a class="code" href="classsdet__grid__finder.html#aaa6f3265f9273ea468a69cd33c9906ea">homography_valid_</a> = <span class="keyword">true</span>;
<a name="l01228"></a>01228 
<a name="l01229"></a>01229   <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l01230"></a>01230 }
<a name="l01231"></a>01231 
<a name="l01232"></a><a class="code" href="classsdet__grid__finder.html#aaaa5be89df9b98d73942631f7d027358">01232</a> <span class="keywordtype">bool</span> <a class="code" href="classsdet__grid__finder.html#aaaa5be89df9b98d73942631f7d027358">sdet_grid_finder::compute_homography</a>()
<a name="l01233"></a>01233 {
<a name="l01234"></a>01234   <span class="keyword">static</span> <span class="keywordtype">int</span> framenum = 0;
<a name="l01235"></a>01235   vcl_cout &lt;&lt; <span class="stringliteral">&quot;framenum = &quot;</span>&lt;&lt;framenum++&lt;&lt;<span class="charliteral">&#39;\n&#39;</span>;
<a name="l01236"></a>01236 
<a name="l01237"></a>01237   <span class="keywordflow">if</span> (!this-&gt;<a class="code" href="classsdet__grid__finder.html#a52a72012dbda86415be3a9a4aee6fe3a" title="Compute a projective homography that sends the two major group vanishing points to the x and y direct...">compute_projective_homography</a>())
<a name="l01238"></a>01238   {
<a name="l01239"></a>01239     vcl_cout &lt;&lt; <span class="stringliteral">&quot;In sdet_grid_finder::compute_homography() -&quot;</span>
<a name="l01240"></a>01240              &lt;&lt; <span class="stringliteral">&quot; projective homography failed\n&quot;</span>;
<a name="l01241"></a>01241     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01242"></a>01242   }
<a name="l01243"></a>01243 
<a name="l01244"></a>01244   <span class="keywordflow">if</span> (!this-&gt;<a class="code" href="classsdet__grid__finder.html#a8d34869604adf73e0cfd85029b282944">compute_affine_homography</a>())
<a name="l01245"></a>01245   {
<a name="l01246"></a>01246     vcl_cout &lt;&lt; <span class="stringliteral">&quot;In sdet_grid_finder::compute_homography() -&quot;</span>
<a name="l01247"></a>01247              &lt;&lt; <span class="stringliteral">&quot; affine homography failed\n&quot;</span>;
<a name="l01248"></a>01248     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01249"></a>01249   }
<a name="l01250"></a>01250 
<a name="l01251"></a>01251   <a class="code" href="classsdet__grid__finder.html#a4ece8008f9422b907ec3ffa291571bda">homography_</a> = <a class="code" href="classsdet__grid__finder.html#af8ffa23de41ab9c460c00acfe9967270">affine_homography_</a>*<a class="code" href="classsdet__grid__finder.html#a5e7bf51b6a873f81167e28cd5c9626d6">projective_homography_</a>;
<a name="l01252"></a>01252 
<a name="l01253"></a>01253   <span class="keywordflow">if</span> (<a class="code" href="classsdet__grid__finder__params.html#add98f5848c934edf71a214b9500c590a" title="print informative debug output">verbose_</a>)
<a name="l01254"></a>01254   {
<a name="l01255"></a>01255     vcl_cout &lt;&lt; <span class="stringliteral">&quot;The composite homography\n&quot;</span> &lt;&lt; <a class="code" href="classsdet__grid__finder.html#a4ece8008f9422b907ec3ffa291571bda">homography_</a> &lt;&lt; <span class="charliteral">&#39;\n&#39;</span>;
<a name="l01256"></a>01256   }
<a name="l01257"></a>01257 
<a name="l01258"></a>01258   <span class="keywordtype">double</span> det = <a class="codeRef" doxygen="core_vnl.tag:../../../../../core/vnl/html" href="../../../../../core/vnl/html/vnl__det_8h.html#ab693288bff9c1685706df581182be4eb">vnl_det</a>(<a class="code" href="classsdet__grid__finder.html#a4ece8008f9422b907ec3ffa291571bda">homography_</a>.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__h__matrix__2d.html#a933552b4244b0c82adbe4fc498ea8690">get_matrix</a>());
<a name="l01259"></a>01259   <span class="keywordflow">if</span> (det != 0.0)
<a name="l01260"></a>01260     <a class="code" href="classsdet__grid__finder.html#aaa6f3265f9273ea468a69cd33c9906ea">homography_valid_</a> = <span class="keyword">true</span>;
<a name="l01261"></a>01261 
<a name="l01262"></a>01262   <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l01263"></a>01263 }
<a name="l01264"></a>01264 
<a name="l01265"></a>01265 <span class="comment">//------------------------------------------------------------------------</span>
<a name="l01266"></a>01266 <span class="comment">//: Transform a vsol line using the point transform</span>
<a name="l01267"></a>01267 <span class="comment">//</span>
<a name="l01268"></a>01268 <a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__smart__ptr.html">vsol_line_2d_sptr</a>
<a name="l01269"></a><a class="code" href="classsdet__grid__finder.html#a1e9152e3f3fb0e0d60823dde70616408">01269</a> <a class="code" href="classsdet__grid__finder.html#a1e9152e3f3fb0e0d60823dde70616408" title="transform a vsol line by transforming the end points.">sdet_grid_finder::transform_line</a>(<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__h__matrix__2d.html">vgl_h_matrix_2d&lt;double&gt;</a> <span class="keyword">const</span>&amp; h,
<a name="l01270"></a>01270                                  <a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__smart__ptr.html">vsol_line_2d_sptr</a> <span class="keyword">const</span> &amp; l)
<a name="l01271"></a>01271 {
<a name="l01272"></a>01272   <a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__smart__ptr.html">vsol_point_2d_sptr</a> p0 = l-&gt;p0();
<a name="l01273"></a>01273   <a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__smart__ptr.html">vsol_point_2d_sptr</a> p1 = l-&gt;p1();
<a name="l01274"></a>01274   <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__point__2d.html">vgl_homg_point_2d&lt;double&gt;</a> vp0(p0-&gt;x(), p0-&gt;y());
<a name="l01275"></a>01275   <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__point__2d.html">vgl_homg_point_2d&lt;double&gt;</a> vp1(p1-&gt;x(), p1-&gt;y());
<a name="l01276"></a>01276   <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__point__2d.html">vgl_point_2d&lt;double&gt;</a> tvp0 = h(vp0);
<a name="l01277"></a>01277   <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__point__2d.html">vgl_point_2d&lt;double&gt;</a> tvp1 = h(vp1);
<a name="l01278"></a>01278   <a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__smart__ptr.html">vsol_point_2d_sptr</a> tp0 = <span class="keyword">new</span> <a class="codeRef" doxygen="contrib_gel_vsol.tag:../../../../../contrib/gel/vsol/html" href="../../../../../contrib/gel/vsol/html/classvsol__point__2d.html">vsol_point_2d</a>(tvp0.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__point__2d.html#a1d928ee2aae43e7cc7bec7e2db2ad989">x</a>(), tvp0.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__point__2d.html#a098f0121fa0b75d2f4171d00a1bf7f31">y</a>());
<a name="l01279"></a>01279   <a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__smart__ptr.html">vsol_point_2d_sptr</a> tp1 = <span class="keyword">new</span> <a class="codeRef" doxygen="contrib_gel_vsol.tag:../../../../../contrib/gel/vsol/html" href="../../../../../contrib/gel/vsol/html/classvsol__point__2d.html">vsol_point_2d</a>(tvp1.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__point__2d.html#a3d0455536dcb130f284c3eeaba1ae960">x</a>(), tvp1.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__point__2d.html#a25dfe52017f7614103d028639125ff91">y</a>());
<a name="l01280"></a>01280   <span class="keywordflow">return</span> <span class="keyword">new</span> <a class="codeRef" doxygen="contrib_gel_vsol.tag:../../../../../contrib/gel/vsol/html" href="../../../../../contrib/gel/vsol/html/classvsol__line__2d.html">vsol_line_2d</a>(tp0, tp1);
<a name="l01281"></a>01281 }
<a name="l01282"></a>01282 
<a name="l01283"></a>01283 <span class="keywordtype">bool</span>
<a name="l01284"></a><a class="code" href="classsdet__grid__finder.html#a925842e3329fc3ed2c87728f0202515a">01284</a> <a class="code" href="classsdet__grid__finder.html#a925842e3329fc3ed2c87728f0202515a">sdet_grid_finder::get_affine_lines</a>(vcl_vector&lt;vsol_line_2d_sptr&gt; &amp; lines)
<a name="l01285"></a>01285 {
<a name="l01286"></a>01286   lines = <a class="code" href="classsdet__grid__finder.html#af8741f73fabae9955adedb5a086e7333">display_lines_</a>;
<a name="l01287"></a>01287   <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l01288"></a>01288 }
<a name="l01289"></a>01289 
<a name="l01290"></a>01290 <span class="keywordtype">bool</span>
<a name="l01291"></a><a class="code" href="classsdet__grid__finder.html#aaf69f33bb8cc68acc1e213c8e8b71c7d">01291</a> <a class="code" href="classsdet__grid__finder.html#aaf69f33bb8cc68acc1e213c8e8b71c7d" title="get all grid corner points, in column-major order.">sdet_grid_finder::get_grid_points</a>(vcl_vector&lt;double&gt; &amp;image_x, vcl_vector&lt;double&gt; &amp;image_y)
<a name="l01292"></a>01292 {
<a name="l01293"></a>01293   <span class="keywordflow">if</span> (!<a class="code" href="classsdet__grid__finder.html#aaa6f3265f9273ea468a69cd33c9906ea">homography_valid_</a>)
<a name="l01294"></a>01294     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01295"></a>01295 
<a name="l01296"></a>01296   <span class="comment">// grid points are stored in image_x_ and image_y_ here, in</span>
<a name="l01297"></a>01297   <span class="comment">// anticipation of being used elsewhere by this class</span>
<a name="l01298"></a>01298 
<a name="l01299"></a>01299   image_x.clear();
<a name="l01300"></a>01300   image_y.clear();
<a name="l01301"></a>01301   <a class="code" href="classsdet__grid__finder.html#a2646a1942bcd8a42d4b42dd7fa98b8ae" title="grid corner point coordinates in the image.">image_x_</a>.clear();
<a name="l01302"></a>01302   <a class="code" href="classsdet__grid__finder.html#a644839d0c1d3d5dbf24be3a8ef9940f2">image_y_</a>.clear();
<a name="l01303"></a>01303   <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__h__matrix__2d.html">vgl_h_matrix_2d&lt;double&gt;</a> grid_to_image = <a class="code" href="classsdet__grid__finder.html#a4ece8008f9422b907ec3ffa291571bda">homography_</a>.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__h__matrix__2d.html#a54ecf67a21fc3a3dc03d4760c8958ded">get_inverse</a>();
<a name="l01304"></a>01304 
<a name="l01305"></a>01305   <span class="comment">// x/y mismatch ok - see comment in sdet_grid_finder_params.h</span>
<a name="l01306"></a>01306   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> x = 0; x &lt; <a class="code" href="classsdet__grid__finder__params.html#a5f247d928fac91521ad77f20a81442c7" title="number of vertical grid lines">n_lines_y_</a>; x++)
<a name="l01307"></a>01307   {
<a name="l01308"></a>01308     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> y = 0; y &lt; <a class="code" href="classsdet__grid__finder__params.html#a46958d023680a9c790b3af4155297bf5" title="number of horizontal grid lines">n_lines_x_</a>; y++)
<a name="l01309"></a>01309     {
<a name="l01310"></a>01310       <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__point__2d.html">vgl_homg_point_2d&lt;double&gt;</a> hp(x*<a class="code" href="classsdet__grid__finder__params.html#a68f253a0739973bf648cb8fada037c7f" title="spacing between lines">spacing_</a>, y*spacing_);
<a name="l01311"></a>01311       <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__point__2d.html">vgl_homg_point_2d&lt;double&gt;</a> thp = grid_to_image(hp);
<a name="l01312"></a>01312       <span class="keywordtype">double</span> imgx = thp.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__point__2d.html#a1d928ee2aae43e7cc7bec7e2db2ad989">x</a>() / thp.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__point__2d.html#ab452fbf6dec9591ff07c0ebb7b05f1e1">w</a>();
<a name="l01313"></a>01313       <span class="keywordtype">double</span> imgy = thp.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__point__2d.html#a098f0121fa0b75d2f4171d00a1bf7f31">y</a>() / thp.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__point__2d.html#ab452fbf6dec9591ff07c0ebb7b05f1e1">w</a>();
<a name="l01314"></a>01314       <a class="code" href="classsdet__grid__finder.html#a2646a1942bcd8a42d4b42dd7fa98b8ae" title="grid corner point coordinates in the image.">image_x_</a>.push_back(imgx);
<a name="l01315"></a>01315       <a class="code" href="classsdet__grid__finder.html#a644839d0c1d3d5dbf24be3a8ef9940f2">image_y_</a>.push_back(imgy);
<a name="l01316"></a>01316     }
<a name="l01317"></a>01317   }
<a name="l01318"></a>01318   image_x = <a class="code" href="classsdet__grid__finder.html#a2646a1942bcd8a42d4b42dd7fa98b8ae" title="grid corner point coordinates in the image.">image_x_</a>;
<a name="l01319"></a>01319   image_y = <a class="code" href="classsdet__grid__finder.html#a644839d0c1d3d5dbf24be3a8ef9940f2">image_y_</a>;
<a name="l01320"></a>01320   <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l01321"></a>01321 }
<a name="l01322"></a>01322 
<a name="l01323"></a>01323 <span class="keywordtype">bool</span>
<a name="l01324"></a><a class="code" href="classsdet__grid__finder.html#a572f48681410b22e7f889bef260399c6">01324</a> <a class="code" href="classsdet__grid__finder.html#a572f48681410b22e7f889bef260399c6">sdet_grid_finder::get_debug_lines</a>(vcl_vector&lt;vsol_line_2d_sptr&gt; &amp; lines)
<a name="l01325"></a>01325 {
<a name="l01326"></a>01326   lines.clear();
<a name="l01327"></a>01327   lines = <a class="code" href="classsdet__grid__finder.html#aa9d28ec6718fcfab52eaa2eef52a9fdf">debug_lines_</a>;
<a name="l01328"></a>01328   <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l01329"></a>01329 }
<a name="l01330"></a>01330 
<a name="l01331"></a>01331 <span class="keywordtype">bool</span>
<a name="l01332"></a><a class="code" href="classsdet__grid__finder.html#ab33f3004db4041a991819931648a0c92">01332</a> <a class="code" href="classsdet__grid__finder.html#ab33f3004db4041a991819931648a0c92">sdet_grid_finder::get_debug_grid_lines</a>(vcl_vector&lt;vsol_line_2d_sptr&gt; &amp; lines)
<a name="l01333"></a>01333 {
<a name="l01334"></a>01334   lines.clear();
<a name="l01335"></a>01335   lines = <a class="code" href="classsdet__grid__finder.html#a433d404aac637bbba94656ecec0f5e47">debug_grid_lines_</a>;
<a name="l01336"></a>01336   <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l01337"></a>01337 }
<a name="l01338"></a>01338 
<a name="l01339"></a>01339 <span class="keywordtype">bool</span>
<a name="l01340"></a><a class="code" href="classsdet__grid__finder.html#a48945d056e1f4f649f1a589c31178081">01340</a> <a class="code" href="classsdet__grid__finder.html#a48945d056e1f4f649f1a589c31178081">sdet_grid_finder::get_matched_lines</a>(vcl_vector&lt;vsol_line_2d_sptr&gt; &amp; lines)
<a name="l01341"></a>01341 {
<a name="l01342"></a>01342   lines = <a class="code" href="classsdet__grid__finder.html#ade4391e462f73ecad1afe151d2e2667a">matched_lines_</a>;
<a name="l01343"></a>01343   <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l01344"></a>01344 }
<a name="l01345"></a>01345 
<a name="l01346"></a>01346 <span class="comment">//-------------------------------------------------------------------------</span>
<a name="l01347"></a>01347 <span class="comment">//: Get the original set of lines mapped by the line homography</span>
<a name="l01348"></a>01348 <span class="comment">//</span>
<a name="l01349"></a>01349 <span class="keywordtype">bool</span>
<a name="l01350"></a><a class="code" href="classsdet__grid__finder.html#a88909d1a3a1d0941c66320c936b3a221">01350</a> <a class="code" href="classsdet__grid__finder.html#a88909d1a3a1d0941c66320c936b3a221" title="Get the original set of lines mapped by the line homography.">sdet_grid_finder::get_mapped_lines</a>(vcl_vector&lt;vsol_line_2d_sptr&gt; &amp; lines)
<a name="l01351"></a>01351 {
<a name="l01352"></a>01352   <span class="keywordflow">if</span> (!<a class="code" href="classsdet__grid__finder.html#aaa6f3265f9273ea468a69cd33c9906ea">homography_valid_</a>)
<a name="l01353"></a>01353     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01354"></a>01354   lines.clear();
<a name="l01355"></a>01355   <span class="keywordflow">for</span> (vcl_vector&lt;vsol_line_2d_sptr&gt;::iterator lit = <a class="code" href="classsdet__grid__finder.html#a608f15023fda070d4d78b4be814d761e">lines_</a>.begin();
<a name="l01356"></a>01356        lit != <a class="code" href="classsdet__grid__finder.html#a608f15023fda070d4d78b4be814d761e">lines_</a>.end(); lit++)
<a name="l01357"></a>01357   {
<a name="l01358"></a>01358     <a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__smart__ptr.html">vsol_line_2d_sptr</a> l = this-&gt;<a class="code" href="classsdet__grid__finder.html#a1e9152e3f3fb0e0d60823dde70616408" title="transform a vsol line by transforming the end points.">transform_line</a>(<a class="code" href="classsdet__grid__finder.html#a4ece8008f9422b907ec3ffa291571bda">homography_</a>,*lit);
<a name="l01359"></a>01359     lines.push_back(l);
<a name="l01360"></a>01360   }
<a name="l01361"></a>01361   <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l01362"></a>01362 }
<a name="l01363"></a>01363 
<a name="l01364"></a>01364 
<a name="l01365"></a>01365 <span class="comment">//-------------------------------------------------------------------------</span>
<a name="l01366"></a>01366 <span class="comment">//: Get the grid lines mapped back onto the image</span>
<a name="l01367"></a>01367 <span class="comment">//</span>
<a name="l01368"></a>01368 <span class="keywordtype">bool</span>
<a name="l01369"></a><a class="code" href="classsdet__grid__finder.html#aa30ba34efafeb9ef91d5bc62b669adc3">01369</a> <a class="code" href="classsdet__grid__finder.html#aa30ba34efafeb9ef91d5bc62b669adc3" title="Get the grid lines mapped back onto the image.">sdet_grid_finder::get_backprojected_grid</a>(vcl_vector&lt;vsol_line_2d_sptr&gt; &amp; lines)
<a name="l01370"></a>01370 {
<a name="l01371"></a>01371   <span class="keywordflow">if</span> (!<a class="code" href="classsdet__grid__finder.html#aaa6f3265f9273ea468a69cd33c9906ea">homography_valid_</a>)
<a name="l01372"></a>01372     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01373"></a>01373 
<a name="l01374"></a>01374   lines.clear();
<a name="l01375"></a>01375   <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__h__matrix__2d.html">vgl_h_matrix_2d&lt;double&gt;</a> grid_to_image = <a class="code" href="classsdet__grid__finder.html#a4ece8008f9422b907ec3ffa291571bda">homography_</a>.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__h__matrix__2d.html#a54ecf67a21fc3a3dc03d4760c8958ded">get_inverse</a>();
<a name="l01376"></a>01376 
<a name="l01377"></a>01377   <span class="comment">// transform the vertical grid lines back to the image</span>
<a name="l01378"></a>01378   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> y = 0; y&lt;<a class="code" href="classsdet__grid__finder__params.html#a5f247d928fac91521ad77f20a81442c7" title="number of vertical grid lines">n_lines_y_</a>; y++)
<a name="l01379"></a>01379   {
<a name="l01380"></a>01380     <span class="keywordtype">double</span> xv = y*<a class="code" href="classsdet__grid__finder__params.html#a68f253a0739973bf648cb8fada037c7f" title="spacing between lines">spacing_</a>, maxy = (<a class="code" href="classsdet__grid__finder__params.html#a46958d023680a9c790b3af4155297bf5" title="number of horizontal grid lines">n_lines_x_</a>-1)*spacing_;
<a name="l01381"></a>01381     <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__point__2d.html">vgl_homg_point_2d&lt;double&gt;</a> p0(xv,0), p1(xv, maxy);
<a name="l01382"></a>01382     <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__point__2d.html">vgl_homg_point_2d&lt;double&gt;</a> tp0, tp1;
<a name="l01383"></a>01383     tp0 = grid_to_image(p0);  tp1 = grid_to_image(p1);
<a name="l01384"></a>01384     <a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__smart__ptr.html">vsol_point_2d_sptr</a> sp0 = <span class="keyword">new</span> <a class="codeRef" doxygen="contrib_gel_vsol.tag:../../../../../contrib/gel/vsol/html" href="../../../../../contrib/gel/vsol/html/classvsol__point__2d.html">vsol_point_2d</a>(tp0);
<a name="l01385"></a>01385     <a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__smart__ptr.html">vsol_point_2d_sptr</a> sp1 = <span class="keyword">new</span> <a class="codeRef" doxygen="contrib_gel_vsol.tag:../../../../../contrib/gel/vsol/html" href="../../../../../contrib/gel/vsol/html/classvsol__point__2d.html">vsol_point_2d</a>(tp1);
<a name="l01386"></a>01386     <a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__smart__ptr.html">vsol_line_2d_sptr</a> lv= <span class="keyword">new</span> <a class="codeRef" doxygen="contrib_gel_vsol.tag:../../../../../contrib/gel/vsol/html" href="../../../../../contrib/gel/vsol/html/classvsol__line__2d.html">vsol_line_2d</a>(sp0, sp1);
<a name="l01387"></a>01387     lines.push_back(lv);
<a name="l01388"></a>01388   }
<a name="l01389"></a>01389   <span class="comment">// transform the horizontal grid lines back to the image</span>
<a name="l01390"></a>01390   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> x = 0; x&lt;<a class="code" href="classsdet__grid__finder__params.html#a46958d023680a9c790b3af4155297bf5" title="number of horizontal grid lines">n_lines_x_</a>; x++)
<a name="l01391"></a>01391   {
<a name="l01392"></a>01392     <span class="keywordtype">double</span> yv = x*<a class="code" href="classsdet__grid__finder__params.html#a68f253a0739973bf648cb8fada037c7f" title="spacing between lines">spacing_</a>, maxx = (n_lines_y_-1)*spacing_;
<a name="l01393"></a>01393     <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__point__2d.html">vgl_homg_point_2d&lt;double&gt;</a> p0(0,yv), p1(maxx, yv);
<a name="l01394"></a>01394     <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__point__2d.html">vgl_homg_point_2d&lt;double&gt;</a> tp0, tp1;
<a name="l01395"></a>01395     tp0 = grid_to_image(p0);  tp1 = grid_to_image(p1);
<a name="l01396"></a>01396     <a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__smart__ptr.html">vsol_point_2d_sptr</a> sp0 = <span class="keyword">new</span> <a class="codeRef" doxygen="contrib_gel_vsol.tag:../../../../../contrib/gel/vsol/html" href="../../../../../contrib/gel/vsol/html/classvsol__point__2d.html">vsol_point_2d</a>(tp0);
<a name="l01397"></a>01397     <a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__smart__ptr.html">vsol_point_2d_sptr</a> sp1 = <span class="keyword">new</span> <a class="codeRef" doxygen="contrib_gel_vsol.tag:../../../../../contrib/gel/vsol/html" href="../../../../../contrib/gel/vsol/html/classvsol__point__2d.html">vsol_point_2d</a>(tp1);
<a name="l01398"></a>01398     <a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__smart__ptr.html">vsol_line_2d_sptr</a> lv = <span class="keyword">new</span> <a class="codeRef" doxygen="contrib_gel_vsol.tag:../../../../../contrib/gel/vsol/html" href="../../../../../contrib/gel/vsol/html/classvsol__line__2d.html">vsol_line_2d</a>(sp0, sp1);
<a name="l01399"></a>01399     lines.push_back(lv);
<a name="l01400"></a>01400   }
<a name="l01401"></a>01401 <span class="preprocessor">#ifdef DEBUG</span>
<a name="l01402"></a>01402 <span class="preprocessor"></span>  <span class="comment">// temp for kongbin -DEC</span>
<a name="l01403"></a>01403    <a class="code" href="classsdet__grid__finder.html#a0b8b6cff7cbf7f734d6cd67e666f693f" title="append the output file with points calculated using homography_.">write_image_points</a>(grid_to_image);
<a name="l01404"></a>01404 <span class="preprocessor">#endif</span>
<a name="l01405"></a>01405 <span class="preprocessor"></span>
<a name="l01406"></a>01406   <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l01407"></a>01407 }
<a name="l01408"></a>01408 
<a name="l01409"></a>01409 <span class="comment">//: initialize and output file. The file will be in the format taken by</span>
<a name="l01410"></a>01410 <span class="comment">//  the zhang calibration routine located in bmvl/bcal</span>
<a name="l01411"></a><a class="code" href="classsdet__grid__finder.html#a74cc25f92d01b0363c16f5a8898ef7fc">01411</a> <span class="keywordtype">bool</span> <a class="code" href="classsdet__grid__finder.html#a74cc25f92d01b0363c16f5a8898ef7fc" title="write transformed grid points to a file.">sdet_grid_finder::init_output_file</a>(vcl_ofstream &amp; outstream)
<a name="l01412"></a>01412 {
<a name="l01413"></a>01413   outstream &lt;&lt; (<a class="code" href="classsdet__grid__finder__params.html#a46958d023680a9c790b3af4155297bf5" title="number of horizontal grid lines">n_lines_x_</a>*<a class="code" href="classsdet__grid__finder__params.html#a5f247d928fac91521ad77f20a81442c7" title="number of vertical grid lines">n_lines_y_</a>) &lt;&lt; <span class="charliteral">&#39;\n&#39;</span>;
<a name="l01414"></a>01414   <span class="comment">// x/y mismatch ok - see comment in sdet_grid_finder_params.h</span>
<a name="l01415"></a>01415   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> x = 0; x &lt; <a class="code" href="classsdet__grid__finder__params.html#a5f247d928fac91521ad77f20a81442c7" title="number of vertical grid lines">n_lines_y_</a>; x++)
<a name="l01416"></a>01416   {
<a name="l01417"></a>01417     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> y = 0; y &lt; <a class="code" href="classsdet__grid__finder__params.html#a46958d023680a9c790b3af4155297bf5" title="number of horizontal grid lines">n_lines_x_</a>; y++)
<a name="l01418"></a>01418     {
<a name="l01419"></a>01419       outstream &lt;&lt; x*<a class="code" href="classsdet__grid__finder__params.html#a68f253a0739973bf648cb8fada037c7f" title="spacing between lines">spacing_</a>&lt;&lt;<span class="charliteral">&#39; &#39;</span>&lt;&lt;y*<a class="code" href="classsdet__grid__finder__params.html#a68f253a0739973bf648cb8fada037c7f" title="spacing between lines">spacing_</a>&lt;&lt;<span class="charliteral">&#39;\n&#39;</span>;
<a name="l01420"></a>01420     }
<a name="l01421"></a>01421   }
<a name="l01422"></a>01422   outstream &lt;&lt; <span class="stringliteral">&quot;NUM_VIEWS_PLACEHOLDER\n&quot;</span>;
<a name="l01423"></a>01423   <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l01424"></a>01424 }
<a name="l01425"></a>01425 
<a name="l01426"></a>01426 <span class="comment">//: append the output file with points calculated using homography_</span>
<a name="l01427"></a><a class="code" href="classsdet__grid__finder.html#a0b8b6cff7cbf7f734d6cd67e666f693f">01427</a> <span class="keywordtype">bool</span> <a class="code" href="classsdet__grid__finder.html#a0b8b6cff7cbf7f734d6cd67e666f693f" title="append the output file with points calculated using homography_.">sdet_grid_finder::write_image_points</a>(vcl_ofstream &amp; outstream)
<a name="l01428"></a>01428 {
<a name="l01429"></a>01429   <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__h__matrix__2d.html">vgl_h_matrix_2d&lt;double&gt;</a> grid_to_image = <a class="code" href="classsdet__grid__finder.html#a4ece8008f9422b907ec3ffa291571bda">homography_</a>.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__h__matrix__2d.html#a54ecf67a21fc3a3dc03d4760c8958ded">get_inverse</a>();
<a name="l01430"></a>01430 
<a name="l01431"></a>01431   <span class="comment">// x/y mismatch ok - see comment in sdet_grid_finder_params.h</span>
<a name="l01432"></a>01432   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> x=0; x&lt;<a class="code" href="classsdet__grid__finder__params.html#a5f247d928fac91521ad77f20a81442c7" title="number of vertical grid lines">n_lines_y_</a>; x++)
<a name="l01433"></a>01433   {
<a name="l01434"></a>01434     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> y=0; y&lt;<a class="code" href="classsdet__grid__finder__params.html#a46958d023680a9c790b3af4155297bf5" title="number of horizontal grid lines">n_lines_x_</a>; y++)
<a name="l01435"></a>01435     {
<a name="l01436"></a>01436       <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__point__2d.html">vgl_homg_point_2d&lt;double&gt;</a> hp(x*<a class="code" href="classsdet__grid__finder__params.html#a68f253a0739973bf648cb8fada037c7f" title="spacing between lines">spacing_</a>, y*spacing_);
<a name="l01437"></a>01437       <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__point__2d.html">vgl_homg_point_2d&lt;double&gt;</a> thp = grid_to_image(hp);
<a name="l01438"></a>01438       <span class="keywordtype">double</span> image_x = thp.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__point__2d.html#a1d928ee2aae43e7cc7bec7e2db2ad989">x</a>() / thp.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__point__2d.html#ab452fbf6dec9591ff07c0ebb7b05f1e1">w</a>();
<a name="l01439"></a>01439       <span class="keywordtype">double</span> image_y = thp.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__point__2d.html#a098f0121fa0b75d2f4171d00a1bf7f31">y</a>() / thp.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__point__2d.html#ab452fbf6dec9591ff07c0ebb7b05f1e1">w</a>();
<a name="l01440"></a>01440       outstream &lt;&lt; image_x &lt;&lt;<span class="charliteral">&#39; &#39;</span>&lt;&lt;image_y&lt;&lt;<span class="charliteral">&#39;\n&#39;</span>;
<a name="l01441"></a>01441     }
<a name="l01442"></a>01442   }
<a name="l01443"></a>01443   outstream &lt;&lt; <span class="charliteral">&#39;\n&#39;</span>;
<a name="l01444"></a>01444 
<a name="l01445"></a>01445   <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l01446"></a>01446 }
<a name="l01447"></a>01447 
<a name="l01448"></a>01448 
<a name="l01449"></a><a class="code" href="classsdet__grid__finder.html#af78d3227dd30c5a2558301025bcd36f9">01449</a> <span class="keywordtype">bool</span> <a class="code" href="classsdet__grid__finder.html#af78d3227dd30c5a2558301025bcd36f9" title="test camera parameter matrices.">sdet_grid_finder::transform_grid_points</a>(vnl_matrix_fixed&lt;double,3,3&gt; &amp; K,
<a name="l01450"></a>01450                                              vnl_matrix_fixed&lt;double,3,4&gt; &amp; M,
<a name="l01451"></a>01451                                              vcl_vector&lt;vsol_point_2d_sptr&gt; &amp; points)
<a name="l01452"></a>01452 {
<a name="l01453"></a>01453   vnl_matrix_fixed&lt;double,3,4&gt; grid_to_image_debug = K*M;
<a name="l01454"></a>01454   <span class="comment">// transform the vertical grid lines back to the image</span>
<a name="l01455"></a>01455   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> x = 0; x&lt;<a class="code" href="classsdet__grid__finder__params.html#a46958d023680a9c790b3af4155297bf5" title="number of horizontal grid lines">n_lines_x_</a>; x++)
<a name="l01456"></a>01456   {
<a name="l01457"></a>01457     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> y = 0; y&lt;<a class="code" href="classsdet__grid__finder__params.html#a5f247d928fac91521ad77f20a81442c7" title="number of vertical grid lines">n_lines_y_</a>; y++)
<a name="l01458"></a>01458     {
<a name="l01459"></a>01459       vnl_matrix_fixed&lt;double,4,1&gt; p;
<a name="l01460"></a>01460       p.put(0,0,x*<a class="code" href="classsdet__grid__finder__params.html#a68f253a0739973bf648cb8fada037c7f" title="spacing between lines">spacing_</a>); p.put(1,0,y*spacing_); p.put(2,0,0); p.put(3,0,1);
<a name="l01461"></a>01461 
<a name="l01462"></a>01462       vnl_matrix_fixed&lt;double,3,1&gt; tp = grid_to_image_debug * p;
<a name="l01463"></a>01463 
<a name="l01464"></a>01464       <a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__smart__ptr.html">vsol_point_2d_sptr</a> sp = <span class="keyword">new</span> <a class="codeRef" doxygen="contrib_gel_vsol.tag:../../../../../contrib/gel/vsol/html" href="../../../../../contrib/gel/vsol/html/classvsol__point__2d.html">vsol_point_2d</a>(tp.get(0,0)/tp.get(2,0),
<a name="l01465"></a>01465                                                 tp.get(1,0)/tp.get(2,0));
<a name="l01466"></a>01466       points.push_back(sp);
<a name="l01467"></a>01467     }
<a name="l01468"></a>01468   }
<a name="l01469"></a>01469   <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l01470"></a>01470 }
<a name="l01471"></a>01471 
<a name="l01472"></a>01472 <span class="comment">//----------------------------------------------------------</span>
<a name="l01473"></a>01473 <span class="comment">//: Clear internal storage</span>
<a name="l01474"></a>01474 <span class="comment">//</span>
<a name="l01475"></a><a class="code" href="classsdet__grid__finder.html#a30bcec051d3565cda60775fea14db484">01475</a> <span class="keywordtype">void</span> <a class="code" href="classsdet__grid__finder.html#a30bcec051d3565cda60775fea14db484" title="Clear internal storage.">sdet_grid_finder::clear</a>()
<a name="l01476"></a>01476 {
<a name="l01477"></a>01477   <a class="code" href="classsdet__grid__finder.html#a608f15023fda070d4d78b4be814d761e">lines_</a>.clear();
<a name="l01478"></a>01478   <a class="code" href="classsdet__grid__finder.html#adc791552e6af41cd5255d5266828256d">vanishing_points_valid_</a>=<span class="keyword">false</span>;
<a name="l01479"></a>01479   <a class="code" href="classsdet__grid__finder.html#adf5ce6ac42e5f286f57acd43be27ed94">projective_homography_valid_</a> = <span class="keyword">false</span>;
<a name="l01480"></a>01480   <a class="code" href="classsdet__grid__finder.html#aaa6f3265f9273ea468a69cd33c9906ea">homography_valid_</a> = <span class="keyword">false</span>;
<a name="l01481"></a>01481 }
<a name="l01482"></a>01482 
<a name="l01483"></a>01483 
<a name="l01484"></a>01484 <span class="comment">//: Check grid match by verifying image intensity values within grid squares</span>
<a name="l01485"></a><a class="code" href="classsdet__grid__finder.html#a530bba6c5dd051300b33a2c217c709fe">01485</a> <span class="keywordtype">bool</span> <a class="code" href="classsdet__grid__finder.html#a530bba6c5dd051300b33a2c217c709fe" title="make sure homography and image correspond with each other.">sdet_grid_finder::check_grid_match</a>(vil1_image img)
<a name="l01486"></a>01486 {
<a name="l01487"></a>01487   <span class="keywordflow">if</span> (!<a class="code" href="classsdet__grid__finder.html#aaa6f3265f9273ea468a69cd33c9906ea">homography_valid_</a>)
<a name="l01488"></a>01488     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01489"></a>01489 
<a name="l01490"></a>01490   <span class="keywordtype">double</span> mean_intensity, intensity_sigma;
<a name="l01491"></a>01491   <span class="comment">// we want to make sure all of the squares in one category (the white squares)</span>
<a name="l01492"></a>01492   <span class="comment">// have intensity greater than all the squares in the other category (black squares)</span>
<a name="l01493"></a>01493   <span class="keywordtype">double</span> square_max_mins[2][2];
<a name="l01494"></a>01494   <span class="comment">// category 1 min</span>
<a name="l01495"></a>01495   square_max_mins[0][0] = vnl_numeric_traits&lt;double&gt;::maxval;
<a name="l01496"></a>01496   <span class="comment">// category 1 max</span>
<a name="l01497"></a>01497   square_max_mins[0][1] = 0;
<a name="l01498"></a>01498   <span class="comment">// category 2 min</span>
<a name="l01499"></a>01499   square_max_mins[1][0] = vnl_numeric_traits&lt;double&gt;::maxval;
<a name="l01500"></a>01500   <span class="comment">// category 2 max</span>
<a name="l01501"></a>01501   square_max_mins[1][1] = 0;
<a name="l01502"></a>01502 
<a name="l01503"></a>01503   <span class="keywordtype">int</span> category;
<a name="l01504"></a>01504   <span class="comment">// check left row of grid squares</span>
<a name="l01505"></a>01505   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="classsdet__grid__finder__params.html#a46958d023680a9c790b3af4155297bf5" title="number of horizontal grid lines">n_lines_x_</a>-1; i++)
<a name="l01506"></a>01506   {
<a name="l01507"></a>01507     <span class="keywordflow">if</span> (!<a class="code" href="classsdet__grid__finder.html#a7adadfaae12602402dc41b19f926c9b4" title="gets pixels stats from img within grid square specified by x,y.">get_square_pixel_stats</a>(img,0,i,mean_intensity,intensity_sigma))
<a name="l01508"></a>01508       <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01509"></a>01509     category = i%2;
<a name="l01510"></a>01510     <span class="keywordflow">if</span> (mean_intensity &lt; square_max_mins[category][0])
<a name="l01511"></a>01511       square_max_mins[category][0] = mean_intensity;
<a name="l01512"></a>01512     <span class="keywordflow">if</span> (mean_intensity &gt; square_max_mins[category][1])
<a name="l01513"></a>01513       square_max_mins[category][1] = mean_intensity;
<a name="l01514"></a>01514   }
<a name="l01515"></a>01515   <span class="comment">// check right row of grid squares</span>
<a name="l01516"></a>01516   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; n_lines_x_-1; i++)
<a name="l01517"></a>01517   {
<a name="l01518"></a>01518     <span class="keywordflow">if</span> (!<a class="code" href="classsdet__grid__finder.html#a7adadfaae12602402dc41b19f926c9b4" title="gets pixels stats from img within grid square specified by x,y.">get_square_pixel_stats</a>(img,<a class="code" href="classsdet__grid__finder__params.html#a5f247d928fac91521ad77f20a81442c7" title="number of vertical grid lines">n_lines_y_</a>-2,i,mean_intensity,intensity_sigma))
<a name="l01519"></a>01519       <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01520"></a>01520     category = int(vcl_abs(<span class="keywordtype">double</span>((<a class="code" href="classsdet__grid__finder__params.html#a5f247d928fac91521ad77f20a81442c7" title="number of vertical grid lines">n_lines_y_</a>%2) - (i%2))));
<a name="l01521"></a>01521     <span class="keywordflow">if</span> (mean_intensity &lt; square_max_mins[category][0])
<a name="l01522"></a>01522       square_max_mins[category][0] = mean_intensity;
<a name="l01523"></a>01523     <span class="keywordflow">if</span> (mean_intensity &gt; square_max_mins[category][1])
<a name="l01524"></a>01524       square_max_mins[category][1] = mean_intensity;
<a name="l01525"></a>01525   }
<a name="l01526"></a>01526   <span class="comment">// check upper row of grid squares</span>
<a name="l01527"></a>01527   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="classsdet__grid__finder__params.html#a5f247d928fac91521ad77f20a81442c7" title="number of vertical grid lines">n_lines_y_</a>-1; i++)
<a name="l01528"></a>01528   {
<a name="l01529"></a>01529     <span class="keywordflow">if</span> (!<a class="code" href="classsdet__grid__finder.html#a7adadfaae12602402dc41b19f926c9b4" title="gets pixels stats from img within grid square specified by x,y.">get_square_pixel_stats</a>(img,i,0,mean_intensity,intensity_sigma))
<a name="l01530"></a>01530       <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01531"></a>01531     category = (i%2);
<a name="l01532"></a>01532     <span class="keywordflow">if</span> (mean_intensity &lt; square_max_mins[category][0])
<a name="l01533"></a>01533       square_max_mins[category][0] = mean_intensity;
<a name="l01534"></a>01534     <span class="keywordflow">if</span> (mean_intensity &gt; square_max_mins[category][1])
<a name="l01535"></a>01535       square_max_mins[category][1] = mean_intensity;
<a name="l01536"></a>01536   }
<a name="l01537"></a>01537   <span class="comment">// check lower row of grid squares</span>
<a name="l01538"></a>01538   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; n_lines_y_-1; i++)
<a name="l01539"></a>01539   {
<a name="l01540"></a>01540     <span class="keywordflow">if</span> (!<a class="code" href="classsdet__grid__finder.html#a7adadfaae12602402dc41b19f926c9b4" title="gets pixels stats from img within grid square specified by x,y.">get_square_pixel_stats</a>(img,i,n_lines_x_-2,mean_intensity,intensity_sigma))
<a name="l01541"></a>01541       <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01542"></a>01542     category = int(vcl_abs(<span class="keywordtype">double</span>((n_lines_x_%2) - (i%2))));
<a name="l01543"></a>01543     <span class="keywordflow">if</span> (mean_intensity &lt; square_max_mins[category][0])
<a name="l01544"></a>01544       square_max_mins[category][0] = mean_intensity;
<a name="l01545"></a>01545     <span class="keywordflow">if</span> (mean_intensity &gt; square_max_mins[category][1])
<a name="l01546"></a>01546       square_max_mins[category][1] = mean_intensity;
<a name="l01547"></a>01547   }
<a name="l01548"></a>01548   vcl_cout &lt;&lt; <span class="stringliteral">&quot;cat 1: min = &quot;</span>&lt;&lt;square_max_mins[0][0]&lt;&lt;<span class="stringliteral">&quot; max = &quot;</span>&lt;&lt;square_max_mins[0][1]&lt;&lt;<span class="charliteral">&#39;\n&#39;</span>
<a name="l01549"></a>01549            &lt;&lt; <span class="stringliteral">&quot;cat 2: min = &quot;</span>&lt;&lt;square_max_mins[1][0]&lt;&lt;<span class="stringliteral">&quot; max = &quot;</span>&lt;&lt;square_max_mins[1][1]&lt;&lt;<span class="charliteral">&#39;\n&#39;</span>;
<a name="l01550"></a>01550 
<a name="l01551"></a>01551   <span class="keywordflow">if</span> ( (square_max_mins[0][0] &gt; square_max_mins[1][1]) ||
<a name="l01552"></a>01552        (square_max_mins[1][0] &gt; square_max_mins[0][1]) )
<a name="l01553"></a>01553   {
<a name="l01554"></a>01554     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l01555"></a>01555   }
<a name="l01556"></a>01556   <span class="keywordflow">else</span>
<a name="l01557"></a>01557   {
<a name="l01558"></a>01558     vcl_cout &lt;&lt; <span class="stringliteral">&quot;INVALID GRID MATCH\n&quot;</span>;
<a name="l01559"></a>01559     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01560"></a>01560   }
<a name="l01561"></a>01561 }
<a name="l01562"></a>01562 
<a name="l01563"></a>01563 <span class="comment">//: gets pixels stats from img within grid square specified by x,y</span>
<a name="l01564"></a>01564 <span class="comment">//  Not returning a valid sigma value for now -DEC</span>
<a name="l01565"></a><a class="code" href="classsdet__grid__finder.html#a7adadfaae12602402dc41b19f926c9b4">01565</a> <span class="keywordtype">bool</span> <a class="code" href="classsdet__grid__finder.html#a7adadfaae12602402dc41b19f926c9b4" title="gets pixels stats from img within grid square specified by x,y.">sdet_grid_finder::get_square_pixel_stats</a>(vil1_image img,
<a name="l01566"></a>01566                                               <span class="keywordtype">int</span> x,<span class="keywordtype">int</span> y,
<a name="l01567"></a>01567                                               <span class="keywordtype">double</span> &amp; mean_intensity,
<a name="l01568"></a>01568                                               <span class="keywordtype">double</span> &amp; <span class="comment">/* intensity_sigma */</span>)
<a name="l01569"></a>01569 {
<a name="l01570"></a>01570   gevd_bufferxy img_buff(img);
<a name="l01571"></a>01571 
<a name="l01572"></a>01572   <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__point__2d.html">vgl_homg_point_2d&lt;double&gt;</a> gul(x*<a class="code" href="classsdet__grid__finder__params.html#a68f253a0739973bf648cb8fada037c7f" title="spacing between lines">spacing_</a>,y*spacing_);
<a name="l01573"></a>01573   <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__point__2d.html">vgl_homg_point_2d&lt;double&gt;</a> gur((x+1)*spacing_,y*spacing_);
<a name="l01574"></a>01574   <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__point__2d.html">vgl_homg_point_2d&lt;double&gt;</a> glr((x+1)*spacing_,(y+1)*spacing_);
<a name="l01575"></a>01575   <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__point__2d.html">vgl_homg_point_2d&lt;double&gt;</a> gll(x*spacing_,(y+1)*spacing_);
<a name="l01576"></a>01576   <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__point__2d.html">vgl_homg_point_2d&lt;double&gt;</a> ul,ur,lr,ll;
<a name="l01577"></a>01577 
<a name="l01578"></a>01578   <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__h__matrix__2d.html">vgl_h_matrix_2d&lt;double&gt;</a> grid_to_image = <a class="code" href="classsdet__grid__finder.html#a4ece8008f9422b907ec3ffa291571bda">homography_</a>.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__h__matrix__2d.html#a54ecf67a21fc3a3dc03d4760c8958ded">get_inverse</a>();
<a name="l01579"></a>01579 
<a name="l01580"></a>01580   ul = grid_to_image(gul); ul.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__point__2d.html#ad09a7a39599211ec304cfcaa3e98ff17">set</a>(ul.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__point__2d.html#a1d928ee2aae43e7cc7bec7e2db2ad989">x</a>()/ul.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__point__2d.html#ab452fbf6dec9591ff07c0ebb7b05f1e1">w</a>(), ul.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__point__2d.html#a098f0121fa0b75d2f4171d00a1bf7f31">y</a>()/ul.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__point__2d.html#ab452fbf6dec9591ff07c0ebb7b05f1e1">w</a>(),1.0);
<a name="l01581"></a>01581   ur = grid_to_image(gur); ur.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__point__2d.html#ad09a7a39599211ec304cfcaa3e98ff17">set</a>(ur.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__point__2d.html#a1d928ee2aae43e7cc7bec7e2db2ad989">x</a>()/ur.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__point__2d.html#ab452fbf6dec9591ff07c0ebb7b05f1e1">w</a>(), ur.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__point__2d.html#a098f0121fa0b75d2f4171d00a1bf7f31">y</a>()/ur.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__point__2d.html#ab452fbf6dec9591ff07c0ebb7b05f1e1">w</a>(),1.0);
<a name="l01582"></a>01582   lr = grid_to_image(glr); lr.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__point__2d.html#ad09a7a39599211ec304cfcaa3e98ff17">set</a>(lr.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__point__2d.html#a1d928ee2aae43e7cc7bec7e2db2ad989">x</a>()/lr.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__point__2d.html#ab452fbf6dec9591ff07c0ebb7b05f1e1">w</a>(), lr.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__point__2d.html#a098f0121fa0b75d2f4171d00a1bf7f31">y</a>()/lr.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__point__2d.html#ab452fbf6dec9591ff07c0ebb7b05f1e1">w</a>(),1.0);
<a name="l01583"></a>01583   ll = grid_to_image(gll); ll.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__point__2d.html#ad09a7a39599211ec304cfcaa3e98ff17">set</a>(ll.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__point__2d.html#a1d928ee2aae43e7cc7bec7e2db2ad989">x</a>()/ll.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__point__2d.html#ab452fbf6dec9591ff07c0ebb7b05f1e1">w</a>(), ll.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__point__2d.html#a098f0121fa0b75d2f4171d00a1bf7f31">y</a>()/ll.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__point__2d.html#ab452fbf6dec9591ff07c0ebb7b05f1e1">w</a>(),1.0);
<a name="l01584"></a>01584 
<a name="l01585"></a>01585 <span class="preprocessor">#ifdef DEBUG</span>
<a name="l01586"></a>01586 <span class="preprocessor"></span>  vcl_cout &lt;&lt; <span class="stringliteral">&quot;ul &quot;</span>&lt;&lt;ul&lt;&lt;<span class="stringliteral">&quot; ur &quot;</span>&lt;&lt;ur&lt;&lt;<span class="stringliteral">&quot; lr &quot;</span>&lt;&lt;lr&lt;&lt;<span class="stringliteral">&quot; ll &quot;</span>&lt;&lt;ll&lt;&lt;<span class="charliteral">&#39;\n&#39;</span>;
<a name="l01587"></a>01587 <span class="preprocessor">#endif</span>
<a name="l01588"></a>01588 <span class="preprocessor"></span>  <span class="comment">// add/subtract 1 from min_y and max_y to account for possible rounding error</span>
<a name="l01589"></a>01589   <span class="keywordtype">int</span> min_y =
<a name="l01590"></a>01590     <a class="codeRef" doxygen="core_vnl.tag:../../../../../core/vnl/html" href="../../../../../core/vnl/html/vnl__math_8h.html#aa8bc35f122f05f3d17e622ba80161361">vnl_math_rnd</a>(<a class="codeRef" doxygen="core_vnl.tag:../../../../../core/vnl/html" href="../../../../../core/vnl/html/vnl__decnum_8h.html#ac7064c7fc83d5d457e5f903eacac9f73">vnl_math_min</a>(<a class="codeRef" doxygen="core_vnl.tag:../../../../../core/vnl/html" href="../../../../../core/vnl/html/vnl__decnum_8h.html#ac7064c7fc83d5d457e5f903eacac9f73">vnl_math_min</a>(<a class="codeRef" doxygen="core_vnl.tag:../../../../../core/vnl/html" href="../../../../../core/vnl/html/vnl__decnum_8h.html#ac7064c7fc83d5d457e5f903eacac9f73">vnl_math_min</a>(ul.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__point__2d.html#a098f0121fa0b75d2f4171d00a1bf7f31">y</a>(),ur.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__point__2d.html#a098f0121fa0b75d2f4171d00a1bf7f31">y</a>()),ll.y()),lr.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__point__2d.html#a098f0121fa0b75d2f4171d00a1bf7f31">y</a>())) -1;
<a name="l01591"></a>01591   <span class="keywordtype">int</span> max_y =
<a name="l01592"></a>01592     <a class="codeRef" doxygen="core_vnl.tag:../../../../../core/vnl/html" href="../../../../../core/vnl/html/vnl__math_8h.html#aa8bc35f122f05f3d17e622ba80161361">vnl_math_rnd</a>(<a class="codeRef" doxygen="core_vnl.tag:../../../../../core/vnl/html" href="../../../../../core/vnl/html/vnl__decnum_8h.html#a17c47eb693cfd88c7b181b162eca8dec">vnl_math_max</a>(<a class="codeRef" doxygen="core_vnl.tag:../../../../../core/vnl/html" href="../../../../../core/vnl/html/vnl__decnum_8h.html#a17c47eb693cfd88c7b181b162eca8dec">vnl_math_max</a>(<a class="codeRef" doxygen="core_vnl.tag:../../../../../core/vnl/html" href="../../../../../core/vnl/html/vnl__decnum_8h.html#a17c47eb693cfd88c7b181b162eca8dec">vnl_math_max</a>(ul.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__point__2d.html#a098f0121fa0b75d2f4171d00a1bf7f31">y</a>(),ur.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__point__2d.html#a098f0121fa0b75d2f4171d00a1bf7f31">y</a>()),ll.y()),lr.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__point__2d.html#a098f0121fa0b75d2f4171d00a1bf7f31">y</a>())) +1;
<a name="l01593"></a>01593 
<a name="l01594"></a>01594   <span class="keywordtype">int</span> n_scan_rows = max_y - min_y + 1;
<a name="l01595"></a>01595 
<a name="l01596"></a>01596   <span class="keywordflow">if</span> (n_scan_rows &lt; 2*<a class="code" href="classsdet__grid__finder__params.html#a46958d023680a9c790b3af4155297bf5" title="number of horizontal grid lines">n_lines_x_</a>)
<a name="l01597"></a>01597   {
<a name="l01598"></a>01598     <span class="comment">// less than 2 pixels per square - something &#39;s wrong</span>
<a name="l01599"></a>01599     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01600"></a>01600   }
<a name="l01601"></a>01601 
<a name="l01602"></a>01602   <a class="codeRef" doxygen="core_vnl.tag:../../../../../core/vnl/html" href="../../../../../core/vnl/html/classvnl__matrix.html">vnl_matrix&lt;int&gt;</a> scan_rows(n_scan_rows,2);
<a name="l01603"></a>01603 
<a name="l01604"></a>01604   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; n_scan_rows; i++)
<a name="l01605"></a>01605   {
<a name="l01606"></a>01606     scan_rows[i][0] = <a class="codeRef" doxygen="core_vnl.tag:../../../../../core/vnl/html" href="../../../../../core/vnl/html/classvnl__numeric__traits_3_01int_01_4.html#ac6ad36b5e5346b1db8942e6d74c6b3d3">vnl_numeric_traits&lt;int&gt;::maxval</a>;
<a name="l01607"></a>01607     scan_rows[i][1] = -<a class="codeRef" doxygen="core_vnl.tag:../../../../../core/vnl/html" href="../../../../../core/vnl/html/classvnl__numeric__traits_3_01int_01_4.html#ac6ad36b5e5346b1db8942e6d74c6b3d3">vnl_numeric_traits&lt;int&gt;::maxval</a>;
<a name="l01608"></a>01608   }
<a name="l01609"></a>01609 
<a name="l01610"></a>01610   <span class="comment">// start_t and end_t are set so we stay within the square region,</span>
<a name="l01611"></a>01611   <span class="comment">// avoiding the boundary pixels</span>
<a name="l01612"></a>01612 
<a name="l01613"></a>01613   <span class="comment">// upper line</span>
<a name="l01614"></a>01614   <span class="keywordtype">int</span> start_t = <a class="codeRef" doxygen="core_vnl.tag:../../../../../core/vnl/html" href="../../../../../core/vnl/html/vnl__math_8h.html#aa8bc35f122f05f3d17e622ba80161361">vnl_math_rnd</a>(ul.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__point__2d.html#a1d928ee2aae43e7cc7bec7e2db2ad989">x</a>()+0.5);
<a name="l01615"></a>01615   <span class="keywordtype">int</span> end_t = <a class="codeRef" doxygen="core_vnl.tag:../../../../../core/vnl/html" href="../../../../../core/vnl/html/vnl__math_8h.html#aa8bc35f122f05f3d17e622ba80161361">vnl_math_rnd</a>(ur.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__point__2d.html#a1d928ee2aae43e7cc7bec7e2db2ad989">x</a>()-0.5);
<a name="l01616"></a>01616   <span class="keywordtype">double</span> slope = (ur.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__point__2d.html#a098f0121fa0b75d2f4171d00a1bf7f31">y</a>() - ul.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__point__2d.html#a098f0121fa0b75d2f4171d00a1bf7f31">y</a>())/(ur.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__point__2d.html#a1d928ee2aae43e7cc7bec7e2db2ad989">x</a>() - ul.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__point__2d.html#a1d928ee2aae43e7cc7bec7e2db2ad989">x</a>());
<a name="l01617"></a>01617   <span class="keywordtype">double</span> real_pix = ul.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__point__2d.html#a098f0121fa0b75d2f4171d00a1bf7f31">y</a>();
<a name="l01618"></a>01618   <span class="keywordtype">int</span> rounded_pix;
<a name="l01619"></a>01619   <span class="keywordtype">int</span> row_idx;
<a name="l01620"></a>01620 <span class="preprocessor">#ifdef DEBUG</span>
<a name="l01621"></a>01621 <span class="preprocessor"></span>  vcl_cout &lt;&lt; <span class="stringliteral">&quot;start_t = &quot;</span>&lt;&lt;start_t&lt;&lt;<span class="stringliteral">&quot; end_t= &quot;</span>&lt;&lt;end_t&lt;&lt;<span class="stringliteral">&quot; slope = &quot;</span>&lt;&lt;slope&lt;&lt;<span class="charliteral">&#39;\n&#39;</span>;
<a name="l01622"></a>01622 <span class="preprocessor">#endif</span>
<a name="l01623"></a>01623 <span class="preprocessor"></span>  <span class="keywordflow">for</span> (<span class="keywordtype">int</span> t = start_t; t &lt;= end_t; t++)
<a name="l01624"></a>01624   {
<a name="l01625"></a>01625     rounded_pix = <a class="codeRef" doxygen="core_vnl.tag:../../../../../core/vnl/html" href="../../../../../core/vnl/html/vnl__math_8h.html#aa8bc35f122f05f3d17e622ba80161361">vnl_math_rnd</a>(real_pix);
<a name="l01626"></a>01626     row_idx = rounded_pix - min_y;
<a name="l01627"></a>01627     scan_rows[row_idx][0] = <a class="codeRef" doxygen="core_vnl.tag:../../../../../core/vnl/html" href="../../../../../core/vnl/html/vnl__decnum_8h.html#ac7064c7fc83d5d457e5f903eacac9f73">vnl_math_min</a>(scan_rows[row_idx][0],t);
<a name="l01628"></a>01628     scan_rows[row_idx][1] = <a class="codeRef" doxygen="core_vnl.tag:../../../../../core/vnl/html" href="../../../../../core/vnl/html/vnl__decnum_8h.html#a17c47eb693cfd88c7b181b162eca8dec">vnl_math_max</a>(scan_rows[row_idx][1],t);
<a name="l01629"></a>01629     real_pix += slope;
<a name="l01630"></a>01630   }
<a name="l01631"></a>01631 
<a name="l01632"></a>01632   <span class="comment">// lower line</span>
<a name="l01633"></a>01633   start_t = <a class="codeRef" doxygen="core_vnl.tag:../../../../../core/vnl/html" href="../../../../../core/vnl/html/vnl__math_8h.html#aa8bc35f122f05f3d17e622ba80161361">vnl_math_rnd</a>(ll.x()+0.5);
<a name="l01634"></a>01634   end_t = <a class="codeRef" doxygen="core_vnl.tag:../../../../../core/vnl/html" href="../../../../../core/vnl/html/vnl__math_8h.html#aa8bc35f122f05f3d17e622ba80161361">vnl_math_rnd</a>(lr.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__point__2d.html#a1d928ee2aae43e7cc7bec7e2db2ad989">x</a>()-0.5);
<a name="l01635"></a>01635   slope = (lr.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__point__2d.html#a098f0121fa0b75d2f4171d00a1bf7f31">y</a>() - ll.y())/(lr.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__point__2d.html#a1d928ee2aae43e7cc7bec7e2db2ad989">x</a>() - ll.x());
<a name="l01636"></a>01636   real_pix = ll.y();
<a name="l01637"></a>01637 <span class="preprocessor">#ifdef DEBUG</span>
<a name="l01638"></a>01638 <span class="preprocessor"></span>  vcl_cout &lt;&lt; <span class="stringliteral">&quot;start_t = &quot;</span>&lt;&lt;start_t&lt;&lt;<span class="stringliteral">&quot; end_t= &quot;</span>&lt;&lt;end_t&lt;&lt;<span class="stringliteral">&quot; slope = &quot;</span>&lt;&lt;slope&lt;&lt;<span class="charliteral">&#39;\n&#39;</span>;
<a name="l01639"></a>01639 <span class="preprocessor">#endif</span>
<a name="l01640"></a>01640 <span class="preprocessor"></span>  <span class="keywordflow">for</span> (<span class="keywordtype">int</span> t = start_t; t &lt;= end_t; t++)
<a name="l01641"></a>01641   {
<a name="l01642"></a>01642     rounded_pix = <a class="codeRef" doxygen="core_vnl.tag:../../../../../core/vnl/html" href="../../../../../core/vnl/html/vnl__math_8h.html#aa8bc35f122f05f3d17e622ba80161361">vnl_math_rnd</a>(real_pix);
<a name="l01643"></a>01643     row_idx = rounded_pix - min_y;
<a name="l01644"></a>01644     scan_rows[row_idx][0] = <a class="codeRef" doxygen="core_vnl.tag:../../../../../core/vnl/html" href="../../../../../core/vnl/html/vnl__decnum_8h.html#ac7064c7fc83d5d457e5f903eacac9f73">vnl_math_min</a>(scan_rows[row_idx][0],t);
<a name="l01645"></a>01645     scan_rows[row_idx][1] = <a class="codeRef" doxygen="core_vnl.tag:../../../../../core/vnl/html" href="../../../../../core/vnl/html/vnl__decnum_8h.html#a17c47eb693cfd88c7b181b162eca8dec">vnl_math_max</a>(scan_rows[row_idx][1],t);
<a name="l01646"></a>01646     real_pix += slope;
<a name="l01647"></a>01647   }
<a name="l01648"></a>01648 
<a name="l01649"></a>01649   <span class="comment">// left line</span>
<a name="l01650"></a>01650   start_t = <a class="codeRef" doxygen="core_vnl.tag:../../../../../core/vnl/html" href="../../../../../core/vnl/html/vnl__math_8h.html#aa8bc35f122f05f3d17e622ba80161361">vnl_math_rnd</a>(ul.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__point__2d.html#a098f0121fa0b75d2f4171d00a1bf7f31">y</a>()+0.5);
<a name="l01651"></a>01651   end_t = <a class="codeRef" doxygen="core_vnl.tag:../../../../../core/vnl/html" href="../../../../../core/vnl/html/vnl__math_8h.html#aa8bc35f122f05f3d17e622ba80161361">vnl_math_rnd</a>(ll.y()-0.5);
<a name="l01652"></a>01652   slope = (ll.x() - ul.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__point__2d.html#a1d928ee2aae43e7cc7bec7e2db2ad989">x</a>())/(ll.y() - ul.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__point__2d.html#a098f0121fa0b75d2f4171d00a1bf7f31">y</a>());
<a name="l01653"></a>01653   real_pix = ul.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__point__2d.html#a1d928ee2aae43e7cc7bec7e2db2ad989">x</a>();
<a name="l01654"></a>01654 <span class="preprocessor">#ifdef DEBUG</span>
<a name="l01655"></a>01655 <span class="preprocessor"></span>  vcl_cout &lt;&lt; <span class="stringliteral">&quot;start_t = &quot;</span>&lt;&lt;start_t&lt;&lt;<span class="stringliteral">&quot; end_t= &quot;</span>&lt;&lt;end_t&lt;&lt;<span class="stringliteral">&quot; slope = &quot;</span>&lt;&lt;slope&lt;&lt;<span class="charliteral">&#39;\n&#39;</span>;
<a name="l01656"></a>01656 <span class="preprocessor">#endif</span>
<a name="l01657"></a>01657 <span class="preprocessor"></span>  <span class="keywordflow">for</span> (<span class="keywordtype">int</span> t = start_t; t &lt;= end_t; t++)
<a name="l01658"></a>01658   {
<a name="l01659"></a>01659     rounded_pix = <a class="codeRef" doxygen="core_vnl.tag:../../../../../core/vnl/html" href="../../../../../core/vnl/html/vnl__math_8h.html#aa8bc35f122f05f3d17e622ba80161361">vnl_math_rnd</a>(real_pix);
<a name="l01660"></a>01660     row_idx = t - min_y;
<a name="l01661"></a>01661     scan_rows[row_idx][0] = <a class="codeRef" doxygen="core_vnl.tag:../../../../../core/vnl/html" href="../../../../../core/vnl/html/vnl__decnum_8h.html#ac7064c7fc83d5d457e5f903eacac9f73">vnl_math_min</a>(scan_rows[row_idx][0],rounded_pix);
<a name="l01662"></a>01662     scan_rows[row_idx][1] = <a class="codeRef" doxygen="core_vnl.tag:../../../../../core/vnl/html" href="../../../../../core/vnl/html/vnl__decnum_8h.html#a17c47eb693cfd88c7b181b162eca8dec">vnl_math_max</a>(scan_rows[row_idx][1],rounded_pix);
<a name="l01663"></a>01663     real_pix += slope;
<a name="l01664"></a>01664   }
<a name="l01665"></a>01665 
<a name="l01666"></a>01666   <span class="comment">// right line</span>
<a name="l01667"></a>01667   start_t = <a class="codeRef" doxygen="core_vnl.tag:../../../../../core/vnl/html" href="../../../../../core/vnl/html/vnl__math_8h.html#aa8bc35f122f05f3d17e622ba80161361">vnl_math_rnd</a>(ur.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__point__2d.html#a098f0121fa0b75d2f4171d00a1bf7f31">y</a>()+0.5);
<a name="l01668"></a>01668   end_t = <a class="codeRef" doxygen="core_vnl.tag:../../../../../core/vnl/html" href="../../../../../core/vnl/html/vnl__math_8h.html#aa8bc35f122f05f3d17e622ba80161361">vnl_math_rnd</a>(lr.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__point__2d.html#a098f0121fa0b75d2f4171d00a1bf7f31">y</a>()-0.5);
<a name="l01669"></a>01669   slope = (lr.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__point__2d.html#a1d928ee2aae43e7cc7bec7e2db2ad989">x</a>() - ur.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__point__2d.html#a1d928ee2aae43e7cc7bec7e2db2ad989">x</a>())/(lr.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__point__2d.html#a098f0121fa0b75d2f4171d00a1bf7f31">y</a>() - ur.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__point__2d.html#a098f0121fa0b75d2f4171d00a1bf7f31">y</a>());
<a name="l01670"></a>01670   real_pix = ur.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__point__2d.html#a1d928ee2aae43e7cc7bec7e2db2ad989">x</a>();
<a name="l01671"></a>01671 <span class="preprocessor">#ifdef DEBUG</span>
<a name="l01672"></a>01672 <span class="preprocessor"></span>  vcl_cout &lt;&lt; <span class="stringliteral">&quot;start_t = &quot;</span>&lt;&lt;start_t&lt;&lt;<span class="stringliteral">&quot; end_t= &quot;</span>&lt;&lt;end_t&lt;&lt;<span class="stringliteral">&quot; slope = &quot;</span>&lt;&lt;slope&lt;&lt;<span class="charliteral">&#39;\n&#39;</span>;
<a name="l01673"></a>01673 <span class="preprocessor">#endif</span>
<a name="l01674"></a>01674 <span class="preprocessor"></span>  <span class="keywordflow">for</span> (<span class="keywordtype">int</span> t = start_t; t &lt;= end_t; t++)
<a name="l01675"></a>01675   {
<a name="l01676"></a>01676     rounded_pix = <a class="codeRef" doxygen="core_vnl.tag:../../../../../core/vnl/html" href="../../../../../core/vnl/html/vnl__math_8h.html#aa8bc35f122f05f3d17e622ba80161361">vnl_math_rnd</a>(real_pix);
<a name="l01677"></a>01677     row_idx = t - min_y;
<a name="l01678"></a>01678     scan_rows[row_idx][0] = <a class="codeRef" doxygen="core_vnl.tag:../../../../../core/vnl/html" href="../../../../../core/vnl/html/vnl__decnum_8h.html#ac7064c7fc83d5d457e5f903eacac9f73">vnl_math_min</a>(scan_rows[row_idx][0],rounded_pix);
<a name="l01679"></a>01679     scan_rows[row_idx][1] = <a class="codeRef" doxygen="core_vnl.tag:../../../../../core/vnl/html" href="../../../../../core/vnl/html/vnl__decnum_8h.html#a17c47eb693cfd88c7b181b162eca8dec">vnl_math_max</a>(scan_rows[row_idx][1],rounded_pix);
<a name="l01680"></a>01680     real_pix += slope;
<a name="l01681"></a>01681   }
<a name="l01682"></a>01682   <span class="comment">// now we can scan the pixels and grab their intensities</span>
<a name="l01683"></a>01683   <span class="keywordtype">double</span> intensity_total = 0.0;
<a name="l01684"></a>01684   <span class="keywordtype">int</span> n_pix = 0;
<a name="l01685"></a>01685   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; n_scan_rows; i++)
<a name="l01686"></a>01686   {
<a name="l01687"></a>01687     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = scan_rows[i][0]; j &lt;= scan_rows[i][1]; ++j)
<a name="l01688"></a>01688     {
<a name="l01689"></a>01689       <span class="keywordtype">int</span> xx = j, yy = i + min_y;
<a name="l01690"></a>01690       <span class="keywordflow">if</span> (xx &lt; 0 || xx &gt;= img_buff.GetSizeX())
<a name="l01691"></a>01691         <span class="keywordflow">continue</span>;
<a name="l01692"></a>01692       <span class="keywordflow">if</span> (yy &lt; 0 || yy &gt;= img_buff.GetSizeY())
<a name="l01693"></a>01693         <span class="keywordflow">continue</span>;
<a name="l01694"></a>01694       intensity_total+= *((<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*)(img_buff.GetElementAddr(xx,yy)));
<a name="l01695"></a>01695       ++n_pix;
<a name="l01696"></a>01696     }
<a name="l01697"></a>01697   }
<a name="l01698"></a>01698   <span class="keywordflow">if</span> (!n_pix)
<a name="l01699"></a>01699   {
<a name="l01700"></a>01700     vcl_cout &lt;&lt; <span class="stringliteral">&quot;grid square contains 0 pixels\n&quot;</span>;
<a name="l01701"></a>01701     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01702"></a>01702   }
<a name="l01703"></a>01703   mean_intensity =  intensity_total / n_pix;
<a name="l01704"></a>01704   <span class="keywordflow">if</span> (<a class="code" href="classsdet__grid__finder__params.html#add98f5848c934edf71a214b9500c590a" title="print informative debug output">verbose_</a>)
<a name="l01705"></a>01705     vcl_cout &lt;&lt; <span class="charliteral">&#39;(&#39;</span>&lt;&lt;x&lt;&lt;<span class="charliteral">&#39;,&#39;</span>&lt;&lt;y&lt;&lt;<span class="stringliteral">&quot;) mean_intensity = &quot;</span>&lt;&lt;mean_intensity&lt;&lt;<span class="charliteral">&#39;\n&#39;</span>;
<a name="l01706"></a>01706   <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l01707"></a>01707 }
<a name="l01708"></a>01708 
</pre></div></div>
</div>


<hr class="footer"/><address class="footer"><small>
Generated on Thu May 2 2013 08:53:32 for contrib/brl/bseg/sdet by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.7.5.1
</small></address>

</body>
</html>
