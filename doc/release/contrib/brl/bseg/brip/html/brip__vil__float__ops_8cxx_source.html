<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
"http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
  <title>contrib/brl/bseg/brip/brip_vil_float_ops.cxx Source File</title>
  <link href="doxygen.css" rel="stylesheet" type="text/css" />
  <link href="tabs.css" rel="stylesheet" type="text/css" />
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
</head>
<body>
<!-- Generated by Doxygen 1.7.5.1 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<div class="title">contrib/brl/bseg/brip/brip_vil_float_ops.cxx</div>  </div>
</div>
<div class="contents">
<a href="brip__vil__float__ops_8cxx.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="preprocessor">#include &quot;<a class="code" href="brip__vil__float__ops_8h.html" title="operations on image_view&lt;float&gt; operands">brip_vil_float_ops.h</a>&quot;</span>
<a name="l00002"></a>00002 <span class="comment">//:</span>
<a name="l00003"></a>00003 <span class="comment">// \file</span>
<a name="l00004"></a>00004 
<a name="l00005"></a>00005 <span class="preprocessor">#include &lt;vcl_cassert.h&gt;</span>
<a name="l00006"></a>00006 <span class="preprocessor">#include &lt;vcl_fstream.h&gt;</span>
<a name="l00007"></a>00007 <span class="preprocessor">#include &lt;vcl_complex.h&gt;</span>
<a name="l00008"></a>00008 <span class="preprocessor">#include &lt;vcl_limits.h&gt;</span>
<a name="l00009"></a>00009 <span class="preprocessor">#include &lt;<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/vgl__box__2d_8h.html">vgl/vgl_box_2d.h</a>&gt;</span>
<a name="l00010"></a>00010 <span class="preprocessor">#include &lt;<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/vgl__point__2d_8h.html">vgl/vgl_point_2d.h</a>&gt;</span>
<a name="l00011"></a>00011 <span class="preprocessor">#include &lt;<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/vgl__vector__2d_8h.html">vgl/vgl_vector_2d.h</a>&gt;</span>
<a name="l00012"></a>00012 <span class="preprocessor">#include &lt;<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/vgl__polygon__scan__iterator_8h.html">vgl/vgl_polygon_scan_iterator.h</a>&gt;</span>
<a name="l00013"></a>00013 <span class="preprocessor">#include &lt;<a class="codeRef" doxygen="core_vul.tag:../../../../../core/vul/html" href="../../../../../core/vul/html/vul__timer_8h.html">vul/vul_timer.h</a>&gt;</span>
<a name="l00014"></a>00014 <span class="preprocessor">#include &lt;<a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/vbl__array__1d_8h.html">vbl/vbl_array_1d.h</a>&gt;</span>
<a name="l00015"></a>00015 <span class="preprocessor">#include &lt;<a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/vbl__array__2d_8h.html">vbl/vbl_array_2d.h</a>&gt;</span>
<a name="l00016"></a>00016 <span class="preprocessor">#include &lt;<a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/vbl__bounding__box_8h.html">vbl/vbl_bounding_box.h</a>&gt;</span>
<a name="l00017"></a>00017 <span class="preprocessor">#include &lt;<a class="codeRef" doxygen="core_vnl.tag:../../../../../core/vnl/html" href="../../../../../core/vnl/html/vnl__numeric__traits_8h.html">vnl/vnl_numeric_traits.h</a>&gt;</span>
<a name="l00018"></a>00018 <span class="preprocessor">#include &lt;<a class="codeRef" doxygen="core_vnl.tag:../../../../../core/vnl/html" href="../../../../../core/vnl/html/vnl__math_8h.html">vnl/vnl_math.h</a>&gt;</span>
<a name="l00019"></a>00019 <span class="preprocessor">#include &lt;<a class="codeRef" doxygen="core_vnl.tag:../../../../../core/vnl/html" href="../../../../../core/vnl/html/vnl__double__2x3_8h.html">vnl/vnl_double_2x3.h</a>&gt;</span>
<a name="l00020"></a>00020 <span class="preprocessor">#include &lt;<a class="codeRef" doxygen="core_vnl.tag:../../../../../core/vnl/html" href="../../../../../core/vnl/html/vnl__fft__prime__factors_8h.html">vnl/algo/vnl_fft_prime_factors.h</a>&gt;</span>
<a name="l00021"></a>00021 <span class="preprocessor">#include &lt;<a class="codeRef" doxygen="core_vnl.tag:../../../../../core/vnl/html" href="../../../../../core/vnl/html/vnl__svd_8h.html">vnl/algo/vnl_svd.h</a>&gt;</span>
<a name="l00022"></a>00022 <span class="preprocessor">#include &lt;<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/vil__pixel__format_8h.html">vil/vil_pixel_format.h</a>&gt;</span>
<a name="l00023"></a>00023 <span class="preprocessor">#include &lt;<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/vil__transpose_8h.html">vil/vil_transpose.h</a>&gt;</span>
<a name="l00024"></a>00024 
<a name="l00025"></a>00025 <span class="preprocessor">#include &lt;<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/vil__convert_8h.html">vil/vil_convert.h</a>&gt;</span>
<a name="l00026"></a>00026 <span class="preprocessor">#include &lt;<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/vil__save_8h.html">vil/vil_save.h</a>&gt;</span>
<a name="l00027"></a>00027 <span class="preprocessor">#include &lt;<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/vil__new_8h.html">vil/vil_new.h</a>&gt;</span>
<a name="l00028"></a>00028 
<a name="l00029"></a>00029 <span class="preprocessor">#include &lt;<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/vil__math_8h.html">vil/vil_math.h</a>&gt;</span>
<a name="l00030"></a>00030 <span class="preprocessor">#include &lt;<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/vil__convolve__1d_8h.html">vil/algo/vil_convolve_1d.h</a>&gt;</span>
<a name="l00031"></a>00031 <span class="preprocessor">#include &lt;<a class="codeRef" doxygen="contrib_gel_vsol.tag:../../../../../contrib/gel/vsol/html" href="../../../../../contrib/gel/vsol/html/vsol__box__2d_8h.html">vsol/vsol_box_2d.h</a>&gt;</span>
<a name="l00032"></a>00032 <span class="preprocessor">#include &lt;<a class="codeRef" doxygen="contrib_gel_vsol.tag:../../../../../contrib/gel/vsol/html" href="../../../../../contrib/gel/vsol/html/vsol__polygon__2d__sptr_8h.html">vsol/vsol_polygon_2d_sptr.h</a>&gt;</span>
<a name="l00033"></a>00033 <span class="preprocessor">#include &lt;<a class="codeRef" doxygen="contrib_gel_vsol.tag:../../../../../contrib/gel/vsol/html" href="../../../../../contrib/gel/vsol/html/vsol__polygon__2d_8h.html">vsol/vsol_polygon_2d.h</a>&gt;</span>
<a name="l00034"></a>00034 <span class="preprocessor">#include &lt;<a class="codeRef" doxygen="contrib_brl_bbas_bsol.tag:../../../../../contrib/brl/bbas/bsol/html" href="../../../../../contrib/brl/bbas/bsol/html/bsol__algs_8h.html">bsol/bsol_algs.h</a>&gt;</span>
<a name="l00035"></a>00035 <span class="preprocessor">#include &lt;bsta/bsta_histogram.h&gt;</span>
<a name="l00036"></a>00036 <span class="preprocessor">#include &lt;bsta/bsta_joint_histogram.h&gt;</span>
<a name="l00037"></a>00037 <span class="preprocessor">#include &lt;<a class="code" href="brip__roi_8h.html" title="A composite region of interest class for image processing operations.">brip/brip_roi.h</a>&gt;</span>
<a name="l00038"></a>00038 
<a name="l00039"></a>00039 <span class="comment">// === Local utility functions ===</span>
<a name="l00040"></a>00040 
<a name="l00041"></a>00041 <span class="comment">//: compute normalized cross correlation from the intensity moment sums.</span>
<a name="l00042"></a>00042 <span class="keyword">static</span> <span class="keywordtype">float</span> cross_corr(<span class="keywordtype">double</span> area, <span class="keywordtype">double</span> si1, <span class="keywordtype">double</span> si2,
<a name="l00043"></a>00043                         <span class="keywordtype">double</span> si1i1, <span class="keywordtype">double</span> si2i2, <span class="keywordtype">double</span> si1i2,
<a name="l00044"></a>00044                         <span class="keywordtype">float</span> intensity_thresh)
<a name="l00045"></a>00045 {
<a name="l00046"></a>00046   <span class="keywordflow">if</span> (!area)
<a name="l00047"></a>00047     <span class="keywordflow">return</span> 0.f;
<a name="l00048"></a>00048   <span class="comment">// the mean values</span>
<a name="l00049"></a>00049   <span class="keywordtype">double</span> u1 = si1/area, u2 = si2/area;
<a name="l00050"></a>00050   <span class="keywordflow">if</span> (u1&lt;intensity_thresh||u2&lt;intensity_thresh)
<a name="l00051"></a>00051     <span class="keywordflow">return</span> -1.f;
<a name="l00052"></a>00052   <span class="keywordtype">double</span> neu = si1i2 - area*u1*u2;
<a name="l00053"></a>00053   <span class="keywordtype">double</span> sd1 = vcl_sqrt(vcl_fabs(si1i1-area*u1*u1)),
<a name="l00054"></a>00054     sd2 = vcl_sqrt(vcl_fabs(si2i2-area*u2*u2));
<a name="l00055"></a>00055   <span class="keywordflow">if</span> (!neu)
<a name="l00056"></a>00056     <span class="keywordflow">return</span> 0.f;
<a name="l00057"></a>00057   <span class="keywordflow">if</span> (!sd1||!sd2) {
<a name="l00058"></a>00058     <span class="keywordflow">if</span> (neu&gt;0)
<a name="l00059"></a>00059       <span class="keywordflow">return</span> 1.f;
<a name="l00060"></a>00060     <span class="keywordflow">else</span>
<a name="l00061"></a>00061       <span class="keywordflow">return</span> -1.f;
<a name="l00062"></a>00062   }
<a name="l00063"></a>00063   <span class="keywordtype">double</span> den = sd1*sd2;
<a name="l00064"></a>00064   <span class="keywordflow">return</span> float(neu/den);
<a name="l00065"></a>00065 }
<a name="l00066"></a>00066 
<a name="l00067"></a>00067 <span class="comment">//------------------------------------------------------------</span>
<a name="l00068"></a>00068 <span class="comment">//:  Convolve with a kernel</span>
<a name="l00069"></a>00069 <span class="comment">//   It&#39;s assumed that the kernel is square with odd dimensions</span>
<a name="l00070"></a>00070 <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a>
<a name="l00071"></a><a class="code" href="classbrip__vil__float__ops.html#a212e5e210bc565c1f63049f119fe4a5b">00071</a> <a class="code" href="classbrip__vil__float__ops.html#a212e5e210bc565c1f63049f119fe4a5b" title="convolves with the specified kernel.">brip_vil_float_ops::convolve</a>(<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> <span class="keyword">const</span>&amp; input,
<a name="l00072"></a>00072                              <a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__array__2d.html">vbl_array_2d&lt;float&gt;</a> <span class="keyword">const</span>&amp; kernel)
<a name="l00073"></a>00073 {
<a name="l00074"></a>00074   <span class="keywordtype">int</span> w = <span class="keyword">static_cast&lt;</span><span class="keywordtype">int</span><span class="keyword">&gt;</span>(input.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a9ea9ad565387a61dccf38fc80a266c2a">ni</a>()), h = static_cast&lt;int&gt;(input.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a44859c72206da7d18728cb2bbf8ae829">nj</a>());
<a name="l00075"></a>00075   <span class="keywordtype">int</span> kw = kernel.<a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__array__2d.html#a5d1d6d4ecc26eff6b99e456078924be6">cols</a>(); <span class="comment">// kh = kernel.rows();</span>
<a name="l00076"></a>00076   <span class="comment">// add a check for kernels that are not equal dimensions of odd size JLM</span>
<a name="l00077"></a>00077   <span class="keywordtype">int</span> n = (kw-1)/2;
<a name="l00078"></a>00078   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> output;
<a name="l00079"></a>00079   output.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html#a9c01939f01ef50314620e26aaacb04d3">set_size</a>(w,h);
<a name="l00080"></a>00080   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> y = n; y&lt;(h-n); y++)
<a name="l00081"></a>00081     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> x = n; x&lt;(w-n); x++)
<a name="l00082"></a>00082     {
<a name="l00083"></a>00083       <span class="keywordtype">float</span> accum = 0;
<a name="l00084"></a>00084       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = -n; j&lt;=n; j++)
<a name="l00085"></a>00085         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = -n; i&lt;=n; i++)
<a name="l00086"></a>00086         {
<a name="l00087"></a>00087           <span class="keywordtype">float</span> x1 = input(x+i,y+j);
<a name="l00088"></a>00088           <span class="keywordtype">float</span> x2 = kernel[i+n][j+n];
<a name="l00089"></a>00089           accum += x1*x2;
<a name="l00090"></a>00090         }
<a name="l00091"></a>00091       output(x,y)=accum;
<a name="l00092"></a>00092     }
<a name="l00093"></a>00093   <a class="code" href="classbrip__vil__float__ops.html#a99ebd3182f788d8147b60f177cee12ef" title="fills a border of width w on left and right of image with value.">brip_vil_float_ops::fill_x_border</a>(output, n, 0.0f);
<a name="l00094"></a>00094   <a class="code" href="classbrip__vil__float__ops.html#addf1ea3028581107a66b3b82ae89aab4" title="fills a border of height h on top and bottom of image with value.">brip_vil_float_ops::fill_y_border</a>(output, n, 0.0f);
<a name="l00095"></a>00095   <span class="keywordflow">return</span> output;
<a name="l00096"></a>00096 }
<a name="l00097"></a>00097 
<a name="l00098"></a>00098 <span class="keyword">static</span> <span class="keywordtype">void</span> fill_1d_array(<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> <span class="keyword">const</span>&amp; input,
<a name="l00099"></a>00099                           <span class="keywordtype">int</span> y, <span class="keywordtype">float</span>* output)
<a name="l00100"></a>00100 {
<a name="l00101"></a>00101   <span class="keywordtype">unsigned</span> w = input.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a9ea9ad565387a61dccf38fc80a266c2a">ni</a>();
<a name="l00102"></a>00102   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> x = 0; x&lt;w; x++)
<a name="l00103"></a>00103     output[x] = input(x,y);
<a name="l00104"></a>00104 }
<a name="l00105"></a>00105 
<a name="l00106"></a>00106 <span class="comment">//: Downsamples the 1-d array by 2 using the Burt-Adelson reduction algorithm.</span>
<a name="l00107"></a><a class="code" href="classbrip__vil__float__ops.html#a1296c4f332561b0713b744e8b2398729">00107</a> <span class="keywordtype">void</span> <a class="code" href="classbrip__vil__float__ops.html#a1296c4f332561b0713b744e8b2398729" title="sub-sample a 1-d array using the Bert-Adelson algorithm.">brip_vil_float_ops::half_resolution_1d</a>(<span class="keyword">const</span> <span class="keywordtype">float</span>* input, <span class="keywordtype">unsigned</span> width,
<a name="l00108"></a>00108                                             <span class="keywordtype">float</span> k0, <span class="keywordtype">float</span> k1, <span class="keywordtype">float</span> k2,
<a name="l00109"></a>00109                                             <span class="keywordtype">float</span>* output)
<a name="l00110"></a>00110 {
<a name="l00111"></a>00111   <span class="keywordtype">float</span> w[5];
<a name="l00112"></a>00112   <span class="keywordtype">int</span> n = 0;
<a name="l00113"></a>00113   <span class="keywordflow">for</span> (; n&lt;5; n++)
<a name="l00114"></a>00114     w[n]=input[n];
<a name="l00115"></a>00115   output[0]=k0*w[0]+ 2.0f*(k1*w[1] + k2*w[2]); <span class="comment">// reflect at boundary</span>
<a name="l00116"></a>00116   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> x = 1; x&lt;width; ++x)
<a name="l00117"></a>00117   {
<a name="l00118"></a>00118     output[x]=k0*w[2]+ k1*(w[1]+w[3]) + k2*(w[0]+w[4]);
<a name="l00119"></a>00119     <span class="comment">//shift the window, w, over by two pixels</span>
<a name="l00120"></a>00120     w[0] = w[2];       w[1] = w[3];     w[2] = w[4];
<a name="l00121"></a>00121     <span class="comment">//handle the boundary conditions</span>
<a name="l00122"></a>00122     <span class="keywordflow">if</span> (x+2&lt;width)
<a name="l00123"></a>00123       w[3] = input[n++], w[4] = input[n++];
<a name="l00124"></a>00124     <span class="keywordflow">else</span>
<a name="l00125"></a>00125       w[3] = w[1], w[4] = w[0];
<a name="l00126"></a>00126   }
<a name="l00127"></a>00127 }
<a name="l00128"></a>00128 
<a name="l00129"></a>00129 <span class="comment">//: Downsamples the image by 2 using the Burt-Adelson reduction algorithm.</span>
<a name="l00130"></a>00130 <span class="comment">// Convolution with a 5-point kernel [(0.5-ka)/2, 0.25, ka, 0.25, (0.5-ka)/2]</span>
<a name="l00131"></a>00131 <span class="comment">// ka = 0.6  maximum decorrelation, wavelet for image compression.</span>
<a name="l00132"></a>00132 <span class="comment">// ka = 0.5  linear interpolation,</span>
<a name="l00133"></a>00133 <span class="comment">// ka = 0.4  Gaussian filter</span>
<a name="l00134"></a>00134 <span class="comment">// ka = 0.359375 min aliasing, wider than Gaussian</span>
<a name="l00135"></a>00135 <span class="comment">// The image sizes are related by: output_dimension = (input_dimension +1)/2.</span>
<a name="l00136"></a>00136 <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a>
<a name="l00137"></a><a class="code" href="classbrip__vil__float__ops.html#a7efa8b56fd39a13d958a846286832969">00137</a> <a class="code" href="classbrip__vil__float__ops.html#a7efa8b56fd39a13d958a846286832969" title="downsamples the input using the Bert-Adelson algorithm.">brip_vil_float_ops::half_resolution</a>(<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> <span class="keyword">const</span>&amp; input,
<a name="l00138"></a>00138                                     <span class="keywordtype">float</span> filter_coef)
<a name="l00139"></a>00139 {
<a name="l00140"></a>00140   <a class="codeRef" doxygen="core_vul.tag:../../../../../core/vul/html" href="../../../../../core/vul/html/classvul__timer.html">vul_timer</a> t;
<a name="l00141"></a>00141   <span class="keywordtype">float</span> k0 = filter_coef, k1 = 0.25f*filter_coef, k2 = 0.5f*(0.5f-filter_coef);
<a name="l00142"></a>00142   <span class="keywordtype">unsigned</span> w = input.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a9ea9ad565387a61dccf38fc80a266c2a">ni</a>(), h = input.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a44859c72206da7d18728cb2bbf8ae829">nj</a>();
<a name="l00143"></a>00143   <span class="keywordtype">int</span> half_w =(w+1)/2, half_h = (h+1)/2;
<a name="l00144"></a>00144   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> output;
<a name="l00145"></a>00145   output.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html#a9c01939f01ef50314620e26aaacb04d3">set_size</a>(half_w, half_h);
<a name="l00146"></a>00146   <span class="comment">// Generate input/output arrays</span>
<a name="l00147"></a>00147   <span class="keywordtype">int</span> n = 0;
<a name="l00148"></a>00148   <span class="keywordtype">float</span>* in0 = <span class="keyword">new</span> <span class="keywordtype">float</span>[w];  <span class="keywordtype">float</span>* in1 = <span class="keyword">new</span> <span class="keywordtype">float</span>[w];
<a name="l00149"></a>00149   <span class="keywordtype">float</span>* in2 = <span class="keyword">new</span> <span class="keywordtype">float</span>[w];  <span class="keywordtype">float</span>* in3 = <span class="keyword">new</span> <span class="keywordtype">float</span>[w];
<a name="l00150"></a>00150   <span class="keywordtype">float</span>* in4 = <span class="keyword">new</span> <span class="keywordtype">float</span>[w];
<a name="l00151"></a>00151 
<a name="l00152"></a>00152   <span class="keywordtype">float</span>* out0 = <span class="keyword">new</span> <span class="keywordtype">float</span>[half_w];  <span class="keywordtype">float</span>* out1 = <span class="keyword">new</span> <span class="keywordtype">float</span>[half_w];
<a name="l00153"></a>00153   <span class="keywordtype">float</span>* out2 = <span class="keyword">new</span> <span class="keywordtype">float</span>[half_w];  <span class="keywordtype">float</span>* out3 = <span class="keyword">new</span> <span class="keywordtype">float</span>[half_w];
<a name="l00154"></a>00154   <span class="keywordtype">float</span>* out4 = <span class="keyword">new</span> <span class="keywordtype">float</span>[half_w];
<a name="l00155"></a>00155   <span class="comment">// Initialize arrays</span>
<a name="l00156"></a>00156   fill_1d_array(input, n++, in0);   fill_1d_array(input, n++, in1);
<a name="l00157"></a>00157   fill_1d_array(input, n++, in2);   fill_1d_array(input, n++, in3);
<a name="l00158"></a>00158   fill_1d_array(input, n++, in4);
<a name="l00159"></a>00159 
<a name="l00160"></a>00160   <span class="comment">// downsample initial arrays</span>
<a name="l00161"></a>00161   <a class="code" href="classbrip__vil__float__ops.html#a1296c4f332561b0713b744e8b2398729" title="sub-sample a 1-d array using the Bert-Adelson algorithm.">brip_vil_float_ops::half_resolution_1d</a>(in0, half_w, k0, k1, k2, out0);
<a name="l00162"></a>00162   <a class="code" href="classbrip__vil__float__ops.html#a1296c4f332561b0713b744e8b2398729" title="sub-sample a 1-d array using the Bert-Adelson algorithm.">brip_vil_float_ops::half_resolution_1d</a>(in1, half_w, k0, k1, k2, out1);
<a name="l00163"></a>00163   <a class="code" href="classbrip__vil__float__ops.html#a1296c4f332561b0713b744e8b2398729" title="sub-sample a 1-d array using the Bert-Adelson algorithm.">brip_vil_float_ops::half_resolution_1d</a>(in2, half_w, k0, k1, k2, out2);
<a name="l00164"></a>00164   <a class="code" href="classbrip__vil__float__ops.html#a1296c4f332561b0713b744e8b2398729" title="sub-sample a 1-d array using the Bert-Adelson algorithm.">brip_vil_float_ops::half_resolution_1d</a>(in3, half_w, k0, k1, k2, out3);
<a name="l00165"></a>00165   <a class="code" href="classbrip__vil__float__ops.html#a1296c4f332561b0713b744e8b2398729" title="sub-sample a 1-d array using the Bert-Adelson algorithm.">brip_vil_float_ops::half_resolution_1d</a>(in4, half_w, k0, k1, k2, out4);
<a name="l00166"></a>00166   <span class="keywordtype">int</span> x=0, y;
<a name="l00167"></a>00167   <span class="comment">// do the first output line</span>
<a name="l00168"></a>00168   <span class="keywordflow">for</span> (;x&lt;half_w;x++)
<a name="l00169"></a>00169     output(x,0)= k0*out0[x]+ 2.0f*(k1*out1[x]+k2*out2[x]);
<a name="l00170"></a>00170   <span class="comment">// normal lines</span>
<a name="l00171"></a>00171   <span class="keywordflow">for</span> (y=1; y&lt;half_h; y++)
<a name="l00172"></a>00172   {
<a name="l00173"></a>00173     <span class="keywordflow">for</span> (x=0; x&lt;half_w; x++)
<a name="l00174"></a>00174       output(x,y) = k0*out2[x]+ k1*(out1[x]+out3[x]) + k2*(out0[x]+out4[x]);
<a name="l00175"></a>00175     <span class="comment">//shift the neighborhood down two lines</span>
<a name="l00176"></a>00176     <span class="keywordtype">float</span>* temp0 = out0;
<a name="l00177"></a>00177     <span class="keywordtype">float</span>* temp1 = out1;
<a name="l00178"></a>00178     out0 = out2;  out1 = out3;  out2 = out4;
<a name="l00179"></a>00179     out3 = temp0; out4 = temp1;<span class="comment">//reflect values</span>
<a name="l00180"></a>00180     <span class="comment">//test border condition</span>
<a name="l00181"></a>00181     <span class="keywordflow">if</span> (y&lt;half_h-2)
<a name="l00182"></a>00182     {
<a name="l00183"></a>00183       <span class="comment">//normal processing, so don&#39;t reflect</span>
<a name="l00184"></a>00184       fill_1d_array(input, n++, in3);
<a name="l00185"></a>00185       fill_1d_array(input, n++, in4);
<a name="l00186"></a>00186       <a class="code" href="classbrip__vil__float__ops.html#a1296c4f332561b0713b744e8b2398729" title="sub-sample a 1-d array using the Bert-Adelson algorithm.">brip_vil_float_ops::half_resolution_1d</a>(in3, half_w, k0, k1, k2, out3);
<a name="l00187"></a>00187       <a class="code" href="classbrip__vil__float__ops.html#a1296c4f332561b0713b744e8b2398729" title="sub-sample a 1-d array using the Bert-Adelson algorithm.">brip_vil_float_ops::half_resolution_1d</a>(in4, half_w, k0, k1, k2, out4);
<a name="l00188"></a>00188     }
<a name="l00189"></a>00189   }
<a name="l00190"></a>00190   <span class="keyword">delete</span> [] in0;  <span class="keyword">delete</span> [] in1; <span class="keyword">delete</span> [] in2;
<a name="l00191"></a>00191   <span class="keyword">delete</span> [] in3;  <span class="keyword">delete</span> [] in4;
<a name="l00192"></a>00192   <span class="keyword">delete</span> [] out0;  <span class="keyword">delete</span> [] out1; <span class="keyword">delete</span> [] out2;
<a name="l00193"></a>00193   <span class="keyword">delete</span> [] out3;  <span class="keyword">delete</span> [] out4;
<a name="l00194"></a>00194 <span class="preprocessor">#ifdef DEBUG</span>
<a name="l00195"></a>00195 <span class="preprocessor"></span>  vcl_cout &lt;&lt; <span class="stringliteral">&quot;\nDownsample a &quot;</span>&lt;&lt; w &lt;&lt;<span class="stringliteral">&quot; x &quot;</span> &lt;&lt; h &lt;&lt; <span class="stringliteral">&quot; image in &quot;</span>&lt;&lt; t.<a class="codeRef" doxygen="core_vul.tag:../../../../../core/vul/html" href="../../../../../core/vul/html/classvul__timer.html#a14c86b3c27f36c1946c184941e006370">real</a>() &lt;&lt; <span class="stringliteral">&quot; msecs.\n&quot;</span>;
<a name="l00196"></a>00196 <span class="preprocessor">#endif</span>
<a name="l00197"></a>00197 <span class="preprocessor"></span>  <span class="keywordflow">return</span> output;
<a name="l00198"></a>00198 }
<a name="l00199"></a>00199 
<a name="l00200"></a><a class="code" href="classbrip__vil__float__ops.html#a4ec6b68e96a418eb7da09bdd7c53f23e">00200</a> <span class="keywordtype">void</span> <a class="code" href="classbrip__vil__float__ops.html#a4ec6b68e96a418eb7da09bdd7c53f23e" title="interpolate a 1-d array using the Bert-Adelson algorithm.">brip_vil_float_ops::double_resolution_1d</a>(<span class="keyword">const</span> <span class="keywordtype">float</span>* input, <span class="keyword">const</span> <span class="keywordtype">unsigned</span> n_input,
<a name="l00201"></a>00201                                               <span class="keyword">const</span> <span class="keywordtype">float</span> k0, <span class="keyword">const</span> <span class="keywordtype">float</span> k1,
<a name="l00202"></a>00202                                               <span class="keyword">const</span> <span class="keywordtype">float</span> k2, <span class="keywordtype">float</span>* output)
<a name="l00203"></a>00203 {
<a name="l00204"></a>00204   <span class="keywordtype">float</span> w[3];
<a name="l00205"></a>00205   <span class="keywordtype">unsigned</span> i = 0;
<a name="l00206"></a>00206   w[1]=input[i]; w[2]=input[i++];
<a name="l00207"></a>00207   w[0]=w[2];
<a name="l00208"></a>00208   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> c = 0; c&lt;2*n_input; c+=2)
<a name="l00209"></a>00209   {
<a name="l00210"></a>00210     output[c] = k0*w[1] + k2*(w[0]+w[2]);
<a name="l00211"></a>00211     output[c+1] = k1*(w[1]+w[2]);
<a name="l00212"></a>00212     w[0]=w[1];
<a name="l00213"></a>00213     w[1]=w[2];
<a name="l00214"></a>00214     <span class="keywordflow">if</span> (c&lt;2*(n_input-2))
<a name="l00215"></a>00215       w[2]=input[i++];
<a name="l00216"></a>00216     <span class="keywordflow">else</span>
<a name="l00217"></a>00217       w[2]=w[0];
<a name="l00218"></a>00218   }
<a name="l00219"></a>00219 }
<a name="l00220"></a>00220 
<a name="l00221"></a>00221 <span class="comment">//: interpolates the input using the Bert-Adelson algorithm</span>
<a name="l00222"></a>00222 <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a>
<a name="l00223"></a><a class="code" href="classbrip__vil__float__ops.html#a259b8032b69c8b7b57bc4171d9580fff">00223</a> <a class="code" href="classbrip__vil__float__ops.html#a259b8032b69c8b7b57bc4171d9580fff" title="interpolates the input using the Bert-Adelson algorithm.">brip_vil_float_ops::double_resolution</a>(<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> <span class="keyword">const</span>&amp; input,
<a name="l00224"></a>00224                                       <span class="keywordtype">float</span> filter_coef)
<a name="l00225"></a>00225 {
<a name="l00226"></a>00226   <span class="keywordtype">unsigned</span> ni_in = input.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a9ea9ad565387a61dccf38fc80a266c2a">ni</a>();
<a name="l00227"></a>00227   <span class="keywordtype">unsigned</span> nj_in = input.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a44859c72206da7d18728cb2bbf8ae829">nj</a>();
<a name="l00228"></a>00228   <span class="keywordtype">unsigned</span> ni_out = 2*ni_in;
<a name="l00229"></a>00229   <span class="keywordtype">unsigned</span> nj_out = 2*nj_in;
<a name="l00230"></a>00230   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> out(ni_out, nj_out);
<a name="l00231"></a>00231   <span class="keywordtype">float</span>* input_1d = <span class="keyword">new</span> <span class="keywordtype">float</span>[ni_in];
<a name="l00232"></a>00232 
<a name="l00233"></a>00233   <span class="comment">// An interpolation neighborhood of three lines</span>
<a name="l00234"></a>00234   <span class="keywordtype">float</span>* output0 = <span class="keyword">new</span> <span class="keywordtype">float</span>[ni_out];
<a name="l00235"></a>00235   <span class="keywordtype">float</span>* output1 = <span class="keyword">new</span> <span class="keywordtype">float</span>[ni_out];
<a name="l00236"></a>00236   <span class="keywordtype">float</span>* output2 = <span class="keyword">new</span> <span class="keywordtype">float</span>[ni_out];
<a name="l00237"></a>00237 
<a name="l00238"></a>00238   <span class="comment">// The filter coefficients</span>
<a name="l00239"></a>00239   <span class="keywordtype">float</span> k0 = filter_coef*2.0f;
<a name="l00240"></a>00240   <span class="keywordtype">float</span> k1 = 0.5f;
<a name="l00241"></a>00241   <span class="keywordtype">float</span> k2 = 0.5f-filter_coef;
<a name="l00242"></a>00242 
<a name="l00243"></a>00243   <span class="comment">// initialize</span>
<a name="l00244"></a>00244   <span class="keywordtype">unsigned</span> i = 0;
<a name="l00245"></a>00245   fill_1d_array(input, i++, input_1d);
<a name="l00246"></a>00246   <a class="code" href="classbrip__vil__float__ops.html#a4ec6b68e96a418eb7da09bdd7c53f23e" title="interpolate a 1-d array using the Bert-Adelson algorithm.">brip_vil_float_ops::double_resolution_1d</a>(input_1d, ni_in, k0, k1, k2, output1);
<a name="l00247"></a>00247   fill_1d_array(input, i++, input_1d);
<a name="l00248"></a>00248   <a class="code" href="classbrip__vil__float__ops.html#a4ec6b68e96a418eb7da09bdd7c53f23e" title="interpolate a 1-d array using the Bert-Adelson algorithm.">brip_vil_float_ops::double_resolution_1d</a>(input_1d, ni_in, k0, k1, k2, output2);
<a name="l00249"></a>00249   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> k = 0; k&lt;ni_out; ++k)
<a name="l00250"></a>00250     output0[k]=output2[k];
<a name="l00251"></a>00251   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> r = 0; r&lt;nj_out; r+=2)
<a name="l00252"></a>00252   {
<a name="l00253"></a>00253     <span class="keywordtype">unsigned</span> rp = r+1;
<a name="l00254"></a>00254     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> c=0; c&lt;ni_out; ++c)
<a name="l00255"></a>00255     {
<a name="l00256"></a>00256       out(c, r) = k0*output1[c] + k2*(output0[c]+output2[c]);
<a name="l00257"></a>00257       out(c, rp) = k1*(output1[c]+output2[c]);
<a name="l00258"></a>00258     }
<a name="l00259"></a>00259     <span class="keywordtype">float</span>* next = output0;
<a name="l00260"></a>00260     output0 = output1;
<a name="l00261"></a>00261     output1 = output2;
<a name="l00262"></a>00262     output2 = next;
<a name="l00263"></a>00263     <span class="keywordflow">if</span> (r&lt;nj_out-4)
<a name="l00264"></a>00264     {
<a name="l00265"></a>00265       fill_1d_array(input, i++, input_1d);
<a name="l00266"></a>00266       <a class="code" href="classbrip__vil__float__ops.html#a4ec6b68e96a418eb7da09bdd7c53f23e" title="interpolate a 1-d array using the Bert-Adelson algorithm.">brip_vil_float_ops::double_resolution_1d</a>(input_1d, ni_in,
<a name="l00267"></a>00267                                                k0, k1, k2, output2);
<a name="l00268"></a>00268     }
<a name="l00269"></a>00269     <span class="keywordflow">else</span>
<a name="l00270"></a>00270       <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> k = 0; k&lt;ni_out; ++k)
<a name="l00271"></a>00271         output2[k]=output0[k];
<a name="l00272"></a>00272   }
<a name="l00273"></a>00273   <span class="keyword">delete</span> [] input_1d;
<a name="l00274"></a>00274   <span class="keyword">delete</span> [] output0;
<a name="l00275"></a>00275   <span class="keyword">delete</span> [] output1;
<a name="l00276"></a>00276   <span class="keyword">delete</span> [] output2;
<a name="l00277"></a>00277   <span class="keywordflow">return</span> out;
<a name="l00278"></a>00278 }
<a name="l00279"></a>00279 
<a name="l00280"></a>00280 <span class="keyword">static</span> <span class="keywordtype">double</span> brip_vil_gaussian(<span class="keywordtype">double</span> x, <span class="keywordtype">double</span> sigma)
<a name="l00281"></a>00281 {
<a name="l00282"></a>00282   <span class="keywordtype">double</span> x_on_sigma = x / sigma;
<a name="l00283"></a>00283   <span class="keywordflow">return</span> (<span class="keywordtype">double</span>)vcl_exp(- x_on_sigma * x_on_sigma / 2);
<a name="l00284"></a>00284 }
<a name="l00285"></a>00285 
<a name="l00286"></a><a class="code" href="classbrip__vil__float__ops.html#a552ca3b4bd3e17dd90363805aad73639">00286</a> <span class="keywordtype">unsigned</span> <a class="code" href="classbrip__vil__float__ops.html#a552ca3b4bd3e17dd90363805aad73639" title="helper to determine processing border required by Gaussian smoothing.">brip_vil_float_ops::gaussian_radius</a>(<span class="keyword">const</span> <span class="keywordtype">double</span> sigma,
<a name="l00287"></a>00287                                              <span class="keyword">const</span> <span class="keywordtype">double</span> fuzz)
<a name="l00288"></a>00288 {
<a name="l00289"></a>00289   <span class="keywordtype">unsigned</span> radius = 0;
<a name="l00290"></a>00290   <span class="keywordflow">while</span> ((<span class="keywordtype">float</span>)brip_vil_gaussian((<span class="keywordtype">double</span>)radius, sigma) &gt; fuzz) ++radius;
<a name="l00291"></a>00291   <span class="keywordflow">return</span> radius;
<a name="l00292"></a>00292 }
<a name="l00293"></a>00293 
<a name="l00294"></a>00294 <span class="comment">//: generate a 1-d Gaussian kernel  fuzz=0.02 is a good value</span>
<a name="l00295"></a>00295 <span class="keyword">static</span> <span class="keywordtype">void</span> brip_1d_gaussian_kernel(<span class="keywordtype">double</span> sigma, <span class="keywordtype">double</span> fuzz,
<a name="l00296"></a>00296                                     <span class="keywordtype">unsigned</span>&amp; radius, <span class="keywordtype">double</span>*&amp; kernel)
<a name="l00297"></a>00297 {
<a name="l00298"></a>00298   radius = <a class="code" href="classbrip__vil__float__ops.html#a552ca3b4bd3e17dd90363805aad73639" title="helper to determine processing border required by Gaussian smoothing.">brip_vil_float_ops::gaussian_radius</a>(sigma, fuzz);
<a name="l00299"></a>00299 
<a name="l00300"></a>00300   kernel = <span class="keyword">new</span> <span class="keywordtype">double</span>[2*radius + 1];
<a name="l00301"></a>00301   <span class="keywordflow">if</span> (!radius)
<a name="l00302"></a>00302   {
<a name="l00303"></a>00303     kernel[0]=1;
<a name="l00304"></a>00304     <span class="keywordflow">return</span>;
<a name="l00305"></a>00305   }
<a name="l00306"></a>00306   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> i=0; i&lt;=radius; ++i)
<a name="l00307"></a>00307     kernel[radius+i] = kernel[radius-i] = brip_vil_gaussian(<span class="keywordtype">double</span>(i), sigma);
<a name="l00308"></a>00308   <span class="keywordtype">double</span> sum = 0;
<a name="l00309"></a>00309   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> i= 0; i &lt;= 2*radius; ++i)
<a name="l00310"></a>00310     sum += kernel[i];                           <span class="comment">// find integral of weights</span>
<a name="l00311"></a>00311   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> i= 0; i &lt;= 2*radius; ++i)
<a name="l00312"></a>00312     kernel[i] /= sum;                           <span class="comment">// normalize by integral</span>
<a name="l00313"></a>00313 }
<a name="l00314"></a>00314 
<a name="l00315"></a>00315 <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a>
<a name="l00316"></a><a class="code" href="classbrip__vil__float__ops.html#a2c82165db7e252f7b843f61f5856dc3f">00316</a> <a class="code" href="classbrip__vil__float__ops.html#a2c82165db7e252f7b843f61f5856dc3f" title="convolves with a Gaussian kernel.">brip_vil_float_ops::gaussian</a>(<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> <span class="keyword">const</span>&amp; input, <span class="keywordtype">float</span> sigma,
<a name="l00317"></a>00317                              <span class="keywordtype">float</span> fill)
<a name="l00318"></a>00318 {
<a name="l00319"></a>00319   <span class="keywordtype">unsigned</span> ni = input.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a9ea9ad565387a61dccf38fc80a266c2a">ni</a>(), nj = input.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a44859c72206da7d18728cb2bbf8ae829">nj</a>();
<a name="l00320"></a>00320   <span class="keywordtype">unsigned</span> np = input.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#adb221bda92a1c0f7f4842af116428b11">nplanes</a>();
<a name="l00321"></a>00321   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> dest(ni, nj, np);
<a name="l00322"></a>00322   dest.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html#a6fd591632020e490abb5e4493a52dbba">fill</a>(fill);
<a name="l00323"></a>00323   <span class="keywordtype">unsigned</span> r;
<a name="l00324"></a>00324   <span class="keywordtype">double</span>* ker;
<a name="l00325"></a>00325   brip_1d_gaussian_kernel(sigma, 0.02, r, ker);
<a name="l00326"></a>00326   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> p = 0; p&lt;np; ++p) {
<a name="l00327"></a>00327     <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> input_temp(ni, nj);
<a name="l00328"></a>00328     <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> out_temp(ni, nj);
<a name="l00329"></a>00329     <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> work(ni, nj);
<a name="l00330"></a>00330     work.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html#a6fd591632020e490abb5e4493a52dbba">fill</a>(fill);
<a name="l00331"></a>00331     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> j = 0; j&lt;nj; ++j)
<a name="l00332"></a>00332       <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> i = 0; i&lt;ni; ++i)
<a name="l00333"></a>00333         input_temp(i,j) = input(i,j,p);
<a name="l00334"></a>00334 
<a name="l00335"></a>00335     <span class="comment">// filter horizontal</span>
<a name="l00336"></a>00336     <span class="keywordtype">int</span> ksize = 2*r + 1 ;
<a name="l00337"></a>00337     <span class="keywordtype">float</span> accum=0.0f;
<a name="l00338"></a>00338     <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/vil__convolve__1d_8h.html#abd5143d33805b11a63369846c49621e5">vil_convolve_1d</a>(input_temp, work, ker + ksize/2,
<a name="l00339"></a>00339                     -ksize/2, r, accum,
<a name="l00340"></a>00340                     <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/vil__convolve__1d_8h.html#a64c41449c63ff20f514c786e54ab3528a01e1098fdd35520e970e2c7ffaa15146">vil_convolve_ignore_edge</a>,
<a name="l00341"></a>00341                     <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/vil__convolve__1d_8h.html#a64c41449c63ff20f514c786e54ab3528a01e1098fdd35520e970e2c7ffaa15146">vil_convolve_ignore_edge</a>);
<a name="l00342"></a>00342 
<a name="l00343"></a>00343     <span class="comment">// filter vertical</span>
<a name="l00344"></a>00344     <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> work_t = <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/vil__transpose_8cxx.html#a5e2a9d27d382508b6e700e75f69246c2">vil_transpose</a>(work);
<a name="l00345"></a>00345     <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> out_temp_t = <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/vil__transpose_8cxx.html#a5e2a9d27d382508b6e700e75f69246c2">vil_transpose</a>(dest);
<a name="l00346"></a>00346     <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/vil__convolve__1d_8h.html#abd5143d33805b11a63369846c49621e5">vil_convolve_1d</a>(work_t, out_temp_t, ker+ ksize/2,
<a name="l00347"></a>00347                     -ksize/2, r, accum,
<a name="l00348"></a>00348                     <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/vil__convolve__1d_8h.html#a64c41449c63ff20f514c786e54ab3528a01e1098fdd35520e970e2c7ffaa15146">vil_convolve_ignore_edge</a>,
<a name="l00349"></a>00349                     <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/vil__convolve__1d_8h.html#a64c41449c63ff20f514c786e54ab3528a01e1098fdd35520e970e2c7ffaa15146">vil_convolve_ignore_edge</a>);
<a name="l00350"></a>00350     <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> plane = <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/vil__transpose_8cxx.html#a5e2a9d27d382508b6e700e75f69246c2">vil_transpose</a>(out_temp_t);
<a name="l00351"></a>00351     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> j = 0; j&lt;nj; ++j)
<a name="l00352"></a>00352       <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> i = 0; i&lt;ni; ++i)
<a name="l00353"></a>00353         dest(i,j,p) = plane(i,j);
<a name="l00354"></a>00354   }
<a name="l00355"></a>00355   <span class="keyword">delete</span> ker;
<a name="l00356"></a>00356   <span class="keywordflow">return</span> dest;
<a name="l00357"></a>00357 }
<a name="l00358"></a>00358 
<a name="l00359"></a>00359 <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a>
<a name="l00360"></a><a class="code" href="classbrip__vil__float__ops.html#a44aed7385a137fb616f467e7a3ad7006">00360</a> <a class="code" href="classbrip__vil__float__ops.html#a44aed7385a137fb616f467e7a3ad7006" title="computes absolute value.">brip_vil_float_ops::absolute_value</a>(<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> <span class="keyword">const</span>&amp; input)
<a name="l00361"></a>00361 {
<a name="l00362"></a>00362   <span class="keywordtype">unsigned</span> ni = input.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a9ea9ad565387a61dccf38fc80a266c2a">ni</a>(), nj = input.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a44859c72206da7d18728cb2bbf8ae829">nj</a>();
<a name="l00363"></a>00363   <span class="keywordtype">unsigned</span> np = input.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#adb221bda92a1c0f7f4842af116428b11">nplanes</a>();
<a name="l00364"></a>00364   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> dest(ni, nj, np);
<a name="l00365"></a>00365   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> p = 0; p&lt;np; ++p)
<a name="l00366"></a>00366     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> j = 0; j&lt;nj; ++j)
<a name="l00367"></a>00367       <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> i = 0; i&lt;ni; ++i)
<a name="l00368"></a>00368         dest(i,j,p) = vcl_fabs(input(i,j,p));
<a name="l00369"></a>00369   <span class="keywordflow">return</span> dest;
<a name="l00370"></a>00370 }
<a name="l00371"></a>00371 
<a name="l00372"></a>00372 <span class="preprocessor">#ifdef VIL_CONVOLVE_WITH_MASK_EXISTS // TODO</span>
<a name="l00373"></a>00373 <span class="preprocessor"></span><a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a>
<a name="l00374"></a>00374 <a class="code" href="classbrip__vil__float__ops.html#a2c82165db7e252f7b843f61f5856dc3f" title="convolves with a Gaussian kernel.">brip_vil_float_ops::gaussian</a>(<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> <span class="keyword">const</span>&amp; input,
<a name="l00375"></a>00375                              <span class="keywordtype">float</span> sigma,
<a name="l00376"></a>00376                              <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> <span class="keyword">const</span>&amp; mask)
<a name="l00377"></a>00377 {
<a name="l00378"></a>00378   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> dest(input.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a9ea9ad565387a61dccf38fc80a266c2a">ni</a>(), input.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a44859c72206da7d18728cb2bbf8ae829">nj</a>());
<a name="l00379"></a>00379 
<a name="l00380"></a>00380   <span class="keywordtype">int</span> r;
<a name="l00381"></a>00381   <span class="keywordtype">double</span>* ker;
<a name="l00382"></a>00382   brip_1d_gaussian_kernel(sigma, 0.02, r, ker);
<a name="l00383"></a>00383   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> work(input.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a9ea9ad565387a61dccf38fc80a266c2a">ni</a>(), input.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a44859c72206da7d18728cb2bbf8ae829">nj</a>());
<a name="l00384"></a>00384   work.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html#a24e151a6f4b19094049923a42a0549e8">deep_copy</a>(input);
<a name="l00385"></a>00385   <span class="comment">// filter horizontal</span>
<a name="l00386"></a>00386   <span class="keywordtype">int</span> ksize = 2*r + 1 ;
<a name="l00387"></a>00387   <span class="keywordtype">float</span> accum=0.0f;
<a name="l00388"></a>00388   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/vil__convolve__1d_8h.html#abd5143d33805b11a63369846c49621e5">vil_convolve_1d</a>(input, work, mask, ker + ksize/2,
<a name="l00389"></a>00389                   -ksize/2, r, accum,
<a name="l00390"></a>00390                   vil_convolve_trim,
<a name="l00391"></a>00391                   vil_convolve_trim);
<a name="l00392"></a>00392 
<a name="l00393"></a>00393   <span class="comment">// filter vertical</span>
<a name="l00394"></a>00394   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> work_t = <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/vil__transpose_8cxx.html#a5e2a9d27d382508b6e700e75f69246c2">vil_transpose</a>(work);
<a name="l00395"></a>00395   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> dest_t = <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/vil__transpose_8cxx.html#a5e2a9d27d382508b6e700e75f69246c2">vil_transpose</a>(dest);
<a name="l00396"></a>00396   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/vil__convolve__1d_8h.html#abd5143d33805b11a63369846c49621e5">vil_convolve_1d</a>(work_t, dest_t, <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/vil__transpose_8cxx.html#a5e2a9d27d382508b6e700e75f69246c2">vil_transpose</a>(mask), ker+ ksize/2,
<a name="l00397"></a>00397                   -ksize/2, r, accum,
<a name="l00398"></a>00398                   vil_convolve_constant_extend,
<a name="l00399"></a>00399                   vil_convolve_constant_extend);
<a name="l00400"></a>00400 
<a name="l00401"></a>00401   <span class="keyword">delete</span> ker;
<a name="l00402"></a>00402   <span class="keywordflow">return</span> dest;
<a name="l00403"></a>00403 }
<a name="l00404"></a>00404 
<a name="l00405"></a>00405 <span class="preprocessor">#endif // VIL_CONVOLVE_WITH_MASK_EXISTS</span>
<a name="l00406"></a>00406 <span class="preprocessor"></span>
<a name="l00407"></a>00407 <span class="comment">//-------------------------------------------------------------------</span>
<a name="l00408"></a>00408 <span class="comment">//: Determine if the center of a (2n+1)x(2n+1) neighborhood is a local maximum</span>
<a name="l00409"></a>00409 <span class="comment">//</span>
<a name="l00410"></a>00410 <span class="keywordtype">bool</span> <a class="code" href="classbrip__vil__float__ops.html#a5a19cc7a9d2a4d99240c32e620a8cb4f" title="find if the center pixel of a neighborhood is the maximum value.">brip_vil_float_ops::</a>
<a name="l00411"></a><a class="code" href="classbrip__vil__float__ops.html#a5a19cc7a9d2a4d99240c32e620a8cb4f">00411</a> <a class="code" href="classbrip__vil__float__ops.html#a5a19cc7a9d2a4d99240c32e620a8cb4f" title="find if the center pixel of a neighborhood is the maximum value.">local_maximum</a>(<a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__array__2d.html">vbl_array_2d&lt;float&gt;</a> <span class="keyword">const</span>&amp; neighborhood, <span class="keywordtype">int</span> n, <span class="keywordtype">float</span>&amp; value)
<a name="l00412"></a>00412 {
<a name="l00413"></a>00413   <span class="keywordtype">bool</span> local_max = <span class="keyword">true</span>;
<a name="l00414"></a>00414   value = 0;
<a name="l00415"></a>00415   <span class="keywordtype">float</span> center = neighborhood[n][n];
<a name="l00416"></a>00416   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> y = -n; y&lt;=n; y++)
<a name="l00417"></a>00417     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> x = -n; x&lt;=n; x++)
<a name="l00418"></a>00418       local_max = local_max&amp;&amp;(neighborhood[y+n][x+n]&lt;=center);
<a name="l00419"></a>00419   <span class="keywordflow">if</span> (!local_max)
<a name="l00420"></a>00420     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00421"></a>00421   value = center;
<a name="l00422"></a>00422   <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00423"></a>00423 }
<a name="l00424"></a>00424 
<a name="l00425"></a>00425 <span class="comment">//-------------------------------------------------------------------</span>
<a name="l00426"></a>00426 <span class="comment">// Interpolate the sub-pixel position of a neighborhood using a</span>
<a name="l00427"></a>00427 <span class="comment">// second order expansion on a 3x3 sub-neighborhood. Return the</span>
<a name="l00428"></a>00428 <span class="comment">// offset to the maximum, i.e. x=x0+dx, y = y0+dy. The design is</span>
<a name="l00429"></a>00429 <span class="comment">// similar to the droid counterpoint by fsm, which uses the Beaudet Hessian</span>
<a name="l00430"></a>00430 <span class="comment">//</span>
<a name="l00431"></a>00431 <span class="keywordtype">void</span> <a class="code" href="classbrip__vil__float__ops.html#a7344da3428f1103cb643e4dcaf3d3e38" title="find the sub-pixel offset to the maximum using a 3x3 quad interpolation.">brip_vil_float_ops::</a>
<a name="l00432"></a><a class="code" href="classbrip__vil__float__ops.html#a7344da3428f1103cb643e4dcaf3d3e38">00432</a> <a class="code" href="classbrip__vil__float__ops.html#a7344da3428f1103cb643e4dcaf3d3e38" title="find the sub-pixel offset to the maximum using a 3x3 quad interpolation.">interpolate_center</a>(<a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__array__2d.html">vbl_array_2d&lt;float&gt;</a><span class="keyword">const</span>&amp; neighborhood, <span class="keywordtype">float</span>&amp; dx, <span class="keywordtype">float</span>&amp; dy)
<a name="l00433"></a>00433 {
<a name="l00434"></a>00434   dx = 0; dy=0;
<a name="l00435"></a>00435   <span class="comment">// extract the neighborhood</span>
<a name="l00436"></a>00436   <span class="keywordtype">float</span> n_m1_m1 = neighborhood[0][0];
<a name="l00437"></a>00437   <span class="keywordtype">float</span> n_m1_0 = neighborhood[0][1];
<a name="l00438"></a>00438   <span class="keywordtype">float</span> n_m1_1 = neighborhood[0][2];
<a name="l00439"></a>00439   <span class="keywordtype">float</span> n_0_m1 = neighborhood[1][0];
<a name="l00440"></a>00440   <span class="keywordtype">float</span> n_0_0 = neighborhood[1][1];
<a name="l00441"></a>00441   <span class="keywordtype">float</span> n_0_1 = neighborhood[1][2];
<a name="l00442"></a>00442   <span class="keywordtype">float</span> n_1_m1 = neighborhood[2][0];
<a name="l00443"></a>00443   <span class="keywordtype">float</span> n_1_0 = neighborhood[2][1];
<a name="l00444"></a>00444   <span class="keywordtype">float</span> n_1_1 = neighborhood[2][2];
<a name="l00445"></a>00445 
<a name="l00446"></a>00446   <span class="comment">// Compute the 2nd order quadratic coefficients</span>
<a name="l00447"></a>00447   <span class="comment">//      1/6 * [ -1  0 +1 ]</span>
<a name="l00448"></a>00448   <span class="comment">// Ix =       [ -1  0 +1 ]</span>
<a name="l00449"></a>00449   <span class="comment">//            [ -1  0 +1 ]</span>
<a name="l00450"></a>00450   <span class="keywordtype">float</span> Ix =(-n_m1_m1+n_m1_1-n_0_m1+n_0_1-n_1_m1+n_1_1)/6.0f;
<a name="l00451"></a>00451   <span class="comment">//      1/6 * [ -1 -1 -1 ]</span>
<a name="l00452"></a>00452   <span class="comment">// Iy =       [  0  0  0 ]</span>
<a name="l00453"></a>00453   <span class="comment">//            [ +1 +1 +1 ]</span>
<a name="l00454"></a>00454   <span class="keywordtype">float</span> Iy =(-n_m1_m1-n_m1_0-n_m1_1+n_1_m1+n_1_0+n_1_1)/6.0f;
<a name="l00455"></a>00455   <span class="comment">//      1/3 * [ +1 -2 +1 ]</span>
<a name="l00456"></a>00456   <span class="comment">// Ixx =      [ +1 -2 +1 ]</span>
<a name="l00457"></a>00457   <span class="comment">//            [ +1 -2 +1 ]</span>
<a name="l00458"></a>00458   <span class="keywordtype">float</span> Ixx = ((n_m1_m1+n_0_m1+n_1_m1+n_m1_1+n_0_1+n_1_1)
<a name="l00459"></a>00459                -2.0f*(n_m1_0+n_0_0+n_1_0))/3.0f;
<a name="l00460"></a>00460   <span class="comment">//      1/4 * [ +1  0 -1 ]</span>
<a name="l00461"></a>00461   <span class="comment">// Ixy =      [  0  0  0 ]</span>
<a name="l00462"></a>00462   <span class="comment">//            [ -1  0 +1 ]</span>
<a name="l00463"></a>00463   <span class="keywordtype">float</span> Ixy = (n_m1_m1-n_m1_1+n_1_m1+n_1_1)/4.0f;
<a name="l00464"></a>00464   <span class="comment">//      1/3 * [ +1 +1 +1 ]</span>
<a name="l00465"></a>00465   <span class="comment">// Iyy =      [ -2 -2 -2 ]</span>
<a name="l00466"></a>00466   <span class="comment">//            [ +1 +1 +1 ]</span>
<a name="l00467"></a>00467   <span class="keywordtype">float</span> Iyy = ((n_m1_m1+n_m1_0+n_m1_1+n_1_m1+n_1_0+n_1_1)
<a name="l00468"></a>00468                -2.0f*(n_0_m1 + n_0_0 + n_1_0))/3.0f;
<a name="l00469"></a>00469   <span class="comment">//</span>
<a name="l00470"></a>00470   <span class="comment">// The next bit is to find the extremum of the fitted surface by setting its</span>
<a name="l00471"></a>00471   <span class="comment">// partial derivatives to zero. We need to solve the following linear system :</span>
<a name="l00472"></a>00472   <span class="comment">// Given the fitted surface is</span>
<a name="l00473"></a>00473   <span class="comment">// I(x,y) = Io + Ix x + Iy y + 1/2 Ixx x^2 + Ixy x y + 1/2 Iyy y^2</span>
<a name="l00474"></a>00474   <span class="comment">// we solve for the maximum (x,y),</span>
<a name="l00475"></a>00475   <span class="comment">//</span>
<a name="l00476"></a>00476   <span class="comment">//  [ Ixx Ixy ] [ dx ] + [ Ix ] = [ 0 ]      (dI/dx = 0)</span>
<a name="l00477"></a>00477   <span class="comment">//  [ Ixy Iyy ] [ dy ]   [ Iy ]   [ 0 ]      (dI/dy = 0)</span>
<a name="l00478"></a>00478   <span class="comment">//</span>
<a name="l00479"></a>00479   <span class="keywordtype">float</span> det = Ixx*Iyy - Ixy*Ixy;
<a name="l00480"></a>00480   <span class="comment">// det&gt;0 corresponds to a true local extremum otherwise a saddle point</span>
<a name="l00481"></a>00481   <span class="keywordflow">if</span> (det&gt;0)
<a name="l00482"></a>00482   {
<a name="l00483"></a>00483     dx = (Iy*Ixy - Ix*Iyy) / det;
<a name="l00484"></a>00484     dy = (Ix*Ixy - Iy*Ixx) / det;
<a name="l00485"></a>00485     <span class="comment">// more than one pixel away</span>
<a name="l00486"></a>00486     <span class="keywordflow">if</span> (vcl_fabs(dx) &gt; 1.0 || vcl_fabs(dy) &gt; 1.0)
<a name="l00487"></a>00487       dx = 0; dy = 0;
<a name="l00488"></a>00488   }
<a name="l00489"></a>00489 }
<a name="l00490"></a>00490 
<a name="l00491"></a>00491 <span class="comment">//---------------------------------------------------------------</span>
<a name="l00492"></a>00492 <span class="comment">// Compute the local maxima of the input on a (2n+1)x(2n+2)</span>
<a name="l00493"></a>00493 <span class="comment">// neighborhood above the given threshold. At each local maximum,</span>
<a name="l00494"></a>00494 <span class="comment">// compute the sub-pixel location, (x_pos, y_pos).</span>
<a name="l00495"></a>00495 <span class="keywordtype">void</span> <a class="code" href="classbrip__vil__float__ops.html#a22c6f9fcaf4f6bd0d1624fea0c49d33a" title="non-maximum suppression on a NxN neighborhood, with sub-pixel location.">brip_vil_float_ops::</a>
<a name="l00496"></a><a class="code" href="classbrip__vil__float__ops.html#a22c6f9fcaf4f6bd0d1624fea0c49d33a">00496</a> <a class="code" href="classbrip__vil__float__ops.html#a22c6f9fcaf4f6bd0d1624fea0c49d33a" title="non-maximum suppression on a NxN neighborhood, with sub-pixel location.">non_maximum_suppression</a>(<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> <span class="keyword">const</span>&amp; input,
<a name="l00497"></a>00497                         <span class="keywordtype">int</span> n, <span class="keywordtype">float</span> thresh,
<a name="l00498"></a>00498                         vcl_vector&lt;float&gt;&amp; x_pos,
<a name="l00499"></a>00499                         vcl_vector&lt;float&gt;&amp; y_pos,
<a name="l00500"></a>00500                         vcl_vector&lt;float&gt;&amp; value)
<a name="l00501"></a>00501 {
<a name="l00502"></a>00502   <a class="codeRef" doxygen="core_vul.tag:../../../../../core/vul/html" href="../../../../../core/vul/html/classvul__timer.html">vul_timer</a> t;
<a name="l00503"></a>00503   <span class="keywordtype">int</span> N = 2*n+1;
<a name="l00504"></a>00504   <span class="keywordtype">int</span> w = <span class="keyword">static_cast&lt;</span><span class="keywordtype">int</span><span class="keyword">&gt;</span>(input.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a9ea9ad565387a61dccf38fc80a266c2a">ni</a>()), h = static_cast&lt;int&gt;(input.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a44859c72206da7d18728cb2bbf8ae829">nj</a>());
<a name="l00505"></a>00505   x_pos.clear();  x_pos.clear();   value.clear();
<a name="l00506"></a>00506   <a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__array__2d.html">vbl_array_2d&lt;float&gt;</a> neighborhood(N,N);
<a name="l00507"></a>00507   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> y =n; y&lt;h-n; y++)
<a name="l00508"></a>00508     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> x = n; x&lt;w-n; x++)
<a name="l00509"></a>00509     {
<a name="l00510"></a>00510       <span class="comment">//If the center is not above threshold then there is</span>
<a name="l00511"></a>00511       <span class="comment">//no hope</span>
<a name="l00512"></a>00512       <span class="keywordflow">if</span> (input(x,y)&lt;thresh)
<a name="l00513"></a>00513         <span class="keywordflow">continue</span>;
<a name="l00514"></a>00514       <span class="comment">//Fill the neighborhood</span>
<a name="l00515"></a>00515       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = -n; i&lt;=n; i++)
<a name="l00516"></a>00516         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = -n; j&lt;=n; j++)
<a name="l00517"></a>00517           neighborhood.<a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__array__2d.html#a67eebbfbe4e8a3b8822abf94f35ceb43">put</a>(j+n,i+n,input(x+i, y+j));
<a name="l00518"></a>00518       <span class="comment">//Check if the center is a local maximum</span>
<a name="l00519"></a>00519       <span class="keywordtype">float</span> dx, dy, max_v;
<a name="l00520"></a>00520       <span class="keywordflow">if</span> (<a class="code" href="classbrip__vil__float__ops.html#a5a19cc7a9d2a4d99240c32e620a8cb4f" title="find if the center pixel of a neighborhood is the maximum value.">brip_vil_float_ops::local_maximum</a>(neighborhood, n, max_v))
<a name="l00521"></a>00521       {
<a name="l00522"></a>00522         <span class="comment">//if so sub-pixel interpolate (3x3) and output results</span>
<a name="l00523"></a>00523         <a class="code" href="classbrip__vil__float__ops.html#a7344da3428f1103cb643e4dcaf3d3e38" title="find the sub-pixel offset to the maximum using a 3x3 quad interpolation.">brip_vil_float_ops::interpolate_center</a>(neighborhood, dx, dy);
<a name="l00524"></a>00524         x_pos.push_back((<span class="keywordtype">float</span>)x+dx);
<a name="l00525"></a>00525         y_pos.push_back((<span class="keywordtype">float</span>)y+dy);
<a name="l00526"></a>00526         value.push_back(max_v);
<a name="l00527"></a>00527       }
<a name="l00528"></a>00528     }
<a name="l00529"></a>00529 <span class="preprocessor">#ifdef DEBUG</span>
<a name="l00530"></a>00530 <span class="preprocessor"></span>  vcl_cout &lt;&lt; <span class="stringliteral">&quot;\nCompute non-maximum suppression on a &quot;</span>&lt;&lt; w &lt;&lt;<span class="stringliteral">&quot; x &quot;</span> &lt;&lt; h &lt;&lt; <span class="stringliteral">&quot; image in &quot;</span>&lt;&lt; t.<a class="codeRef" doxygen="core_vul.tag:../../../../../core/vul/html" href="../../../../../core/vul/html/classvul__timer.html#a14c86b3c27f36c1946c184941e006370">real</a>() &lt;&lt; <span class="stringliteral">&quot; msecs.\n&quot;</span>;
<a name="l00531"></a>00531 <span class="preprocessor">#endif</span>
<a name="l00532"></a>00532 <span class="preprocessor"></span>}
<a name="l00533"></a>00533 
<a name="l00534"></a>00534 <span class="comment">// -----------------------------------------------------------------</span>
<a name="l00535"></a>00535 <span class="comment">//: Subtract image_1 from image_2.</span>
<a name="l00536"></a>00536 <span class="comment">// Will not operate unless the two input images are the same dimensions</span>
<a name="l00537"></a>00537 <span class="comment">//</span>
<a name="l00538"></a>00538 <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a>
<a name="l00539"></a><a class="code" href="classbrip__vil__float__ops.html#a8a34499b91e321beff2beb67d131aac7">00539</a> <a class="code" href="classbrip__vil__float__ops.html#a8a34499b91e321beff2beb67d131aac7" title="subtracts image_1 from image_2.">brip_vil_float_ops::difference</a>(<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> <span class="keyword">const</span>&amp; image_1,
<a name="l00540"></a>00540                                <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> <span class="keyword">const</span>&amp; image_2)
<a name="l00541"></a>00541 {
<a name="l00542"></a>00542   <span class="keywordtype">unsigned</span> w1 = image_1.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a9ea9ad565387a61dccf38fc80a266c2a">ni</a>(), h1 = image_1.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a44859c72206da7d18728cb2bbf8ae829">nj</a>();
<a name="l00543"></a>00543   <span class="keywordtype">unsigned</span> w2 = image_2.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a9ea9ad565387a61dccf38fc80a266c2a">ni</a>(), h2 = image_2.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a44859c72206da7d18728cb2bbf8ae829">nj</a>();
<a name="l00544"></a>00544   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> temp(w1, h1);
<a name="l00545"></a>00545   <span class="keywordflow">if</span> (w1!=w2||h1!=h2)
<a name="l00546"></a>00546   {
<a name="l00547"></a>00547     vcl_cout &lt;&lt; <span class="stringliteral">&quot;In brip_vil_float_ops::difference(..) - images are not the same dimensions\n&quot;</span>;
<a name="l00548"></a>00548     <span class="keywordflow">return</span> temp;
<a name="l00549"></a>00549   }
<a name="l00550"></a>00550   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> out;
<a name="l00551"></a>00551   out.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html#a9c01939f01ef50314620e26aaacb04d3">set_size</a>(w1, h1);
<a name="l00552"></a>00552   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> y = 0; y&lt;h1; y++)
<a name="l00553"></a>00553     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> x = 0; x&lt;w1; x++)
<a name="l00554"></a>00554       out(x,y) = image_2(x,y)-image_1(x,y);
<a name="l00555"></a>00555   <span class="keywordflow">return</span> out;
<a name="l00556"></a>00556 }
<a name="l00557"></a>00557 
<a name="l00558"></a>00558 <span class="comment">//: negate an image returning the same pixel type (only greyscale)</span>
<a name="l00559"></a><a class="code" href="classbrip__vil__float__ops.html#a4969f6f7f28a8d01b8a4b89e6f2d4eae">00559</a> <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__smart__ptr.html">vil_image_resource_sptr</a> <a class="code" href="classbrip__vil__float__ops.html#a4969f6f7f28a8d01b8a4b89e6f2d4eae" title="negate an image returning the same pixel type (only greyscale).">brip_vil_float_ops::negate</a>(<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__smart__ptr.html">vil_image_resource_sptr</a> <span class="keyword">const</span>&amp; imgr)
<a name="l00560"></a>00560 {
<a name="l00561"></a>00561   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__smart__ptr.html">vil_image_resource_sptr</a> outr;
<a name="l00562"></a>00562   <span class="keywordflow">if</span> (!imgr)
<a name="l00563"></a>00563     <span class="keywordflow">return</span> outr;
<a name="l00564"></a>00564 
<a name="l00565"></a>00565   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/vil__pixel__format_8h.html#a6f749d91364b0bcb661189f4a154800d">vil_pixel_format</a> fmt = imgr-&gt;pixel_format();
<a name="l00566"></a>00566   <span class="keywordflow">switch</span> (fmt)
<a name="l00567"></a>00567     {
<a name="l00568"></a>00568 <span class="preprocessor">#define NEGATE_CASE(FORMAT, T) \</span>
<a name="l00569"></a>00569 <span class="preprocessor">   case FORMAT: { \</span>
<a name="l00570"></a>00570 <span class="preprocessor">    vil_image_view&lt;T&gt; view = imgr-&gt;get_copy_view(); \</span>
<a name="l00571"></a>00571 <span class="preprocessor">    T mxv = vcl_numeric_limits&lt;T&gt;::max(); \</span>
<a name="l00572"></a>00572 <span class="preprocessor">    vil_math_scale_and_offset_values(view, -1.0, mxv); \</span>
<a name="l00573"></a>00573 <span class="preprocessor">    outr = vil_new_image_resource_of_view(view);  \</span>
<a name="l00574"></a>00574 <span class="preprocessor">    break; \</span>
<a name="l00575"></a>00575 <span class="preprocessor">                }</span>
<a name="l00576"></a>00576 <span class="preprocessor"></span>      <a class="code" href="brip__vil__float__ops_8cxx.html#a5d9d3d42756eb3c504a30ccd592c9ef8">NEGATE_CASE</a>(<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/vil__pixel__format_8h.html#a6f749d91364b0bcb661189f4a154800da7e558fc5ba55dbb9c32658e7960b83f4">VIL_PIXEL_FORMAT_BYTE</a>, vxl_byte);
<a name="l00577"></a>00577       <a class="code" href="brip__vil__float__ops_8cxx.html#a5d9d3d42756eb3c504a30ccd592c9ef8">NEGATE_CASE</a>(<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/vil__pixel__format_8h.html#a6f749d91364b0bcb661189f4a154800da355f2de6abb4cb81d9ca9cfcad7dd0fa">VIL_PIXEL_FORMAT_UINT_32</a>, vxl_uint_32);
<a name="l00578"></a>00578       <a class="code" href="brip__vil__float__ops_8cxx.html#a5d9d3d42756eb3c504a30ccd592c9ef8">NEGATE_CASE</a>(<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/vil__pixel__format_8h.html#a6f749d91364b0bcb661189f4a154800dabecb5c0033517756dc112ccd18f97073">VIL_PIXEL_FORMAT_UINT_16</a>, vxl_uint_16);
<a name="l00579"></a>00579       <a class="code" href="brip__vil__float__ops_8cxx.html#a5d9d3d42756eb3c504a30ccd592c9ef8">NEGATE_CASE</a>(<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/vil__pixel__format_8h.html#a6f749d91364b0bcb661189f4a154800daba50e1cdc6e602c7e314fa82066027a3">VIL_PIXEL_FORMAT_INT_16</a>, vxl_int_16);
<a name="l00580"></a>00580       <a class="code" href="brip__vil__float__ops_8cxx.html#a5d9d3d42756eb3c504a30ccd592c9ef8">NEGATE_CASE</a>(<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/vil__pixel__format_8h.html#a6f749d91364b0bcb661189f4a154800da8d2e38094a68770dcad0e6637d5ce3ba">VIL_PIXEL_FORMAT_FLOAT</a>, <span class="keywordtype">float</span>);
<a name="l00581"></a>00581       <a class="code" href="brip__vil__float__ops_8cxx.html#a5d9d3d42756eb3c504a30ccd592c9ef8">NEGATE_CASE</a>(<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/vil__pixel__format_8h.html#a6f749d91364b0bcb661189f4a154800da57e197d362a17a1777b1ff69ee82e8ec">VIL_PIXEL_FORMAT_DOUBLE</a>, <span class="keywordtype">double</span>);
<a name="l00582"></a>00582 <span class="preprocessor">#undef NEGATE_CASE</span>
<a name="l00583"></a>00583 <span class="preprocessor"></span>    <span class="keywordflow">default</span>:
<a name="l00584"></a>00584       vcl_cout &lt;&lt; <span class="stringliteral">&quot;Unknown image format\n&quot;</span>;
<a name="l00585"></a>00585     }
<a name="l00586"></a>00586   <span class="keywordflow">return</span> outr;
<a name="l00587"></a>00587 }
<a name="l00588"></a>00588 
<a name="l00589"></a>00589 <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a>
<a name="l00590"></a><a class="code" href="classbrip__vil__float__ops.html#a081eae963a107c950551c48265072e83">00590</a> <a class="code" href="classbrip__vil__float__ops.html#a081eae963a107c950551c48265072e83" title="sets values greater than thresh to specified level and the rest to zero.">brip_vil_float_ops::threshold</a>(<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> <span class="keyword">const</span> &amp; image,
<a name="l00591"></a>00591                               <span class="keyword">const</span> <span class="keywordtype">float</span> thresh, <span class="keyword">const</span> <span class="keywordtype">float</span> level)
<a name="l00592"></a>00592 {
<a name="l00593"></a>00593   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> out;
<a name="l00594"></a>00594   <span class="keywordtype">unsigned</span> w = image.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a9ea9ad565387a61dccf38fc80a266c2a">ni</a>(), h = image.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a44859c72206da7d18728cb2bbf8ae829">nj</a>();
<a name="l00595"></a>00595   out.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html#a9c01939f01ef50314620e26aaacb04d3">set_size</a>(w, h);
<a name="l00596"></a>00596   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> y = 0; y&lt;h; y++)
<a name="l00597"></a>00597     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> x = 0; x&lt;w; x++)
<a name="l00598"></a>00598     {
<a name="l00599"></a>00599       <span class="keywordflow">if</span> (image(x,y)&gt;thresh)
<a name="l00600"></a>00600         out(x,y) = level;
<a name="l00601"></a>00601       <span class="keywordflow">else</span>
<a name="l00602"></a>00602         out(x,y) = 0;
<a name="l00603"></a>00603     }
<a name="l00604"></a>00604   <span class="keywordflow">return</span> out;
<a name="l00605"></a>00605 }
<a name="l00606"></a>00606 
<a name="l00607"></a>00607 <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a>
<a name="l00608"></a><a class="code" href="classbrip__vil__float__ops.html#a435264a5e7ef193ad05b811870c5f547">00608</a> <a class="code" href="classbrip__vil__float__ops.html#a435264a5e7ef193ad05b811870c5f547" title="sets absolute values greater than thresh to specified level.">brip_vil_float_ops::abs_clip_to_level</a>(<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> <span class="keyword">const</span>&amp; image,
<a name="l00609"></a>00609                                       <span class="keywordtype">float</span> thresh, <span class="keywordtype">float</span> level)
<a name="l00610"></a>00610 {
<a name="l00611"></a>00611   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> out;
<a name="l00612"></a>00612   <span class="keywordtype">unsigned</span> w = image.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a9ea9ad565387a61dccf38fc80a266c2a">ni</a>(), h = image.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a44859c72206da7d18728cb2bbf8ae829">nj</a>();
<a name="l00613"></a>00613   out.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html#a9c01939f01ef50314620e26aaacb04d3">set_size</a>(w, h);
<a name="l00614"></a>00614   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> y = 0; y&lt;h; y++)
<a name="l00615"></a>00615     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> x = 0; x&lt;w; x++)
<a name="l00616"></a>00616     {
<a name="l00617"></a>00617       <span class="keywordflow">if</span> (vcl_fabs(image(x,y))&gt;thresh)
<a name="l00618"></a>00618         out(x,y) = level;
<a name="l00619"></a>00619       <span class="keywordflow">else</span>
<a name="l00620"></a>00620         out(x,y) = image(x,y);
<a name="l00621"></a>00621     }
<a name="l00622"></a>00622   <span class="keywordflow">return</span> out;
<a name="l00623"></a>00623 }
<a name="l00624"></a>00624 
<a name="l00625"></a><a class="code" href="classbrip__vil__float__ops.html#ac60b6fd09e290a108312fd4b47132487">00625</a> <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> <a class="code" href="classbrip__vil__float__ops.html#ac60b6fd09e290a108312fd4b47132487" title="Blur the image with an NxN averaging filter.">brip_vil_float_ops::average_NxN</a>(<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> <span class="keyword">const</span> &amp; img, <span class="keywordtype">int</span> N)
<a name="l00626"></a>00626 {
<a name="l00627"></a>00627   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> result;
<a name="l00628"></a>00628   <span class="keywordtype">unsigned</span> w = img.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a9ea9ad565387a61dccf38fc80a266c2a">ni</a>(), h = img.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a44859c72206da7d18728cb2bbf8ae829">nj</a>();
<a name="l00629"></a>00629   result.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html#a9c01939f01ef50314620e26aaacb04d3">set_size</a> (w, h);
<a name="l00630"></a>00630 
<a name="l00631"></a>00631   <a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__array__2d.html">vbl_array_2d &lt;float&gt;</a> averaging_filt(N, N);
<a name="l00632"></a>00632   averaging_filt.<a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__array__2d.html#a53bc68e39f36ce09948ecf9750ce7767">fill</a>( <span class="keywordtype">float</span>(1.00/<span class="keywordtype">double</span>(N*N)) );
<a name="l00633"></a>00633   result = <a class="code" href="classbrip__vil__float__ops.html#a212e5e210bc565c1f63049f119fe4a5b" title="convolves with the specified kernel.">brip_vil_float_ops::convolve</a>(img, averaging_filt);
<a name="l00634"></a>00634   <span class="keywordflow">return</span> result;
<a name="l00635"></a>00635 }
<a name="l00636"></a>00636 
<a name="l00637"></a>00637 <span class="comment">//----------------------------------------------------------------</span>
<a name="l00638"></a>00638 <span class="comment">//: Compute the gradient of the input, use a 3x3 mask</span>
<a name="l00639"></a>00639 <span class="comment">// \verbatim</span>
<a name="l00640"></a>00640 <span class="comment">//         1  |-1  0  1|         1  |-1 -1 -1|</span>
<a name="l00641"></a>00641 <span class="comment">//   Ix = --- |-1  0  1|   Iy = --- | 0  0  0|</span>
<a name="l00642"></a>00642 <span class="comment">//         6  |-1  0  1|         6  | 1  1  1|</span>
<a name="l00643"></a>00643 <span class="comment">// \endverbatim</span>
<a name="l00644"></a>00644 <span class="comment">// Larger masks are computed by pre-convolving with a Gaussian</span>
<a name="l00645"></a>00645 <span class="comment">//</span>
<a name="l00646"></a><a class="code" href="classbrip__vil__float__ops.html#a45ba9abd34128197b97a74ecfe18f50f">00646</a> <span class="keywordtype">void</span> <a class="code" href="classbrip__vil__float__ops.html#a45ba9abd34128197b97a74ecfe18f50f" title="Returns the gradient using a 3x3 kernel.">brip_vil_float_ops::gradient_3x3</a>(<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> <span class="keyword">const</span>&amp; input,
<a name="l00647"></a>00647                                       <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a>&amp; grad_x,
<a name="l00648"></a>00648                                       <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a>&amp; grad_y)
<a name="l00649"></a>00649 {
<a name="l00650"></a>00650   <a class="codeRef" doxygen="core_vul.tag:../../../../../core/vul/html" href="../../../../../core/vul/html/classvul__timer.html">vul_timer</a> t;
<a name="l00651"></a>00651   <span class="keywordtype">unsigned</span> w = input.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a9ea9ad565387a61dccf38fc80a266c2a">ni</a>(), h = input.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a44859c72206da7d18728cb2bbf8ae829">nj</a>();
<a name="l00652"></a>00652   <span class="keywordtype">float</span> scale = 1.0f/6.0f;
<a name="l00653"></a>00653   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> y = 1; y+1&lt;h; ++y)
<a name="l00654"></a>00654     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> x = 1; x+1&lt;w; ++x)
<a name="l00655"></a>00655     {
<a name="l00656"></a>00656       <span class="keywordtype">float</span> gx = input(x+1,y-1)+input(x+1,y)+input(x+1,y-1)
<a name="l00657"></a>00657                 -input(x-1,y-1)-input(x-1,y)-input(x-1,y-1);
<a name="l00658"></a>00658       <span class="keywordtype">float</span> gy = input(x+1,y+1)+input(x,y+1)+input(x-1,y+1)
<a name="l00659"></a>00659                 -input(x+1,y-1)-input(x,y-1)-input(x-1,y-1);
<a name="l00660"></a>00660       grad_x(x,y) = scale*gx;
<a name="l00661"></a>00661       grad_y(x,y) = scale*gy;
<a name="l00662"></a>00662     }
<a name="l00663"></a>00663   <a class="code" href="classbrip__vil__float__ops.html#a99ebd3182f788d8147b60f177cee12ef" title="fills a border of width w on left and right of image with value.">brip_vil_float_ops::fill_x_border</a>(grad_x, 1, 0.0f);
<a name="l00664"></a>00664   <a class="code" href="classbrip__vil__float__ops.html#addf1ea3028581107a66b3b82ae89aab4" title="fills a border of height h on top and bottom of image with value.">brip_vil_float_ops::fill_y_border</a>(grad_x, 1, 0.0f);
<a name="l00665"></a>00665   <a class="code" href="classbrip__vil__float__ops.html#a99ebd3182f788d8147b60f177cee12ef" title="fills a border of width w on left and right of image with value.">brip_vil_float_ops::fill_x_border</a>(grad_y, 1, 0.0f);
<a name="l00666"></a>00666   <a class="code" href="classbrip__vil__float__ops.html#addf1ea3028581107a66b3b82ae89aab4" title="fills a border of height h on top and bottom of image with value.">brip_vil_float_ops::fill_y_border</a>(grad_y, 1, 0.0f);
<a name="l00667"></a>00667 <span class="preprocessor">#ifdef DEBUG</span>
<a name="l00668"></a>00668 <span class="preprocessor"></span>  vcl_cout &lt;&lt; <span class="stringliteral">&quot;\nCompute Gradient in &quot;</span> &lt;&lt; t.<a class="codeRef" doxygen="core_vul.tag:../../../../../core/vul/html" href="../../../../../core/vul/html/classvul__timer.html#a14c86b3c27f36c1946c184941e006370">real</a>() &lt;&lt; <span class="stringliteral">&quot; msecs.\n&quot;</span>;
<a name="l00669"></a>00669 <span class="preprocessor">#endif</span>
<a name="l00670"></a>00670 <span class="preprocessor"></span>}
<a name="l00671"></a>00671 
<a name="l00672"></a><a class="code" href="classbrip__vil__float__ops.html#aa5df52b6658d631973d8cd1204644b0e">00672</a> <span class="keywordtype">void</span> <a class="code" href="classbrip__vil__float__ops.html#aa5df52b6658d631973d8cd1204644b0e" title="Returns the gradient magnitude using a 3x3 kernel.">brip_vil_float_ops::gradient_mag_3x3</a>(<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> <span class="keyword">const</span>&amp; input,
<a name="l00673"></a>00673                                           <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a>&amp; mag)
<a name="l00674"></a>00674 {
<a name="l00675"></a>00675   <span class="keywordtype">unsigned</span> w = input.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a9ea9ad565387a61dccf38fc80a266c2a">ni</a>(), h = input.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a44859c72206da7d18728cb2bbf8ae829">nj</a>();
<a name="l00676"></a>00676   <span class="keywordtype">float</span> scale = 1.0f/6.0f;
<a name="l00677"></a>00677   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> y = 1; y+1&lt;h; ++y)
<a name="l00678"></a>00678     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> x = 1; x+1&lt;w; ++x)
<a name="l00679"></a>00679     {
<a name="l00680"></a>00680       <span class="keywordtype">float</span> gx = input(x+1,y-1)+input(x+1,y)+input(x+1,y-1)
<a name="l00681"></a>00681                 -input(x-1,y-1)-input(x-1,y)-input(x-1,y-1);
<a name="l00682"></a>00682       <span class="keywordtype">float</span> gy = input(x+1,y+1)+input(x,y+1)+input(x-1,y+1)
<a name="l00683"></a>00683                 -input(x+1,y-1)-input(x,y-1)-input(x-1,y-1);
<a name="l00684"></a>00684       mag(x,y) = scale*vcl_sqrt(gx*gx+gy*gy);
<a name="l00685"></a>00685     }
<a name="l00686"></a>00686   <a class="code" href="classbrip__vil__float__ops.html#a99ebd3182f788d8147b60f177cee12ef" title="fills a border of width w on left and right of image with value.">brip_vil_float_ops::fill_x_border</a>(mag, 1, 0.0f);
<a name="l00687"></a>00687   <a class="code" href="classbrip__vil__float__ops.html#addf1ea3028581107a66b3b82ae89aab4" title="fills a border of height h on top and bottom of image with value.">brip_vil_float_ops::fill_y_border</a>(mag, 1, 0.0f);
<a name="l00688"></a>00688 }
<a name="l00689"></a>00689 
<a name="l00690"></a>00690 <span class="keywordtype">void</span> <a class="code" href="classbrip__vil__float__ops.html#a29081cdbf1797a03d13cc96699b50623" title="Returns the gradient and its magnitude, using a 3x3 kernel.">brip_vil_float_ops::</a>
<a name="l00691"></a><a class="code" href="classbrip__vil__float__ops.html#a29081cdbf1797a03d13cc96699b50623">00691</a> <a class="code" href="classbrip__vil__float__ops.html#a29081cdbf1797a03d13cc96699b50623" title="Returns the gradient and its magnitude, using a 3x3 kernel.">gradient_mag_comp_3x3</a>(<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> <span class="keyword">const</span>&amp; input,
<a name="l00692"></a>00692                       <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a>&amp; mag,
<a name="l00693"></a>00693                       <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a>&amp; gx,
<a name="l00694"></a>00694                       <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a>&amp; gy)
<a name="l00695"></a>00695 {
<a name="l00696"></a>00696   <span class="keywordtype">unsigned</span> w = input.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a9ea9ad565387a61dccf38fc80a266c2a">ni</a>(), h = input.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a44859c72206da7d18728cb2bbf8ae829">nj</a>();
<a name="l00697"></a>00697   <span class="keywordtype">float</span> scale = 1.0f/6.0f;
<a name="l00698"></a>00698   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> y = 1; y+1&lt;h; ++y)
<a name="l00699"></a>00699     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> x = 1; x+1&lt;w; ++x)
<a name="l00700"></a>00700     {
<a name="l00701"></a>00701       <span class="keywordtype">float</span> ggx = input(x+1,y-1)+input(x+1,y)+input(x+1,y-1)
<a name="l00702"></a>00702                  -input(x-1,y-1)-input(x-1,y)-input(x-1,y-1);
<a name="l00703"></a>00703       <span class="keywordtype">float</span> ggy = input(x+1,y+1)+input(x,y+1)+input(x-1,y+1)
<a name="l00704"></a>00704                  -input(x+1,y-1)-input(x,y-1)-input(x-1,y-1);
<a name="l00705"></a>00705       mag(x,y) = scale*vcl_sqrt(ggx*ggx+ggy*ggy);
<a name="l00706"></a>00706       gx(x,y) = ggx*scale;
<a name="l00707"></a>00707       gy(x,y) = ggy*scale;
<a name="l00708"></a>00708     }
<a name="l00709"></a>00709   <a class="code" href="classbrip__vil__float__ops.html#a99ebd3182f788d8147b60f177cee12ef" title="fills a border of width w on left and right of image with value.">brip_vil_float_ops::fill_x_border</a>(mag, 1, 0.0f);
<a name="l00710"></a>00710   <a class="code" href="classbrip__vil__float__ops.html#addf1ea3028581107a66b3b82ae89aab4" title="fills a border of height h on top and bottom of image with value.">brip_vil_float_ops::fill_y_border</a>(mag, 1, 0.0f);
<a name="l00711"></a>00711   <a class="code" href="classbrip__vil__float__ops.html#a99ebd3182f788d8147b60f177cee12ef" title="fills a border of width w on left and right of image with value.">brip_vil_float_ops::fill_x_border</a>(gx, 1, 0.0f);
<a name="l00712"></a>00712   <a class="code" href="classbrip__vil__float__ops.html#addf1ea3028581107a66b3b82ae89aab4" title="fills a border of height h on top and bottom of image with value.">brip_vil_float_ops::fill_y_border</a>(gy, 1, 0.0f);
<a name="l00713"></a>00713 }
<a name="l00714"></a>00714 
<a name="l00715"></a>00715 <span class="comment">//----------------------------------------------------------------</span>
<a name="l00716"></a>00716 <span class="comment">//: Compute the Hessian of the input, use a 3x3 mask</span>
<a name="l00717"></a>00717 <span class="comment">// \verbatim</span>
<a name="l00718"></a>00718 <span class="comment">//          1 | 1  -2  1|          1 |  1  1  1|         1  | 1  0 -1|</span>
<a name="l00719"></a>00719 <span class="comment">//   Ixx = ---| 1  -2  1|   Iyy = ---| -2 -2 -2|  Ixy = --- | 0  0  0|</span>
<a name="l00720"></a>00720 <span class="comment">//          3 | 1  -2  1|          3 |  1  1  1|         4  |-1  0  1|</span>
<a name="l00721"></a>00721 <span class="comment">// \endverbatim</span>
<a name="l00722"></a>00722 <span class="comment">// Larger masks are computed by pre-convolving with a Gaussian</span>
<a name="l00723"></a>00723 <span class="comment">//</span>
<a name="l00724"></a><a class="code" href="classbrip__vil__float__ops.html#ad6ad693597b317c03dfa936e1cecf2bf">00724</a> <span class="keywordtype">void</span> <a class="code" href="classbrip__vil__float__ops.html#ad6ad693597b317c03dfa936e1cecf2bf" title="Returns the Hessian using a 3x3 kernel.">brip_vil_float_ops::hessian_3x3</a>(<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> <span class="keyword">const</span>&amp; input,
<a name="l00725"></a>00725                                      <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a>&amp; Ixx,
<a name="l00726"></a>00726                                      <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a>&amp; Ixy,
<a name="l00727"></a>00727                                      <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a>&amp; Iyy)
<a name="l00728"></a>00728 {
<a name="l00729"></a>00729   <a class="codeRef" doxygen="core_vul.tag:../../../../../core/vul/html" href="../../../../../core/vul/html/classvul__timer.html">vul_timer</a> t;
<a name="l00730"></a>00730   <span class="keywordtype">unsigned</span> w = input.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a9ea9ad565387a61dccf38fc80a266c2a">ni</a>(), h = input.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a44859c72206da7d18728cb2bbf8ae829">nj</a>();
<a name="l00731"></a>00731   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> y = 1; y+1&lt;h; ++y)
<a name="l00732"></a>00732     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> x = 1; x+1&lt;w; ++x)
<a name="l00733"></a>00733     {
<a name="l00734"></a>00734       <span class="keywordtype">float</span> xx = input(x-1,y-1)+input(x-1,y)+input(x+1,y+1)+
<a name="l00735"></a>00735                  input(x+1,y-1)+input(x+1,y)+input(x+1,y+1)-
<a name="l00736"></a>00736                  2.0f*(input(x,y-1)+input(x,y)+input(x,y+1));
<a name="l00737"></a>00737 
<a name="l00738"></a>00738       <span class="keywordtype">float</span> xy = (input(x-1,y-1)+input(x+1,y+1))-
<a name="l00739"></a>00739                  (input(x-1,y+1)+input(x+1,y-1));
<a name="l00740"></a>00740 
<a name="l00741"></a>00741       <span class="keywordtype">float</span> yy = input(x-1,y-1)+input(x,y-1)+input(x+1,y-1)+
<a name="l00742"></a>00742                  input(x-1,y+1)+input(x,y+1)+input(x+1,y+1)-
<a name="l00743"></a>00743                  2.0f*(input(x-1,y)+input(x,y)+input(x+1,y));
<a name="l00744"></a>00744 
<a name="l00745"></a>00745       Ixx(x,y) = xx/3.0f;
<a name="l00746"></a>00746       Ixy(x,y) = xy/4.0f;
<a name="l00747"></a>00747       Iyy(x,y) = yy/3.0f;
<a name="l00748"></a>00748     }
<a name="l00749"></a>00749   <a class="code" href="classbrip__vil__float__ops.html#a99ebd3182f788d8147b60f177cee12ef" title="fills a border of width w on left and right of image with value.">brip_vil_float_ops::fill_x_border</a>(Ixx, 1, 0.0f);
<a name="l00750"></a>00750   <a class="code" href="classbrip__vil__float__ops.html#addf1ea3028581107a66b3b82ae89aab4" title="fills a border of height h on top and bottom of image with value.">brip_vil_float_ops::fill_y_border</a>(Ixx, 1, 0.0f);
<a name="l00751"></a>00751   <a class="code" href="classbrip__vil__float__ops.html#a99ebd3182f788d8147b60f177cee12ef" title="fills a border of width w on left and right of image with value.">brip_vil_float_ops::fill_x_border</a>(Ixy, 1, 0.0f);
<a name="l00752"></a>00752   <a class="code" href="classbrip__vil__float__ops.html#addf1ea3028581107a66b3b82ae89aab4" title="fills a border of height h on top and bottom of image with value.">brip_vil_float_ops::fill_y_border</a>(Ixy, 1, 0.0f);
<a name="l00753"></a>00753   <a class="code" href="classbrip__vil__float__ops.html#a99ebd3182f788d8147b60f177cee12ef" title="fills a border of width w on left and right of image with value.">brip_vil_float_ops::fill_x_border</a>(Iyy, 1, 0.0f);
<a name="l00754"></a>00754   <a class="code" href="classbrip__vil__float__ops.html#addf1ea3028581107a66b3b82ae89aab4" title="fills a border of height h on top and bottom of image with value.">brip_vil_float_ops::fill_y_border</a>(Iyy, 1, 0.0f);
<a name="l00755"></a>00755 <span class="preprocessor">#ifdef DEBUG</span>
<a name="l00756"></a>00756 <span class="preprocessor"></span>  vcl_cout &lt;&lt; <span class="stringliteral">&quot;\nCompute a hessian matrix &quot;</span>&lt;&lt; w &lt;&lt;<span class="stringliteral">&quot; x &quot;</span> &lt;&lt; h &lt;&lt; <span class="stringliteral">&quot; image in &quot;</span>&lt;&lt; t.<a class="codeRef" doxygen="core_vul.tag:../../../../../core/vul/html" href="../../../../../core/vul/html/classvul__timer.html#a14c86b3c27f36c1946c184941e006370">real</a>() &lt;&lt; <span class="stringliteral">&quot; msecs.\n&quot;</span>;
<a name="l00757"></a>00757 <span class="preprocessor">#endif</span>
<a name="l00758"></a>00758 <span class="preprocessor"></span>}
<a name="l00759"></a>00759 
<a name="l00760"></a>00760 <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a>
<a name="l00761"></a><a class="code" href="classbrip__vil__float__ops.html#a2dfd02e0c2177a0192ec487a78c47342">00761</a> <a class="code" href="classbrip__vil__float__ops.html#a2dfd02e0c2177a0192ec487a78c47342">brip_vil_float_ops::beaudet</a>(<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> <span class="keyword">const</span>&amp; Ixx,
<a name="l00762"></a>00762                             <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> <span class="keyword">const</span>&amp; Ixy,
<a name="l00763"></a>00763                             <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> <span class="keyword">const</span>&amp; Iyy,
<a name="l00764"></a>00764                             <span class="keywordtype">bool</span> determinant)
<a name="l00765"></a>00765 {
<a name="l00766"></a>00766   <span class="keywordtype">unsigned</span> w = Ixx.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a9ea9ad565387a61dccf38fc80a266c2a">ni</a>(), h = Ixx.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a44859c72206da7d18728cb2bbf8ae829">nj</a>();
<a name="l00767"></a>00767   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> output;
<a name="l00768"></a>00768   output.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html#a9c01939f01ef50314620e26aaacb04d3">set_size</a>(w, h);
<a name="l00769"></a>00769   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> y = 0; y&lt;h; y++)
<a name="l00770"></a>00770     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> x = 0; x&lt;w; x++)
<a name="l00771"></a>00771     {
<a name="l00772"></a>00772       <span class="keywordtype">float</span> xx = Ixx(x,y), xy = Ixy(x,y), yy = Iyy(x,y);
<a name="l00773"></a>00773 
<a name="l00774"></a>00774       <span class="comment">//compute eigenvalues for experimentation</span>
<a name="l00775"></a>00775       <span class="keywordtype">float</span> det = xx*yy-xy*xy;
<a name="l00776"></a>00776       <span class="keywordtype">float</span> tr = xx+yy;
<a name="l00777"></a>00777       <span class="keywordtype">float</span> arg = tr*tr-4.f*det, lambda0 = 0, lambda1=0;
<a name="l00778"></a>00778       <span class="keywordflow">if</span> (arg&gt;0)
<a name="l00779"></a>00779       {
<a name="l00780"></a>00780         lambda0 = tr+vcl_sqrt(arg);
<a name="l00781"></a>00781         lambda1 = tr-vcl_sqrt(arg);
<a name="l00782"></a>00782       }
<a name="l00783"></a>00783       <span class="keywordflow">if</span> (determinant)
<a name="l00784"></a>00784         output(x,y) = det;
<a name="l00785"></a>00785       <span class="keywordflow">else</span>
<a name="l00786"></a>00786         output(x,y) = tr;
<a name="l00787"></a>00787     }
<a name="l00788"></a>00788   <span class="keywordflow">return</span> output;
<a name="l00789"></a>00789 }
<a name="l00790"></a>00790 
<a name="l00791"></a>00791 <span class="comment">//----------------------------------------------------------------</span>
<a name="l00792"></a>00792 <span class="comment">//: $Ix\cdot Ix^t$ gradient matrix elements</span>
<a name="l00793"></a>00793 <span class="comment">// That is,</span>
<a name="l00794"></a>00794 <span class="comment">// \verbatim</span>
<a name="l00795"></a>00795 <span class="comment">//                        _                           _</span>
<a name="l00796"></a>00796 <span class="comment">//                       | (dI/dx)^2    (dI/dx)(dI/dy) |</span>
<a name="l00797"></a>00797 <span class="comment">//                       |                             |</span>
<a name="l00798"></a>00798 <span class="comment">//  A = Sum(neighborhood)|                             |</span>
<a name="l00799"></a>00799 <span class="comment">//                       |(dI/dx)(dI/dy)   (dI/dx)^2   |</span>
<a name="l00800"></a>00800 <span class="comment">//                       |_                           _|</span>
<a name="l00801"></a>00801 <span class="comment">// \endverbatim</span>
<a name="l00802"></a>00802 <span class="comment">// over a 2n+1 x 2n+1 neighborhood</span>
<a name="l00803"></a>00803 <span class="comment">//</span>
<a name="l00804"></a>00804 <span class="keywordtype">void</span>
<a name="l00805"></a><a class="code" href="classbrip__vil__float__ops.html#a559841e39a36ea857695ef6efd3fff80">00805</a> <a class="code" href="classbrip__vil__float__ops.html#a559841e39a36ea857695ef6efd3fff80" title="Ix.Ix-transpose gradient matrix elements for an NxN region ($N = 2n+1$).">brip_vil_float_ops::grad_matrix_NxN</a>(<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> <span class="keyword">const</span>&amp; input,
<a name="l00806"></a>00806                                     <span class="keywordtype">unsigned</span> n,
<a name="l00807"></a>00807                                     <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a>&amp; IxIx,
<a name="l00808"></a>00808                                     <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a>&amp; IxIy,
<a name="l00809"></a>00809                                     <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a>&amp; IyIy)
<a name="l00810"></a>00810 {
<a name="l00811"></a>00811   <span class="keywordtype">int</span> w = <span class="keyword">static_cast&lt;</span><span class="keywordtype">int</span><span class="keyword">&gt;</span>(input.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a9ea9ad565387a61dccf38fc80a266c2a">ni</a>()), h = static_cast&lt;int&gt;(input.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a44859c72206da7d18728cb2bbf8ae829">nj</a>());
<a name="l00812"></a>00812   <span class="keywordtype">int</span> N = (2*n+1)*(2*n+1);
<a name="l00813"></a>00813   <span class="keywordtype">int</span> ni = <span class="keyword">static_cast&lt;</span><span class="keywordtype">int</span><span class="keyword">&gt;</span>(n);
<a name="l00814"></a>00814   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> grad_x, grad_y, output;
<a name="l00815"></a>00815   grad_x.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html#a9c01939f01ef50314620e26aaacb04d3">set_size</a>(w,h);
<a name="l00816"></a>00816   grad_y.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html#a9c01939f01ef50314620e26aaacb04d3">set_size</a>(w,h);
<a name="l00817"></a>00817   output.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html#a9c01939f01ef50314620e26aaacb04d3">set_size</a>(w,h);
<a name="l00818"></a>00818   <a class="code" href="classbrip__vil__float__ops.html#a45ba9abd34128197b97a74ecfe18f50f" title="Returns the gradient using a 3x3 kernel.">brip_vil_float_ops::gradient_3x3</a>(input, grad_x, grad_y);
<a name="l00819"></a>00819   <a class="codeRef" doxygen="core_vul.tag:../../../../../core/vul/html" href="../../../../../core/vul/html/classvul__timer.html">vul_timer</a> t;
<a name="l00820"></a>00820   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> y = ni; y&lt;h-ni;y++)
<a name="l00821"></a>00821     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> x = ni; x&lt;w-ni;x++)
<a name="l00822"></a>00822     {
<a name="l00823"></a>00823       <span class="keywordtype">float</span> xx=0, xy=0, yy=0;
<a name="l00824"></a>00824       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = -ni; i&lt;=ni; i++)
<a name="l00825"></a>00825         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = -ni; j&lt;=ni; j++)
<a name="l00826"></a>00826         {
<a name="l00827"></a>00827           <span class="keywordtype">float</span> gx = grad_x(x+i, y+j), gy = grad_y(x+i, y+j);
<a name="l00828"></a>00828           xx += gx*gx;
<a name="l00829"></a>00829           xy += gx*gy;
<a name="l00830"></a>00830           yy += gy*gy;
<a name="l00831"></a>00831         }
<a name="l00832"></a>00832       IxIx(x,y) = xx/(float)N;
<a name="l00833"></a>00833       IxIy(x,y) = xy/(float)N;
<a name="l00834"></a>00834       IyIy(x,y) = yy/(float)N;
<a name="l00835"></a>00835     }
<a name="l00836"></a>00836   <a class="code" href="classbrip__vil__float__ops.html#a99ebd3182f788d8147b60f177cee12ef" title="fills a border of width w on left and right of image with value.">brip_vil_float_ops::fill_x_border</a>(IxIx, ni, 0.0f);
<a name="l00837"></a>00837   <a class="code" href="classbrip__vil__float__ops.html#addf1ea3028581107a66b3b82ae89aab4" title="fills a border of height h on top and bottom of image with value.">brip_vil_float_ops::fill_y_border</a>(IxIx, ni, 0.0f);
<a name="l00838"></a>00838   <a class="code" href="classbrip__vil__float__ops.html#a99ebd3182f788d8147b60f177cee12ef" title="fills a border of width w on left and right of image with value.">brip_vil_float_ops::fill_x_border</a>(IxIy, ni, 0.0f);
<a name="l00839"></a>00839   <a class="code" href="classbrip__vil__float__ops.html#addf1ea3028581107a66b3b82ae89aab4" title="fills a border of height h on top and bottom of image with value.">brip_vil_float_ops::fill_y_border</a>(IxIy, ni, 0.0f);
<a name="l00840"></a>00840   <a class="code" href="classbrip__vil__float__ops.html#a99ebd3182f788d8147b60f177cee12ef" title="fills a border of width w on left and right of image with value.">brip_vil_float_ops::fill_x_border</a>(IyIy, ni, 0.0f);
<a name="l00841"></a>00841   <a class="code" href="classbrip__vil__float__ops.html#addf1ea3028581107a66b3b82ae89aab4" title="fills a border of height h on top and bottom of image with value.">brip_vil_float_ops::fill_y_border</a>(IyIy, ni, 0.0f);
<a name="l00842"></a>00842 <span class="preprocessor">#ifdef DEBUG</span>
<a name="l00843"></a>00843 <span class="preprocessor"></span>  vcl_cout &lt;&lt; <span class="stringliteral">&quot;\nCompute a gradient matrix &quot;</span>&lt;&lt; w &lt;&lt;<span class="stringliteral">&quot; x &quot;</span> &lt;&lt; h &lt;&lt; <span class="stringliteral">&quot; image in &quot;</span>&lt;&lt; t.<a class="codeRef" doxygen="core_vul.tag:../../../../../core/vul/html" href="../../../../../core/vul/html/classvul__timer.html#a14c86b3c27f36c1946c184941e006370">real</a>() &lt;&lt; <span class="stringliteral">&quot; msecs.\n&quot;</span>;
<a name="l00844"></a>00844 <span class="preprocessor">#endif</span>
<a name="l00845"></a>00845 <span class="preprocessor"></span>}
<a name="l00846"></a>00846 
<a name="l00847"></a>00847 <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> <a class="code" href="classbrip__vil__float__ops.html#aa766d48d8ad212e16cff8a9537cefa12" title="Tr(IxIx.transpose) for a NxN region ($N = 2n+1$).">brip_vil_float_ops::</a>
<a name="l00848"></a><a class="code" href="classbrip__vil__float__ops.html#aa766d48d8ad212e16cff8a9537cefa12">00848</a> <a class="code" href="classbrip__vil__float__ops.html#aa766d48d8ad212e16cff8a9537cefa12" title="Tr(IxIx.transpose) for a NxN region ($N = 2n+1$).">trace_grad_matrix_NxN</a>(<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> <span class="keyword">const</span>&amp; input, <span class="keywordtype">unsigned</span> n)
<a name="l00849"></a>00849 {
<a name="l00850"></a>00850   <span class="keywordtype">unsigned</span> ni = input.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a9ea9ad565387a61dccf38fc80a266c2a">ni</a>(), nj = input.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a44859c72206da7d18728cb2bbf8ae829">nj</a>();
<a name="l00851"></a>00851   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> IxIx;
<a name="l00852"></a>00852   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> IxIy;
<a name="l00853"></a>00853   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> IyIy;
<a name="l00854"></a>00854   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> tr;
<a name="l00855"></a>00855   IxIx.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html#a9c01939f01ef50314620e26aaacb04d3">set_size</a>(ni, nj);   IxIy.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html#a9c01939f01ef50314620e26aaacb04d3">set_size</a>(ni, nj);   IyIy.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html#a9c01939f01ef50314620e26aaacb04d3">set_size</a>(ni, nj);
<a name="l00856"></a>00856   tr.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html#a9c01939f01ef50314620e26aaacb04d3">set_size</a>(ni, nj);
<a name="l00857"></a>00857   <a class="code" href="classbrip__vil__float__ops.html#a559841e39a36ea857695ef6efd3fff80" title="Ix.Ix-transpose gradient matrix elements for an NxN region ($N = 2n+1$).">brip_vil_float_ops::grad_matrix_NxN</a>(input, n, IxIx, IxIy, IyIy);
<a name="l00858"></a>00858   vil_math_image_sum&lt;float, float, float&gt;(IxIx, IyIy, tr);
<a name="l00859"></a>00859   <span class="keywordflow">return</span> tr;
<a name="l00860"></a>00860 }
<a name="l00861"></a>00861 
<a name="l00862"></a>00862 <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a>
<a name="l00863"></a><a class="code" href="classbrip__vil__float__ops.html#ae33a546f170f6a28c1addf1e1677d889">00863</a> <a class="code" href="classbrip__vil__float__ops.html#ae33a546f170f6a28c1addf1e1677d889" title="Computes the Harris corner measure.">brip_vil_float_ops::harris</a>(<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> <span class="keyword">const</span>&amp; IxIx,
<a name="l00864"></a>00864                            <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> <span class="keyword">const</span>&amp; IxIy,
<a name="l00865"></a>00865                            <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> <span class="keyword">const</span>&amp; IyIy,
<a name="l00866"></a>00866                            <span class="keywordtype">double</span> scale)
<a name="l00867"></a>00867 {
<a name="l00868"></a>00868   <span class="keywordtype">unsigned</span> w = IxIx.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a9ea9ad565387a61dccf38fc80a266c2a">ni</a>(), h = IxIx.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a44859c72206da7d18728cb2bbf8ae829">nj</a>();
<a name="l00869"></a>00869   <span class="keywordtype">float</span> norm = 1e-3f; <span class="comment">// Scale the output to values in the 10-&gt;1000 range</span>
<a name="l00870"></a>00870   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> output;
<a name="l00871"></a>00871   output.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html#a9c01939f01ef50314620e26aaacb04d3">set_size</a>(w, h);
<a name="l00872"></a>00872   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> y = 0; y&lt;h; y++)
<a name="l00873"></a>00873     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> x = 0; x&lt;w; x++)
<a name="l00874"></a>00874     {
<a name="l00875"></a>00875       <span class="keywordtype">float</span> xx = IxIx(x,y), xy = IxIy(x,y), yy = IyIy(x,y);
<a name="l00876"></a>00876       <span class="keywordtype">float</span> det = xx*yy-xy*xy, <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/vil__jpeg__decompressor_8cxx.html#a2526a8fa89c481f1f1b6f21c4957345a">trace</a> = xx+yy;
<a name="l00877"></a>00877       output(x,y) = float(det - scale*trace*trace)*norm;
<a name="l00878"></a>00878     }
<a name="l00879"></a>00879   <span class="keywordflow">return</span> output;
<a name="l00880"></a>00880 }
<a name="l00881"></a>00881 
<a name="l00882"></a>00882 <span class="comment">//----------------------------------------------------------------</span>
<a name="l00883"></a>00883 <span class="comment">// Compute the sqrt of the product of the eigenvalues of the</span>
<a name="l00884"></a>00884 <span class="comment">// gradient matrix over a 2n+1 x 2n+1 neighborhood</span>
<a name="l00885"></a>00885 <span class="comment">// That is,</span>
<a name="l00886"></a>00886 <span class="comment">// \verbatim</span>
<a name="l00887"></a>00887 <span class="comment">//                        _                           _</span>
<a name="l00888"></a>00888 <span class="comment">//                       | (dI/dx)^2    (dI/dx)(dI/dy) |</span>
<a name="l00889"></a>00889 <span class="comment">//                       |                             |</span>
<a name="l00890"></a>00890 <span class="comment">//  A = Sum(neighborhood)|                             |</span>
<a name="l00891"></a>00891 <span class="comment">//                       |(dI/dx)(dI/dy)   (dI/dx)^2   |</span>
<a name="l00892"></a>00892 <span class="comment">//                       |_                           _|</span>
<a name="l00893"></a>00893 <span class="comment">// \endverbatim</span>
<a name="l00894"></a>00894 <span class="comment">// The output image is sqrt(lamba_1*lambda_2) where lambda_i are the eigenvalues</span>
<a name="l00895"></a>00895 <span class="comment">//</span>
<a name="l00896"></a>00896 <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a>
<a name="l00897"></a><a class="code" href="classbrip__vil__float__ops.html#ab567f486e0dd5e4ecff7cb6b3abc5112">00897</a> <a class="code" href="classbrip__vil__float__ops.html#ab567f486e0dd5e4ecff7cb6b3abc5112" title="Computes the conditioning of the $2n+1 ~~ 2n+1$ gradient neighborhood.">brip_vil_float_ops::sqrt_grad_singular_values</a>(<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a>&amp; input,
<a name="l00898"></a>00898                                               <span class="keywordtype">int</span> n)
<a name="l00899"></a>00899 {
<a name="l00900"></a>00900   <span class="keywordtype">int</span> N = (2*n+1)*(2*n+1);
<a name="l00901"></a>00901   <span class="keywordtype">int</span> w = <span class="keyword">static_cast&lt;</span><span class="keywordtype">int</span><span class="keyword">&gt;</span>(input.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a9ea9ad565387a61dccf38fc80a266c2a">ni</a>()), h = static_cast&lt;int&gt;(input.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a44859c72206da7d18728cb2bbf8ae829">nj</a>());
<a name="l00902"></a>00902   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> grad_x, grad_y, output;
<a name="l00903"></a>00903   grad_x.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html#a9c01939f01ef50314620e26aaacb04d3">set_size</a>(w,h);
<a name="l00904"></a>00904   grad_y.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html#a9c01939f01ef50314620e26aaacb04d3">set_size</a>(w,h);
<a name="l00905"></a>00905   output.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html#a9c01939f01ef50314620e26aaacb04d3">set_size</a>(w,h);
<a name="l00906"></a>00906   <a class="code" href="classbrip__vil__float__ops.html#a45ba9abd34128197b97a74ecfe18f50f" title="Returns the gradient using a 3x3 kernel.">brip_vil_float_ops::gradient_3x3</a>(input, grad_x, grad_y);
<a name="l00907"></a>00907   <a class="codeRef" doxygen="core_vul.tag:../../../../../core/vul/html" href="../../../../../core/vul/html/classvul__timer.html">vul_timer</a> t;
<a name="l00908"></a>00908   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> y = n; y&lt;h-n;y++)
<a name="l00909"></a>00909     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> x = n; x&lt;w-n;x++)
<a name="l00910"></a>00910     {
<a name="l00911"></a>00911       <span class="keywordtype">float</span> IxIx=0, IxIy=0, IyIy=0;
<a name="l00912"></a>00912       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = -n; i&lt;=n; i++)
<a name="l00913"></a>00913         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = -n; j&lt;=n; j++)
<a name="l00914"></a>00914         {
<a name="l00915"></a>00915           <span class="keywordtype">float</span> gx = grad_x(x+i, y+j), gy = grad_y(x+i, y+j);
<a name="l00916"></a>00916           IxIx += gx*gx;
<a name="l00917"></a>00917           IxIy += gx*gy;
<a name="l00918"></a>00918           IyIy += gy*gy;
<a name="l00919"></a>00919         }
<a name="l00920"></a>00920       <span class="keywordtype">float</span> det = (IxIx*IyIy-IxIy*IxIy)/(<span class="keywordtype">float</span>)N;
<a name="l00921"></a>00921       output(x,y)=vcl_sqrt(vcl_fabs(det));
<a name="l00922"></a>00922     }
<a name="l00923"></a>00923   <a class="code" href="classbrip__vil__float__ops.html#a99ebd3182f788d8147b60f177cee12ef" title="fills a border of width w on left and right of image with value.">brip_vil_float_ops::fill_x_border</a>(output, n, 0.0f);
<a name="l00924"></a>00924   <a class="code" href="classbrip__vil__float__ops.html#addf1ea3028581107a66b3b82ae89aab4" title="fills a border of height h on top and bottom of image with value.">brip_vil_float_ops::fill_y_border</a>(output, n, 0.0f);
<a name="l00925"></a>00925 <span class="preprocessor">#ifdef DEBUG</span>
<a name="l00926"></a>00926 <span class="preprocessor"></span>  vcl_cout &lt;&lt; <span class="stringliteral">&quot;\nCompute sqrt(sigma0*sigma1) in&quot;</span> &lt;&lt; t.<a class="codeRef" doxygen="core_vul.tag:../../../../../core/vul/html" href="../../../../../core/vul/html/classvul__timer.html#a14c86b3c27f36c1946c184941e006370">real</a>() &lt;&lt; <span class="stringliteral">&quot; msecs.\n&quot;</span>;
<a name="l00927"></a>00927 <span class="preprocessor">#endif</span>
<a name="l00928"></a>00928 <span class="preprocessor"></span>  <span class="keywordflow">return</span> output;
<a name="l00929"></a>00929 }
<a name="l00930"></a>00930 
<a name="l00931"></a>00931 <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> <a class="code" href="classbrip__vil__float__ops.html#af31bd65241c0fd6c05569d46f7e05e8d" title="Returns the image with max scale values.">brip_vil_float_ops::</a>
<a name="l00932"></a><a class="code" href="classbrip__vil__float__ops.html#af31bd65241c0fd6c05569d46f7e05e8d">00932</a> <a class="code" href="classbrip__vil__float__ops.html#af31bd65241c0fd6c05569d46f7e05e8d" title="Returns the image with max scale values.">max_scale_trace</a>(<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> input,
<a name="l00933"></a>00933                 <span class="keywordtype">float</span> min_scale, <span class="keywordtype">float</span> max_scale, <span class="keywordtype">float</span> scale_inc)
<a name="l00934"></a>00934 {
<a name="l00935"></a>00935   <span class="keywordtype">unsigned</span> ni = input.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a9ea9ad565387a61dccf38fc80a266c2a">ni</a>(), nj = input.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a44859c72206da7d18728cb2bbf8ae829">nj</a>();
<a name="l00936"></a>00936   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> tr_max, sc;
<a name="l00937"></a>00937   tr_max.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html#a9c01939f01ef50314620e26aaacb04d3">set_size</a>(ni, nj);
<a name="l00938"></a>00938   tr_max.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html#a6fd591632020e490abb5e4493a52dbba">fill</a>(0.0f);
<a name="l00939"></a>00939   sc.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html#a9c01939f01ef50314620e26aaacb04d3">set_size</a>(ni, nj);
<a name="l00940"></a>00940   sc.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html#a6fd591632020e490abb5e4493a52dbba">fill</a>(min_scale);
<a name="l00941"></a>00941   <span class="keywordflow">for</span> (<span class="keywordtype">float</span> s = min_scale; s&lt;=max_scale; s+=scale_inc)
<a name="l00942"></a>00942   {
<a name="l00943"></a>00943     <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> smooth = <a class="code" href="classbrip__vil__float__ops.html#a2c82165db7e252f7b843f61f5856dc3f" title="convolves with a Gaussian kernel.">brip_vil_float_ops::gaussian</a>(input, s);
<a name="l00944"></a>00944     <span class="keywordtype">unsigned</span> N = <span class="keyword">static_cast&lt;</span><span class="keywordtype">unsigned</span><span class="keyword">&gt;</span>(2.0f*s);
<a name="l00945"></a>00945     <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> tr =
<a name="l00946"></a>00946       <a class="code" href="classbrip__vil__float__ops.html#aa766d48d8ad212e16cff8a9537cefa12" title="Tr(IxIx.transpose) for a NxN region ($N = 2n+1$).">brip_vil_float_ops::trace_grad_matrix_NxN</a>(smooth, N);
<a name="l00947"></a>00947     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> r = 0; r&lt;nj; ++r)
<a name="l00948"></a>00948       <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> c = 0; c&lt;ni; ++c)
<a name="l00949"></a>00949       {
<a name="l00950"></a>00950         <span class="keywordtype">float</span> trv = s*s*tr(c,r);
<a name="l00951"></a>00951         <span class="keywordflow">if</span> (trv&gt;tr_max(c,r))
<a name="l00952"></a>00952         {
<a name="l00953"></a>00953           tr_max(c,r) = trv;
<a name="l00954"></a>00954           sc(c,r) = s;
<a name="l00955"></a>00955         }
<a name="l00956"></a>00956       }
<a name="l00957"></a>00957   }
<a name="l00958"></a>00958   <span class="keywordflow">return</span> sc;
<a name="l00959"></a>00959 }
<a name="l00960"></a>00960 
<a name="l00961"></a>00961 <span class="comment">//: exactly same as max_scale_trace, only return the image with actual trace values at max scales instead of the image with max scale values</span>
<a name="l00962"></a>00962 <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> <a class="code" href="classbrip__vil__float__ops.html#a1f0b34ba968bdbb44f9768074efccfd1" title="Exactly same as max_scale_trace, only return the image with actual trace values at max scales instead...">brip_vil_float_ops::</a>
<a name="l00963"></a><a class="code" href="classbrip__vil__float__ops.html#a1f0b34ba968bdbb44f9768074efccfd1">00963</a> <a class="code" href="classbrip__vil__float__ops.html#a1f0b34ba968bdbb44f9768074efccfd1" title="Exactly same as max_scale_trace, only return the image with actual trace values at max scales instead...">max_scale_trace_value</a>(<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> input,
<a name="l00964"></a>00964                       <span class="keywordtype">float</span> min_scale, <span class="keywordtype">float</span> max_scale, <span class="keywordtype">float</span> scale_inc)
<a name="l00965"></a>00965 {
<a name="l00966"></a>00966   <span class="keywordtype">unsigned</span> ni = input.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a9ea9ad565387a61dccf38fc80a266c2a">ni</a>(), nj = input.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a44859c72206da7d18728cb2bbf8ae829">nj</a>();
<a name="l00967"></a>00967   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> tr_max, sc;
<a name="l00968"></a>00968   tr_max.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html#a9c01939f01ef50314620e26aaacb04d3">set_size</a>(ni, nj);
<a name="l00969"></a>00969   tr_max.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html#a6fd591632020e490abb5e4493a52dbba">fill</a>(0.0f);
<a name="l00970"></a>00970   sc.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html#a9c01939f01ef50314620e26aaacb04d3">set_size</a>(ni, nj);
<a name="l00971"></a>00971   sc.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html#a6fd591632020e490abb5e4493a52dbba">fill</a>(min_scale);
<a name="l00972"></a>00972   <span class="keywordflow">for</span> (<span class="keywordtype">float</span> s = min_scale; s&lt;=max_scale; s+=scale_inc)
<a name="l00973"></a>00973   {
<a name="l00974"></a>00974     <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> smooth = <a class="code" href="classbrip__vil__float__ops.html#a2c82165db7e252f7b843f61f5856dc3f" title="convolves with a Gaussian kernel.">brip_vil_float_ops::gaussian</a>(input, s);
<a name="l00975"></a>00975     <span class="keywordtype">unsigned</span> N = <span class="keyword">static_cast&lt;</span><span class="keywordtype">unsigned</span><span class="keyword">&gt;</span>(2.0f*s);
<a name="l00976"></a>00976     <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> tr =
<a name="l00977"></a>00977       <a class="code" href="classbrip__vil__float__ops.html#aa766d48d8ad212e16cff8a9537cefa12" title="Tr(IxIx.transpose) for a NxN region ($N = 2n+1$).">brip_vil_float_ops::trace_grad_matrix_NxN</a>(smooth, N);
<a name="l00978"></a>00978     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> r = 0; r&lt;nj; ++r)
<a name="l00979"></a>00979       <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> c = 0; c&lt;ni; ++c)
<a name="l00980"></a>00980       {
<a name="l00981"></a>00981         <span class="keywordtype">float</span> trv = s*s*tr(c,r);
<a name="l00982"></a>00982         <span class="keywordflow">if</span> (trv&gt;tr_max(c,r))
<a name="l00983"></a>00983         {
<a name="l00984"></a>00984           tr_max(c,r) = trv;
<a name="l00985"></a>00985           sc(c,r) = s;
<a name="l00986"></a>00986         }
<a name="l00987"></a>00987       }
<a name="l00988"></a>00988   }
<a name="l00989"></a>00989   <span class="comment">// mask the region where integration region extends outside the image borders</span>
<a name="l00990"></a>00990   <span class="keywordtype">unsigned</span> N = <span class="keyword">static_cast&lt;</span><span class="keywordtype">unsigned</span><span class="keyword">&gt;</span>(5.0f*max_scale);
<a name="l00991"></a>00991   <span class="keywordtype">unsigned</span> njmax = nj-N;
<a name="l00992"></a>00992   <span class="keywordtype">unsigned</span> nimax = ni-N;
<a name="l00993"></a>00993   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> r = 0; r&lt;nj; ++r)
<a name="l00994"></a>00994     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> c = 0; c&lt;ni; ++c)
<a name="l00995"></a>00995     {
<a name="l00996"></a>00996       <span class="keywordflow">if</span> (r &lt;= N || r &gt;= njmax || c &lt;= N || c &gt;= nimax)
<a name="l00997"></a>00997         tr_max(c,r) = 0.0f;
<a name="l00998"></a>00998     }
<a name="l00999"></a>00999 
<a name="l01000"></a>01000   <span class="comment">// normalize the trace values</span>
<a name="l01001"></a>01001   <span class="keywordtype">float</span> min_b,max_b;
<a name="l01002"></a>01002   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/vil__math_8h.html#a3e16fe5a086f6c2c05c67e15edd6ebf6">vil_math_value_range</a>(tr_max,min_b,max_b);
<a name="l01003"></a>01003   vcl_cout &lt;&lt; <span class="stringliteral">&quot;in trace max image min value: &quot;</span> &lt;&lt; min_b &lt;&lt; <span class="stringliteral">&quot; max value: &quot;</span> &lt;&lt; max_b &lt;&lt; vcl_endl;
<a name="l01004"></a>01004 
<a name="l01005"></a>01005   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;double&gt;</a> tr_normalized, tr_stretched;
<a name="l01006"></a>01006   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/vil__convert_8h.html#a22b15212bd956ab84b9c9ab48130e5ec">vil_convert_stretch_range</a>(tr_max, tr_normalized, 0.0f, 1.0f);
<a name="l01007"></a>01007   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/vil__convert_8h.html#a22b15212bd956ab84b9c9ab48130e5ec">vil_convert_stretch_range</a>(tr_max, tr_stretched, 0.0f, 255.0f);
<a name="l01008"></a>01008   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> tr_cast;
<a name="l01009"></a>01009   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/vil__convert_8h.html#af543dee18b841e4ff83332687af942f2">vil_convert_cast</a>(tr_stretched, tr_cast);
<a name="l01010"></a>01010   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;vxl_byte&gt;</a> tr_cast_byte;
<a name="l01011"></a>01011   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/vil__convert_8h.html#af543dee18b841e4ff83332687af942f2">vil_convert_cast</a>(tr_stretched, tr_cast_byte);
<a name="l01012"></a>01012   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/vil__save_8cxx.html#aaeafd48e43bac2e455f0a9c6d4532a30">vil_save_image_resource</a>(<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/vil__new_8cxx.html#a7d991bbca1ecd8b4c0917c36ec4b27c6">vil_new_image_resource_of_view</a>(tr_cast_byte), <span class="stringliteral">&quot;D:\\projects\\vehicle_rec_on_models\\trace_image.png&quot;</span>);
<a name="l01013"></a>01013 
<a name="l01014"></a>01014 <span class="preprocessor">#if 0 // commented out</span>
<a name="l01015"></a>01015 <span class="preprocessor"></span>  <span class="comment">// investigate illumination invariance</span>
<a name="l01016"></a>01016   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> modified_input = input;
<a name="l01017"></a>01017   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> const_image(ni, nj);
<a name="l01018"></a>01018   const_image.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html#a6fd591632020e490abb5e4493a52dbba">fill</a>(3.0f);
<a name="l01019"></a>01019   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> r = 0; r&lt;nj; ++r)
<a name="l01020"></a>01020     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> c = 0; c&lt;ni; ++c)
<a name="l01021"></a>01021     {
<a name="l01022"></a>01022       <span class="keywordflow">if</span> (modified_input(c,r) &lt; 120 || modified_input(c,r) &gt; 95) = modified_input(c,r)*const_image(c,r);
<a name="l01023"></a>01023     }
<a name="l01024"></a>01024 
<a name="l01025"></a>01025   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;vxl_byte&gt;</a> mod_cast;
<a name="l01026"></a>01026   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/vil__convert_8h.html#af543dee18b841e4ff83332687af942f2">vil_convert_cast</a>(modified_input, mod_cast);
<a name="l01027"></a>01027   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/vil__save_8cxx.html#aaeafd48e43bac2e455f0a9c6d4532a30">vil_save_image_resource</a>(<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/vil__new_8cxx.html#a7d991bbca1ecd8b4c0917c36ec4b27c6">vil_new_image_resource_of_view</a>(mod_cast), <span class="stringliteral">&quot;D:\\projects\\vehicle_rec_on_models\\modified_image.png&quot;</span>);
<a name="l01028"></a>01028 
<a name="l01029"></a>01029   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> tr_max2, sc2;
<a name="l01030"></a>01030   tr_max2.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html#a9c01939f01ef50314620e26aaacb04d3">set_size</a>(ni, nj);
<a name="l01031"></a>01031   tr_max2.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html#a6fd591632020e490abb5e4493a52dbba">fill</a>(0.0f);
<a name="l01032"></a>01032   sc2.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html#a9c01939f01ef50314620e26aaacb04d3">set_size</a>(ni, nj);
<a name="l01033"></a>01033   sc2.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html#a6fd591632020e490abb5e4493a52dbba">fill</a>(min_scale);
<a name="l01034"></a>01034   <span class="keywordflow">for</span> (<span class="keywordtype">float</span> s = min_scale; s&lt;=max_scale; s+=scale_inc)
<a name="l01035"></a>01035   {
<a name="l01036"></a>01036     <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> smooth = <a class="code" href="classbrip__vil__float__ops.html#a2c82165db7e252f7b843f61f5856dc3f" title="convolves with a Gaussian kernel.">brip_vil_float_ops::gaussian</a>(modified_input, s);
<a name="l01037"></a>01037     <span class="keywordtype">unsigned</span> N = <span class="keyword">static_cast&lt;</span><span class="keywordtype">unsigned</span><span class="keyword">&gt;</span>(2.0f*s);
<a name="l01038"></a>01038     <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> tr =
<a name="l01039"></a>01039       <a class="code" href="classbrip__vil__float__ops.html#aa766d48d8ad212e16cff8a9537cefa12" title="Tr(IxIx.transpose) for a NxN region ($N = 2n+1$).">brip_vil_float_ops::trace_grad_matrix_NxN</a>(smooth, N);
<a name="l01040"></a>01040     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> r = 0; r&lt;nj; ++r)
<a name="l01041"></a>01041       <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> c = 0; c&lt;ni; ++c)
<a name="l01042"></a>01042       {
<a name="l01043"></a>01043         <span class="keywordtype">float</span> trv = s*s*tr(c,r);
<a name="l01044"></a>01044         <span class="keywordflow">if</span> (trv&gt;tr_max2(c,r))
<a name="l01045"></a>01045         {
<a name="l01046"></a>01046           tr_max2(c,r) = trv;
<a name="l01047"></a>01047           sc2(c,r) = s;
<a name="l01048"></a>01048         }
<a name="l01049"></a>01049       }
<a name="l01050"></a>01050   }
<a name="l01051"></a>01051   <span class="comment">// mask the region where integration region extends outside the image borders</span>
<a name="l01052"></a>01052   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> r = 0; r&lt;nj; ++r)
<a name="l01053"></a>01053     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> c = 0; c&lt;ni; ++c)
<a name="l01054"></a>01054     {
<a name="l01055"></a>01055       <span class="keywordflow">if</span> (r &lt;= N || r &gt;= njmax || c &lt;= N || c &gt;= nimax)
<a name="l01056"></a>01056         tr_max2(c,r) = 0.0f;
<a name="l01057"></a>01057     }
<a name="l01058"></a>01058 
<a name="l01059"></a>01059   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/vil__math_8h.html#a3e16fe5a086f6c2c05c67e15edd6ebf6">vil_math_value_range</a>(tr_max2,min_b,max_b);
<a name="l01060"></a>01060   vcl_cout &lt;&lt; <span class="stringliteral">&quot;in trace max2 image min value: &quot;</span> &lt;&lt; min_b &lt;&lt; <span class="stringliteral">&quot; max value: &quot;</span> &lt;&lt; max_b &lt;&lt; vcl_endl;
<a name="l01061"></a>01061 
<a name="l01062"></a>01062   <span class="comment">// normalize</span>
<a name="l01063"></a>01063   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;double&gt;</a> tr_normalized2;
<a name="l01064"></a>01064   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/vil__convert_8h.html#a22b15212bd956ab84b9c9ab48130e5ec">vil_convert_stretch_range</a>(tr_max2, tr_normalized2, 0.0f, 1.0f);
<a name="l01065"></a>01065 
<a name="l01066"></a>01066   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;double&gt;</a> difference_image = tr_normalized;
<a name="l01067"></a>01067   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> r = 0; r&lt;nj; ++r)
<a name="l01068"></a>01068     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> c = 0; c&lt;ni; ++c)
<a name="l01069"></a>01069     {
<a name="l01070"></a>01070       difference_image(c,r) = vcl_abs(difference_image(c,r) - tr_normalized2(c,r));
<a name="l01071"></a>01071     }
<a name="l01072"></a>01072   <span class="keywordtype">double</span> min_bd, max_bd;
<a name="l01073"></a>01073   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/vil__math_8h.html#a3e16fe5a086f6c2c05c67e15edd6ebf6">vil_math_value_range</a>(difference_image,min_bd,max_bd);
<a name="l01074"></a>01074   vcl_cout &lt;&lt; <span class="stringliteral">&quot;in difference image of normalized trace images min value: &quot;</span> &lt;&lt; min_bd &lt;&lt; <span class="stringliteral">&quot; max value: &quot;</span> &lt;&lt; max_bd &lt;&lt; vcl_endl;
<a name="l01075"></a>01075   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;vxl_byte&gt;</a> dif_cast;
<a name="l01076"></a>01076   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/vil__convert_8h.html#af543dee18b841e4ff83332687af942f2">vil_convert_cast</a>(difference_image, dif_cast);
<a name="l01077"></a>01077   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/vil__save_8cxx.html#aaeafd48e43bac2e455f0a9c6d4532a30">vil_save_image_resource</a>(<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/vil__new_8cxx.html#a7d991bbca1ecd8b4c0917c36ec4b27c6">vil_new_image_resource_of_view</a>(dif_cast), <span class="stringliteral">&quot;D:\\projects\\vehicle_rec_on_models\\difference_image.png&quot;</span>);
<a name="l01078"></a>01078 
<a name="l01079"></a>01079   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;double&gt;</a> tr_stretched2;
<a name="l01080"></a>01080   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/vil__convert_8h.html#a22b15212bd956ab84b9c9ab48130e5ec">vil_convert_stretch_range</a>(tr_max2, tr_stretched2, 0.0f, 255.0f);
<a name="l01081"></a>01081   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> tr_cast2;
<a name="l01082"></a>01082   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/vil__convert_8h.html#af543dee18b841e4ff83332687af942f2">vil_convert_cast</a>(tr_stretched2, tr_cast2);
<a name="l01083"></a>01083   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;vxl_byte&gt;</a> tr_cast2_byte;
<a name="l01084"></a>01084   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/vil__convert_8h.html#af543dee18b841e4ff83332687af942f2">vil_convert_cast</a>(tr_stretched2, tr_cast2_byte);
<a name="l01085"></a>01085   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/vil__save_8cxx.html#aaeafd48e43bac2e455f0a9c6d4532a30">vil_save_image_resource</a>(<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/vil__new_8cxx.html#a7d991bbca1ecd8b4c0917c36ec4b27c6">vil_new_image_resource_of_view</a>(tr_cast2_byte), <span class="stringliteral">&quot;D:\\projects\\vehicle_rec_on_models\\trace_image2.png&quot;</span>);
<a name="l01086"></a>01086 
<a name="l01087"></a>01087   <span class="keywordflow">return</span> tr_cast2;
<a name="l01088"></a>01088 <span class="preprocessor">#else // 0</span>
<a name="l01089"></a>01089 <span class="preprocessor"></span>  <span class="keywordflow">return</span> tr_cast;
<a name="l01090"></a>01090 <span class="preprocessor">#endif // 0</span>
<a name="l01091"></a>01091 <span class="preprocessor"></span>}
<a name="l01092"></a>01092 
<a name="l01093"></a>01093 
<a name="l01094"></a>01094 <span class="comment">//---------------------------------------------------------------------</span>
<a name="l01095"></a>01095 <span class="comment">// Lucas-Kanade motion vectors:  Solve for the motion vectors over a</span>
<a name="l01096"></a>01096 <span class="comment">// (2n+1)x(2n+1) neighborhood. The time derivative of intensity is computed</span>
<a name="l01097"></a>01097 <span class="comment">// from the previous_frame. The threshold eliminates small values of</span>
<a name="l01098"></a>01098 <span class="comment">// the product of the time derivative and the motion matrix eigenvalues,</span>
<a name="l01099"></a>01099 <span class="comment">// i.e, |lambda_1*lambda_2*dI/dt|&lt;thresh.  Thus motion is only reported when</span>
<a name="l01100"></a>01100 <span class="comment">// the solution is well-conditioned.</span>
<a name="l01101"></a>01101 <span class="comment">//</span>
<a name="l01102"></a>01102 <span class="keywordtype">void</span>
<a name="l01103"></a><a class="code" href="classbrip__vil__float__ops.html#a9157e3d2ce6639f755aa1b7533436726">01103</a> <a class="code" href="classbrip__vil__float__ops.html#a9157e3d2ce6639f755aa1b7533436726" title="computes Lucas-Kanade optical flow on a $2n+1$ neighborhood.">brip_vil_float_ops::Lucas_KanadeMotion</a>(<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> &amp; current_frame,
<a name="l01104"></a>01104                                        <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> &amp; previous_frame,
<a name="l01105"></a>01105                                        <span class="keywordtype">int</span> n, <span class="keywordtype">double</span> thresh,
<a name="l01106"></a>01106                                        <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a>&amp; vx,
<a name="l01107"></a>01107                                        <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a>&amp; vy)
<a name="l01108"></a>01108 {
<a name="l01109"></a>01109   <span class="keywordtype">int</span> N = (2*n+1)*(2*n+1);
<a name="l01110"></a>01110   <span class="keywordtype">int</span> w = <span class="keyword">static_cast&lt;</span><span class="keywordtype">int</span><span class="keyword">&gt;</span>(current_frame.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a9ea9ad565387a61dccf38fc80a266c2a">ni</a>()), h = static_cast&lt;int&gt;(current_frame.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a44859c72206da7d18728cb2bbf8ae829">nj</a>());
<a name="l01111"></a>01111   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> grad_x, grad_y, diff;
<a name="l01112"></a>01112   grad_x.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html#a9c01939f01ef50314620e26aaacb04d3">set_size</a>(w,h);
<a name="l01113"></a>01113   grad_y.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html#a9c01939f01ef50314620e26aaacb04d3">set_size</a>(w,h);
<a name="l01114"></a>01114   <span class="comment">// compute the gradient vector and the time derivative</span>
<a name="l01115"></a>01115   <a class="code" href="classbrip__vil__float__ops.html#a45ba9abd34128197b97a74ecfe18f50f" title="Returns the gradient using a 3x3 kernel.">brip_vil_float_ops::gradient_3x3</a>(current_frame, grad_x, grad_y);
<a name="l01116"></a>01116   diff = <a class="code" href="classbrip__vil__float__ops.html#a8a34499b91e321beff2beb67d131aac7" title="subtracts image_1 from image_2.">brip_vil_float_ops::difference</a>(previous_frame, current_frame);
<a name="l01117"></a>01117   <a class="codeRef" doxygen="core_vul.tag:../../../../../core/vul/html" href="../../../../../core/vul/html/classvul__timer.html">vul_timer</a> t;
<a name="l01118"></a>01118   <span class="comment">// sum the motion terms over the (2n+1)x(2n+1) neighborhood.</span>
<a name="l01119"></a>01119   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> y = n; y&lt;h-n;y++)
<a name="l01120"></a>01120     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> x = n; x&lt;w-n;x++)
<a name="l01121"></a>01121     {
<a name="l01122"></a>01122       <span class="keywordtype">float</span> IxIx=0, IxIy=0, IyIy=0, IxIt=0, IyIt=0;
<a name="l01123"></a>01123       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = -n; i&lt;=n; i++)
<a name="l01124"></a>01124         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = -n; j&lt;=n; j++)
<a name="l01125"></a>01125         {
<a name="l01126"></a>01126           <span class="keywordtype">float</span> gx = grad_x(x+i, y+j), gy = grad_y(x+i, y+j);
<a name="l01127"></a>01127           <span class="keywordtype">float</span> dt = diff(x+i, y+j);
<a name="l01128"></a>01128           IxIx += gx*gx;
<a name="l01129"></a>01129           IxIy += gx*gy;
<a name="l01130"></a>01130           IyIy += gy*gy;
<a name="l01131"></a>01131           IxIt += gx*dt;
<a name="l01132"></a>01132           IyIt += gy*dt;
<a name="l01133"></a>01133         }
<a name="l01134"></a>01134       <span class="comment">//Divide by the number of pixels in the neighborhood</span>
<a name="l01135"></a>01135       IxIx/=N;  IxIy/=N; IyIy/=N; IxIt/=N; IyIt/=N;
<a name="l01136"></a>01136       <span class="keywordtype">float</span> det = float(IxIx*IyIy-IxIy*IxIy);
<a name="l01137"></a>01137       <span class="comment">//Eliminate small motion factors</span>
<a name="l01138"></a>01138       <span class="keywordtype">float</span> dif = diff(x,y);
<a name="l01139"></a>01139       <span class="keywordtype">float</span> motion_factor = vcl_fabs(det*dif);
<a name="l01140"></a>01140       <span class="keywordflow">if</span> (motion_factor&lt;thresh)
<a name="l01141"></a>01141       {
<a name="l01142"></a>01142         vx(x,y) = 0.0f;
<a name="l01143"></a>01143         vy(x,y) = 0.0f;
<a name="l01144"></a>01144         <span class="keywordflow">continue</span>;
<a name="l01145"></a>01145       }
<a name="l01146"></a>01146       <span class="comment">//solve for the motion vector</span>
<a name="l01147"></a>01147       vx(x,y) = (IyIy*IxIt-IxIy*IyIt)/det;
<a name="l01148"></a>01148       vy(x,y) = (-IxIy*IxIt + IxIx*IyIt)/det;
<a name="l01149"></a>01149     }
<a name="l01150"></a>01150   <a class="code" href="classbrip__vil__float__ops.html#a99ebd3182f788d8147b60f177cee12ef" title="fills a border of width w on left and right of image with value.">brip_vil_float_ops::fill_x_border</a>(vx, n, 0.0f);
<a name="l01151"></a>01151   <a class="code" href="classbrip__vil__float__ops.html#addf1ea3028581107a66b3b82ae89aab4" title="fills a border of height h on top and bottom of image with value.">brip_vil_float_ops::fill_y_border</a>(vx, n, 0.0f);
<a name="l01152"></a>01152   <a class="code" href="classbrip__vil__float__ops.html#a99ebd3182f788d8147b60f177cee12ef" title="fills a border of width w on left and right of image with value.">brip_vil_float_ops::fill_x_border</a>(vy, n, 0.0f);
<a name="l01153"></a>01153   <a class="code" href="classbrip__vil__float__ops.html#addf1ea3028581107a66b3b82ae89aab4" title="fills a border of height h on top and bottom of image with value.">brip_vil_float_ops::fill_y_border</a>(vy, n, 0.0f);
<a name="l01154"></a>01154 <span class="preprocessor">#ifdef DEBUG</span>
<a name="l01155"></a>01155 <span class="preprocessor"></span>  vcl_cout &lt;&lt; <span class="stringliteral">&quot;\nCompute Lucas-Kanade in &quot;</span> &lt;&lt; t.<a class="codeRef" doxygen="core_vul.tag:../../../../../core/vul/html" href="../../../../../core/vul/html/classvul__timer.html#a14c86b3c27f36c1946c184941e006370">real</a>() &lt;&lt; <span class="stringliteral">&quot; msecs.\n&quot;</span>;
<a name="l01156"></a>01156 <span class="preprocessor">#endif</span>
<a name="l01157"></a>01157 <span class="preprocessor"></span>}
<a name="l01158"></a>01158 
<a name="l01159"></a>01159 <span class="comment">//: computes Lucas-Kanade optical flow on the complete input views</span>
<a name="l01160"></a>01160 <span class="keywordtype">void</span> <a class="code" href="classbrip__vil__float__ops.html#ac5ee1e95d8515b4c6ac79d438d49fa29" title="computes velocity of a region(view) using Lucas Kanade.">brip_vil_float_ops::</a>
<a name="l01161"></a><a class="code" href="classbrip__vil__float__ops.html#ac5ee1e95d8515b4c6ac79d438d49fa29">01161</a> <a class="code" href="classbrip__vil__float__ops.html#ac5ee1e95d8515b4c6ac79d438d49fa29" title="computes velocity of a region(view) using Lucas Kanade.">lucas_kanade_motion_on_view</a>(<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> <span class="keyword">const</span>&amp; curr_frame,
<a name="l01162"></a>01162                             <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> <span class="keyword">const</span>&amp; prev_frame,
<a name="l01163"></a>01163                             <span class="keyword">const</span> <span class="keywordtype">double</span> thresh,
<a name="l01164"></a>01164                             <span class="keywordtype">float</span>&amp; vx,
<a name="l01165"></a>01165                             <span class="keywordtype">float</span>&amp; vy)
<a name="l01166"></a>01166 {
<a name="l01167"></a>01167   <span class="keywordtype">unsigned</span> w = curr_frame.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a9ea9ad565387a61dccf38fc80a266c2a">ni</a>(), h = curr_frame.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a44859c72206da7d18728cb2bbf8ae829">nj</a>();
<a name="l01168"></a>01168   <span class="keywordtype">unsigned</span> N  = w*h;
<a name="l01169"></a>01169   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> grad_x, grad_y;
<a name="l01170"></a>01170   grad_x.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html#a9c01939f01ef50314620e26aaacb04d3">set_size</a>(w,h);
<a name="l01171"></a>01171   grad_y.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html#a9c01939f01ef50314620e26aaacb04d3">set_size</a>(w,h);
<a name="l01172"></a>01172   <span class="comment">// compute the gradient vector and the time derivative</span>
<a name="l01173"></a>01173   <a class="code" href="classbrip__vil__float__ops.html#a45ba9abd34128197b97a74ecfe18f50f" title="Returns the gradient using a 3x3 kernel.">brip_vil_float_ops::gradient_3x3</a>(curr_frame, grad_x, grad_y);
<a name="l01174"></a>01174   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> diff =
<a name="l01175"></a>01175     <a class="code" href="classbrip__vil__float__ops.html#a8a34499b91e321beff2beb67d131aac7" title="subtracts image_1 from image_2.">brip_vil_float_ops::difference</a>(prev_frame, curr_frame);
<a name="l01176"></a>01176 
<a name="l01177"></a>01177   <span class="comment">// sum the motion terms over the view</span>
<a name="l01178"></a>01178   <span class="keywordtype">float</span> IxIx=0.0f, IxIy=0.0f, IyIy=0.0f, IxIt=0.0f, IyIt=0.0f, dsum=0.0f;
<a name="l01179"></a>01179   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> j = 0; j&lt;h; j++)
<a name="l01180"></a>01180     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> i = 0; i&lt;w; i++)
<a name="l01181"></a>01181     {
<a name="l01182"></a>01182       <span class="keywordtype">float</span> gx = grad_x(i, j), gy = grad_y(i, j);
<a name="l01183"></a>01183       <span class="keywordtype">float</span> dt = diff(i, j);
<a name="l01184"></a>01184       dsum += dt*dt;
<a name="l01185"></a>01185       IxIx += gx*gx;
<a name="l01186"></a>01186       IxIy += gx*gy;
<a name="l01187"></a>01187       IyIy += gy*gy;
<a name="l01188"></a>01188       IxIt += gx*dt;
<a name="l01189"></a>01189       IyIt += gy*dt;
<a name="l01190"></a>01190     }
<a name="l01191"></a>01191   <span class="comment">// Divide by the number of pixels in the neighborhood</span>
<a name="l01192"></a>01192   IxIx/=(float)N;  IxIy/=(float)N; IyIy/=(float)N; IxIt/=(float)N; IyIt/=(float)N; dsum/=(float)N;
<a name="l01193"></a>01193   <span class="keywordtype">float</span> det = float(IxIx*IyIy-IxIy*IxIy);
<a name="l01194"></a>01194   <span class="comment">// Eliminate small motion factors</span>
<a name="l01195"></a>01195   <span class="keywordtype">float</span> dif = vcl_sqrt(dsum);
<a name="l01196"></a>01196   <span class="keywordtype">float</span> motion_factor = vcl_fabs(det*dif);
<a name="l01197"></a>01197   <span class="keywordflow">if</span> (motion_factor&lt;thresh)
<a name="l01198"></a>01198   {
<a name="l01199"></a>01199     vx = 0.0f;
<a name="l01200"></a>01200     vy = 0.0f;
<a name="l01201"></a>01201     <span class="keywordflow">return</span>;
<a name="l01202"></a>01202   }
<a name="l01203"></a>01203   <span class="comment">// solve for the motion vector</span>
<a name="l01204"></a>01204   vx = (IyIy*IxIt-IxIy*IyIt)/det;
<a name="l01205"></a>01205   vy = (-IxIy*IxIt + IxIx*IyIt)/det;
<a name="l01206"></a>01206 }
<a name="l01207"></a>01207 
<a name="l01208"></a>01208 <span class="comment">//------------------------------------------------------------------------</span>
<a name="l01209"></a>01209 <span class="comment">// Assume that curr match region is larger than prev_region by the required</span>
<a name="l01210"></a>01210 <span class="comment">// search ranges. Step through the search and output the shift that</span>
<a name="l01211"></a>01211 <span class="comment">// maximizes the correlation. zero_i and zero_j indicate the curr_image</span>
<a name="l01212"></a>01212 <span class="comment">// pixel location corresponding to no velocity between frames</span>
<a name="l01213"></a>01213 <span class="keywordtype">void</span> <a class="code" href="classbrip__vil__float__ops.html#a68b46c91f8725eb38db88a2a38628c66" title="computes velocity of a region(view) using correlation.">brip_vil_float_ops::</a>
<a name="l01214"></a><a class="code" href="classbrip__vil__float__ops.html#a68b46c91f8725eb38db88a2a38628c66">01214</a> <a class="code" href="classbrip__vil__float__ops.html#a68b46c91f8725eb38db88a2a38628c66" title="computes velocity of a region(view) using correlation.">velocity_by_correlation</a>(<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> <span class="keyword">const</span>&amp; curr_image,
<a name="l01215"></a>01215                         <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> <span class="keyword">const</span>&amp; prev_region,
<a name="l01216"></a>01216                         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> start_i, <span class="keyword">const</span> <span class="keywordtype">unsigned</span> end_i,
<a name="l01217"></a>01217                         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> start_j, <span class="keyword">const</span> <span class="keywordtype">unsigned</span> end_j,
<a name="l01218"></a>01218                         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> zero_i, <span class="keyword">const</span> <span class="keywordtype">unsigned</span> zero_j,
<a name="l01219"></a>01219                         <span class="keywordtype">float</span>&amp; vx,
<a name="l01220"></a>01220                         <span class="keywordtype">float</span>&amp; vy)
<a name="l01221"></a>01221 {
<a name="l01222"></a>01222   <span class="keywordtype">unsigned</span> ni = prev_region.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a9ea9ad565387a61dccf38fc80a266c2a">ni</a>(), nj = prev_region.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a44859c72206da7d18728cb2bbf8ae829">nj</a>();
<a name="l01223"></a>01223   <span class="keywordtype">float</span> corr_max = -10.0f;
<a name="l01224"></a>01224   <span class="keywordtype">float</span> vx0 = <span class="keyword">static_cast&lt;</span><span class="keywordtype">float</span><span class="keyword">&gt;</span>(zero_i);
<a name="l01225"></a>01225   <span class="keywordtype">float</span> vy0 = <span class="keyword">static_cast&lt;</span><span class="keywordtype">float</span><span class="keyword">&gt;</span>(zero_j);
<a name="l01226"></a>01226   <span class="keywordtype">float</span> area = <span class="keyword">static_cast&lt;</span><span class="keywordtype">float</span><span class="keyword">&gt;</span>(ni*nj);
<a name="l01227"></a>01227   vx = 0; vy = 0;
<a name="l01228"></a>01228   <span class="keywordtype">unsigned</span> max_i = start_i, max_j = start_j;
<a name="l01229"></a>01229   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> j = start_j; j&lt;=end_j; ++j)
<a name="l01230"></a>01230     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> i = start_i; i&lt;=end_i; ++i)
<a name="l01231"></a>01231     {
<a name="l01232"></a>01232       <span class="keywordtype">float</span> si1 = 0, si2 = 0, si1i1 = 0, si2i2 = 0, si1i2 = 0;
<a name="l01233"></a>01233       <span class="comment">//sum over the region</span>
<a name="l01234"></a>01234       <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> r = 0; r&lt;nj; ++r)
<a name="l01235"></a>01235         <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> c = 0; c&lt;ni; ++c)
<a name="l01236"></a>01236         {
<a name="l01237"></a>01237           <span class="keywordtype">float</span> I1 = prev_region(c, r);
<a name="l01238"></a>01238           <span class="keywordtype">float</span> I2 = curr_image(i+c, j+r);
<a name="l01239"></a>01239           si1 += I1; si2 += I2;
<a name="l01240"></a>01240           si1i1 += I1*I1;
<a name="l01241"></a>01241           si2i2 += I2*I2;
<a name="l01242"></a>01242           si1i2 += I1*I2;
<a name="l01243"></a>01243         }
<a name="l01244"></a>01244       <span class="keywordtype">float</span> corr = cross_corr(area, si1, si2, si1i1, si2i2,si1i2, 1.0f);
<a name="l01245"></a>01245       <span class="keywordflow">if</span> (corr&gt;corr_max)
<a name="l01246"></a>01246       {
<a name="l01247"></a>01247         corr_max = corr;
<a name="l01248"></a>01248         max_i = i; max_j = j;
<a name="l01249"></a>01249       }
<a name="l01250"></a>01250 <span class="preprocessor">#if 0</span>
<a name="l01251"></a>01251 <span class="preprocessor"></span>      <span class="keywordtype">float</span> di = i-vx0, dj = j-vy0;
<a name="l01252"></a>01252       vcl_cout &lt;&lt;  di &lt;&lt; <span class="charliteral">&#39;\t&#39;</span> &lt;&lt; dj &lt;&lt; <span class="charliteral">&#39;\t&#39;</span> &lt;&lt; corr &lt;&lt; <span class="charliteral">&#39;\n&#39;</span>;
<a name="l01253"></a>01253 <span class="preprocessor">#endif</span>
<a name="l01254"></a>01254 <span class="preprocessor"></span>    }
<a name="l01255"></a>01255   <span class="comment">// the velocity is given by the max indices relative to the zero location</span>
<a name="l01256"></a>01256   vx = <span class="keyword">static_cast&lt;</span><span class="keywordtype">float</span><span class="keyword">&gt;</span>(max_i)- vx0;
<a name="l01257"></a>01257   vy = <span class="keyword">static_cast&lt;</span><span class="keywordtype">float</span><span class="keyword">&gt;</span>(max_j) - vy0;
<a name="l01258"></a>01258   <span class="comment">// vcl_cout &lt;&lt; &#39;(&#39; &lt;&lt; vx &lt;&lt; &#39; &#39; &lt;&lt; vy &lt;&lt; &quot;): &quot; &lt;&lt; corr_max &lt;&lt; &#39;\n&#39;;</span>
<a name="l01259"></a>01259 }
<a name="l01260"></a>01260 
<a name="l01261"></a>01261 <span class="comment">//---------------------------------------------------------------------</span>
<a name="l01262"></a>01262 <span class="comment">// Horn-Schunk method for calc. motion vectors:  Solve for the motion vectors</span>
<a name="l01263"></a>01263 <span class="comment">// iteratively using a cost function with two terms (RHS of optical flow eqn</span>
<a name="l01264"></a>01264 <span class="comment">// and the magnitude of spatial derivatives of the velocity field</span>
<a name="l01265"></a>01265 <span class="comment">// (so that pixel-to-pixel variations are small). The second term is</span>
<a name="l01266"></a>01266 <span class="comment">// weighted by alpha_coef term. The iteration goes on until the error</span>
<a name="l01267"></a>01267 <span class="comment">// reaches below err_thresh</span>
<a name="l01268"></a>01268 <span class="comment">//  Error conditions:</span>
<a name="l01269"></a>01269 <span class="comment">//  -  -1  -  current_frame and previous_frame are equal</span>
<a name="l01270"></a>01270 <span class="comment">//  -  -2  -  at least one input frame or internal process image is all zeros</span>
<a name="l01271"></a>01271 <span class="comment">//  -   0  -  routine was successful</span>
<a name="l01272"></a>01272 
<a name="l01273"></a>01273 <span class="keywordtype">int</span> <a class="code" href="classbrip__vil__float__ops.html#af15d30f55dae567cc0386b206da2addf" title="computes optical flow using Horn and Schunck&#39;s method.">brip_vil_float_ops::</a>
<a name="l01274"></a><a class="code" href="classbrip__vil__float__ops.html#af15d30f55dae567cc0386b206da2addf">01274</a> <a class="code" href="classbrip__vil__float__ops.html#af15d30f55dae567cc0386b206da2addf" title="computes optical flow using Horn and Schunck&#39;s method.">Horn_SchunckMotion</a>(<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> <span class="keyword">const</span>&amp; current_frame,
<a name="l01275"></a>01275                    <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> <span class="keyword">const</span>&amp; previous_frame,
<a name="l01276"></a>01276                    <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a>&amp; vx,
<a name="l01277"></a>01277                    <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a>&amp; vy,
<a name="l01278"></a>01278                    <span class="keyword">const</span> <span class="keywordtype">float</span> alpha_coef,
<a name="l01279"></a>01279                    <span class="keyword">const</span> <span class="keywordtype">int</span> no_of_iterations)
<a name="l01280"></a>01280 {
<a name="l01281"></a>01281   <span class="comment">// Check for equal images</span>
<a name="l01282"></a>01282   <span class="keywordflow">if</span> (<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/vil__image__view_8h.html#ae6285651019d9b0932905feb98618733">vil_image_view_deep_equality</a> (previous_frame, current_frame ) )
<a name="l01283"></a>01283   {
<a name="l01284"></a>01284     vcl_cout&lt;&lt;<span class="stringliteral">&quot;Images are same&quot;</span>;
<a name="l01285"></a>01285     <span class="keywordflow">return</span> -1;
<a name="l01286"></a>01286   }
<a name="l01287"></a>01287 
<a name="l01288"></a>01288   <span class="comment">// Declarations</span>
<a name="l01289"></a>01289   <span class="keywordtype">unsigned</span> w = current_frame.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a9ea9ad565387a61dccf38fc80a266c2a">ni</a>(), h = current_frame.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a44859c72206da7d18728cb2bbf8ae829">nj</a>();
<a name="l01290"></a>01290 
<a name="l01291"></a>01291   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> grad_x, grad_y, diff;
<a name="l01292"></a>01292 
<a name="l01293"></a>01293   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> temp1;
<a name="l01294"></a>01294   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> temp2;
<a name="l01295"></a>01295 
<a name="l01296"></a>01296   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> emptyimg;
<a name="l01297"></a>01297 
<a name="l01298"></a>01298   <span class="comment">// Size Init</span>
<a name="l01299"></a>01299 
<a name="l01300"></a>01300   grad_x.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html#a9c01939f01ef50314620e26aaacb04d3">set_size</a>(w,h);
<a name="l01301"></a>01301   grad_y.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html#a9c01939f01ef50314620e26aaacb04d3">set_size</a>(w,h);
<a name="l01302"></a>01302   diff.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html#a9c01939f01ef50314620e26aaacb04d3">set_size</a>(w,h);
<a name="l01303"></a>01303   temp1.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html#a9c01939f01ef50314620e26aaacb04d3">set_size</a>(w,h);
<a name="l01304"></a>01304   temp2.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html#a9c01939f01ef50314620e26aaacb04d3">set_size</a>(w,h);
<a name="l01305"></a>01305 
<a name="l01306"></a>01306   emptyimg.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html#a9c01939f01ef50314620e26aaacb04d3">set_size</a>(w,h);
<a name="l01307"></a>01307 
<a name="l01308"></a>01308   temp1.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html#a6fd591632020e490abb5e4493a52dbba">fill</a>(0.0);
<a name="l01309"></a>01309   temp2.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html#a6fd591632020e490abb5e4493a52dbba">fill</a>(0.0);
<a name="l01310"></a>01310 
<a name="l01311"></a>01311   <span class="comment">// Initialization</span>
<a name="l01312"></a>01312   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> y = 0; y&lt;h; y++)
<a name="l01313"></a>01313     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> x = 0; x&lt;w; x++)
<a name="l01314"></a>01314     {
<a name="l01315"></a>01315       vx(x,y)=0.0f;
<a name="l01316"></a>01316       vy(x,y)=0.0f;
<a name="l01317"></a>01317       diff (x,y)=0.0f;
<a name="l01318"></a>01318       grad_x (x, y)= 0.0f;
<a name="l01319"></a>01319       grad_y (x, y)= 0.0f;
<a name="l01320"></a>01320 
<a name="l01321"></a>01321       emptyimg (x, y) = 0.0f;
<a name="l01322"></a>01322     }
<a name="l01323"></a>01323 
<a name="l01324"></a>01324   <span class="comment">// Check for empty images</span>
<a name="l01325"></a>01325   <span class="keywordflow">if</span> ( (<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/vil__image__view_8h.html#ae6285651019d9b0932905feb98618733">vil_image_view_deep_equality</a> (emptyimg, current_frame )) || (<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/vil__image__view_8h.html#ae6285651019d9b0932905feb98618733">vil_image_view_deep_equality</a>(emptyimg, previous_frame)))
<a name="l01326"></a>01326   {
<a name="l01327"></a>01327     vcl_cout&lt;&lt;<span class="stringliteral">&quot;Image is empty&quot;</span>;
<a name="l01328"></a>01328     <span class="keywordflow">return</span> -2;
<a name="l01329"></a>01329   }
<a name="l01330"></a>01330 
<a name="l01331"></a>01331   <span class="comment">// compute the gradient vector for current and previous</span>
<a name="l01332"></a>01332   <a class="code" href="classbrip__vil__float__ops.html#a45ba9abd34128197b97a74ecfe18f50f" title="Returns the gradient using a 3x3 kernel.">brip_vil_float_ops::gradient_3x3</a> (current_frame , grad_x , grad_y);
<a name="l01333"></a>01333   <a class="code" href="classbrip__vil__float__ops.html#a45ba9abd34128197b97a74ecfe18f50f" title="Returns the gradient using a 3x3 kernel.">brip_vil_float_ops::gradient_3x3</a> (previous_frame , temp1 , temp2);
<a name="l01334"></a>01334 
<a name="l01335"></a>01335   <span class="comment">//  Grad = 0.5* Grad(current) + 0.5 * Grad(previous)</span>
<a name="l01336"></a>01336   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/vil__math_8h.html#a59cee1d8003915b0406501f411e9ea90">vil_math_add_image_fraction</a>(grad_x, 0.5, temp1, 0.5);
<a name="l01337"></a>01337   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/vil__math_8h.html#a59cee1d8003915b0406501f411e9ea90">vil_math_add_image_fraction</a>(grad_y, 0.5, temp2, 0.5);
<a name="l01338"></a>01338   <span class="keywordflow">if</span> ( (<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/vil__image__view_8h.html#ae6285651019d9b0932905feb98618733">vil_image_view_deep_equality</a>(emptyimg, grad_x)) ||
<a name="l01339"></a>01339        (<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/vil__image__view_8h.html#ae6285651019d9b0932905feb98618733">vil_image_view_deep_equality</a>(emptyimg, grad_y)) )
<a name="l01340"></a>01340     {
<a name="l01341"></a>01341       vcl_cout&lt;&lt;<span class="stringliteral">&quot;Gradient Image is empty&quot;</span>;
<a name="l01342"></a>01342       <span class="keywordflow">return</span> -2;
<a name="l01343"></a>01343     }
<a name="l01344"></a>01344 
<a name="l01345"></a>01345   temp1.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html#a6fd591632020e490abb5e4493a52dbba">fill</a>(0.0);
<a name="l01346"></a>01346   temp2.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html#a6fd591632020e490abb5e4493a52dbba">fill</a>(0.0);
<a name="l01347"></a>01347 
<a name="l01348"></a>01348   <span class="comment">// Average the local intensities over 3x3 region</span>
<a name="l01349"></a>01349   temp1 = <a class="code" href="classbrip__vil__float__ops.html#ac60b6fd09e290a108312fd4b47132487" title="Blur the image with an NxN averaging filter.">brip_vil_float_ops::average_NxN</a>(previous_frame, 3);
<a name="l01350"></a>01350   temp2 = <a class="code" href="classbrip__vil__float__ops.html#ac60b6fd09e290a108312fd4b47132487" title="Blur the image with an NxN averaging filter.">brip_vil_float_ops::average_NxN</a>(current_frame, 3);
<a name="l01351"></a>01351   <span class="keywordflow">if</span> (<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/vil__image__view_8h.html#ae6285651019d9b0932905feb98618733">vil_image_view_deep_equality</a>(emptyimg, temp1) ||
<a name="l01352"></a>01352       <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/vil__image__view_8h.html#ae6285651019d9b0932905feb98618733">vil_image_view_deep_equality</a>(emptyimg, temp2))
<a name="l01353"></a>01353     {
<a name="l01354"></a>01354       vcl_cout&lt;&lt;<span class="stringliteral">&quot;Averaged Image is empty&quot;</span>;
<a name="l01355"></a>01355       <span class="keywordflow">return</span> -2;
<a name="l01356"></a>01356     }
<a name="l01357"></a>01357 
<a name="l01358"></a>01358   <span class="comment">// Compute the time derivative (difference of local average intensities)</span>
<a name="l01359"></a>01359   <span class="comment">// diff = dI/dt</span>
<a name="l01360"></a>01360   diff = <a class="code" href="classbrip__vil__float__ops.html#a8a34499b91e321beff2beb67d131aac7" title="subtracts image_1 from image_2.">brip_vil_float_ops::difference</a>(temp1 , temp2);
<a name="l01361"></a>01361   <span class="keywordflow">if</span> (<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/vil__image__view_8h.html#ae6285651019d9b0932905feb98618733">vil_image_view_deep_equality</a>(emptyimg, diff) )
<a name="l01362"></a>01362   {
<a name="l01363"></a>01363     vcl_cout&lt;&lt;<span class="stringliteral">&quot;Difference Image is empty&quot;</span>;
<a name="l01364"></a>01364     <span class="keywordflow">return</span> -2;
<a name="l01365"></a>01365   }
<a name="l01366"></a>01366 
<a name="l01367"></a>01367   temp1.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html#a6fd591632020e490abb5e4493a52dbba">fill</a>(0.0);
<a name="l01368"></a>01368   temp2.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html#a6fd591632020e490abb5e4493a52dbba">fill</a>(0.0);
<a name="l01369"></a>01369   <span class="comment">// Iterate</span>
<a name="l01370"></a>01370 <span class="preprocessor">#ifdef DEBUG</span>
<a name="l01371"></a>01371 <span class="preprocessor"></span>  <a class="codeRef" doxygen="core_vul.tag:../../../../../core/vul/html" href="../../../../../core/vul/html/classvul__timer.html">vul_timer</a> t;
<a name="l01372"></a>01372 <span class="preprocessor">#endif</span>
<a name="l01373"></a>01373 <span class="preprocessor"></span>  <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0;i&lt;no_of_iterations;i++)
<a name="l01374"></a>01374   {
<a name="l01375"></a>01375     <span class="comment">// Update vx and vy</span>
<a name="l01376"></a>01376     <span class="comment">//Smoothed velocities on 3x3 region</span>
<a name="l01377"></a>01377     temp1 = <a class="code" href="classbrip__vil__float__ops.html#ac60b6fd09e290a108312fd4b47132487" title="Blur the image with an NxN averaging filter.">brip_vil_float_ops::average_NxN</a> (vx,  3);
<a name="l01378"></a>01378     temp2 = <a class="code" href="classbrip__vil__float__ops.html#ac60b6fd09e290a108312fd4b47132487" title="Blur the image with an NxN averaging filter.">brip_vil_float_ops::average_NxN</a> (vy,  3);
<a name="l01379"></a>01379     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> y = 1; y+1&lt;h; ++y)
<a name="l01380"></a>01380       <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> x = 1; x+1&lt;w; ++x)
<a name="l01381"></a>01381       {
<a name="l01382"></a>01382         <span class="keywordtype">float</span> tempx = temp1(x,y);
<a name="l01383"></a>01383         <span class="keywordtype">float</span> tempy = temp2(x,y);
<a name="l01384"></a>01384 
<a name="l01385"></a>01385         <span class="keywordtype">float</span> gx = grad_x(x, y), gy = grad_y(x, y);
<a name="l01386"></a>01386 
<a name="l01387"></a>01387         <span class="keywordtype">float</span> dt = diff(x, y);
<a name="l01388"></a>01388         <span class="comment">//         _____</span>
<a name="l01389"></a>01389         <span class="comment">// term = (v(x,y).Grad(x,y) + dI/dt(x,y))/(alpha + |Grad(x,y)|^2)</span>
<a name="l01390"></a>01390         <span class="comment">// term is the brightness constraint normalized by gradient mag.</span>
<a name="l01391"></a>01391         <span class="comment">//</span>
<a name="l01392"></a>01392         <span class="keywordtype">float</span> term =
<a name="l01393"></a>01393           ( (gx * tempx) + (gy * tempy) + dt )/ (alpha_coef + gx*gx + gy*gy);
<a name="l01394"></a>01394 
<a name="l01395"></a>01395         <span class="comment">//         ______</span>
<a name="l01396"></a>01396         <span class="comment">//v(x,y) = v(x,y) - Grad(x,y)* term</span>
<a name="l01397"></a>01397         vx(x,y) = tempx - (gx *  term);
<a name="l01398"></a>01398         vy(x,y) = tempy - (gy *  term);
<a name="l01399"></a>01399       }
<a name="l01400"></a>01400 
<a name="l01401"></a>01401 <span class="preprocessor">#ifdef DEBUG</span>
<a name="l01402"></a>01402 <span class="preprocessor"></span>    vcl_cout &lt;&lt; <span class="stringliteral">&quot;Iteration No &quot;</span> &lt;&lt; i &lt;&lt; <span class="charliteral">&#39;\n&#39;</span>;
<a name="l01403"></a>01403 <span class="preprocessor">#endif</span>
<a name="l01404"></a>01404 <span class="preprocessor"></span>    <a class="code" href="classbrip__vil__float__ops.html#a99ebd3182f788d8147b60f177cee12ef" title="fills a border of width w on left and right of image with value.">brip_vil_float_ops::fill_x_border</a>(vx, 1, 0.0f);
<a name="l01405"></a>01405     <a class="code" href="classbrip__vil__float__ops.html#addf1ea3028581107a66b3b82ae89aab4" title="fills a border of height h on top and bottom of image with value.">brip_vil_float_ops::fill_y_border</a>(vx, 1, 0.0f);
<a name="l01406"></a>01406     <a class="code" href="classbrip__vil__float__ops.html#a99ebd3182f788d8147b60f177cee12ef" title="fills a border of width w on left and right of image with value.">brip_vil_float_ops::fill_x_border</a>(vy, 1, 0.0f);
<a name="l01407"></a>01407     <a class="code" href="classbrip__vil__float__ops.html#addf1ea3028581107a66b3b82ae89aab4" title="fills a border of height h on top and bottom of image with value.">brip_vil_float_ops::fill_y_border</a>(vy, 1, 0.0f);
<a name="l01408"></a>01408   }
<a name="l01409"></a>01409 <span class="preprocessor">#ifdef DEBUG</span>
<a name="l01410"></a>01410 <span class="preprocessor"></span>  vcl_cout &lt;&lt; <span class="stringliteral">&quot;\nCompute Horn-Schunck iteration in &quot;</span> &lt;&lt; t.<a class="codeRef" doxygen="core_vul.tag:../../../../../core/vul/html" href="../../../../../core/vul/html/classvul__timer.html#a14c86b3c27f36c1946c184941e006370">real</a>() &lt;&lt; <span class="stringliteral">&quot; msecs.\n&quot;</span>;
<a name="l01411"></a>01411 <span class="preprocessor">#endif</span>
<a name="l01412"></a>01412 <span class="preprocessor"></span>  <span class="keywordflow">return</span> 0;
<a name="l01413"></a>01413 }
<a name="l01414"></a>01414 
<a name="l01415"></a><a class="code" href="classbrip__vil__float__ops.html#a99ebd3182f788d8147b60f177cee12ef">01415</a> <span class="keywordtype">void</span> <a class="code" href="classbrip__vil__float__ops.html#a99ebd3182f788d8147b60f177cee12ef" title="fills a border of width w on left and right of image with value.">brip_vil_float_ops::fill_x_border</a>(<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> &amp; image,
<a name="l01416"></a>01416                                        <span class="keywordtype">unsigned</span> w, <span class="keywordtype">float</span> value)
<a name="l01417"></a>01417 {
<a name="l01418"></a>01418   <span class="keywordtype">unsigned</span> width = image.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a9ea9ad565387a61dccf38fc80a266c2a">ni</a>(), height = image.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a44859c72206da7d18728cb2bbf8ae829">nj</a>();
<a name="l01419"></a>01419   <span class="keywordflow">if</span> (2*w&gt;width)
<a name="l01420"></a>01420   {
<a name="l01421"></a>01421     vcl_cout &lt;&lt; <span class="stringliteral">&quot;In brip_vil_float_ops::fill_x_border(..) - 2xborder exceeds image width\n&quot;</span>;
<a name="l01422"></a>01422     <span class="keywordflow">return</span>;
<a name="l01423"></a>01423   }
<a name="l01424"></a>01424   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> y = 0; y&lt;height; y++)
<a name="l01425"></a>01425     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> x = 0; x&lt;w; x++)
<a name="l01426"></a>01426       image(x, y) = value;
<a name="l01427"></a>01427 
<a name="l01428"></a>01428   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> y = 0; y&lt;height; y++)
<a name="l01429"></a>01429     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> x = width-w; x&lt;width; x++)
<a name="l01430"></a>01430       image(x, y) = value;
<a name="l01431"></a>01431 }
<a name="l01432"></a>01432 
<a name="l01433"></a><a class="code" href="classbrip__vil__float__ops.html#addf1ea3028581107a66b3b82ae89aab4">01433</a> <span class="keywordtype">void</span> <a class="code" href="classbrip__vil__float__ops.html#addf1ea3028581107a66b3b82ae89aab4" title="fills a border of height h on top and bottom of image with value.">brip_vil_float_ops::fill_y_border</a>(<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> &amp; image,
<a name="l01434"></a>01434                                        <span class="keywordtype">unsigned</span> h, <span class="keywordtype">float</span> value)
<a name="l01435"></a>01435 {
<a name="l01436"></a>01436   <span class="keywordtype">unsigned</span> width = image.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a9ea9ad565387a61dccf38fc80a266c2a">ni</a>(), height = image.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a44859c72206da7d18728cb2bbf8ae829">nj</a>();
<a name="l01437"></a>01437   <span class="keywordflow">if</span> (2*h&gt;height)
<a name="l01438"></a>01438   {
<a name="l01439"></a>01439     vcl_cout &lt;&lt; <span class="stringliteral">&quot;In brip_vil_float_ops::fill_y_border(..) - 2xborder exceeds image height\n&quot;</span>;
<a name="l01440"></a>01440     <span class="keywordflow">return</span>;
<a name="l01441"></a>01441   }
<a name="l01442"></a>01442   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> y = 0; y&lt;h; y++)
<a name="l01443"></a>01443     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> x = 0; x&lt;width; x++)
<a name="l01444"></a>01444       image(x, y) = value;
<a name="l01445"></a>01445 
<a name="l01446"></a>01446   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> y = height-h; y&lt;height; y++)
<a name="l01447"></a>01447     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> x = 0; x&lt;width; x++)
<a name="l01448"></a>01448       image(x, y) = value;
<a name="l01449"></a>01449 }
<a name="l01450"></a>01450 
<a name="l01451"></a>01451 <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;vxl_byte&gt;</a>
<a name="l01452"></a><a class="code" href="classbrip__vil__float__ops.html#af77691e76e6b2fc38568b3c07cb3335d">01452</a> <a class="code" href="classbrip__vil__float__ops.html#af77691e76e6b2fc38568b3c07cb3335d" title="converts a float image to a byte value range.">brip_vil_float_ops::convert_to_byte</a>(<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> <span class="keyword">const</span>&amp; image)
<a name="l01453"></a>01453 {
<a name="l01454"></a>01454   <span class="comment">// determine the max min values</span>
<a name="l01455"></a>01455   <span class="keywordtype">float</span> min_val = vnl_numeric_traits&lt;float&gt;::maxval;
<a name="l01456"></a>01456   <span class="keywordtype">float</span> max_val = -min_val;
<a name="l01457"></a>01457   <span class="keywordtype">unsigned</span> w = image.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a9ea9ad565387a61dccf38fc80a266c2a">ni</a>(), h = image.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a44859c72206da7d18728cb2bbf8ae829">nj</a>();
<a name="l01458"></a>01458   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;vxl_byte&gt;</a> output;
<a name="l01459"></a>01459   output.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html#a9c01939f01ef50314620e26aaacb04d3">set_size</a>(w,h);
<a name="l01460"></a>01460   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> y = 0; y&lt;h; y++)
<a name="l01461"></a>01461     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> x = 0; x&lt;w; x++)
<a name="l01462"></a>01462     {
<a name="l01463"></a>01463       min_val = <a class="codeRef" doxygen="core_vnl.tag:../../../../../core/vnl/html" href="../../../../../core/vnl/html/vnl__decnum_8h.html#ac7064c7fc83d5d457e5f903eacac9f73">vnl_math_min</a>(min_val, image(x,y));
<a name="l01464"></a>01464       max_val = <a class="codeRef" doxygen="core_vnl.tag:../../../../../core/vnl/html" href="../../../../../core/vnl/html/vnl__decnum_8h.html#a17c47eb693cfd88c7b181b162eca8dec">vnl_math_max</a>(max_val, image(x,y));
<a name="l01465"></a>01465     }
<a name="l01466"></a>01466   <span class="keywordtype">float</span> range = max_val-min_val;
<a name="l01467"></a>01467   <span class="keywordflow">if</span> (range == 0.f)
<a name="l01468"></a>01468     range = 1.f;
<a name="l01469"></a>01469   <span class="keywordflow">else</span>
<a name="l01470"></a>01470     range = 255.f/range;
<a name="l01471"></a>01471   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> y = 0; y&lt;h; y++)
<a name="l01472"></a>01472     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> x = 0; x&lt;w; x++)
<a name="l01473"></a>01473     {
<a name="l01474"></a>01474       <span class="keywordtype">float</span> <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/vgl__vector__2d_8h.html#a38bf1e5e0427bdeba2b469eea9befc23">v</a> = (image(x,y)-min_val)*range;
<a name="l01475"></a>01475       output(x,y) = (<span class="keywordtype">unsigned</span> char)v;
<a name="l01476"></a>01476     }
<a name="l01477"></a>01477   <span class="keywordflow">return</span> output;
<a name="l01478"></a>01478 }
<a name="l01479"></a>01479 
<a name="l01480"></a>01480 <span class="comment">//------------------------------------------------------------</span>
<a name="l01481"></a>01481 <span class="comment">//: Convert the range between min_val and max_val to 255</span>
<a name="l01482"></a>01482 <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;vxl_byte&gt;</a>
<a name="l01483"></a><a class="code" href="classbrip__vil__float__ops.html#afd08b901b9896eaae05c540e9cda4c5b">01483</a> <a class="code" href="classbrip__vil__float__ops.html#af77691e76e6b2fc38568b3c07cb3335d" title="converts a float image to a byte value range.">brip_vil_float_ops::convert_to_byte</a>(<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> <span class="keyword">const</span>&amp; image,
<a name="l01484"></a>01484                                     <span class="keywordtype">float</span> min_val, <span class="keywordtype">float</span> max_val)
<a name="l01485"></a>01485 {
<a name="l01486"></a>01486   <span class="keywordtype">unsigned</span> w = image.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a9ea9ad565387a61dccf38fc80a266c2a">ni</a>(), h = image.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a44859c72206da7d18728cb2bbf8ae829">nj</a>();
<a name="l01487"></a>01487   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;vxl_byte&gt;</a> output;
<a name="l01488"></a>01488   output.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html#a9c01939f01ef50314620e26aaacb04d3">set_size</a>(w,h);
<a name="l01489"></a>01489   <span class="keywordtype">float</span> range = max_val-min_val;
<a name="l01490"></a>01490   <span class="keywordflow">if</span> (range == 0.f)
<a name="l01491"></a>01491     range = 1.f;
<a name="l01492"></a>01492   <span class="keywordflow">else</span>
<a name="l01493"></a>01493     range = 255.f/range;
<a name="l01494"></a>01494   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> y = 0; y&lt;h; y++)
<a name="l01495"></a>01495     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> x = 0; x&lt;w; x++)
<a name="l01496"></a>01496     {
<a name="l01497"></a>01497       <span class="keywordtype">float</span> <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/vgl__vector__2d_8h.html#a38bf1e5e0427bdeba2b469eea9befc23">v</a> = (image(x,y)-min_val)*range;
<a name="l01498"></a>01498       <span class="keywordflow">if</span> (v&gt;255)
<a name="l01499"></a>01499         v=255;
<a name="l01500"></a>01500       <span class="keywordflow">if</span> (v&lt;0)
<a name="l01501"></a>01501         v=0;
<a name="l01502"></a>01502       output(x,y) = (<span class="keywordtype">unsigned</span> char)v;
<a name="l01503"></a>01503     }
<a name="l01504"></a>01504 
<a name="l01505"></a>01505   <span class="keywordflow">return</span> output;
<a name="l01506"></a>01506 }
<a name="l01507"></a>01507 
<a name="l01508"></a>01508 <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;vxl_byte&gt;</a> <a class="code" href="classbrip__vil__float__ops.html#af77691e76e6b2fc38568b3c07cb3335d" title="converts a float image to a byte value range.">brip_vil_float_ops::</a>
<a name="l01509"></a><a class="code" href="classbrip__vil__float__ops.html#a6e55147e91a0eb94aa314bde3268fd48">01509</a> <a class="code" href="classbrip__vil__float__ops.html#af77691e76e6b2fc38568b3c07cb3335d" title="converts a float image to a byte value range.">convert_to_byte</a>(<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;vxl_uint_16&gt;</a> <span class="keyword">const</span>&amp; image,
<a name="l01510"></a>01510                 vxl_uint_16 min_val, vxl_uint_16 max_val)
<a name="l01511"></a>01511 {
<a name="l01512"></a>01512   <span class="keywordtype">unsigned</span> ni = image.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a9ea9ad565387a61dccf38fc80a266c2a">ni</a>(), nj = image.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a44859c72206da7d18728cb2bbf8ae829">nj</a>();
<a name="l01513"></a>01513   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;vxl_byte&gt;</a> output;
<a name="l01514"></a>01514   output.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html#a9c01939f01ef50314620e26aaacb04d3">set_size</a>(ni, nj);
<a name="l01515"></a>01515   <span class="keywordtype">float</span> range = <span class="keyword">static_cast&lt;</span><span class="keywordtype">float</span><span class="keyword">&gt;</span>(max_val-min_val);
<a name="l01516"></a>01516   <span class="keywordflow">if</span> (!range)
<a name="l01517"></a>01517     range = 1;
<a name="l01518"></a>01518   <span class="keywordflow">else</span>
<a name="l01519"></a>01519     range = 255/range;
<a name="l01520"></a>01520   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> r = 0; r&lt;nj; r++)
<a name="l01521"></a>01521     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> c = 0; c&lt;ni; c++)
<a name="l01522"></a>01522     {
<a name="l01523"></a>01523       <span class="keywordtype">float</span> <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/vgl__vector__2d_8h.html#a38bf1e5e0427bdeba2b469eea9befc23">v</a> = float(image(c, r)-min_val)*range;
<a name="l01524"></a>01524       <span class="keywordflow">if</span> (v&gt;255)
<a name="l01525"></a>01525         v=255;
<a name="l01526"></a>01526       <span class="keywordflow">if</span> (v&lt;0)
<a name="l01527"></a>01527         v=0;
<a name="l01528"></a>01528       output(c, r) = <span class="keyword">static_cast&lt;</span><span class="keywordtype">unsigned</span> <span class="keywordtype">char</span><span class="keyword">&gt;</span>(v);
<a name="l01529"></a>01529     }
<a name="l01530"></a>01530   <span class="keywordflow">return</span> output;
<a name="l01531"></a>01531 }
<a name="l01532"></a>01532 
<a name="l01533"></a>01533 <span class="comment">// Note this is a more standard interface than convert_to_grey</span>
<a name="l01534"></a>01534 <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;vxl_byte&gt;</a>
<a name="l01535"></a><a class="code" href="classbrip__vil__float__ops.html#a7f52379d906ff43b75678cf875ff3960">01535</a> <a class="code" href="classbrip__vil__float__ops.html#af77691e76e6b2fc38568b3c07cb3335d" title="converts a float image to a byte value range.">brip_vil_float_ops::convert_to_byte</a>(<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__smart__ptr.html">vil_image_resource_sptr</a> <span class="keyword">const</span>&amp; image)
<a name="l01536"></a>01536 {
<a name="l01537"></a>01537   <span class="keywordflow">return</span> <a class="code" href="classbrip__vil__float__ops.html#a279d627c74a027f7f5a168f6b2ea0f19" title="converts a generic (byte-pixel RGB) image to greyscale.">brip_vil_float_ops::convert_to_grey</a>(*image);
<a name="l01538"></a>01538 }
<a name="l01539"></a>01539 
<a name="l01540"></a>01540 <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;vxl_uint_16&gt;</a>
<a name="l01541"></a><a class="code" href="classbrip__vil__float__ops.html#a2761cfe0b0d451bb950f9cb802e20eb5">01541</a> <a class="code" href="classbrip__vil__float__ops.html#a2761cfe0b0d451bb950f9cb802e20eb5" title="converts a float image to an unsigned short (16-bit) image within a range.">brip_vil_float_ops::convert_to_short</a>(<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> <span class="keyword">const</span>&amp; image,
<a name="l01542"></a>01542                                      <span class="keywordtype">float</span> min_val, <span class="keywordtype">float</span> max_val)
<a name="l01543"></a>01543 {
<a name="l01544"></a>01544   <span class="keywordtype">unsigned</span> w = image.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a9ea9ad565387a61dccf38fc80a266c2a">ni</a>(), h = image.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a44859c72206da7d18728cb2bbf8ae829">nj</a>();
<a name="l01545"></a>01545   <span class="keywordtype">float</span> max_short = 65355.f;
<a name="l01546"></a>01546   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;vxl_uint_16&gt;</a> output;
<a name="l01547"></a>01547   output.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html#a9c01939f01ef50314620e26aaacb04d3">set_size</a>(w,h);
<a name="l01548"></a>01548   <span class="keywordtype">float</span> range = max_val-min_val;
<a name="l01549"></a>01549   <span class="keywordflow">if</span> (!range)
<a name="l01550"></a>01550     range = 1;
<a name="l01551"></a>01551   <span class="keywordflow">else</span>
<a name="l01552"></a>01552     range = max_short/range;
<a name="l01553"></a>01553   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> y = 0; y&lt;h; y++)
<a name="l01554"></a>01554     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> x = 0; x&lt;w; x++)
<a name="l01555"></a>01555     {
<a name="l01556"></a>01556       <span class="keywordtype">float</span> <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/vgl__vector__2d_8h.html#a38bf1e5e0427bdeba2b469eea9befc23">v</a> = (image(x,y)-min_val)*range;
<a name="l01557"></a>01557       <span class="keywordflow">if</span> (v&gt;max_short)
<a name="l01558"></a>01558         v=max_short;
<a name="l01559"></a>01559       <span class="keywordflow">if</span> (v&lt;0)
<a name="l01560"></a>01560         v=0;
<a name="l01561"></a>01561       output(x,y) = (<span class="keywordtype">unsigned</span> short)v;
<a name="l01562"></a>01562     }
<a name="l01563"></a>01563   <span class="keywordflow">return</span> output;
<a name="l01564"></a>01564 }
<a name="l01565"></a>01565 
<a name="l01566"></a>01566 <span class="comment">//: converts a float image to an unsigned short (16-bit) image.</span>
<a name="l01567"></a>01567 <span class="comment">// range determined automatically</span>
<a name="l01568"></a>01568 <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;vxl_uint_16&gt;</a>
<a name="l01569"></a><a class="code" href="classbrip__vil__float__ops.html#ae35def6dd053cf41161f2339283184b8">01569</a> <a class="code" href="classbrip__vil__float__ops.html#a2761cfe0b0d451bb950f9cb802e20eb5" title="converts a float image to an unsigned short (16-bit) image within a range.">brip_vil_float_ops::convert_to_short</a>(<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> <span class="keyword">const</span>&amp; image)
<a name="l01570"></a>01570 {
<a name="l01571"></a>01571   <span class="keywordtype">float</span> minv = vnl_numeric_traits&lt;float&gt;::maxval;
<a name="l01572"></a>01572   <span class="keywordtype">float</span> maxv = -minv;
<a name="l01573"></a>01573   <span class="keywordtype">unsigned</span> ni = image.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a9ea9ad565387a61dccf38fc80a266c2a">ni</a>(), nj = image.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a44859c72206da7d18728cb2bbf8ae829">nj</a>();
<a name="l01574"></a>01574   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> j = 0; j&lt;nj; ++j)
<a name="l01575"></a>01575     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> i = 0; i&lt;ni; ++i)
<a name="l01576"></a>01576     {
<a name="l01577"></a>01577       <span class="keywordtype">float</span> <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/vgl__vector__2d_8h.html#a38bf1e5e0427bdeba2b469eea9befc23">v</a> = image(i,j);
<a name="l01578"></a>01578       <span class="keywordflow">if</span> (v&lt;minv)
<a name="l01579"></a>01579         minv = v;
<a name="l01580"></a>01580       <span class="keywordflow">if</span> (v&gt;maxv)
<a name="l01581"></a>01581         maxv = v;
<a name="l01582"></a>01582     }
<a name="l01583"></a>01583   <span class="keywordflow">return</span> <a class="code" href="classbrip__vil__float__ops.html#a2761cfe0b0d451bb950f9cb802e20eb5" title="converts a float image to an unsigned short (16-bit) image within a range.">brip_vil_float_ops::convert_to_short</a>(image, minv, maxv);
<a name="l01584"></a>01584 }
<a name="l01585"></a>01585 
<a name="l01586"></a>01586 <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;vxl_uint_16&gt;</a>
<a name="l01587"></a><a class="code" href="classbrip__vil__float__ops.html#a2ec09bae796e4c09879ce25384ea34bf">01587</a> <a class="code" href="classbrip__vil__float__ops.html#a2761cfe0b0d451bb950f9cb802e20eb5" title="converts a float image to an unsigned short (16-bit) image within a range.">brip_vil_float_ops::convert_to_short</a>(<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__smart__ptr.html">vil_image_resource_sptr</a> <span class="keyword">const</span>&amp; image)
<a name="l01588"></a>01588 {
<a name="l01589"></a>01589   <span class="comment">// Check if the image is a float</span>
<a name="l01590"></a>01590   <span class="keywordflow">if</span> (image-&gt;nplanes()==1 &amp;&amp;image-&gt;pixel_format()==<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/vil__pixel__format_8h.html#a6f749d91364b0bcb661189f4a154800da8d2e38094a68770dcad0e6637d5ce3ba">VIL_PIXEL_FORMAT_FLOAT</a>)
<a name="l01591"></a>01591   {
<a name="l01592"></a>01592     <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> temp = image-&gt;get_view();
<a name="l01593"></a>01593     <span class="keywordtype">float</span> vmin=0, vmax= 65355;
<a name="l01594"></a>01594     vil_math_value_range&lt;float&gt;(temp, vmin, vmax);
<a name="l01595"></a>01595     <span class="keywordflow">return</span> <a class="code" href="classbrip__vil__float__ops.html#a2761cfe0b0d451bb950f9cb802e20eb5" title="converts a float image to an unsigned short (16-bit) image within a range.">brip_vil_float_ops::convert_to_short</a>(temp, vmin, vmax);
<a name="l01596"></a>01596   }
<a name="l01597"></a>01597 
<a name="l01598"></a>01598   <span class="comment">// Here we assume that the image is an unsigned char</span>
<a name="l01599"></a>01599   <span class="keywordflow">if</span> (image-&gt;nplanes()==1&amp;&amp;image-&gt;pixel_format()==<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/vil__pixel__format_8h.html#a6f749d91364b0bcb661189f4a154800da7e558fc5ba55dbb9c32658e7960b83f4">VIL_PIXEL_FORMAT_BYTE</a>)
<a name="l01600"></a>01600   {
<a name="l01601"></a>01601     <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;unsigned char &gt;</a> temp = image-&gt;get_view();
<a name="l01602"></a>01602     <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;unsigned short&gt;</a> short_image;
<a name="l01603"></a>01603     <span class="keywordtype">unsigned</span> width = temp.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a9ea9ad565387a61dccf38fc80a266c2a">ni</a>(), height = temp.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a44859c72206da7d18728cb2bbf8ae829">nj</a>();
<a name="l01604"></a>01604     short_image.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html#a9c01939f01ef50314620e26aaacb04d3">set_size</a>(width, height);
<a name="l01605"></a>01605     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> y = 0; y&lt;height; y++)
<a name="l01606"></a>01606       <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> x = 0; x&lt;width; x++)
<a name="l01607"></a>01607         short_image(x,y) = <span class="keyword">static_cast&lt;</span><span class="keywordtype">unsigned</span> <span class="keywordtype">short</span><span class="keyword">&gt;</span>(temp(x,y));
<a name="l01608"></a>01608     <span class="keywordflow">return</span> temp;
<a name="l01609"></a>01609   }
<a name="l01610"></a>01610 
<a name="l01611"></a>01611   <span class="comment">// Here the image is an unsigned short (16-bit) image so just return it</span>
<a name="l01612"></a>01612   <span class="keywordflow">if</span> (image-&gt;nplanes()==1&amp;&amp;image-&gt;pixel_format()==<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/vil__pixel__format_8h.html#a6f749d91364b0bcb661189f4a154800dabecb5c0033517756dc112ccd18f97073">VIL_PIXEL_FORMAT_UINT_16</a>)
<a name="l01613"></a>01613   {
<a name="l01614"></a>01614     <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;unsigned short &gt;</a> temp = image-&gt;get_view();
<a name="l01615"></a>01615     <span class="keywordflow">return</span> temp;
<a name="l01616"></a>01616   }
<a name="l01617"></a>01617 
<a name="l01618"></a>01618   <span class="comment">// the image is color so we should convert it to greyscale</span>
<a name="l01619"></a>01619   <span class="comment">// Here we assume the color elements are unsigned char.</span>
<a name="l01620"></a>01620   <span class="keywordflow">if</span> (image-&gt;nplanes()==3&amp;&amp;image-&gt;pixel_format()==<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/vil__pixel__format_8h.html#a6f749d91364b0bcb661189f4a154800da7e558fc5ba55dbb9c32658e7960b83f4">VIL_PIXEL_FORMAT_BYTE</a>)
<a name="l01621"></a>01621   {
<a name="l01622"></a>01622     <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;vxl_byte&gt;</a> color_image = image-&gt;get_view();
<a name="l01623"></a>01623     <span class="keywordtype">unsigned</span> width = color_image.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a9ea9ad565387a61dccf38fc80a266c2a">ni</a>(), height = color_image.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a44859c72206da7d18728cb2bbf8ae829">nj</a>();
<a name="l01624"></a>01624     <span class="comment">// the output image</span>
<a name="l01625"></a>01625     <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;unsigned short&gt;</a> short_image;
<a name="l01626"></a>01626     short_image.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html#a9c01939f01ef50314620e26aaacb04d3">set_size</a>(width, height);
<a name="l01627"></a>01627     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> y = 0; y&lt;height; y++)
<a name="l01628"></a>01628       <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> x = 0; x&lt;width; x++)
<a name="l01629"></a>01629       {
<a name="l01630"></a>01630         <span class="keywordtype">double</span> <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/vgl__vector__2d_8h.html#a38bf1e5e0427bdeba2b469eea9befc23">v</a> = color_image(x,y,0)+color_image(x,y,1)+color_image(x,y,2);
<a name="l01631"></a>01631         v/=3.0;
<a name="l01632"></a>01632         short_image(x,y) = <span class="keyword">static_cast&lt;</span><span class="keywordtype">unsigned</span> <span class="keywordtype">short</span><span class="keyword">&gt;</span>(v);
<a name="l01633"></a>01633       }
<a name="l01634"></a>01634     <span class="keywordflow">return</span> short_image;
<a name="l01635"></a>01635   }
<a name="l01636"></a>01636 
<a name="l01637"></a>01637   <span class="comment">// the image is multispectral so we should convert it to greyscale</span>
<a name="l01638"></a>01638   <span class="comment">// Here we assume the color elements are unsigned short (16-bit).</span>
<a name="l01639"></a>01639   <span class="keywordflow">if</span> (image-&gt;nplanes()==4&amp;&amp;image-&gt;pixel_format()==<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/vil__pixel__format_8h.html#a6f749d91364b0bcb661189f4a154800dabecb5c0033517756dc112ccd18f97073">VIL_PIXEL_FORMAT_UINT_16</a>)
<a name="l01640"></a>01640   {
<a name="l01641"></a>01641     <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;unsigned short &gt;</a> mband_image = image-&gt;get_view();
<a name="l01642"></a>01642     <span class="keywordtype">unsigned</span> width = mband_image.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a9ea9ad565387a61dccf38fc80a266c2a">ni</a>(), height = mband_image.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a44859c72206da7d18728cb2bbf8ae829">nj</a>();
<a name="l01643"></a>01643     <span class="comment">// the output image</span>
<a name="l01644"></a>01644     <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;unsigned short&gt;</a> short_image;
<a name="l01645"></a>01645     short_image.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html#a9c01939f01ef50314620e26aaacb04d3">set_size</a>(width, height);
<a name="l01646"></a>01646     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> y = 0; y&lt;height; y++)
<a name="l01647"></a>01647       <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> x = 0; x&lt;width; x++)
<a name="l01648"></a>01648       {
<a name="l01649"></a>01649         <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/vgl__vector__2d_8h.html#a38bf1e5e0427bdeba2b469eea9befc23">v</a> = 0;
<a name="l01650"></a>01650         <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> p = 0; p&lt;4; ++p)
<a name="l01651"></a>01651           v += mband_image(x, y, p);
<a name="l01652"></a>01652         v/=4;
<a name="l01653"></a>01653         short_image(x,y) = v;
<a name="l01654"></a>01654       }
<a name="l01655"></a>01655     <span class="keywordflow">return</span> short_image;
<a name="l01656"></a>01656   }
<a name="l01657"></a>01657 
<a name="l01658"></a>01658   <span class="comment">// If we get here then the input is not a type we handle so return a null view</span>
<a name="l01659"></a>01659   <span class="keywordflow">return</span> <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;vxl_uint_16&gt;</a>();
<a name="l01660"></a>01660 }
<a name="l01661"></a>01661 
<a name="l01662"></a>01662 <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a>
<a name="l01663"></a><a class="code" href="classbrip__vil__float__ops.html#a63b53c357e3687e9efebe8fcdfc9b9a9">01663</a> <a class="code" href="classbrip__vil__float__ops.html#afc428b73d4f323a495252b0f5cb30a20" title="converts a vil_image_resource to a float image.">brip_vil_float_ops::convert_to_float</a>(<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;vxl_byte&gt;</a> <span class="keyword">const</span>&amp; image)
<a name="l01664"></a>01664 {
<a name="l01665"></a>01665   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> output;
<a name="l01666"></a>01666   <span class="keywordtype">unsigned</span> ni = image.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a9ea9ad565387a61dccf38fc80a266c2a">ni</a>(), nj = image.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a44859c72206da7d18728cb2bbf8ae829">nj</a>(), np = image.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#adb221bda92a1c0f7f4842af116428b11">nplanes</a>();
<a name="l01667"></a>01667   output.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html#a9c01939f01ef50314620e26aaacb04d3">set_size</a>(ni,nj, np);
<a name="l01668"></a>01668   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> j = 0; j&lt;nj; j++)
<a name="l01669"></a>01669     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> i = 0; i&lt;ni; i++)
<a name="l01670"></a>01670       <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> p = 0; p&lt;np; ++p)
<a name="l01671"></a>01671         output(i,j,p) = (float)image(i,j,p);
<a name="l01672"></a>01672   <span class="keywordflow">return</span> output;
<a name="l01673"></a>01673 }
<a name="l01674"></a>01674 
<a name="l01675"></a>01675 <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a>
<a name="l01676"></a><a class="code" href="classbrip__vil__float__ops.html#af7a8629d872ecd27559d14bbcc111684">01676</a> <a class="code" href="classbrip__vil__float__ops.html#afc428b73d4f323a495252b0f5cb30a20" title="converts a vil_image_resource to a float image.">brip_vil_float_ops::convert_to_float</a>(<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;vxl_uint_16&gt;</a> <span class="keyword">const</span>&amp; image)
<a name="l01677"></a>01677 {
<a name="l01678"></a>01678   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> output;
<a name="l01679"></a>01679   <span class="keywordtype">unsigned</span> w = image.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a9ea9ad565387a61dccf38fc80a266c2a">ni</a>(), h = image.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a44859c72206da7d18728cb2bbf8ae829">nj</a>();
<a name="l01680"></a>01680   output.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html#a9c01939f01ef50314620e26aaacb04d3">set_size</a>(w,h);
<a name="l01681"></a>01681   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> y = 0; y&lt;h; y++)
<a name="l01682"></a>01682     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> x = 0; x&lt;w; x++)
<a name="l01683"></a>01683       output(x,y) = (float)image(x,y);
<a name="l01684"></a>01684   <span class="keywordflow">return</span> output;
<a name="l01685"></a>01685 }
<a name="l01686"></a>01686 
<a name="l01687"></a>01687 <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;bool&gt;</a>
<a name="l01688"></a><a class="code" href="classbrip__vil__float__ops.html#a0c1830c5186a00b32dd0c19d62ba608e">01688</a> <a class="code" href="classbrip__vil__float__ops.html#a0c1830c5186a00b32dd0c19d62ba608e" title="converts a byte image to a bool image.">brip_vil_float_ops::convert_to_bool</a>(<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;vxl_byte&gt;</a> <span class="keyword">const</span>&amp; image)
<a name="l01689"></a>01689 {
<a name="l01690"></a>01690   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;bool&gt;</a> output;
<a name="l01691"></a>01691   <span class="keywordtype">unsigned</span> w = image.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a9ea9ad565387a61dccf38fc80a266c2a">ni</a>(), h = image.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a44859c72206da7d18728cb2bbf8ae829">nj</a>();
<a name="l01692"></a>01692   output.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html#a9c01939f01ef50314620e26aaacb04d3">set_size</a>(w,h);
<a name="l01693"></a>01693   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> y = 0; y&lt;h; y++)
<a name="l01694"></a>01694     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> x = 0; x&lt;w; x++)
<a name="l01695"></a>01695       <span class="keywordflow">if</span> (image(x,y) &gt; 128)
<a name="l01696"></a>01696         output(x,y)=<span class="keyword">true</span>;
<a name="l01697"></a>01697       <span class="keywordflow">else</span>
<a name="l01698"></a>01698         output(x,y)=<span class="keyword">false</span>;
<a name="l01699"></a>01699   <span class="keywordflow">return</span> output;
<a name="l01700"></a>01700 }
<a name="l01701"></a>01701 
<a name="l01702"></a>01702 <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a>
<a name="l01703"></a><a class="code" href="classbrip__vil__float__ops.html#ad9206391bab2670e9b35697efde14120">01703</a> <a class="code" href="classbrip__vil__float__ops.html#afc428b73d4f323a495252b0f5cb30a20" title="converts a vil_image_resource to a float image.">brip_vil_float_ops::convert_to_float</a>(<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view</a>&lt;<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/structvil__rgb.html">vil_rgb&lt;vxl_byte&gt;</a> &gt; <span class="keyword">const</span>&amp; image)
<a name="l01704"></a>01704 {
<a name="l01705"></a>01705   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> output;
<a name="l01706"></a>01706   <span class="keywordtype">unsigned</span> w = image.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a9ea9ad565387a61dccf38fc80a266c2a">ni</a>(), h = image.nj();
<a name="l01707"></a>01707   output.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html#a9c01939f01ef50314620e26aaacb04d3">set_size</a>(w,h);
<a name="l01708"></a>01708   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> y = 0; y&lt;h; y++)
<a name="l01709"></a>01709     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> x = 0; x&lt;w; x++)
<a name="l01710"></a>01710     {
<a name="l01711"></a>01711       <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/structvil__rgb.html">vil_rgb&lt;vxl_byte&gt;</a> <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/vil__rgb_8h.html#a53ebd0eabadf8cd53f5c55958d57b355">rgb</a> = image(x,y);
<a name="l01712"></a>01712       output(x,y) = (float)rgb.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/structvil__rgb.html#afedf06a61dfa09a136f68fdd00585106">grey</a>();
<a name="l01713"></a>01713     }
<a name="l01714"></a>01714   <span class="keywordflow">return</span> output;
<a name="l01715"></a>01715 }
<a name="l01716"></a>01716 
<a name="l01717"></a><a class="code" href="classbrip__vil__float__ops.html#ab4c327b50d70672d329cab389dafcdf8">01717</a> <span class="keywordtype">void</span> <a class="code" href="classbrip__vil__float__ops.html#ab4c327b50d70672d329cab389dafcdf8" title="convert a single RGB pixel to (I,H,S).">brip_vil_float_ops::rgb_to_ihs</a>(<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/structvil__rgb.html">vil_rgb&lt;vxl_byte&gt;</a> <span class="keyword">const</span>&amp; rgb,
<a name="l01718"></a>01718                                     <span class="keywordtype">float</span>&amp; i, <span class="keywordtype">float</span>&amp; h, <span class="keywordtype">float</span>&amp; s)
<a name="l01719"></a>01719 {
<a name="l01720"></a>01720   <span class="keywordtype">float</span> r,g,b;
<a name="l01721"></a>01721   r=rgb.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/structvil__rgb.html#a007e0fdb6b5e447c72a2a61a76f00e0a">R</a>();
<a name="l01722"></a>01722   g=rgb.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/structvil__rgb.html#af8a50843495399901eb48b667ba2bf07">G</a>();
<a name="l01723"></a>01723   b=rgb.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/structvil__rgb.html#a26523356ec80dff1fc93efbd38cbddd8">B</a>();
<a name="l01724"></a>01724 
<a name="l01725"></a>01725   <span class="keywordtype">float</span> <a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/vbl__attributes_8h.html#aa183d966bcf99457a0c040f19e9aaf78">maxval</a> = <a class="codeRef" doxygen="core_vnl.tag:../../../../../core/vnl/html" href="../../../../../core/vnl/html/vnl__decnum_8h.html#a17c47eb693cfd88c7b181b162eca8dec">vnl_math_max</a>(r,<a class="codeRef" doxygen="core_vnl.tag:../../../../../core/vnl/html" href="../../../../../core/vnl/html/vnl__decnum_8h.html#a17c47eb693cfd88c7b181b162eca8dec">vnl_math_max</a>(g,b));
<a name="l01726"></a>01726   <span class="keywordtype">float</span> <a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/vbl__attributes_8h.html#a5279cd0ed4e58a0d88bfd450a6cded2a">minval</a> = <a class="codeRef" doxygen="core_vnl.tag:../../../../../core/vnl/html" href="../../../../../core/vnl/html/vnl__decnum_8h.html#ac7064c7fc83d5d457e5f903eacac9f73">vnl_math_min</a>(r,<a class="codeRef" doxygen="core_vnl.tag:../../../../../core/vnl/html" href="../../../../../core/vnl/html/vnl__decnum_8h.html#ac7064c7fc83d5d457e5f903eacac9f73">vnl_math_min</a>(g,b));
<a name="l01727"></a>01727 
<a name="l01728"></a>01728   <span class="keywordtype">float</span> delta = maxval - minval;
<a name="l01729"></a>01729   i = maxval;
<a name="l01730"></a>01730   <span class="keywordflow">if</span> (maxval == 0)
<a name="l01731"></a>01731     s = 0;
<a name="l01732"></a>01732   <span class="keywordflow">else</span>
<a name="l01733"></a>01733     s = delta / maxval;
<a name="l01734"></a>01734 
<a name="l01735"></a>01735   <span class="keywordflow">if</span> (s== 0)
<a name="l01736"></a>01736     h = 0;                   <span class="comment">//!&lt; (Hue is undefined)</span>
<a name="l01737"></a>01737 <span class="comment"></span>
<a name="l01738"></a>01738   <span class="keywordflow">if</span> (r== maxval)
<a name="l01739"></a>01739     h = (g - b) / delta ;    <span class="comment">//!&lt; (between yellow and magenta)</span>
<a name="l01740"></a>01740 <span class="comment"></span>  <span class="keywordflow">if</span> (g == maxval)
<a name="l01741"></a>01741     h = 2 + (b - r)/delta ;  <span class="comment">//!&lt; (between cyan and yellow)</span>
<a name="l01742"></a>01742 <span class="comment"></span>  <span class="keywordflow">if</span> (b == maxval)
<a name="l01743"></a>01743     h = 4 + (r - g) / delta; <span class="comment">//!&lt; (between magenta and cyan)</span>
<a name="l01744"></a>01744 <span class="comment"></span>  h = h * 60;                <span class="comment">//!&lt; (convert Hue to degrees)</span>
<a name="l01745"></a>01745 <span class="comment"></span>  <span class="keywordflow">if</span> (h &lt; 0)
<a name="l01746"></a>01746     h = h + 360 ;            <span class="comment">//!&lt; (Hue must be positive)</span>
<a name="l01747"></a>01747 <span class="comment"></span>  <span class="keywordflow">if</span> (h &gt;= 360)
<a name="l01748"></a>01748     h = h - 360;             <span class="comment">//!&lt; (Hue must be less than 360)</span>
<a name="l01749"></a>01749 <span class="comment"></span>
<a name="l01750"></a>01750   h = (vxl_byte)(h * (255.0 / 360.0));
<a name="l01751"></a>01751   s = (vxl_byte)(s * 255.0);
<a name="l01752"></a>01752 }
<a name="l01753"></a>01753 
<a name="l01754"></a><a class="code" href="classbrip__vil__float__ops.html#ac279802787840ee6fab64d95a18766a0">01754</a> <span class="keywordtype">void</span> <a class="code" href="classbrip__vil__float__ops.html#ac279802787840ee6fab64d95a18766a0" title="convert a single (I,H,S) pixel to RGB.">brip_vil_float_ops::ihs_to_rgb</a>(<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/structvil__rgb.html">vil_rgb&lt;vxl_byte&gt;</a> &amp; rgb,
<a name="l01755"></a>01755                                     <span class="keyword">const</span> <span class="keywordtype">float</span> i, <span class="keyword">const</span> <span class="keywordtype">float</span> h, <span class="keyword">const</span> <span class="keywordtype">float</span> s)
<a name="l01756"></a>01756 {
<a name="l01757"></a>01757   <span class="comment">// Reference: page 593 of Foley &amp; van Dam</span>
<a name="l01758"></a>01758   <span class="keywordtype">float</span> R = 0.0f;
<a name="l01759"></a>01759   <span class="keywordtype">float</span> G = 0.0f;
<a name="l01760"></a>01760   <span class="keywordtype">float</span> B = 0.0f;
<a name="l01761"></a>01761 
<a name="l01762"></a>01762   <span class="keywordflow">if</span> (s == 0) {
<a name="l01763"></a>01763     R=i;
<a name="l01764"></a>01764     G=i;
<a name="l01765"></a>01765     B=i;
<a name="l01766"></a>01766   }
<a name="l01767"></a>01767   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (s &gt; 0.0)
<a name="l01768"></a>01768   {
<a name="l01769"></a>01769     <span class="keywordtype">float</span> ss = s, hh = h;
<a name="l01770"></a>01770     ss *= 1.f / 255.f;
<a name="l01771"></a>01771     hh *= 6.f / 255.f;
<a name="l01772"></a>01772 
<a name="l01773"></a>01773     <span class="keywordtype">float</span> J = vcl_floor(hh);
<a name="l01774"></a>01774     <span class="keywordtype">float</span> F = hh - J;
<a name="l01775"></a>01775     <span class="keywordtype">float</span> P =( i * (1 - ss));
<a name="l01776"></a>01776     <span class="keywordtype">float</span> Q = (i * (1 - (ss * F)));
<a name="l01777"></a>01777     <span class="keywordtype">float</span> T = (i * (1 - (ss * (1 - F))));
<a name="l01778"></a>01778 
<a name="l01779"></a>01779     <span class="keywordflow">if</span> (J == 0) { R=i; G=T; B=P; }
<a name="l01780"></a>01780     <span class="keywordflow">if</span> (J == 1) { R=Q; G=i; B=P; }
<a name="l01781"></a>01781     <span class="keywordflow">if</span> (J == 2) { R=P; G=i; B=T; }
<a name="l01782"></a>01782     <span class="keywordflow">if</span> (J == 3) { R=P; G=Q; B=i; }
<a name="l01783"></a>01783     <span class="keywordflow">if</span> (J == 4) { R=T; G=P; B=i; }
<a name="l01784"></a>01784     <span class="keywordflow">if</span> (J == 5) { R=i; G=P; B=Q; }
<a name="l01785"></a>01785   }
<a name="l01786"></a>01786   rgb.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/structvil__rgb.html#a00531dfe37aefaac34f63d954ce244f5">r</a> = (vxl_byte)R;
<a name="l01787"></a>01787   rgb.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/structvil__rgb.html#a88111b5b1688f13c33bb27b931a1a782">g</a> = (vxl_byte)G;
<a name="l01788"></a>01788   rgb.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/structvil__rgb.html#ae4c341d1e11338aa68adc5441b939900">b</a> = (vxl_byte)B;
<a name="l01789"></a>01789 }
<a name="l01790"></a>01790 
<a name="l01791"></a>01791 <span class="keywordtype">void</span> <a class="code" href="classbrip__vil__float__ops.html#acd65ba88ab8574e43a06ab7e1757e9f3" title="converts a byte-pixel color image to float (I,H,S) image triple.">brip_vil_float_ops::</a>
<a name="l01792"></a><a class="code" href="classbrip__vil__float__ops.html#acd65ba88ab8574e43a06ab7e1757e9f3">01792</a> <a class="code" href="classbrip__vil__float__ops.html#acd65ba88ab8574e43a06ab7e1757e9f3" title="converts a byte-pixel color image to float (I,H,S) image triple.">convert_to_IHS</a>(<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view</a>&lt;<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/structvil__rgb.html">vil_rgb&lt;vxl_byte&gt;</a> &gt; <span class="keyword">const</span>&amp; image,
<a name="l01793"></a>01793                <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a>&amp; I,
<a name="l01794"></a>01794                <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a>&amp; H,
<a name="l01795"></a>01795                <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a>&amp; S)
<a name="l01796"></a>01796 {
<a name="l01797"></a>01797   <span class="keywordtype">unsigned</span> w = image.ni(), h = image.nj();
<a name="l01798"></a>01798   I.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html#a9c01939f01ef50314620e26aaacb04d3">set_size</a>(w,h);
<a name="l01799"></a>01799   H.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html#a9c01939f01ef50314620e26aaacb04d3">set_size</a>(w,h);
<a name="l01800"></a>01800   S.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html#a9c01939f01ef50314620e26aaacb04d3">set_size</a>(w,h);
<a name="l01801"></a>01801   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> r = 0; r &lt; h; r++)
<a name="l01802"></a>01802     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> c = 0; c &lt; w; c++)
<a name="l01803"></a>01803     {
<a name="l01804"></a>01804       <span class="keywordtype">float</span> in, hue, sat;
<a name="l01805"></a>01805       <a class="code" href="classbrip__vil__float__ops.html#ab4c327b50d70672d329cab389dafcdf8" title="convert a single RGB pixel to (I,H,S).">rgb_to_ihs</a>(image(c,r), in, hue, sat);
<a name="l01806"></a>01806       I(c,r) = in;
<a name="l01807"></a>01807       H(c,r) = hue;
<a name="l01808"></a>01808       S(c,r) = sat;
<a name="l01809"></a>01809     }
<a name="l01810"></a>01810 }
<a name="l01811"></a>01811 
<a name="l01812"></a>01812 <span class="keywordtype">void</span> <a class="code" href="classbrip__vil__float__ops.html#acd65ba88ab8574e43a06ab7e1757e9f3" title="converts a byte-pixel color image to float (I,H,S) image triple.">brip_vil_float_ops::</a>
<a name="l01813"></a><a class="code" href="classbrip__vil__float__ops.html#a1f54bd3e24e18445ef4b6ce27df0c12c">01813</a> <a class="code" href="classbrip__vil__float__ops.html#acd65ba88ab8574e43a06ab7e1757e9f3" title="converts a byte-pixel color image to float (I,H,S) image triple.">convert_to_IHS</a>(<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;vxl_byte&gt;</a> <span class="keyword">const</span>&amp; image,
<a name="l01814"></a>01814                <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a>&amp; I,
<a name="l01815"></a>01815                <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a>&amp; H,
<a name="l01816"></a>01816                <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a>&amp; S)
<a name="l01817"></a>01817 {
<a name="l01818"></a>01818   <span class="keywordtype">unsigned</span> w = image.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a9ea9ad565387a61dccf38fc80a266c2a">ni</a>(), h = image.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a44859c72206da7d18728cb2bbf8ae829">nj</a>();
<a name="l01819"></a>01819   I.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html#a9c01939f01ef50314620e26aaacb04d3">set_size</a>(w,h);
<a name="l01820"></a>01820   H.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html#a9c01939f01ef50314620e26aaacb04d3">set_size</a>(w,h);
<a name="l01821"></a>01821   S.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html#a9c01939f01ef50314620e26aaacb04d3">set_size</a>(w,h);
<a name="l01822"></a>01822   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> r = 0; r &lt; h; r++)
<a name="l01823"></a>01823     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> c = 0; c &lt; w; c++)
<a name="l01824"></a>01824     {
<a name="l01825"></a>01825       <span class="keywordtype">float</span> in, hue, sat;
<a name="l01826"></a>01826       <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/structvil__rgb.html">vil_rgb&lt;vxl_byte&gt;</a> imint(image(c,r,0),image(c,r,1),image(c,r,2));
<a name="l01827"></a>01827       <a class="code" href="classbrip__vil__float__ops.html#ab4c327b50d70672d329cab389dafcdf8" title="convert a single RGB pixel to (I,H,S).">rgb_to_ihs</a>(imint, in, hue, sat);
<a name="l01828"></a>01828       I(c,r) = in;
<a name="l01829"></a>01829       H(c,r) = hue;
<a name="l01830"></a>01830       S(c,r) = sat;
<a name="l01831"></a>01831     }
<a name="l01832"></a>01832 }
<a name="l01833"></a>01833 
<a name="l01834"></a>01834 <span class="preprocessor">#if 0 // commented out</span>
<a name="l01835"></a>01835 <span class="preprocessor"></span><span class="keywordtype">void</span> <a class="code" href="classbrip__vil__float__ops.html#a44f1751d1ba0b10621b7c9969d55a889" title="display (I,H,S) image triple as RGB (no conversion from IHS to RGB!).">brip_vil_float_ops::</a>
<a name="l01836"></a>01836 <a class="code" href="classbrip__vil__float__ops.html#a44f1751d1ba0b10621b7c9969d55a889" title="display (I,H,S) image triple as RGB (no conversion from IHS to RGB!).">display_IHS_as_RGB</a>(<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> <span class="keyword">const</span>&amp; I,
<a name="l01837"></a>01837                    <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> <span class="keyword">const</span>&amp; H,
<a name="l01838"></a>01838                    <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> <span class="keyword">const</span>&amp; S,
<a name="l01839"></a>01839                    <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view</a>&lt;<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/structvil__rgb.html">vil_rgb&lt;vxl_byte&gt;</a> &gt;&amp; image)
<a name="l01840"></a>01840 {
<a name="l01841"></a>01841   <span class="keywordtype">unsigned</span> w = I.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a9ea9ad565387a61dccf38fc80a266c2a">ni</a>(), h = I.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a44859c72206da7d18728cb2bbf8ae829">nj</a>();
<a name="l01842"></a>01842   image.set_size(w,h);
<a name="l01843"></a>01843   <span class="keywordtype">float</span> s = 255.0f/360.0f;
<a name="l01844"></a>01844   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> r = 0; r &lt; h; r++)
<a name="l01845"></a>01845     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> c = 0; c &lt; w; c++)
<a name="l01846"></a>01846     {
<a name="l01847"></a>01847       <span class="keywordtype">float</span> in = I(c,r);
<a name="l01848"></a>01848       <span class="keywordtype">float</span> hue = s * H(c,r);
<a name="l01849"></a>01849       <span class="keywordtype">float</span> sat = S(c,r);
<a name="l01850"></a>01850       <span class="keywordflow">if</span> (in&lt;0) in = 0;
<a name="l01851"></a>01851       <span class="keywordflow">if</span> (sat&lt;0) sat = 0;
<a name="l01852"></a>01852       <span class="keywordflow">if</span> (hue&lt;0) hue = 0;
<a name="l01853"></a>01853       <span class="keywordflow">if</span> (in&gt;255) in = 255;
<a name="l01854"></a>01854       <span class="keywordflow">if</span> (hue&gt;255) hue = 255;
<a name="l01855"></a>01855       <span class="keywordflow">if</span> (sat&gt;255) sat = 255;
<a name="l01856"></a>01856       image(c,r).r = (vxl_byte)in;
<a name="l01857"></a>01857       image(c,r).g = (vxl_byte)hue;
<a name="l01858"></a>01858       image(c,r).b = (vxl_byte)sat;
<a name="l01859"></a>01859     }
<a name="l01860"></a>01860 }
<a name="l01861"></a>01861 <span class="preprocessor">#endif // 0</span>
<a name="l01862"></a>01862 <span class="preprocessor"></span>
<a name="l01863"></a>01863 <span class="comment">// map so that intensity is proportional to saturation and hue is color</span>
<a name="l01864"></a>01864 <span class="keywordtype">void</span> <a class="code" href="classbrip__vil__float__ops.html#a44f1751d1ba0b10621b7c9969d55a889" title="display (I,H,S) image triple as RGB (no conversion from IHS to RGB!).">brip_vil_float_ops::</a>
<a name="l01865"></a><a class="code" href="classbrip__vil__float__ops.html#a44f1751d1ba0b10621b7c9969d55a889">01865</a> <a class="code" href="classbrip__vil__float__ops.html#a44f1751d1ba0b10621b7c9969d55a889" title="display (I,H,S) image triple as RGB (no conversion from IHS to RGB!).">display_IHS_as_RGB</a>(<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> <span class="keyword">const</span>&amp; I,
<a name="l01866"></a>01866                    <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> <span class="keyword">const</span>&amp; H,
<a name="l01867"></a>01867                    <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> <span class="keyword">const</span>&amp; S,
<a name="l01868"></a>01868                    <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view</a>&lt;<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/structvil__rgb.html">vil_rgb&lt;vxl_byte&gt;</a> &gt;&amp; image)
<a name="l01869"></a>01869 {
<a name="l01870"></a>01870   <span class="keywordtype">unsigned</span> w = I.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a9ea9ad565387a61dccf38fc80a266c2a">ni</a>(), h = I.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a44859c72206da7d18728cb2bbf8ae829">nj</a>();
<a name="l01871"></a>01871   image.set_size(w,h);
<a name="l01872"></a>01872 
<a name="l01873"></a>01873   <span class="keyword">const</span> <span class="keywordtype">float</span> deg_to_rad = float(vnl_math::pi_over_180);
<a name="l01874"></a>01874   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> r = 0; r &lt; h; r++)
<a name="l01875"></a>01875     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> c = 0; c &lt; w; c++)
<a name="l01876"></a>01876     {
<a name="l01877"></a>01877       <span class="keywordtype">float</span> hue = H(c,r);
<a name="l01878"></a>01878       <span class="keywordtype">float</span> sat = 2.f*S(c,r);
<a name="l01879"></a>01879       <span class="keywordflow">if</span> (sat&lt;0)
<a name="l01880"></a>01880         sat = 0.f;
<a name="l01881"></a>01881       <span class="keywordflow">if</span> (sat&gt;255)
<a name="l01882"></a>01882         sat = 255.f;
<a name="l01883"></a>01883       <span class="keywordtype">float</span> ang = deg_to_rad*hue;
<a name="l01884"></a>01884       <span class="keywordtype">float</span> cs = vcl_cos(ang), si = vcl_fabs(vcl_sin(ang));
<a name="l01885"></a>01885       <span class="keywordtype">float</span> red=0.0f, blue=0.0f;
<a name="l01886"></a>01886       <span class="keywordtype">float</span> green = si*sat;
<a name="l01887"></a>01887       <span class="keywordflow">if</span> (cs&gt;=0)
<a name="l01888"></a>01888         red = cs*sat;
<a name="l01889"></a>01889       <span class="keywordflow">else</span>
<a name="l01890"></a>01890         blue = sat*(-cs);
<a name="l01891"></a>01891       image(c,r).r = (vxl_byte)red;
<a name="l01892"></a>01892       image(c,r).g = (vxl_byte)green;
<a name="l01893"></a>01893       image(c,r).b = (vxl_byte)blue;
<a name="l01894"></a>01894     }
<a name="l01895"></a>01895 }
<a name="l01896"></a>01896 
<a name="l01897"></a>01897 <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;vil_rgb&lt;vxl_byte&gt;</a> &gt; <a class="code" href="classbrip__vil__float__ops.html#a147aaff77fa9321322f1326d76e24806" title="Create a byte-pixel color image from multiple view channels (R,G,B).">brip_vil_float_ops::</a>
<a name="l01898"></a><a class="code" href="classbrip__vil__float__ops.html#a147aaff77fa9321322f1326d76e24806">01898</a> <a class="code" href="classbrip__vil__float__ops.html#a147aaff77fa9321322f1326d76e24806" title="Create a byte-pixel color image from multiple view channels (R,G,B).">combine_color_planes</a>(<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;vxl_byte&gt;</a> <span class="keyword">const</span>&amp; R,
<a name="l01899"></a>01899                      <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;vxl_byte&gt;</a> <span class="keyword">const</span>&amp; G,
<a name="l01900"></a>01900                      <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;vxl_byte&gt;</a> <span class="keyword">const</span>&amp; B)
<a name="l01901"></a>01901 {
<a name="l01902"></a>01902   <span class="keywordtype">unsigned</span> w = R.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a9ea9ad565387a61dccf38fc80a266c2a">ni</a>(), h = R.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a44859c72206da7d18728cb2bbf8ae829">nj</a>();
<a name="l01903"></a>01903   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;vil_rgb&lt;vxl_byte&gt;</a> &gt; image(w,h);
<a name="l01904"></a>01904   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> r = 0; r &lt; h; r++)
<a name="l01905"></a>01905     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> c = 0; c &lt; w; c++)
<a name="l01906"></a>01906     {
<a name="l01907"></a>01907       image(c,r).r = R(c,r);
<a name="l01908"></a>01908       image(c,r).g = G(c,r);
<a name="l01909"></a>01909       image(c,r).b = B(c,r);
<a name="l01910"></a>01910     }
<a name="l01911"></a>01911   <span class="keywordflow">return</span> image;
<a name="l01912"></a>01912 }
<a name="l01913"></a>01913 
<a name="l01914"></a>01914 <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;vil_rgb&lt;vxl_byte&gt;</a> &gt;
<a name="l01915"></a><a class="code" href="classbrip__vil__float__ops.html#ae34932e50a117f311c694bd12eaab446">01915</a> <a class="code" href="classbrip__vil__float__ops.html#a147aaff77fa9321322f1326d76e24806" title="Create a byte-pixel color image from multiple view channels (R,G,B).">brip_vil_float_ops::combine_color_planes</a>(<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__smart__ptr.html">vil_image_resource_sptr</a> <span class="keyword">const</span>&amp; R,
<a name="l01916"></a>01916                                          <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__smart__ptr.html">vil_image_resource_sptr</a> <span class="keyword">const</span>&amp; G,
<a name="l01917"></a>01917                                          <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__smart__ptr.html">vil_image_resource_sptr</a> <span class="keyword">const</span>&amp; B)
<a name="l01918"></a>01918 {
<a name="l01919"></a>01919   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;vil_rgb&lt;vxl_byte&gt;</a> &gt; view(0,0);
<a name="l01920"></a>01920   <span class="keywordflow">if</span> (!R||!G||!B)
<a name="l01921"></a>01921     <span class="keywordflow">return</span> view; <span class="comment">// return an empty view</span>
<a name="l01922"></a>01922   <span class="comment">// determine the union of all the resources</span>
<a name="l01923"></a>01923   <a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__bounding__box.html">vbl_bounding_box&lt;unsigned int, 2&gt;</a> b;
<a name="l01924"></a>01924   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> r_ni = R-&gt;ni(), r_nj = R-&gt;nj();
<a name="l01925"></a>01925   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> g_ni = G-&gt;ni(), g_nj = G-&gt;nj();
<a name="l01926"></a>01926   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> b_ni = B-&gt;ni(), b_nj = B-&gt;nj();
<a name="l01927"></a>01927   b.<a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__bounding__box__base.html#a7ef4b00f7beb30bdfc05c1e98b1b595a">update</a>(r_ni, r_nj);
<a name="l01928"></a>01928   b.<a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__bounding__box__base.html#a7ef4b00f7beb30bdfc05c1e98b1b595a">update</a>(g_ni, g_nj);
<a name="l01929"></a>01929   b.<a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__bounding__box__base.html#a7ef4b00f7beb30bdfc05c1e98b1b595a">update</a>(b_ni, b_nj);
<a name="l01930"></a>01930   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> n_i = b.<a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__bounding__box__base.html#aadc63437cf501b3b5d7deb036e15c406">xmax</a>(), n_j = b.<a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__bounding__box__base.html#a3ed2812c5a93f963f49f73d74e010d81">ymax</a>();
<a name="l01931"></a>01931   view.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html#a9c01939f01ef50314620e26aaacb04d3">set_size</a>(n_i, n_j);
<a name="l01932"></a>01932   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/structvil__rgb.html">vil_rgb&lt;vxl_byte&gt;</a> zero(0, 0, 0);
<a name="l01933"></a>01933   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a>    fR = <a class="code" href="classbrip__vil__float__ops.html#afc428b73d4f323a495252b0f5cb30a20" title="converts a vil_image_resource to a float image.">brip_vil_float_ops::convert_to_float</a>(R);
<a name="l01934"></a>01934   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;vxl_byte&gt;</a> cR = <a class="code" href="classbrip__vil__float__ops.html#af77691e76e6b2fc38568b3c07cb3335d" title="converts a float image to a byte value range.">brip_vil_float_ops::convert_to_byte</a>(fR);
<a name="l01935"></a>01935   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a>    fG = <a class="code" href="classbrip__vil__float__ops.html#afc428b73d4f323a495252b0f5cb30a20" title="converts a vil_image_resource to a float image.">brip_vil_float_ops::convert_to_float</a>(G);
<a name="l01936"></a>01936   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;vxl_byte&gt;</a> cG = <a class="code" href="classbrip__vil__float__ops.html#af77691e76e6b2fc38568b3c07cb3335d" title="converts a float image to a byte value range.">brip_vil_float_ops::convert_to_byte</a>(fG);
<a name="l01937"></a>01937   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a>    fB = <a class="code" href="classbrip__vil__float__ops.html#afc428b73d4f323a495252b0f5cb30a20" title="converts a vil_image_resource to a float image.">brip_vil_float_ops::convert_to_float</a>(B);
<a name="l01938"></a>01938   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;vxl_byte&gt;</a> cB = <a class="code" href="classbrip__vil__float__ops.html#af77691e76e6b2fc38568b3c07cb3335d" title="converts a float image to a byte value range.">brip_vil_float_ops::convert_to_byte</a>(fB);
<a name="l01939"></a>01939   <span class="keywordflow">for</span> (vxl_uint_16 j = 0; j&lt;n_j; ++j)
<a name="l01940"></a>01940     <span class="keywordflow">for</span> (vxl_uint_16 i = 0; i&lt;n_i; ++i)
<a name="l01941"></a>01941     {
<a name="l01942"></a>01942       <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/structvil__rgb.html">vil_rgb&lt;vxl_byte&gt;</a> <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/vgl__vector__2d_8h.html#a38bf1e5e0427bdeba2b469eea9befc23">v</a> = zero;
<a name="l01943"></a>01943       <span class="keywordflow">if</span> (i&lt;r_ni&amp;&amp;j&lt;r_nj)
<a name="l01944"></a>01944         v.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/structvil__rgb.html#a00531dfe37aefaac34f63d954ce244f5">r</a> = cR(i,j);
<a name="l01945"></a>01945       <span class="keywordflow">if</span> (i&lt;g_ni&amp;&amp;j&lt;g_nj)
<a name="l01946"></a>01946         v.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/structvil__rgb.html#a88111b5b1688f13c33bb27b931a1a782">g</a>= cG(i,j);
<a name="l01947"></a>01947       <span class="keywordflow">if</span> (i&lt;b_ni&amp;&amp;j&lt;b_nj)
<a name="l01948"></a>01948         v.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/structvil__rgb.html#ae4c341d1e11338aa68adc5441b939900">b</a>= cB(i,j);
<a name="l01949"></a>01949       view(i,j)=v;
<a name="l01950"></a>01950     }
<a name="l01951"></a>01951   <span class="keywordflow">return</span> view;
<a name="l01952"></a>01952 }
<a name="l01953"></a>01953 
<a name="l01954"></a>01954 <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a>
<a name="l01955"></a><a class="code" href="classbrip__vil__float__ops.html#afc428b73d4f323a495252b0f5cb30a20">01955</a> <a class="code" href="classbrip__vil__float__ops.html#afc428b73d4f323a495252b0f5cb30a20" title="converts a vil_image_resource to a float image.">brip_vil_float_ops::convert_to_float</a>(<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__resource.html">vil_image_resource</a> <span class="keyword">const</span>&amp; image)
<a name="l01956"></a>01956 {
<a name="l01957"></a>01957   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> fimg;
<a name="l01958"></a>01958   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/vil__pixel__format_8h.html#a6f749d91364b0bcb661189f4a154800d">vil_pixel_format</a> fmt = image.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__resource.html#a5ea3c315747b7f1433b10706875b539c">pixel_format</a>();
<a name="l01959"></a>01959   <span class="keywordflow">if</span> (<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/vil__pixel__format_8cxx.html#a2637b810a0cdc48160ea51da1dd19831">vil_pixel_format_num_components</a>(image.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__resource.html#a5ea3c315747b7f1433b10706875b539c">pixel_format</a>())==1)
<a name="l01960"></a>01960   {
<a name="l01961"></a>01961     <span class="keywordflow">if</span> (fmt==<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/vil__pixel__format_8h.html#a6f749d91364b0bcb661189f4a154800dabecb5c0033517756dc112ccd18f97073">VIL_PIXEL_FORMAT_UINT_16</a>)
<a name="l01962"></a>01962     {
<a name="l01963"></a>01963       <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;unsigned short&gt;</a> temp=image.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__resource.html#aacd09edeeecf84f6fb35348893e21e15">get_view</a>();
<a name="l01964"></a>01964       fimg = <a class="code" href="classbrip__vil__float__ops.html#afc428b73d4f323a495252b0f5cb30a20" title="converts a vil_image_resource to a float image.">brip_vil_float_ops::convert_to_float</a>(temp);
<a name="l01965"></a>01965     }
<a name="l01966"></a>01966     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (fmt==<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/vil__pixel__format_8h.html#a6f749d91364b0bcb661189f4a154800da7e558fc5ba55dbb9c32658e7960b83f4">VIL_PIXEL_FORMAT_BYTE</a>)
<a name="l01967"></a>01967     {
<a name="l01968"></a>01968       <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;unsigned char&gt;</a> temp=image.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__resource.html#aacd09edeeecf84f6fb35348893e21e15">get_view</a>();
<a name="l01969"></a>01969       fimg = <a class="code" href="classbrip__vil__float__ops.html#afc428b73d4f323a495252b0f5cb30a20" title="converts a vil_image_resource to a float image.">brip_vil_float_ops::convert_to_float</a>(temp);
<a name="l01970"></a>01970     }
<a name="l01971"></a>01971     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (fmt==<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/vil__pixel__format_8h.html#a6f749d91364b0bcb661189f4a154800da8d2e38094a68770dcad0e6637d5ce3ba">VIL_PIXEL_FORMAT_FLOAT</a>)
<a name="l01972"></a>01972       <span class="keywordflow">return</span> image.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__resource.html#aacd09edeeecf84f6fb35348893e21e15">get_view</a>();
<a name="l01973"></a>01973   }
<a name="l01974"></a>01974   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/vil__pixel__format_8cxx.html#a2637b810a0cdc48160ea51da1dd19831">vil_pixel_format_num_components</a>(fmt)==3)
<a name="l01975"></a>01975   {
<a name="l01976"></a>01976     <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;vil_rgb&lt;vxl_byte&gt;</a> &gt; temp= image.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__resource.html#aacd09edeeecf84f6fb35348893e21e15">get_view</a>();
<a name="l01977"></a>01977     fimg = <a class="code" href="classbrip__vil__float__ops.html#afc428b73d4f323a495252b0f5cb30a20" title="converts a vil_image_resource to a float image.">brip_vil_float_ops::convert_to_float</a>(temp);
<a name="l01978"></a>01978   }
<a name="l01979"></a>01979   <span class="keywordflow">else</span>
<a name="l01980"></a>01980   {
<a name="l01981"></a>01981     vcl_cout &lt;&lt; <span class="stringliteral">&quot;In brip_vil_float_ops::convert_to_float - input not color or grey\n&quot;</span>;
<a name="l01982"></a>01982     <span class="keywordflow">return</span> <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a>();
<a name="l01983"></a>01983   }
<a name="l01984"></a>01984   <span class="keywordflow">return</span> fimg;
<a name="l01985"></a>01985 }
<a name="l01986"></a>01986 
<a name="l01987"></a>01987 <span class="comment">//-----------------------------------------------------------------</span>
<a name="l01988"></a>01988 <span class="comment">//: Convert any image to an unsigned_char image</span>
<a name="l01989"></a>01989 <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;vxl_byte&gt;</a>
<a name="l01990"></a><a class="code" href="classbrip__vil__float__ops.html#a279d627c74a027f7f5a168f6b2ea0f19">01990</a> <a class="code" href="classbrip__vil__float__ops.html#a279d627c74a027f7f5a168f6b2ea0f19" title="converts a generic (byte-pixel RGB) image to greyscale.">brip_vil_float_ops::convert_to_grey</a>(<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__resource.html">vil_image_resource</a> <span class="keyword">const</span>&amp; image)
<a name="l01991"></a>01991 {
<a name="l01992"></a>01992   <span class="comment">// Check if the image is a float</span>
<a name="l01993"></a>01993   <span class="keywordflow">if</span> (image.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__resource.html#abe3c10a311740c98cf5f1c01e45fb346">nplanes</a>()==1 &amp;&amp;image.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__resource.html#a5ea3c315747b7f1433b10706875b539c">pixel_format</a>()==<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/vil__pixel__format_8h.html#a6f749d91364b0bcb661189f4a154800da8d2e38094a68770dcad0e6637d5ce3ba">VIL_PIXEL_FORMAT_FLOAT</a>)
<a name="l01994"></a>01994   {
<a name="l01995"></a>01995     <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> temp = image.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__resource.html#aacd09edeeecf84f6fb35348893e21e15">get_view</a>();
<a name="l01996"></a>01996     <span class="keywordtype">float</span> vmin=0, vmax=255;
<a name="l01997"></a>01997     vil_math_value_range&lt;float&gt;(temp, vmin, vmax);
<a name="l01998"></a>01998     <span class="keywordflow">return</span> <a class="code" href="classbrip__vil__float__ops.html#af77691e76e6b2fc38568b3c07cb3335d" title="converts a float image to a byte value range.">brip_vil_float_ops::convert_to_byte</a>(temp, vmin, vmax);
<a name="l01999"></a>01999   }
<a name="l02000"></a>02000   <span class="keywordflow">if</span> (image.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__resource.html#abe3c10a311740c98cf5f1c01e45fb346">nplanes</a>()==1 &amp;&amp;image.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__resource.html#a5ea3c315747b7f1433b10706875b539c">pixel_format</a>()==<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/vil__pixel__format_8h.html#a6f749d91364b0bcb661189f4a154800da270ef8e69c137b9bed10074d2726ffa9">VIL_PIXEL_FORMAT_BOOL</a>)
<a name="l02001"></a>02001   {
<a name="l02002"></a>02002     <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;bool&gt;</a> temp = image.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__resource.html#aacd09edeeecf84f6fb35348893e21e15">get_view</a>();
<a name="l02003"></a>02003     <span class="keywordtype">unsigned</span> nj = temp.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a44859c72206da7d18728cb2bbf8ae829">nj</a>(), ni = temp.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a9ea9ad565387a61dccf38fc80a266c2a">ni</a>();
<a name="l02004"></a>02004     <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;unsigned char&gt;</a> out(ni, nj);
<a name="l02005"></a>02005     out.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html#a6fd591632020e490abb5e4493a52dbba">fill</a>(0);
<a name="l02006"></a>02006     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> j = 0; j&lt;nj; ++j)
<a name="l02007"></a>02007       <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> i = 0; i&lt;ni; ++i)
<a name="l02008"></a>02008         <span class="keywordflow">if</span> (temp(i,j)) out(i,j) = 255;
<a name="l02009"></a>02009     <span class="keywordflow">return</span> out;
<a name="l02010"></a>02010   }
<a name="l02011"></a>02011 
<a name="l02012"></a>02012   <span class="comment">// Here we assume that the image is an unsigned char</span>
<a name="l02013"></a>02013   <span class="comment">// In this case we should just return it.</span>
<a name="l02014"></a>02014   <span class="keywordflow">if</span> (image.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__resource.html#abe3c10a311740c98cf5f1c01e45fb346">nplanes</a>()==1&amp;&amp;image.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__resource.html#a5ea3c315747b7f1433b10706875b539c">pixel_format</a>()==<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/vil__pixel__format_8h.html#a6f749d91364b0bcb661189f4a154800da7e558fc5ba55dbb9c32658e7960b83f4">VIL_PIXEL_FORMAT_BYTE</a>)
<a name="l02015"></a>02015   {
<a name="l02016"></a>02016     <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;unsigned char &gt;</a> temp = image.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__resource.html#aacd09edeeecf84f6fb35348893e21e15">get_view</a>();
<a name="l02017"></a>02017     <span class="keywordflow">return</span> temp;
<a name="l02018"></a>02018   }
<a name="l02019"></a>02019 
<a name="l02020"></a>02020   <span class="keywordflow">if</span> (image.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__resource.html#abe3c10a311740c98cf5f1c01e45fb346">nplanes</a>()==1&amp;&amp;image.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__resource.html#a5ea3c315747b7f1433b10706875b539c">pixel_format</a>()==<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/vil__pixel__format_8h.html#a6f749d91364b0bcb661189f4a154800dabecb5c0033517756dc112ccd18f97073">VIL_PIXEL_FORMAT_UINT_16</a>)
<a name="l02021"></a>02021   {
<a name="l02022"></a>02022     <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;unsigned short &gt;</a> temp = image.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__resource.html#aacd09edeeecf84f6fb35348893e21e15">get_view</a>();
<a name="l02023"></a>02023     <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> vmin=0, vmax=255;
<a name="l02024"></a>02024     vil_math_value_range&lt;unsigned short&gt;(temp, vmin, vmax);
<a name="l02025"></a>02025     <span class="keywordflow">return</span> <a class="code" href="classbrip__vil__float__ops.html#af77691e76e6b2fc38568b3c07cb3335d" title="converts a float image to a byte value range.">brip_vil_float_ops::convert_to_byte</a>(temp, vmin, vmax);
<a name="l02026"></a>02026   }
<a name="l02027"></a>02027   <span class="comment">// the image is color so we should convert it to greyscale</span>
<a name="l02028"></a>02028   <span class="comment">// Here we assume the color elements are unsigned char.</span>
<a name="l02029"></a>02029   <span class="keywordflow">if</span> (image.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__resource.html#abe3c10a311740c98cf5f1c01e45fb346">nplanes</a>()==3&amp;&amp;image.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__resource.html#a5ea3c315747b7f1433b10706875b539c">pixel_format</a>()==<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/vil__pixel__format_8h.html#a6f749d91364b0bcb661189f4a154800da7e558fc5ba55dbb9c32658e7960b83f4">VIL_PIXEL_FORMAT_BYTE</a>)
<a name="l02030"></a>02030   {
<a name="l02031"></a>02031     <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;vil_rgb&lt;vxl_byte&gt;</a> &gt; color_image = image.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__resource.html#aacd09edeeecf84f6fb35348893e21e15">get_view</a>();
<a name="l02032"></a>02032     <span class="keywordtype">unsigned</span> width = color_image.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a9ea9ad565387a61dccf38fc80a266c2a">ni</a>(), height = color_image.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a44859c72206da7d18728cb2bbf8ae829">nj</a>();
<a name="l02033"></a>02033     <span class="comment">// the output image</span>
<a name="l02034"></a>02034     <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;unsigned char&gt;</a> grey_image;
<a name="l02035"></a>02035     grey_image.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html#a9c01939f01ef50314620e26aaacb04d3">set_size</a>(width, height);
<a name="l02036"></a>02036     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> y = 0; y&lt;height; y++)
<a name="l02037"></a>02037       <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> x = 0; x&lt;width; x++)
<a name="l02038"></a>02038         grey_image(x,y) = color_image(x,y).grey();
<a name="l02039"></a>02039     <span class="keywordflow">return</span> grey_image;
<a name="l02040"></a>02040   }
<a name="l02041"></a>02041   <span class="keywordflow">if</span> (image.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__resource.html#abe3c10a311740c98cf5f1c01e45fb346">nplanes</a>()==3&amp;&amp;image.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__resource.html#a5ea3c315747b7f1433b10706875b539c">pixel_format</a>()==<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/vil__pixel__format_8h.html#a6f749d91364b0bcb661189f4a154800da8d2e38094a68770dcad0e6637d5ce3ba">VIL_PIXEL_FORMAT_FLOAT</a>)
<a name="l02042"></a>02042   {
<a name="l02043"></a>02043     <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> color_image = image.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__resource.html#aacd09edeeecf84f6fb35348893e21e15">get_view</a>();
<a name="l02044"></a>02044     <span class="keywordtype">unsigned</span> width = color_image.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a9ea9ad565387a61dccf38fc80a266c2a">ni</a>(), height = color_image.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a44859c72206da7d18728cb2bbf8ae829">nj</a>();
<a name="l02045"></a>02045     <span class="comment">// the output image</span>
<a name="l02046"></a>02046     <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> grey_image_f;
<a name="l02047"></a>02047     grey_image_f.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html#a9c01939f01ef50314620e26aaacb04d3">set_size</a>(width, height);
<a name="l02048"></a>02048     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> y = 0; y&lt;height; y++)
<a name="l02049"></a>02049       <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> x = 0; x&lt;width; x++) {
<a name="l02050"></a>02050         <span class="keywordtype">float</span> <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/vgl__vector__2d_8h.html#a38bf1e5e0427bdeba2b469eea9befc23">v</a> = 0;
<a name="l02051"></a>02051         <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> p = 0; p&lt;3; ++p)
<a name="l02052"></a>02052           v += color_image(x,y,p);
<a name="l02053"></a>02053         grey_image_f(x,y) = v/3.0f;
<a name="l02054"></a>02054       }
<a name="l02055"></a>02055     <span class="keywordtype">float</span> vmin=0, vmax=255;
<a name="l02056"></a>02056     vil_math_value_range&lt;float&gt;(grey_image_f, vmin, vmax);
<a name="l02057"></a>02057     <span class="keywordflow">return</span> <a class="code" href="classbrip__vil__float__ops.html#af77691e76e6b2fc38568b3c07cb3335d" title="converts a float image to a byte value range.">brip_vil_float_ops::convert_to_byte</a>(grey_image_f, vmin, vmax);
<a name="l02058"></a>02058   }
<a name="l02059"></a>02059   <span class="comment">// If we get here then the input is not a type we handle so return a null view</span>
<a name="l02060"></a>02060   <span class="keywordflow">return</span> <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;vxl_byte&gt;</a>();
<a name="l02061"></a>02061 }
<a name="l02062"></a>02062 
<a name="l02063"></a>02063 <span class="comment">//--------------------------------------------------------------</span>
<a name="l02064"></a>02064 <span class="comment">//: Read a convolution kernel from file</span>
<a name="l02065"></a>02065 <span class="comment">// Assumes a square kernel with odd dimensions, i.e., w,h = 2n+1</span>
<a name="l02066"></a>02066 <span class="comment">// format:</span>
<a name="l02067"></a>02067 <span class="comment">// \verbatim</span>
<a name="l02068"></a>02068 <span class="comment">//     n</span>
<a name="l02069"></a>02069 <span class="comment">//     scale</span>
<a name="l02070"></a>02070 <span class="comment">//     k00  k01  ... k02n</span>
<a name="l02071"></a>02071 <span class="comment">//           ...</span>
<a name="l02072"></a>02072 <span class="comment">//     k2n0 k2n1 ... k2n2n</span>
<a name="l02073"></a>02073 <span class="comment">// \endverbatim</span>
<a name="l02074"></a>02074 <span class="comment">//</span>
<a name="l02075"></a><a class="code" href="classbrip__vil__float__ops.html#acca1cda9612b77149b18f1512d8e9823">02075</a> <a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__array__2d.html">vbl_array_2d&lt;float&gt;</a> <a class="code" href="classbrip__vil__float__ops.html#acca1cda9612b77149b18f1512d8e9823" title="loads a $2n+1 ~~ 2n+1$ convolution kernel.">brip_vil_float_ops::load_kernel</a>(vcl_string <span class="keyword">const</span>&amp; file)
<a name="l02076"></a>02076 {
<a name="l02077"></a>02077   vcl_ifstream instr(file.c_str(), vcl_ios::in);
<a name="l02078"></a>02078   <span class="keywordflow">if</span> (!instr)
<a name="l02079"></a>02079   {
<a name="l02080"></a>02080     vcl_cout &lt;&lt; <span class="stringliteral">&quot;In brip_vil_float_ops::load_kernel - failed to load kernel\n&quot;</span>;
<a name="l02081"></a>02081     <span class="keywordflow">return</span> <a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__array__2d.html">vbl_array_2d&lt;float&gt;</a>(0,0);
<a name="l02082"></a>02082   }
<a name="l02083"></a>02083   <span class="keywordtype">unsigned</span> n;
<a name="l02084"></a>02084   <span class="keywordtype">float</span> scale;
<a name="l02085"></a>02085   <span class="keywordtype">float</span> <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/vgl__vector__2d_8h.html#a38bf1e5e0427bdeba2b469eea9befc23">v</a> =0.0f;
<a name="l02086"></a>02086   instr &gt;&gt; n;
<a name="l02087"></a>02087   instr &gt;&gt; scale;
<a name="l02088"></a>02088   <span class="keywordtype">unsigned</span> N = 2*n+1;
<a name="l02089"></a>02089   <a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__array__2d.html">vbl_array_2d&lt;float&gt;</a> output(N, N);
<a name="l02090"></a>02090   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> y = 0; y&lt;N; y++)
<a name="l02091"></a>02091     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> x = 0; x&lt;N; x++)
<a name="l02092"></a>02092     {
<a name="l02093"></a>02093       instr &gt;&gt; v;
<a name="l02094"></a>02094       output.<a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__array__2d.html#a67eebbfbe4e8a3b8822abf94f35ceb43">put</a>(x, y, v/scale);
<a name="l02095"></a>02095     }
<a name="l02096"></a>02096 <span class="preprocessor">#ifdef DEBUG</span>
<a name="l02097"></a>02097 <span class="preprocessor"></span>  vcl_cout &lt;&lt; <span class="stringliteral">&quot;The Kernel\n&quot;</span>;
<a name="l02098"></a>02098   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> y = 0; y&lt;N; y++)
<a name="l02099"></a>02099   {
<a name="l02100"></a>02100     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> x = 0; x&lt;N; x++)
<a name="l02101"></a>02101       vcl_cout &lt;&lt; <span class="charliteral">&#39; &#39;</span> &lt;&lt;  output[x][y];
<a name="l02102"></a>02102     vcl_cout &lt;&lt; <span class="charliteral">&#39;\n&#39;</span>;
<a name="l02103"></a>02103   }
<a name="l02104"></a>02104 <span class="preprocessor">#endif</span>
<a name="l02105"></a>02105 <span class="preprocessor"></span>  <span class="keywordflow">return</span> output;
<a name="l02106"></a>02106 }
<a name="l02107"></a>02107 
<a name="l02108"></a>02108 <span class="keyword">static</span> <span class="keywordtype">void</span> insert_image(<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> <span class="keyword">const</span>&amp; image, <span class="keywordtype">int</span> col,
<a name="l02109"></a>02109                          <a class="codeRef" doxygen="core_vnl.tag:../../../../../core/vnl/html" href="../../../../../core/vnl/html/classvnl__matrix.html">vnl_matrix&lt;float&gt;</a> &amp; I)
<a name="l02110"></a>02110 {
<a name="l02111"></a>02111   <span class="keywordtype">unsigned</span> width = image.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a9ea9ad565387a61dccf38fc80a266c2a">ni</a>(), height = image.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a44859c72206da7d18728cb2bbf8ae829">nj</a>(), row=0;
<a name="l02112"></a>02112   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> y =0; y&lt;height; y++)
<a name="l02113"></a>02113     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> x = 0; x&lt;width; x++, row++)
<a name="l02114"></a>02114       I.<a class="codeRef" doxygen="core_vnl.tag:../../../../../core/vnl/html" href="../../../../../core/vnl/html/classvnl__matrix.html#a45a132d7cafb7f0ceb414efd48802fb0">put</a>(row, col, image(x,y));
<a name="l02115"></a>02115 }
<a name="l02116"></a>02116 
<a name="l02117"></a>02117 <span class="keywordtype">void</span> <a class="code" href="classbrip__vil__float__ops.html#ab771e5c930e15488a719d90c63b470f8" title="compute basis images for a set of input images.">brip_vil_float_ops::</a>
<a name="l02118"></a><a class="code" href="classbrip__vil__float__ops.html#ab771e5c930e15488a719d90c63b470f8">02118</a> <a class="code" href="classbrip__vil__float__ops.html#ab771e5c930e15488a719d90c63b470f8" title="compute basis images for a set of input images.">basis_images</a>(vcl_vector&lt;<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> &gt; <span class="keyword">const</span>&amp; input_images,
<a name="l02119"></a>02119              vcl_vector&lt;<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> &gt;&amp; basis)
<a name="l02120"></a>02120 {
<a name="l02121"></a>02121   basis.clear();
<a name="l02122"></a>02122   <span class="keywordtype">unsigned</span> n_images = input_images.size();
<a name="l02123"></a>02123   <span class="keywordflow">if</span> (!n_images)
<a name="l02124"></a>02124   {
<a name="l02125"></a>02125     vcl_cout &lt;&lt; <span class="stringliteral">&quot;In brip_vil_float_ops::basis_images(.) - no input images\n&quot;</span>;
<a name="l02126"></a>02126     <span class="keywordflow">return</span>;
<a name="l02127"></a>02127   }
<a name="l02128"></a>02128   <span class="keywordtype">unsigned</span> width = input_images[0].ni(), height = input_images[0].nj();
<a name="l02129"></a>02129   <span class="keywordtype">unsigned</span> npix = width*height;
<a name="l02130"></a>02130 
<a name="l02131"></a>02131   <span class="comment">// Insert the images into matrix I</span>
<a name="l02132"></a>02132   <a class="codeRef" doxygen="core_vnl.tag:../../../../../core/vnl/html" href="../../../../../core/vnl/html/classvnl__matrix.html">vnl_matrix&lt;float&gt;</a> I(npix, n_images, 0.f);
<a name="l02133"></a>02133   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> i = 0; i&lt;n_images; i++)
<a name="l02134"></a>02134     insert_image(input_images[i], i, I);
<a name="l02135"></a>02135 
<a name="l02136"></a>02136   <span class="comment">// Compute the SVD of matrix I</span>
<a name="l02137"></a>02137 <span class="preprocessor">#ifdef DEBUG</span>
<a name="l02138"></a>02138 <span class="preprocessor"></span>  vcl_cout &lt;&lt; <span class="stringliteral">&quot;Computing Singular values of a &quot;</span> &lt;&lt;  npix &lt;&lt; <span class="stringliteral">&quot; by &quot;</span>
<a name="l02139"></a>02139            &lt;&lt; n_images &lt;&lt; <span class="stringliteral">&quot; matrix\n&quot;</span>;
<a name="l02140"></a>02140   <a class="codeRef" doxygen="core_vul.tag:../../../../../core/vul/html" href="../../../../../core/vul/html/classvul__timer.html">vul_timer</a> t;
<a name="l02141"></a>02141 <span class="preprocessor">#endif</span>
<a name="l02142"></a>02142 <span class="preprocessor"></span>  <a class="codeRef" doxygen="core_vnl.tag:../../../../../core/vnl/html" href="../../../../../core/vnl/html/classvnl__svd.html">vnl_svd&lt;float&gt;</a> svd(I);
<a name="l02143"></a>02143 <span class="preprocessor">#ifdef DEBUG</span>
<a name="l02144"></a>02144 <span class="preprocessor"></span>  vcl_cout &lt;&lt; <span class="stringliteral">&quot;SVD Took &quot;</span> &lt;&lt; t.<a class="codeRef" doxygen="core_vul.tag:../../../../../core/vul/html" href="../../../../../core/vul/html/classvul__timer.html#a14c86b3c27f36c1946c184941e006370">real</a>() &lt;&lt; <span class="stringliteral">&quot; msecs\n&quot;</span>
<a name="l02145"></a>02145            &lt;&lt; <span class="stringliteral">&quot;Eigenvalues:\n&quot;</span>;
<a name="l02146"></a>02146   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> i = 0; i&lt;n_images; i++)
<a name="l02147"></a>02147     vcl_cout &lt;&lt; svd.<a class="codeRef" doxygen="core_vnl.tag:../../../../../core/vnl/html" href="../../../../../core/vnl/html/classvnl__svd.html#a3b3197be0858ae3315117e6d49cfa4ff">W</a>(i) &lt;&lt; <span class="charliteral">&#39;\n&#39;</span>;
<a name="l02148"></a>02148 <span class="preprocessor">#endif</span>
<a name="l02149"></a>02149 <span class="preprocessor"></span>  <span class="comment">// Extract the Basis images</span>
<a name="l02150"></a>02150   <span class="keywordtype">unsigned</span> rank = svd.<a class="codeRef" doxygen="core_vnl.tag:../../../../../core/vnl/html" href="../../../../../core/vnl/html/classvnl__svd.html#a8bd7961063ebeda214bfb7fad8e63c3c">rank</a>();
<a name="l02151"></a>02151   <span class="keywordflow">if</span> (!rank)
<a name="l02152"></a>02152   {
<a name="l02153"></a>02153     vcl_cout &lt;&lt; <span class="stringliteral">&quot;In brip_vil_float_ops::basis_images(.) - I has zero rank\n&quot;</span>;
<a name="l02154"></a>02154     <span class="keywordflow">return</span>;
<a name="l02155"></a>02155   }
<a name="l02156"></a>02156   <a class="codeRef" doxygen="core_vnl.tag:../../../../../core/vnl/html" href="../../../../../core/vnl/html/classvnl__matrix.html">vnl_matrix&lt;float&gt;</a> U = svd.<a class="codeRef" doxygen="core_vnl.tag:../../../../../core/vnl/html" href="../../../../../core/vnl/html/classvnl__svd.html#ab90d87b0dd53bb3afe92e7c4e6a1d090">U</a>();
<a name="l02157"></a>02157   <span class="comment">// Output the basis images</span>
<a name="l02158"></a>02158   <span class="keywordtype">unsigned</span> rows = U.<a class="codeRef" doxygen="core_vnl.tag:../../../../../core/vnl/html" href="../../../../../core/vnl/html/classvnl__matrix.html#a840b1c4c74689f19b0496d476c5cc2d7">rows</a>();
<a name="l02159"></a>02159   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> k = 0; k&lt;rank; k++)
<a name="l02160"></a>02160   {
<a name="l02161"></a>02161     <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> out(width, height);
<a name="l02162"></a>02162     <span class="keywordtype">unsigned</span> x =0, y = 0;
<a name="l02163"></a>02163     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> r = 0; r&lt;rows; r++)
<a name="l02164"></a>02164     {
<a name="l02165"></a>02165       out(x, y) = U(r,k);
<a name="l02166"></a>02166       x++;
<a name="l02167"></a>02167       <span class="keywordflow">if</span> (x&gt;=width)
<a name="l02168"></a>02168       {
<a name="l02169"></a>02169         y++;
<a name="l02170"></a>02170         x=0;
<a name="l02171"></a>02171       }
<a name="l02172"></a>02172       <span class="keywordflow">if</span> (y&gt;=width)
<a name="l02173"></a>02173       {
<a name="l02174"></a>02174         vcl_cout&lt;&lt;<span class="stringliteral">&quot;In brip_vil_float_ops::basis_images(.) - shouldn&#39;t happen\n&quot;</span>;
<a name="l02175"></a>02175         <span class="keywordflow">return</span>;
<a name="l02176"></a>02176       }
<a name="l02177"></a>02177     }
<a name="l02178"></a>02178     basis.push_back(out);
<a name="l02179"></a>02179   }
<a name="l02180"></a>02180 }
<a name="l02181"></a>02181 
<a name="l02182"></a>02182 <span class="comment">//: 1d fourier transform</span>
<a name="l02183"></a>02183 <span class="comment">//-------------------------------------------------------------------------</span>
<a name="l02184"></a>02184 <span class="comment">// This computes an in-place complex-to-complex FFT</span>
<a name="l02185"></a>02185 <span class="comment">// x and y are the real and imaginary arrays of 2^m points.</span>
<a name="l02186"></a>02186 <span class="comment">// dir =  1 gives forward transform</span>
<a name="l02187"></a>02187 <span class="comment">// dir = -1 gives reverse transform</span>
<a name="l02188"></a>02188 <span class="comment">//</span>
<a name="l02189"></a>02189 <span class="comment">//   Formula: forward</span>
<a name="l02190"></a>02190 <span class="comment">// \verbatim</span>
<a name="l02191"></a>02191 <span class="comment">//                N-1</span>
<a name="l02192"></a>02192 <span class="comment">//                ---</span>
<a name="l02193"></a>02193 <span class="comment">//            1   \          - j k 2 pi n / N</span>
<a name="l02194"></a>02194 <span class="comment">//    X(n) = ---   &gt;   x(k) e                    = forward transform</span>
<a name="l02195"></a>02195 <span class="comment">//            N   /                                n=0..N-1</span>
<a name="l02196"></a>02196 <span class="comment">//                ---</span>
<a name="l02197"></a>02197 <span class="comment">//                k=0</span>
<a name="l02198"></a>02198 <span class="comment">// \endverbatim</span>
<a name="l02199"></a>02199 <span class="comment">//</span>
<a name="l02200"></a>02200 <span class="comment">//    Formula: reverse</span>
<a name="l02201"></a>02201 <span class="comment">// \verbatim</span>
<a name="l02202"></a>02202 <span class="comment">//                N-1</span>
<a name="l02203"></a>02203 <span class="comment">//                ---</span>
<a name="l02204"></a>02204 <span class="comment">//                \          j k 2 pi n / N</span>
<a name="l02205"></a>02205 <span class="comment">//    X(n) =       &gt;   x(k) e                    = forward transform</span>
<a name="l02206"></a>02206 <span class="comment">//                /                                n=0..N-1</span>
<a name="l02207"></a>02207 <span class="comment">//                ---</span>
<a name="l02208"></a>02208 <span class="comment">//                k=0</span>
<a name="l02209"></a>02209 <span class="comment">// \endverbatim</span>
<a name="l02210"></a><a class="code" href="classbrip__vil__float__ops.html#af5bc1527e59afc42c7cfb291adef8251">02210</a> <span class="comment">//</span>
<a name="l02211"></a>02211 <span class="keywordtype">bool</span> <a class="code" href="classbrip__vil__float__ops.html#af5bc1527e59afc42c7cfb291adef8251" title="One-dimensional fft.">brip_vil_float_ops::fft_1d</a>(<span class="keywordtype">int</span> dir, <span class="keywordtype">int</span> m, <span class="keywordtype">double</span>* x, <span class="keywordtype">double</span>* y)
<a name="l02212"></a>02212 {
<a name="l02213"></a>02213   <span class="keywordtype">long</span> nn,i,i1,j,k,i2,<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/vgl__homg__line__2d_8h.html#a1cb503ddd20ff3cf9588d2b5abd202d8">l</a>,l1,l2;
<a name="l02214"></a>02214   <span class="keywordtype">double</span> c1,c2,tx,ty,t1,t2,u1,u2,z;
<a name="l02215"></a>02215 
<a name="l02216"></a>02216   <span class="comment">// Calculate the number of points</span>
<a name="l02217"></a>02217   nn = 1;
<a name="l02218"></a>02218   <span class="keywordflow">for</span> (i=0;i&lt;m;i++)
<a name="l02219"></a>02219     nn *= 2;
<a name="l02220"></a>02220 
<a name="l02221"></a>02221   <span class="comment">// Do the bit reversal</span>
<a name="l02222"></a>02222   i2 = nn &gt;&gt; 1;
<a name="l02223"></a>02223   j = 0;
<a name="l02224"></a>02224   <span class="keywordflow">for</span> (i=0;i&lt;nn-1;i++) {
<a name="l02225"></a>02225     <span class="keywordflow">if</span> (i &lt; j) {
<a name="l02226"></a>02226       tx = x[i];
<a name="l02227"></a>02227       ty = y[i];
<a name="l02228"></a>02228       x[i] = x[j];
<a name="l02229"></a>02229       y[i] = y[j];
<a name="l02230"></a>02230       x[j] = tx;
<a name="l02231"></a>02231       y[j] = ty;
<a name="l02232"></a>02232     }
<a name="l02233"></a>02233     k = i2;
<a name="l02234"></a>02234     <span class="keywordflow">while</span> (k &lt;= j) {
<a name="l02235"></a>02235       j -= k;
<a name="l02236"></a>02236       k &gt;&gt;= 1;
<a name="l02237"></a>02237     }
<a name="l02238"></a>02238     j += k;
<a name="l02239"></a>02239   }
<a name="l02240"></a>02240 
<a name="l02241"></a>02241   <span class="comment">// Compute the FFT</span>
<a name="l02242"></a>02242   c1 = -1.0;
<a name="l02243"></a>02243   c2 = 0.0;
<a name="l02244"></a>02244   l2 = 1;
<a name="l02245"></a>02245   <span class="keywordflow">for</span> (l=0;l&lt;m;l++) {
<a name="l02246"></a>02246     l1 = l2;
<a name="l02247"></a>02247     l2 &lt;&lt;= 1;
<a name="l02248"></a>02248     u1 = 1.0;
<a name="l02249"></a>02249     u2 = 0.0;
<a name="l02250"></a>02250     <span class="keywordflow">for</span> (j=0;j&lt;l1;j++) {
<a name="l02251"></a>02251       <span class="keywordflow">for</span> (i=j;i&lt;nn;i+=l2) {
<a name="l02252"></a>02252         i1 = i + l1;
<a name="l02253"></a>02253         t1 = u1 * x[i1] - u2 * y[i1];
<a name="l02254"></a>02254         t2 = u1 * y[i1] + u2 * x[i1];
<a name="l02255"></a>02255         x[i1] = x[i] - t1;
<a name="l02256"></a>02256         y[i1] = y[i] - t2;
<a name="l02257"></a>02257         x[i] += t1;
<a name="l02258"></a>02258         y[i] += t2;
<a name="l02259"></a>02259       }
<a name="l02260"></a>02260       z =  u1 * c1 - u2 * c2;
<a name="l02261"></a>02261       u2 = u1 * c2 + u2 * c1;
<a name="l02262"></a>02262       u1 = z;
<a name="l02263"></a>02263     }
<a name="l02264"></a>02264     c2 = vcl_sqrt((1.0 - c1) / 2.0);
<a name="l02265"></a>02265     <span class="keywordflow">if</span> (dir == 1)
<a name="l02266"></a>02266       c2 = -c2;
<a name="l02267"></a>02267     c1 = vcl_sqrt((1.0 + c1) / 2.0);
<a name="l02268"></a>02268   }
<a name="l02269"></a>02269 
<a name="l02270"></a>02270   <span class="comment">// Scaling for forward transform</span>
<a name="l02271"></a>02271   <span class="keywordflow">if</span> (dir == 1) {
<a name="l02272"></a>02272     <span class="keywordflow">for</span> (i=0;i&lt;nn;i++) {
<a name="l02273"></a>02273       x[i] /= (double)nn;
<a name="l02274"></a>02274       y[i] /= (double)nn;
<a name="l02275"></a>02275     }
<a name="l02276"></a>02276   }
<a name="l02277"></a>02277 
<a name="l02278"></a>02278   <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l02279"></a>02279 }
<a name="l02280"></a>02280 
<a name="l02281"></a>02281 <span class="comment">//-------------------------------------------------------------------------</span>
<a name="l02282"></a>02282 <span class="comment">//: Perform a 2D FFT inplace given a complex 2D array</span>
<a name="l02283"></a>02283 <span class="comment">//  The direction dir, 1 for forward, -1 for reverse</span>
<a name="l02284"></a>02284 <span class="comment">//  The size of the array (nx,ny)</span>
<a name="l02285"></a>02285 <span class="comment">//  Return false if there are memory problems or</span>
<a name="l02286"></a>02286 <span class="comment">//  the dimensions are not powers of 2</span>
<a name="l02287"></a><a class="code" href="classbrip__vil__float__ops.html#ace0ed20f9f9b1d6164d9684f8f9842ea">02287</a> <span class="comment">//</span>
<a name="l02288"></a>02288 <span class="keywordtype">bool</span> <a class="code" href="classbrip__vil__float__ops.html#ace0ed20f9f9b1d6164d9684f8f9842ea" title="Two-dimensional fft.">brip_vil_float_ops::fft_2d</a>(<a class="codeRef" doxygen="core_vnl.tag:../../../../../core/vnl/html" href="../../../../../core/vnl/html/classvnl__matrix.html">vnl_matrix</a>&lt;vcl_complex&lt;double&gt; &gt;&amp; c,<span class="keywordtype">int</span> nx,<span class="keywordtype">int</span> ny,<span class="keywordtype">int</span> dir)
<a name="l02289"></a>02289 {
<a name="l02290"></a>02290   <span class="keywordtype">int</span> i,j;
<a name="l02291"></a>02291   <span class="keywordtype">int</span> mx, my;
<a name="l02292"></a>02292   <span class="keywordtype">double</span> *real,*imag;
<a name="l02293"></a>02293   <a class="codeRef" doxygen="core_vnl.tag:../../../../../core/vnl/html" href="../../../../../core/vnl/html/structvnl__fft__prime__factors.html">vnl_fft_prime_factors&lt;double&gt;</a> pfx (nx);
<a name="l02294"></a>02294   <a class="codeRef" doxygen="core_vnl.tag:../../../../../core/vnl/html" href="../../../../../core/vnl/html/structvnl__fft__prime__factors.html">vnl_fft_prime_factors&lt;double&gt;</a> pfy (ny);
<a name="l02295"></a>02295   mx = (int)pfx.<a class="codeRef" doxygen="core_vnl.tag:../../../../../core/vnl/html" href="../../../../../core/vnl/html/structvnl__fft__prime__factors.html#a42171f28a2bc49207339986a5c514230">pqr</a>()[0];
<a name="l02296"></a>02296   my = (int)pfy.<a class="codeRef" doxygen="core_vnl.tag:../../../../../core/vnl/html" href="../../../../../core/vnl/html/structvnl__fft__prime__factors.html#a42171f28a2bc49207339986a5c514230">pqr</a>()[0];
<a name="l02297"></a>02297   <span class="comment">// Transform the rows</span>
<a name="l02298"></a>02298   real = <span class="keyword">new</span> <span class="keywordtype">double</span>[nx];
<a name="l02299"></a>02299   imag = <span class="keyword">new</span> <span class="keywordtype">double</span>[nx];
<a name="l02300"></a>02300   <span class="keywordflow">if</span> (real == 0 || imag == 0)
<a name="l02301"></a>02301     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02302"></a>02302   <span class="keywordflow">for</span> (j=0;j&lt;ny;j++) {
<a name="l02303"></a>02303     <span class="keywordflow">for</span> (i=0;i&lt;nx;i++) {
<a name="l02304"></a>02304       real[i] = c[j][i].real();
<a name="l02305"></a>02305       imag[i] = c[j][i].imag();
<a name="l02306"></a>02306     }
<a name="l02307"></a>02307     <a class="code" href="classbrip__vil__float__ops.html#af5bc1527e59afc42c7cfb291adef8251" title="One-dimensional fft.">brip_vil_float_ops::fft_1d</a>(dir,mx,real,imag);
<a name="l02308"></a>02308     <span class="keywordflow">for</span> (i=0;i&lt;nx;i++) {
<a name="l02309"></a>02309       vcl_complex&lt;double&gt; <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/vgl__vector__2d_8h.html#a38bf1e5e0427bdeba2b469eea9befc23">v</a>(real[i], imag[i]);
<a name="l02310"></a>02310       c[j][i] = v;
<a name="l02311"></a>02311     }
<a name="l02312"></a>02312   }
<a name="l02313"></a>02313   <span class="keyword">delete</span> [] real;
<a name="l02314"></a>02314   <span class="keyword">delete</span> [] imag;
<a name="l02315"></a>02315   <span class="comment">// Transform the columns</span>
<a name="l02316"></a>02316   real = <span class="keyword">new</span> <span class="keywordtype">double</span>[ny];
<a name="l02317"></a>02317   imag = <span class="keyword">new</span> <span class="keywordtype">double</span>[ny];
<a name="l02318"></a>02318   <span class="keywordflow">if</span> (real == 0 || imag == 0)
<a name="l02319"></a>02319     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02320"></a>02320   <span class="keywordflow">for</span> (i=0;i&lt;nx;i++) {
<a name="l02321"></a>02321     <span class="keywordflow">for</span> (j=0;j&lt;ny;j++) {
<a name="l02322"></a>02322       real[j] = c[j][i].real();
<a name="l02323"></a>02323       imag[j] = c[j][i].imag();
<a name="l02324"></a>02324     }
<a name="l02325"></a>02325     <a class="code" href="classbrip__vil__float__ops.html#af5bc1527e59afc42c7cfb291adef8251" title="One-dimensional fft.">fft_1d</a>(dir,my,real,imag);
<a name="l02326"></a>02326     <span class="keywordflow">for</span> (j=0;j&lt;ny;j++) {
<a name="l02327"></a>02327       vcl_complex&lt;double&gt; <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/vgl__vector__2d_8h.html#a38bf1e5e0427bdeba2b469eea9befc23">v</a>(real[j], imag[j]);
<a name="l02328"></a>02328       c[j][i] =  v;
<a name="l02329"></a>02329     }
<a name="l02330"></a>02330   }
<a name="l02331"></a>02331   <span class="keyword">delete</span> [] real;
<a name="l02332"></a>02332   <span class="keyword">delete</span> [] imag;
<a name="l02333"></a>02333   <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l02334"></a>02334 }
<a name="l02335"></a>02335 
<a name="l02336"></a>02336 <span class="comment">//: reorder the transform values to sequential frequencies as in conventional Fourier transforms.</span>
<a name="l02337"></a>02337 <span class="comment">//  The transformation is its self-inverse.</span>
<a name="l02338"></a><a class="code" href="classbrip__vil__float__ops.html#a9ce32025420af91658dcaf32141044c7">02338</a> <span class="keywordtype">void</span> <a class="code" href="classbrip__vil__float__ops.html#a9ce32025420af91658dcaf32141044c7" title="Transform the fft coefficients from/to fft/frequency order(self inverse).">brip_vil_float_ops::</a>
<a name="l02339"></a>02339 <a class="code" href="classbrip__vil__float__ops.html#a9ce32025420af91658dcaf32141044c7" title="Transform the fft coefficients from/to fft/frequency order(self inverse).">ftt_fourier_2d_reorder</a>(<a class="codeRef" doxygen="core_vnl.tag:../../../../../core/vnl/html" href="../../../../../core/vnl/html/classvnl__matrix.html">vnl_matrix</a>&lt;vcl_complex&lt;double&gt; &gt; <span class="keyword">const</span>&amp; F1,
<a name="l02340"></a>02340                        <a class="codeRef" doxygen="core_vnl.tag:../../../../../core/vnl/html" href="../../../../../core/vnl/html/classvnl__matrix.html">vnl_matrix</a>&lt;vcl_complex&lt;double&gt; &gt; &amp; F2)
<a name="l02341"></a>02341 {
<a name="l02342"></a>02342   <span class="keywordtype">int</span> rows = <span class="keyword">static_cast&lt;</span><span class="keywordtype">int</span><span class="keyword">&gt;</span>(F1.rows()), cols = static_cast&lt;int&gt;(F1.cols());
<a name="l02343"></a>02343   <span class="keywordtype">int</span> half_rows = rows/2, half_cols = cols/2;
<a name="l02344"></a>02344   <span class="keywordtype">int</span> ri, ci;
<a name="l02345"></a>02345   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> r = 0; r&lt;rows; r++)
<a name="l02346"></a>02346   {
<a name="l02347"></a>02347     <span class="keywordflow">if</span> (r&lt;half_rows)
<a name="l02348"></a>02348       ri = half_rows+r;
<a name="l02349"></a>02349     <span class="keywordflow">else</span>
<a name="l02350"></a>02350       ri = r-half_rows;
<a name="l02351"></a>02351     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> c = 0; c&lt;cols; c++)
<a name="l02352"></a>02352     {
<a name="l02353"></a>02353       <span class="keywordflow">if</span> (c&lt;half_cols)
<a name="l02354"></a>02354         ci = half_cols+c;
<a name="l02355"></a>02355       <span class="keywordflow">else</span>
<a name="l02356"></a>02356         ci = c-half_cols;
<a name="l02357"></a>02357       F2[ri][ci]=F1[r][c];
<a name="l02358"></a>02358     }
<a name="l02359"></a>02359   }
<a name="l02360"></a>02360 }
<a name="l02361"></a>02361 
<a name="l02362"></a>02362 <span class="comment">//: Compute the fourier transform.</span>
<a name="l02363"></a>02363 <span class="comment">//  If the image dimensions are not a power of 2 then the operation fails.</span>
<a name="l02364"></a><a class="code" href="classbrip__vil__float__ops.html#a797cada492649d11a57d654ab65035e2">02364</a> <span class="keywordtype">bool</span> <a class="code" href="classbrip__vil__float__ops.html#a797cada492649d11a57d654ab65035e2" title="compute the Fourier transform using the vnl FFT algorithm.">brip_vil_float_ops::</a>
<a name="l02365"></a>02365 <a class="code" href="classbrip__vil__float__ops.html#a797cada492649d11a57d654ab65035e2" title="compute the Fourier transform using the vnl FFT algorithm.">fourier_transform</a>(<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> <span class="keyword">const</span>&amp; input,
<a name="l02366"></a>02366                   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a>&amp; mag,
<a name="l02367"></a>02367                   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a>&amp; phase)
<a name="l02368"></a>02368 {
<a name="l02369"></a>02369   <span class="keywordtype">unsigned</span> w = input.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a9ea9ad565387a61dccf38fc80a266c2a">ni</a>(), h = input.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a44859c72206da7d18728cb2bbf8ae829">nj</a>();
<a name="l02370"></a>02370 
<a name="l02371"></a>02371   <a class="codeRef" doxygen="core_vnl.tag:../../../../../core/vnl/html" href="../../../../../core/vnl/html/structvnl__fft__prime__factors.html">vnl_fft_prime_factors&lt;float&gt;</a> pfx (w);
<a name="l02372"></a>02372   <a class="codeRef" doxygen="core_vnl.tag:../../../../../core/vnl/html" href="../../../../../core/vnl/html/structvnl__fft__prime__factors.html">vnl_fft_prime_factors&lt;float&gt;</a> pfy (h);
<a name="l02373"></a>02373   <span class="keywordflow">if</span> (!pfx.<a class="codeRef" doxygen="core_vnl.tag:../../../../../core/vnl/html" href="../../../../../core/vnl/html/structvnl__fft__prime__factors.html#a42171f28a2bc49207339986a5c514230">pqr</a>()[0]||!pfy.<a class="codeRef" doxygen="core_vnl.tag:../../../../../core/vnl/html" href="../../../../../core/vnl/html/structvnl__fft__prime__factors.html#a42171f28a2bc49207339986a5c514230">pqr</a>()[0])
<a name="l02374"></a>02374     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02375"></a>02375   <span class="comment">// fill the fft matrix</span>
<a name="l02376"></a>02376   <a class="codeRef" doxygen="core_vnl.tag:../../../../../core/vnl/html" href="../../../../../core/vnl/html/classvnl__matrix.html">vnl_matrix&lt;vcl_complex&lt;double&gt;</a> &gt; fft_matrix(h, w), fourier_matrix(h,w);
<a name="l02377"></a>02377   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> y = 0; y&lt;h; y++)
<a name="l02378"></a>02378     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> x =0; x&lt;w; x++)
<a name="l02379"></a>02379     {
<a name="l02380"></a>02380       vcl_complex&lt;double&gt; cv(input(x,y), 0.0);
<a name="l02381"></a>02381       fft_matrix.put(y, x, cv);
<a name="l02382"></a>02382     }
<a name="l02383"></a>02383 <span class="preprocessor">#ifdef DEBUG</span>
<a name="l02384"></a>02384 <span class="preprocessor"></span>  <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> r = 0; r&lt;h; r++)
<a name="l02385"></a>02385     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> c =0; c&lt;w; c++)
<a name="l02386"></a>02386     {
<a name="l02387"></a>02387       vcl_complex&lt;double&gt; res = fft_matrix[r][c];
<a name="l02388"></a>02388       vcl_cout &lt;&lt; res &lt;&lt; <span class="charliteral">&#39;\n&#39;</span>;
<a name="l02389"></a>02389     }
<a name="l02390"></a>02390 <span class="preprocessor">#endif</span>
<a name="l02391"></a>02391 <span class="preprocessor"></span>
<a name="l02392"></a>02392   <a class="code" href="classbrip__vil__float__ops.html#ace0ed20f9f9b1d6164d9684f8f9842ea" title="Two-dimensional fft.">brip_vil_float_ops::fft_2d</a>(fft_matrix, w, h, 1);
<a name="l02393"></a>02393   <a class="code" href="classbrip__vil__float__ops.html#a9ce32025420af91658dcaf32141044c7" title="Transform the fft coefficients from/to fft/frequency order(self inverse).">brip_vil_float_ops::ftt_fourier_2d_reorder</a>(fft_matrix, fourier_matrix);
<a name="l02394"></a>02394   mag.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html#a9c01939f01ef50314620e26aaacb04d3">set_size</a>(w,h);
<a name="l02395"></a>02395   phase.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html#a9c01939f01ef50314620e26aaacb04d3">set_size</a>(w,h);
<a name="l02396"></a>02396 
<a name="l02397"></a>02397   <span class="comment">// extract magnitude and phase</span>
<a name="l02398"></a>02398   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> r = 0; r&lt;h; r++)
<a name="l02399"></a>02399     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> c = 0; c&lt;w; c++)
<a name="l02400"></a>02400     {
<a name="l02401"></a>02401       <span class="keywordtype">float</span> re = (float)fourier_matrix[r][c].real(),
<a name="l02402"></a>02402         im = (float)fourier_matrix[r][c].imag();
<a name="l02403"></a>02403       mag(c,r) = vcl_sqrt(re*re + im*im);
<a name="l02404"></a>02404       phase(c,r) = vcl_atan2(im, re);
<a name="l02405"></a>02405     }
<a name="l02406"></a>02406   <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l02407"></a>02407 }
<a name="l02408"></a>02408 
<a name="l02409"></a><a class="code" href="classbrip__vil__float__ops.html#a99d5898ecc257ddbc3ea04e14b7d42a6">02409</a> <span class="keywordtype">bool</span> <a class="code" href="classbrip__vil__float__ops.html#a99d5898ecc257ddbc3ea04e14b7d42a6" title="compute the inverse Fourier transform using the vnl FFT algorithm.">brip_vil_float_ops::</a>
<a name="l02410"></a>02410 <a class="code" href="classbrip__vil__float__ops.html#a99d5898ecc257ddbc3ea04e14b7d42a6" title="compute the inverse Fourier transform using the vnl FFT algorithm.">inverse_fourier_transform</a>(<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> <span class="keyword">const</span>&amp; mag,
<a name="l02411"></a>02411                           <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> <span class="keyword">const</span>&amp; phase,
<a name="l02412"></a>02412                           <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a>&amp; output)
<a name="l02413"></a>02413 {
<a name="l02414"></a>02414   <span class="keywordtype">unsigned</span> w = mag.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a9ea9ad565387a61dccf38fc80a266c2a">ni</a>(), h = mag.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a44859c72206da7d18728cb2bbf8ae829">nj</a>();
<a name="l02415"></a>02415   <a class="codeRef" doxygen="core_vnl.tag:../../../../../core/vnl/html" href="../../../../../core/vnl/html/classvnl__matrix.html">vnl_matrix&lt;vcl_complex&lt;double&gt;</a> &gt; fft_matrix(h, w), fourier_matrix(h, w);
<a name="l02416"></a>02416   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> y = 0; y&lt;h; y++)
<a name="l02417"></a>02417     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> x =0; x&lt;w; x++)
<a name="l02418"></a>02418     {
<a name="l02419"></a>02419       <span class="keywordtype">float</span> <a class="codeRef" doxygen="core_vnl.tag:../../../../../core/vnl/html" href="../../../../../core/vnl/html/vnl__vector_8h.html#a00626facb4f86efb8618a4c5f5c3c5f8">m</a> = mag(x,y);
<a name="l02420"></a>02420       <span class="keywordtype">float</span> p = phase(x,y);
<a name="l02421"></a>02421       vcl_complex&lt;double&gt; cv(m*vcl_cos(p), m*vcl_sin(p));
<a name="l02422"></a>02422       fourier_matrix.<a class="codeRef" doxygen="core_vnl.tag:../../../../../core/vnl/html" href="../../../../../core/vnl/html/classvnl__matrix.html#a45a132d7cafb7f0ceb414efd48802fb0">put</a>(y, x, cv);
<a name="l02423"></a>02423     }
<a name="l02424"></a>02424 
<a name="l02425"></a>02425   <a class="code" href="classbrip__vil__float__ops.html#a9ce32025420af91658dcaf32141044c7" title="Transform the fft coefficients from/to fft/frequency order(self inverse).">brip_vil_float_ops::ftt_fourier_2d_reorder</a>(fourier_matrix, fft_matrix);
<a name="l02426"></a>02426   <a class="code" href="classbrip__vil__float__ops.html#ace0ed20f9f9b1d6164d9684f8f9842ea" title="Two-dimensional fft.">brip_vil_float_ops::fft_2d</a>(fft_matrix, w, h, -1);
<a name="l02427"></a>02427 
<a name="l02428"></a>02428   output.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html#a9c01939f01ef50314620e26aaacb04d3">set_size</a>(w,h);
<a name="l02429"></a>02429 
<a name="l02430"></a>02430   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> y = 0; y&lt;h; y++)
<a name="l02431"></a>02431     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> x = 0; x&lt;w; x++)
<a name="l02432"></a>02432       output(x,y) = (float)fft_matrix[y][x].real();
<a name="l02433"></a>02433   <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l02434"></a>02434 }
<a name="l02435"></a><a class="code" href="classbrip__vil__float__ops.html#adb0a859d85e7878fed415789818b757d">02435</a> 
<a name="l02436"></a>02436 <span class="keywordtype">void</span> <a class="code" href="classbrip__vil__float__ops.html#adb0a859d85e7878fed415789818b757d" title="resize to specified dimensions.">brip_vil_float_ops::resize</a>(<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> <span class="keyword">const</span>&amp; input,
<a name="l02437"></a>02437                                 <span class="keywordtype">unsigned</span> width, <span class="keywordtype">unsigned</span> height,
<a name="l02438"></a>02438                                 <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a>&amp; output)
<a name="l02439"></a>02439 {
<a name="l02440"></a>02440   <span class="keywordtype">unsigned</span> w = input.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a9ea9ad565387a61dccf38fc80a266c2a">ni</a>(), h = input.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a44859c72206da7d18728cb2bbf8ae829">nj</a>();
<a name="l02441"></a>02441   output.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html#a9c01939f01ef50314620e26aaacb04d3">set_size</a>(width, height);
<a name="l02442"></a>02442   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> y = 0; y&lt;height; y++)
<a name="l02443"></a>02443     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> x = 0; x&lt;width; x++)
<a name="l02444"></a>02444       <span class="keywordflow">if</span> (x&lt;w &amp;&amp; y&lt;h)
<a name="l02445"></a>02445         output(x,y) = input(x,y);
<a name="l02446"></a>02446       <span class="keywordflow">else</span>
<a name="l02447"></a>02447         output(x,y) = 0; <span class="comment">// pad with zeroes</span>
<a name="l02448"></a>02448 }
<a name="l02449"></a>02449 
<a name="l02450"></a>02450 <span class="comment">//: resize the input to the closest power of two image dimensions</span>
<a name="l02451"></a><a class="code" href="classbrip__vil__float__ops.html#aaf8b0286c52a8fa35261fb61550e355e">02451</a> <span class="keywordtype">bool</span> <a class="code" href="classbrip__vil__float__ops.html#aaf8b0286c52a8fa35261fb61550e355e" title="resize to closest power of two larger dimensions than the input.">brip_vil_float_ops::</a>
<a name="l02452"></a>02452 <a class="code" href="classbrip__vil__float__ops.html#aaf8b0286c52a8fa35261fb61550e355e" title="resize to closest power of two larger dimensions than the input.">resize_to_power_of_two</a>(<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> <span class="keyword">const</span>&amp; input,
<a name="l02453"></a>02453                        <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a>&amp; output)
<a name="l02454"></a>02454 {
<a name="l02455"></a>02455   <span class="keywordtype">unsigned</span> max_exp = 13; <span class="comment">// we wouldn&#39;t want to have such large images in memory</span>
<a name="l02456"></a>02456   <span class="keywordtype">unsigned</span> w = input.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a9ea9ad565387a61dccf38fc80a266c2a">ni</a>(), h = input.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a44859c72206da7d18728cb2bbf8ae829">nj</a>();
<a name="l02457"></a>02457   <span class="keywordtype">unsigned</span> prodw = 1, prodh = 1;
<a name="l02458"></a>02458   <span class="comment">// Find power of two width</span>
<a name="l02459"></a>02459   <span class="keywordtype">unsigned</span> nw, nh;
<a name="l02460"></a>02460   <span class="keywordflow">for</span> (nw = 1; nw&lt;=max_exp; nw++)
<a name="l02461"></a>02461     <span class="keywordflow">if</span> (prodw&gt;w)
<a name="l02462"></a>02462       <span class="keywordflow">break</span>;
<a name="l02463"></a>02463     <span class="keywordflow">else</span>
<a name="l02464"></a>02464       prodw *= 2;
<a name="l02465"></a>02465   <span class="keywordflow">if</span> (nw==max_exp)
<a name="l02466"></a>02466     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02467"></a>02467   <span class="comment">// Find power of two height</span>
<a name="l02468"></a>02468   <span class="keywordflow">for</span> (nh = 1; nh&lt;=max_exp; nh++)
<a name="l02469"></a>02469     <span class="keywordflow">if</span> (prodh&gt;h)
<a name="l02470"></a>02470       <span class="keywordflow">break</span>;
<a name="l02471"></a>02471     <span class="keywordflow">else</span>
<a name="l02472"></a>02472       prodh *= 2;
<a name="l02473"></a>02473   <span class="keywordflow">if</span> (nh==max_exp)
<a name="l02474"></a>02474     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02475"></a>02475   <a class="code" href="classbrip__vil__float__ops.html#adb0a859d85e7878fed415789818b757d" title="resize to specified dimensions.">brip_vil_float_ops::resize</a>(input, prodw, prodh, output);
<a name="l02476"></a>02476 
<a name="l02477"></a>02477   <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l02478"></a>02478 }
<a name="l02479"></a>02479 
<a name="l02480"></a>02480 <span class="comment">//</span>
<a name="l02481"></a>02481 <span class="comment">//: block a periodic signal by suppressing two Gaussian lobes in the frequency domain.</span>
<a name="l02482"></a>02482 <span class="comment">//  The lobes are on the line defined by dir_fx and dir_fy through the</span>
<a name="l02483"></a>02483 <span class="comment">//  dc origin, assumed (0, 0).  The center frequency, f0, is the distance along</span>
<a name="l02484"></a>02484 <span class="comment">//  the line to the center of each blocking lobe (+- f0). radius is the</span>
<a name="l02485"></a>02485 <span class="comment">//  standard deviation of each lobe. Later we can define a &quot;filter&quot; class.</span>
<a name="l02486"></a><a class="code" href="classbrip__vil__float__ops.html#ab73e2d6c5c0a840db9cb5014fd61363d">02486</a> <span class="comment">//</span>
<a name="l02487"></a>02487 <span class="keywordtype">float</span> <a class="code" href="classbrip__vil__float__ops.html#ab73e2d6c5c0a840db9cb5014fd61363d" title="Blocking filter function.">brip_vil_float_ops::gaussian_blocking_filter</a>(<span class="keywordtype">float</span> dir_fx,
<a name="l02488"></a>02488                                                    <span class="keywordtype">float</span> dir_fy,
<a name="l02489"></a>02489                                                    <span class="keywordtype">float</span> f0,
<a name="l02490"></a>02490                                                    <span class="keywordtype">float</span> radius,
<a name="l02491"></a>02491                                                    <span class="keywordtype">float</span> fx,
<a name="l02492"></a>02492                                                    <span class="keywordtype">float</span> fy)
<a name="l02493"></a>02493 {
<a name="l02494"></a>02494   <span class="comment">// normalize dir_fx and dir_fy</span>
<a name="l02495"></a>02495   <span class="keywordtype">float</span> mag = vcl_sqrt(dir_fx*dir_fx + dir_fy*dir_fy);
<a name="l02496"></a>02496   <span class="keywordflow">if</span> (!mag)
<a name="l02497"></a>02497     <span class="keywordflow">return</span> 0.f;
<a name="l02498"></a>02498   <span class="keywordtype">float</span> r2 = 2.f*radius*radius;
<a name="l02499"></a>02499   <span class="keywordtype">float</span> dx = dir_fx/mag, dy = dir_fy/mag;
<a name="l02500"></a>02500   <span class="comment">// compute the centers of each lobe</span>
<a name="l02501"></a>02501   <span class="keywordtype">float</span> fx0p = dx*f0, fy0p = dy*f0;
<a name="l02502"></a>02502   <span class="keywordtype">float</span> fx0m = -dx*f0, fy0m = -dy*f0;
<a name="l02503"></a>02503   <span class="comment">// the squared distance of fx, fy from each center</span>
<a name="l02504"></a>02504   <span class="keywordtype">float</span> d2p = (fx-fx0p)*(fx-fx0p) + (fy-fy0p)*(fy-fy0p);
<a name="l02505"></a>02505   <span class="keywordtype">float</span> d2m = (fx-fx0m)*(fx-fx0m) + (fy-fy0m)*(fy-fy0m);
<a name="l02506"></a>02506   <span class="comment">// use the closest lobe</span>
<a name="l02507"></a>02507   <span class="keywordtype">float</span> d = d2p;
<a name="l02508"></a>02508   <span class="keywordflow">if</span> (d2m&lt;d2p)
<a name="l02509"></a>02509     d = d2m;
<a name="l02510"></a>02510   <span class="comment">// the gaussian blocking function</span>
<a name="l02511"></a>02511   <span class="keywordtype">float</span> gb = 1.f-(float)vcl_exp(-d/r2);
<a name="l02512"></a>02512   <span class="keywordflow">return</span> gb;
<a name="l02513"></a>02513 }
<a name="l02514"></a>02514 
<a name="l02515"></a><a class="code" href="classbrip__vil__float__ops.html#afb630c58f3c2264c39df52721e60874c">02515</a> <span class="keywordtype">bool</span> <a class="code" href="classbrip__vil__float__ops.html#afb630c58f3c2264c39df52721e60874c" title="filter the input image with a Gaussian blocking filter.">brip_vil_float_ops::</a>
<a name="l02516"></a>02516 <a class="code" href="classbrip__vil__float__ops.html#afb630c58f3c2264c39df52721e60874c" title="filter the input image with a Gaussian blocking filter.">spatial_frequency_filter</a>(<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> <span class="keyword">const</span>&amp; input,
<a name="l02517"></a>02517                          <span class="keywordtype">float</span> dir_fx, <span class="keywordtype">float</span> dir_fy,
<a name="l02518"></a>02518                          <span class="keywordtype">float</span> f0, <span class="keywordtype">float</span> radius,
<a name="l02519"></a>02519                          <span class="keywordtype">bool</span> output_fourier_mag,
<a name="l02520"></a>02520                          <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a>&amp; output)
<a name="l02521"></a>02521 {
<a name="l02522"></a>02522   <span class="comment">// Compute the fourier transform of the image.</span>
<a name="l02523"></a>02523   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> pow_two, mag, bmag, phase, pow_two_filt;
<a name="l02524"></a>02524   <a class="code" href="classbrip__vil__float__ops.html#aaf8b0286c52a8fa35261fb61550e355e" title="resize to closest power of two larger dimensions than the input.">brip_vil_float_ops::resize_to_power_of_two</a>(input, pow_two);
<a name="l02525"></a>02525   <span class="keywordtype">unsigned</span> Nfx = pow_two.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a9ea9ad565387a61dccf38fc80a266c2a">ni</a>(), Nfy = pow_two.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a44859c72206da7d18728cb2bbf8ae829">nj</a>();
<a name="l02526"></a>02526 
<a name="l02527"></a>02527   <span class="keywordflow">if</span> (!<a class="code" href="classbrip__vil__float__ops.html#a797cada492649d11a57d654ab65035e2" title="compute the Fourier transform using the vnl FFT algorithm.">brip_vil_float_ops::fourier_transform</a>(pow_two, mag, phase))
<a name="l02528"></a>02528     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02529"></a>02529   bmag.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html#a9c01939f01ef50314620e26aaacb04d3">set_size</a>(Nfx, Nfy);
<a name="l02530"></a>02530 
<a name="l02531"></a>02531   <span class="comment">// filter the magnitude function</span>
<a name="l02532"></a>02532   <span class="keywordtype">float</span> Ofx = Nfx*0.5f, Ofy = Nfy*0.5f;
<a name="l02533"></a>02533   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> fy =0; fy&lt;Nfy; fy++)
<a name="l02534"></a>02534     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> fx =0; fx&lt;Nfx; fx++)
<a name="l02535"></a>02535     {
<a name="l02536"></a>02536       <span class="keywordtype">float</span> gb = <a class="code" href="classbrip__vil__float__ops.html#ab73e2d6c5c0a840db9cb5014fd61363d" title="Blocking filter function.">gaussian_blocking_filter</a>(dir_fx, dir_fy, f0,
<a name="l02537"></a>02537                                           radius,
<a name="l02538"></a>02538                                           (<span class="keywordtype">float</span>)fx-Ofx, (<span class="keywordtype">float</span>)fy-Ofy);
<a name="l02539"></a>02539       bmag(fx,fy) = mag(fx,fy)*gb;
<a name="l02540"></a>02540     }
<a name="l02541"></a>02541   <span class="keywordflow">if</span> (output_fourier_mag)
<a name="l02542"></a>02542   {
<a name="l02543"></a>02543     output = bmag;
<a name="l02544"></a>02544     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l02545"></a>02545   }
<a name="l02546"></a>02546   <span class="comment">// Transform back</span>
<a name="l02547"></a>02547   pow_two_filt.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html#a9c01939f01ef50314620e26aaacb04d3">set_size</a>(Nfx, Nfy);
<a name="l02548"></a>02548   <a class="code" href="classbrip__vil__float__ops.html#a99d5898ecc257ddbc3ea04e14b7d42a6" title="compute the inverse Fourier transform using the vnl FFT algorithm.">brip_vil_float_ops::inverse_fourier_transform</a>(bmag, phase, pow_two_filt);
<a name="l02549"></a>02549 
<a name="l02550"></a>02550   <span class="comment">// Resize to original input size</span>
<a name="l02551"></a>02551   <a class="code" href="classbrip__vil__float__ops.html#adb0a859d85e7878fed415789818b757d" title="resize to specified dimensions.">brip_vil_float_ops::resize</a>(pow_two_filt, input.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a9ea9ad565387a61dccf38fc80a266c2a">ni</a>(), input.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a44859c72206da7d18728cb2bbf8ae829">nj</a>(), output);
<a name="l02552"></a>02552   <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l02553"></a>02553 }
<a name="l02554"></a>02554 
<a name="l02555"></a>02555 <span class="comment">//----------------------------------------------------------------------</span>
<a name="l02556"></a>02556 <span class="comment">//: Bi-linear interpolation on the neighborhood below.</span>
<a name="l02557"></a>02557 <span class="comment">// \verbatim</span>
<a name="l02558"></a>02558 <span class="comment">//      xr</span>
<a name="l02559"></a>02559 <span class="comment">//   yr 0  x</span>
<a name="l02560"></a>02560 <span class="comment">//      x  x</span>
<a name="l02561"></a>02561 <span class="comment">// \endverbatim</span>
<a name="l02562"></a>02562 <span class="comment">//</span>
<a name="l02563"></a><a class="code" href="classbrip__vil__float__ops.html#ac56dfd015fb01a56d315d5ae109e30fc">02563</a> <span class="keywordtype">double</span> <a class="code" href="classbrip__vil__float__ops.html#ac56dfd015fb01a56d315d5ae109e30fc" title="2x2 bilinear interpolation of image at specified location.">brip_vil_float_ops::</a>
<a name="l02564"></a>02564 <a class="code" href="classbrip__vil__float__ops.html#ac56dfd015fb01a56d315d5ae109e30fc" title="2x2 bilinear interpolation of image at specified location.">bilinear_interpolation</a>(<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> <span class="keyword">const</span>&amp; input, <span class="keywordtype">double</span> x, <span class="keywordtype">double</span> y)
<a name="l02565"></a>02565 {
<a name="l02566"></a>02566   <span class="comment">// check bounds</span>
<a name="l02567"></a>02567   <span class="keywordtype">int</span> w = <span class="keyword">static_cast&lt;</span><span class="keywordtype">int</span><span class="keyword">&gt;</span>(input.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a9ea9ad565387a61dccf38fc80a266c2a">ni</a>()), h = static_cast&lt;int&gt;(input.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a44859c72206da7d18728cb2bbf8ae829">nj</a>());
<a name="l02568"></a>02568   <span class="comment">// the pixel containing the interpolated point</span>
<a name="l02569"></a>02569   <span class="keywordtype">int</span> xr = (int)x, yr = (<span class="keywordtype">int</span>)y;
<a name="l02570"></a>02570   <span class="keywordtype">double</span> fx = x-xr, fy = y-yr;
<a name="l02571"></a>02571   <span class="keywordflow">if</span> (xr&lt;0||xr&gt;w-2)
<a name="l02572"></a>02572     <span class="keywordflow">return</span> 0.0;
<a name="l02573"></a>02573   <span class="keywordflow">if</span> (yr&lt;0||yr&gt;h-2)
<a name="l02574"></a>02574     <span class="keywordflow">return</span> 0.0;
<a name="l02575"></a>02575   <span class="keywordtype">double</span> int00 = input(xr, yr), int10 = input(xr+1,yr);
<a name="l02576"></a>02576   <span class="keywordtype">double</span> int01 = input(xr, yr+1), int11 = input(xr+1,yr+1);
<a name="l02577"></a>02577   <span class="keywordtype">double</span> int0 = int00 + fy * (int01 - int00);
<a name="l02578"></a>02578   <span class="keywordtype">double</span> int1 = int10 + fy * (int11 - int10);
<a name="l02579"></a>02579   <span class="keywordtype">float</span> val = (float) (int0 + fx * (int1 - int0));
<a name="l02580"></a>02580   <span class="keywordflow">return</span> val;
<a name="l02581"></a>02581 }
<a name="l02582"></a>02582 
<a name="l02583"></a>02583 <span class="comment">//: Transform the input to the output by a homography.</span>
<a name="l02584"></a>02584 <span class="comment">//  If the output size is fixed then only the corresponding</span>
<a name="l02585"></a><a class="code" href="classbrip__vil__float__ops.html#a083fb590fecf698c5bcaf0c809adf4c7">02585</a> <span class="comment">//  region of input image space is transformed.</span>
<a name="l02586"></a>02586 <span class="keywordtype">bool</span> <a class="code" href="classbrip__vil__float__ops.html#a083fb590fecf698c5bcaf0c809adf4c7" title="map the input to the output by a homography.">brip_vil_float_ops::homography</a>(<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> <span class="keyword">const</span>&amp; input,
<a name="l02587"></a>02587                                     <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__h__matrix__2d.html">vgl_h_matrix_2d&lt;double&gt;</a> <span class="keyword">const</span>&amp; H,
<a name="l02588"></a>02588                                     <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a>&amp; output,
<a name="l02589"></a>02589                                     <span class="keywordtype">bool</span> output_size_fixed,
<a name="l02590"></a>02590                                     <span class="keywordtype">float</span> output_fill_value)
<a name="l02591"></a>02591 {
<a name="l02592"></a>02592   <span class="keywordflow">if</span> (!input)
<a name="l02593"></a>02593     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02594"></a>02594   <span class="comment">// smooth the input to condition interpolation</span>
<a name="l02595"></a>02595   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> gimage =
<a name="l02596"></a>02596     <a class="code" href="classbrip__vil__float__ops.html#a2c82165db7e252f7b843f61f5856dc3f" title="convolves with a Gaussian kernel.">brip_vil_float_ops::gaussian</a>(input, 0.5f);
<a name="l02597"></a>02597 
<a name="l02598"></a>02598   <span class="comment">// First, there is some rather complex bookeeping to insure that</span>
<a name="l02599"></a>02599   <span class="comment">// the input and output image rois are consistent with the homography.</span>
<a name="l02600"></a>02600 
<a name="l02601"></a>02601   <span class="comment">// the bounding boxes corresponding to input and output rois</span>
<a name="l02602"></a>02602   <span class="comment">// We also construct polygons since homographies turn boxes into arbitrary</span>
<a name="l02603"></a>02603   <span class="comment">// quadrilaterals.</span>
<a name="l02604"></a>02604   <a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__smart__ptr.html">vsol_box_2d_sptr</a> input_roi, output_roi;
<a name="l02605"></a>02605   <a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__smart__ptr.html">vsol_polygon_2d_sptr</a> input_poly, output_poly;
<a name="l02606"></a>02606   <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__h__matrix__2d.html">vgl_h_matrix_2d&lt;double&gt;</a> Hinv;
<a name="l02607"></a>02607   <span class="comment">// set up the roi and poly for the input image</span>
<a name="l02608"></a>02608   <span class="keywordtype">unsigned</span> win = gimage.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a9ea9ad565387a61dccf38fc80a266c2a">ni</a>(), hin = gimage.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a44859c72206da7d18728cb2bbf8ae829">nj</a>();
<a name="l02609"></a>02609   input_roi = <span class="keyword">new</span> <a class="codeRef" doxygen="contrib_gel_vsol.tag:../../../../../contrib/gel/vsol/html" href="../../../../../contrib/gel/vsol/html/classvsol__box__2d.html">vsol_box_2d</a>();
<a name="l02610"></a>02610   input_roi-&gt;add_point(0, 0);
<a name="l02611"></a>02611   input_roi-&gt;add_point(win, hin);
<a name="l02612"></a>02612   input_poly = <a class="codeRef" doxygen="contrib_brl_bbas_bsol.tag:../../../../../contrib/brl/bbas/bsol/html" href="../../../../../contrib/brl/bbas/bsol/html/classbsol__algs.html#a86bf45c002817d85e4cea675a6b631d6">bsol_algs::poly_from_box</a>(input_roi);
<a name="l02613"></a>02613   <span class="comment">// Case I</span>
<a name="l02614"></a>02614   <span class="comment">//  the output image size and input transform can be adjusted</span>
<a name="l02615"></a>02615   <span class="comment">//  to map the transformed image onto the full range</span>
<a name="l02616"></a>02616   <span class="keywordflow">if</span> (!output_size_fixed)
<a name="l02617"></a>02617   {
<a name="l02618"></a>02618     <span class="keywordflow">if</span> (!<a class="codeRef" doxygen="contrib_brl_bbas_bsol.tag:../../../../../contrib/brl/bbas/bsol/html" href="../../../../../contrib/brl/bbas/bsol/html/classbsol__algs.html#a45c1ae3acd32c0931018b707a5823ccf">bsol_algs::homography</a>(input_poly, H, output_poly))
<a name="l02619"></a>02619       <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02620"></a>02620     <a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__smart__ptr.html">vsol_box_2d_sptr</a> temp = output_poly-&gt;get_bounding_box();
<a name="l02621"></a>02621     output.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html#a9c01939f01ef50314620e26aaacb04d3">set_size</a>((<span class="keywordtype">int</span>)temp-&gt;width(), (int)temp-&gt;height());
<a name="l02622"></a>02622     output.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html#a6fd591632020e490abb5e4493a52dbba">fill</a>(output_fill_value);
<a name="l02623"></a>02623     <span class="comment">//offset the transform so the origin is (0,0)</span>
<a name="l02624"></a>02624     output_roi = <span class="keyword">new</span> <a class="codeRef" doxygen="contrib_gel_vsol.tag:../../../../../contrib/gel/vsol/html" href="../../../../../contrib/gel/vsol/html/classvsol__box__2d.html">vsol_box_2d</a>();
<a name="l02625"></a>02625     output_roi-&gt;add_point(0, 0);
<a name="l02626"></a>02626     output_roi-&gt;add_point(temp-&gt;width(), temp-&gt;height());
<a name="l02627"></a>02627     <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__h__matrix__2d.html">vgl_h_matrix_2d&lt;double&gt;</a> t; t.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__h__matrix__2d.html#a6b07c0342624f3d5a1d1b696acf0a31e">set_identity</a>().<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__h__matrix__2d.html#aa1fdf29fb9a7bf70e066fbd25d8d8857">set_translation</a>(-temp-&gt;get_min_x(),-temp-&gt;get_min_y());
<a name="l02628"></a>02628     Hinv = (t*H).get_inverse();
<a name="l02629"></a>02629   }
<a name="l02630"></a>02630   <span class="keywordflow">else</span> <span class="comment">// Case II, the output image size is fixed so we have to find the</span>
<a name="l02631"></a>02631   {    <span class="comment">// inverse mapping of the output roi and intersect with the input roi</span>
<a name="l02632"></a>02632     <span class="comment">// to determine the domain of the mapping</span>
<a name="l02633"></a>02633     <span class="keywordflow">if</span> (!output)
<a name="l02634"></a>02634       <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02635"></a>02635     <span class="comment">//The output roi and poly</span>
<a name="l02636"></a>02636     <span class="keywordtype">unsigned</span> wout = output.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a9ea9ad565387a61dccf38fc80a266c2a">ni</a>(), hout = output.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a44859c72206da7d18728cb2bbf8ae829">nj</a>();
<a name="l02637"></a>02637     output.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html#a6fd591632020e490abb5e4493a52dbba">fill</a>(output_fill_value);
<a name="l02638"></a>02638     output_roi = <span class="keyword">new</span> <a class="codeRef" doxygen="contrib_gel_vsol.tag:../../../../../contrib/gel/vsol/html" href="../../../../../contrib/gel/vsol/html/classvsol__box__2d.html">vsol_box_2d</a>();
<a name="l02639"></a>02639     output_roi-&gt;add_point(0, 0);
<a name="l02640"></a>02640     output_roi-&gt;add_point(wout, hout);
<a name="l02641"></a>02641     output_poly = <a class="codeRef" doxygen="contrib_brl_bbas_bsol.tag:../../../../../contrib/brl/bbas/bsol/html" href="../../../../../contrib/brl/bbas/bsol/html/classbsol__algs.html#a86bf45c002817d85e4cea675a6b631d6">bsol_algs::poly_from_box</a>(output_roi);
<a name="l02642"></a>02642 
<a name="l02643"></a>02643     <span class="comment">//Construct the reverse mapping of the output bounds</span>
<a name="l02644"></a>02644     <a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__smart__ptr.html">vsol_polygon_2d_sptr</a> tpoly;
<a name="l02645"></a>02645     Hinv = H.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__h__matrix__2d.html#a54ecf67a21fc3a3dc03d4760c8958ded">get_inverse</a>();
<a name="l02646"></a>02646     <span class="keywordflow">if</span> (!<a class="codeRef" doxygen="contrib_brl_bbas_bsol.tag:../../../../../contrib/brl/bbas/bsol/html" href="../../../../../contrib/brl/bbas/bsol/html/classbsol__algs.html#a45c1ae3acd32c0931018b707a5823ccf">bsol_algs::homography</a>(output_poly, Hinv, tpoly))
<a name="l02647"></a>02647       <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02648"></a>02648 
<a name="l02649"></a>02649     <span class="comment">//form the roi corresponding to the inverse mapped output bounds</span>
<a name="l02650"></a>02650     <a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__smart__ptr.html">vsol_box_2d_sptr</a> tbox = tpoly-&gt;get_bounding_box();
<a name="l02651"></a>02651 
<a name="l02652"></a>02652     <span class="comment">//intersect with the input image bounds to get the input roi</span>
<a name="l02653"></a>02653     <a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__smart__ptr.html">vsol_box_2d_sptr</a> temp;
<a name="l02654"></a>02654     <span class="keywordflow">if</span> (!<a class="codeRef" doxygen="contrib_brl_bbas_bsol.tag:../../../../../contrib/brl/bbas/bsol/html" href="../../../../../contrib/brl/bbas/bsol/html/classbsol__algs.html#a0c7179ce4d78cbf73a99a29e173c5beb">bsol_algs::intersection</a>(tbox, input_roi, temp))
<a name="l02655"></a>02655       <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02656"></a>02656     input_roi = temp;
<a name="l02657"></a>02657   }
<a name="l02658"></a>02658   <span class="comment">// At this point we have the correct bounds for the input and</span>
<a name="l02659"></a>02659   <span class="comment">// the output image</span>
<a name="l02660"></a>02660 
<a name="l02661"></a>02661   <span class="comment">// Iterate over the output image space and map the location of each</span>
<a name="l02662"></a>02662   <span class="comment">// pixel into the input image space. Then carry out interpolation to</span>
<a name="l02663"></a>02663   <span class="comment">// get the value of each output pixel</span>
<a name="l02664"></a>02664 
<a name="l02665"></a>02665   <span class="comment">// Dimensions of the input image</span>
<a name="l02666"></a>02666   <span class="keywordtype">int</span> ailow  = int(input_roi-&gt;get_min_x()+0.9999f); <span class="comment">// round up to nearest int</span>
<a name="l02667"></a>02667   <span class="keywordtype">int</span> aihigh = int(input_roi-&gt;get_max_x());      <span class="comment">// round down to nearest int</span>
<a name="l02668"></a>02668   <span class="keywordtype">int</span> ajlow  = int(input_roi-&gt;get_min_y()+0.9999f);
<a name="l02669"></a>02669   <span class="keywordtype">int</span> ajhigh = int(input_roi-&gt;get_max_y());
<a name="l02670"></a>02670 
<a name="l02671"></a>02671   <span class="comment">// Dimensions of the output image</span>
<a name="l02672"></a>02672   <span class="keywordtype">int</span> bilow  = int(output_roi-&gt;get_min_x()+0.9999f);
<a name="l02673"></a>02673   <span class="keywordtype">int</span> bihigh = int(output_roi-&gt;get_max_x());
<a name="l02674"></a>02674   <span class="keywordtype">int</span> bjlow  = int(output_roi-&gt;get_min_y()+0.9999f);
<a name="l02675"></a>02675   <span class="keywordtype">int</span> bjhigh = int(output_roi-&gt;get_max_y());
<a name="l02676"></a>02676 
<a name="l02677"></a>02677   <span class="comment">// The inverse transform is used to map backwards from the output</span>
<a name="l02678"></a>02678   <span class="keyword">const</span> vnl_matrix_fixed&lt;double,3,3&gt;&amp; Minv = Hinv.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__h__matrix__2d.html#a933552b4244b0c82adbe4fc498ea8690">get_matrix</a>();
<a name="l02679"></a>02679 
<a name="l02680"></a>02680   <span class="comment">// Now use Hinv to transform the image</span>
<a name="l02681"></a>02681   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = bilow; i&lt;bihigh; i++)
<a name="l02682"></a>02682     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = bjlow; j&lt;bjhigh; j++)
<a name="l02683"></a>02683     {
<a name="l02684"></a>02684       <span class="comment">// Transform the pixel</span>
<a name="l02685"></a>02685       <span class="keywordtype">float</span> val;
<a name="l02686"></a>02686       <span class="keywordtype">double</span> u = Minv[0][0] * i + Minv[0][1] * j + Minv[0][2];
<a name="l02687"></a>02687       <span class="keywordtype">double</span> <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/vgl__vector__2d_8h.html#a38bf1e5e0427bdeba2b469eea9befc23">v</a> = Minv[1][0] * i + Minv[1][1] * j + Minv[1][2];
<a name="l02688"></a>02688       <span class="keywordtype">double</span> w = Minv[2][0] * i + Minv[2][1] * j + Minv[2][2];
<a name="l02689"></a>02689       u /= w;
<a name="l02690"></a>02690       v /= w;
<a name="l02691"></a>02691 
<a name="l02692"></a>02692       <span class="comment">// Now do linear interpolation</span>
<a name="l02693"></a>02693       {
<a name="l02694"></a>02694         <span class="keywordtype">int</span> iu = (int) u;
<a name="l02695"></a>02695         <span class="keywordtype">int</span> iv = (int) v;
<a name="l02696"></a>02696 
<a name="l02697"></a>02697         <span class="keywordflow">if</span> (iu &gt;= ailow &amp;&amp; iu &lt; aihigh-1 &amp;&amp;
<a name="l02698"></a>02698             iv &gt;= ajlow &amp;&amp; iv &lt; ajhigh-1)
<a name="l02699"></a>02699         {
<a name="l02700"></a>02700           <span class="comment">// Get the neighbouring pixels</span>
<a name="l02701"></a>02701           <span class="comment">//      (u  v)    (u+1  v)</span>
<a name="l02702"></a>02702           <span class="comment">//      (u v+1)   (u+1 v+1)</span>
<a name="l02703"></a>02703           <span class="comment">//</span>
<a name="l02704"></a>02704           <span class="keywordtype">double</span> v00 = gimage(iu, iv);
<a name="l02705"></a>02705           <span class="keywordtype">double</span> v01 = gimage(iu, iv+1);
<a name="l02706"></a>02706           <span class="keywordtype">double</span> v10 = gimage(iu+1,iv);
<a name="l02707"></a>02707           <span class="keywordtype">double</span> v11 = gimage(iu+1, iv+1);
<a name="l02708"></a>02708 
<a name="l02709"></a>02709           <span class="keywordtype">double</span> fu = u - iu;
<a name="l02710"></a>02710           <span class="keywordtype">double</span> fv = v - iv;
<a name="l02711"></a>02711           <span class="keywordtype">double</span> v0 = v00 + fv * (v01 - v00);
<a name="l02712"></a>02712           <span class="keywordtype">double</span> v1 = v10 + fv * (v11 - v10);
<a name="l02713"></a>02713           val = (float) (v0 + fu * (v1 - v0));
<a name="l02714"></a>02714           <span class="comment">// Set the value</span>
<a name="l02715"></a>02715           output(i,j) = val;
<a name="l02716"></a>02716         }
<a name="l02717"></a>02717       }
<a name="l02718"></a>02718     }
<a name="l02719"></a>02719   <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l02720"></a>02720 }
<a name="l02721"></a>02721 
<a name="l02722"></a>02722 <span class="comment">//: rotate the input image counter-clockwise about the image origin.</span>
<a name="l02723"></a>02723 <span class="comment">// Demonstrates the use of image homography</span>
<a name="l02724"></a><a class="code" href="classbrip__vil__float__ops.html#a9ae7c0edadcf398dc0081cd85d05982f">02724</a> <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a>
<a name="l02725"></a>02725 <a class="code" href="classbrip__vil__float__ops.html#a9ae7c0edadcf398dc0081cd85d05982f" title="rotate the input image counter-clockwise about the image origin.">brip_vil_float_ops::rotate</a>(<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> <span class="keyword">const</span>&amp; input,
<a name="l02726"></a>02726                            <span class="keywordtype">double</span> theta_deg)
<a name="l02727"></a>02727 {
<a name="l02728"></a>02728   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> out;
<a name="l02729"></a>02729   <span class="keywordflow">if</span> (!input)
<a name="l02730"></a>02730     <span class="keywordflow">return</span> out;
<a name="l02731"></a>02731   <span class="keywordtype">double</span> ang = theta_deg;
<a name="l02732"></a>02732   <span class="comment">// map theta_deg to [0 360]</span>
<a name="l02733"></a>02733   <span class="keywordflow">while</span> (ang&gt;360)
<a name="l02734"></a>02734     ang-=360;
<a name="l02735"></a>02735   <span class="keywordflow">while</span> (ang&lt;0)
<a name="l02736"></a>02736     ang+=360;
<a name="l02737"></a>02737   <span class="comment">// convert to radians</span>
<a name="l02738"></a>02738   <span class="keywordtype">double</span> deg_to_rad = vnl_math::pi_over_180;
<a name="l02739"></a>02739   <span class="keywordtype">double</span> rang = deg_to_rad*ang;
<a name="l02740"></a>02740   <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__h__matrix__2d.html">vgl_h_matrix_2d&lt;double&gt;</a> H;
<a name="l02741"></a>02741   H.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__h__matrix__2d.html#a6b07c0342624f3d5a1d1b696acf0a31e">set_identity</a>().<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__h__matrix__2d.html#a33b79fa18f9763fa5075553e631afdb3">set_rotation</a>(rang);
<a name="l02742"></a>02742   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> temp;
<a name="l02743"></a>02743   <span class="comment">// The transform is adjusted to map the full input domain onto</span>
<a name="l02744"></a>02744   <span class="comment">// the output image.</span>
<a name="l02745"></a>02745   <span class="keywordflow">if</span> (!<a class="code" href="classbrip__vil__float__ops.html#a083fb590fecf698c5bcaf0c809adf4c7" title="map the input to the output by a homography.">brip_vil_float_ops::homography</a>(input, H, temp))
<a name="l02746"></a>02746     <span class="keywordflow">return</span> out;
<a name="l02747"></a>02747   <span class="keywordflow">return</span> temp;
<a name="l02748"></a>02748 }
<a name="l02749"></a><a class="code" href="classbrip__vil__float__ops.html#a509e2a5cfaf99a330e42b334b87729d5">02749</a> 
<a name="l02750"></a>02750 <span class="keywordtype">bool</span> <a class="code" href="classbrip__vil__float__ops.html#a509e2a5cfaf99a330e42b334b87729d5" title="extract a region of interest.">brip_vil_float_ops::chip</a>(<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> <span class="keyword">const</span>&amp; input,
<a name="l02751"></a>02751                               <a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__smart__ptr.html">vsol_box_2d_sptr</a> <span class="keyword">const</span>&amp; roi,
<a name="l02752"></a>02752                               <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a>&amp; chip)
<a name="l02753"></a>02753 {
<a name="l02754"></a>02754   <span class="keywordflow">if</span> (!input||!roi)
<a name="l02755"></a>02755     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02756"></a>02756   <span class="keywordtype">int</span> w = <span class="keyword">static_cast&lt;</span><span class="keywordtype">int</span><span class="keyword">&gt;</span>(input.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a9ea9ad565387a61dccf38fc80a266c2a">ni</a>()), h = static_cast&lt;int&gt;(input.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a44859c72206da7d18728cb2bbf8ae829">nj</a>());
<a name="l02757"></a>02757   <span class="keywordtype">int</span> x_min = (int)roi-&gt;get_min_x(), y_min = (int)roi-&gt;get_min_y();
<a name="l02758"></a>02758   <span class="keywordtype">int</span> x_max = (int)roi-&gt;get_max_x(), y_max = (int)roi-&gt;get_max_y();
<a name="l02759"></a>02759   <span class="keywordflow">if</span> (x_min&lt;0)
<a name="l02760"></a>02760     x_min = 0;
<a name="l02761"></a>02761   <span class="keywordflow">if</span> (y_min&lt;0)
<a name="l02762"></a>02762     y_min = 0;
<a name="l02763"></a>02763   <span class="keywordflow">if</span> (x_max&gt;w-1)
<a name="l02764"></a>02764     x_max=w-1;
<a name="l02765"></a>02765   <span class="keywordflow">if</span> (y_max&gt;h-1)
<a name="l02766"></a>02766     y_max=h-1;
<a name="l02767"></a>02767   <span class="keywordtype">int</span> rw = x_max-x_min, rh = y_max-y_min;
<a name="l02768"></a>02768   <span class="keywordflow">if</span> (rw&lt;=0||rh&lt;=0)
<a name="l02769"></a>02769     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02770"></a>02770   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> temp(rw+1, rh+1, 1);
<a name="l02771"></a>02771   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> y = y_min; y&lt;=y_max; y++)  <span class="comment">//!&lt; changed &lt; to &lt;= to include the boundary points too</span>
<a name="l02772"></a>02772 <span class="comment"></span>    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> x =x_min; x&lt;=x_max; x++)
<a name="l02773"></a>02773       temp(x-x_min, y-y_min) = input(x, y);
<a name="l02774"></a>02774   chip = temp;
<a name="l02775"></a>02775   <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l02776"></a>02776 }
<a name="l02777"></a>02777 
<a name="l02778"></a><a class="code" href="classbrip__vil__float__ops.html#a039ced864826b80312f02bf77e277659">02778</a> <span class="comment">//: convert image resource to cropped view according to a roi.</span>
<a name="l02779"></a>02779 <span class="keywordtype">bool</span> <a class="code" href="classbrip__vil__float__ops.html#a509e2a5cfaf99a330e42b334b87729d5" title="extract a region of interest.">brip_vil_float_ops::chip</a>(<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__smart__ptr.html">vil_image_resource_sptr</a> <span class="keyword">const</span>&amp; image,
<a name="l02780"></a>02780                               <a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__smart__ptr.html">brip_roi_sptr</a> <span class="keyword">const</span>&amp; roi,
<a name="l02781"></a>02781                               <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__smart__ptr.html">vil_image_resource_sptr</a> &amp; chip)
<a name="l02782"></a>02782 {
<a name="l02783"></a>02783   <span class="comment">// image bounds</span>
<a name="l02784"></a>02784   <span class="keywordtype">unsigned</span> ni = image-&gt;ni(), nj = image-&gt;nj();
<a name="l02785"></a>02785 
<a name="l02786"></a>02786   <span class="comment">// image bounds for the chip</span>
<a name="l02787"></a>02787   <span class="keywordtype">unsigned</span> cm = roi-&gt;cmin(0), rm = roi-&gt;rmin(0);
<a name="l02788"></a>02788   <span class="keywordtype">unsigned</span> niv = roi-&gt;csize(0), njv = roi-&gt;rsize(0);
<a name="l02789"></a>02789   vcl_cout &lt;&lt; <span class="stringliteral">&quot;org(&quot;</span> &lt;&lt; cm &lt;&lt; <span class="charliteral">&#39; &#39;</span> &lt;&lt; rm &lt;&lt; <span class="stringliteral">&quot;):size(&quot;</span> &lt;&lt; niv
<a name="l02790"></a>02790            &lt;&lt; <span class="charliteral">&#39; &#39;</span> &lt;&lt; njv &lt;&lt; <span class="stringliteral">&quot;)\n&quot;</span> &lt;&lt; vcl_flush;
<a name="l02791"></a>02791   <span class="comment">// check bounds</span>
<a name="l02792"></a>02792   <span class="keywordflow">if</span> (cm&gt;ni-1||rm&gt;nj-1||cm+niv&gt;ni||rm+njv&gt;nj)
<a name="l02793"></a>02793     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02794"></a>02794   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/vil__pixel__format_8h.html#a6f749d91364b0bcb661189f4a154800d">vil_pixel_format</a> pix_format = image-&gt;pixel_format();
<a name="l02795"></a>02795   <span class="comment">// get an appropriate image view for scalar images we care about</span>
<a name="l02796"></a>02796   <span class="keywordflow">if</span> (image-&gt;nplanes()==1)
<a name="l02797"></a>02797   {
<a name="l02798"></a>02798     <span class="keywordflow">if</span> (pix_format==<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/vil__pixel__format_8h.html#a6f749d91364b0bcb661189f4a154800da7e558fc5ba55dbb9c32658e7960b83f4">VIL_PIXEL_FORMAT_BYTE</a>)
<a name="l02799"></a>02799     {
<a name="l02800"></a>02800       <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;unsigned char&gt;</a> temp = image-&gt;get_view(cm, niv, rm, njv);
<a name="l02801"></a>02801       <span class="keywordflow">if</span> (!temp) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02802"></a>02802       chip = <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/vil__new_8cxx.html#a7d991bbca1ecd8b4c0917c36ec4b27c6">vil_new_image_resource_of_view</a>(temp);
<a name="l02803"></a>02803       <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l02804"></a>02804     }
<a name="l02805"></a>02805     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pix_format==<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/vil__pixel__format_8h.html#a6f749d91364b0bcb661189f4a154800dabecb5c0033517756dc112ccd18f97073">VIL_PIXEL_FORMAT_UINT_16</a>)
<a name="l02806"></a>02806     {
<a name="l02807"></a>02807       <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;unsigned short&gt;</a> temp = image-&gt;get_view(cm, niv, rm, njv);
<a name="l02808"></a>02808       <span class="keywordflow">if</span> (!temp) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02809"></a>02809       chip = <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/vil__new_8cxx.html#a7d991bbca1ecd8b4c0917c36ec4b27c6">vil_new_image_resource_of_view</a>(temp);
<a name="l02810"></a>02810       vcl_cout &lt;&lt; <span class="stringliteral">&quot;resc(&quot;</span> &lt;&lt; chip-&gt;ni() &lt;&lt; <span class="charliteral">&#39; &#39;</span> &lt;&lt; chip-&gt;nj()&lt;&lt; <span class="stringliteral">&quot;)\n&quot;</span>
<a name="l02811"></a>02811                &lt;&lt; vcl_flush;
<a name="l02812"></a>02812       <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l02813"></a>02813     }
<a name="l02814"></a>02814     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pix_format==<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/vil__pixel__format_8h.html#a6f749d91364b0bcb661189f4a154800da8d2e38094a68770dcad0e6637d5ce3ba">VIL_PIXEL_FORMAT_FLOAT</a>)
<a name="l02815"></a>02815     {
<a name="l02816"></a>02816       <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> temp = image-&gt;get_view(cm, niv, rm, njv);
<a name="l02817"></a>02817       <span class="keywordflow">if</span> (!temp) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02818"></a>02818       chip = <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/vil__new_8cxx.html#a7d991bbca1ecd8b4c0917c36ec4b27c6">vil_new_image_resource_of_view</a>(temp);
<a name="l02819"></a>02819       <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l02820"></a>02820     }
<a name="l02821"></a>02821   }
<a name="l02822"></a>02822 
<a name="l02823"></a>02823   <span class="comment">// color data</span>
<a name="l02824"></a>02824   <span class="keywordflow">if</span> (image-&gt;nplanes()==3)
<a name="l02825"></a>02825   {
<a name="l02826"></a>02826     <span class="keywordflow">if</span> (pix_format==<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/vil__pixel__format_8h.html#a6f749d91364b0bcb661189f4a154800da7e558fc5ba55dbb9c32658e7960b83f4">VIL_PIXEL_FORMAT_BYTE</a>) <span class="comment">//the only way now</span>
<a name="l02827"></a>02827     {
<a name="l02828"></a>02828       <span class="comment">//extract view corresponding to region of interest</span>
<a name="l02829"></a>02829       <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;vil_rgb&lt;vxl_byte&gt;</a> &gt; temp = image-&gt;get_view(cm, niv, rm, njv);
<a name="l02830"></a>02830       <span class="keywordflow">if</span> (!temp) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02831"></a>02831       chip = <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/vil__new_8cxx.html#a7d991bbca1ecd8b4c0917c36ec4b27c6">vil_new_image_resource_of_view</a>(temp);
<a name="l02832"></a>02832       <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l02833"></a>02833     }
<a name="l02834"></a>02834   }
<a name="l02835"></a>02835   <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02836"></a>02836 }
<a name="l02837"></a>02837 
<a name="l02838"></a><a class="code" href="classbrip__vil__float__ops.html#a7c51c7b999267d285ed7e64b48530151">02838</a> <span class="keywordtype">bool</span> <a class="code" href="classbrip__vil__float__ops.html#a509e2a5cfaf99a330e42b334b87729d5" title="extract a region of interest.">brip_vil_float_ops::</a>
<a name="l02839"></a>02839 <a class="code" href="classbrip__vil__float__ops.html#a509e2a5cfaf99a330e42b334b87729d5" title="extract a region of interest.">chip</a>(vcl_vector&lt;vil_image_resource_sptr&gt; <span class="keyword">const</span>&amp; images,
<a name="l02840"></a>02840      <a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__smart__ptr.html">brip_roi_sptr</a> <span class="keyword">const</span>&amp; roi,
<a name="l02841"></a>02841      vcl_vector&lt;vil_image_resource_sptr&gt;&amp; chips)
<a name="l02842"></a>02842 {
<a name="l02843"></a>02843   <span class="keywordflow">for</span> (vcl_vector&lt;vil_image_resource_sptr&gt;::const_iterator iit = images.begin(); iit != images.end(); ++iit) {
<a name="l02844"></a>02844     <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__smart__ptr.html">vil_image_resource_sptr</a> <a class="code" href="classbrip__vil__float__ops.html#a509e2a5cfaf99a330e42b334b87729d5" title="extract a region of interest.">chip</a>;
<a name="l02845"></a>02845     <span class="keywordflow">if</span> (!<a class="code" href="classbrip__vil__float__ops.html#a509e2a5cfaf99a330e42b334b87729d5" title="extract a region of interest.">brip_vil_float_ops::chip</a>(*iit, roi, chip))
<a name="l02846"></a>02846       <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02847"></a>02847     chips.push_back(chip);
<a name="l02848"></a>02848   }
<a name="l02849"></a>02849   <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l02850"></a>02850 }
<a name="l02851"></a>02851 
<a name="l02852"></a>02852 <span class="comment">//: perform normalized cross-correlation at a sub-pixel location.</span>
<a name="l02853"></a>02853 <span class="comment">// Thus all the pixel values are interpolated.</span>
<a name="l02854"></a><a class="code" href="classbrip__vil__float__ops.html#aa37f076413fbf47f6b379e87d63a9f90">02854</a> <span class="keywordtype">float</span> <a class="code" href="classbrip__vil__float__ops.html#aa37f076413fbf47f6b379e87d63a9f90" title="cross-correlate two images at a given sub-pixel location.">brip_vil_float_ops::</a>
<a name="l02855"></a>02855 <a class="code" href="classbrip__vil__float__ops.html#aa37f076413fbf47f6b379e87d63a9f90" title="cross-correlate two images at a given sub-pixel location.">cross_correlate</a>(<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> <span class="keyword">const</span>&amp; image1,
<a name="l02856"></a>02856                 <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> <span class="keyword">const</span>&amp; image2,
<a name="l02857"></a>02857                 <span class="keywordtype">float</span> x, <span class="keywordtype">float</span> y, <span class="keywordtype">int</span> radius, <span class="keywordtype">float</span> intensity_thresh)
<a name="l02858"></a>02858 {
<a name="l02859"></a>02859   <span class="keywordtype">unsigned</span> w1 = image1.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a9ea9ad565387a61dccf38fc80a266c2a">ni</a>(), h1 = image1.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a44859c72206da7d18728cb2bbf8ae829">nj</a>();
<a name="l02860"></a>02860   <span class="keywordtype">unsigned</span> w2 = image1.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a9ea9ad565387a61dccf38fc80a266c2a">ni</a>(), h2 = image1.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a44859c72206da7d18728cb2bbf8ae829">nj</a>();
<a name="l02861"></a>02861   <span class="comment">// bounds checks</span>
<a name="l02862"></a>02862   <span class="keywordflow">if</span> (w1!=w2||h1!=h2)
<a name="l02863"></a>02863     <span class="keywordflow">return</span> -1;
<a name="l02864"></a>02864   <span class="keywordflow">if</span> (x&lt;radius||x&gt;w1-radius-1||y&lt;radius||y&gt;h1-radius-1)
<a name="l02865"></a>02865     <span class="keywordflow">return</span> -1;
<a name="l02866"></a>02866 
<a name="l02867"></a>02867   <span class="comment">// accumulate correlation sums,</span>
<a name="l02868"></a>02868   <span class="comment">// bi-linear interpolate the values</span>
<a name="l02869"></a>02869   <span class="keywordtype">int</span> s = 2*radius+1;
<a name="l02870"></a>02870   <span class="keywordtype">double</span> area = s*s;
<a name="l02871"></a>02871   <span class="keywordtype">double</span> sI1=0, sI2=0, sI1I1=0, sI2I2=0, sI1I2=0;
<a name="l02872"></a>02872   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> y0 = -10*radius; y0&lt;=10*radius; ++y0)
<a name="l02873"></a>02873     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> x0 = -10*radius; x0&lt;=10*radius; ++x0)
<a name="l02874"></a>02874     {
<a name="l02875"></a>02875       <span class="keywordtype">float</span> xp = x+0.1f*(float)x0, yp = y+0.1f*(<span class="keywordtype">float</span>)y0;
<a name="l02876"></a>02876       <span class="keywordtype">double</span> v1 = <a class="code" href="classbrip__vil__float__ops.html#ac56dfd015fb01a56d315d5ae109e30fc" title="2x2 bilinear interpolation of image at specified location.">brip_vil_float_ops::bilinear_interpolation</a>(image1, xp, yp);
<a name="l02877"></a>02877       <span class="keywordtype">double</span> v2 = <a class="code" href="classbrip__vil__float__ops.html#ac56dfd015fb01a56d315d5ae109e30fc" title="2x2 bilinear interpolation of image at specified location.">brip_vil_float_ops::bilinear_interpolation</a>(image2, xp, yp);
<a name="l02878"></a>02878       sI1 += v1;
<a name="l02879"></a>02879       sI2 += v2;
<a name="l02880"></a>02880       sI1I1 += v1*v1;
<a name="l02881"></a>02881       sI2I2 += v2*v2;
<a name="l02882"></a>02882       sI1I2 += v1*v2;
<a name="l02883"></a>02883     }
<a name="l02884"></a>02884   <span class="comment">// compute correlation.</span>
<a name="l02885"></a>02885   <span class="keywordtype">float</span> cc = cross_corr(area, sI1, sI2, sI1I1, sI2I2, sI1I2, intensity_thresh);
<a name="l02886"></a>02886   <span class="keywordflow">return</span> cc;
<a name="l02887"></a>02887 }
<a name="l02888"></a>02888 
<a name="l02889"></a>02889 <span class="comment">//: r0 is the image from which to read the new intensity values.</span>
<a name="l02890"></a>02890 <span class="comment">//  \param r is the summing array row in which the values are to be accumulated</span>
<a name="l02891"></a>02891 <span class="keyword">static</span> <span class="keywordtype">bool</span> update_row(<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> <span class="keyword">const</span>&amp; image1,
<a name="l02892"></a>02892                        <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> <span class="keyword">const</span>&amp; image2,
<a name="l02893"></a>02893                        <span class="keywordtype">int</span> r0, <span class="keywordtype">int</span> r,
<a name="l02894"></a>02894                        <a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__array__2d.html">vbl_array_2d&lt;double&gt;</a>&amp; SI1,
<a name="l02895"></a>02895                        <a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__array__2d.html">vbl_array_2d&lt;double&gt;</a>&amp; SI2,
<a name="l02896"></a>02896                        <a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__array__2d.html">vbl_array_2d&lt;double&gt;</a>&amp; SI1I1,
<a name="l02897"></a>02897                        <a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__array__2d.html">vbl_array_2d&lt;double&gt;</a>&amp; SI2I2,
<a name="l02898"></a>02898                        <a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__array__2d.html">vbl_array_2d&lt;double&gt;</a>&amp; SI1I2)
<a name="l02899"></a>02899 {
<a name="l02900"></a>02900   <span class="keywordtype">unsigned</span> w1 = image1.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a9ea9ad565387a61dccf38fc80a266c2a">ni</a>();
<a name="l02901"></a>02901   <span class="keywordtype">unsigned</span> w2 = image2.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a9ea9ad565387a61dccf38fc80a266c2a">ni</a>();
<a name="l02902"></a>02902   <span class="keywordtype">int</span> h1 = image1.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a44859c72206da7d18728cb2bbf8ae829">nj</a>();
<a name="l02903"></a>02903   <span class="keywordtype">int</span> h2 = image2.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a44859c72206da7d18728cb2bbf8ae829">nj</a>();
<a name="l02904"></a>02904   <span class="keywordflow">if</span> (w1!=w2||h1!=h2||r&lt;0||r&gt;=h1)
<a name="l02905"></a>02905     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02906"></a>02906   <span class="keywordtype">double</span> i10 = image1(0,r0), i20 = image2(0,r0);
<a name="l02907"></a>02907   SI1[r][0] = i10; SI2[r][0] = i20; SI1I1[r][0]=i10*i10;
<a name="l02908"></a>02908   SI2I2[r][0]=i20*i20; SI1I2[r][0]=i10*i20;
<a name="l02909"></a>02909   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> c = 1; c&lt;w1; c++)
<a name="l02910"></a>02910   {
<a name="l02911"></a>02911     <span class="keywordtype">double</span> i1c = image1(c,r0);
<a name="l02912"></a>02912     <span class="keywordtype">double</span> i2c = image2(c,r0);
<a name="l02913"></a>02913     SI1[r][c]    = SI1[r][c-1]+i1c;
<a name="l02914"></a>02914     SI2[r][c]    = SI2[r][c-1]+i2c;
<a name="l02915"></a>02915     SI1I1[r][c]  = SI1I1[r][c-1]+ i1c*i1c;
<a name="l02916"></a>02916     SI2I2[r][c]  = SI2I2[r][c-1]+ i2c*i2c;
<a name="l02917"></a>02917     SI1I2[r][c]  = SI1I2[r][c-1]+ i1c*i2c;
<a name="l02918"></a>02918   }
<a name="l02919"></a>02919   <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l02920"></a>02920 }
<a name="l02921"></a>02921 
<a name="l02922"></a>02922 <span class="keyword">static</span> <span class="keywordtype">bool</span> initialize_slice(<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> <span class="keyword">const</span>&amp; image1,
<a name="l02923"></a>02923                              <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> <span class="keyword">const</span>&amp; image2,
<a name="l02924"></a>02924                              <span class="keywordtype">unsigned</span> radius,
<a name="l02925"></a>02925                              <a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__array__2d.html">vbl_array_2d&lt;double&gt;</a>&amp; SI1,
<a name="l02926"></a>02926                              <a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__array__2d.html">vbl_array_2d&lt;double&gt;</a>&amp; SI2,
<a name="l02927"></a>02927                              <a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__array__2d.html">vbl_array_2d&lt;double&gt;</a>&amp; SI1I1,
<a name="l02928"></a>02928                              <a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__array__2d.html">vbl_array_2d&lt;double&gt;</a>&amp; SI2I2,
<a name="l02929"></a>02929                              <a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__array__2d.html">vbl_array_2d&lt;double&gt;</a>&amp; SI1I2)
<a name="l02930"></a>02930 {
<a name="l02931"></a>02931   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> r = 0; r&lt;=2*radius; r++)
<a name="l02932"></a>02932     <span class="keywordflow">if</span> (!update_row(image1, image2, r, r, SI1, SI2, SI1I1, SI2I2, SI1I2))
<a name="l02933"></a>02933       <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02934"></a>02934   <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l02935"></a>02935 }
<a name="l02936"></a>02936 
<a name="l02937"></a>02937 <span class="keyword">static</span> <span class="keywordtype">bool</span> collapse_slice(<a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__array__2d.html">vbl_array_2d&lt;double&gt;</a> <span class="keyword">const</span>&amp; SI1,
<a name="l02938"></a>02938                            <a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__array__2d.html">vbl_array_2d&lt;double&gt;</a> <span class="keyword">const</span>&amp; SI2,
<a name="l02939"></a>02939                            <a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__array__2d.html">vbl_array_2d&lt;double&gt;</a> <span class="keyword">const</span>&amp; SI1I1,
<a name="l02940"></a>02940                            <a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__array__2d.html">vbl_array_2d&lt;double&gt;</a> <span class="keyword">const</span>&amp; SI2I2,
<a name="l02941"></a>02941                            <a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__array__2d.html">vbl_array_2d&lt;double&gt;</a> <span class="keyword">const</span>&amp; SI1I2,
<a name="l02942"></a>02942                            <a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__array__1d.html">vbl_array_1d&lt;double&gt;</a>&amp; dSI1,
<a name="l02943"></a>02943                            <a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__array__1d.html">vbl_array_1d&lt;double&gt;</a>&amp; dSI2,
<a name="l02944"></a>02944                            <a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__array__1d.html">vbl_array_1d&lt;double&gt;</a>&amp; dSI1I1,
<a name="l02945"></a>02945                            <a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__array__1d.html">vbl_array_1d&lt;double&gt;</a>&amp; dSI2I2,
<a name="l02946"></a>02946                            <a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__array__1d.html">vbl_array_1d&lt;double&gt;</a>&amp; dSI1I2)
<a name="l02947"></a>02947 {
<a name="l02948"></a>02948   <span class="comment">// sanity check</span>
<a name="l02949"></a>02949   <span class="keywordtype">unsigned</span> w = SI1.<a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__array__2d.html#a5d1d6d4ecc26eff6b99e456078924be6">cols</a>(), h = SI1.<a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__array__2d.html#abe25ab10299a0b1c6a075895bfb85fe6">rows</a>();
<a name="l02950"></a>02950   <span class="keywordtype">unsigned</span> dw = dSI1.<a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__array__1d.html#ac11ed4641108cad5b64d5c6f432a421d">size</a>();
<a name="l02951"></a>02951   <span class="keywordflow">if</span> (dw!=w)
<a name="l02952"></a>02952     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02953"></a>02953 
<a name="l02954"></a>02954   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> c = 0; c&lt;w; c++)
<a name="l02955"></a>02955   {
<a name="l02956"></a>02956     dSI1[c]=0; dSI2[c]=0; dSI1I1[c]=0;
<a name="l02957"></a>02957     dSI2I2[c]=0; dSI1I2[c]=0;
<a name="l02958"></a>02958     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> r = 0; r&lt;h; r++)
<a name="l02959"></a>02959     {
<a name="l02960"></a>02960       dSI1[c] += SI1[r][c];
<a name="l02961"></a>02961       dSI2[c] += SI2[r][c];
<a name="l02962"></a>02962       dSI1I1[c] += SI1I1[r][c];
<a name="l02963"></a>02963       dSI2I2[c] += SI2I2[r][c];
<a name="l02964"></a>02964       dSI1I2[c] += SI1I2[r][c];
<a name="l02965"></a>02965     }
<a name="l02966"></a>02966   }
<a name="l02967"></a>02967   <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l02968"></a>02968 }
<a name="l02969"></a>02969 
<a name="l02970"></a>02970 <span class="keyword">static</span> <span class="keywordtype">bool</span> cross_correlate_row(<span class="keywordtype">int</span> radius,
<a name="l02971"></a>02971                                 <a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__array__1d.html">vbl_array_1d&lt;double&gt;</a>&amp; dSI1,
<a name="l02972"></a>02972                                 <a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__array__1d.html">vbl_array_1d&lt;double&gt;</a>&amp; dSI2,
<a name="l02973"></a>02973                                 <a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__array__1d.html">vbl_array_1d&lt;double&gt;</a>&amp; dSI1I1,
<a name="l02974"></a>02974                                 <a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__array__1d.html">vbl_array_1d&lt;double&gt;</a>&amp; dSI2I2,
<a name="l02975"></a>02975                                 <a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__array__1d.html">vbl_array_1d&lt;double&gt;</a>&amp; dSI1I2,
<a name="l02976"></a>02976                                 <span class="keywordtype">float</span> intensity_thresh,
<a name="l02977"></a>02977                                 <a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__array__1d.html">vbl_array_1d&lt;float&gt;</a>&amp; cc)
<a name="l02978"></a>02978 {
<a name="l02979"></a>02979   <span class="comment">// sanity check</span>
<a name="l02980"></a>02980   <span class="keywordtype">unsigned</span> w = dSI1.<a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__array__1d.html#ac11ed4641108cad5b64d5c6f432a421d">size</a>(), wc = cc.<a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__array__1d.html#ac11ed4641108cad5b64d5c6f432a421d">size</a>();
<a name="l02981"></a>02981   <span class="keywordflow">if</span> (!w||!wc||w!=wc)
<a name="l02982"></a>02982     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l02983"></a>02983   <span class="keywordtype">int</span> s = 2*radius+1;
<a name="l02984"></a>02984   <span class="keywordtype">double</span> area = s*s;
<a name="l02985"></a>02985   <span class="comment">// the general case</span>
<a name="l02986"></a>02986   <span class="keywordtype">double</span> si1=dSI1[s-1], si2=dSI2[s-1], si1i1=dSI1I1[s-1],
<a name="l02987"></a>02987     si2i2=dSI2I2[s-1], si1i2=dSI1I2[s-1];
<a name="l02988"></a>02988   cc[radius]= cross_corr(area, si1, si2, si1i1, si2i2, si1i2, intensity_thresh);
<a name="l02989"></a>02989   <span class="comment">// the remaining columns</span>
<a name="l02990"></a>02990   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> c = radius+1; c+radius&lt;w; c++)
<a name="l02991"></a>02991   {
<a name="l02992"></a>02992     si1=dSI1[c+radius]-dSI1[c-radius-1];
<a name="l02993"></a>02993     si2=dSI2[c+radius]-dSI2[c-radius-1];
<a name="l02994"></a>02994     si1i1=dSI1I1[c+radius]-dSI1I1[c-radius-1];
<a name="l02995"></a>02995     si2i2=dSI2I2[c+radius]-dSI2I2[c-radius-1];
<a name="l02996"></a>02996     si1i2=dSI1I2[c+radius]-dSI1I2[c-radius-1];
<a name="l02997"></a>02997     cc[c] = cross_corr(area, si1, si2, si1i1, si2i2, si1i2, intensity_thresh);
<a name="l02998"></a>02998   }
<a name="l02999"></a>02999   <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l03000"></a>03000 }
<a name="l03001"></a>03001 
<a name="l03002"></a>03002 <span class="keyword">static</span> <span class="keywordtype">void</span> advance_rows(<a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__array__2d.html">vbl_array_2d&lt;double&gt;</a>&amp; S)
<a name="l03003"></a>03003 {
<a name="l03004"></a>03004   <span class="keywordtype">unsigned</span> nr = S.<a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__array__2d.html#abe25ab10299a0b1c6a075895bfb85fe6">rows</a>(), nc = S.<a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__array__2d.html#a5d1d6d4ecc26eff6b99e456078924be6">cols</a>();
<a name="l03005"></a>03005   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> r = 0; r&lt;nr-1; r++)
<a name="l03006"></a>03006     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> c =0; c&lt;nc; c++)
<a name="l03007"></a>03007       S[r][c]=S[r+1][c];
<a name="l03008"></a>03008 }
<a name="l03009"></a>03009 
<a name="l03010"></a>03010 <span class="keyword">static</span> <span class="keywordtype">bool</span> output_cc_row(<span class="keywordtype">int</span> r0, <a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__array__1d.html">vbl_array_1d&lt;float&gt;</a> <span class="keyword">const</span>&amp; cc,
<a name="l03011"></a>03011                           <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a>&amp; out)
<a name="l03012"></a>03012 {
<a name="l03013"></a>03013   <span class="keywordtype">unsigned</span> n = cc.<a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__array__1d.html#ac11ed4641108cad5b64d5c6f432a421d">size</a>(), w = out.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a9ea9ad565387a61dccf38fc80a266c2a">ni</a>();
<a name="l03014"></a>03014   <span class="keywordflow">if</span> (n!=w)
<a name="l03015"></a>03015     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l03016"></a>03016   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> c = 0; c&lt;w; c++)
<a name="l03017"></a>03017     out(c, r0) = cc[c];
<a name="l03018"></a>03018   <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l03019"></a>03019 }
<a name="l03020"></a>03020 
<a name="l03021"></a><a class="code" href="classbrip__vil__float__ops.html#adc0dcb564f66da04432fa3bbe4376881">03021</a> <span class="keywordtype">bool</span> <a class="code" href="classbrip__vil__float__ops.html#aa37f076413fbf47f6b379e87d63a9f90" title="cross-correlate two images at a given sub-pixel location.">brip_vil_float_ops::</a>
<a name="l03022"></a>03022 <a class="code" href="classbrip__vil__float__ops.html#aa37f076413fbf47f6b379e87d63a9f90" title="cross-correlate two images at a given sub-pixel location.">cross_correlate</a>(<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> <span class="keyword">const</span>&amp; image1,
<a name="l03023"></a>03023                 <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> <span class="keyword">const</span>&amp; image2,
<a name="l03024"></a>03024                 <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a>&amp; out,
<a name="l03025"></a>03025                 <span class="keywordtype">int</span> radius, <span class="keywordtype">float</span> intensity_thresh)
<a name="l03026"></a>03026 {
<a name="l03027"></a>03027   <a class="codeRef" doxygen="core_vul.tag:../../../../../core/vul/html" href="../../../../../core/vul/html/classvul__timer.html">vul_timer</a> t;
<a name="l03028"></a>03028   <span class="keywordtype">unsigned</span> w = image1.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a9ea9ad565387a61dccf38fc80a266c2a">ni</a>(), h = image1.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a44859c72206da7d18728cb2bbf8ae829">nj</a>();
<a name="l03029"></a>03029   <span class="keywordtype">unsigned</span> w2 = image2.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a9ea9ad565387a61dccf38fc80a266c2a">ni</a>(), h2 = image2.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a44859c72206da7d18728cb2bbf8ae829">nj</a>();
<a name="l03030"></a>03030   <span class="comment">// sizes must match</span>
<a name="l03031"></a>03031   <span class="keywordflow">if</span> (w!=w2||h!=h2)
<a name="l03032"></a>03032   {
<a name="l03033"></a>03033     vcl_cout &lt;&lt; <span class="stringliteral">&quot;In brip_vil_float_ops::cross_correlate(..) -&quot;</span>
<a name="l03034"></a>03034              &lt;&lt; <span class="stringliteral">&quot; image sizes don&#39;t match\n&quot;</span>;
<a name="l03035"></a>03035     <span class="keywordflow">return</span> out;
<a name="l03036"></a>03036   }
<a name="l03037"></a>03037   out.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html#a9c01939f01ef50314620e26aaacb04d3">set_size</a>(w, h);
<a name="l03038"></a>03038   out.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html#a6fd591632020e490abb5e4493a52dbba">fill</a>(0.f);
<a name="l03039"></a>03039   <span class="keywordtype">int</span> s = 2*radius+1;
<a name="l03040"></a>03040   <span class="comment">// Create the running sum slices</span>
<a name="l03041"></a>03041   <a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__array__2d.html">vbl_array_2d&lt;double&gt;</a> SI1(s,w), SI2(s,w),
<a name="l03042"></a>03042     SI1I1(s,w), SI2I2(s,w), SI1I2(s,w);
<a name="l03043"></a>03043   <a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__array__1d.html">vbl_array_1d&lt;float&gt;</a> cc(w, 0.f);
<a name="l03044"></a>03044   <a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__array__1d.html">vbl_array_1d&lt;double&gt;</a> dSI1(w, 0.0), dSI2(w, 0.0),
<a name="l03045"></a>03045     dSI1I1(w, 0.0), dSI2I2(w, 0.0), dSI1I2(w, 0.0);
<a name="l03046"></a>03046   initialize_slice(image1, image2, radius, SI1, SI2, SI1I1, SI2I2, SI1I2);
<a name="l03047"></a>03047   <span class="keywordflow">if</span> (!collapse_slice(SI1,  SI2,  SI1I1,  SI2I2,  SI1I2,
<a name="l03048"></a>03048                       dSI1, dSI2, dSI1I1, dSI2I2, dSI1I2))
<a name="l03049"></a>03049     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l03050"></a>03050   <span class="keywordtype">unsigned</span> r0 = radius;
<a name="l03051"></a>03051   <span class="keywordflow">for</span> (; r0+radius+1&lt;h; r0++)
<a name="l03052"></a>03052   {
<a name="l03053"></a>03053     <span class="keywordflow">if</span> (r0==5)
<a name="l03054"></a>03054       r0=5;
<a name="l03055"></a>03055 <span class="preprocessor">#ifdef DEBUG</span>
<a name="l03056"></a>03056 <span class="preprocessor"></span>    vcl_cout &lt;&lt; <span class="stringliteral">&quot;r0 &quot;</span> &lt;&lt; r0 &lt;&lt; <span class="charliteral">&#39;\n&#39;</span>;
<a name="l03057"></a>03057 <span class="preprocessor">#endif</span>
<a name="l03058"></a>03058 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (!cross_correlate_row(radius, dSI1, dSI2, dSI1I1, dSI2I2, dSI1I2,
<a name="l03059"></a>03059                              intensity_thresh, cc))
<a name="l03060"></a>03060       <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l03061"></a>03061 <span class="preprocessor">#ifdef DEBUG</span>
<a name="l03062"></a>03062 <span class="preprocessor"></span>    vcl_cout &lt;&lt; <span class="charliteral">&#39;\n&#39;</span>;
<a name="l03063"></a>03063 <span class="preprocessor">#endif</span>
<a name="l03064"></a>03064 <span class="preprocessor"></span>    advance_rows(SI1); advance_rows(SI2);  advance_rows(SI1I1);
<a name="l03065"></a>03065     advance_rows(SI2I2); advance_rows(SI1I2);
<a name="l03066"></a>03066     <span class="keywordflow">if</span> (!update_row(image1, image2, r0+radius+1, 2*radius,
<a name="l03067"></a>03067                     SI1, SI2, SI1I1, SI2I2, SI1I2))
<a name="l03068"></a>03068       <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l03069"></a>03069     <span class="keywordflow">if</span> (!collapse_slice(SI1,  SI2,  SI1I1,  SI2I2,  SI1I2,
<a name="l03070"></a>03070                         dSI1, dSI2, dSI1I1, dSI2I2, dSI1I2))
<a name="l03071"></a>03071       <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l03072"></a>03072     <span class="keywordflow">if</span> (!output_cc_row(r0, cc, out))
<a name="l03073"></a>03073       <span class="keywordflow">return</span> out;
<a name="l03074"></a>03074   }
<a name="l03075"></a>03075   <span class="comment">// handle the last row</span>
<a name="l03076"></a>03076 <span class="preprocessor">#ifdef DEBUG</span>
<a name="l03077"></a>03077 <span class="preprocessor"></span>  vcl_cout &lt;&lt; <span class="stringliteral">&quot;r0 &quot;</span> &lt;&lt; r0 &lt;&lt; <span class="charliteral">&#39;\n&#39;</span>;
<a name="l03078"></a>03078 <span class="preprocessor">#endif</span>
<a name="l03079"></a>03079 <span class="preprocessor"></span>  <span class="keywordflow">if</span> (!cross_correlate_row(radius, dSI1, dSI2, dSI1I1, dSI2I2, dSI1I2,
<a name="l03080"></a>03080                            intensity_thresh, cc))
<a name="l03081"></a>03081     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l03082"></a>03082 <span class="preprocessor">#ifdef DEBUG</span>
<a name="l03083"></a>03083 <span class="preprocessor"></span>  vcl_cout &lt;&lt; <span class="charliteral">&#39;\n&#39;</span>;
<a name="l03084"></a>03084 <span class="preprocessor">#endif</span>
<a name="l03085"></a>03085 <span class="preprocessor"></span>  <span class="keywordflow">if</span> (!output_cc_row(r0, cc, out))
<a name="l03086"></a>03086     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l03087"></a>03087 <span class="preprocessor">#ifdef DEBUG</span>
<a name="l03088"></a>03088 <span class="preprocessor"></span>  vcl_cout &lt;&lt; <span class="stringliteral">&quot;RunningSumCrossCorrelation for &quot;</span> &lt;&lt; w*h/1000.0f &lt;&lt; <span class="stringliteral">&quot; k pixels in &quot;</span>
<a name="l03089"></a>03089            &lt;&lt; t.<a class="codeRef" doxygen="core_vul.tag:../../../../../core/vul/html" href="../../../../../core/vul/html/classvul__timer.html#a14c86b3c27f36c1946c184941e006370">real</a>() &lt;&lt; <span class="stringliteral">&quot; msecs\n&quot;</span>&lt;&lt; vcl_flush;
<a name="l03090"></a>03090 <span class="preprocessor">#endif</span>
<a name="l03091"></a>03091 <span class="preprocessor"></span>  <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l03092"></a>03092 }
<a name="l03093"></a>03093 
<a name="l03094"></a><a class="code" href="classbrip__vil__float__ops.html#aa53780e68774a9005f49508d8b9a221a">03094</a> <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__smart__ptr.html">vil_image_resource_sptr</a>
<a name="l03095"></a>03095 <a class="code" href="classbrip__vil__float__ops.html#aa53780e68774a9005f49508d8b9a221a" title="Add two images from a general resource (forces types to be the same).">brip_vil_float_ops::sum</a>(<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__smart__ptr.html">vil_image_resource_sptr</a> <span class="keyword">const</span>&amp; img0,
<a name="l03096"></a>03096                         <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__smart__ptr.html">vil_image_resource_sptr</a> <span class="keyword">const</span>&amp; img1)
<a name="l03097"></a>03097 {
<a name="l03098"></a>03098   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> op0 = <a class="code" href="classbrip__vil__float__ops.html#afc428b73d4f323a495252b0f5cb30a20" title="converts a vil_image_resource to a float image.">brip_vil_float_ops::convert_to_float</a>(img0);
<a name="l03099"></a>03099   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> op1 = <a class="code" href="classbrip__vil__float__ops.html#afc428b73d4f323a495252b0f5cb30a20" title="converts a vil_image_resource to a float image.">brip_vil_float_ops::convert_to_float</a>(img1);
<a name="l03100"></a>03100   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> <a class="code" href="classbrip__vil__float__ops.html#aa53780e68774a9005f49508d8b9a221a" title="Add two images from a general resource (forces types to be the same).">sum</a>;
<a name="l03101"></a>03101   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/vil__math_8h.html#a20b958fc0b19b97e2c071ba6c4515ee2">vil_math_image_sum</a>(op0, op1, sum);
<a name="l03102"></a>03102 
<a name="l03103"></a>03103   <span class="comment">// find out the types of the input images for now, only do greyscale operands</span>
<a name="l03104"></a>03104   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/vil__pixel__format_8h.html#a6f749d91364b0bcb661189f4a154800d">vil_pixel_format</a> pix_format0 = img0-&gt;pixel_format();
<a name="l03105"></a>03105   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/vil__pixel__format_8h.html#a6f749d91364b0bcb661189f4a154800d">vil_pixel_format</a> pix_format1 = img1-&gt;pixel_format();
<a name="l03106"></a>03106   <span class="keywordflow">if</span> (pix_format0 == <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/vil__pixel__format_8h.html#a6f749d91364b0bcb661189f4a154800da8d2e38094a68770dcad0e6637d5ce3ba">VIL_PIXEL_FORMAT_FLOAT</a> ||
<a name="l03107"></a>03107       pix_format1 == <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/vil__pixel__format_8h.html#a6f749d91364b0bcb661189f4a154800da8d2e38094a68770dcad0e6637d5ce3ba">VIL_PIXEL_FORMAT_FLOAT</a>)
<a name="l03108"></a>03108     {
<a name="l03109"></a>03109       <span class="keywordflow">return</span> <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/vil__new_8cxx.html#a7d991bbca1ecd8b4c0917c36ec4b27c6">vil_new_image_resource_of_view</a>(sum);
<a name="l03110"></a>03110     }
<a name="l03111"></a>03111 
<a name="l03112"></a>03112   <span class="keywordflow">if</span> (pix_format0 == <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/vil__pixel__format_8h.html#a6f749d91364b0bcb661189f4a154800dabecb5c0033517756dc112ccd18f97073">VIL_PIXEL_FORMAT_UINT_16</a> ||
<a name="l03113"></a>03113       pix_format1 == <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/vil__pixel__format_8h.html#a6f749d91364b0bcb661189f4a154800dabecb5c0033517756dc112ccd18f97073">VIL_PIXEL_FORMAT_UINT_16</a>)
<a name="l03114"></a>03114     {
<a name="l03115"></a>03115       <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;vxl_uint_16&gt;</a> res =
<a name="l03116"></a>03116         <a class="code" href="classbrip__vil__float__ops.html#a2761cfe0b0d451bb950f9cb802e20eb5" title="converts a float image to an unsigned short (16-bit) image within a range.">brip_vil_float_ops::convert_to_short</a>(<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/vil__new_8cxx.html#a7d991bbca1ecd8b4c0917c36ec4b27c6">vil_new_image_resource_of_view</a>(sum));
<a name="l03117"></a>03117       <span class="keywordflow">return</span> <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/vil__new_8cxx.html#a7d991bbca1ecd8b4c0917c36ec4b27c6">vil_new_image_resource_of_view</a>(res);
<a name="l03118"></a>03118     }
<a name="l03119"></a>03119 
<a name="l03120"></a>03120   <span class="keywordflow">if</span> (pix_format0 == <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/vil__pixel__format_8h.html#a6f749d91364b0bcb661189f4a154800da7e558fc5ba55dbb9c32658e7960b83f4">VIL_PIXEL_FORMAT_BYTE</a> ||
<a name="l03121"></a>03121       pix_format1 == <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/vil__pixel__format_8h.html#a6f749d91364b0bcb661189f4a154800da7e558fc5ba55dbb9c32658e7960b83f4">VIL_PIXEL_FORMAT_BYTE</a>)
<a name="l03122"></a>03122     {
<a name="l03123"></a>03123       <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;vxl_byte&gt;</a> res =
<a name="l03124"></a>03124         <a class="code" href="classbrip__vil__float__ops.html#af77691e76e6b2fc38568b3c07cb3335d" title="converts a float image to a byte value range.">brip_vil_float_ops::convert_to_byte</a>(sum);
<a name="l03125"></a>03125       <span class="keywordflow">return</span> <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/vil__new_8cxx.html#a7d991bbca1ecd8b4c0917c36ec4b27c6">vil_new_image_resource_of_view</a>(res);
<a name="l03126"></a>03126     }
<a name="l03127"></a>03127   <span class="comment">// for color return the float image</span>
<a name="l03128"></a>03128   <span class="keywordflow">return</span> <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/vil__new_8cxx.html#a7d991bbca1ecd8b4c0917c36ec4b27c6">vil_new_image_resource_of_view</a>(sum);
<a name="l03129"></a>03129 }
<a name="l03130"></a>03130 
<a name="l03131"></a>03131 <span class="comment">// Compute img0 - img1</span>
<a name="l03132"></a><a class="code" href="classbrip__vil__float__ops.html#a56fb40bf980f1c63199805de7a5eee9e">03132</a> <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__smart__ptr.html">vil_image_resource_sptr</a>
<a name="l03133"></a>03133 <a class="code" href="classbrip__vil__float__ops.html#a8a34499b91e321beff2beb67d131aac7" title="subtracts image_1 from image_2.">brip_vil_float_ops::difference</a>(<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__smart__ptr.html">vil_image_resource_sptr</a> <span class="keyword">const</span>&amp; img0,
<a name="l03134"></a>03134                                <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__smart__ptr.html">vil_image_resource_sptr</a> <span class="keyword">const</span>&amp; img1)
<a name="l03135"></a>03135 {
<a name="l03136"></a>03136   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> op0 = <a class="code" href="classbrip__vil__float__ops.html#afc428b73d4f323a495252b0f5cb30a20" title="converts a vil_image_resource to a float image.">brip_vil_float_ops::convert_to_float</a>(img0);
<a name="l03137"></a>03137   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> op1 = <a class="code" href="classbrip__vil__float__ops.html#afc428b73d4f323a495252b0f5cb30a20" title="converts a vil_image_resource to a float image.">brip_vil_float_ops::convert_to_float</a>(img1);
<a name="l03138"></a>03138   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> diff;
<a name="l03139"></a>03139   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/vil__math_8h.html#a567b3e7140896193cbb2fd72fdd42c47">vil_math_image_difference</a>(op0, op1, diff);
<a name="l03140"></a>03140 
<a name="l03141"></a>03141   <span class="comment">// find out the types of the input images for now, only do greyscale operands</span>
<a name="l03142"></a>03142   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/vil__pixel__format_8h.html#a6f749d91364b0bcb661189f4a154800d">vil_pixel_format</a> pix_format0 = img0-&gt;pixel_format();
<a name="l03143"></a>03143   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/vil__pixel__format_8h.html#a6f749d91364b0bcb661189f4a154800d">vil_pixel_format</a> pix_format1 = img1-&gt;pixel_format();
<a name="l03144"></a>03144   <span class="keywordflow">if</span> (pix_format0 == <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/vil__pixel__format_8h.html#a6f749d91364b0bcb661189f4a154800da8d2e38094a68770dcad0e6637d5ce3ba">VIL_PIXEL_FORMAT_FLOAT</a> ||
<a name="l03145"></a>03145       pix_format1 == <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/vil__pixel__format_8h.html#a6f749d91364b0bcb661189f4a154800da8d2e38094a68770dcad0e6637d5ce3ba">VIL_PIXEL_FORMAT_FLOAT</a>)
<a name="l03146"></a>03146     {
<a name="l03147"></a>03147       <span class="keywordflow">return</span> <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/vil__new_8cxx.html#a7d991bbca1ecd8b4c0917c36ec4b27c6">vil_new_image_resource_of_view</a>(diff);
<a name="l03148"></a>03148     }
<a name="l03149"></a>03149 
<a name="l03150"></a>03150   <span class="keywordflow">if</span> (pix_format0 == <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/vil__pixel__format_8h.html#a6f749d91364b0bcb661189f4a154800dabecb5c0033517756dc112ccd18f97073">VIL_PIXEL_FORMAT_UINT_16</a> ||
<a name="l03151"></a>03151       pix_format1 == <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/vil__pixel__format_8h.html#a6f749d91364b0bcb661189f4a154800dabecb5c0033517756dc112ccd18f97073">VIL_PIXEL_FORMAT_UINT_16</a>)
<a name="l03152"></a>03152     {
<a name="l03153"></a>03153       <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;vxl_uint_16&gt;</a> res =
<a name="l03154"></a>03154         <a class="code" href="classbrip__vil__float__ops.html#a2761cfe0b0d451bb950f9cb802e20eb5" title="converts a float image to an unsigned short (16-bit) image within a range.">brip_vil_float_ops::convert_to_short</a>(<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/vil__new_8cxx.html#a7d991bbca1ecd8b4c0917c36ec4b27c6">vil_new_image_resource_of_view</a>(diff));
<a name="l03155"></a>03155       <span class="keywordflow">return</span> <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/vil__new_8cxx.html#a7d991bbca1ecd8b4c0917c36ec4b27c6">vil_new_image_resource_of_view</a>(res);
<a name="l03156"></a>03156     }
<a name="l03157"></a>03157 
<a name="l03158"></a>03158   <span class="keywordflow">if</span> (pix_format0 == <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/vil__pixel__format_8h.html#a6f749d91364b0bcb661189f4a154800da7e558fc5ba55dbb9c32658e7960b83f4">VIL_PIXEL_FORMAT_BYTE</a> ||
<a name="l03159"></a>03159       pix_format1 == <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/vil__pixel__format_8h.html#a6f749d91364b0bcb661189f4a154800da7e558fc5ba55dbb9c32658e7960b83f4">VIL_PIXEL_FORMAT_BYTE</a>)
<a name="l03160"></a>03160     {
<a name="l03161"></a>03161       <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;vxl_byte&gt;</a> res = <a class="code" href="classbrip__vil__float__ops.html#af77691e76e6b2fc38568b3c07cb3335d" title="converts a float image to a byte value range.">brip_vil_float_ops::convert_to_byte</a>(diff);
<a name="l03162"></a>03162       <span class="keywordflow">return</span> <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/vil__new_8cxx.html#a7d991bbca1ecd8b4c0917c36ec4b27c6">vil_new_image_resource_of_view</a>(res);
<a name="l03163"></a>03163     }
<a name="l03164"></a>03164   <span class="comment">// for color return the float image</span>
<a name="l03165"></a>03165   <span class="keywordflow">return</span> <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/vil__new_8cxx.html#a7d991bbca1ecd8b4c0917c36ec4b27c6">vil_new_image_resource_of_view</a>(diff);
<a name="l03166"></a>03166 }
<a name="l03167"></a>03167 
<a name="l03168"></a>03168 <span class="comment">//: Compute the entropy of the intensity of a region</span>
<a name="l03169"></a><a class="code" href="classbrip__vil__float__ops.html#a385b81e29541c44ac52d1f66186a0ea6">03169</a> <span class="comment">//  Note no bounds checking!</span>
<a name="l03170"></a>03170 <span class="keywordtype">float</span> <a class="code" href="classbrip__vil__float__ops.html#a385b81e29541c44ac52d1f66186a0ea6" title="Compute the intensity entropy of a region about the specified pixel.">brip_vil_float_ops::entropy_i</a>(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> i, <span class="keyword">const</span> <span class="keywordtype">unsigned</span> j,
<a name="l03171"></a>03171                                     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> i_radius,
<a name="l03172"></a>03172                                     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> j_radius,
<a name="l03173"></a>03173                                     <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> <span class="keyword">const</span>&amp; intensity,
<a name="l03174"></a>03174                                     <span class="keyword">const</span> <span class="keywordtype">float</span> range, <span class="keyword">const</span> <span class="keywordtype">unsigned</span> bins)
<a name="l03175"></a>03175 {
<a name="l03176"></a>03176   bsta_histogram&lt;float&gt; hi(range, bins);
<a name="l03177"></a>03177   <span class="keywordtype">int</span> ir = <span class="keyword">static_cast&lt;</span><span class="keywordtype">int</span><span class="keyword">&gt;</span>(i_radius), jr = static_cast&lt;int&gt;(j_radius);
<a name="l03178"></a>03178   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> dj = -jr; dj&lt;=jr; ++dj)
<a name="l03179"></a>03179     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> di = -ir; di&lt;=ir; ++di)
<a name="l03180"></a>03180     {
<a name="l03181"></a>03181       <span class="keywordtype">float</span> inten = intensity(i+di, j+dj);
<a name="l03182"></a>03182       hi.upcount(inten, 1.0f);
<a name="l03183"></a>03183     }
<a name="l03184"></a>03184   <span class="keywordflow">return</span> hi.entropy();
<a name="l03185"></a>03185 }
<a name="l03186"></a>03186 
<a name="l03187"></a>03187 <span class="comment">//: Compute the entropy of the gradient direction of a region</span>
<a name="l03188"></a><a class="code" href="classbrip__vil__float__ops.html#a7fcbd6e787b882f6064cb9679c7b0aed">03188</a> <span class="comment">//  Note no bounds checking!</span>
<a name="l03189"></a>03189 <span class="keywordtype">float</span> <a class="code" href="classbrip__vil__float__ops.html#a7fcbd6e787b882f6064cb9679c7b0aed" title="Compute the gradient entropy of a region about the specified pixel.">brip_vil_float_ops::entropy_g</a>(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> i, <span class="keyword">const</span> <span class="keywordtype">unsigned</span> j,
<a name="l03190"></a>03190                                     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> i_radius,
<a name="l03191"></a>03191                                     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> j_radius,
<a name="l03192"></a>03192                                     <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> <span class="keyword">const</span>&amp; gradx,
<a name="l03193"></a>03193                                     <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> <span class="keyword">const</span>&amp; grady,
<a name="l03194"></a>03194                                     <span class="keyword">const</span> <span class="keywordtype">float</span> range, <span class="keyword">const</span> <span class="keywordtype">unsigned</span> bins)
<a name="l03195"></a>03195 {
<a name="l03196"></a>03196   bsta_histogram&lt;float&gt; hg(range, bins);
<a name="l03197"></a>03197   <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">float</span> deg_rad = (float)(vnl_math::deg_per_rad);
<a name="l03198"></a>03198   <span class="keywordtype">int</span> ir = <span class="keyword">static_cast&lt;</span><span class="keywordtype">int</span><span class="keyword">&gt;</span>(i_radius), jr = static_cast&lt;int&gt;(j_radius);
<a name="l03199"></a>03199   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> dj = -jr; dj&lt;=jr; ++dj)
<a name="l03200"></a>03200     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> di = -ir; di&lt;=ir; ++di)
<a name="l03201"></a>03201     {
<a name="l03202"></a>03202       <span class="keywordtype">float</span> Ix = gradx(i+di, j+dj), Iy = grady(i+di, j+dj);
<a name="l03203"></a>03203       <span class="keywordtype">float</span> ang = deg_rad*vcl_atan2(Iy, Ix) + 180.0f;
<a name="l03204"></a>03204       <span class="keywordtype">float</span> mag = vcl_abs(Ix)+vcl_abs(Iy);
<a name="l03205"></a>03205       hg.upcount(ang, mag);
<a name="l03206"></a>03206     }
<a name="l03207"></a>03207   <span class="keywordflow">return</span> hg.entropy();
<a name="l03208"></a>03208 }
<a name="l03209"></a>03209 
<a name="l03210"></a>03210 <span class="comment">//: Compute the hue and saturation entropy of a region about the specified pixel</span>
<a name="l03211"></a><a class="code" href="classbrip__vil__float__ops.html#a5188ad320607f60e41a241c1d4bdd3d8">03211</a> <span class="comment">//  Note no bounds checking!</span>
<a name="l03212"></a>03212 <span class="keywordtype">float</span> <a class="code" href="classbrip__vil__float__ops.html#a5188ad320607f60e41a241c1d4bdd3d8" title="Compute the hue and saturation entropy of a region about the specified pixel.">brip_vil_float_ops::entropy_hs</a>(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> i, <span class="keyword">const</span> <span class="keywordtype">unsigned</span> j,
<a name="l03213"></a>03213                                      <span class="keyword">const</span> <span class="keywordtype">unsigned</span> i_radius,
<a name="l03214"></a>03214                                      <span class="keyword">const</span> <span class="keywordtype">unsigned</span> j_radius,
<a name="l03215"></a>03215                                      <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> <span class="keyword">const</span>&amp; hue,
<a name="l03216"></a>03216                                      <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> <span class="keyword">const</span>&amp; sat,
<a name="l03217"></a>03217                                      <span class="keyword">const</span> <span class="keywordtype">float</span> range, <span class="keyword">const</span> <span class="keywordtype">unsigned</span> bins)
<a name="l03218"></a>03218 {
<a name="l03219"></a>03219   bsta_histogram&lt;float&gt; hg(range, bins);
<a name="l03220"></a>03220   <span class="keywordtype">int</span> ir = <span class="keyword">static_cast&lt;</span><span class="keywordtype">int</span><span class="keyword">&gt;</span>(i_radius), jr = static_cast&lt;int&gt;(j_radius);
<a name="l03221"></a>03221   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> dj = -jr; dj&lt;=jr; ++dj)
<a name="l03222"></a>03222     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> di = -ir; di&lt;=ir; ++di)
<a name="l03223"></a>03223     {
<a name="l03224"></a>03224       <span class="keywordtype">float</span> h = hue(i+di, j+dj), s = sat(i+di, j+dj);
<a name="l03225"></a>03225       hg.upcount(h, s);
<a name="l03226"></a>03226     }
<a name="l03227"></a>03227   <span class="keywordflow">return</span> hg.entropy();
<a name="l03228"></a>03228 }
<a name="l03229"></a>03229 
<a name="l03230"></a><a class="code" href="classbrip__vil__float__ops.html#ae1a2bc53cc81305fde6af9b890ff460a">03230</a> <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a>
<a name="l03231"></a>03231 <a class="code" href="classbrip__vil__float__ops.html#ae1a2bc53cc81305fde6af9b890ff460a" title="Compute the entropy of the specified region about each pixel.">brip_vil_float_ops::entropy</a>(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> i_radius,
<a name="l03232"></a>03232                             <span class="keyword">const</span> <span class="keywordtype">unsigned</span> j_radius,
<a name="l03233"></a>03233                             <span class="keyword">const</span> <span class="keywordtype">unsigned</span> step,
<a name="l03234"></a>03234                             <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__smart__ptr.html">vil_image_resource_sptr</a> <span class="keyword">const</span>&amp; img,
<a name="l03235"></a>03235                             <span class="keyword">const</span> <span class="keywordtype">float</span> sigma,
<a name="l03236"></a>03236                             <span class="keyword">const</span> <span class="keywordtype">bool</span> intensity,
<a name="l03237"></a>03237                             <span class="keyword">const</span> <span class="keywordtype">bool</span> gradient,
<a name="l03238"></a>03238                             <span class="keyword">const</span> <span class="keywordtype">bool</span> ihs)
<a name="l03239"></a>03239 {
<a name="l03240"></a>03240   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> ent;
<a name="l03241"></a>03241   <span class="keywordflow">if</span> (!intensity&amp;&amp;!gradient&amp;&amp;!ihs)
<a name="l03242"></a>03242   {
<a name="l03243"></a>03243     vcl_cout &lt;&lt; <span class="stringliteral">&quot;In brip_vil_float_ops::entropy(.) - No computation to do\n&quot;</span>;
<a name="l03244"></a>03244     <span class="keywordflow">return</span> ent;
<a name="l03245"></a>03245   }
<a name="l03246"></a>03246 
<a name="l03247"></a>03247   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> fimage = <a class="code" href="classbrip__vil__float__ops.html#afc428b73d4f323a495252b0f5cb30a20" title="converts a vil_image_resource to a float image.">brip_vil_float_ops::convert_to_float</a>(img);
<a name="l03248"></a>03248   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> gimage =
<a name="l03249"></a>03249     <a class="code" href="classbrip__vil__float__ops.html#a2c82165db7e252f7b843f61f5856dc3f" title="convolves with a Gaussian kernel.">brip_vil_float_ops::gaussian</a>(fimage, sigma);
<a name="l03250"></a>03250 
<a name="l03251"></a>03251   <span class="keywordtype">unsigned</span> ni = img-&gt;ni(), nj = img-&gt;nj();
<a name="l03252"></a>03252   ent.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html#a9c01939f01ef50314620e26aaacb04d3">set_size</a>(ni/step+1, nj/step+1);
<a name="l03253"></a>03253   ent.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html#a6fd591632020e490abb5e4493a52dbba">fill</a>(0.0f);
<a name="l03254"></a>03254   <span class="keywordflow">if</span> (intensity)
<a name="l03255"></a>03255     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> j = j_radius; j&lt;(nj-j_radius); j+=step)
<a name="l03256"></a>03256       <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> i = i_radius; i&lt;(ni-i_radius); i+=step)
<a name="l03257"></a>03257         ent(i/step,j/step) =
<a name="l03258"></a>03258           <a class="code" href="classbrip__vil__float__ops.html#a385b81e29541c44ac52d1f66186a0ea6" title="Compute the intensity entropy of a region about the specified pixel.">brip_vil_float_ops::entropy_i</a>(i, j, i_radius, j_radius, gimage);
<a name="l03259"></a>03259 
<a name="l03260"></a>03260   <span class="keywordflow">if</span> (gradient)
<a name="l03261"></a>03261   {
<a name="l03262"></a>03262     <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> grad_x, grad_y;
<a name="l03263"></a>03263     grad_x.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html#a9c01939f01ef50314620e26aaacb04d3">set_size</a>(ni, nj);
<a name="l03264"></a>03264     grad_y.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html#a9c01939f01ef50314620e26aaacb04d3">set_size</a>(ni, nj);
<a name="l03265"></a>03265     <a class="code" href="classbrip__vil__float__ops.html#a45ba9abd34128197b97a74ecfe18f50f" title="Returns the gradient using a 3x3 kernel.">brip_vil_float_ops::gradient_3x3</a> (gimage , grad_x , grad_y);
<a name="l03266"></a>03266     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> j = j_radius; j&lt;(nj-j_radius); j+=step)
<a name="l03267"></a>03267       <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> i = i_radius; i&lt;(ni-i_radius); i+=step)
<a name="l03268"></a>03268         ent(i/step,j/step) +=
<a name="l03269"></a>03269           <a class="code" href="classbrip__vil__float__ops.html#a7fcbd6e787b882f6064cb9679c7b0aed" title="Compute the gradient entropy of a region about the specified pixel.">brip_vil_float_ops::entropy_g</a>(i, j, i_radius, j_radius,
<a name="l03270"></a>03270                                         grad_x, grad_y);
<a name="l03271"></a>03271   }
<a name="l03272"></a>03272   <span class="keywordflow">if</span> (ihs&amp;&amp;img-&gt;nplanes()==3)
<a name="l03273"></a>03273   {
<a name="l03274"></a>03274     <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> inten, hue, sat;
<a name="l03275"></a>03275     <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;vil_rgb&lt;vxl_byte&gt;</a> &gt; cimage = img-&gt;get_view();
<a name="l03276"></a>03276     <a class="code" href="classbrip__vil__float__ops.html#acd65ba88ab8574e43a06ab7e1757e9f3" title="converts a byte-pixel color image to float (I,H,S) image triple.">brip_vil_float_ops::convert_to_IHS</a>(cimage, inten, hue, sat);
<a name="l03277"></a>03277     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> j = j_radius; j&lt;(nj-j_radius); j+=step)
<a name="l03278"></a>03278       <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> i = i_radius; i&lt;(ni-i_radius); i+=step)
<a name="l03279"></a>03279         ent(i/step,j/step) +=
<a name="l03280"></a>03280           <a class="code" href="classbrip__vil__float__ops.html#a5188ad320607f60e41a241c1d4bdd3d8" title="Compute the hue and saturation entropy of a region about the specified pixel.">brip_vil_float_ops::entropy_hs</a>(i, j, i_radius, j_radius,
<a name="l03281"></a>03281                                          hue, sat);
<a name="l03282"></a>03282   }
<a name="l03283"></a>03283   <span class="keywordflow">return</span> ent;
<a name="l03284"></a>03284 }
<a name="l03285"></a><a class="code" href="classbrip__vil__float__ops.html#aa6f309f8d63cf37a48cccb5d897fb6a3">03285</a> 
<a name="l03286"></a>03286 <span class="keywordtype">float</span> <a class="code" href="classbrip__vil__float__ops.html#aa6f309f8d63cf37a48cccb5d897fb6a3" title="Compute the intensity minfo of a region about the specified pixel.">brip_vil_float_ops::minfo_i</a>(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> i0, <span class="keyword">const</span> <span class="keywordtype">unsigned</span> j0,
<a name="l03287"></a>03287                                   <span class="keyword">const</span> <span class="keywordtype">unsigned</span> i1, <span class="keyword">const</span> <span class="keywordtype">unsigned</span> j1,
<a name="l03288"></a>03288                                   <span class="keyword">const</span> <span class="keywordtype">unsigned</span> i_radius,
<a name="l03289"></a>03289                                   <span class="keyword">const</span> <span class="keywordtype">unsigned</span> j_radius,
<a name="l03290"></a>03290                                   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> <span class="keyword">const</span>&amp; int0,
<a name="l03291"></a>03291                                   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> <span class="keyword">const</span>&amp; int1,
<a name="l03292"></a>03292                                   <span class="keyword">const</span> <span class="keywordtype">float</span> range, <span class="keyword">const</span> <span class="keywordtype">unsigned</span> bins)
<a name="l03293"></a>03293 {
<a name="l03294"></a>03294   bsta_histogram&lt;float&gt; hi0(range, bins);
<a name="l03295"></a>03295   bsta_histogram&lt;float&gt; hi1(range, bins);
<a name="l03296"></a>03296   bsta_joint_histogram&lt;float&gt; hji(range, bins);
<a name="l03297"></a>03297   <span class="keywordtype">int</span> ir = <span class="keyword">static_cast&lt;</span><span class="keywordtype">int</span><span class="keyword">&gt;</span>(i_radius), jr = static_cast&lt;int&gt;(j_radius);
<a name="l03298"></a>03298   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> dj = -jr; dj&lt;=jr; ++dj)
<a name="l03299"></a>03299     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> di = -ir; di&lt;=ir; ++di)
<a name="l03300"></a>03300     {
<a name="l03301"></a>03301       <span class="keywordtype">float</span> inten0 = int0(i0+di, j0+dj);
<a name="l03302"></a>03302       <span class="keywordtype">float</span> inten1 = int1(i1+di, j1+dj);
<a name="l03303"></a>03303       hi0.upcount(inten0, 1.0f);
<a name="l03304"></a>03304       hi1.upcount(inten1, 1.0f);
<a name="l03305"></a>03305       hji.upcount(inten0, 1.0f, inten1, 1.0f);
<a name="l03306"></a>03306     }
<a name="l03307"></a>03307   <span class="keywordtype">float</span> H0 = hi0.entropy();
<a name="l03308"></a>03308   <span class="keywordtype">float</span> H1 = hi1.entropy();
<a name="l03309"></a>03309   <span class="keywordtype">float</span> HJ = hji.entropy();
<a name="l03310"></a>03310   <span class="keywordtype">float</span> <a class="code" href="classbrip__vil__float__ops.html#aa6f309f8d63cf37a48cccb5d897fb6a3" title="Compute the intensity minfo of a region about the specified pixel.">minfo_i</a> = H0 + H1 - HJ;
<a name="l03311"></a>03311 <span class="preprocessor">#ifdef DEBUG</span>
<a name="l03312"></a>03312 <span class="preprocessor"></span>  <span class="keywordflow">if</span> (<a class="code" href="classbrip__vil__float__ops.html#a25df0224a3b1d59d26665ecf3a0ab0f3" title="Compute the minfo of the specified region about each pixel.">minfo</a>&lt;0)
<a name="l03313"></a>03313     vcl_cout &lt;&lt; <span class="stringliteral">&quot;intensity MI LT 0 &quot;</span> &lt;&lt; <a class="code" href="classbrip__vil__float__ops.html#a25df0224a3b1d59d26665ecf3a0ab0f3" title="Compute the minfo of the specified region about each pixel.">minfo</a> &lt;&lt; vcl_endl;
<a name="l03314"></a>03314 <span class="preprocessor">#endif</span>
<a name="l03315"></a>03315 <span class="preprocessor"></span>  <span class="keywordflow">return</span> <a class="code" href="classbrip__vil__float__ops.html#aa6f309f8d63cf37a48cccb5d897fb6a3" title="Compute the intensity minfo of a region about the specified pixel.">minfo_i</a>;
<a name="l03316"></a>03316 }
<a name="l03317"></a><a class="code" href="classbrip__vil__float__ops.html#ae00c6a583f02b727ce6ef2bc9c1bdfa4">03317</a> 
<a name="l03318"></a>03318 <span class="keywordtype">float</span> <a class="code" href="classbrip__vil__float__ops.html#ae00c6a583f02b727ce6ef2bc9c1bdfa4" title="Compute the gradient minfo of a region about the specified pixel.">brip_vil_float_ops::minfo_g</a>(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> i0, <span class="keyword">const</span> <span class="keywordtype">unsigned</span> j0,
<a name="l03319"></a>03319                                   <span class="keyword">const</span> <span class="keywordtype">unsigned</span> i1, <span class="keyword">const</span> <span class="keywordtype">unsigned</span> j1,
<a name="l03320"></a>03320                                   <span class="keyword">const</span> <span class="keywordtype">unsigned</span> i_radius,
<a name="l03321"></a>03321                                   <span class="keyword">const</span> <span class="keywordtype">unsigned</span> j_radius,
<a name="l03322"></a>03322                                   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> <span class="keyword">const</span>&amp; gradx0,
<a name="l03323"></a>03323                                   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> <span class="keyword">const</span>&amp; grady0,
<a name="l03324"></a>03324                                   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> <span class="keyword">const</span>&amp; gradx1,
<a name="l03325"></a>03325                                   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> <span class="keyword">const</span>&amp; grady1,
<a name="l03326"></a>03326                                   <span class="keyword">const</span> <span class="keywordtype">float</span> range, <span class="keyword">const</span> <span class="keywordtype">unsigned</span> bins)
<a name="l03327"></a>03327 {
<a name="l03328"></a>03328   bsta_histogram&lt;float&gt; hg0(range, bins);
<a name="l03329"></a>03329   bsta_histogram&lt;float&gt; hg1(range, bins);
<a name="l03330"></a>03330   bsta_joint_histogram&lt;float&gt; hjg(range, bins);
<a name="l03331"></a>03331   <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">float</span> deg_rad = (float)(vnl_math::deg_per_rad);
<a name="l03332"></a>03332   <span class="keywordtype">int</span> ir = <span class="keyword">static_cast&lt;</span><span class="keywordtype">int</span><span class="keyword">&gt;</span>(i_radius), jr = static_cast&lt;int&gt;(j_radius);
<a name="l03333"></a>03333   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> dj = -jr; dj&lt;=jr; ++dj)
<a name="l03334"></a>03334     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> di = -ir; di&lt;=ir; ++di)
<a name="l03335"></a>03335     {
<a name="l03336"></a>03336       <span class="keywordtype">float</span> Ix0 = gradx0(i0+di, j0+dj), Iy0 = grady0(i0+di, j0+dj);
<a name="l03337"></a>03337       <span class="keywordtype">float</span> Ix1 = gradx1(i1+di, j1+dj), Iy1 = grady1(i1+di, j1+dj);
<a name="l03338"></a>03338       <span class="keywordtype">float</span> ang0 = deg_rad*vcl_atan2(Iy0, Ix0) + 180.0f;
<a name="l03339"></a>03339       <span class="keywordtype">float</span> ang1 = deg_rad*vcl_atan2(Iy1, Ix1) + 180.0f;
<a name="l03340"></a>03340       <span class="keywordtype">float</span> mag0 = vcl_abs(Ix0)+vcl_abs(Iy0);
<a name="l03341"></a>03341       <span class="keywordtype">float</span> mag1 = vcl_abs(Ix1)+vcl_abs(Iy1);
<a name="l03342"></a>03342       hg0.upcount(ang0, mag0);
<a name="l03343"></a>03343       hg1.upcount(ang1, mag1);
<a name="l03344"></a>03344       hjg.upcount(ang0, mag0, ang1, mag1);
<a name="l03345"></a>03345     }
<a name="l03346"></a>03346   <span class="keywordtype">float</span> H0 = hg0.entropy();
<a name="l03347"></a>03347   <span class="keywordtype">float</span> H1 = hg1.entropy();
<a name="l03348"></a>03348   <span class="keywordtype">float</span> HJ = hjg.entropy();
<a name="l03349"></a>03349   <span class="keywordtype">float</span> <a class="code" href="classbrip__vil__float__ops.html#ae00c6a583f02b727ce6ef2bc9c1bdfa4" title="Compute the gradient minfo of a region about the specified pixel.">minfo_g</a> = H0 + H1 - HJ;
<a name="l03350"></a>03350 <span class="preprocessor">#ifdef DEBUG</span>
<a name="l03351"></a>03351 <span class="preprocessor"></span>  <span class="keywordflow">if</span> (<a class="code" href="classbrip__vil__float__ops.html#a25df0224a3b1d59d26665ecf3a0ab0f3" title="Compute the minfo of the specified region about each pixel.">minfo</a>&lt;0)
<a name="l03352"></a>03352     vcl_cout &lt;&lt; <span class="stringliteral">&quot;gradient MI LT 0 &quot;</span> &lt;&lt; <a class="code" href="classbrip__vil__float__ops.html#a25df0224a3b1d59d26665ecf3a0ab0f3" title="Compute the minfo of the specified region about each pixel.">minfo</a> &lt;&lt; vcl_endl;
<a name="l03353"></a>03353 <span class="preprocessor">#endif</span>
<a name="l03354"></a>03354 <span class="preprocessor"></span>  <span class="keywordflow">return</span> <a class="code" href="classbrip__vil__float__ops.html#ae00c6a583f02b727ce6ef2bc9c1bdfa4" title="Compute the gradient minfo of a region about the specified pixel.">minfo_g</a>;
<a name="l03355"></a>03355 }
<a name="l03356"></a><a class="code" href="classbrip__vil__float__ops.html#a35da27af608d795160f5ee4317cda68c">03356</a> 
<a name="l03357"></a>03357 <span class="keywordtype">float</span> <a class="code" href="classbrip__vil__float__ops.html#a35da27af608d795160f5ee4317cda68c" title="Compute the hue and saturation minfo of a region about the specified pixel.">brip_vil_float_ops::minfo_hs</a>(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> i0, <span class="keyword">const</span> <span class="keywordtype">unsigned</span> j0,
<a name="l03358"></a>03358                                    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> i1, <span class="keyword">const</span> <span class="keywordtype">unsigned</span> j1,
<a name="l03359"></a>03359                                    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> i_radius,
<a name="l03360"></a>03360                                    <span class="keyword">const</span> <span class="keywordtype">unsigned</span> j_radius,
<a name="l03361"></a>03361                                    <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> <span class="keyword">const</span>&amp; hue0,
<a name="l03362"></a>03362                                    <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> <span class="keyword">const</span>&amp; sat0,
<a name="l03363"></a>03363                                    <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> <span class="keyword">const</span>&amp; hue1,
<a name="l03364"></a>03364                                    <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> <span class="keyword">const</span>&amp; sat1,
<a name="l03365"></a>03365                                    <span class="keyword">const</span> <span class="keywordtype">float</span> range, <span class="keyword">const</span> <span class="keywordtype">unsigned</span> bins)
<a name="l03366"></a>03366 {
<a name="l03367"></a>03367   bsta_histogram&lt;float&gt; hh0(range, bins);
<a name="l03368"></a>03368   bsta_histogram&lt;float&gt; hh1(range, bins);
<a name="l03369"></a>03369   bsta_joint_histogram&lt;float&gt; hjh(range, bins);
<a name="l03370"></a>03370   <span class="keywordtype">int</span> ir = <span class="keyword">static_cast&lt;</span><span class="keywordtype">int</span><span class="keyword">&gt;</span>(i_radius), jr = static_cast&lt;int&gt;(j_radius);
<a name="l03371"></a>03371   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> dj = -jr; dj&lt;=jr; ++dj)
<a name="l03372"></a>03372     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> di = -ir; di&lt;=ir; ++di)
<a name="l03373"></a>03373     {
<a name="l03374"></a>03374       <span class="keywordtype">float</span> h0 = hue0(i0+di, j0+dj), s0 = sat0(i0+di, j0+dj);
<a name="l03375"></a>03375       <span class="keywordtype">float</span> h1 = hue1(i1+di, j1+dj), s1 = sat1(i1+di, j1+dj);
<a name="l03376"></a>03376       hh0.upcount(h0, s0);
<a name="l03377"></a>03377       hh1.upcount(h1, s1);
<a name="l03378"></a>03378       hjh.upcount(h0, s0, h1, s1);
<a name="l03379"></a>03379     }
<a name="l03380"></a>03380   <span class="keywordtype">float</span> H0 = hh0.entropy();
<a name="l03381"></a>03381   <span class="keywordtype">float</span> H1 = hh1.entropy();
<a name="l03382"></a>03382   <span class="keywordtype">float</span> HJ = hjh.entropy();
<a name="l03383"></a>03383   <span class="keywordtype">float</span> minfo_h = H0 + H1 - HJ;
<a name="l03384"></a>03384 <span class="preprocessor">#ifdef DEBUG</span>
<a name="l03385"></a>03385 <span class="preprocessor"></span>  <span class="keywordflow">if</span> (<a class="code" href="classbrip__vil__float__ops.html#a25df0224a3b1d59d26665ecf3a0ab0f3" title="Compute the minfo of the specified region about each pixel.">minfo</a>&lt;0)
<a name="l03386"></a>03386     vcl_cout &lt;&lt; <span class="stringliteral">&quot;color MI LT 0 &quot;</span> &lt;&lt; <a class="code" href="classbrip__vil__float__ops.html#a25df0224a3b1d59d26665ecf3a0ab0f3" title="Compute the minfo of the specified region about each pixel.">minfo</a> &lt;&lt; vcl_endl;
<a name="l03387"></a>03387 <span class="preprocessor">#endif</span>
<a name="l03388"></a>03388 <span class="preprocessor"></span>  <span class="keywordflow">return</span> minfo_h;
<a name="l03389"></a>03389 }
<a name="l03390"></a><a class="code" href="classbrip__vil__float__ops.html#a25df0224a3b1d59d26665ecf3a0ab0f3">03390</a> 
<a name="l03391"></a>03391 <span class="keywordtype">bool</span> <a class="code" href="classbrip__vil__float__ops.html#a25df0224a3b1d59d26665ecf3a0ab0f3" title="Compute the minfo of the specified region about each pixel.">brip_vil_float_ops::minfo</a>(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> i_radius,
<a name="l03392"></a>03392                                <span class="keyword">const</span> <span class="keywordtype">unsigned</span> j_radius,
<a name="l03393"></a>03393                                <span class="keyword">const</span> <span class="keywordtype">unsigned</span> step,
<a name="l03394"></a>03394                                <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__smart__ptr.html">vil_image_resource_sptr</a> <span class="keyword">const</span>&amp; img0,
<a name="l03395"></a>03395                                <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__smart__ptr.html">vil_image_resource_sptr</a> <span class="keyword">const</span>&amp; img1,
<a name="l03396"></a>03396                                <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a>&amp; MI0,
<a name="l03397"></a>03397                                <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a>&amp; MI1,
<a name="l03398"></a>03398                                <span class="keyword">const</span> <span class="keywordtype">float</span> sigma,
<a name="l03399"></a>03399                                <span class="keyword">const</span> <span class="keywordtype">bool</span> intensity,
<a name="l03400"></a>03400                                <span class="keyword">const</span> <span class="keywordtype">bool</span> gradient,
<a name="l03401"></a>03401                                <span class="keyword">const</span> <span class="keywordtype">bool</span> ihs)
<a name="l03402"></a>03402 {
<a name="l03403"></a>03403   <span class="keywordflow">if</span> (!intensity&amp;&amp;!gradient&amp;&amp;!ihs)
<a name="l03404"></a>03404   {
<a name="l03405"></a>03405     vcl_cout &lt;&lt; <span class="stringliteral">&quot;In brip_vil_float_ops::minforopy(.) - No computation to do\n&quot;</span>;
<a name="l03406"></a>03406     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l03407"></a>03407   }
<a name="l03408"></a>03408 
<a name="l03409"></a>03409   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> fimage0 = <a class="code" href="classbrip__vil__float__ops.html#afc428b73d4f323a495252b0f5cb30a20" title="converts a vil_image_resource to a float image.">brip_vil_float_ops::convert_to_float</a>(img0);
<a name="l03410"></a>03410   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> gimage0 =
<a name="l03411"></a>03411     <a class="code" href="classbrip__vil__float__ops.html#a2c82165db7e252f7b843f61f5856dc3f" title="convolves with a Gaussian kernel.">brip_vil_float_ops::gaussian</a>(fimage0, sigma);
<a name="l03412"></a>03412 
<a name="l03413"></a>03413   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> fimage1 = <a class="code" href="classbrip__vil__float__ops.html#afc428b73d4f323a495252b0f5cb30a20" title="converts a vil_image_resource to a float image.">brip_vil_float_ops::convert_to_float</a>(img1);
<a name="l03414"></a>03414   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> gimage1 =
<a name="l03415"></a>03415     <a class="code" href="classbrip__vil__float__ops.html#a2c82165db7e252f7b843f61f5856dc3f" title="convolves with a Gaussian kernel.">brip_vil_float_ops::gaussian</a>(fimage1, sigma);
<a name="l03416"></a>03416 
<a name="l03417"></a>03417   <span class="keywordtype">unsigned</span> ni0 = img0-&gt;ni(), nj0 = img0-&gt;nj();
<a name="l03418"></a>03418   <span class="keywordtype">unsigned</span> ni1 = img1-&gt;ni(), nj1 = img1-&gt;nj();
<a name="l03419"></a>03419   <span class="keywordtype">unsigned</span> ilimit = 2*i_radius +1, jlimit = 2*j_radius+1;
<a name="l03420"></a>03420   <span class="keywordflow">if</span> (ni0&lt;ilimit||nj0&lt;jlimit||ni1&lt;ilimit||nj1&lt;jlimit)
<a name="l03421"></a>03421   {
<a name="l03422"></a>03422     vcl_cout &lt;&lt; <span class="stringliteral">&quot;In brip_vil_float_ops::minfo(...) - image too small\n&quot;</span>;
<a name="l03423"></a>03423     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l03424"></a>03424   }
<a name="l03425"></a>03425   MI0.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html#a9c01939f01ef50314620e26aaacb04d3">set_size</a>(ni0/step+1, nj0/step+1); MI0.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html#a6fd591632020e490abb5e4493a52dbba">fill</a>(0.0f);
<a name="l03426"></a>03426   MI1.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html#a9c01939f01ef50314620e26aaacb04d3">set_size</a>(ni1/step+1, nj1/step+1); MI1.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html#a6fd591632020e490abb5e4493a52dbba">fill</a>(0.0f);
<a name="l03427"></a>03427   <span class="keywordflow">if</span> (intensity)
<a name="l03428"></a>03428     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> j0 = j_radius; j0&lt;(nj0-j_radius); j0+=step)
<a name="l03429"></a>03429       <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> i0 = i_radius; i0&lt;(ni0-i_radius); i0+=step)
<a name="l03430"></a>03430         <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> j1 = j_radius; j1&lt;(nj1-j_radius); j1+=step)
<a name="l03431"></a>03431           <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> i1 = i_radius; i1&lt;(ni1-i_radius); i1+=step)
<a name="l03432"></a>03432           {
<a name="l03433"></a>03433             <span class="keywordtype">float</span> <a class="code" href="classbrip__vil__float__ops.html#a25df0224a3b1d59d26665ecf3a0ab0f3" title="Compute the minfo of the specified region about each pixel.">minfo</a> = <a class="code" href="classbrip__vil__float__ops.html#aa6f309f8d63cf37a48cccb5d897fb6a3" title="Compute the intensity minfo of a region about the specified pixel.">brip_vil_float_ops::minfo_i</a>(i0, j0,i1, j1,
<a name="l03434"></a>03434                                                       i_radius, j_radius,
<a name="l03435"></a>03435                                                       gimage0, gimage1);
<a name="l03436"></a>03436             MI0(i0/step,j0/step) = <a class="code" href="classbrip__vil__float__ops.html#a25df0224a3b1d59d26665ecf3a0ab0f3" title="Compute the minfo of the specified region about each pixel.">minfo</a>;
<a name="l03437"></a>03437             MI1(i1/step,j1/step) = <a class="code" href="classbrip__vil__float__ops.html#a25df0224a3b1d59d26665ecf3a0ab0f3" title="Compute the minfo of the specified region about each pixel.">minfo</a>;
<a name="l03438"></a>03438           }
<a name="l03439"></a>03439   <span class="keywordflow">if</span> (gradient)
<a name="l03440"></a>03440   {
<a name="l03441"></a>03441     <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> grad_x0, grad_y0, grad_x1, grad_y1;
<a name="l03442"></a>03442     grad_x0.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html#a9c01939f01ef50314620e26aaacb04d3">set_size</a>(ni0, nj0);
<a name="l03443"></a>03443     grad_y0.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html#a9c01939f01ef50314620e26aaacb04d3">set_size</a>(ni0, nj0);
<a name="l03444"></a>03444     grad_x1.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html#a9c01939f01ef50314620e26aaacb04d3">set_size</a>(ni1, nj1);
<a name="l03445"></a>03445     grad_y1.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html#a9c01939f01ef50314620e26aaacb04d3">set_size</a>(ni1, nj1);
<a name="l03446"></a>03446     <a class="code" href="classbrip__vil__float__ops.html#a45ba9abd34128197b97a74ecfe18f50f" title="Returns the gradient using a 3x3 kernel.">brip_vil_float_ops::gradient_3x3</a> (gimage0 , grad_x0 , grad_y0);
<a name="l03447"></a>03447     <a class="code" href="classbrip__vil__float__ops.html#a45ba9abd34128197b97a74ecfe18f50f" title="Returns the gradient using a 3x3 kernel.">brip_vil_float_ops::gradient_3x3</a> (gimage1 , grad_x1 , grad_y1);
<a name="l03448"></a>03448     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> j0 = j_radius; j0&lt;(nj0-j_radius); j0+=step)
<a name="l03449"></a>03449       <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> i0 = i_radius; i0&lt;(ni0-i_radius); i0+=step)
<a name="l03450"></a>03450         <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> j1 = j_radius; j1&lt;(nj1-j_radius); j1+=step)
<a name="l03451"></a>03451           <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> i1 = i_radius; i1&lt;(ni1-i_radius); i1+=step)
<a name="l03452"></a>03452           {
<a name="l03453"></a>03453             <span class="keywordtype">float</span> <a class="code" href="classbrip__vil__float__ops.html#a25df0224a3b1d59d26665ecf3a0ab0f3" title="Compute the minfo of the specified region about each pixel.">minfo</a> = <a class="code" href="classbrip__vil__float__ops.html#ae00c6a583f02b727ce6ef2bc9c1bdfa4" title="Compute the gradient minfo of a region about the specified pixel.">brip_vil_float_ops::minfo_g</a>(i0, j0,i1, j1,
<a name="l03454"></a>03454                                                       i_radius, j_radius,
<a name="l03455"></a>03455                                                       grad_x0, grad_y0,
<a name="l03456"></a>03456                                                       grad_x1, grad_y1);
<a name="l03457"></a>03457             MI0(i0/step,j0/step) += <a class="code" href="classbrip__vil__float__ops.html#a25df0224a3b1d59d26665ecf3a0ab0f3" title="Compute the minfo of the specified region about each pixel.">minfo</a>;
<a name="l03458"></a>03458             MI1(i1/step,j1/step) += <a class="code" href="classbrip__vil__float__ops.html#a25df0224a3b1d59d26665ecf3a0ab0f3" title="Compute the minfo of the specified region about each pixel.">minfo</a>;
<a name="l03459"></a>03459           }
<a name="l03460"></a>03460   }
<a name="l03461"></a>03461   <span class="keywordflow">if</span> (ihs&amp;&amp;img0-&gt;nplanes()==3&amp;&amp;img1-&gt;nplanes()==3)
<a name="l03462"></a>03462   {
<a name="l03463"></a>03463     <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> inten0, hue0, sat0;
<a name="l03464"></a>03464     <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> inten1, hue1, sat1;
<a name="l03465"></a>03465     <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;vil_rgb&lt;vxl_byte&gt;</a> &gt; cimage0 = img0-&gt;get_view();
<a name="l03466"></a>03466     <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;vil_rgb&lt;vxl_byte&gt;</a> &gt; cimage1 = img1-&gt;get_view();
<a name="l03467"></a>03467     <a class="code" href="classbrip__vil__float__ops.html#acd65ba88ab8574e43a06ab7e1757e9f3" title="converts a byte-pixel color image to float (I,H,S) image triple.">brip_vil_float_ops::convert_to_IHS</a>(cimage0, inten0, hue0, sat0);
<a name="l03468"></a>03468     <a class="code" href="classbrip__vil__float__ops.html#acd65ba88ab8574e43a06ab7e1757e9f3" title="converts a byte-pixel color image to float (I,H,S) image triple.">brip_vil_float_ops::convert_to_IHS</a>(cimage1, inten1, hue1, sat1);
<a name="l03469"></a>03469 
<a name="l03470"></a>03470     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> j0 = j_radius; j0&lt;(nj0-j_radius); j0+=step)
<a name="l03471"></a>03471       <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> i0 = i_radius; i0&lt;(ni0-i_radius); i0+=step)
<a name="l03472"></a>03472         <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> j1 = j_radius; j1&lt;(nj1-j_radius); j1+=step)
<a name="l03473"></a>03473           <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> i1 = i_radius; i1&lt;(ni1-i_radius); i1+=step)
<a name="l03474"></a>03474           {
<a name="l03475"></a>03475             <span class="keywordtype">float</span> <a class="code" href="classbrip__vil__float__ops.html#a25df0224a3b1d59d26665ecf3a0ab0f3" title="Compute the minfo of the specified region about each pixel.">minfo</a> = <a class="code" href="classbrip__vil__float__ops.html#a35da27af608d795160f5ee4317cda68c" title="Compute the hue and saturation minfo of a region about the specified pixel.">brip_vil_float_ops::minfo_hs</a>(i0, j0,i1, j1,
<a name="l03476"></a>03476                                                        i_radius, j_radius,
<a name="l03477"></a>03477                                                        hue0, sat0,
<a name="l03478"></a>03478                                                        hue1, sat1);
<a name="l03479"></a>03479             MI0(i0/step,j0/step) += <a class="code" href="classbrip__vil__float__ops.html#a25df0224a3b1d59d26665ecf3a0ab0f3" title="Compute the minfo of the specified region about each pixel.">minfo</a>;
<a name="l03480"></a>03480             MI1(i1/step,j1/step) += <a class="code" href="classbrip__vil__float__ops.html#a25df0224a3b1d59d26665ecf3a0ab0f3" title="Compute the minfo of the specified region about each pixel.">minfo</a>;
<a name="l03481"></a>03481           }
<a name="l03482"></a>03482   }
<a name="l03483"></a>03483   <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l03484"></a>03484 }
<a name="l03485"></a>03485 
<a name="l03486"></a>03486 <span class="comment">// compute the average of the image intensity within the specified region</span>
<a name="l03487"></a><a class="code" href="classbrip__vil__float__ops.html#a52c0a1a77fef444f775d2c142b606045">03487</a> <span class="keywordtype">float</span> <a class="code" href="classbrip__vil__float__ops.html#a52c0a1a77fef444f775d2c142b606045" title="compute the average of the image intensity within the specified region.">brip_vil_float_ops::</a>
<a name="l03488"></a>03488 <a class="code" href="classbrip__vil__float__ops.html#a52c0a1a77fef444f775d2c142b606045" title="compute the average of the image intensity within the specified region.">average_in_box</a>(<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> <span class="keyword">const</span>&amp; v, <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__box__2d.html">vgl_box_2d&lt;double&gt;</a> <span class="keyword">const</span>&amp;  box)
<a name="l03489"></a>03489 {
<a name="l03490"></a>03490   <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__point__2d.html">vgl_point_2d&lt;double&gt;</a> p0 = box.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__box__2d.html#aa09df9eac008d5b688d35fb57df41edd">min_point</a>();
<a name="l03491"></a>03491   <span class="keywordtype">unsigned</span> i0 = <span class="keyword">static_cast&lt;</span><span class="keywordtype">unsigned</span><span class="keyword">&gt;</span>(p0.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__point__2d.html#a3d0455536dcb130f284c3eeaba1ae960">x</a>()), j0 = static_cast&lt;unsigned&gt;(p0.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__point__2d.html#a25dfe52017f7614103d028639125ff91">y</a>());
<a name="l03492"></a>03492   <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__point__2d.html">vgl_point_2d&lt;double&gt;</a> p1 = box.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__box__2d.html#ad4455601f9e5fdaf0b586d82c5cb6134">max_point</a>();
<a name="l03493"></a>03493   <span class="keywordtype">unsigned</span> i1 = <span class="keyword">static_cast&lt;</span><span class="keywordtype">unsigned</span><span class="keyword">&gt;</span>(p1.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__point__2d.html#a3d0455536dcb130f284c3eeaba1ae960">x</a>()), j1 = static_cast&lt;unsigned&gt;(p1.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__point__2d.html#a25dfe52017f7614103d028639125ff91">y</a>());
<a name="l03494"></a>03494   <span class="keywordtype">float</span> n = 0.0f;
<a name="l03495"></a>03495   <span class="keywordtype">float</span> sum = 0.0f;
<a name="l03496"></a>03496   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> i = i0; i&lt;=i1; ++i)
<a name="l03497"></a>03497     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> j = j0; j&lt;=j1; ++j, ++n)
<a name="l03498"></a>03498       sum += v(i,j);
<a name="l03499"></a>03499   <span class="keywordflow">if</span> (n&gt;0)
<a name="l03500"></a>03500     sum /= n;
<a name="l03501"></a>03501   <span class="keywordflow">return</span> <a class="code" href="classbrip__vil__float__ops.html#aa53780e68774a9005f49508d8b9a221a" title="Add two images from a general resource (forces types to be the same).">sum</a>;
<a name="l03502"></a>03502 }
<a name="l03503"></a>03503 
<a name="l03504"></a>03504 <span class="preprocessor">#if 0 // For now remove dependency on vimt. Save for illustration</span>
<a name="l03505"></a>03505 <span class="preprocessor"></span><span class="keywordtype">bool</span> brip_vil_float_ops::vimt_homography(<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> <span class="keyword">const</span>&amp; curr_view,
<a name="l03506"></a>03506                                          <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__h__matrix__2d.html">vgl_h_matrix_2d&lt;double&gt;</a><span class="keyword">const</span>&amp; H,
<a name="l03507"></a>03507                                          <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a>&amp; output)
<a name="l03508"></a>03508 {
<a name="l03509"></a>03509   <span class="keywordtype">int</span> bimg_ni;
<a name="l03510"></a>03510   <span class="keywordtype">int</span> bimg_nj;
<a name="l03511"></a>03511 
<a name="l03512"></a>03512   <span class="keywordtype">int</span> offset_i;
<a name="l03513"></a>03513   <span class="keywordtype">int</span> offset_j;
<a name="l03514"></a>03514 
<a name="l03515"></a>03515   <a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__bounding__box.html">vbl_bounding_box&lt;double,2&gt;</a> box;
<a name="l03516"></a>03516 
<a name="l03517"></a>03517   <span class="keywordtype">unsigned</span> ni =  curr_view.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a9ea9ad565387a61dccf38fc80a266c2a">ni</a>(), nj =  curr_view.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a44859c72206da7d18728cb2bbf8ae829">nj</a>();
<a name="l03518"></a>03518   vimt_transform_2d p;
<a name="l03519"></a>03519   <a class="codeRef" doxygen="core_vnl.tag:../../../../../core/vnl/html" href="../../../../../core/vnl/html/vnl__double__3x3_8h.html#a6f4fae33245645d430d5cf35a5ef607c">vnl_double_3x3</a> Mh = H.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__h__matrix__2d.html#a933552b4244b0c82adbe4fc498ea8690">get_matrix</a>();
<a name="l03520"></a>03520   <a class="codeRef" doxygen="core_vnl.tag:../../../../../core/vnl/html" href="../../../../../core/vnl/html/classvnl__double__2x3.html">vnl_double_2x3</a> M;
<a name="l03521"></a>03521   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> c = 0; c&lt;3; ++c)
<a name="l03522"></a>03522     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> r = 0; r&lt;2; ++r)
<a name="l03523"></a>03523       M[r][c] = Mh[r][c]/Mh[2][2];
<a name="l03524"></a>03524   p.set_affine(M);
<a name="l03525"></a>03525   box.<a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__bounding__box__base.html#a7ef4b00f7beb30bdfc05c1e98b1b595a">update</a>(p(0,0).x(),p(0,0).y());
<a name="l03526"></a>03526   box.<a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__bounding__box__base.html#a7ef4b00f7beb30bdfc05c1e98b1b595a">update</a>(p(0,nj).x(),p(0,nj).y());
<a name="l03527"></a>03527   box.<a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__bounding__box__base.html#a7ef4b00f7beb30bdfc05c1e98b1b595a">update</a>(p(ni,0).x(),p(ni,0).y());
<a name="l03528"></a>03528   box.<a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__bounding__box__base.html#a7ef4b00f7beb30bdfc05c1e98b1b595a">update</a>(p(ni,nj).x(),p(ni,nj).y());
<a name="l03529"></a>03529 
<a name="l03530"></a>03530   bimg_ni=(int)vcl_ceil(box.<a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__bounding__box__base.html#a7df29ea1406b8986ae0c0af858858539">max</a>()[0]-box.<a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__bounding__box__base.html#ac493fb109fb365b091695d3329e75ce6">min</a>()[0]);
<a name="l03531"></a>03531   bimg_nj=(int)vcl_ceil(box.<a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__bounding__box__base.html#a7df29ea1406b8986ae0c0af858858539">max</a>()[1]-box.<a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__bounding__box__base.html#ac493fb109fb365b091695d3329e75ce6">min</a>()[1]);
<a name="l03532"></a>03532 
<a name="l03533"></a>03533   offset_i=(int)vcl_ceil(0-box.<a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__bounding__box__base.html#ac493fb109fb365b091695d3329e75ce6">min</a>()[0]);
<a name="l03534"></a>03534   offset_j=(int)vcl_ceil(0-box.<a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__bounding__box__base.html#ac493fb109fb365b091695d3329e75ce6">min</a>()[1]);
<a name="l03535"></a>03535 
<a name="l03536"></a>03536   vimt_image_2d_of&lt;float&gt; sample_im;
<a name="l03537"></a>03537   <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__point__2d.html">vgl_point_2d&lt;double&gt;</a> q(-offset_i,-offset_j);
<a name="l03538"></a>03538   <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__2d.html">vgl_vector_2d&lt;double&gt;</a> u(1,0);
<a name="l03539"></a>03539   <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__2d.html">vgl_vector_2d&lt;double&gt;</a> <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/vgl__vector__2d_8h.html#a38bf1e5e0427bdeba2b469eea9befc23">v</a>(0,1);
<a name="l03540"></a>03540 
<a name="l03541"></a>03541   vimt_image_2d_of&lt;float&gt; curr_img(curr_view,p);
<a name="l03542"></a>03542   vimt_resample_bilin(curr_img,sample_im,q,u,v,bimg_ni,bimg_nj);
<a name="l03543"></a>03543   output = sample_im.image();
<a name="l03544"></a>03544   <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l03545"></a>03545 }
<a name="l03546"></a>03546 
<a name="l03547"></a>03547 <span class="preprocessor">#endif // 0</span>
<a name="l03548"></a><a class="code" href="classbrip__vil__float__ops.html#a5217a79cfe0476cc873d74709c051146">03548</a> <span class="preprocessor"></span>
<a name="l03549"></a>03549 vcl_vector&lt;float&gt; <a class="code" href="classbrip__vil__float__ops.html#a5217a79cfe0476cc873d74709c051146" title="scan a polygon and return the pixel values as well as max min.">brip_vil_float_ops::scan_region</a>(<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__smart__ptr.html">vil_image_resource_sptr</a> img,
<a name="l03550"></a>03550                                                   <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__polygon.html">vgl_polygon&lt;double&gt;</a> poly,
<a name="l03551"></a>03551                                                   <span class="keywordtype">float</span>&amp; min,
<a name="l03552"></a>03552                                                   <span class="keywordtype">float</span>&amp; max)
<a name="l03553"></a>03553 {
<a name="l03554"></a>03554   vcl_vector&lt;float&gt; pixels;
<a name="l03555"></a>03555   min = vnl_numeric_traits&lt;float&gt;::maxval;
<a name="l03556"></a>03556   max = 0;
<a name="l03557"></a>03557   <span class="keywordtype">unsigned</span> np = img-&gt;nplanes();
<a name="l03558"></a>03558   <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__polygon__scan__iterator.html">vgl_polygon_scan_iterator&lt;double&gt;</a> si(poly, <span class="keyword">false</span>);
<a name="l03559"></a>03559   <span class="keywordflow">if</span> (img-&gt;pixel_format()==<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/vil__pixel__format_8h.html#a6f749d91364b0bcb661189f4a154800da7e558fc5ba55dbb9c32658e7960b83f4">VIL_PIXEL_FORMAT_BYTE</a>)
<a name="l03560"></a>03560   {
<a name="l03561"></a>03561     <span class="keywordflow">if</span> (np==1) <span class="comment">// single plane</span>
<a name="l03562"></a>03562     {
<a name="l03563"></a>03563       <span class="keywordflow">for</span> (si.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__polygon__scan__iterator.html#ad2f0a5cb137f2bb7cff163574b7d0245">reset</a>(); si.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__polygon__scan__iterator.html#a34cd8b05b86643530146691634b2f86b">next</a>();)
<a name="l03564"></a>03564       {
<a name="l03565"></a>03565         <span class="keywordtype">unsigned</span> j = <span class="keyword">static_cast&lt;</span><span class="keywordtype">unsigned</span><span class="keyword">&gt;</span>(si.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__polygon__scan__iterator.html#a12f70dfb61ae979cb4fb8243f31d1de8">scany</a>());
<a name="l03566"></a>03566         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> x = si.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__polygon__scan__iterator.html#a65a1151f70252afea9d3a3f871b50d42">startx</a>(); x&lt;=si.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__polygon__scan__iterator.html#aedb827c709ee859dc63744c3bfea2ac5">endx</a>(); ++x)
<a name="l03567"></a>03567         {
<a name="l03568"></a>03568           <span class="keywordtype">unsigned</span> i = <span class="keyword">static_cast&lt;</span><span class="keywordtype">unsigned</span><span class="keyword">&gt;</span>(x);
<a name="l03569"></a>03569           <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;unsigned char&gt;</a> <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/vgl__vector__2d_8h.html#a38bf1e5e0427bdeba2b469eea9befc23">v</a> = img-&gt;get_view(i, 1,j, 1);
<a name="l03570"></a>03570           <span class="keywordtype">float</span> fv = <span class="keyword">static_cast&lt;</span><span class="keywordtype">float</span><span class="keyword">&gt;</span>(v(0,0));
<a name="l03571"></a>03571           <span class="keywordflow">if</span> (fv&lt;min) min = fv;
<a name="l03572"></a>03572           <span class="keywordflow">if</span> (fv&gt;max) max = fv;
<a name="l03573"></a>03573           pixels.push_back(fv);
<a name="l03574"></a>03574         }
<a name="l03575"></a>03575       }
<a name="l03576"></a>03576       <span class="keywordflow">return</span> pixels;
<a name="l03577"></a>03577     }
<a name="l03578"></a>03578     <span class="keywordflow">else</span>
<a name="l03579"></a>03579     {
<a name="l03580"></a>03580       <span class="keywordflow">for</span> (si.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__polygon__scan__iterator.html#ad2f0a5cb137f2bb7cff163574b7d0245">reset</a>(); si.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__polygon__scan__iterator.html#a34cd8b05b86643530146691634b2f86b">next</a>();)
<a name="l03581"></a>03581       {
<a name="l03582"></a>03582         <span class="keywordtype">unsigned</span> j = <span class="keyword">static_cast&lt;</span><span class="keywordtype">unsigned</span><span class="keyword">&gt;</span>(si.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__polygon__scan__iterator.html#a12f70dfb61ae979cb4fb8243f31d1de8">scany</a>());
<a name="l03583"></a>03583         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> x = si.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__polygon__scan__iterator.html#a65a1151f70252afea9d3a3f871b50d42">startx</a>(); x&lt;=si.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__polygon__scan__iterator.html#aedb827c709ee859dc63744c3bfea2ac5">endx</a>(); ++x)
<a name="l03584"></a>03584         {
<a name="l03585"></a>03585           <span class="keywordtype">unsigned</span> i = <span class="keyword">static_cast&lt;</span><span class="keywordtype">unsigned</span><span class="keyword">&gt;</span>(x);
<a name="l03586"></a>03586           <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;unsigned char&gt;</a> <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/vgl__vector__2d_8h.html#a38bf1e5e0427bdeba2b469eea9befc23">v</a> = img-&gt;get_view(i, 1,j, 1);
<a name="l03587"></a>03587           <span class="keywordtype">float</span> fv = 0;
<a name="l03588"></a>03588           <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> p = 0; p&lt;np; ++p)
<a name="l03589"></a>03589             fv += v(0,0,p);
<a name="l03590"></a>03590           fv/=3;
<a name="l03591"></a>03591           <span class="keywordflow">if</span> (fv&lt;min) min = fv;
<a name="l03592"></a>03592           <span class="keywordflow">if</span> (fv&gt;max) max = fv;
<a name="l03593"></a>03593           pixels.push_back(fv);
<a name="l03594"></a>03594         }
<a name="l03595"></a>03595       }
<a name="l03596"></a>03596     }
<a name="l03597"></a>03597     <span class="keywordflow">return</span> pixels;
<a name="l03598"></a>03598   }
<a name="l03599"></a>03599   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (img-&gt;pixel_format()==<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/vil__pixel__format_8h.html#a6f749d91364b0bcb661189f4a154800dabecb5c0033517756dc112ccd18f97073">VIL_PIXEL_FORMAT_UINT_16</a>)
<a name="l03600"></a>03600   {
<a name="l03601"></a>03601     <span class="keywordflow">if</span> (np) <span class="comment">// single plane</span>
<a name="l03602"></a>03602     {
<a name="l03603"></a>03603       <span class="keywordflow">for</span> (si.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__polygon__scan__iterator.html#ad2f0a5cb137f2bb7cff163574b7d0245">reset</a>(); si.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__polygon__scan__iterator.html#a34cd8b05b86643530146691634b2f86b">next</a>();)
<a name="l03604"></a>03604       {
<a name="l03605"></a>03605         <span class="keywordtype">unsigned</span> j = <span class="keyword">static_cast&lt;</span><span class="keywordtype">unsigned</span><span class="keyword">&gt;</span>(si.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__polygon__scan__iterator.html#a12f70dfb61ae979cb4fb8243f31d1de8">scany</a>());
<a name="l03606"></a>03606         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> x = si.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__polygon__scan__iterator.html#a65a1151f70252afea9d3a3f871b50d42">startx</a>(); x&lt;=si.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__polygon__scan__iterator.html#aedb827c709ee859dc63744c3bfea2ac5">endx</a>(); ++x)
<a name="l03607"></a>03607         {
<a name="l03608"></a>03608           <span class="keywordtype">unsigned</span> i = <span class="keyword">static_cast&lt;</span><span class="keywordtype">unsigned</span><span class="keyword">&gt;</span>(x);
<a name="l03609"></a>03609           <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;unsigned short&gt;</a> <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/vgl__vector__2d_8h.html#a38bf1e5e0427bdeba2b469eea9befc23">v</a> = img-&gt;get_view(i, 1,j, 1);
<a name="l03610"></a>03610           <span class="keywordtype">float</span> fv = <span class="keyword">static_cast&lt;</span><span class="keywordtype">float</span><span class="keyword">&gt;</span>(v(0,0));
<a name="l03611"></a>03611           <span class="keywordflow">if</span> (fv&lt;min) min = fv;
<a name="l03612"></a>03612           <span class="keywordflow">if</span> (fv&gt;max) max = fv;
<a name="l03613"></a>03613           pixels.push_back(fv);
<a name="l03614"></a>03614         }
<a name="l03615"></a>03615       }
<a name="l03616"></a>03616       <span class="keywordflow">return</span> pixels;
<a name="l03617"></a>03617     }
<a name="l03618"></a>03618     <span class="keywordflow">else</span>
<a name="l03619"></a>03619     {
<a name="l03620"></a>03620       <span class="keywordflow">for</span> (si.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__polygon__scan__iterator.html#ad2f0a5cb137f2bb7cff163574b7d0245">reset</a>(); si.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__polygon__scan__iterator.html#a34cd8b05b86643530146691634b2f86b">next</a>();)
<a name="l03621"></a>03621       {
<a name="l03622"></a>03622         <span class="keywordtype">unsigned</span> j = <span class="keyword">static_cast&lt;</span><span class="keywordtype">unsigned</span><span class="keyword">&gt;</span>(si.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__polygon__scan__iterator.html#a12f70dfb61ae979cb4fb8243f31d1de8">scany</a>());
<a name="l03623"></a>03623         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> x = si.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__polygon__scan__iterator.html#a65a1151f70252afea9d3a3f871b50d42">startx</a>(); x&lt;=si.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__polygon__scan__iterator.html#aedb827c709ee859dc63744c3bfea2ac5">endx</a>(); ++x)
<a name="l03624"></a>03624         {
<a name="l03625"></a>03625           <span class="keywordtype">unsigned</span> i = <span class="keyword">static_cast&lt;</span><span class="keywordtype">unsigned</span><span class="keyword">&gt;</span>(x);
<a name="l03626"></a>03626           <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;unsigned short&gt;</a> <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/vgl__vector__2d_8h.html#a38bf1e5e0427bdeba2b469eea9befc23">v</a> = img-&gt;get_view(i, 1,j, 1);
<a name="l03627"></a>03627           <span class="keywordtype">float</span> fv = 0;
<a name="l03628"></a>03628           <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> p = 0; p&lt;np; ++p)
<a name="l03629"></a>03629             fv += v(0,0,p);
<a name="l03630"></a>03630           fv/=3;
<a name="l03631"></a>03631           <span class="keywordflow">if</span> (fv&lt;min) min = fv;
<a name="l03632"></a>03632           <span class="keywordflow">if</span> (fv&gt;max) max = fv;
<a name="l03633"></a>03633           pixels.push_back(fv);
<a name="l03634"></a>03634         }
<a name="l03635"></a>03635       }
<a name="l03636"></a>03636       <span class="keywordflow">return</span> pixels;
<a name="l03637"></a>03637     }
<a name="l03638"></a>03638   }
<a name="l03639"></a>03639   vcl_cerr &lt;&lt; <span class="stringliteral">&quot;In brip_vil_float_ops::scan_region() - unknown format\n&quot;</span>;
<a name="l03640"></a>03640   <span class="keywordflow">return</span> pixels;
<a name="l03641"></a>03641 }
<a name="l03642"></a>03642 
<a name="l03643"></a>03643 <span class="comment">// It has been observed that color order is somewhat invariant to illumination</span>
<a name="l03644"></a>03644 <span class="comment">// Compute an index based on color order. The tolerance determines if two</span>
<a name="l03645"></a>03645 <span class="comment">// color bands are too close to determine order, i.e. they should be considered</span>
<a name="l03646"></a>03646 <span class="comment">// equal instead</span>
<a name="l03647"></a>03647 <span class="comment">// the two relations being considered  are &lt;, &gt; and =, so the relationship</span>
<a name="l03648"></a>03648 <span class="comment">// graph looks like:</span>
<a name="l03649"></a>03649 <span class="comment">// \verbatim</span>
<a name="l03650"></a>03650 <span class="comment">//         G</span>
<a name="l03651"></a>03651 <span class="comment">//       /   \.</span>
<a name="l03652"></a>03652 <span class="comment">//   &gt; &lt; =   &gt; &lt; =</span>
<a name="l03653"></a>03653 <span class="comment">//    /         \.</span>
<a name="l03654"></a>03654 <span class="comment">//  R  - &gt; &lt; = -  B</span>
<a name="l03655"></a>03655 <span class="comment">// \endverbatim</span>
<a name="l03656"></a>03656 <span class="comment">// Thus, there are three graph edges with each of three possible labels or</span>
<a name="l03657"></a>03657 <span class="comment">// 9 possible order codes. An easy coding scheme is to use the top 6 bits of</span>
<a name="l03658"></a>03658 <span class="comment">// the byte output pixel. The relationship is encoded as states of bit pairs</span>
<a name="l03659"></a>03659 <span class="comment">// \verbatim</span>
<a name="l03660"></a>03660 <span class="comment">// Color relations  R*G  R*B  G*B    * indicates &gt; &lt; = (1,2,3)</span>
<a name="l03661"></a>03661 <span class="comment">// Bit indices      7,6  5,4  3,2</span>
<a name="l03662"></a>03662 <span class="comment">// \endverbatim</span>
<a name="l03663"></a>03663 <span class="comment">//</span>
<a name="l03664"></a><a class="code" href="classbrip__vil__float__ops.html#a4b8bd97f78795ee988a2038cfc4cfc57">03664</a> <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;vxl_byte&gt;</a> <a class="code" href="classbrip__vil__float__ops.html#a4b8bd97f78795ee988a2038cfc4cfc57" title="Color order operator, output an index based on RGB intensity order.">brip_vil_float_ops::</a>
<a name="l03665"></a>03665 <a class="code" href="classbrip__vil__float__ops.html#a4b8bd97f78795ee988a2038cfc4cfc57" title="Color order operator, output an index based on RGB intensity order.">color_order</a>(<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> <span class="keyword">const</span>&amp; color_image, <span class="keywordtype">float</span> eq_tol)
<a name="l03666"></a>03666 {
<a name="l03667"></a>03667   <span class="keywordtype">unsigned</span> ni = color_image.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a9ea9ad565387a61dccf38fc80a266c2a">ni</a>(), nj = color_image.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a44859c72206da7d18728cb2bbf8ae829">nj</a>();
<a name="l03668"></a>03668   <span class="keywordtype">unsigned</span> np = color_image.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#adb221bda92a1c0f7f4842af116428b11">nplanes</a>();
<a name="l03669"></a>03669   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;vxl_byte&gt;</a> temp;
<a name="l03670"></a>03670   <span class="keywordflow">if</span> (np!=3)
<a name="l03671"></a>03671     <span class="keywordflow">return</span> temp; <span class="comment">// improper call</span>
<a name="l03672"></a>03672   temp.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html#a9c01939f01ef50314620e26aaacb04d3">set_size</a>(ni, nj);
<a name="l03673"></a>03673   vxl_byte rg_eq=192, rg_lt=128, rg_gt=64;
<a name="l03674"></a>03674   vxl_byte rb_eq=48, rb_lt=32, rb_gt=16;
<a name="l03675"></a>03675   vxl_byte gb_eq=12, gb_lt=8, gb_gt=4;
<a name="l03676"></a>03676   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> j = 0; j&lt;nj; ++j)
<a name="l03677"></a>03677     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> i = 0; i&lt;ni; ++i) {
<a name="l03678"></a>03678       <span class="keywordtype">float</span> r=color_image(i,j,0), g=color_image(i,j,1), b=color_image(i,j,2);
<a name="l03679"></a>03679       vxl_byte rg, rb, gb;
<a name="l03680"></a>03680       <span class="comment">// rg code</span>
<a name="l03681"></a>03681       <span class="keywordflow">if</span> (vcl_fabs(r-g)&lt;eq_tol)
<a name="l03682"></a>03682         rg = rg_eq;
<a name="l03683"></a>03683       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (r&lt;g)
<a name="l03684"></a>03684         rg = rg_lt;
<a name="l03685"></a>03685       <span class="keywordflow">else</span> rg = rg_gt;
<a name="l03686"></a>03686       <span class="comment">// rb code</span>
<a name="l03687"></a>03687       <span class="keywordflow">if</span> (vcl_fabs(r-b)&lt;eq_tol)
<a name="l03688"></a>03688         rb = rb_eq;
<a name="l03689"></a>03689       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (r&lt;b)
<a name="l03690"></a>03690         rb = rb_lt;
<a name="l03691"></a>03691       <span class="keywordflow">else</span> rb = rb_gt;
<a name="l03692"></a>03692       <span class="comment">// gb code</span>
<a name="l03693"></a>03693       <span class="keywordflow">if</span> (vcl_fabs(g-b)&lt;eq_tol)
<a name="l03694"></a>03694         gb = gb_eq;
<a name="l03695"></a>03695       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (g&lt;b)
<a name="l03696"></a>03696         gb = gb_lt;
<a name="l03697"></a>03697       <span class="keywordflow">else</span> gb = gb_gt;
<a name="l03698"></a>03698       vxl_byte <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/vgl__vector__2d_8h.html#a38bf1e5e0427bdeba2b469eea9befc23">v</a> = <span class="keyword">static_cast&lt;</span>vxl_byte<span class="keyword">&gt;</span>(rg|rb|gb); <span class="comment">// bitwise or</span>
<a name="l03699"></a>03699       temp(i,j) = v;
<a name="l03700"></a>03700     }
<a name="l03701"></a>03701   <span class="keywordflow">return</span> temp;
<a name="l03702"></a>03702 }
<a name="l03703"></a>03703 
<a name="l03704"></a>03704 <span class="preprocessor">#if 0 // only used in commented-out part of brip_vil_float_ops::extrema()</span>
<a name="l03705"></a>03705 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">double</span> zs(<span class="keywordtype">double</span> x)
<a name="l03706"></a>03706 { <span class="keywordflow">if</span> (x &lt; 0.0001 &amp;&amp; x &gt; -0.0001) <span class="keywordflow">return</span> 0; <span class="keywordflow">else</span> <span class="keywordflow">return</span> x; }
<a name="l03707"></a>03707 <span class="preprocessor">#endif // 0</span>
<a name="l03708"></a>03708 <span class="preprocessor"></span>
<a name="l03709"></a>03709 <span class="keyword">static</span> <span class="keywordtype">double</span> brip_vil_rot_gauss(<span class="keywordtype">double</span> x, <span class="keywordtype">double</span> y,
<a name="l03710"></a>03710                                  <span class="keywordtype">double</span> sigma_x, <span class="keywordtype">double</span> sigma_y, <span class="keywordtype">double</span> theta)
<a name="l03711"></a>03711 {
<a name="l03712"></a>03712   <span class="keywordtype">double</span> theta_rad = theta*vnl_math::pi_over_180;
<a name="l03713"></a>03713   <span class="keywordtype">double</span> s = vcl_sin(theta_rad), c = vcl_cos(theta_rad);
<a name="l03714"></a>03714   <span class="keywordtype">double</span> sxr = 1.0/sigma_x, syr = 1.0/sigma_y;
<a name="l03715"></a>03715   <span class="keywordtype">double</span> ax = (c*x + s*y)*sxr, ay = (-s*x + c*y)*syr;
<a name="l03716"></a>03716   <span class="keywordtype">double</span> ret = vcl_exp(-0.5*(ax*ax + ay*ay));
<a name="l03717"></a>03717   <span class="keywordflow">return</span> ret*sxr*syr/(2.0*vnl_math::pi);
<a name="l03718"></a>03718 }
<a name="l03719"></a>03719 
<a name="l03720"></a><a class="code" href="classbrip__vil__float__ops.html#afe9221eb2252268b97774cc2da878e4a">03720</a> <span class="comment">// revert angle to the range [-90, 90]</span>
<a name="l03721"></a>03721 <span class="keywordtype">float</span> <a class="code" href="classbrip__vil__float__ops.html#afe9221eb2252268b97774cc2da878e4a" title="a helper function for the extrema method: reverts angle to the range [-90, 90].">brip_vil_float_ops::extrema_revert_angle</a>(<span class="keywordtype">float</span> angle)
<a name="l03722"></a>03722 {
<a name="l03723"></a>03723   <span class="keywordflow">if</span> (angle&gt;=0.0f) {
<a name="l03724"></a>03724     <span class="keywordflow">if</span> (angle&gt;90.0f&amp;&amp;angle&lt;=270.0f)
<a name="l03725"></a>03725       angle -= 180.0f;
<a name="l03726"></a>03726     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (angle&gt;270.0f&amp;&amp;angle&lt;=360.0f)
<a name="l03727"></a>03727       angle -= 360.0f;
<a name="l03728"></a>03728   }
<a name="l03729"></a>03729   <span class="keywordflow">if</span> (angle&lt;0.0f) {
<a name="l03730"></a>03730     <span class="keywordflow">if</span> (angle&lt;-90.0f&amp;&amp;angle&gt;=-270.0f)
<a name="l03731"></a>03731       angle += 180.0f;
<a name="l03732"></a>03732     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (angle&lt;-270.0f&amp;&amp;angle&gt;=-360.0f)
<a name="l03733"></a>03733       angle += 360.0f;
<a name="l03734"></a>03734   }
<a name="l03735"></a>03735   <span class="keywordflow">return</span> angle;
<a name="l03736"></a>03736 }
<a name="l03737"></a>03737 
<a name="l03738"></a><a class="code" href="classbrip__vil__float__ops.html#a6da9fd4380e539fda1705e96ac453c09">03738</a> <span class="comment">// if scale_invariant = true then the response mag is independent of lambda1</span>
<a name="l03739"></a>03739 <span class="keywordtype">void</span> <a class="code" href="classbrip__vil__float__ops.html#a6da9fd4380e539fda1705e96ac453c09" title="theta must be given in degrees.">brip_vil_float_ops::extrema_kernel_mask</a>(<span class="keywordtype">float</span> lambda0, <span class="keywordtype">float</span> lambda1,
<a name="l03740"></a>03740                                              <span class="keywordtype">float</span> theta,
<a name="l03741"></a>03741                                              <a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__array__2d.html">vbl_array_2d&lt;float&gt;</a>&amp; kernel,
<a name="l03742"></a>03742                                              <a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__array__2d.html">vbl_array_2d&lt;bool&gt;</a>&amp; mask, <span class="keywordtype">float</span> cutoff_percentage, <span class="keywordtype">bool</span> scale_invariant)
<a name="l03743"></a>03743 {
<a name="l03744"></a>03744   theta = <a class="code" href="classbrip__vil__float__ops.html#afe9221eb2252268b97774cc2da878e4a" title="a helper function for the extrema method: reverts angle to the range [-90, 90].">extrema_revert_angle</a>(theta); <span class="comment">// in range [-90, 90]</span>
<a name="l03745"></a>03745   <span class="comment">// convert theta to radians</span>
<a name="l03746"></a>03746   <span class="keywordtype">double</span> theta_rad = theta*vnl_math::pi_over_180;
<a name="l03747"></a>03747   <span class="keywordtype">double</span> s = vcl_sin(theta_rad), c = vcl_cos(theta_rad);
<a name="l03748"></a>03748   <span class="keywordtype">double</span> s0 = lambda0, s1 = lambda1;
<a name="l03749"></a>03749   <span class="keywordtype">double</span> s1sq = 1.0/(s1*s1);
<a name="l03750"></a>03750   <span class="comment">// determine the size of the array</span>
<a name="l03751"></a>03751   <span class="keywordtype">double</span> max_v = brip_vil_rot_gauss(0, 0, s0, s1, 0);
<a name="l03752"></a>03752   <span class="keywordtype">double</span> cutoff = max_v*cutoff_percentage; <span class="comment">// if 0.01 then 1% tails removed</span>
<a name="l03753"></a>03753   <span class="keywordtype">unsigned</span> ru = 0;
<a name="l03754"></a>03754   <span class="keywordflow">while</span> (brip_vil_rot_gauss(ru, 0, s0, s1, 0) &gt;= cutoff)
<a name="l03755"></a>03755     ++ru;
<a name="l03756"></a>03756   <span class="keywordtype">unsigned</span> rv = 0;
<a name="l03757"></a>03757   <span class="keywordflow">while</span> (brip_vil_rot_gauss(0, rv, s0, s1, 0) &gt;= cutoff)
<a name="l03758"></a>03758     ++rv;
<a name="l03759"></a>03759 
<a name="l03760"></a>03760   <span class="comment">// rotate to get bounds</span>
<a name="l03761"></a>03761   <span class="keywordtype">int</span> ri = <span class="keyword">static_cast&lt;</span><span class="keywordtype">int</span><span class="keyword">&gt;</span>(vcl_fabs(ru*c+rv*s) +0.5);
<a name="l03762"></a>03762   <span class="keywordtype">int</span> rj = <span class="keyword">static_cast&lt;</span><span class="keywordtype">int</span><span class="keyword">&gt;</span>(vcl_fabs(ru*s+rv*c) +0.5);
<a name="l03763"></a>03763   <span class="keywordflow">if</span> (s&lt;0) {
<a name="l03764"></a>03764     ri = <span class="keyword">static_cast&lt;</span><span class="keywordtype">int</span><span class="keyword">&gt;</span>(vcl_fabs(ru*c-rv*s) +0.5);
<a name="l03765"></a>03765     rj = <span class="keyword">static_cast&lt;</span><span class="keywordtype">int</span><span class="keyword">&gt;</span>(vcl_fabs(ru*s-rv*c) +0.5);
<a name="l03766"></a>03766   }
<a name="l03767"></a>03767 
<a name="l03768"></a>03768   <span class="keywordtype">unsigned</span> ncols = 2*ri +1, nrows = 2*rj+1;
<a name="l03769"></a>03769   <a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__array__2d.html">vbl_array_2d&lt;double&gt;</a> coef(nrows, ncols);
<a name="l03770"></a>03770   mask.<a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__array__2d.html#ab4c579123a1f5a2b6c5606c7b9d251e2">resize</a>(nrows,ncols);
<a name="l03771"></a>03771   <span class="keywordtype">double</span> residual = 0.0, total  = 0.0;
<a name="l03772"></a>03772   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> ry = -rj; ry&lt;=rj; ++ry)
<a name="l03773"></a>03773     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> rx = -ri; rx&lt;=ri; ++rx)
<a name="l03774"></a>03774     {
<a name="l03775"></a>03775       <span class="keywordtype">double</span> g = brip_vil_rot_gauss(rx, ry, s0, s1, theta);
<a name="l03776"></a>03776       mask[ry+rj][rx+ri] = g&gt;=cutoff;
<a name="l03777"></a>03777       <span class="keywordtype">double</span> temp = (-s*rx + c*ry);
<a name="l03778"></a>03778       temp = temp*temp*s1sq;
<a name="l03779"></a>03779       <span class="keywordtype">double</span> <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/vgl__vector__2d_8h.html#a38bf1e5e0427bdeba2b469eea9befc23">v</a> = (temp -1)*g*(scale_invariant?1.0:s1sq);
<a name="l03780"></a>03780       <span class="keywordflow">if</span> (g&lt;cutoff) v = 0.0;
<a name="l03781"></a>03781       coef[ry+rj][rx+ri] = v;
<a name="l03782"></a>03782       residual+=v;
<a name="l03783"></a>03783       total += vcl_fabs(v);
<a name="l03784"></a>03784     }
<a name="l03785"></a>03785   <span class="keywordtype">double</span> cor = 0.0;
<a name="l03786"></a>03786   <span class="keywordflow">if</span> (total)
<a name="l03787"></a>03787     cor = -residual/total;
<a name="l03788"></a>03788   kernel.<a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__array__2d.html#ab4c579123a1f5a2b6c5606c7b9d251e2">resize</a>(nrows, ncols);
<a name="l03789"></a>03789   <span class="comment">// correct any residual offset in coefficients</span>
<a name="l03790"></a>03790   <span class="comment">// distribute proportionally to coefficient magnitude</span>
<a name="l03791"></a>03791   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> j = 0; j&lt;nrows; ++j)
<a name="l03792"></a>03792     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> i = 0; i&lt;ncols; ++i)
<a name="l03793"></a>03793     {
<a name="l03794"></a>03794       <span class="keywordtype">double</span> <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/vgl__vector__2d_8h.html#a38bf1e5e0427bdeba2b469eea9befc23">v</a> = vcl_fabs(coef[j][i]);
<a name="l03795"></a>03795       coef[j][i]+=v*cor;
<a name="l03796"></a>03796       kernel[j][i]=<span class="keyword">static_cast&lt;</span><span class="keywordtype">float</span><span class="keyword">&gt;</span>(coef[j][i]);
<a name="l03797"></a>03797     }
<a name="l03798"></a>03798 }
<a name="l03799"></a>03799 
<a name="l03800"></a>03800 <span class="comment">// Compute the standard deviation of an operator response</span>
<a name="l03801"></a>03801 <span class="comment">// given the image intensity standard deviation at each pixel</span>
<a name="l03802"></a><a class="code" href="classbrip__vil__float__ops.html#aded584e4b469896b59fb4f107a21dff4">03802</a> <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> <a class="code" href="classbrip__vil__float__ops.html#aded584e4b469896b59fb4f107a21dff4" title="Compute the standard deviation of an operator response, given the image intensity standard deviation ...">brip_vil_float_ops::</a>
<a name="l03803"></a>03803 <a class="code" href="classbrip__vil__float__ops.html#aded584e4b469896b59fb4f107a21dff4" title="Compute the standard deviation of an operator response, given the image intensity standard deviation ...">std_dev_operator</a>(<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> <span class="keyword">const</span>&amp; sd_image,
<a name="l03804"></a>03804                  <a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__array__2d.html">vbl_array_2d&lt;float&gt;</a> <span class="keyword">const</span>&amp; kernel)
<a name="l03805"></a>03805 {
<a name="l03806"></a>03806   <span class="keywordtype">unsigned</span> ni = sd_image.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a9ea9ad565387a61dccf38fc80a266c2a">ni</a>(), nj = sd_image.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a44859c72206da7d18728cb2bbf8ae829">nj</a>();
<a name="l03807"></a>03807   <span class="keywordtype">unsigned</span> nrows = kernel.<a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__array__2d.html#abe25ab10299a0b1c6a075895bfb85fe6">rows</a>(), ncols = kernel.<a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__array__2d.html#a5d1d6d4ecc26eff6b99e456078924be6">cols</a>();
<a name="l03808"></a>03808   <span class="keywordtype">int</span> rrad = (nrows-1)/2, crad = (ncols-1)/2;
<a name="l03809"></a>03809   <span class="keywordtype">float</span> sd_min, sd_max;
<a name="l03810"></a>03810   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/vil__math_8h.html#a3e16fe5a086f6c2c05c67e15edd6ebf6">vil_math_value_range</a>(sd_image, sd_min, sd_max);
<a name="l03811"></a>03811 
<a name="l03812"></a>03812   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> res(ni, nj);
<a name="l03813"></a>03813   res.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html#a6fd591632020e490abb5e4493a52dbba">fill</a>(sd_max);
<a name="l03814"></a>03814 
<a name="l03815"></a>03815   <a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__array__2d.html">vbl_array_2d&lt;float&gt;</a>ksq(nrows, ncols);
<a name="l03816"></a>03816   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> r = 0; r&lt;nrows; ++r)
<a name="l03817"></a>03817     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> c = 0; c&lt;ncols; ++c)
<a name="l03818"></a>03818       ksq[r][c] = kernel[r][c]*kernel[r][c];
<a name="l03819"></a>03819 
<a name="l03820"></a>03820   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = rrad; j&lt;static_cast&lt;int&gt;(nj-rrad); ++j)
<a name="l03821"></a>03821     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = crad; i&lt;static_cast&lt;int&gt;(ni-crad); ++i)
<a name="l03822"></a>03822     {
<a name="l03823"></a>03823       <span class="keywordtype">float</span> sum = 0;
<a name="l03824"></a>03824       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> jj = -rrad; jj&lt;=rrad; ++jj)
<a name="l03825"></a>03825         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> ii = -crad; ii&lt;=crad; ++ii) {
<a name="l03826"></a>03826           <span class="keywordtype">float</span> sd_sq = sd_image(i+ii, j+jj);
<a name="l03827"></a>03827           sd_sq *= sd_sq;
<a name="l03828"></a>03828           sum += sd_sq*ksq[jj+rrad][ii+crad];
<a name="l03829"></a>03829         }
<a name="l03830"></a>03830       res(i,j) = vcl_sqrt(sum);
<a name="l03831"></a>03831     }
<a name="l03832"></a>03832   <span class="keywordflow">return</span> res;
<a name="l03833"></a>03833 }
<a name="l03834"></a>03834 
<a name="l03835"></a>03835 <span class="comment">// Compute the standard deviation of an operator response</span>
<a name="l03836"></a>03836 <span class="comment">// given the image intensity standard deviation at each pixel</span>
<a name="l03837"></a>03837 <span class="comment">// uses a modified formula to compute std_dev</span>
<a name="l03838"></a><a class="code" href="classbrip__vil__float__ops.html#a16b6363cadf487f2667a1c0e889cb9be">03838</a> <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> <a class="code" href="classbrip__vil__float__ops.html#a16b6363cadf487f2667a1c0e889cb9be" title="Compute the standard deviation of an operator response, given the image intensity standard deviation ...">brip_vil_float_ops::</a>
<a name="l03839"></a>03839 <a class="code" href="classbrip__vil__float__ops.html#a16b6363cadf487f2667a1c0e889cb9be" title="Compute the standard deviation of an operator response, given the image intensity standard deviation ...">std_dev_operator_method2</a>(<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> <span class="keyword">const</span>&amp; sd_image,
<a name="l03840"></a>03840                          <a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__array__2d.html">vbl_array_2d&lt;float&gt;</a> <span class="keyword">const</span>&amp; kernel)
<a name="l03841"></a>03841 {
<a name="l03842"></a>03842   <span class="keywordtype">unsigned</span> ni = sd_image.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a9ea9ad565387a61dccf38fc80a266c2a">ni</a>(), nj = sd_image.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a44859c72206da7d18728cb2bbf8ae829">nj</a>();
<a name="l03843"></a>03843   <span class="keywordtype">unsigned</span> nrows = kernel.<a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__array__2d.html#abe25ab10299a0b1c6a075895bfb85fe6">rows</a>(), ncols = kernel.<a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__array__2d.html#a5d1d6d4ecc26eff6b99e456078924be6">cols</a>();
<a name="l03844"></a>03844   <span class="keywordtype">int</span> rrad = (nrows-1)/2, crad = (ncols-1)/2;
<a name="l03845"></a>03845   <span class="keywordtype">float</span> sd_min, sd_max;
<a name="l03846"></a>03846   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/vil__math_8h.html#a3e16fe5a086f6c2c05c67e15edd6ebf6">vil_math_value_range</a>(sd_image, sd_min, sd_max);
<a name="l03847"></a>03847 
<a name="l03848"></a>03848   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> res(ni, nj);
<a name="l03849"></a>03849   res.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html#a6fd591632020e490abb5e4493a52dbba">fill</a>(sd_max);
<a name="l03850"></a>03850 
<a name="l03851"></a>03851   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = rrad; j&lt;static_cast&lt;int&gt;(nj-rrad); ++j)
<a name="l03852"></a>03852     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = crad; i&lt;static_cast&lt;int&gt;(ni-crad); ++i)
<a name="l03853"></a>03853     {
<a name="l03854"></a>03854       <span class="keywordtype">float</span> sum = 0;
<a name="l03855"></a>03855       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> jj = -rrad; jj&lt;=rrad; ++jj)
<a name="l03856"></a>03856         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> ii = -crad; ii&lt;=crad; ++ii) {
<a name="l03857"></a>03857           <span class="keywordtype">float</span> sd = sd_image(i+ii, j+jj);
<a name="l03858"></a>03858           sum += (float)(sd*vcl_abs(kernel[jj+rrad][ii+crad]));
<a name="l03859"></a>03859         }
<a name="l03860"></a>03860       res(i,j) = <a class="code" href="classbrip__vil__float__ops.html#aa53780e68774a9005f49508d8b9a221a" title="Add two images from a general resource (forces types to be the same).">sum</a>;
<a name="l03861"></a>03861     }
<a name="l03862"></a>03862   <span class="keywordflow">return</span> res;
<a name="l03863"></a>03863 }
<a name="l03864"></a>03864 
<a name="l03865"></a><a class="code" href="classbrip__vil__float__ops.html#a66f0a1382b16dc0e2497d7f61ef32528">03865</a> <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a>
<a name="l03866"></a>03866 <a class="code" href="classbrip__vil__float__ops.html#a66f0a1382b16dc0e2497d7f61ef32528" title="Find anisotropic intensity extrema (Gaussian 2nd derivative). Theta is in degrees.">brip_vil_float_ops::extrema</a>(<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> <span class="keyword">const</span>&amp; input,
<a name="l03867"></a>03867                             <span class="keywordtype">float</span> lambda0, <span class="keywordtype">float</span> lambda1, <span class="keywordtype">float</span> theta,
<a name="l03868"></a>03868                             <span class="keywordtype">bool</span> bright, <span class="keywordtype">bool</span> mag_only,
<a name="l03869"></a>03869                             <span class="keywordtype">bool</span> output_response_mask,
<a name="l03870"></a>03870                             <span class="keywordtype">bool</span> signed_response, <span class="keywordtype">bool</span> scale_invariant,
<a name="l03871"></a>03871                             <span class="keywordtype">bool</span> non_max_suppress, <span class="keywordtype">float</span> cutoff_per)
<a name="l03872"></a>03872 {
<a name="l03873"></a>03873   assert(!(mag_only&amp;&amp;signed_response));
<a name="l03874"></a>03874   <a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__array__2d.html">vbl_array_2d&lt;float&gt;</a> fa;
<a name="l03875"></a>03875   <a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__array__2d.html">vbl_array_2d&lt;bool&gt;</a> mask;
<a name="l03876"></a>03876   <a class="code" href="classbrip__vil__float__ops.html#a6da9fd4380e539fda1705e96ac453c09" title="theta must be given in degrees.">brip_vil_float_ops::extrema_kernel_mask</a>(lambda0, lambda1, theta,
<a name="l03877"></a>03877                                           fa, mask, cutoff_per,
<a name="l03878"></a>03878                                           scale_invariant);
<a name="l03879"></a>03879   <span class="keywordtype">unsigned</span> nrows = fa.<a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__array__2d.html#abe25ab10299a0b1c6a075895bfb85fe6">rows</a>(), ncols = fa.<a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__array__2d.html#a5d1d6d4ecc26eff6b99e456078924be6">cols</a>();
<a name="l03880"></a>03880   <span class="keywordtype">int</span> rj = (nrows-1)/2, ri = (ncols-1)/2;
<a name="l03881"></a>03881   <a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__array__2d.html">vbl_array_2d&lt;double&gt;</a> coef(nrows,ncols);
<a name="l03882"></a>03882   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> r = 0; r&lt;nrows; ++r)
<a name="l03883"></a>03883     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> c = 0; c&lt;ncols; ++c)
<a name="l03884"></a>03884       coef[r][c]=fa[r][c];
<a name="l03885"></a>03885 
<a name="l03886"></a>03886 <span class="preprocessor">#if 0</span>
<a name="l03887"></a>03887 <span class="preprocessor"></span>  <span class="comment">// (unused) double max_v = brip_vil_rot_gauss(0, 0, lambda0, lambda1, 0);</span>
<a name="l03888"></a>03888   <span class="comment">// (unused) double cutoff=static_cast&lt;float&gt;(max_v*0.01); // 1% tails removed</span>
<a name="l03889"></a>03889   vcl_cout &lt;&lt; <span class="stringliteral">&quot;\ngauss ={&quot;</span>;
<a name="l03890"></a>03890   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> j = 0; j&lt;nrows; ++j) {
<a name="l03891"></a>03891     vcl_cout &lt;&lt; <span class="charliteral">&#39;{&#39;</span>;
<a name="l03892"></a>03892     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> i = 0; i&lt;ncols-1; ++i)
<a name="l03893"></a>03893       vcl_cout &lt;&lt; zs(coef[j][i]) &lt;&lt; <span class="charliteral">&#39;,&#39;</span>;
<a name="l03894"></a>03894     <span class="keywordflow">if</span> (j != nrows-1)
<a name="l03895"></a>03895       vcl_cout &lt;&lt; zs(coef[j][ncols-1]) &lt;&lt; <span class="stringliteral">&quot;},&quot;</span>;
<a name="l03896"></a>03896     <span class="keywordflow">else</span>
<a name="l03897"></a>03897       vcl_cout &lt;&lt; zs(coef[j][ncols-1]) &lt;&lt; <span class="charliteral">&#39;}&#39;</span>;
<a name="l03898"></a>03898   }
<a name="l03899"></a>03899 
<a name="l03900"></a>03900   vcl_cout &lt;&lt; <span class="stringliteral">&quot;};\n\nmask ={&quot;</span>;
<a name="l03901"></a>03901   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> j = 0; j&lt;nrows; ++j) {
<a name="l03902"></a>03902     vcl_cout &lt;&lt; <span class="charliteral">&#39;{&#39;</span>;
<a name="l03903"></a>03903     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> i = 0; i&lt;ncols-1; ++i)
<a name="l03904"></a>03904       vcl_cout &lt;&lt; mask[j][i] &lt;&lt; <span class="charliteral">&#39;,&#39;</span>;
<a name="l03905"></a>03905     <span class="keywordflow">if</span> (j != nrows-1)
<a name="l03906"></a>03906       vcl_cout &lt;&lt; mask[j][ncols-1] &lt;&lt; <span class="stringliteral">&quot;},&quot;</span>;
<a name="l03907"></a>03907     <span class="keywordflow">else</span>
<a name="l03908"></a>03908       vcl_cout &lt;&lt; mask[j][ncols-1] &lt;&lt; <span class="charliteral">&#39;}&#39;</span>;
<a name="l03909"></a>03909   }
<a name="l03910"></a>03910   vcl_cout &lt;&lt; <span class="stringliteral">&quot;};&quot;</span> &lt;&lt; vcl_flush;
<a name="l03911"></a>03911 <span class="preprocessor">#endif</span>
<a name="l03912"></a>03912 <span class="preprocessor"></span>  <span class="comment">// compute response image</span>
<a name="l03913"></a>03913   <span class="keywordtype">unsigned</span> ni = input.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a9ea9ad565387a61dccf38fc80a266c2a">ni</a>(), nj = input.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a44859c72206da7d18728cb2bbf8ae829">nj</a>();
<a name="l03914"></a>03914   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> temp(ni, nj);
<a name="l03915"></a>03915   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> temp2(ni, nj);
<a name="l03916"></a>03916   temp.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html#a6fd591632020e490abb5e4493a52dbba">fill</a>(0.0f); temp2.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html#a6fd591632020e490abb5e4493a52dbba">fill</a>(0.0f);
<a name="l03917"></a>03917   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> j = rj; j&lt;(nj-rj); j++)
<a name="l03918"></a>03918     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> i = ri; i&lt;(ni-ri); i++) {
<a name="l03919"></a>03919       <span class="keywordtype">double</span> sum = 0;
<a name="l03920"></a>03920       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> jj=-rj; jj&lt;=rj; ++jj)
<a name="l03921"></a>03921         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> ii=-ri; ii&lt;=ri; ++ii)
<a name="l03922"></a>03922           <span class="keywordflow">if</span> (mask[jj+rj][ii+ri])
<a name="l03923"></a>03923             sum += coef[jj+rj][ii+ri]*input(i+ii, j+jj);
<a name="l03924"></a>03924       temp2(i,j) = <span class="keyword">static_cast&lt;</span><span class="keywordtype">float</span><span class="keyword">&gt;</span>(<a class="code" href="classbrip__vil__float__ops.html#aa53780e68774a9005f49508d8b9a221a" title="Add two images from a general resource (forces types to be the same).">sum</a>);
<a name="l03925"></a>03925       <span class="keywordflow">if</span> (mag_only) {
<a name="l03926"></a>03926         temp(i,j) = <span class="keyword">static_cast&lt;</span><span class="keywordtype">float</span><span class="keyword">&gt;</span>(vcl_fabs(sum));
<a name="l03927"></a>03927       }
<a name="l03928"></a>03928       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (bright) { <span class="comment">// coefficients are negative at center</span>
<a name="l03929"></a>03929         <span class="keywordflow">if</span> (sum&lt;0) temp(i,j) = <span class="keyword">static_cast&lt;</span><span class="keywordtype">float</span><span class="keyword">&gt;</span>(-<a class="code" href="classbrip__vil__float__ops.html#aa53780e68774a9005f49508d8b9a221a" title="Add two images from a general resource (forces types to be the same).">sum</a>);
<a name="l03930"></a>03930       }
<a name="l03931"></a>03931       <span class="keywordflow">else</span> {
<a name="l03932"></a>03932         <span class="keywordflow">if</span> (sum&gt;0) temp(i,j) = <span class="keyword">static_cast&lt;</span><span class="keywordtype">float</span><span class="keyword">&gt;</span>(<a class="code" href="classbrip__vil__float__ops.html#aa53780e68774a9005f49508d8b9a221a" title="Add two images from a general resource (forces types to be the same).">sum</a>);
<a name="l03933"></a>03933       }
<a name="l03934"></a>03934     }
<a name="l03935"></a>03935   <span class="comment">// non-max suppression</span>
<a name="l03936"></a>03936   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> res(temp);
<a name="l03937"></a>03937   <span class="keywordflow">if</span> (non_max_suppress)
<a name="l03938"></a>03938     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> j = rj; j&lt;(nj-rj); j++)
<a name="l03939"></a>03939       <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> i = ri; i&lt;(ni-ri); i++)
<a name="l03940"></a>03940       {
<a name="l03941"></a>03941         <span class="keywordtype">float</span> cv = temp(i,j);
<a name="l03942"></a>03942         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> jj=-rj; jj&lt;=rj; ++jj)
<a name="l03943"></a>03943           <span class="keywordflow">for</span> (<span class="keywordtype">int</span> ii=-ri; ii&lt;=ri; ++ii)
<a name="l03944"></a>03944             <span class="keywordflow">if</span> ((ii!=0||jj!=0) &amp;&amp; mask[jj+rj][ii+ri] &amp;&amp; temp(i+ii, j+jj)&gt;cv)
<a name="l03945"></a>03945               res(i,j)=0.0f;
<a name="l03946"></a>03946       }
<a name="l03947"></a>03947   <span class="keywordflow">if</span> (!output_response_mask&amp;&amp;!signed_response)
<a name="l03948"></a>03948     <span class="keywordflow">return</span> res;
<a name="l03949"></a>03949   <span class="keywordtype">unsigned</span> np = 2;
<a name="l03950"></a>03950   <span class="keywordflow">if</span> (output_response_mask&amp;&amp;signed_response)
<a name="l03951"></a>03951     np = 3;
<a name="l03952"></a>03952   <span class="comment">//response plane and mask plane and/or signed response</span>
<a name="l03953"></a>03953   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> res_mask(ni, nj, np);
<a name="l03954"></a>03954   res_mask.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html#a6fd591632020e490abb5e4493a52dbba">fill</a>(0.0f);
<a name="l03955"></a>03955   <span class="comment">// always copy response to plane 0</span>
<a name="l03956"></a>03956   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> j = rj; j&lt;(nj-rj); j++)
<a name="l03957"></a>03957     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> i = ri; i&lt;(ni-ri); i++)
<a name="l03958"></a>03958     {
<a name="l03959"></a>03959       <span class="keywordtype">float</span> rv = res(i,j);
<a name="l03960"></a>03960       res_mask(i,j,0)=rv;
<a name="l03961"></a>03961     }
<a name="l03962"></a>03962   <span class="comment">// copy mask plane to plane 1 (or not)</span>
<a name="l03963"></a>03963   <span class="keywordflow">if</span> (output_response_mask) {
<a name="l03964"></a>03964     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> j = rj; j&lt;(nj-rj); j++)
<a name="l03965"></a>03965       <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> i = ri; i&lt;(ni-ri); i++)
<a name="l03966"></a>03966       {
<a name="l03967"></a>03967         <span class="keywordtype">float</span> rv = res(i,j);
<a name="l03968"></a>03968         <span class="keywordflow">if</span> (!rv)
<a name="l03969"></a>03969           <span class="keywordflow">continue</span>;
<a name="l03970"></a>03970         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> jj=-rj; jj&lt;=rj; ++jj)
<a name="l03971"></a>03971           <span class="keywordflow">for</span> (<span class="keywordtype">int</span> ii=-ri; ii&lt;=ri; ++ii)
<a name="l03972"></a>03972             <span class="keywordflow">if</span> (mask[jj+rj][ii+ri])
<a name="l03973"></a>03973               <span class="keywordflow">if</span> (rv&gt;res_mask(i+ii,j+jj,1))
<a name="l03974"></a>03974                 res_mask(i+ii,j+jj,1) = rv;
<a name="l03975"></a>03975       }
<a name="l03976"></a>03976   }
<a name="l03977"></a>03977   <span class="comment">// copy signed response to plane 1 if no mask plane, otherwise plane 2</span>
<a name="l03978"></a>03978   <span class="keywordflow">if</span> (signed_response) {
<a name="l03979"></a>03979     <span class="keywordtype">unsigned</span> p = np-1;
<a name="l03980"></a>03980     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> j = rj; j&lt;(nj-rj); j++)
<a name="l03981"></a>03981       <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> i = ri; i&lt;(ni-ri); i++)
<a name="l03982"></a>03982         res_mask(i,j,p) = temp2(i,j);
<a name="l03983"></a>03983   }
<a name="l03984"></a>03984   <span class="keywordflow">return</span> res_mask;
<a name="l03985"></a>03985 }
<a name="l03986"></a>03986 
<a name="l03987"></a>03987 
<a name="l03988"></a>03988 <span class="comment">//: Find anisotropic intensity extrema at a range of orientations and return the maximal response at the best orientation. Theta interval is in degrees</span>
<a name="l03989"></a>03989 <span class="comment">//  if lambda0 == lambda1 then reduces to the normal extrema operator</span>
<a name="l03990"></a><a class="code" href="classbrip__vil__float__ops.html#ae8ea501e0d22fcc55ff0a966bffed3d5">03990</a> <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> <a class="code" href="classbrip__vil__float__ops.html#ae8ea501e0d22fcc55ff0a966bffed3d5" title="Find anisotropic intensity extrema at a range of orientations and return the maximal response at the ...">brip_vil_float_ops::</a>
<a name="l03991"></a>03991 <a class="code" href="classbrip__vil__float__ops.html#ae8ea501e0d22fcc55ff0a966bffed3d5" title="Find anisotropic intensity extrema at a range of orientations and return the maximal response at the ...">extrema_rotational</a>(<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> <span class="keyword">const</span>&amp; input, <span class="keywordtype">float</span> lambda0,
<a name="l03992"></a>03992                    <span class="keywordtype">float</span> lambda1, <span class="keywordtype">float</span> theta_interval, <span class="keywordtype">bool</span> bright,
<a name="l03993"></a>03993                    <span class="keywordtype">bool</span> mag_only, <span class="keywordtype">bool</span> signed_response,
<a name="l03994"></a>03994                    <span class="keywordtype">bool</span> scale_invariant, <span class="keywordtype">bool</span> non_max_suppress,
<a name="l03995"></a>03995                    <span class="keywordtype">float</span> cutoff_per)
<a name="l03996"></a>03996 {
<a name="l03997"></a>03997   <span class="comment">//invalid response</span>
<a name="l03998"></a>03998   assert(!(mag_only&amp;&amp;signed_response));
<a name="l03999"></a>03999 
<a name="l04000"></a>04000   <span class="keywordtype">unsigned</span> ni = input.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a9ea9ad565387a61dccf38fc80a266c2a">ni</a>();
<a name="l04001"></a>04001   <span class="keywordtype">unsigned</span> nj = input.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a44859c72206da7d18728cb2bbf8ae829">nj</a>();
<a name="l04002"></a>04002 
<a name="l04003"></a>04003   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> output(ni, nj, 3); <span class="comment">// the first plane is the response strength, the second is the best angle and the third is the mask for that angle</span>
<a name="l04004"></a>04004   output.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html#a6fd591632020e490abb5e4493a52dbba">fill</a>(0.0f);
<a name="l04005"></a>04005 
<a name="l04006"></a>04006   <span class="keywordflow">if</span> (lambda0 == lambda1) {  <span class="comment">// if isotropic reduces to normal extrema calculation (perfect orientation symmetry)</span>
<a name="l04007"></a>04007     <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> res_mask_current =
<a name="l04008"></a>04008       <a class="code" href="classbrip__vil__float__ops.html#a66f0a1382b16dc0e2497d7f61ef32528" title="Find anisotropic intensity extrema (Gaussian 2nd derivative). Theta is in degrees.">extrema</a>(input, lambda0, lambda1, 0.0f, bright, mag_only,
<a name="l04009"></a>04009               <span class="keyword">true</span>, signed_response, scale_invariant,
<a name="l04010"></a>04010               non_max_suppress, cutoff_per);
<a name="l04011"></a>04011     <span class="keywordtype">unsigned</span> np = res_mask_current.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#adb221bda92a1c0f7f4842af116428b11">nplanes</a>();
<a name="l04012"></a>04012     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> j = 0; j&lt;nj; j++)
<a name="l04013"></a>04013       <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> i = 0; i&lt;ni; i++) {
<a name="l04014"></a>04014         <span class="keywordflow">if</span> (!signed_response)
<a name="l04015"></a>04015           output(i,j,0) = res_mask_current(i,j,0);  <span class="comment">// return the non-max suppressed for angle 0</span>
<a name="l04016"></a>04016         <span class="keywordflow">else</span>
<a name="l04017"></a>04017           output(i,j,0) = res_mask_current(i,j,np-1);
<a name="l04018"></a>04018         output(i,j,1) = 0.0f;
<a name="l04019"></a>04019         output(i,j,2) = res_mask_current(i,j,1);
<a name="l04020"></a>04020       }
<a name="l04021"></a>04021     <span class="keywordflow">return</span> output;
<a name="l04022"></a>04022   }
<a name="l04023"></a>04023 
<a name="l04024"></a>04024   <span class="comment">// The kernel generator does not treat the x and y axis symmetrically, the method works correctly only when lambda0 &gt; lambda1</span>
<a name="l04025"></a>04025   <span class="comment">// Theoretically one can always call this method by switching the lambdas but the caller of the method should make this switch if needed hence the assertion</span>
<a name="l04026"></a>04026   <span class="keywordflow">if</span> (lambda0 &lt; lambda1) {
<a name="l04027"></a>04027     vcl_cout &lt;&lt; <span class="stringliteral">&quot;In brip_vil_float_ops::extrema_rotational() - ERROR! rotational extrema operator requires lambda0 to be larger than lambda1! switch the lambdas and use the output angle map accordingly!\n&quot;</span>;
<a name="l04028"></a>04028     <span class="keywordflow">throw</span> 0;
<a name="l04029"></a>04029   }
<a name="l04030"></a>04030   <span class="keywordflow">if</span> (theta_interval &lt; vcl_numeric_limits&lt;float&gt;::epsilon()) {
<a name="l04031"></a>04031     vcl_cout &lt;&lt; <span class="stringliteral">&quot;In brip_vil_float_ops::extrema_rotational() - ERROR! theta_interval needs to be larger than 0!\n&quot;</span>;
<a name="l04032"></a>04032     <span class="keywordflow">throw</span> 0;
<a name="l04033"></a>04033   }
<a name="l04034"></a>04034 
<a name="l04035"></a>04035   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> res_img(ni, nj);
<a name="l04036"></a>04036   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;int&gt;</a> res_angle(ni, nj);
<a name="l04037"></a>04037   res_img.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html#a6fd591632020e490abb5e4493a52dbba">fill</a>(0.0f); res_angle.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html#a6fd591632020e490abb5e4493a52dbba">fill</a>(0);
<a name="l04038"></a>04038 
<a name="l04039"></a>04039   vcl_vector&lt;float&gt; angles;
<a name="l04040"></a>04040   angles.push_back(-1.0f);
<a name="l04041"></a>04041   <span class="keywordflow">for</span> (<span class="keywordtype">float</span> theta = 0.0f; theta &lt; 180.0f; theta += theta_interval) { angles.push_back(theta); }
<a name="l04042"></a>04042 
<a name="l04043"></a>04043   vcl_vector&lt;vbl_array_2d&lt;bool&gt; &gt; mask_vect(angles.size(), <a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__array__2d.html">vbl_array_2d&lt;bool&gt;</a>());
<a name="l04044"></a>04044   <span class="keywordtype">int</span> max_rji = 0;
<a name="l04045"></a>04045   <span class="comment">// elliptical operator has 180 degree rotational symmetry, so only the angles in the range [0,180] matter</span>
<a name="l04046"></a>04046   <span class="keywordtype">float</span> theta = 0.0f; <span class="keywordtype">unsigned</span> theta_i = 1;
<a name="l04047"></a>04047   <span class="keywordflow">for</span> ( ; theta &lt; 180; theta += theta_interval, theta_i++)
<a name="l04048"></a>04048   {
<a name="l04049"></a>04049     <span class="comment">// compute the response</span>
<a name="l04050"></a>04050     <a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__array__2d.html">vbl_array_2d&lt;float&gt;</a> fa; <a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__array__2d.html">vbl_array_2d&lt;bool&gt;</a> mask;
<a name="l04051"></a>04051     <a class="code" href="classbrip__vil__float__ops.html#a6da9fd4380e539fda1705e96ac453c09" title="theta must be given in degrees.">brip_vil_float_ops::extrema_kernel_mask</a>(lambda0, lambda1, theta,
<a name="l04052"></a>04052                                             fa, mask, cutoff_per, scale_invariant);
<a name="l04053"></a>04053     mask_vect[theta_i] = mask;
<a name="l04054"></a>04054     <span class="keywordtype">unsigned</span> nrows = fa.<a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__array__2d.html#abe25ab10299a0b1c6a075895bfb85fe6">rows</a>(), ncols = fa.<a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__array__2d.html#a5d1d6d4ecc26eff6b99e456078924be6">cols</a>();
<a name="l04055"></a>04055     <span class="keywordtype">int</span> rj = (nrows-1)/2, ri = (ncols-1)/2;
<a name="l04056"></a>04056     <span class="keywordflow">if</span> (rj &gt; max_rji) max_rji = rj;
<a name="l04057"></a>04057     <span class="keywordflow">if</span> (ri &gt; max_rji) max_rji = ri;
<a name="l04058"></a>04058     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> j = rj; j&lt;(nj-rj); j++) {
<a name="l04059"></a>04059       <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> i = ri; i&lt;(ni-ri); i++) {
<a name="l04060"></a>04060         <span class="keywordtype">float</span> res = 0.0f;
<a name="l04061"></a>04061         <span class="keywordtype">double</span> sum = 0;
<a name="l04062"></a>04062         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> jj=-rj; jj&lt;=rj; ++jj)
<a name="l04063"></a>04063           <span class="keywordflow">for</span> (<span class="keywordtype">int</span> ii=-ri; ii&lt;=ri; ++ii)
<a name="l04064"></a>04064             <span class="keywordflow">if</span> (mask[jj+rj][ii+ri]) {
<a name="l04065"></a>04065               sum += double(fa[jj+rj][ii+ri])*input(i+ii, j+jj);
<a name="l04066"></a>04066             }
<a name="l04067"></a>04067         <span class="keywordflow">if</span> (mag_only) {
<a name="l04068"></a>04068           res = <span class="keyword">static_cast&lt;</span><span class="keywordtype">float</span><span class="keyword">&gt;</span>(vcl_fabs(sum));
<a name="l04069"></a>04069         }
<a name="l04070"></a>04070         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (signed_response) {
<a name="l04071"></a>04071           res = <span class="keyword">static_cast&lt;</span><span class="keywordtype">float</span><span class="keyword">&gt;</span>(<a class="code" href="classbrip__vil__float__ops.html#aa53780e68774a9005f49508d8b9a221a" title="Add two images from a general resource (forces types to be the same).">sum</a>);
<a name="l04072"></a>04072         }
<a name="l04073"></a>04073         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (bright) { <span class="comment">// coefficients are negative at center</span>
<a name="l04074"></a>04074           <span class="keywordflow">if</span> (sum&lt;0) res = <span class="keyword">static_cast&lt;</span><span class="keywordtype">float</span><span class="keyword">&gt;</span>(-<a class="code" href="classbrip__vil__float__ops.html#aa53780e68774a9005f49508d8b9a221a" title="Add two images from a general resource (forces types to be the same).">sum</a>);
<a name="l04075"></a>04075         }
<a name="l04076"></a>04076         <span class="keywordflow">else</span> {
<a name="l04077"></a>04077           <span class="keywordflow">if</span> (sum&gt;0) res = <span class="keyword">static_cast&lt;</span><span class="keywordtype">float</span><span class="keyword">&gt;</span>(<a class="code" href="classbrip__vil__float__ops.html#aa53780e68774a9005f49508d8b9a221a" title="Add two images from a general resource (forces types to be the same).">sum</a>);
<a name="l04078"></a>04078         }
<a name="l04079"></a>04079         <span class="comment">// pick largest angle response magnitude</span>
<a name="l04080"></a>04080         <span class="keywordflow">if</span> (vcl_fabs(res_img(i,j)) &lt; vcl_fabs(res)) {
<a name="l04081"></a>04081           res_img(i,j) = res;
<a name="l04082"></a>04082           res_angle(i,j) = theta_i;
<a name="l04083"></a>04083         }
<a name="l04084"></a>04084       }
<a name="l04085"></a>04085     }
<a name="l04086"></a>04086     vcl_cout &lt;&lt; <span class="charliteral">&#39;.&#39;</span>;
<a name="l04087"></a>04087   }
<a name="l04088"></a>04088   vcl_cout &lt;&lt; <span class="charliteral">&#39;\n&#39;</span>;
<a name="l04089"></a>04089   <span class="keywordflow">if</span> (!non_max_suppress) <span class="keywordflow">return</span> res_img;
<a name="l04090"></a>04090   <span class="comment">// now we have pixel-wise best angle, run the non-max suppression around each non-zero pixel using the angles mask</span>
<a name="l04091"></a>04091   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> res(res_img);
<a name="l04092"></a>04092 
<a name="l04093"></a>04093   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> j = max_rji; j&lt;(nj-max_rji); j++)
<a name="l04094"></a>04094     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> i = max_rji; i&lt;(ni-max_rji); i++)
<a name="l04095"></a>04095     {
<a name="l04096"></a>04096       <span class="keywordtype">float</span> cv = res_img(i,j);
<a name="l04097"></a>04097       <span class="keywordflow">if</span> (!cv)
<a name="l04098"></a>04098         <span class="keywordflow">continue</span>;
<a name="l04099"></a>04099       <span class="keywordtype">int</span> theta_i = res_angle(i,j);
<a name="l04100"></a>04100       <a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__array__2d.html">vbl_array_2d&lt;bool&gt;</a> mask = mask_vect[theta_i];
<a name="l04101"></a>04101       <span class="keywordtype">unsigned</span> nrows = mask.<a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__array__2d.html#abe25ab10299a0b1c6a075895bfb85fe6">rows</a>(), ncols = mask.<a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__array__2d.html#a5d1d6d4ecc26eff6b99e456078924be6">cols</a>();
<a name="l04102"></a>04102       <span class="keywordtype">int</span> rj = (nrows-1)/2, ri = (ncols-1)/2;
<a name="l04103"></a>04103 
<a name="l04104"></a>04104       <span class="keywordtype">bool</span> max = <span class="keyword">true</span>;
<a name="l04105"></a>04105       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> jj=-rj; jj&lt;=rj; ++jj) {
<a name="l04106"></a>04106         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> ii=-ri; ii&lt;=ri; ++ii) {
<a name="l04107"></a>04107           <span class="keywordflow">if</span> ((ii!=0||jj!=0) &amp;&amp; mask[jj+rj][ii+ri] &amp;&amp; res_img(i+ii, j+jj)&gt;cv) {
<a name="l04108"></a>04108             max = <span class="keyword">false</span>;
<a name="l04109"></a>04109             <span class="keywordflow">break</span>;
<a name="l04110"></a>04110           }
<a name="l04111"></a>04111         }
<a name="l04112"></a>04112         <span class="keywordflow">if</span> (!max)
<a name="l04113"></a>04113           <span class="keywordflow">break</span>;
<a name="l04114"></a>04114       }
<a name="l04115"></a>04115       <span class="keywordflow">if</span> (!max) {
<a name="l04116"></a>04116         res(i,j) = 0.0f;
<a name="l04117"></a>04117         res_angle(i, j) = 0; <span class="comment">// the zeroth angle is -1.0f, so invalid</span>
<a name="l04118"></a>04118       }
<a name="l04119"></a>04119     }
<a name="l04120"></a>04120 
<a name="l04121"></a>04121   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> res_mask(ni, nj);
<a name="l04122"></a>04122   res_mask.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html#a6fd591632020e490abb5e4493a52dbba">fill</a>(0.0f);
<a name="l04123"></a>04123   <span class="comment">// now all the non-zero elements in res are our responses, create the mask image using the angle info</span>
<a name="l04124"></a>04124   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> j = max_rji; j&lt;(nj-max_rji); j++)
<a name="l04125"></a>04125     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> i = max_rji; i&lt;(ni-max_rji); i++)
<a name="l04126"></a>04126     {
<a name="l04127"></a>04127       <span class="keywordtype">float</span> rv = res(i,j);
<a name="l04128"></a>04128       <span class="keywordflow">if</span> (!rv)
<a name="l04129"></a>04129         <span class="keywordflow">continue</span>;
<a name="l04130"></a>04130       <span class="keywordtype">int</span> theta_i = res_angle(i,j);
<a name="l04131"></a>04131       <span class="comment">// get the mask for this angle</span>
<a name="l04132"></a>04132       <a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__array__2d.html">vbl_array_2d&lt;bool&gt;</a> mask = mask_vect[theta_i];
<a name="l04133"></a>04133       <span class="keywordtype">unsigned</span> nrows = mask.<a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__array__2d.html#abe25ab10299a0b1c6a075895bfb85fe6">rows</a>(), ncols = mask.<a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__array__2d.html#a5d1d6d4ecc26eff6b99e456078924be6">cols</a>();
<a name="l04134"></a>04134       <span class="keywordtype">int</span> rj = (nrows-1)/2, ri = (ncols-1)/2;
<a name="l04135"></a>04135 
<a name="l04136"></a>04136       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> jj=-rj; jj&lt;=rj; ++jj)
<a name="l04137"></a>04137         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> ii=-ri; ii&lt;=ri; ++ii)
<a name="l04138"></a>04138           <span class="keywordflow">if</span> (mask[jj+rj][ii+ri])
<a name="l04139"></a>04139             <span class="keywordflow">if</span> (rv&gt;res_mask(i+ii,j+jj))
<a name="l04140"></a>04140               res_mask(i+ii,j+jj) = rv;
<a name="l04141"></a>04141     }
<a name="l04142"></a>04142 
<a name="l04143"></a>04143   <span class="comment">// now prepare the output accordingly</span>
<a name="l04144"></a>04144   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> j = max_rji; j&lt;(nj-max_rji); j++)
<a name="l04145"></a>04145     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> i = max_rji; i&lt;(ni-max_rji); i++)
<a name="l04146"></a>04146     {
<a name="l04147"></a>04147       output(i,j,0) = res(i,j);
<a name="l04148"></a>04148       output(i,j,1) = angles[res_angle(i,j)];
<a name="l04149"></a>04149       output(i,j,2) = res_mask(i,j);
<a name="l04150"></a>04150     }
<a name="l04151"></a>04151   <span class="keywordflow">return</span> output;
<a name="l04152"></a>04152 }
<a name="l04153"></a>04153 
<a name="l04154"></a>04154 
<a name="l04155"></a><a class="code" href="classbrip__vil__float__ops.html#ac450c96a526467ea2ee258ccf70682af">04155</a> <span class="comment">//: theta and phi are in radians</span>
<a name="l04156"></a>04156 <span class="keywordtype">float</span> <a class="code" href="classbrip__vil__float__ops.html#ac450c96a526467ea2ee258ccf70682af" title="u-coordinate of an ellipse defined by lambda0, lambda1 and theta, vs. phi.">brip_vil_float_ops::elu</a>(<span class="keywordtype">float</span> phi, <span class="keywordtype">float</span> lamda0,
<a name="l04157"></a>04157                               <span class="keywordtype">float</span> lambda1, <span class="keywordtype">float</span> theta)
<a name="l04158"></a>04158 {
<a name="l04159"></a>04159   <span class="keywordtype">double</span> sp = vcl_sin(phi), cp = vcl_cos(phi);
<a name="l04160"></a>04160   <span class="keywordtype">double</span> st = vcl_sin(theta), ct = vcl_cos(theta);
<a name="l04161"></a>04161   <span class="keywordtype">double</span> temp = 3.0*lamda0*cp*ct-3.0*lambda1*sp*st;
<a name="l04162"></a>04162   <span class="keywordflow">return</span> <span class="keyword">static_cast&lt;</span><span class="keywordtype">float</span><span class="keyword">&gt;</span>(temp);
<a name="l04163"></a>04163 }
<a name="l04164"></a>04164 
<a name="l04165"></a><a class="code" href="classbrip__vil__float__ops.html#ab28d1b93c4d2d49d2ce6982d1ead5716">04165</a> <span class="comment">//: theta and phi are in radians</span>
<a name="l04166"></a>04166 <span class="keywordtype">float</span> <a class="code" href="classbrip__vil__float__ops.html#ab28d1b93c4d2d49d2ce6982d1ead5716" title="v-coordinate of an ellipse defined by lambda0, lambda1 and theta, vs. phi.">brip_vil_float_ops::elv</a>(<span class="keywordtype">float</span> phi, <span class="keywordtype">float</span> lamda0,
<a name="l04167"></a>04167                               <span class="keywordtype">float</span> lambda1, <span class="keywordtype">float</span> theta)
<a name="l04168"></a>04168 {
<a name="l04169"></a>04169   <span class="keywordtype">double</span> sp = vcl_sin(phi), cp = vcl_cos(phi);
<a name="l04170"></a>04170   <span class="keywordtype">double</span> st = vcl_sin(theta), ct = vcl_cos(theta);
<a name="l04171"></a>04171   <span class="keywordtype">double</span> temp = 3.0*lamda0*st*cp + 3.0*lambda1*sp*ct;
<a name="l04172"></a>04172   <span class="keywordflow">return</span> <span class="keyword">static_cast&lt;</span><span class="keywordtype">float</span><span class="keyword">&gt;</span>(temp);
<a name="l04173"></a>04173 }
<a name="l04174"></a>04174 
<a name="l04175"></a>04175 <span class="comment">//: theta and phi are in radians</span>
<a name="l04176"></a><a class="code" href="classbrip__vil__float__ops.html#a8690eb7bf2266cb38bd43d479e0a217d">04176</a> <span class="keywordtype">void</span> <a class="code" href="classbrip__vil__float__ops.html#a8690eb7bf2266cb38bd43d479e0a217d" title="Compute the inscribed rectangle in an ellipse with largest $(1+h)(1+w)$.">brip_vil_float_ops::</a>
<a name="l04177"></a>04177 <a class="code" href="classbrip__vil__float__ops.html#a8690eb7bf2266cb38bd43d479e0a217d" title="Compute the inscribed rectangle in an ellipse with largest $(1+h)(1+w)$.">max_inscribed_rect</a>(<span class="keywordtype">float</span> lambda0, <span class="keywordtype">float</span> lambda1, <span class="keywordtype">float</span> theta,
<a name="l04178"></a>04178                    <span class="keywordtype">float</span>&amp; u_rect, <span class="keywordtype">float</span>&amp; v_rect)
<a name="l04179"></a>04179 {
<a name="l04180"></a>04180   <span class="keywordtype">float</span> sign = -1.0f;
<a name="l04181"></a>04181   <span class="keywordflow">if</span> (theta&lt;0) sign = 1.0f;
<a name="l04182"></a>04182   <span class="keywordtype">float</span> th_rad = <span class="keyword">static_cast&lt;</span><span class="keywordtype">float</span><span class="keyword">&gt;</span>(theta*vnl_math::pi_over_180);
<a name="l04183"></a>04183   <span class="keywordtype">float</span> maxa = 0.0f, max_phi = 0.0f;
<a name="l04184"></a>04184   <span class="keywordflow">for</span> (<span class="keywordtype">float</span> phi = -<span class="keywordtype">float</span>(vnl_math::pi); phi&lt;=float(vnl_math::pi); phi+=0.01f)
<a name="l04185"></a>04185   {
<a name="l04186"></a>04186     <span class="keywordtype">float</span> a = (1.0f+<a class="code" href="classbrip__vil__float__ops.html#ac450c96a526467ea2ee258ccf70682af" title="u-coordinate of an ellipse defined by lambda0, lambda1 and theta, vs. phi.">brip_vil_float_ops::elu</a>(phi, lambda0, lambda1, th_rad));
<a name="l04187"></a>04187     a *= (1.0f+ sign*<a class="code" href="classbrip__vil__float__ops.html#ab28d1b93c4d2d49d2ce6982d1ead5716" title="v-coordinate of an ellipse defined by lambda0, lambda1 and theta, vs. phi.">brip_vil_float_ops::elv</a>(phi, lambda0, lambda1, th_rad));
<a name="l04188"></a>04188     <span class="keywordflow">if</span> (a&gt;maxa)
<a name="l04189"></a>04189     {
<a name="l04190"></a>04190       maxa = a;
<a name="l04191"></a>04191       max_phi = phi;
<a name="l04192"></a>04192     }
<a name="l04193"></a>04193   }
<a name="l04194"></a>04194   u_rect = <a class="code" href="classbrip__vil__float__ops.html#ac450c96a526467ea2ee258ccf70682af" title="u-coordinate of an ellipse defined by lambda0, lambda1 and theta, vs. phi.">brip_vil_float_ops::elu</a>(max_phi, lambda0, lambda1, th_rad);
<a name="l04195"></a>04195   v_rect = <a class="code" href="classbrip__vil__float__ops.html#ab28d1b93c4d2d49d2ce6982d1ead5716" title="v-coordinate of an ellipse defined by lambda0, lambda1 and theta, vs. phi.">brip_vil_float_ops::elv</a>(max_phi, lambda0, lambda1, th_rad);
<a name="l04196"></a>04196   v_rect = vcl_fabs(v_rect);
<a name="l04197"></a>04197 }
<a name="l04198"></a>04198 
<a name="l04199"></a>04199 <span class="keyword">static</span> <span class="keywordtype">void</span> eu(<span class="keywordtype">float</span> lambda0, <span class="keywordtype">float</span> cutoff_per, vcl_vector&lt;float&gt;&amp; kernel)
<a name="l04200"></a>04200 {
<a name="l04201"></a>04201   kernel.clear();
<a name="l04202"></a>04202   <span class="keywordtype">double</span> l_sqi = 1/(lambda0*lambda0);
<a name="l04203"></a>04203   <span class="keywordtype">double</span> norm = 1/vcl_sqrt(2.0*vnl_math::pi);
<a name="l04204"></a>04204   norm /= lambda0;
<a name="l04205"></a>04205   <span class="keywordtype">int</span> r = <span class="keyword">static_cast&lt;</span><span class="keywordtype">int</span><span class="keyword">&gt;</span>(vcl_sqrt((-2.0*vcl_log(cutoff_per))/l_sqi)+0.5);
<a name="l04206"></a>04206   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = -r; i&lt;=r; ++i)
<a name="l04207"></a>04207   {
<a name="l04208"></a>04208     <span class="keywordtype">double</span> k = vcl_exp(-0.5*i*i*l_sqi);
<a name="l04209"></a>04209     k*=norm;
<a name="l04210"></a>04210     kernel.push_back(static_cast&lt;float&gt;(k));
<a name="l04211"></a>04211   }
<a name="l04212"></a>04212 }
<a name="l04213"></a>04213 
<a name="l04214"></a>04214 <span class="keyword">static</span> <span class="keywordtype">void</span> ev(<span class="keywordtype">float</span> lambda1, <span class="keywordtype">float</span> cutoff_per, <span class="keywordtype">bool</span> scale_invariant,
<a name="l04215"></a>04215                vcl_vector&lt;float&gt;&amp; kernel)
<a name="l04216"></a>04216 {
<a name="l04217"></a>04217   kernel.clear();
<a name="l04218"></a>04218   <span class="keywordtype">double</span> l1_sqi = 1/(lambda1*lambda1);
<a name="l04219"></a>04219   <span class="keywordtype">int</span> r = <span class="keyword">static_cast&lt;</span><span class="keywordtype">int</span><span class="keyword">&gt;</span>(vcl_sqrt((-2.0*vcl_log(cutoff_per))/l1_sqi)+0.5);
<a name="l04220"></a>04220   <span class="keywordtype">double</span> norm = scale_invariant ? 1/lambda1 : l1_sqi/lambda1;
<a name="l04221"></a>04221   norm /= vcl_sqrt(2.0*vnl_math::pi);
<a name="l04222"></a>04222   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = -r; i&lt;=r; ++i)
<a name="l04223"></a>04223   {
<a name="l04224"></a>04224     <span class="keywordtype">double</span> s = i*i*l1_sqi;
<a name="l04225"></a>04225     <span class="keywordtype">double</span> k = vcl_exp(-0.5*s);
<a name="l04226"></a>04226     k *= norm*(s-1.0);
<a name="l04227"></a>04227     kernel.push_back(static_cast&lt;float&gt;(k));
<a name="l04228"></a>04228   }
<a name="l04229"></a>04229 }
<a name="l04230"></a>04230 
<a name="l04231"></a>04231 <span class="keyword">static</span> <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> convolve_u(<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> <span class="keyword">const</span>&amp; image,
<a name="l04232"></a>04232                                         vcl_vector&lt;float&gt; <span class="keyword">const</span>&amp; kernel,
<a name="l04233"></a>04233                                         <span class="keywordtype">bool</span> initialize = <span class="keyword">true</span>)
<a name="l04234"></a>04234 {
<a name="l04235"></a>04235   <span class="keywordtype">int</span> nk = kernel.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#ad9be33d94e81b6957af71b2e030cef6a">size</a>();
<a name="l04236"></a>04236   <span class="keywordflow">if</span> (nk&lt;3)
<a name="l04237"></a>04237     <span class="keywordflow">return</span> image;
<a name="l04238"></a>04238   <span class="keywordtype">int</span> ni = image.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a9ea9ad565387a61dccf38fc80a266c2a">ni</a>(), nj = image.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a44859c72206da7d18728cb2bbf8ae829">nj</a>();
<a name="l04239"></a>04239   <span class="keywordtype">int</span> ru = (nk-1)/2;
<a name="l04240"></a>04240   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> Iu(ni, nj);
<a name="l04241"></a>04241   <span class="keywordflow">if</span> (initialize) Iu.fill(0.0f);
<a name="l04242"></a>04242   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = 0; j&lt;nj; ++j)
<a name="l04243"></a>04243     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = ru; i&lt;ni-ru; ++i) {
<a name="l04244"></a>04244       <span class="keywordtype">float</span> sum = 0.0f;
<a name="l04245"></a>04245       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> k = -ru; k&lt;=ru; ++k)
<a name="l04246"></a>04246       {
<a name="l04247"></a>04247         <span class="keywordtype">float</span> <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/vgl__vector__2d_8h.html#a38bf1e5e0427bdeba2b469eea9befc23">v</a> = image(i+k, j);
<a name="l04248"></a>04248         sum += kernel[k+ru]*v;
<a name="l04249"></a>04249       }
<a name="l04250"></a>04250       Iu(i,j) = sum;
<a name="l04251"></a>04251     }
<a name="l04252"></a>04252   <span class="keywordflow">return</span> Iu;
<a name="l04253"></a>04253 }
<a name="l04254"></a>04254 
<a name="l04255"></a>04255 <span class="keyword">static</span> <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> convolve_v(<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> <span class="keyword">const</span>&amp; image,
<a name="l04256"></a>04256                                         vcl_vector&lt;float&gt; <span class="keyword">const</span>&amp; kernel,
<a name="l04257"></a>04257                                         <span class="keywordtype">bool</span> initialize = <span class="keyword">true</span>)
<a name="l04258"></a>04258 {
<a name="l04259"></a>04259   <span class="keywordtype">int</span> nk = kernel.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#ad9be33d94e81b6957af71b2e030cef6a">size</a>();
<a name="l04260"></a>04260   <span class="keywordflow">if</span> (nk&lt;3)
<a name="l04261"></a>04261     <span class="keywordflow">return</span> image;
<a name="l04262"></a>04262   <span class="keywordtype">int</span> ni = image.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a9ea9ad565387a61dccf38fc80a266c2a">ni</a>(), nj = image.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a44859c72206da7d18728cb2bbf8ae829">nj</a>();
<a name="l04263"></a>04263   <span class="keywordtype">int</span> rv = (nk-1)/2;
<a name="l04264"></a>04264   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> Iv(ni, nj);
<a name="l04265"></a>04265   <span class="keywordflow">if</span> (initialize) Iv.fill(0.0f);
<a name="l04266"></a>04266   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = rv; j&lt;nj-rv; ++j)
<a name="l04267"></a>04267     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i&lt;ni; ++i) {
<a name="l04268"></a>04268       <span class="keywordtype">float</span> sum = 0.0f;
<a name="l04269"></a>04269       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> k = -rv; k&lt;=rv; ++k)
<a name="l04270"></a>04270       {
<a name="l04271"></a>04271         <span class="keywordtype">float</span> <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/vgl__vector__2d_8h.html#a38bf1e5e0427bdeba2b469eea9befc23">v</a> = image(i, j+k);
<a name="l04272"></a>04272         sum += kernel[k+rv]*v;
<a name="l04273"></a>04273       }
<a name="l04274"></a>04274       Iv(i,j) = sum;
<a name="l04275"></a>04275     }
<a name="l04276"></a>04276   <span class="keywordflow">return</span> Iv;
<a name="l04277"></a>04277 }
<a name="l04278"></a>04278 
<a name="l04279"></a>04279 <span class="comment">// this function tracks the image origin during rotation</span>
<a name="l04280"></a>04280 <span class="comment">// the calculations are the same as used in the homography method.</span>
<a name="l04281"></a>04281 <span class="keyword">static</span> <span class="keywordtype">void</span> rotation_offset(<span class="keywordtype">int</span> ni, <span class="keywordtype">int</span> nj, <span class="keywordtype">float</span> theta_deg,
<a name="l04282"></a>04282                             <span class="keywordtype">int</span> i, <span class="keywordtype">int</span> j, <span class="keywordtype">int</span>&amp; ti, <span class="keywordtype">int</span>&amp; tj)
<a name="l04283"></a>04283 {
<a name="l04284"></a>04284   ti= 0; tj = 0;
<a name="l04285"></a>04285   <span class="keywordtype">double</span> deg_to_rad = vnl_math::pi_over_180;
<a name="l04286"></a>04286   <span class="keywordtype">double</span> rang = deg_to_rad*theta_deg;
<a name="l04287"></a>04287   <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__h__matrix__2d.html">vgl_h_matrix_2d&lt;double&gt;</a> H;
<a name="l04288"></a>04288   H.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__h__matrix__2d.html#a6b07c0342624f3d5a1d1b696acf0a31e">set_identity</a>().<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__h__matrix__2d.html#a33b79fa18f9763fa5075553e631afdb3">set_rotation</a>(rang);
<a name="l04289"></a>04289   <a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__smart__ptr.html">vsol_box_2d_sptr</a> input_roi;
<a name="l04290"></a>04290   <a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__smart__ptr.html">vsol_polygon_2d_sptr</a> input_poly, output_poly;
<a name="l04291"></a>04291   input_roi = <span class="keyword">new</span> <a class="codeRef" doxygen="contrib_gel_vsol.tag:../../../../../contrib/gel/vsol/html" href="../../../../../contrib/gel/vsol/html/classvsol__box__2d.html">vsol_box_2d</a>();
<a name="l04292"></a>04292   input_roi-&gt;add_point(0, 0);
<a name="l04293"></a>04293   input_roi-&gt;add_point(ni, nj);
<a name="l04294"></a>04294   input_poly = <a class="codeRef" doxygen="contrib_brl_bbas_bsol.tag:../../../../../contrib/brl/bbas/bsol/html" href="../../../../../contrib/brl/bbas/bsol/html/classbsol__algs.html#a86bf45c002817d85e4cea675a6b631d6">bsol_algs::poly_from_box</a>(input_roi);
<a name="l04295"></a>04295   <span class="keywordflow">if</span> (!<a class="codeRef" doxygen="contrib_brl_bbas_bsol.tag:../../../../../contrib/brl/bbas/bsol/html" href="../../../../../contrib/brl/bbas/bsol/html/classbsol__algs.html#a45c1ae3acd32c0931018b707a5823ccf">bsol_algs::homography</a>(input_poly, H, output_poly))
<a name="l04296"></a>04296     <span class="keywordflow">return</span>;
<a name="l04297"></a>04297   <a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__smart__ptr.html">vsol_box_2d_sptr</a> temp = output_poly-&gt;get_bounding_box();
<a name="l04298"></a>04298   <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__h__matrix__2d.html">vgl_h_matrix_2d&lt;double&gt;</a> t; t.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__h__matrix__2d.html#a6b07c0342624f3d5a1d1b696acf0a31e">set_identity</a>().<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__h__matrix__2d.html#aa1fdf29fb9a7bf70e066fbd25d8d8857">set_translation</a>(-temp-&gt;get_min_x(),-temp-&gt;get_min_y());
<a name="l04299"></a>04299   <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__point__2d.html">vgl_homg_point_2d&lt;double&gt;</a> torg = (t*H)*<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__point__2d.html">vgl_homg_point_2d&lt;double&gt;</a>(<span class="keywordtype">double</span>(i),double(j));
<a name="l04300"></a>04300   ti = <span class="keyword">static_cast&lt;</span><span class="keywordtype">int</span><span class="keyword">&gt;</span>(torg.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__point__2d.html#a1d928ee2aae43e7cc7bec7e2db2ad989">x</a>());
<a name="l04301"></a>04301   tj = <span class="keyword">static_cast&lt;</span><span class="keywordtype">int</span><span class="keyword">&gt;</span>(torg.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__homg__point__2d.html#a098f0121fa0b75d2f4171d00a1bf7f31">y</a>());
<a name="l04302"></a>04302 }
<a name="l04303"></a>04303 
<a name="l04304"></a><a class="code" href="classbrip__vil__float__ops.html#a059bbe4180291ff0122302ce56074f80">04304</a> <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> <a class="code" href="classbrip__vil__float__ops.html#a059bbe4180291ff0122302ce56074f80" title="Find intensity extrema using kernel decomposition.">brip_vil_float_ops::</a>
<a name="l04305"></a>04305 <a class="code" href="classbrip__vil__float__ops.html#a059bbe4180291ff0122302ce56074f80" title="Find intensity extrema using kernel decomposition.">fast_extrema</a>(<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> <span class="keyword">const</span>&amp; input, <span class="keywordtype">float</span> lambda0, <span class="keywordtype">float</span> lambda1,
<a name="l04306"></a>04306              <span class="keywordtype">float</span> theta, <span class="keywordtype">bool</span> bright, <span class="keywordtype">bool</span> mag_only,<span class="keywordtype">bool</span> output_response_mask,
<a name="l04307"></a>04307              <span class="keywordtype">bool</span> signed_response, <span class="keywordtype">bool</span> scale_invariant, <span class="keywordtype">bool</span> non_max_suppress,
<a name="l04308"></a>04308              <span class="keywordtype">float</span> cutoff)
<a name="l04309"></a>04309 {
<a name="l04310"></a>04310   <span class="comment">// invalid choice</span>
<a name="l04311"></a>04311   assert(!(mag_only&amp;&amp;signed_response));
<a name="l04312"></a>04312   <span class="comment">// the kernels for u and v</span>
<a name="l04313"></a>04313   vcl_vector&lt;float&gt; euk, evk;
<a name="l04314"></a>04314   eu(lambda0, cutoff, euk);
<a name="l04315"></a>04315   ev(lambda1, cutoff, scale_invariant, evk);
<a name="l04316"></a>04316   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> pre_res;
<a name="l04317"></a>04317   <span class="keywordtype">int</span> tuf=0, tvf=0, tui=0, tvi=0;
<a name="l04318"></a>04318   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> rot = input;
<a name="l04319"></a>04319   <span class="keywordtype">bool</span> ang90 = theta==90.0f||theta == 270.0f||
<a name="l04320"></a>04320     theta ==-90.0f||theta == -270.0f;
<a name="l04321"></a>04321   <span class="comment">// rotate the image to the specified angle (minus due to flipped v axis)</span>
<a name="l04322"></a>04322   <span class="keywordflow">if</span> (theta!=0&amp;&amp;!ang90)
<a name="l04323"></a>04323     rot = <a class="code" href="classbrip__vil__float__ops.html#a9ae7c0edadcf398dc0081cd85d05982f" title="rotate the input image counter-clockwise about the image origin.">brip_vil_float_ops::rotate</a>(input, -theta);
<a name="l04324"></a>04324   <span class="keywordflow">if</span> (!ang90) {
<a name="l04325"></a>04325     <span class="comment">// convolve kernel across rows</span>
<a name="l04326"></a>04326     <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> rotu = convolve_u(rot, euk);
<a name="l04327"></a>04327     <span class="comment">// then convolve along columns</span>
<a name="l04328"></a>04328     <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> rotuv = convolve_v(rotu, evk);
<a name="l04329"></a>04329     <span class="comment">// rotate back</span>
<a name="l04330"></a>04330     <span class="keywordflow">if</span> (theta!=0)
<a name="l04331"></a>04331     {
<a name="l04332"></a>04332       pre_res = <a class="code" href="classbrip__vil__float__ops.html#a9ae7c0edadcf398dc0081cd85d05982f" title="rotate the input image counter-clockwise about the image origin.">brip_vil_float_ops::rotate</a>(rotuv, +theta);
<a name="l04333"></a>04333       <span class="comment">// there is a border around the image to contain the rotated version</span>
<a name="l04334"></a>04334       <span class="comment">// which should be removed.</span>
<a name="l04335"></a>04335       rotation_offset(input.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a9ea9ad565387a61dccf38fc80a266c2a">ni</a>(), input.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a44859c72206da7d18728cb2bbf8ae829">nj</a>(), -theta, 0, 0, tuf, tvf);
<a name="l04336"></a>04336       rotation_offset(rotuv.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a9ea9ad565387a61dccf38fc80a266c2a">ni</a>(), rotuv.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a44859c72206da7d18728cb2bbf8ae829">nj</a>(), +theta, tuf, tvf, tui, tvi);
<a name="l04337"></a>04337     }
<a name="l04338"></a>04338     <span class="keywordflow">else</span> pre_res = rotuv;
<a name="l04339"></a>04339   }
<a name="l04340"></a>04340   <span class="keywordflow">else</span> {
<a name="l04341"></a>04341     <span class="comment">// convolve along columns</span>
<a name="l04342"></a>04342     <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> rotv = convolve_v(rot, euk);
<a name="l04343"></a>04343     <span class="comment">// convolve across rows</span>
<a name="l04344"></a>04344     <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> rotvu = convolve_u(rotv, evk);
<a name="l04345"></a>04345     pre_res = rotvu;
<a name="l04346"></a>04346   }
<a name="l04347"></a>04347   <span class="keywordtype">int</span> ni = input.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a9ea9ad565387a61dccf38fc80a266c2a">ni</a>(), nj = input.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a44859c72206da7d18728cb2bbf8ae829">nj</a>();
<a name="l04348"></a>04348   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> res(ni, nj);
<a name="l04349"></a>04349   res.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html#a6fd591632020e490abb5e4493a52dbba">fill</a>(0.0f);
<a name="l04350"></a>04350   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> temp2(ni, nj);
<a name="l04351"></a>04351   temp2.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html#a6fd591632020e490abb5e4493a52dbba">fill</a>(0.0f);
<a name="l04352"></a>04352   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = 0; j&lt;nj; ++j)
<a name="l04353"></a>04353     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i&lt;ni; ++i)
<a name="l04354"></a>04354     {
<a name="l04355"></a>04355       <span class="keywordtype">float</span> <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/vgl__vector__2d_8h.html#a38bf1e5e0427bdeba2b469eea9befc23">v</a> = pre_res(i + tui, j+ tvi);
<a name="l04356"></a>04356       <span class="keywordflow">if</span> (mag_only) {
<a name="l04357"></a>04357         res(i,j) = vcl_fabs(v);
<a name="l04358"></a>04358       }
<a name="l04359"></a>04359       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (bright) { <span class="comment">// coefficients are negative at center</span>
<a name="l04360"></a>04360         <span class="keywordflow">if</span> (v&lt;0) res(i,j) = -v;
<a name="l04361"></a>04361       }
<a name="l04362"></a>04362       <span class="keywordflow">else</span> {
<a name="l04363"></a>04363         <span class="keywordflow">if</span> (v&gt;0) res(i,j) = v;
<a name="l04364"></a>04364       }
<a name="l04365"></a>04365       temp2(i,j) = v;<span class="comment">// signed output</span>
<a name="l04366"></a>04366     }
<a name="l04367"></a>04367   <span class="keywordflow">if</span> (!non_max_suppress &amp;&amp; !output_response_mask) {
<a name="l04368"></a>04368     <span class="keywordflow">return</span> signed_response ? temp2 : res;
<a name="l04369"></a>04369   }
<a name="l04370"></a>04370   <span class="comment">// TO DO! handle non_max_suppress==false but response_mask==true</span>
<a name="l04371"></a>04371   <span class="comment">// December 12, 2011 --- JLM</span>
<a name="l04372"></a>04372   <span class="comment">//</span>
<a name="l04373"></a>04373   <span class="comment">// the second derivative convolution is complete</span>
<a name="l04374"></a>04374   <span class="comment">// non-maximal suppression</span>
<a name="l04375"></a>04375   <span class="comment">// determine the inscribed rect in the response mask with max area</span>
<a name="l04376"></a>04376   <span class="keywordtype">float</span> u_rect, v_rect;
<a name="l04377"></a>04377   <a class="code" href="classbrip__vil__float__ops.html#a8690eb7bf2266cb38bd43d479e0a217d" title="Compute the inscribed rectangle in an ellipse with largest $(1+h)(1+w)$.">brip_vil_float_ops::max_inscribed_rect</a>(lambda0,lambda1,theta,u_rect,v_rect);
<a name="l04378"></a>04378   <span class="keywordtype">int</span> ni_rect = <span class="keyword">static_cast&lt;</span><span class="keywordtype">int</span><span class="keyword">&gt;</span>(u_rect);
<a name="l04379"></a>04379   <span class="keywordtype">int</span> nj_rect = <span class="keyword">static_cast&lt;</span><span class="keywordtype">int</span><span class="keyword">&gt;</span>(v_rect);
<a name="l04380"></a>04380   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> res_sup(ni, nj);
<a name="l04381"></a>04381   res_sup.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html#a6fd591632020e490abb5e4493a52dbba">fill</a>(0.0f);
<a name="l04382"></a>04382   <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> i= ni_rect; i&lt; ni-ni_rect; i+= ni_rect+1 )
<a name="l04383"></a>04383     <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> j = nj_rect; j &lt; nj-nj_rect; j += nj_rect+1 ) {
<a name="l04384"></a>04384       <span class="keywordtype">int</span> ci= i, cj = j;
<a name="l04385"></a>04385       <span class="keywordtype">bool</span> find_response = <span class="keyword">false</span>;
<a name="l04386"></a>04386       <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> di= 0; di&lt;= ni_rect; di++ )
<a name="l04387"></a>04387         <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> dj = 0; dj &lt;= nj_rect; dj++ )
<a name="l04388"></a>04388         {
<a name="l04389"></a>04389           <span class="keywordtype">float</span> <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/vgl__vector__2d_8h.html#a38bf1e5e0427bdeba2b469eea9befc23">v</a> = res(ci,cj);
<a name="l04390"></a>04390           <span class="keywordtype">float</span> dv = res(i+di,j+dj);
<a name="l04391"></a>04391           <span class="keywordflow">if</span> (v==0.0f&amp;&amp;dv==0.0f) <span class="keywordflow">continue</span>;
<a name="l04392"></a>04392           find_response = <span class="keyword">true</span>;
<a name="l04393"></a>04393           <span class="keywordflow">if</span> ( v &lt; dv )
<a name="l04394"></a>04394           {
<a name="l04395"></a>04395             ci= i+di;
<a name="l04396"></a>04396             cj = j+dj;
<a name="l04397"></a>04397           }
<a name="l04398"></a>04398         }
<a name="l04399"></a>04399       <span class="keywordflow">if</span> (!find_response)
<a name="l04400"></a>04400         <span class="keywordflow">continue</span>;
<a name="l04401"></a>04401       res_sup(ci,cj) = res(ci,cj);
<a name="l04402"></a>04402     }
<a name="l04403"></a>04403 
<a name="l04404"></a>04404   <span class="comment">// determine the outside bounding box</span>
<a name="l04405"></a>04405   <a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__array__2d.html">vbl_array_2d&lt;float&gt;</a> kern;
<a name="l04406"></a>04406   <a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__array__2d.html">vbl_array_2d&lt;bool&gt;</a> mask;
<a name="l04407"></a>04407   <a class="code" href="classbrip__vil__float__ops.html#a6da9fd4380e539fda1705e96ac453c09" title="theta must be given in degrees.">brip_vil_float_ops::extrema_kernel_mask</a>(lambda0, lambda1, theta, kern, mask);
<a name="l04408"></a>04408   <span class="keywordtype">int</span> ri = (kern.<a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__array__2d.html#a5d1d6d4ecc26eff6b99e456078924be6">cols</a>()-1)/2, rj = (kern.<a class="codeRef" doxygen="core_vbl.tag:../../../../../core/vbl/html" href="../../../../../core/vbl/html/classvbl__array__2d.html#abe25ab10299a0b1c6a075895bfb85fe6">rows</a>()-1)/2;
<a name="l04409"></a>04409   <span class="comment">// go through the array again and search about each retained</span>
<a name="l04410"></a>04410   <span class="comment">// local maximum using the outside bounding box</span>
<a name="l04411"></a>04411   <span class="comment">// there will be at most one non-zero response to test in the inscribed rect</span>
<a name="l04412"></a>04412   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = rj; j&lt;(nj-rj); j++)
<a name="l04413"></a>04413     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = ri; i&lt;(ni-ri); i++)
<a name="l04414"></a>04414     {
<a name="l04415"></a>04415       <span class="keywordtype">float</span> <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/vgl__vector__2d_8h.html#a38bf1e5e0427bdeba2b469eea9befc23">v</a> = res_sup(i,j);
<a name="l04416"></a>04416       <span class="keywordflow">if</span> (v==0.0f) <span class="keywordflow">continue</span>;
<a name="l04417"></a>04417       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> jj=-rj; jj&lt;=rj; ++jj)
<a name="l04418"></a>04418         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> ii=-ri; ii&lt;=ri; ++ii)
<a name="l04419"></a>04419           <span class="keywordflow">if</span> (mask[rj+jj][ri+ii] &amp;&amp; res_sup(i+ii, j+jj)&lt;v)
<a name="l04420"></a>04420             res_sup(i+ii,j+jj)=0.0f;
<a name="l04421"></a>04421     }
<a name="l04422"></a>04422 
<a name="l04423"></a>04423   <span class="keywordflow">if</span> (!output_response_mask&amp;&amp;!signed_response)
<a name="l04424"></a>04424     <span class="keywordflow">return</span> res_sup;
<a name="l04425"></a>04425   <span class="keywordtype">unsigned</span> np = 2;
<a name="l04426"></a>04426   <span class="keywordflow">if</span> (output_response_mask&amp;&amp;signed_response)
<a name="l04427"></a>04427     np = 3;
<a name="l04428"></a>04428   <span class="comment">//response plane and mask plane and/or signed response</span>
<a name="l04429"></a>04429 
<a name="l04430"></a>04430   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> res_mask(ni, nj, np);
<a name="l04431"></a>04431   res_mask.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html#a6fd591632020e490abb5e4493a52dbba">fill</a>(0.0f);
<a name="l04432"></a>04432   <span class="comment">// always copy response to plane 0</span>
<a name="l04433"></a>04433   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = rj; j&lt;(nj-rj); j++)
<a name="l04434"></a>04434     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = ri; i&lt;(ni-ri); i++)
<a name="l04435"></a>04435     {
<a name="l04436"></a>04436       <span class="keywordtype">float</span> rv = res_sup(i,j);
<a name="l04437"></a>04437       res_mask(i,j,0)=rv;
<a name="l04438"></a>04438     }
<a name="l04439"></a>04439   <span class="comment">// copy mask plane to plane 1 (or not)</span>
<a name="l04440"></a>04440   <span class="keywordflow">if</span> (output_response_mask) {
<a name="l04441"></a>04441     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = rj; j&lt;(nj-rj); j++)
<a name="l04442"></a>04442       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = ri; i&lt;(ni-ri); i++)
<a name="l04443"></a>04443       {
<a name="l04444"></a>04444         <span class="keywordtype">float</span> rv = res_sup(i,j);
<a name="l04445"></a>04445         <span class="keywordflow">if</span> (!rv)
<a name="l04446"></a>04446           <span class="keywordflow">continue</span>;
<a name="l04447"></a>04447         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> jj=-rj; jj&lt;=rj; ++jj)
<a name="l04448"></a>04448           <span class="keywordflow">for</span> (<span class="keywordtype">int</span> ii=-ri; ii&lt;=ri; ++ii)
<a name="l04449"></a>04449             <span class="keywordflow">if</span> (mask[jj+rj][ii+ri])
<a name="l04450"></a>04450               <span class="keywordflow">if</span> (rv&gt;res_mask(i+ii,j+jj,1))
<a name="l04451"></a>04451                 res_mask(i+ii,j+jj,1) = rv;
<a name="l04452"></a>04452       }
<a name="l04453"></a>04453   }
<a name="l04454"></a>04454   <span class="comment">// copy signed response to plane 1 if no mask plane, otherwise plane 2</span>
<a name="l04455"></a>04455   <span class="keywordflow">if</span> (signed_response) {
<a name="l04456"></a>04456     <span class="keywordtype">unsigned</span> p = np-1;
<a name="l04457"></a>04457     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = rj; j&lt;(nj-rj); j++)
<a name="l04458"></a>04458       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = ri; i&lt;(ni-ri); i++)
<a name="l04459"></a>04459         res_mask(i,j,p) = temp2(i,j);
<a name="l04460"></a>04460   }
<a name="l04461"></a>04461   <span class="keywordflow">return</span> res_mask;
<a name="l04462"></a>04462 }
<a name="l04463"></a>04463 
<a name="l04464"></a><a class="code" href="classbrip__vil__float__ops.html#a9366aaa86a04023b304df217b58e41e5">04464</a> <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> <a class="code" href="classbrip__vil__float__ops.html#a9366aaa86a04023b304df217b58e41e5">brip_vil_float_ops::</a>
<a name="l04465"></a>04465 <a class="code" href="classbrip__vil__float__ops.html#a9366aaa86a04023b304df217b58e41e5">fast_extrema_rotational</a>(<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> <span class="keyword">const</span>&amp; input,
<a name="l04466"></a>04466                         <span class="keywordtype">float</span> lambda0, <span class="keywordtype">float</span> lambda1,
<a name="l04467"></a>04467                         <span class="keywordtype">float</span> theta_interval,
<a name="l04468"></a>04468                         <span class="keywordtype">bool</span> bright, <span class="keywordtype">bool</span> mag_only,
<a name="l04469"></a>04469                         <span class="keywordtype">bool</span> signed_response, <span class="keywordtype">bool</span> scale_invariant,
<a name="l04470"></a>04470                         <span class="keywordtype">bool</span> non_max_suppress,
<a name="l04471"></a>04471                         <span class="keywordtype">float</span> cutoff) {
<a name="l04472"></a>04472   <span class="keywordtype">unsigned</span> ni = input.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a9ea9ad565387a61dccf38fc80a266c2a">ni</a>(), nj = input.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view__base.html#a44859c72206da7d18728cb2bbf8ae829">nj</a>();
<a name="l04473"></a>04473   <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> <a class="code" href="classbrip__vil__float__ops.html#ae5e1bfc2673ae23cbbffa03ea0e0f3a4">resp</a>(ni, nj);
<a name="l04474"></a>04474   resp.<a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html#a6fd591632020e490abb5e4493a52dbba">fill</a>(0.0f);
<a name="l04475"></a>04475 
<a name="l04476"></a>04476     <span class="comment">// elliptical operator has 180 degree rotational symmetry, so only the angles in the range [0,180] matter</span>
<a name="l04477"></a>04477   <span class="keywordtype">float</span> theta = 0; <span class="keywordtype">unsigned</span> theta_i = 1;
<a name="l04478"></a>04478   <span class="keywordflow">for</span> (; theta &lt; 180; theta += theta_interval, theta_i++)
<a name="l04479"></a>04479   {
<a name="l04480"></a>04480    <a class="codeRef" doxygen="core_vil.tag:../../../../../core/vil/html" href="../../../../../core/vil/html/classvil__image__view.html">vil_image_view&lt;float&gt;</a> temp =
<a name="l04481"></a>04481      <a class="code" href="classbrip__vil__float__ops.html#a059bbe4180291ff0122302ce56074f80" title="Find intensity extrema using kernel decomposition.">fast_extrema</a>(input, lambda0, lambda1, theta, bright,
<a name="l04482"></a>04482                   mag_only, <span class="keyword">false</span>, signed_response,
<a name="l04483"></a>04483                   scale_invariant, <span class="keyword">false</span>, cutoff);
<a name="l04484"></a>04484     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> j = 0; j&lt;nj; ++j)
<a name="l04485"></a>04485       <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> i = 0; i&lt;ni; ++i) {
<a name="l04486"></a>04486         <span class="keywordtype">float</span> <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/vgl__vector__2d_8h.html#a38bf1e5e0427bdeba2b469eea9befc23">v</a> = temp(i,j);
<a name="l04487"></a>04487         <span class="keywordflow">if</span> (vcl_fabs(v)&gt;vcl_fabs(<a class="code" href="classbrip__vil__float__ops.html#ae5e1bfc2673ae23cbbffa03ea0e0f3a4">resp</a>(i,j)))
<a name="l04488"></a>04488           <a class="code" href="classbrip__vil__float__ops.html#ae5e1bfc2673ae23cbbffa03ea0e0f3a4">resp</a>(i,j) = v;
<a name="l04489"></a>04489       }
<a name="l04490"></a>04490   }
<a name="l04491"></a>04491   <span class="keywordflow">return</span> <a class="code" href="classbrip__vil__float__ops.html#ae5e1bfc2673ae23cbbffa03ea0e0f3a4">resp</a>;
<a name="l04492"></a>04492 }
</pre></div></div>
</div>


<hr class="footer"/><address class="footer"><small>
Generated on Thu May 2 2013 08:53:09 for contrib/brl/bseg/brip by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.7.5.1
</small></address>

</body>
</html>
