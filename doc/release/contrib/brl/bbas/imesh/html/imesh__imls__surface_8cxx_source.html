<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
"http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
  <title>contrib/brl/bbas/imesh/algo/imesh_imls_surface.cxx Source File</title>
  <link href="doxygen.css" rel="stylesheet" type="text/css" />
  <link href="tabs.css" rel="stylesheet" type="text/css" />
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
</head>
<body>
<!-- Generated by Doxygen 1.7.5.1 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<div class="title">contrib/brl/bbas/imesh/algo/imesh_imls_surface.cxx</div>  </div>
</div>
<div class="contents">
<a href="imesh__imls__surface_8cxx.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">// This is brl/bbas/imesh/algo/imesh_imls_surface.cxx</span>
<a name="l00002"></a>00002 <span class="preprocessor">#include &quot;<a class="code" href="imesh__imls__surface_8h.html" title="Interpolating Surface functions using IMLS.">imesh_imls_surface.h</a>&quot;</span>
<a name="l00003"></a>00003 <span class="comment">//:</span>
<a name="l00004"></a>00004 <span class="comment">// \file</span>
<a name="l00005"></a>00005 
<a name="l00006"></a>00006 <span class="preprocessor">#include &lt;<a class="code" href="imesh__operations_8h.html" title="Operations on meshes.">imesh/imesh_operations.h</a>&gt;</span>
<a name="l00007"></a>00007 <span class="preprocessor">#include &lt;<a class="code" href="imesh__intersect_8h.html" title="Functions for mesh intersections.">imesh/algo/imesh_intersect.h</a>&gt;</span>
<a name="l00008"></a>00008 <span class="preprocessor">#include &lt;<a class="code" href="imesh__kd__tree_8txx.html" title="A KD-Tree template code.">imesh/algo/imesh_kd_tree.txx</a>&gt;</span>
<a name="l00009"></a>00009 <span class="preprocessor">#include &lt;vcl_cmath.h&gt;</span>
<a name="l00010"></a>00010 <span class="preprocessor">#include &lt;vcl_limits.h&gt;</span>
<a name="l00011"></a>00011 <span class="preprocessor">#include &lt;vcl_cassert.h&gt;</span>
<a name="l00012"></a>00012 
<a name="l00013"></a>00013 <span class="preprocessor">#include &lt;vcl_iostream.h&gt;</span>
<a name="l00014"></a>00014 <span class="preprocessor">#include &lt;vnl/vnl_math.h&gt;</span>
<a name="l00015"></a>00015 <span class="preprocessor">#include &lt;vnl/vnl_double_3.h&gt;</span>
<a name="l00016"></a>00016 
<a name="l00017"></a>00017 
<a name="l00018"></a>00018 <span class="comment">//: Constructor</span>
<a name="l00019"></a><a class="code" href="classimesh__imls__surface.html#a9ff538b162930e8e49cc50d462fe7e87">00019</a> <a class="code" href="classimesh__imls__surface.html#a9ff538b162930e8e49cc50d462fe7e87" title="Constructor.">imesh_imls_surface::imesh_imls_surface</a>(<span class="keyword">const</span> <a class="code" href="classimesh__mesh.html" title="A simple mesh.">imesh_mesh</a>&amp; mesh, <span class="keywordtype">double</span> eps, <span class="keywordtype">double</span> lambda,
<a name="l00020"></a>00020                                        <span class="keywordtype">bool</span> enforce_bounded,
<a name="l00021"></a>00021                                        <span class="keyword">const</span> vcl_set&lt;unsigned int&gt;&amp; no_normal_faces)
<a name="l00022"></a>00022   : verts_(mesh.num_verts()), phi_(mesh.num_verts(),0.0),
<a name="l00023"></a>00023     eps2_(eps*eps), lambda_(lambda), iso_level_(0.0), bounded_(enforce_bounded)
<a name="l00024"></a>00024 {
<a name="l00025"></a>00025   <span class="keyword">const</span> <a class="code" href="classimesh__vertex__array.html" title="An array of vertices of dimension d.">imesh_vertex_array&lt;3&gt;</a>&amp; <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/vgl__vector__2d_8h.html#a38bf1e5e0427bdeba2b469eea9befc23">v</a> = mesh.<a class="code" href="classimesh__mesh.html#ae22a5853a69f2ca520d82433a7f27009" title="Access the vector of vertices.">vertices</a>&lt;3&gt;();
<a name="l00026"></a>00026 
<a name="l00027"></a>00027   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i=0; i&lt;v.<a class="code" href="classimesh__vertex__array.html#a89539d3e40b411109649389c7a2fd6fa" title="returns the number of vertices.">size</a>(); ++i)
<a name="l00028"></a>00028     <a class="code" href="classimesh__imls__surface.html#aec4e66dac2e3dae2d1034a250df17885">verts_</a>[i] = <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__point__3d.html">vgl_point_3d&lt;double&gt;</a>(v[i]);
<a name="l00029"></a>00029 
<a name="l00030"></a>00030   <span class="keywordflow">if</span> (mesh.<a class="code" href="classimesh__mesh.html#a0c318307ea669c54b7fe8f92b9f06df9" title="Access the vector of faces.">faces</a>().<a class="code" href="classimesh__face__array__base.html#a2384d28fc0f452535ab21e9f13ae9830" title="returns the number of vertices per face if the same for all faces, zero otherwise.">regularity</a>() != 3)
<a name="l00031"></a>00031     <a class="code" href="classimesh__imls__surface.html#ae486e3dedfe1a3f9c811f55998dadc3e">triangles_</a> = <a class="code" href="imesh__operations_8cxx.html#a4837785b66816f4aca2a86bdee043642" title="Subdivide mesh faces into triangle.">imesh_triangulate</a>(mesh.<a class="code" href="classimesh__mesh.html#a0c318307ea669c54b7fe8f92b9f06df9" title="Access the vector of faces.">faces</a>());
<a name="l00032"></a>00032   <span class="keywordflow">else</span>
<a name="l00033"></a>00033     <a class="code" href="classimesh__imls__surface.html#ae486e3dedfe1a3f9c811f55998dadc3e">triangles_</a>.reset(<span class="keyword">static_cast&lt;</span><a class="code" href="classimesh__regular__face__array.html" title="An array of mesh faces of arbitrary size.">imesh_regular_face_array&lt;3&gt;</a>*<span class="keyword">&gt;</span>
<a name="l00034"></a>00034                      (mesh.<a class="code" href="classimesh__mesh.html#a0c318307ea669c54b7fe8f92b9f06df9" title="Access the vector of faces.">faces</a>().<a class="code" href="classimesh__face__array__base.html#ab77e8024ddfd27d0b2d567995f864be4" title="Produce a clone of this object (dynamic copy).">clone</a>()));
<a name="l00035"></a>00035 
<a name="l00036"></a>00036   <span class="keywordflow">if</span> (<a class="code" href="classimesh__imls__surface.html#ae415503ef19a41060dd0087206d89d84">bounded_</a>)
<a name="l00037"></a>00037   {
<a name="l00038"></a>00038     <span class="comment">// build enclosure</span>
<a name="l00039"></a>00039     <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__box__3d.html">vgl_box_3d&lt;double&gt;</a> box;
<a name="l00040"></a>00040     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i=0; i&lt;<a class="code" href="classimesh__imls__surface.html#aec4e66dac2e3dae2d1034a250df17885">verts_</a>.size(); ++i) {
<a name="l00041"></a>00041       box.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__box__3d.html#a118584683b9f4ba817acc8a6064b245d">add</a>(<a class="code" href="classimesh__imls__surface.html#aec4e66dac2e3dae2d1034a250df17885">verts_</a>[i]);
<a name="l00042"></a>00042     }
<a name="l00043"></a>00043     box.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__box__3d.html#aa7b30eba1e09fc38826fb1a618721064">expand_about_centroid</a>(1);
<a name="l00044"></a>00044     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> base = <a class="code" href="classimesh__imls__surface.html#aec4e66dac2e3dae2d1034a250df17885">verts_</a>.size();
<a name="l00045"></a>00045     <a class="code" href="classimesh__imls__surface.html#aec4e66dac2e3dae2d1034a250df17885">verts_</a>.push_back(<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__point__3d.html">vgl_point_3d&lt;double&gt;</a>(box.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__box__3d.html#ab79a05c37774165ce3cae19ccbcc549c">min_x</a>(),box.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__box__3d.html#a23726177791036bd1b7ef4db11553abe">min_y</a>(),box.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__box__3d.html#a51ff4f78a35a326eb2fd95a82ca47f3d">min_z</a>()));
<a name="l00046"></a>00046     <a class="code" href="classimesh__imls__surface.html#aec4e66dac2e3dae2d1034a250df17885">verts_</a>.push_back(<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__point__3d.html">vgl_point_3d&lt;double&gt;</a>(box.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__box__3d.html#ab79a05c37774165ce3cae19ccbcc549c">min_x</a>(),box.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__box__3d.html#a23726177791036bd1b7ef4db11553abe">min_y</a>(),box.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__box__3d.html#a6d1e762f48d0420bc28f1e17e9da0f6e">max_z</a>()));
<a name="l00047"></a>00047     <a class="code" href="classimesh__imls__surface.html#aec4e66dac2e3dae2d1034a250df17885">verts_</a>.push_back(<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__point__3d.html">vgl_point_3d&lt;double&gt;</a>(box.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__box__3d.html#ab79a05c37774165ce3cae19ccbcc549c">min_x</a>(),box.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__box__3d.html#aa3b803c856fcdacd649625c2454c02cf">max_y</a>(),box.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__box__3d.html#a51ff4f78a35a326eb2fd95a82ca47f3d">min_z</a>()));
<a name="l00048"></a>00048     <a class="code" href="classimesh__imls__surface.html#aec4e66dac2e3dae2d1034a250df17885">verts_</a>.push_back(<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__point__3d.html">vgl_point_3d&lt;double&gt;</a>(box.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__box__3d.html#ab79a05c37774165ce3cae19ccbcc549c">min_x</a>(),box.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__box__3d.html#aa3b803c856fcdacd649625c2454c02cf">max_y</a>(),box.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__box__3d.html#a6d1e762f48d0420bc28f1e17e9da0f6e">max_z</a>()));
<a name="l00049"></a>00049     <a class="code" href="classimesh__imls__surface.html#aec4e66dac2e3dae2d1034a250df17885">verts_</a>.push_back(<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__point__3d.html">vgl_point_3d&lt;double&gt;</a>(box.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__box__3d.html#afacb5c402d085e4f899b9468f3ea710d">max_x</a>(),box.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__box__3d.html#a23726177791036bd1b7ef4db11553abe">min_y</a>(),box.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__box__3d.html#a51ff4f78a35a326eb2fd95a82ca47f3d">min_z</a>()));
<a name="l00050"></a>00050     <a class="code" href="classimesh__imls__surface.html#aec4e66dac2e3dae2d1034a250df17885">verts_</a>.push_back(<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__point__3d.html">vgl_point_3d&lt;double&gt;</a>(box.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__box__3d.html#afacb5c402d085e4f899b9468f3ea710d">max_x</a>(),box.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__box__3d.html#a23726177791036bd1b7ef4db11553abe">min_y</a>(),box.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__box__3d.html#a6d1e762f48d0420bc28f1e17e9da0f6e">max_z</a>()));
<a name="l00051"></a>00051     <a class="code" href="classimesh__imls__surface.html#aec4e66dac2e3dae2d1034a250df17885">verts_</a>.push_back(<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__point__3d.html">vgl_point_3d&lt;double&gt;</a>(box.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__box__3d.html#afacb5c402d085e4f899b9468f3ea710d">max_x</a>(),box.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__box__3d.html#aa3b803c856fcdacd649625c2454c02cf">max_y</a>(),box.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__box__3d.html#a51ff4f78a35a326eb2fd95a82ca47f3d">min_z</a>()));
<a name="l00052"></a>00052     <a class="code" href="classimesh__imls__surface.html#aec4e66dac2e3dae2d1034a250df17885">verts_</a>.push_back(<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__point__3d.html">vgl_point_3d&lt;double&gt;</a>(box.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__box__3d.html#afacb5c402d085e4f899b9468f3ea710d">max_x</a>(),box.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__box__3d.html#aa3b803c856fcdacd649625c2454c02cf">max_y</a>(),box.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__box__3d.html#a6d1e762f48d0420bc28f1e17e9da0f6e">max_z</a>()));
<a name="l00053"></a>00053     <a class="code" href="classimesh__imls__surface.html#ae486e3dedfe1a3f9c811f55998dadc3e">triangles_</a>-&gt;push_back(<a class="code" href="classimesh__tri.html" title="A triangle face.">imesh_tri</a>(base+0,base+1,base+2));
<a name="l00054"></a>00054     <a class="code" href="classimesh__imls__surface.html#ae486e3dedfe1a3f9c811f55998dadc3e">triangles_</a>-&gt;push_back(<a class="code" href="classimesh__tri.html" title="A triangle face.">imesh_tri</a>(base+1,base+3,base+2));
<a name="l00055"></a>00055     <a class="code" href="classimesh__imls__surface.html#ae486e3dedfe1a3f9c811f55998dadc3e">triangles_</a>-&gt;push_back(<a class="code" href="classimesh__tri.html" title="A triangle face.">imesh_tri</a>(base+0,base+6,base+4));
<a name="l00056"></a>00056     <a class="code" href="classimesh__imls__surface.html#ae486e3dedfe1a3f9c811f55998dadc3e">triangles_</a>-&gt;push_back(<a class="code" href="classimesh__tri.html" title="A triangle face.">imesh_tri</a>(base+0,base+2,base+6));
<a name="l00057"></a>00057     <a class="code" href="classimesh__imls__surface.html#ae486e3dedfe1a3f9c811f55998dadc3e">triangles_</a>-&gt;push_back(<a class="code" href="classimesh__tri.html" title="A triangle face.">imesh_tri</a>(base+2,base+7,base+6));
<a name="l00058"></a>00058     <a class="code" href="classimesh__imls__surface.html#ae486e3dedfe1a3f9c811f55998dadc3e">triangles_</a>-&gt;push_back(<a class="code" href="classimesh__tri.html" title="A triangle face.">imesh_tri</a>(base+2,base+3,base+7));
<a name="l00059"></a>00059     <a class="code" href="classimesh__imls__surface.html#ae486e3dedfe1a3f9c811f55998dadc3e">triangles_</a>-&gt;push_back(<a class="code" href="classimesh__tri.html" title="A triangle face.">imesh_tri</a>(base+3,base+5,base+7));
<a name="l00060"></a>00060     <a class="code" href="classimesh__imls__surface.html#ae486e3dedfe1a3f9c811f55998dadc3e">triangles_</a>-&gt;push_back(<a class="code" href="classimesh__tri.html" title="A triangle face.">imesh_tri</a>(base+3,base+1,base+5));
<a name="l00061"></a>00061     <a class="code" href="classimesh__imls__surface.html#ae486e3dedfe1a3f9c811f55998dadc3e">triangles_</a>-&gt;push_back(<a class="code" href="classimesh__tri.html" title="A triangle face.">imesh_tri</a>(base+1,base+4,base+5));
<a name="l00062"></a>00062     <a class="code" href="classimesh__imls__surface.html#ae486e3dedfe1a3f9c811f55998dadc3e">triangles_</a>-&gt;push_back(<a class="code" href="classimesh__tri.html" title="A triangle face.">imesh_tri</a>(base+1,base+0,base+4));
<a name="l00063"></a>00063     <a class="code" href="classimesh__imls__surface.html#ae486e3dedfe1a3f9c811f55998dadc3e">triangles_</a>-&gt;push_back(<a class="code" href="classimesh__tri.html" title="A triangle face.">imesh_tri</a>(base+4,base+7,base+5));
<a name="l00064"></a>00064     <a class="code" href="classimesh__imls__surface.html#ae486e3dedfe1a3f9c811f55998dadc3e">triangles_</a>-&gt;push_back(<a class="code" href="classimesh__tri.html" title="A triangle face.">imesh_tri</a>(base+4,base+6,base+7));
<a name="l00065"></a>00065     <a class="code" href="classimesh__imls__surface.html#a705d794cccf603a239182df8c1b5a0c7">phi_</a>.resize(<a class="code" href="classimesh__imls__surface.html#aec4e66dac2e3dae2d1034a250df17885">verts_</a>.size(),1.0);
<a name="l00066"></a>00066   }
<a name="l00067"></a>00067 
<a name="l00068"></a>00068   vcl_vector&lt;vgl_box_3d&lt;double&gt; &gt; boxes(<a class="code" href="classimesh__imls__surface.html#ae486e3dedfe1a3f9c811f55998dadc3e">triangles_</a>-&gt;size());
<a name="l00069"></a>00069   <span class="keywordflow">for</span> ( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i=0; i&lt;boxes.size(); ++i ) {
<a name="l00070"></a>00070     <span class="keyword">const</span> <a class="code" href="classimesh__regular__face.html">imesh_regular_face&lt;3&gt;</a>&amp; tri = (*triangles_)[i];
<a name="l00071"></a>00071     boxes[i].add(<a class="code" href="classimesh__imls__surface.html#aec4e66dac2e3dae2d1034a250df17885">verts_</a>[tri[0]]);
<a name="l00072"></a>00072     boxes[i].add(<a class="code" href="classimesh__imls__surface.html#aec4e66dac2e3dae2d1034a250df17885">verts_</a>[tri[1]]);
<a name="l00073"></a>00073     boxes[i].add(<a class="code" href="classimesh__imls__surface.html#aec4e66dac2e3dae2d1034a250df17885">verts_</a>[tri[2]]);
<a name="l00074"></a>00074   }
<a name="l00075"></a>00075 
<a name="l00076"></a>00076   <a class="code" href="classimesh__imls__surface.html#aa6683a2224c8e4099d02ded4258ce857">kd_tree_</a> = <a class="code" href="imesh__kd__tree_8cxx.html#a1b06a5024893c3be32d0c43527469c0f" title="Construct a kd-tree (in 3d) of axis aligned boxes.">imesh_build_kd_tree</a>(boxes);
<a name="l00077"></a>00077   <span class="keywordtype">unsigned</span> num_tree_nodes = <a class="code" href="classimesh__imls__surface.html#ae486e3dedfe1a3f9c811f55998dadc3e">triangles_</a>-&gt;size()*2-1;
<a name="l00078"></a>00078 
<a name="l00079"></a>00079   <a class="code" href="classimesh__imls__surface.html#ae67dc43d910aff02a24cf7ddec257f40">unweighted_</a>.resize(num_tree_nodes);
<a name="l00080"></a>00080   <a class="code" href="classimesh__imls__surface.html#ac32caa7cc6c6dc8192c81243885786f2">centroid_</a>.resize(num_tree_nodes);
<a name="l00081"></a>00081   <a class="code" href="classimesh__imls__surface.html#a94fe59c7af85b8bebc8a1b369f2d81f2">normals_</a>.resize(num_tree_nodes);
<a name="l00082"></a>00082   <a class="code" href="classimesh__imls__surface.html#a4d33d2d1a6571c05d15d089f4fa33dc0">normal_len_</a>.resize(num_tree_nodes);
<a name="l00083"></a>00083   <a class="code" href="classimesh__imls__surface.html#ac9885bb5c4e7aaba58b7b16064c7c5b9">area_</a>.resize(num_tree_nodes);
<a name="l00084"></a>00084 
<a name="l00085"></a>00085 
<a name="l00086"></a>00086   <a class="code" href="classimesh__imls__surface.html#adc010b32d618b945124bd18c394c2efb" title="recursively compute the area weighted centroids.">compute_centroids_rec</a>(<a class="code" href="classimesh__imls__surface.html#aa6683a2224c8e4099d02ded4258ce857">kd_tree_</a>, no_normal_faces);
<a name="l00087"></a>00087   <a class="code" href="classimesh__imls__surface.html#a62e512fab6ab84314c2f97b836835502" title="recursively compute the unweighted integrals.">compute_unweighed_rec</a>(<a class="code" href="classimesh__imls__surface.html#aa6683a2224c8e4099d02ded4258ce857">kd_tree_</a>);
<a name="l00088"></a>00088 
<a name="l00089"></a>00089   <a class="code" href="classimesh__imls__surface.html#a227d30e4fbded856b45fcb72367cae69" title="adjust the phi values until all vertices are within the iso surface.">compute_enclosing_phi</a>();
<a name="l00090"></a>00090 }
<a name="l00091"></a>00091 
<a name="l00092"></a>00092 
<a name="l00093"></a>00093 <span class="comment">//: Copy Constructor</span>
<a name="l00094"></a><a class="code" href="classimesh__imls__surface.html#aec56f88613f04777cbfc5691b63606d5">00094</a> <a class="code" href="classimesh__imls__surface.html#a9ff538b162930e8e49cc50d462fe7e87" title="Constructor.">imesh_imls_surface::imesh_imls_surface</a>(<span class="keyword">const</span> <a class="code" href="classimesh__imls__surface.html">imesh_imls_surface</a>&amp; other)
<a name="l00095"></a>00095   : verts_(other.verts_),
<a name="l00096"></a>00096     triangles_(other.triangles_.get() ?
<a name="l00097"></a>00097                new <a class="code" href="classimesh__regular__face__array.html" title="An array of mesh faces of arbitrary size.">imesh_regular_face_array</a>&lt;3&gt;(*other.triangles_) :
<a name="l00098"></a>00098                0),
<a name="l00099"></a>00099     kd_tree_(other.kd_tree_.get() ?
<a name="l00100"></a>00100              new <a class="code" href="structimesh__kd__tree__node.html" title="A node in the KD-Tree.">imesh_kd_tree_node</a>(*other.kd_tree_) :
<a name="l00101"></a>00101              0),
<a name="l00102"></a>00102     phi_(other.phi_),
<a name="l00103"></a>00103     area_(other.area_),
<a name="l00104"></a>00104     unweighted_(other.unweighted_),
<a name="l00105"></a>00105     centroid_(other.centroid_),
<a name="l00106"></a>00106     normals_(other.normals_),
<a name="l00107"></a>00107     normal_len_(other.normal_len_),
<a name="l00108"></a>00108     eps2_(other.eps2_),
<a name="l00109"></a>00109     lambda_(other.lambda_),
<a name="l00110"></a>00110     iso_level_(other.iso_level_)
<a name="l00111"></a>00111 {
<a name="l00112"></a>00112 }
<a name="l00113"></a>00113 
<a name="l00114"></a>00114 
<a name="l00115"></a>00115 <span class="comment">//: compute the iso value such that the mean value at the vertices is zero</span>
<a name="l00116"></a><a class="code" href="classimesh__imls__surface.html#af92021e42315f3ac060d64fcb684ea71">00116</a> <span class="keywordtype">void</span> <a class="code" href="classimesh__imls__surface.html#af92021e42315f3ac060d64fcb684ea71" title="compute the iso value such that the mean value at the vertices is zero.">imesh_imls_surface::compute_iso_level</a>()
<a name="l00117"></a>00117 {
<a name="l00118"></a>00118   <span class="keywordtype">double</span> mean = 0.0;
<a name="l00119"></a>00119   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i=0; i&lt;<a class="code" href="classimesh__imls__surface.html#aec4e66dac2e3dae2d1034a250df17885">verts_</a>.size(); ++i)
<a name="l00120"></a>00120     mean += (*<span class="keyword">this</span>)(<a class="code" href="classimesh__imls__surface.html#aec4e66dac2e3dae2d1034a250df17885">verts_</a>[i]);
<a name="l00121"></a>00121   <a class="code" href="classimesh__imls__surface.html#a262e8acfff0f8284136092d50a8a4bba">iso_level_</a> = mean / <a class="code" href="classimesh__imls__surface.html#aec4e66dac2e3dae2d1034a250df17885">verts_</a>.size();
<a name="l00122"></a>00122 }
<a name="l00123"></a>00123 
<a name="l00124"></a>00124 
<a name="l00125"></a>00125 <span class="comment">//: adjust the phi values until all vertices are within the iso surface</span>
<a name="l00126"></a>00126 <span class="comment">// Also computes the iso level</span>
<a name="l00127"></a><a class="code" href="classimesh__imls__surface.html#a227d30e4fbded856b45fcb72367cae69">00127</a> <span class="keywordtype">void</span> <a class="code" href="classimesh__imls__surface.html#a227d30e4fbded856b45fcb72367cae69" title="adjust the phi values until all vertices are within the iso surface.">imesh_imls_surface::compute_enclosing_phi</a>()
<a name="l00128"></a>00128 {
<a name="l00129"></a>00129   <span class="keyword">typedef</span> vcl_pair&lt;unsigned int,double&gt; pair_id;
<a name="l00130"></a>00130   vcl_vector&lt;pair_id&gt; outside;
<a name="l00131"></a>00131   <span class="keywordtype">double</span> mean = 0.0;
<a name="l00132"></a>00132   <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> num_verts = <a class="code" href="classimesh__imls__surface.html#ae415503ef19a41060dd0087206d89d84">bounded_</a> ?
<a name="l00133"></a>00133                                  <a class="code" href="classimesh__imls__surface.html#aec4e66dac2e3dae2d1034a250df17885">verts_</a>.size() :
<a name="l00134"></a>00134                                  <a class="code" href="classimesh__imls__surface.html#aec4e66dac2e3dae2d1034a250df17885">verts_</a>.size() - 8;
<a name="l00135"></a>00135   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i=0; i&lt;num_verts; ++i) {
<a name="l00136"></a>00136     <span class="keywordtype">double</span> val = (*this)(<a class="code" href="classimesh__imls__surface.html#aec4e66dac2e3dae2d1034a250df17885">verts_</a>[i]);
<a name="l00137"></a>00137     mean += val;
<a name="l00138"></a>00138     <span class="keywordflow">if</span> (val &gt; 0)
<a name="l00139"></a>00139       outside.push_back(pair_id(i,val));
<a name="l00140"></a>00140   }
<a name="l00141"></a>00141   <a class="code" href="classimesh__imls__surface.html#a262e8acfff0f8284136092d50a8a4bba">iso_level_</a> = mean / <a class="code" href="classimesh__imls__surface.html#aec4e66dac2e3dae2d1034a250df17885">verts_</a>.size();
<a name="l00142"></a>00142 
<a name="l00143"></a>00143   <span class="keywordflow">for</span> (<span class="keywordtype">double</span> s=1.0; !outside.empty(); s*=2) {
<a name="l00144"></a>00144     vcl_cout &lt;&lt; outside.size() &lt;&lt; <span class="stringliteral">&quot; outside&quot;</span> &lt;&lt; vcl_endl;
<a name="l00145"></a>00145     <span class="keywordflow">for</span> (vcl_vector&lt;pair_id&gt;::const_iterator i=outside.begin();
<a name="l00146"></a>00146          i!=outside.end(); ++i) {
<a name="l00147"></a>00147       <a class="code" href="classimesh__imls__surface.html#a705d794cccf603a239182df8c1b5a0c7">phi_</a>[i-&gt;first] -= s*i-&gt;second;
<a name="l00148"></a>00148     }
<a name="l00149"></a>00149     <a class="code" href="classimesh__imls__surface.html#a62e512fab6ab84314c2f97b836835502" title="recursively compute the unweighted integrals.">compute_unweighed_rec</a>(<a class="code" href="classimesh__imls__surface.html#aa6683a2224c8e4099d02ded4258ce857">kd_tree_</a>);
<a name="l00150"></a>00150     vcl_vector&lt;pair_id&gt; next_outside;
<a name="l00151"></a>00151     <span class="keywordflow">for</span> (vcl_vector&lt;pair_id&gt;::const_iterator i=outside.begin();
<a name="l00152"></a>00152          i!=outside.end(); ++i) {
<a name="l00153"></a>00153       <span class="keywordtype">double</span> val = (*this)(<a class="code" href="classimesh__imls__surface.html#aec4e66dac2e3dae2d1034a250df17885">verts_</a>[i-&gt;first]);
<a name="l00154"></a>00154       <span class="keywordflow">if</span> (val &gt; vcl_abs(vcl_numeric_limits&lt;double&gt;::epsilon()*<a class="code" href="classimesh__imls__surface.html#a705d794cccf603a239182df8c1b5a0c7">phi_</a>[i-&gt;first])) {
<a name="l00155"></a>00155         next_outside.push_back(pair_id(i-&gt;first,val));
<a name="l00156"></a>00156       }
<a name="l00157"></a>00157     }
<a name="l00158"></a>00158     outside.swap(next_outside);
<a name="l00159"></a>00159   }
<a name="l00160"></a>00160 }
<a name="l00161"></a>00161 
<a name="l00162"></a>00162 
<a name="l00163"></a>00163 <span class="comment">//: recursively compute the area weighted centroids</span>
<a name="l00164"></a>00164 <span class="keywordtype">void</span> <a class="code" href="classimesh__imls__surface.html#adc010b32d618b945124bd18c394c2efb" title="recursively compute the area weighted centroids.">imesh_imls_surface::</a>
<a name="l00165"></a><a class="code" href="classimesh__imls__surface.html#adc010b32d618b945124bd18c394c2efb">00165</a> <a class="code" href="classimesh__imls__surface.html#adc010b32d618b945124bd18c394c2efb" title="recursively compute the area weighted centroids.">compute_centroids_rec</a>(<span class="keyword">const</span> vcl_auto_ptr&lt;imesh_kd_tree_node&gt;&amp; node,
<a name="l00166"></a>00166                       <span class="keyword">const</span> vcl_set&lt;unsigned int&gt;&amp; no_normal_faces)
<a name="l00167"></a>00167 {
<a name="l00168"></a>00168   <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>&amp; i = node-&gt;index_;
<a name="l00169"></a>00169   <span class="keywordflow">if</span> (node-&gt;is_leaf()) {
<a name="l00170"></a>00170     <span class="keyword">const</span> <a class="code" href="classimesh__regular__face.html">imesh_regular_face&lt;3&gt;</a>&amp; tri = (*triangles_)[i];
<a name="l00171"></a>00171     <span class="keyword">const</span> <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__point__3d.html">vgl_point_3d&lt;double&gt;</a>&amp; v0 = <a class="code" href="classimesh__imls__surface.html#aec4e66dac2e3dae2d1034a250df17885">verts_</a>[tri[0]];
<a name="l00172"></a>00172     <span class="keyword">const</span> <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__point__3d.html">vgl_point_3d&lt;double&gt;</a>&amp; v1 = <a class="code" href="classimesh__imls__surface.html#aec4e66dac2e3dae2d1034a250df17885">verts_</a>[tri[1]];
<a name="l00173"></a>00173     <span class="keyword">const</span> <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__point__3d.html">vgl_point_3d&lt;double&gt;</a>&amp; v2 = <a class="code" href="classimesh__imls__surface.html#aec4e66dac2e3dae2d1034a250df17885">verts_</a>[tri[2]];
<a name="l00174"></a>00174     <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__3d.html">vgl_vector_3d&lt;double&gt;</a>&amp; n = <a class="code" href="classimesh__imls__surface.html#a94fe59c7af85b8bebc8a1b369f2d81f2">normals_</a>[i];
<a name="l00175"></a>00175     n = <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/vgl__vector__2d_8h.html#ae238212d8b18ea93da5fba3f397f984a">cross_product</a>(v1-v0,v2-v0)/2.0;
<a name="l00176"></a>00176     <a class="code" href="classimesh__imls__surface.html#a4d33d2d1a6571c05d15d089f4fa33dc0">normal_len_</a>[i] = n.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__3d.html#aed39c2835939944b8e12a21479ac6880">length</a>();
<a name="l00177"></a>00177     <a class="code" href="classimesh__imls__surface.html#ac9885bb5c4e7aaba58b7b16064c7c5b9">area_</a>[i] = <a class="code" href="classimesh__imls__surface.html#a4d33d2d1a6571c05d15d089f4fa33dc0">normal_len_</a>[i];
<a name="l00178"></a>00178     <a class="code" href="classimesh__imls__surface.html#ac32caa7cc6c6dc8192c81243885786f2">centroid_</a>[i] = <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/vgl__homg__point__1d_8h.html#adee43f992edd6c4c8e46fde8cf9a7576">centre</a>(v0,v1,v2);
<a name="l00179"></a>00179     <span class="keywordflow">if</span> (no_normal_faces.find(i) != no_normal_faces.end()) {
<a name="l00180"></a>00180       n = <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__3d.html">vgl_vector_3d&lt;double&gt;</a>(0,0,0);
<a name="l00181"></a>00181       <a class="code" href="classimesh__imls__surface.html#a4d33d2d1a6571c05d15d089f4fa33dc0">normal_len_</a>[i] = 0.0;
<a name="l00182"></a>00182     }
<a name="l00183"></a>00183     <span class="keywordflow">return</span>;
<a name="l00184"></a>00184   }
<a name="l00185"></a>00185 
<a name="l00186"></a>00186   <a class="code" href="classimesh__imls__surface.html#adc010b32d618b945124bd18c394c2efb" title="recursively compute the area weighted centroids.">compute_centroids_rec</a>(node-&gt;left_,no_normal_faces);
<a name="l00187"></a>00187   <a class="code" href="classimesh__imls__surface.html#adc010b32d618b945124bd18c394c2efb" title="recursively compute the area weighted centroids.">compute_centroids_rec</a>(node-&gt;right_,no_normal_faces);
<a name="l00188"></a>00188 
<a name="l00189"></a>00189   <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>&amp; i_left = node-&gt;left_-&gt;index_;
<a name="l00190"></a>00190   <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>&amp; i_right = node-&gt;right_-&gt;index_;
<a name="l00191"></a>00191 
<a name="l00192"></a>00192   <span class="keyword">const</span> <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__point__3d.html">vgl_point_3d&lt;double&gt;</a>&amp; cl = <a class="code" href="classimesh__imls__surface.html#ac32caa7cc6c6dc8192c81243885786f2">centroid_</a>[i_left];
<a name="l00193"></a>00193   <span class="keyword">const</span> <span class="keywordtype">double</span>&amp; al = <a class="code" href="classimesh__imls__surface.html#ac9885bb5c4e7aaba58b7b16064c7c5b9">area_</a>[i_left];
<a name="l00194"></a>00194   <span class="keyword">const</span> <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__point__3d.html">vgl_point_3d&lt;double&gt;</a>&amp; cr = <a class="code" href="classimesh__imls__surface.html#ac32caa7cc6c6dc8192c81243885786f2">centroid_</a>[i_right];
<a name="l00195"></a>00195   <span class="keyword">const</span> <span class="keywordtype">double</span>&amp; ar = <a class="code" href="classimesh__imls__surface.html#ac9885bb5c4e7aaba58b7b16064c7c5b9">area_</a>[i_right];
<a name="l00196"></a>00196   <span class="keywordtype">double</span>&amp; at = <a class="code" href="classimesh__imls__surface.html#ac9885bb5c4e7aaba58b7b16064c7c5b9">area_</a>[i];
<a name="l00197"></a>00197   at = al + ar;
<a name="l00198"></a>00198   <a class="code" href="classimesh__imls__surface.html#ac32caa7cc6c6dc8192c81243885786f2">centroid_</a>[i].set((ar*cr.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__point__3d.html#a1ad910614a911c7d322c086438d6441d">x</a>() + al*cl.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__point__3d.html#a1ad910614a911c7d322c086438d6441d">x</a>()) / at,
<a name="l00199"></a>00199                    (ar*cr.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__point__3d.html#a6fcfebd50c3f8570fafd49df0687feb2">y</a>() + al*cl.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__point__3d.html#a6fcfebd50c3f8570fafd49df0687feb2">y</a>()) / at,
<a name="l00200"></a>00200                    (ar*cr.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__point__3d.html#a477066fab00b63b2641305fb7e41fb62">z</a>() + al*cl.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__point__3d.html#a477066fab00b63b2641305fb7e41fb62">z</a>()) / at);
<a name="l00201"></a>00201   <span class="comment">//normals_[i] = normalized(normals_[i_left]*al + normals_[i_right]*ar);</span>
<a name="l00202"></a>00202   <a class="code" href="classimesh__imls__surface.html#a94fe59c7af85b8bebc8a1b369f2d81f2">normals_</a>[i] = <a class="code" href="classimesh__imls__surface.html#a94fe59c7af85b8bebc8a1b369f2d81f2">normals_</a>[i_left] + <a class="code" href="classimesh__imls__surface.html#a94fe59c7af85b8bebc8a1b369f2d81f2">normals_</a>[i_right];
<a name="l00203"></a>00203   <a class="code" href="classimesh__imls__surface.html#a4d33d2d1a6571c05d15d089f4fa33dc0">normal_len_</a>[i] = normals_[i].length();
<a name="l00204"></a>00204 }
<a name="l00205"></a>00205 
<a name="l00206"></a>00206 
<a name="l00207"></a>00207 <span class="comment">//: recursively compute the unweighted integrals</span>
<a name="l00208"></a>00208 <span class="keywordtype">void</span> <a class="code" href="classimesh__imls__surface.html#a62e512fab6ab84314c2f97b836835502" title="recursively compute the unweighted integrals.">imesh_imls_surface::</a>
<a name="l00209"></a><a class="code" href="classimesh__imls__surface.html#a62e512fab6ab84314c2f97b836835502">00209</a> <a class="code" href="classimesh__imls__surface.html#a62e512fab6ab84314c2f97b836835502" title="recursively compute the unweighted integrals.">compute_unweighed_rec</a>(<span class="keyword">const</span> vcl_auto_ptr&lt;imesh_kd_tree_node&gt;&amp; node)
<a name="l00210"></a>00210 {
<a name="l00211"></a>00211   <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>&amp; i = node-&gt;index_;
<a name="l00212"></a>00212   <span class="keywordflow">if</span> (node-&gt;is_leaf()) {
<a name="l00213"></a>00213     <span class="keyword">const</span> <a class="code" href="classimesh__regular__face.html">imesh_regular_face&lt;3&gt;</a>&amp; tri = (*triangles_)[i];
<a name="l00214"></a>00214     <a class="code" href="classimesh__imls__surface.html#ae67dc43d910aff02a24cf7ddec257f40">unweighted_</a>[i] = (<a class="code" href="classimesh__imls__surface.html#a705d794cccf603a239182df8c1b5a0c7">phi_</a>[tri[0]]
<a name="l00215"></a>00215                     + <a class="code" href="classimesh__imls__surface.html#a705d794cccf603a239182df8c1b5a0c7">phi_</a>[tri[1]]
<a name="l00216"></a>00216                     + <a class="code" href="classimesh__imls__surface.html#a705d794cccf603a239182df8c1b5a0c7">phi_</a>[tri[2]])/3.0 * <a class="code" href="classimesh__imls__surface.html#ac9885bb5c4e7aaba58b7b16064c7c5b9">area_</a>[i];
<a name="l00217"></a>00217           <span class="comment">//- dot_product(normals_[i],centroid_[i]-vgl_point_3d&lt;double&gt;(0,0,0));</span>
<a name="l00218"></a>00218     <span class="keywordflow">return</span>;
<a name="l00219"></a>00219   }
<a name="l00220"></a>00220 
<a name="l00221"></a>00221   <a class="code" href="classimesh__imls__surface.html#a62e512fab6ab84314c2f97b836835502" title="recursively compute the unweighted integrals.">compute_unweighed_rec</a>(node-&gt;left_);
<a name="l00222"></a>00222   <a class="code" href="classimesh__imls__surface.html#a62e512fab6ab84314c2f97b836835502" title="recursively compute the unweighted integrals.">compute_unweighed_rec</a>(node-&gt;right_);
<a name="l00223"></a>00223 
<a name="l00224"></a>00224   <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>&amp; i_left = node-&gt;left_-&gt;index_;
<a name="l00225"></a>00225   <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>&amp; i_right = node-&gt;right_-&gt;index_;
<a name="l00226"></a>00226   <a class="code" href="classimesh__imls__surface.html#ae67dc43d910aff02a24cf7ddec257f40">unweighted_</a>[i] = <a class="code" href="classimesh__imls__surface.html#ae67dc43d910aff02a24cf7ddec257f40">unweighted_</a>[i_left] + <a class="code" href="classimesh__imls__surface.html#ae67dc43d910aff02a24cf7ddec257f40">unweighted_</a>[i_right];
<a name="l00227"></a>00227 }
<a name="l00228"></a>00228 
<a name="l00229"></a>00229 
<a name="l00230"></a>00230 <span class="comment">//: return a bounding box for the original input mesh</span>
<a name="l00231"></a><a class="code" href="classimesh__imls__surface.html#a17181fb2ba52d89edce1e8b88e621c6c">00231</a> <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__box__3d.html">vgl_box_3d&lt;double&gt;</a> <a class="code" href="classimesh__imls__surface.html#a17181fb2ba52d89edce1e8b88e621c6c" title="return a bounding box for the original input mesh.">imesh_imls_surface::bounding_box</a>()<span class="keyword"> const</span>
<a name="l00232"></a>00232 <span class="keyword"></span>{
<a name="l00233"></a>00233   <span class="keywordflow">return</span> <a class="code" href="classimesh__imls__surface.html#aa6683a2224c8e4099d02ded4258ce857">kd_tree_</a>-&gt;inner_box_;
<a name="l00234"></a>00234 }
<a name="l00235"></a>00235 
<a name="l00236"></a>00236 
<a name="l00237"></a>00237 <span class="comment">//: change the epsilon (smoothness) of the surface</span>
<a name="l00238"></a><a class="code" href="classimesh__imls__surface.html#a77c091d43cbd8e05fe4712484202496a">00238</a> <span class="keywordtype">void</span> <a class="code" href="classimesh__imls__surface.html#a77c091d43cbd8e05fe4712484202496a" title="change the epsilon (smoothness) of the surface.">imesh_imls_surface::set_epsilon</a>(<span class="keywordtype">double</span> eps)
<a name="l00239"></a>00239 {
<a name="l00240"></a>00240   <a class="code" href="classimesh__imls__surface.html#a5dc693e1bde2a4135a17367eff00f37d">eps2_</a> = eps*eps;
<a name="l00241"></a>00241   <a class="code" href="classimesh__imls__surface.html#a262e8acfff0f8284136092d50a8a4bba">iso_level_</a> = 0.0;
<a name="l00242"></a>00242 
<a name="l00243"></a>00243   <span class="comment">// reset the phi values at each vertex</span>
<a name="l00244"></a>00244   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> i=0; i&lt;<a class="code" href="classimesh__imls__surface.html#a705d794cccf603a239182df8c1b5a0c7">phi_</a>.size(); ++i)
<a name="l00245"></a>00245     <a class="code" href="classimesh__imls__surface.html#a705d794cccf603a239182df8c1b5a0c7">phi_</a>[i] = 0.0;
<a name="l00246"></a>00246 
<a name="l00247"></a>00247   <a class="code" href="classimesh__imls__surface.html#a62e512fab6ab84314c2f97b836835502" title="recursively compute the unweighted integrals.">compute_unweighed_rec</a>(<a class="code" href="classimesh__imls__surface.html#aa6683a2224c8e4099d02ded4258ce857">kd_tree_</a>);
<a name="l00248"></a>00248 
<a name="l00249"></a>00249   <a class="code" href="classimesh__imls__surface.html#a227d30e4fbded856b45fcb72367cae69" title="adjust the phi values until all vertices are within the iso surface.">compute_enclosing_phi</a>();
<a name="l00250"></a>00250 }
<a name="l00251"></a>00251 
<a name="l00252"></a>00252 
<a name="l00253"></a>00253 <span class="keyword">namespace </span>{
<a name="l00254"></a>00254 <span class="keyword">class </span>tri_dist_func
<a name="l00255"></a>00255 {
<a name="l00256"></a>00256  <span class="keyword">public</span>:
<a name="l00257"></a>00257   tri_dist_func(<span class="keyword">const</span> vcl_vector&lt;<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__point__3d.html">vgl_point_3d&lt;double&gt;</a> &gt;&amp; v,
<a name="l00258"></a>00258                 <span class="keyword">const</span> <a class="code" href="classimesh__regular__face__array.html" title="An array of mesh faces of arbitrary size.">imesh_regular_face_array&lt;3&gt;</a>&amp; t)
<a name="l00259"></a>00259   : verts(<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/vgl__vector__2d_8h.html#a38bf1e5e0427bdeba2b469eea9befc23">v</a>), tris(t), closest_index(static_cast&lt;unsigned int&gt;(-1)),
<a name="l00260"></a>00260     closest_dist(vcl_numeric_limits&lt;double&gt;::infinity()) {}
<a name="l00261"></a>00261   <span class="keyword">const</span> vcl_vector&lt;vgl_point_3d&lt;double&gt; &gt;&amp; verts;
<a name="l00262"></a>00262   <span class="keyword">const</span> <a class="code" href="classimesh__regular__face__array.html" title="An array of mesh faces of arbitrary size.">imesh_regular_face_array&lt;3&gt;</a>&amp; tris;
<a name="l00263"></a>00263   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> closest_index;
<a name="l00264"></a>00264   <span class="keywordtype">double</span> closest_dist, closest_u, closest_v;
<a name="l00265"></a>00265 
<a name="l00266"></a>00266   <span class="keywordtype">double</span> operator () (<span class="keyword">const</span> <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__point__3d.html">vgl_point_3d&lt;double&gt;</a>&amp; pt, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i)
<a name="l00267"></a>00267   {
<a name="l00268"></a>00268     <span class="keyword">const</span> <a class="code" href="classimesh__regular__face.html">imesh_regular_face&lt;3&gt;</a>&amp; tri = tris[i];
<a name="l00269"></a>00269     <span class="keywordtype">double</span> dist,u,<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/vgl__vector__2d_8h.html#a38bf1e5e0427bdeba2b469eea9befc23">v</a>;
<a name="l00270"></a>00270     <span class="comment">/* unsigned char s = */</span>
<a name="l00271"></a>00271     <a class="code" href="imesh__intersect_8cxx.html#a40f4d8dfff487697208af64cfcf8b7c0" title="Find the closest point on the triangle a,b,c to point p.">imesh_triangle_closest_point</a>(pt,
<a name="l00272"></a>00272                                  verts[tri[0]], verts[tri[1]], verts[tri[2]],
<a name="l00273"></a>00273                                  dist, u, v);
<a name="l00274"></a>00274     <span class="keywordflow">if</span> (dist &lt; closest_dist) {
<a name="l00275"></a>00275       closest_dist = dist;
<a name="l00276"></a>00276       closest_index = i;
<a name="l00277"></a>00277       closest_u = u;
<a name="l00278"></a>00278       closest_v = v;
<a name="l00279"></a>00279     }
<a name="l00280"></a>00280     <span class="keywordflow">return</span> dist;
<a name="l00281"></a>00281   }
<a name="l00282"></a>00282 };
<a name="l00283"></a>00283 <span class="comment">// end of namespace</span>
<a name="l00284"></a>00284 }
<a name="l00285"></a>00285 
<a name="l00286"></a>00286 
<a name="l00287"></a>00287 <span class="comment">//: evaluate the implicit surface at a point</span>
<a name="l00288"></a><a class="code" href="classimesh__imls__surface.html#a19a86942d23535a0dfc116dc278f2952">00288</a> <span class="keywordtype">double</span> <a class="code" href="classimesh__imls__surface.html#a19a86942d23535a0dfc116dc278f2952" title="evaluate the implicit surface at a point.">imesh_imls_surface::operator() </a>(<span class="keyword">const</span> <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__point__3d.html">vgl_point_3d&lt;double&gt;</a>&amp; p)<span class="keyword"> const</span>
<a name="l00289"></a>00289 <span class="keyword"></span>{
<a name="l00290"></a>00290   <span class="keywordtype">double</span> sum=0.0, sum_phi = 0.0;
<a name="l00291"></a>00291 
<a name="l00292"></a>00292   vcl_vector&lt;imesh_kd_tree_queue_entry&gt; remain;
<a name="l00293"></a>00293   tri_dist_func dist(<a class="code" href="classimesh__imls__surface.html#aec4e66dac2e3dae2d1034a250df17885">verts_</a>,*<a class="code" href="classimesh__imls__surface.html#ae486e3dedfe1a3f9c811f55998dadc3e">triangles_</a>);
<a name="l00294"></a>00294   <span class="comment">/* unsigned int ind = */</span>
<a name="l00295"></a>00295   imesh_closest_index&lt;tri_dist_func&amp;&gt;(p,<a class="code" href="classimesh__imls__surface.html#aa6683a2224c8e4099d02ded4258ce857">kd_tree_</a>,dist,&amp;remain);
<a name="l00296"></a>00296 
<a name="l00297"></a>00297   <span class="comment">// compute the (negative) maximum error of integration</span>
<a name="l00298"></a>00298   <span class="comment">// stored negative so that the max error is first when sorted by &lt;</span>
<a name="l00299"></a>00299   vcl_vector&lt;imesh_kd_tree_queue_entry&gt;::iterator itr = remain.begin();
<a name="l00300"></a>00300   <span class="keywordflow">for</span> (; itr != remain.end(); ++itr) {
<a name="l00301"></a>00301     <span class="keywordtype">double</span> min = <a class="code" href="classimesh__imls__surface.html#a535311b037c2448e5950eba706b0582d" title="evaluate the squared weighting function given a squared distance.">w2</a>(itr-&gt;val_);
<a name="l00302"></a>00302     <span class="keywordtype">double</span> max = <a class="code" href="classimesh__imls__surface.html#a535311b037c2448e5950eba706b0582d" title="evaluate the squared weighting function given a squared distance.">w2</a>(<a class="code" href="imesh__kd__tree_8cxx.html#a7bb66ceba635f24df166ecbd2aca2326" title="The maximum square distance between p and any point in b.">imesh_max_sq_dist</a>(p,itr-&gt;node_-&gt;inner_box_));
<a name="l00303"></a>00303     itr-&gt;val_ = (max - min)*<a class="code" href="classimesh__imls__surface.html#ac9885bb5c4e7aaba58b7b16064c7c5b9">area_</a>[itr-&gt;node_-&gt;index_];
<a name="l00304"></a>00304   }
<a name="l00305"></a>00305   vcl_make_heap( remain.begin(), remain.end() );
<a name="l00306"></a>00306 
<a name="l00307"></a>00307   vcl_pop_heap( remain.begin(), remain.end() );
<a name="l00308"></a>00308   <span class="keywordflow">while</span> (!remain.empty() &amp;&amp; -remain.back().val_ &gt; <a class="code" href="classimesh__imls__surface.html#a59d4345d4ea7afc09a5d6b1d2b84dd74">lambda_</a>*sum)
<a name="l00309"></a>00309   {
<a name="l00310"></a>00310     <a class="code" href="structimesh__kd__tree__node.html" title="A node in the KD-Tree.">imesh_kd_tree_node</a>* current = remain.back().node_;
<a name="l00311"></a>00311     remain.pop_back();
<a name="l00312"></a>00312 
<a name="l00313"></a>00313     <span class="keywordflow">if</span> (current-&gt;<a class="code" href="structimesh__kd__tree__node.html#a62d022cdc07a95c0ef124721150773fb" title="Return true if this node is a leaf node.">is_leaf</a>())
<a name="l00314"></a>00314     {
<a name="l00315"></a>00315       <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = current-&gt;<a class="code" href="structimesh__kd__tree__node.html#aaad4334738e44cee931ab9e784bf89cf" title="index into original data vector (at leaf nodes).">index_</a>;
<a name="l00316"></a>00316       <span class="keyword">const</span> <a class="code" href="classimesh__regular__face.html">imesh_regular_face&lt;3&gt;</a>&amp; tri = (*triangles_)[i];
<a name="l00317"></a>00317       <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i1=tri[0], i2=tri[1], i3=tri[2];
<a name="l00318"></a>00318       <span class="keyword">typedef</span> <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__2d.html">vgl_vector_2d&lt;double&gt;</a> T;
<a name="l00319"></a>00319       <span class="keyword">typedef</span> <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__2d.html">vgl_vector_2d&lt;double&gt;</a> (*F) (<span class="keyword">const</span> <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__point__3d.html">vgl_point_3d&lt;double&gt;</a>&amp;, <span class="keyword">const</span> vgl_point_3d&lt;double&gt;&amp;,
<a name="l00320"></a>00320                                           <span class="keyword">const</span> vgl_point_3d&lt;double&gt;&amp;, <span class="keyword">const</span> vgl_point_3d&lt;double&gt;&amp;,
<a name="l00321"></a>00321                                           double, double, double, double);
<a name="l00322"></a>00322       <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__2d.html">vgl_vector_2d&lt;double&gt;</a> I = triangle_quadrature&lt;T,F&gt;(<a class="code" href="classimesh__imls__surface.html#ad836ea851e9d26bf7aba4dd35fe6de65" title="area integral of the squared weight function times a linearly interpolated value.">split_triangle_quadrature</a>,
<a name="l00323"></a>00323                                                          p,<a class="code" href="classimesh__imls__surface.html#aec4e66dac2e3dae2d1034a250df17885">verts_</a>[i1],verts_[i2],verts_[i3],
<a name="l00324"></a>00324                                                          <a class="code" href="classimesh__imls__surface.html#a94fe59c7af85b8bebc8a1b369f2d81f2">normals_</a>[i]*2.0,
<a name="l00325"></a>00325                                                          <a class="code" href="classimesh__imls__surface.html#a705d794cccf603a239182df8c1b5a0c7">phi_</a>[i1],<a class="code" href="classimesh__imls__surface.html#a705d794cccf603a239182df8c1b5a0c7">phi_</a>[i2],phi_[i3],<a class="code" href="classimesh__imls__surface.html#a5dc693e1bde2a4135a17367eff00f37d">eps2_</a>);
<a name="l00326"></a>00326       assert(!vnl_math_isnan(I.x()) &amp;&amp; !vnl_math_isnan(I.y()));
<a name="l00327"></a>00327 
<a name="l00328"></a>00328       sum_phi += I.x();
<a name="l00329"></a>00329       <span class="keywordflow">if</span> (<a class="code" href="classimesh__imls__surface.html#a4d33d2d1a6571c05d15d089f4fa33dc0">normal_len_</a>[i]&gt;0.0)
<a name="l00330"></a>00330         sum_phi += <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/vgl__vector__2d_8h.html#af8601d1894aed553c33ab9d9a2c5af48">dot_product</a>(<a class="code" href="classimesh__imls__surface.html#a94fe59c7af85b8bebc8a1b369f2d81f2">normals_</a>[i],p-verts_[i1]) * I.y() / <a class="code" href="classimesh__imls__surface.html#a4d33d2d1a6571c05d15d089f4fa33dc0">normal_len_</a>[i];
<a name="l00331"></a>00331       sum += I.y();
<a name="l00332"></a>00332     }
<a name="l00333"></a>00333     <span class="keywordflow">else</span>
<a name="l00334"></a>00334     {
<a name="l00335"></a>00335       <span class="keywordtype">double</span> min = <a class="code" href="classimesh__imls__surface.html#a535311b037c2448e5950eba706b0582d" title="evaluate the squared weighting function given a squared distance.">w2</a>(<a class="code" href="imesh__kd__tree_8cxx.html#a76bf7e20506e3e26efe8010b83a0b784" title="The minimum square distance between p and any point in b.">imesh_min_sq_dist</a>(p,current-&gt;<a class="code" href="structimesh__kd__tree__node.html#a6f2d8f9cf174b6847e4947d04466b1d9" title="Left child.">left_</a>-&gt;inner_box_));
<a name="l00336"></a>00336       <span class="keywordtype">double</span> max = <a class="code" href="classimesh__imls__surface.html#a535311b037c2448e5950eba706b0582d" title="evaluate the squared weighting function given a squared distance.">w2</a>(<a class="code" href="imesh__kd__tree_8cxx.html#a7bb66ceba635f24df166ecbd2aca2326" title="The maximum square distance between p and any point in b.">imesh_max_sq_dist</a>(p,current-&gt;<a class="code" href="structimesh__kd__tree__node.html#a6f2d8f9cf174b6847e4947d04466b1d9" title="Left child.">left_</a>-&gt;inner_box_));
<a name="l00337"></a>00337       remain.push_back(<a class="code" href="classimesh__kd__tree__queue__entry.html" title="A class used for sorting a queue of tree nodes by an assigned value.">imesh_kd_tree_queue_entry</a>((max - min)*<a class="code" href="classimesh__imls__surface.html#ac9885bb5c4e7aaba58b7b16064c7c5b9">area_</a>[current-&gt;<a class="code" href="structimesh__kd__tree__node.html#a6f2d8f9cf174b6847e4947d04466b1d9" title="Left child.">left_</a>-&gt;index_],
<a name="l00338"></a>00338                                                  current-&gt;<a class="code" href="structimesh__kd__tree__node.html#a6f2d8f9cf174b6847e4947d04466b1d9" title="Left child.">left_</a>.get()));
<a name="l00339"></a>00339       vcl_push_heap(remain.begin(), remain.end());
<a name="l00340"></a>00340 
<a name="l00341"></a>00341       min = <a class="code" href="classimesh__imls__surface.html#a535311b037c2448e5950eba706b0582d" title="evaluate the squared weighting function given a squared distance.">w2</a>(<a class="code" href="imesh__kd__tree_8cxx.html#a76bf7e20506e3e26efe8010b83a0b784" title="The minimum square distance between p and any point in b.">imesh_min_sq_dist</a>(p,current-&gt;<a class="code" href="structimesh__kd__tree__node.html#a34a012f4fe05c11c7d709ce0e3369c59" title="Right child.">right_</a>-&gt;inner_box_));
<a name="l00342"></a>00342       max = <a class="code" href="classimesh__imls__surface.html#a535311b037c2448e5950eba706b0582d" title="evaluate the squared weighting function given a squared distance.">w2</a>(<a class="code" href="imesh__kd__tree_8cxx.html#a7bb66ceba635f24df166ecbd2aca2326" title="The maximum square distance between p and any point in b.">imesh_max_sq_dist</a>(p,current-&gt;<a class="code" href="structimesh__kd__tree__node.html#a34a012f4fe05c11c7d709ce0e3369c59" title="Right child.">right_</a>-&gt;inner_box_));
<a name="l00343"></a>00343       remain.push_back(<a class="code" href="classimesh__kd__tree__queue__entry.html" title="A class used for sorting a queue of tree nodes by an assigned value.">imesh_kd_tree_queue_entry</a>((max - min)*area_[current-&gt;<a class="code" href="structimesh__kd__tree__node.html#a34a012f4fe05c11c7d709ce0e3369c59" title="Right child.">right_</a>-&gt;index_],
<a name="l00344"></a>00344                                                  current-&gt;<a class="code" href="structimesh__kd__tree__node.html#a34a012f4fe05c11c7d709ce0e3369c59" title="Right child.">right_</a>.get()));
<a name="l00345"></a>00345       vcl_push_heap(remain.begin(), remain.end());
<a name="l00346"></a>00346     }
<a name="l00347"></a>00347     <span class="keywordflow">if</span> (!remain.empty())
<a name="l00348"></a>00348       vcl_pop_heap( remain.begin(), remain.end() );
<a name="l00349"></a>00349   }
<a name="l00350"></a>00350 
<a name="l00351"></a>00351   <span class="comment">// approximate the contribution from the remain nodes</span>
<a name="l00352"></a>00352   <span class="keywordflow">for</span> (itr = remain.begin(); itr != remain.end(); ++itr) {
<a name="l00353"></a>00353     <span class="comment">// Use approximation assuming the weight is constant</span>
<a name="l00354"></a>00354     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = itr-&gt;node_-&gt;index_;
<a name="l00355"></a>00355     <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__3d.html">vgl_vector_3d&lt;double&gt;</a> <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/vgl__vector__2d_8h.html#a38bf1e5e0427bdeba2b469eea9befc23">v</a>(p-<a class="code" href="classimesh__imls__surface.html#ac32caa7cc6c6dc8192c81243885786f2">centroid_</a>[i]);
<a name="l00356"></a>00356     <span class="keywordtype">double</span> w = <a class="code" href="classimesh__imls__surface.html#a535311b037c2448e5950eba706b0582d" title="evaluate the squared weighting function given a squared distance.">w2</a>(v.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__3d.html#a9415896a1013a2c7bf6ebda3048cad1e">sqr_length</a>());
<a name="l00357"></a>00357 
<a name="l00358"></a>00358     sum_phi += w*<a class="code" href="classimesh__imls__surface.html#ae67dc43d910aff02a24cf7ddec257f40">unweighted_</a>[i] + <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/vgl__vector__2d_8h.html#af8601d1894aed553c33ab9d9a2c5af48">dot_product</a>(<a class="code" href="classimesh__imls__surface.html#a94fe59c7af85b8bebc8a1b369f2d81f2">normals_</a>[i],v)*w;
<a name="l00359"></a>00359     sum += w*<a class="code" href="classimesh__imls__surface.html#ac9885bb5c4e7aaba58b7b16064c7c5b9">area_</a>[i];
<a name="l00360"></a>00360   }
<a name="l00361"></a>00361 
<a name="l00362"></a>00362   assert(sum != 0.0);
<a name="l00363"></a>00363   <span class="keywordflow">return</span> sum_phi / sum - <a class="code" href="classimesh__imls__surface.html#a262e8acfff0f8284136092d50a8a4bba">iso_level_</a>;
<a name="l00364"></a>00364 }
<a name="l00365"></a>00365 
<a name="l00366"></a>00366 
<a name="l00367"></a>00367 <span class="comment">//: evaluate the function and its derivative (returned by reference)</span>
<a name="l00368"></a><a class="code" href="classimesh__imls__surface.html#ad914e6b71476a610be9df7164ec50b2b">00368</a> <span class="keywordtype">double</span> <a class="code" href="classimesh__imls__surface.html#ad914e6b71476a610be9df7164ec50b2b" title="evaluate the function and its derivative (returned by reference).">imesh_imls_surface::deriv</a>(<span class="keyword">const</span> <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__point__3d.html">vgl_point_3d&lt;double&gt;</a>&amp; p,
<a name="l00369"></a>00369                                  <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__3d.html">vgl_vector_3d&lt;double&gt;</a>&amp; dp)<span class="keyword"> const</span>
<a name="l00370"></a>00370 <span class="keyword"></span>{
<a name="l00371"></a>00371   <a class="code" href="structimesh__imls__surface_1_1integral__data.html" title="a data structure to hold the integral terms.">integral_data</a> sums;
<a name="l00372"></a>00372 
<a name="l00373"></a>00373   vcl_vector&lt;imesh_kd_tree_queue_entry&gt; remain;
<a name="l00374"></a>00374   tri_dist_func dist(<a class="code" href="classimesh__imls__surface.html#aec4e66dac2e3dae2d1034a250df17885">verts_</a>,*<a class="code" href="classimesh__imls__surface.html#ae486e3dedfe1a3f9c811f55998dadc3e">triangles_</a>);
<a name="l00375"></a>00375   <span class="comment">/* unsigned int ind = */</span>
<a name="l00376"></a>00376   imesh_closest_index&lt;tri_dist_func&amp;&gt;(p,<a class="code" href="classimesh__imls__surface.html#aa6683a2224c8e4099d02ded4258ce857">kd_tree_</a>,dist,&amp;remain);
<a name="l00377"></a>00377 
<a name="l00378"></a>00378   <span class="comment">// compute the (negative) maximum error of integration</span>
<a name="l00379"></a>00379   <span class="comment">// stored negative so that the max error is first when sorted by &lt;</span>
<a name="l00380"></a>00380   vcl_vector&lt;imesh_kd_tree_queue_entry&gt;::iterator itr = remain.begin();
<a name="l00381"></a>00381   <span class="keywordflow">for</span> (; itr != remain.end(); ++itr) {
<a name="l00382"></a>00382     <span class="keywordtype">double</span> min = <a class="code" href="classimesh__imls__surface.html#a535311b037c2448e5950eba706b0582d" title="evaluate the squared weighting function given a squared distance.">w2</a>(itr-&gt;val_);
<a name="l00383"></a>00383     <span class="keywordtype">double</span> max = <a class="code" href="classimesh__imls__surface.html#a535311b037c2448e5950eba706b0582d" title="evaluate the squared weighting function given a squared distance.">w2</a>(<a class="code" href="imesh__kd__tree_8cxx.html#a7bb66ceba635f24df166ecbd2aca2326" title="The maximum square distance between p and any point in b.">imesh_max_sq_dist</a>(p,itr-&gt;node_-&gt;inner_box_));
<a name="l00384"></a>00384     itr-&gt;val_ = (max - min)*<a class="code" href="classimesh__imls__surface.html#ac9885bb5c4e7aaba58b7b16064c7c5b9">area_</a>[itr-&gt;node_-&gt;index_];
<a name="l00385"></a>00385   }
<a name="l00386"></a>00386   vcl_make_heap( remain.begin(), remain.end() );
<a name="l00387"></a>00387 
<a name="l00388"></a>00388   vcl_pop_heap( remain.begin(), remain.end() );
<a name="l00389"></a>00389   <span class="keywordflow">while</span> (!remain.empty() &amp;&amp; -remain.back().val_ &gt; <a class="code" href="classimesh__imls__surface.html#a59d4345d4ea7afc09a5d6b1d2b84dd74">lambda_</a>*sums.<a class="code" href="structimesh__imls__surface_1_1integral__data.html#a54edb3c7132c659116d127e484b1d1a5">I</a>)
<a name="l00390"></a>00390   {
<a name="l00391"></a>00391     <a class="code" href="structimesh__kd__tree__node.html" title="A node in the KD-Tree.">imesh_kd_tree_node</a>* current = remain.back().node_;
<a name="l00392"></a>00392     remain.pop_back();
<a name="l00393"></a>00393 
<a name="l00394"></a>00394     <span class="keywordflow">if</span> (current-&gt;<a class="code" href="structimesh__kd__tree__node.html#a62d022cdc07a95c0ef124721150773fb" title="Return true if this node is a leaf node.">is_leaf</a>())
<a name="l00395"></a>00395     {
<a name="l00396"></a>00396       <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = current-&gt;<a class="code" href="structimesh__kd__tree__node.html#aaad4334738e44cee931ab9e784bf89cf" title="index into original data vector (at leaf nodes).">index_</a>;
<a name="l00397"></a>00397       <span class="keyword">const</span> <a class="code" href="classimesh__regular__face.html">imesh_regular_face&lt;3&gt;</a>&amp; tri = (*triangles_)[i];
<a name="l00398"></a>00398       <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i1=tri[0], i2=tri[1], i3=tri[2];
<a name="l00399"></a>00399       <span class="keyword">typedef</span> <a class="code" href="structimesh__imls__surface_1_1integral__data.html" title="a data structure to hold the integral terms.">integral_data</a> T;
<a name="l00400"></a>00400       <span class="keyword">typedef</span> <a class="code" href="structimesh__imls__surface_1_1integral__data.html" title="a data structure to hold the integral terms.">integral_data</a> (*F) (<span class="keyword">const</span> <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__point__3d.html">vgl_point_3d&lt;double&gt;</a>&amp;, <span class="keyword">const</span> vgl_point_3d&lt;double&gt;&amp;,
<a name="l00401"></a>00401                                   <span class="keyword">const</span> vgl_point_3d&lt;double&gt;&amp;, <span class="keyword">const</span> vgl_point_3d&lt;double&gt;&amp;,
<a name="l00402"></a>00402                                   double, double, double, double);
<a name="l00403"></a>00403       <a class="code" href="structimesh__imls__surface_1_1integral__data.html" title="a data structure to hold the integral terms.">integral_data</a> Id = triangle_quadrature&lt;T,F&gt;(<a class="code" href="classimesh__imls__surface.html#a7a106a6fe2bc37e3ccf175f44c75afb3" title="area integral of the squared weight function times a linearly interpolated value.">split_triangle_quadrature_with_deriv</a>,
<a name="l00404"></a>00404                                                   p,<a class="code" href="classimesh__imls__surface.html#aec4e66dac2e3dae2d1034a250df17885">verts_</a>[i1],verts_[i2],verts_[i3],
<a name="l00405"></a>00405                                                   <a class="code" href="classimesh__imls__surface.html#a94fe59c7af85b8bebc8a1b369f2d81f2">normals_</a>[i]*2.0,
<a name="l00406"></a>00406                                                   <a class="code" href="classimesh__imls__surface.html#a705d794cccf603a239182df8c1b5a0c7">phi_</a>[i1],<a class="code" href="classimesh__imls__surface.html#a705d794cccf603a239182df8c1b5a0c7">phi_</a>[i2],phi_[i3],<a class="code" href="classimesh__imls__surface.html#a5dc693e1bde2a4135a17367eff00f37d">eps2_</a>);
<a name="l00407"></a>00407       assert(!vnl_math_isnan(Id.I) &amp;&amp; !vnl_math_isnan(Id.I_phi));
<a name="l00408"></a>00408       <span class="comment">//assert(!vnl_math_isnan(Id.dI) &amp;&amp; !vnl_math_isnan(Id.dI_phi));</span>
<a name="l00409"></a>00409 
<a name="l00410"></a>00410       sums.<a class="code" href="structimesh__imls__surface_1_1integral__data.html#a54edb3c7132c659116d127e484b1d1a5">I</a> += Id.I;
<a name="l00411"></a>00411       sums.<a class="code" href="structimesh__imls__surface_1_1integral__data.html#a042aa1297b6631072099b008df303b78">I_phi</a> += Id.I_phi;
<a name="l00412"></a>00412       sums.<a class="code" href="structimesh__imls__surface_1_1integral__data.html#aabbbf30e111454e980bf5be09b4d9550">dI</a> += Id.dI;
<a name="l00413"></a>00413       sums.<a class="code" href="structimesh__imls__surface_1_1integral__data.html#a4b84fae65bb359687326e6367bdde275">dI_phi</a> += Id.dI_phi;
<a name="l00414"></a>00414       <span class="comment">// terms involving the normal constraints</span>
<a name="l00415"></a>00415       <span class="keywordflow">if</span> (<a class="code" href="classimesh__imls__surface.html#a4d33d2d1a6571c05d15d089f4fa33dc0">normal_len_</a>[i]&gt;0.0) {
<a name="l00416"></a>00416         <span class="keyword">const</span> <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__3d.html">vgl_vector_3d&lt;double&gt;</a>&amp; n = <a class="code" href="classimesh__imls__surface.html#a94fe59c7af85b8bebc8a1b369f2d81f2">normals_</a>[i];
<a name="l00417"></a>00417         <span class="keywordtype">double</span> plane_dist = <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/vgl__vector__2d_8h.html#af8601d1894aed553c33ab9d9a2c5af48">dot_product</a>(n,p-verts_[i1])/<a class="code" href="classimesh__imls__surface.html#a4d33d2d1a6571c05d15d089f4fa33dc0">normal_len_</a>[i];
<a name="l00418"></a>00418         sums.<a class="code" href="structimesh__imls__surface_1_1integral__data.html#a042aa1297b6631072099b008df303b78">I_phi</a> += plane_dist*Id.I;
<a name="l00419"></a>00419         sums.<a class="code" href="structimesh__imls__surface_1_1integral__data.html#a4b84fae65bb359687326e6367bdde275">dI_phi</a> += n*(Id.I/<a class="code" href="classimesh__imls__surface.html#a4d33d2d1a6571c05d15d089f4fa33dc0">normal_len_</a>[i]) + plane_dist*Id.dI;
<a name="l00420"></a>00420       }
<a name="l00421"></a>00421     }
<a name="l00422"></a>00422     <span class="keywordflow">else</span>
<a name="l00423"></a>00423     {
<a name="l00424"></a>00424       <span class="keywordtype">double</span> min = <a class="code" href="classimesh__imls__surface.html#a535311b037c2448e5950eba706b0582d" title="evaluate the squared weighting function given a squared distance.">w2</a>(<a class="code" href="imesh__kd__tree_8cxx.html#a76bf7e20506e3e26efe8010b83a0b784" title="The minimum square distance between p and any point in b.">imesh_min_sq_dist</a>(p,current-&gt;<a class="code" href="structimesh__kd__tree__node.html#a6f2d8f9cf174b6847e4947d04466b1d9" title="Left child.">left_</a>-&gt;inner_box_));
<a name="l00425"></a>00425       <span class="keywordtype">double</span> max = <a class="code" href="classimesh__imls__surface.html#a535311b037c2448e5950eba706b0582d" title="evaluate the squared weighting function given a squared distance.">w2</a>(<a class="code" href="imesh__kd__tree_8cxx.html#a7bb66ceba635f24df166ecbd2aca2326" title="The maximum square distance between p and any point in b.">imesh_max_sq_dist</a>(p,current-&gt;<a class="code" href="structimesh__kd__tree__node.html#a6f2d8f9cf174b6847e4947d04466b1d9" title="Left child.">left_</a>-&gt;inner_box_));
<a name="l00426"></a>00426       remain.push_back(<a class="code" href="classimesh__kd__tree__queue__entry.html" title="A class used for sorting a queue of tree nodes by an assigned value.">imesh_kd_tree_queue_entry</a>((max - min)*<a class="code" href="classimesh__imls__surface.html#ac9885bb5c4e7aaba58b7b16064c7c5b9">area_</a>[current-&gt;<a class="code" href="structimesh__kd__tree__node.html#a6f2d8f9cf174b6847e4947d04466b1d9" title="Left child.">left_</a>-&gt;index_],
<a name="l00427"></a>00427                                                  current-&gt;<a class="code" href="structimesh__kd__tree__node.html#a6f2d8f9cf174b6847e4947d04466b1d9" title="Left child.">left_</a>.get()));
<a name="l00428"></a>00428       vcl_push_heap(remain.begin(), remain.end());
<a name="l00429"></a>00429 
<a name="l00430"></a>00430       min = <a class="code" href="classimesh__imls__surface.html#a535311b037c2448e5950eba706b0582d" title="evaluate the squared weighting function given a squared distance.">w2</a>(<a class="code" href="imesh__kd__tree_8cxx.html#a76bf7e20506e3e26efe8010b83a0b784" title="The minimum square distance between p and any point in b.">imesh_min_sq_dist</a>(p,current-&gt;<a class="code" href="structimesh__kd__tree__node.html#a34a012f4fe05c11c7d709ce0e3369c59" title="Right child.">right_</a>-&gt;inner_box_));
<a name="l00431"></a>00431       max = <a class="code" href="classimesh__imls__surface.html#a535311b037c2448e5950eba706b0582d" title="evaluate the squared weighting function given a squared distance.">w2</a>(<a class="code" href="imesh__kd__tree_8cxx.html#a7bb66ceba635f24df166ecbd2aca2326" title="The maximum square distance between p and any point in b.">imesh_max_sq_dist</a>(p,current-&gt;<a class="code" href="structimesh__kd__tree__node.html#a34a012f4fe05c11c7d709ce0e3369c59" title="Right child.">right_</a>-&gt;inner_box_));
<a name="l00432"></a>00432       remain.push_back(<a class="code" href="classimesh__kd__tree__queue__entry.html" title="A class used for sorting a queue of tree nodes by an assigned value.">imesh_kd_tree_queue_entry</a>((max - min)*area_[current-&gt;<a class="code" href="structimesh__kd__tree__node.html#a34a012f4fe05c11c7d709ce0e3369c59" title="Right child.">right_</a>-&gt;index_],
<a name="l00433"></a>00433                                                  current-&gt;<a class="code" href="structimesh__kd__tree__node.html#a34a012f4fe05c11c7d709ce0e3369c59" title="Right child.">right_</a>.get()));
<a name="l00434"></a>00434       vcl_push_heap(remain.begin(), remain.end());
<a name="l00435"></a>00435     }
<a name="l00436"></a>00436     <span class="keywordflow">if</span> (!remain.empty())
<a name="l00437"></a>00437       vcl_pop_heap( remain.begin(), remain.end() );
<a name="l00438"></a>00438   }
<a name="l00439"></a>00439 
<a name="l00440"></a>00440   <span class="comment">// approximate the contribution from the remain nodes</span>
<a name="l00441"></a>00441   <span class="keywordflow">for</span> (itr = remain.begin(); itr != remain.end(); ++itr) {
<a name="l00442"></a>00442     <span class="comment">// Use approximation assuming the weight is constant</span>
<a name="l00443"></a>00443     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = itr-&gt;node_-&gt;index_;
<a name="l00444"></a>00444     <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__3d.html">vgl_vector_3d&lt;double&gt;</a> <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/vgl__vector__2d_8h.html#a38bf1e5e0427bdeba2b469eea9befc23">v</a>(p-<a class="code" href="classimesh__imls__surface.html#ac32caa7cc6c6dc8192c81243885786f2">centroid_</a>[i]);
<a name="l00445"></a>00445     <span class="keywordtype">double</span> w = 1.0/(v.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__3d.html#a9415896a1013a2c7bf6ebda3048cad1e">sqr_length</a>() + <a class="code" href="classimesh__imls__surface.html#a5dc693e1bde2a4135a17367eff00f37d">eps2_</a>);
<a name="l00446"></a>00446     <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__3d.html">vgl_vector_3d&lt;double&gt;</a> dw(v);
<a name="l00447"></a>00447     dw *= -4*w;
<a name="l00448"></a>00448     w *= w;
<a name="l00449"></a>00449     dw *= w;
<a name="l00450"></a>00450 
<a name="l00451"></a>00451     <span class="keyword">const</span> <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__3d.html">vgl_vector_3d&lt;double&gt;</a>&amp; n = <a class="code" href="classimesh__imls__surface.html#a94fe59c7af85b8bebc8a1b369f2d81f2">normals_</a>[i];
<a name="l00452"></a>00452     <span class="keywordtype">double</span> plane_dist = <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/vgl__vector__2d_8h.html#af8601d1894aed553c33ab9d9a2c5af48">dot_product</a>(n,v);
<a name="l00453"></a>00453     sums.<a class="code" href="structimesh__imls__surface_1_1integral__data.html#a54edb3c7132c659116d127e484b1d1a5">I</a> += w*<a class="code" href="classimesh__imls__surface.html#ac9885bb5c4e7aaba58b7b16064c7c5b9">area_</a>[i];
<a name="l00454"></a>00454     sums.<a class="code" href="structimesh__imls__surface_1_1integral__data.html#a042aa1297b6631072099b008df303b78">I_phi</a> += w*<a class="code" href="classimesh__imls__surface.html#ae67dc43d910aff02a24cf7ddec257f40">unweighted_</a>[i] + plane_dist*w;
<a name="l00455"></a>00455     sums.<a class="code" href="structimesh__imls__surface_1_1integral__data.html#aabbbf30e111454e980bf5be09b4d9550">dI</a> += dw*area_[i];
<a name="l00456"></a>00456     sums.<a class="code" href="structimesh__imls__surface_1_1integral__data.html#a4b84fae65bb359687326e6367bdde275">dI_phi</a> += n*w + dw*(<a class="code" href="classimesh__imls__surface.html#ae67dc43d910aff02a24cf7ddec257f40">unweighted_</a>[i] + plane_dist);
<a name="l00457"></a>00457   }
<a name="l00458"></a>00458 
<a name="l00459"></a>00459 
<a name="l00460"></a>00460   assert(sums.<a class="code" href="structimesh__imls__surface_1_1integral__data.html#a54edb3c7132c659116d127e484b1d1a5">I</a> != 0.0);
<a name="l00461"></a>00461   dp = (-sums.<a class="code" href="structimesh__imls__surface_1_1integral__data.html#a042aa1297b6631072099b008df303b78">I_phi</a>/(sums.<a class="code" href="structimesh__imls__surface_1_1integral__data.html#a54edb3c7132c659116d127e484b1d1a5">I</a>*sums.<a class="code" href="structimesh__imls__surface_1_1integral__data.html#a54edb3c7132c659116d127e484b1d1a5">I</a>))*sums.<a class="code" href="structimesh__imls__surface_1_1integral__data.html#aabbbf30e111454e980bf5be09b4d9550">dI</a> + sums.<a class="code" href="structimesh__imls__surface_1_1integral__data.html#a4b84fae65bb359687326e6367bdde275">dI_phi</a>/sums.<a class="code" href="structimesh__imls__surface_1_1integral__data.html#a54edb3c7132c659116d127e484b1d1a5">I</a>;
<a name="l00462"></a>00462   <span class="keywordflow">return</span> sums.<a class="code" href="structimesh__imls__surface_1_1integral__data.html#a042aa1297b6631072099b008df303b78">I_phi</a> / sums.<a class="code" href="structimesh__imls__surface_1_1integral__data.html#a54edb3c7132c659116d127e484b1d1a5">I</a> - <a class="code" href="classimesh__imls__surface.html#a262e8acfff0f8284136092d50a8a4bba">iso_level_</a>;
<a name="l00463"></a>00463 }
<a name="l00464"></a>00464 
<a name="l00465"></a>00465 
<a name="l00466"></a>00466 <span class="comment">//: evaluate the function and its first and second derivatives (returned by reference)</span>
<a name="l00467"></a><a class="code" href="classimesh__imls__surface.html#a280d114d72e3436140583d824c4ebdf4">00467</a> <span class="keywordtype">double</span> <a class="code" href="classimesh__imls__surface.html#a280d114d72e3436140583d824c4ebdf4" title="evaluate the function and its first and second derivatives (returned by reference).">imesh_imls_surface::deriv2</a>(<span class="keyword">const</span> <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__point__3d.html">vgl_point_3d&lt;double&gt;</a>&amp; p,
<a name="l00468"></a>00468                                   <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__3d.html">vgl_vector_3d&lt;double&gt;</a>&amp; dp,
<a name="l00469"></a>00469                                   vnl_double_3x3&amp; ddp)<span class="keyword"> const</span>
<a name="l00470"></a>00470 <span class="keyword"></span>{
<a name="l00471"></a>00471   <span class="keywordtype">double</span> eps = 1e-8;
<a name="l00472"></a>00472   <span class="keywordtype">double</span> val = this-&gt;<a class="code" href="classimesh__imls__surface.html#ad914e6b71476a610be9df7164ec50b2b" title="evaluate the function and its derivative (returned by reference).">deriv</a>(p,dp);
<a name="l00473"></a>00473   <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__3d.html">vgl_vector_3d&lt;double&gt;</a> dpx,dpy,dpz;
<a name="l00474"></a>00474   this-&gt;<a class="code" href="classimesh__imls__surface.html#ad914e6b71476a610be9df7164ec50b2b" title="evaluate the function and its derivative (returned by reference).">deriv</a>(p+<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__3d.html">vgl_vector_3d&lt;double&gt;</a>(eps,0,0),dpx);
<a name="l00475"></a>00475   this-&gt;<a class="code" href="classimesh__imls__surface.html#ad914e6b71476a610be9df7164ec50b2b" title="evaluate the function and its derivative (returned by reference).">deriv</a>(p+<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__3d.html">vgl_vector_3d&lt;double&gt;</a>(0,eps,0),dpy);
<a name="l00476"></a>00476   this-&gt;<a class="code" href="classimesh__imls__surface.html#ad914e6b71476a610be9df7164ec50b2b" title="evaluate the function and its derivative (returned by reference).">deriv</a>(p+<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__3d.html">vgl_vector_3d&lt;double&gt;</a>(0,0,eps),dpz);
<a name="l00477"></a>00477   dpx -= dp;
<a name="l00478"></a>00478   dpx /= eps;
<a name="l00479"></a>00479   dpy -= dp;
<a name="l00480"></a>00480   dpy /= eps;
<a name="l00481"></a>00481   dpz -= dp;
<a name="l00482"></a>00482   dpz /= eps;
<a name="l00483"></a>00483   ddp(0,0) = dpx.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__3d.html#a912b0263c344513af0ffa0c07415fe20">x</a>();   ddp(0,1) = dpy.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__3d.html#a912b0263c344513af0ffa0c07415fe20">x</a>();   ddp(0,2) = dpz.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__3d.html#a912b0263c344513af0ffa0c07415fe20">x</a>();
<a name="l00484"></a>00484   ddp(1,0) = dpx.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__3d.html#af31e8106e9f1aa85bdc70bc40a73dff6">y</a>();   ddp(1,1) = dpy.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__3d.html#af31e8106e9f1aa85bdc70bc40a73dff6">y</a>();   ddp(1,2) = dpz.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__3d.html#af31e8106e9f1aa85bdc70bc40a73dff6">y</a>();
<a name="l00485"></a>00485   ddp(2,0) = dpx.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__3d.html#aa655643683e63092c938ea6f2b4459e0">z</a>();   ddp(2,1) = dpy.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__3d.html#aa655643683e63092c938ea6f2b4459e0">z</a>();   ddp(2,2) = dpz.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__3d.html#aa655643683e63092c938ea6f2b4459e0">z</a>();
<a name="l00486"></a>00486   <span class="keywordflow">return</span> val;
<a name="l00487"></a>00487 }
<a name="l00488"></a>00488 
<a name="l00489"></a>00489 <span class="comment">//: integrals of f(x)dx and x*f(x)dx over [0,1] where f(x)= 1/((x+k1)^2 + k2)^2</span>
<a name="l00490"></a>00490 <span class="comment">//</span>
<a name="l00491"></a>00491 <span class="comment">//  These equations are wrong in the paper, they should be (for a=1):</span>
<a name="l00492"></a>00492 <span class="comment">// Beta = atan( k1/sqrt(k2) ) - atan( (k1+1)/sqrt(k2) )</span>
<a name="l00493"></a>00493 <span class="comment">// I1 = -Beta * 1/(2*k2^(3/2))  + (k2 - k1*(k1+1)) / (2*k2*(k1^2+k2)*((k1+1)^2+k2))</span>
<a name="l00494"></a>00494 <span class="comment">// Ix = Beta * k1/(2*k2^(3/2))  + (k1 + 1) / (2*k2*((k1+1)^2+k2))</span>
<a name="l00495"></a>00495 <span class="keywordtype">void</span>
<a name="l00496"></a><a class="code" href="classimesh__imls__surface.html#a2119bcff24366ff1c0d76df0514b4d42">00496</a> <a class="code" href="classimesh__imls__surface.html#a2119bcff24366ff1c0d76df0514b4d42" title="integrals of f(x)dx and x*f(x)dx over [0,1] where f(x)= 1/((x+k1)^2 + k2)^2.">imesh_imls_surface::line_integrals</a>(<span class="keywordtype">double</span> k1, <span class="keywordtype">double</span> k2, <span class="keywordtype">double</span>&amp; I1, <span class="keywordtype">double</span>&amp; Ix)
<a name="l00497"></a>00497 {
<a name="l00498"></a>00498   <span class="keywordtype">double</span> sqrt_k2 = vcl_sqrt(k2);
<a name="l00499"></a>00499   <span class="keywordtype">double</span> k1_p1 = k1+1.0;
<a name="l00500"></a>00500   I1 = Ix = (vcl_atan(k1_p1/sqrt_k2) - vcl_atan(k1/sqrt_k2) ) / (2.0*k2*sqrt_k2);
<a name="l00501"></a>00501   Ix *= -k1;
<a name="l00502"></a>00502 
<a name="l00503"></a>00503   <span class="keywordtype">double</span> denom = 1.0/(2.0*k2*(k1_p1*k1_p1+k2));
<a name="l00504"></a>00504 
<a name="l00505"></a>00505   Ix += k1_p1 * denom;
<a name="l00506"></a>00506   I1 += (k2 - k1*k1_p1)*denom / (k1*k1+k2);
<a name="l00507"></a>00507 }
<a name="l00508"></a>00508 
<a name="l00509"></a>00509 
<a name="l00510"></a>00510 <span class="comment">//: integrals of f(x)dx and x*f(x)dx over [0,1] where f(x)= 1/((x+k1)^2 + k2)^2</span>
<a name="l00511"></a>00511 <span class="comment">//  Also compute the integrals when f(x)=1/((x+k1)^2 + k2)^3 (for use in derivatives)</span>
<a name="l00512"></a>00512 <span class="comment">//</span>
<a name="l00513"></a>00513 <span class="comment">// Beta = atan( k1/sqrt(k2) ) - atan( (k1+1)/sqrt(k2) )</span>
<a name="l00514"></a>00514 <span class="comment">// I1 = -Beta * 1/(2*k2^(3/2))  + (k2 - k1*(k1+1)) / (2*k2*(k1^2+k2)*((k1+1)^2+k2))</span>
<a name="l00515"></a>00515 <span class="comment">// Ix = Beta * k1/(2*k2^(3/2))  + (k1 + 1) / (2*k2*((k1+1)^2+k2))</span>
<a name="l00516"></a>00516 <span class="comment">// dI1 = 1/8 * ( -Beta*3/k2^(5/2) +</span>
<a name="l00517"></a>00517 <span class="comment">//               (5*k2^3 - (k1*(k1+1)-3)*k2^2 - k1*(k1+1)*(9*k1*(k1+1)+5)*k2 - 3*k1^3*(k1+1)^3)</span>
<a name="l00518"></a>00518 <span class="comment">//               / (k2^2*(k1^2+k2)^2*((k1+1)^2+k2)^2) )</span>
<a name="l00519"></a>00519 <span class="comment">// dIx = 1/8 * ( Beta*3*k1/k2^(5/2) +</span>
<a name="l00520"></a>00520 <span class="comment">//               ((k1^2+k2)*((3*(k1+1)+1)*k2^2 + (k1+1)*(6*k1^2+3*k1+2)*k2 + 3*k1^2*(k1+1)^3))</span>
<a name="l00521"></a>00521 <span class="comment">//               /(k2^2*(k1^2+k2)^2*((k1+1)^2+k2)^2)  )</span>
<a name="l00522"></a>00522 <span class="comment">// dIx2 = 1/8 * ( -Beta*(3*k1^2+k2)/k2^(5/2) -</span>
<a name="l00523"></a>00523 <span class="comment">//                ((k1^2+k2)^2*(k2^2 + (k1+1)*(4*k1-1)*k2 + 3*k1*(k1+1)^3))</span>
<a name="l00524"></a>00524 <span class="comment">//                /(k2^2*(k1^2+k2)^2*((k1+1)^2+k2)^2)  )</span>
<a name="l00525"></a>00525 <span class="keywordtype">void</span>
<a name="l00526"></a><a class="code" href="classimesh__imls__surface.html#abd745756c7bb10add44c4ecc2d5a22de">00526</a> <a class="code" href="classimesh__imls__surface.html#a2119bcff24366ff1c0d76df0514b4d42" title="integrals of f(x)dx and x*f(x)dx over [0,1] where f(x)= 1/((x+k1)^2 + k2)^2.">imesh_imls_surface::line_integrals</a>(<span class="keywordtype">double</span> k1, <span class="keywordtype">double</span> k2,
<a name="l00527"></a>00527                                    <span class="keywordtype">double</span>&amp; I1, <span class="keywordtype">double</span>&amp; Ix,
<a name="l00528"></a>00528                                    <span class="keywordtype">double</span>&amp; dI1, <span class="keywordtype">double</span>&amp; dIx, <span class="keywordtype">double</span>&amp; dIx2)
<a name="l00529"></a>00529 {
<a name="l00530"></a>00530   <span class="keywordtype">double</span> sqrt_k2 = vcl_sqrt(k2);
<a name="l00531"></a>00531   <span class="keywordtype">double</span> k1_p1 = k1+1.0;
<a name="l00532"></a>00532   <span class="keywordtype">double</span> k1_2 = k1*k1;
<a name="l00533"></a>00533   <span class="keywordtype">double</span> k2_2 = k2*k2;
<a name="l00534"></a>00534   <span class="keywordtype">double</span> k1_p1_2 = k1_p1*k1_p1;
<a name="l00535"></a>00535   <span class="keywordtype">double</span> t1 = k2 + k1_p1_2;
<a name="l00536"></a>00536   <span class="keywordtype">double</span> t2 = k2 + k1_2;
<a name="l00537"></a>00537   <span class="keywordtype">double</span> t3 = 3*k1_p1_2*k1_p1*k1;
<a name="l00538"></a>00538 
<a name="l00539"></a>00539 
<a name="l00540"></a>00540   I1 = dI1 = (vcl_atan(k1_p1/sqrt_k2) - vcl_atan(k1/sqrt_k2) ) / (2.0*k2*sqrt_k2);
<a name="l00541"></a>00541   dI1 *= 0.75/k2;
<a name="l00542"></a>00542   Ix = -k1 * I1;
<a name="l00543"></a>00543   dIx = -k1 * dI1;
<a name="l00544"></a>00544   dIx2 = 0.25*I1*(3*k1_2+k2)/k2;
<a name="l00545"></a>00545 
<a name="l00546"></a>00546 
<a name="l00547"></a>00547   <span class="keywordtype">double</span> denom = 0.5/(k2*t1);
<a name="l00548"></a>00548   <span class="keywordtype">double</span> ddenom = 0.125/(k2_2*t2*t2*t1*t1);
<a name="l00549"></a>00549 
<a name="l00550"></a>00550   I1 += (k2 - k1*k1_p1)*denom / t2;
<a name="l00551"></a>00551   Ix += k1_p1 * denom;
<a name="l00552"></a>00552 
<a name="l00553"></a>00553   dI1 += (5*k2*k2_2 - (k1*k1_p1-3)*k2_2 - k1*k1_p1*(9*k1*k1_p1+5)*k2 - k1_2*t3 )*ddenom;
<a name="l00554"></a>00554   dIx += t2*((3*k1_p1+1)*k2_2 + k1_p1*(6*k1_2+3*k1+2)*k2 + k1*t3)*ddenom;
<a name="l00555"></a>00555   dIx2 -= t2*t2*(k2_2 + k1_p1*(4*k1-1)*k2 + t3)*ddenom;
<a name="l00556"></a>00556 }
<a name="l00557"></a>00557 
<a name="l00558"></a>00558 
<a name="l00559"></a>00559 <span class="comment">//: line integral of the squared weight function times a linear value on the line from p0 to p1</span>
<a name="l00560"></a>00560 <span class="comment">//  (value at p0 is v0 and at p1 is v1)</span>
<a name="l00561"></a>00561 <span class="comment">//  \a eps2 is epsilon^2</span>
<a name="l00562"></a>00562 <span class="keywordtype">double</span>
<a name="l00563"></a><a class="code" href="classimesh__imls__surface.html#ae749050452ce5e3d06397c1cb320f6a3">00563</a> <a class="code" href="classimesh__imls__surface.html#ae749050452ce5e3d06397c1cb320f6a3" title="line integral of the squared weight function times a linear value on the line from p0 to p1...">imesh_imls_surface::line_integral</a>(<span class="keyword">const</span> <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__point__3d.html">vgl_point_3d&lt;double&gt;</a>&amp; x,
<a name="l00564"></a>00564                                   <span class="keyword">const</span> <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__point__3d.html">vgl_point_3d&lt;double&gt;</a>&amp; p0,
<a name="l00565"></a>00565                                   <span class="keyword">const</span> <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__point__3d.html">vgl_point_3d&lt;double&gt;</a>&amp; p1,
<a name="l00566"></a>00566                                   <span class="keywordtype">double</span> v0, <span class="keywordtype">double</span> v1, <span class="keywordtype">double</span> eps2)
<a name="l00567"></a>00567 {
<a name="l00568"></a>00568   <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__3d.html">vgl_vector_3d&lt;double&gt;</a> ab(p1-p0);
<a name="l00569"></a>00569   <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__3d.html">vgl_vector_3d&lt;double&gt;</a> xa(p0-x);
<a name="l00570"></a>00570   <span class="keywordtype">double</span> denom = 1.0/ab.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__3d.html#a9415896a1013a2c7bf6ebda3048cad1e">sqr_length</a>();
<a name="l00571"></a>00571   <span class="keywordtype">double</span> k1 = <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/vgl__vector__2d_8h.html#af8601d1894aed553c33ab9d9a2c5af48">dot_product</a>(ab,xa)*denom;
<a name="l00572"></a>00572   <span class="keywordtype">double</span> k2 = (xa.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__3d.html#a9415896a1013a2c7bf6ebda3048cad1e">sqr_length</a>()+eps2)*denom - k1*k1;
<a name="l00573"></a>00573   <span class="keywordtype">double</span> I1,Ix;
<a name="l00574"></a>00574   <a class="code" href="classimesh__imls__surface.html#a2119bcff24366ff1c0d76df0514b4d42" title="integrals of f(x)dx and x*f(x)dx over [0,1] where f(x)= 1/((x+k1)^2 + k2)^2.">line_integrals</a>(k1,k2,I1,Ix);
<a name="l00575"></a>00575   <span class="keywordflow">return</span> (v0*I1 + (v1-v0)*Ix)*vcl_sqrt(denom)*denom;
<a name="l00576"></a>00576 }
<a name="l00577"></a>00577 
<a name="l00578"></a>00578 
<a name="l00579"></a>00579 <span class="comment">//: The derivative of the line integral with respect to x</span>
<a name="l00580"></a>00580 <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__3d.html">vgl_vector_3d&lt;double&gt;</a>
<a name="l00581"></a><a class="code" href="classimesh__imls__surface.html#a4b215b95f59fdf04b8c6a8965d3e154b">00581</a> <a class="code" href="classimesh__imls__surface.html#a4b215b95f59fdf04b8c6a8965d3e154b" title="The derivative of the line integral with respect to x.">imesh_imls_surface::line_integral_deriv</a>(<span class="keyword">const</span> <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__point__3d.html">vgl_point_3d&lt;double&gt;</a>&amp; x,
<a name="l00582"></a>00582                                         <span class="keyword">const</span> <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__point__3d.html">vgl_point_3d&lt;double&gt;</a>&amp; p0,
<a name="l00583"></a>00583                                         <span class="keyword">const</span> <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__point__3d.html">vgl_point_3d&lt;double&gt;</a>&amp; p1,
<a name="l00584"></a>00584                                         <span class="keywordtype">double</span> v0, <span class="keywordtype">double</span> v1, <span class="keywordtype">double</span> eps2)
<a name="l00585"></a>00585 {
<a name="l00586"></a>00586   <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__3d.html">vgl_vector_3d&lt;double&gt;</a> ab(p1-p0);
<a name="l00587"></a>00587   <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__3d.html">vgl_vector_3d&lt;double&gt;</a> xa(p0-x);
<a name="l00588"></a>00588   <span class="keywordtype">double</span> denom = 1.0/ab.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__3d.html#a9415896a1013a2c7bf6ebda3048cad1e">sqr_length</a>();
<a name="l00589"></a>00589   <span class="keywordtype">double</span> k1 = <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/vgl__vector__2d_8h.html#af8601d1894aed553c33ab9d9a2c5af48">dot_product</a>(ab,xa)*denom;
<a name="l00590"></a>00590   <span class="keywordtype">double</span> k2 = (xa.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__3d.html#a9415896a1013a2c7bf6ebda3048cad1e">sqr_length</a>()+eps2)*denom - k1*k1;
<a name="l00591"></a>00591   <span class="keywordtype">double</span> I1,Ix,dI1,dIx,dIx2;
<a name="l00592"></a>00592   <a class="code" href="classimesh__imls__surface.html#a2119bcff24366ff1c0d76df0514b4d42" title="integrals of f(x)dx and x*f(x)dx over [0,1] where f(x)= 1/((x+k1)^2 + k2)^2.">line_integrals</a>(k1,k2,I1,Ix,dI1,dIx,dIx2);
<a name="l00593"></a>00593   denom = 4*vcl_sqrt(denom)*denom*denom;
<a name="l00594"></a>00594 
<a name="l00595"></a>00595   <span class="keywordflow">return</span> (xa*(v0*dI1+(v1-v0)*dIx)
<a name="l00596"></a>00596         + ab*(v0*dIx + (v1-v0)*dIx2))*denom;<span class="comment">//4*vcl_sqrt(denom)*denom*denom;</span>
<a name="l00597"></a>00597 }
<a name="l00598"></a>00598 
<a name="l00599"></a>00599 
<a name="l00600"></a>00600 <span class="comment">//: area integral of the squared weight function times a linearly interpolated value</span>
<a name="l00601"></a>00601 <span class="comment">//  \a m is the point closest point on the triangle to sample point \a x</span>
<a name="l00602"></a>00602 <span class="comment">//  \a p0 and \a p1 are the other vertices</span>
<a name="l00603"></a>00603 <span class="comment">//  call triangle_quadrature to first split an arbitrary triangle</span>
<a name="l00604"></a>00604 <span class="comment">//  \a eps2 is epsilon^2</span>
<a name="l00605"></a>00605 <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__2d.html">vgl_vector_2d&lt;double&gt;</a>
<a name="l00606"></a><a class="code" href="classimesh__imls__surface.html#ad836ea851e9d26bf7aba4dd35fe6de65">00606</a> <a class="code" href="classimesh__imls__surface.html#ad836ea851e9d26bf7aba4dd35fe6de65" title="area integral of the squared weight function times a linearly interpolated value.">imesh_imls_surface::split_triangle_quadrature</a>(<span class="keyword">const</span> <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__point__3d.html">vgl_point_3d&lt;double&gt;</a>&amp; x,
<a name="l00607"></a>00607                                               <span class="keyword">const</span> <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__point__3d.html">vgl_point_3d&lt;double&gt;</a>&amp; pm,
<a name="l00608"></a>00608                                               <span class="keyword">const</span> <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__point__3d.html">vgl_point_3d&lt;double&gt;</a>&amp; p1,
<a name="l00609"></a>00609                                               <span class="keyword">const</span> <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__point__3d.html">vgl_point_3d&lt;double&gt;</a>&amp; p2,
<a name="l00610"></a>00610                                               <span class="keywordtype">double</span> vm, <span class="keywordtype">double</span> v1, <span class="keywordtype">double</span> v2,
<a name="l00611"></a>00611                                               <span class="keywordtype">double</span> eps)
<a name="l00612"></a>00612 {
<a name="l00613"></a>00613   <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__point__3d.html">vgl_point_3d&lt;double&gt;</a> pp(p1), pn(p2);
<a name="l00614"></a>00614   <span class="keywordtype">double</span> <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/vgl__homg__line__2d_8txx.html#ad49b25478287e1337feef22ecbeed231">vp</a>(v1), vn(v2);
<a name="l00615"></a>00615   <span class="keywordflow">if</span> ((pp-x).<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/vgl__vector__2d_8h.html#a31c7db8164e71d411a1a821525102dc3">length</a>() &gt; (pn-x).<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/vgl__vector__2d_8h.html#a31c7db8164e71d411a1a821525102dc3">length</a>()) {
<a name="l00616"></a>00616     <span class="comment">// swap so that pp is closest to x</span>
<a name="l00617"></a>00617     pp = p2; pn = p1;
<a name="l00618"></a>00618     <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/vgl__homg__line__2d_8txx.html#ad49b25478287e1337feef22ecbeed231">vp</a> = v2; vn = v1;
<a name="l00619"></a>00619   }
<a name="l00620"></a>00620 
<a name="l00621"></a>00621   <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__3d.html">vgl_vector_3d&lt;double&gt;</a> d1(pp-pm);
<a name="l00622"></a>00622   <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__3d.html">vgl_vector_3d&lt;double&gt;</a> d2(pn-pm);
<a name="l00623"></a>00623   <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__3d.html">vgl_vector_3d&lt;double&gt;</a> d3(pm-x);
<a name="l00624"></a>00624 
<a name="l00625"></a>00625   <span class="keywordtype">double</span> t1 = d1.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__3d.html#a9415896a1013a2c7bf6ebda3048cad1e">sqr_length</a>();
<a name="l00626"></a>00626   <span class="keywordtype">double</span> t2 = <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/vgl__vector__2d_8h.html#af8601d1894aed553c33ab9d9a2c5af48">dot_product</a>(d1,d2);
<a name="l00627"></a>00627   <span class="keywordtype">double</span> t3 = <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/vgl__vector__2d_8h.html#af8601d1894aed553c33ab9d9a2c5af48">dot_product</a>(d1,d3);
<a name="l00628"></a>00628   <span class="keywordtype">double</span> t4 = d2.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__3d.html#a9415896a1013a2c7bf6ebda3048cad1e">sqr_length</a>();
<a name="l00629"></a>00629   <span class="keywordtype">double</span> t5 = <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/vgl__vector__2d_8h.html#af8601d1894aed553c33ab9d9a2c5af48">dot_product</a>(d2,d3) * 2;
<a name="l00630"></a>00630   <span class="keywordtype">double</span> t6 = d3.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__3d.html#a9415896a1013a2c7bf6ebda3048cad1e">sqr_length</a>() + eps;
<a name="l00631"></a>00631 
<a name="l00632"></a>00632   <span class="comment">// compute height (divided by 2*sqrt(t1))</span>
<a name="l00633"></a>00633   <span class="comment">// early exit if triangle flat</span>
<a name="l00634"></a>00634   <span class="keywordtype">double</span> height = t4/t1 - t2*t2/(t1*t1);
<a name="l00635"></a>00635   <span class="keywordflow">if</span> (!(height &gt; 0.0))
<a name="l00636"></a>00636     <span class="keywordflow">return</span> <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__2d.html">vgl_vector_2d&lt;double&gt;</a>(0,0);
<a name="l00637"></a>00637   height = vcl_sqrt(height)/2.0;
<a name="l00638"></a>00638 
<a name="l00639"></a>00639   <span class="keywordtype">double</span> vt1 = vn-vm;
<a name="l00640"></a>00640   <span class="keywordtype">double</span> vt2 = <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/vgl__homg__line__2d_8txx.html#ad49b25478287e1337feef22ecbeed231">vp</a>-vm;
<a name="l00641"></a>00641 
<a name="l00642"></a>00642   <span class="keywordtype">double</span> alpha = 2.0/3.0;
<a name="l00643"></a>00643   <span class="keywordtype">double</span> sum1 = 0.0, sum2 = 0.0;
<a name="l00644"></a>00644   <span class="keywordtype">double</span> weight = (1.0/alpha-alpha);
<a name="l00645"></a>00645   <span class="keywordtype">double</span> I1,Ix,u_1,denom,k1,k2;
<a name="l00646"></a>00646   <span class="keywordtype">double</span> u = alpha;
<a name="l00647"></a>00647   <span class="keywordtype">double</span> last_li1 = 0.0, last_li2 = 0.0;
<a name="l00648"></a>00648   <span class="comment">// integrate using the trapezoid rule with non-uniform sampling</span>
<a name="l00649"></a>00649   <span class="keywordflow">for</span> (; u&gt;0.01; u*=alpha) {
<a name="l00650"></a>00650     sum1 += last_li1;
<a name="l00651"></a>00651     sum2 += last_li2;
<a name="l00652"></a>00652     u_1 = 1.0-u;
<a name="l00653"></a>00653     denom = 1.0/(u_1*u_1*t1);
<a name="l00654"></a>00654     k1 = (t3 + u*t2)*u_1*denom;
<a name="l00655"></a>00655     k2 = (t6 + u*t5 + u*u*t4)*denom - k1*k1;
<a name="l00656"></a>00656     <a class="code" href="classimesh__imls__surface.html#a2119bcff24366ff1c0d76df0514b4d42" title="integrals of f(x)dx and x*f(x)dx over [0,1] where f(x)= 1/((x+k1)^2 + k2)^2.">line_integrals</a>(k1,k2,I1,Ix);
<a name="l00657"></a>00657     denom *= u / u_1;
<a name="l00658"></a>00658     last_li1 = ((vm+u*vt1)*I1 + u_1*vt2*Ix) * denom;
<a name="l00659"></a>00659     last_li2 = I1 * denom;
<a name="l00660"></a>00660   }
<a name="l00661"></a>00661   sum1 *= weight;
<a name="l00662"></a>00662   sum1 += last_li1/alpha;
<a name="l00663"></a>00663   sum2 *= weight;
<a name="l00664"></a>00664   sum2 += last_li2/alpha;
<a name="l00665"></a>00665 
<a name="l00666"></a>00666   <span class="comment">// add the last trapezoid covering the remaining area</span>
<a name="l00667"></a>00667   denom = 1.0/t1;
<a name="l00668"></a>00668   k1 = t3*denom;
<a name="l00669"></a>00669   k2 = t6*denom - k1*k1;
<a name="l00670"></a>00670   <a class="code" href="classimesh__imls__surface.html#a2119bcff24366ff1c0d76df0514b4d42" title="integrals of f(x)dx and x*f(x)dx over [0,1] where f(x)= 1/((x+k1)^2 + k2)^2.">line_integrals</a>(k1,k2,I1,Ix);
<a name="l00671"></a>00671   denom *= u/alpha;
<a name="l00672"></a>00672   sum1 += (vm*I1 + vt2*Ix) * denom;
<a name="l00673"></a>00673   sum2 += I1 * denom;
<a name="l00674"></a>00674 
<a name="l00675"></a>00675   sum1 *= height;
<a name="l00676"></a>00676   sum2 *= height;
<a name="l00677"></a>00677 
<a name="l00678"></a>00678 
<a name="l00679"></a>00679   <span class="keywordflow">return</span> <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__2d.html">vgl_vector_2d&lt;double&gt;</a>(sum1,sum2);
<a name="l00680"></a>00680 }
<a name="l00681"></a>00681 
<a name="l00682"></a>00682 
<a name="l00683"></a>00683 <span class="comment">//: area integral of the squared weight function times a linearly interpolated value</span>
<a name="l00684"></a>00684 <span class="comment">//  Also computes vector term used in the derivative</span>
<a name="l00685"></a>00685 <span class="comment">//  \a m is the point closest point on the triangle to sample point \a x</span>
<a name="l00686"></a>00686 <span class="comment">//  \a p0 and \a p1 are the other vertices</span>
<a name="l00687"></a>00687 <span class="comment">//  call triangle_quadrature to first split an arbitrary triangle</span>
<a name="l00688"></a>00688 <span class="comment">//  \a eps2 is epsilon^2</span>
<a name="l00689"></a>00689 <a class="code" href="structimesh__imls__surface_1_1integral__data.html" title="a data structure to hold the integral terms.">imesh_imls_surface::integral_data</a> <a class="code" href="classimesh__imls__surface.html#a7a106a6fe2bc37e3ccf175f44c75afb3" title="area integral of the squared weight function times a linearly interpolated value.">imesh_imls_surface::</a>
<a name="l00690"></a><a class="code" href="classimesh__imls__surface.html#a7a106a6fe2bc37e3ccf175f44c75afb3">00690</a> <a class="code" href="classimesh__imls__surface.html#a7a106a6fe2bc37e3ccf175f44c75afb3" title="area integral of the squared weight function times a linearly interpolated value.">split_triangle_quadrature_with_deriv</a>(<span class="keyword">const</span> <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__point__3d.html">vgl_point_3d&lt;double&gt;</a>&amp; x,
<a name="l00691"></a>00691                                      <span class="keyword">const</span> <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__point__3d.html">vgl_point_3d&lt;double&gt;</a>&amp; pm,
<a name="l00692"></a>00692                                      <span class="keyword">const</span> <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__point__3d.html">vgl_point_3d&lt;double&gt;</a>&amp; p1,
<a name="l00693"></a>00693                                      <span class="keyword">const</span> <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__point__3d.html">vgl_point_3d&lt;double&gt;</a>&amp; p2,
<a name="l00694"></a>00694                                      <span class="keywordtype">double</span> vm, <span class="keywordtype">double</span> v1, <span class="keywordtype">double</span> v2,
<a name="l00695"></a>00695                                      <span class="keywordtype">double</span> eps)
<a name="l00696"></a>00696 {
<a name="l00697"></a>00697   <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__point__3d.html">vgl_point_3d&lt;double&gt;</a> pp(p1), pn(p2);
<a name="l00698"></a>00698   <span class="keywordtype">double</span> <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/vgl__homg__line__2d_8txx.html#ad49b25478287e1337feef22ecbeed231">vp</a>(v1), vn(v2);
<a name="l00699"></a>00699   <span class="keywordflow">if</span> ((pp-x).<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/vgl__vector__2d_8h.html#a31c7db8164e71d411a1a821525102dc3">length</a>() &gt; (pn-x).<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/vgl__vector__2d_8h.html#a31c7db8164e71d411a1a821525102dc3">length</a>()) {
<a name="l00700"></a>00700     <span class="comment">// swap so that pp is closest to x</span>
<a name="l00701"></a>00701     pp = p2; pn = p1;
<a name="l00702"></a>00702     <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/vgl__homg__line__2d_8txx.html#ad49b25478287e1337feef22ecbeed231">vp</a> = v2; vn = v1;
<a name="l00703"></a>00703   }
<a name="l00704"></a>00704 
<a name="l00705"></a>00705   <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__3d.html">vgl_vector_3d&lt;double&gt;</a> d1(pp-pm);
<a name="l00706"></a>00706   <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__3d.html">vgl_vector_3d&lt;double&gt;</a> d2(pn-pm);
<a name="l00707"></a>00707   <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__3d.html">vgl_vector_3d&lt;double&gt;</a> d3(pm-x);
<a name="l00708"></a>00708 
<a name="l00709"></a>00709   <span class="keywordtype">double</span> t1 = d1.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__3d.html#a9415896a1013a2c7bf6ebda3048cad1e">sqr_length</a>();
<a name="l00710"></a>00710   <span class="keywordtype">double</span> t2 = <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/vgl__vector__2d_8h.html#af8601d1894aed553c33ab9d9a2c5af48">dot_product</a>(d1,d2);
<a name="l00711"></a>00711   <span class="keywordtype">double</span> t3 = <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/vgl__vector__2d_8h.html#af8601d1894aed553c33ab9d9a2c5af48">dot_product</a>(d1,d3);
<a name="l00712"></a>00712   <span class="keywordtype">double</span> t4 = d2.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__3d.html#a9415896a1013a2c7bf6ebda3048cad1e">sqr_length</a>();
<a name="l00713"></a>00713   <span class="keywordtype">double</span> t5 = <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/vgl__vector__2d_8h.html#af8601d1894aed553c33ab9d9a2c5af48">dot_product</a>(d2,d3) * 2;
<a name="l00714"></a>00714   <span class="keywordtype">double</span> t6 = d3.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__3d.html#a9415896a1013a2c7bf6ebda3048cad1e">sqr_length</a>() + eps;
<a name="l00715"></a>00715 
<a name="l00716"></a>00716   <span class="comment">// compute height (divided by 2*sqrt(t1))</span>
<a name="l00717"></a>00717   <span class="comment">// early exit if triangle flat</span>
<a name="l00718"></a>00718   <span class="keywordtype">double</span> height = t4/t1 - t2*t2/(t1*t1);
<a name="l00719"></a>00719   <span class="keywordflow">if</span> (!(height &gt; 0.0))
<a name="l00720"></a>00720     <span class="keywordflow">return</span> <a class="code" href="structimesh__imls__surface_1_1integral__data.html" title="a data structure to hold the integral terms.">integral_data</a>();
<a name="l00721"></a>00721   height = vcl_sqrt(height)/2.0;
<a name="l00722"></a>00722 
<a name="l00723"></a>00723   <span class="keywordtype">double</span> vt1 = vn-vm;
<a name="l00724"></a>00724   <span class="keywordtype">double</span> vt2 = <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/vgl__homg__line__2d_8txx.html#ad49b25478287e1337feef22ecbeed231">vp</a>-vm;
<a name="l00725"></a>00725 
<a name="l00726"></a>00726   <span class="keywordtype">double</span> alpha = 2.0/3.0;
<a name="l00727"></a>00727   <a class="code" href="structimesh__imls__surface_1_1integral__data.html" title="a data structure to hold the integral terms.">integral_data</a> i_data, last_i_data;
<a name="l00728"></a>00728   <span class="keywordtype">double</span> weight = (1.0/alpha-alpha);
<a name="l00729"></a>00729   <span class="keywordtype">double</span> I1,Ix,dI1,dIx,dIx2,u_1,denom,k1,k2;
<a name="l00730"></a>00730   <span class="keywordtype">double</span> u = alpha;
<a name="l00731"></a>00731   <span class="comment">// integrate using the trapezoid rule with non-uniform sampling</span>
<a name="l00732"></a>00732   <span class="keyword">const</span> <span class="keywordtype">double</span> lower_bound = 0.01;<span class="comment">//((t6&lt;t4)?(t6/t4):1.0) * 0.01;</span>
<a name="l00733"></a>00733   <span class="keywordflow">for</span> (; u&gt;lower_bound; u*=alpha) {
<a name="l00734"></a>00734     i_data += last_i_data;
<a name="l00735"></a>00735     u_1 = 1.0-u;
<a name="l00736"></a>00736     denom = 1.0/(u_1*u_1*t1);
<a name="l00737"></a>00737     k1 = (t3 + u*t2)*u_1*denom;
<a name="l00738"></a>00738     k2 = (t6 + u*t5 + u*u*t4)*denom - k1*k1;
<a name="l00739"></a>00739     <a class="code" href="classimesh__imls__surface.html#a2119bcff24366ff1c0d76df0514b4d42" title="integrals of f(x)dx and x*f(x)dx over [0,1] where f(x)= 1/((x+k1)^2 + k2)^2.">line_integrals</a>(k1,k2,I1,Ix,dI1,dIx,dIx2);
<a name="l00740"></a>00740     <span class="keywordtype">double</span> phi_c = vm+u*vt1;
<a name="l00741"></a>00741     <span class="keywordtype">double</span> phi_x = u_1*vt2;
<a name="l00742"></a>00742     last_i_data.<a class="code" href="structimesh__imls__surface_1_1integral__data.html#a54edb3c7132c659116d127e484b1d1a5">I</a> = I1;
<a name="l00743"></a>00743     last_i_data.<a class="code" href="structimesh__imls__surface_1_1integral__data.html#a042aa1297b6631072099b008df303b78">I_phi</a> = (phi_c*I1 + phi_x*Ix);
<a name="l00744"></a>00744 
<a name="l00745"></a>00745     <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__3d.html">vgl_vector_3d&lt;double&gt;</a> d_c(d3+u*d2), d_x(d1*u_1);
<a name="l00746"></a>00746     last_i_data.<a class="code" href="structimesh__imls__surface_1_1integral__data.html#aabbbf30e111454e980bf5be09b4d9550">dI</a> = (d_c*dI1 + d_x*dIx)*denom;
<a name="l00747"></a>00747     last_i_data.<a class="code" href="structimesh__imls__surface_1_1integral__data.html#a4b84fae65bb359687326e6367bdde275">dI_phi</a> = ( d_c*(phi_c*dI1 + phi_x*dIx)
<a name="l00748"></a>00748                          + d_x*(phi_c*dIx + phi_x*dIx2) ) * denom;
<a name="l00749"></a>00749 
<a name="l00750"></a>00750     denom *= u / u_1;
<a name="l00751"></a>00751     last_i_data *= denom;
<a name="l00752"></a>00752   }
<a name="l00753"></a>00753   i_data *= weight;
<a name="l00754"></a>00754   last_i_data *= 1.0/alpha;
<a name="l00755"></a>00755   i_data += last_i_data;
<a name="l00756"></a>00756 
<a name="l00757"></a>00757 
<a name="l00758"></a>00758   <span class="comment">// add the last trapezoid covering the remaining area</span>
<a name="l00759"></a>00759   denom = 1.0/t1;
<a name="l00760"></a>00760   k1 = t3*denom;
<a name="l00761"></a>00761   k2 = t6*denom - k1*k1;
<a name="l00762"></a>00762   <a class="code" href="classimesh__imls__surface.html#a2119bcff24366ff1c0d76df0514b4d42" title="integrals of f(x)dx and x*f(x)dx over [0,1] where f(x)= 1/((x+k1)^2 + k2)^2.">line_integrals</a>(k1,k2,I1,Ix,dI1,dIx,dIx2);
<a name="l00763"></a>00763   denom *= u/alpha;
<a name="l00764"></a>00764 
<a name="l00765"></a>00765   i_data.<a class="code" href="structimesh__imls__surface_1_1integral__data.html#a54edb3c7132c659116d127e484b1d1a5">I</a> += I1 * denom;
<a name="l00766"></a>00766   i_data.<a class="code" href="structimesh__imls__surface_1_1integral__data.html#a042aa1297b6631072099b008df303b78">I_phi</a> += (vm*I1 + vt2*Ix) * denom;
<a name="l00767"></a>00767   denom /= t1;
<a name="l00768"></a>00768   i_data.<a class="code" href="structimesh__imls__surface_1_1integral__data.html#aabbbf30e111454e980bf5be09b4d9550">dI</a> += (d3*dI1 + d1*dIx)*denom;
<a name="l00769"></a>00769   i_data.<a class="code" href="structimesh__imls__surface_1_1integral__data.html#a4b84fae65bb359687326e6367bdde275">dI_phi</a> += ( d3*(vm*dI1 + vt2*dIx)
<a name="l00770"></a>00770                    + d1*(vm*dIx + vt2*dIx2) ) * denom;
<a name="l00771"></a>00771 
<a name="l00772"></a>00772   i_data *= height;
<a name="l00773"></a>00773   i_data.<a class="code" href="structimesh__imls__surface_1_1integral__data.html#aabbbf30e111454e980bf5be09b4d9550">dI</a> *= 4.0;
<a name="l00774"></a>00774   i_data.<a class="code" href="structimesh__imls__surface_1_1integral__data.html#a4b84fae65bb359687326e6367bdde275">dI_phi</a> *= 4.0;
<a name="l00775"></a>00775 
<a name="l00776"></a>00776   <span class="keywordflow">return</span> i_data;
<a name="l00777"></a>00777 }
<a name="l00778"></a>00778 
<a name="l00779"></a>00779 
<a name="l00780"></a>00780 <span class="comment">//=============================================================================</span>
<a name="l00781"></a>00781 <span class="comment">// External functions</span>
<a name="l00782"></a>00782 
<a name="l00783"></a>00783 <span class="comment">//: find the zero crossing point by bisection between positive point \a pp and negative point \a pn</span>
<a name="l00784"></a>00784 <span class="comment">//  Stops searching when $||pp-pn|| &lt; xeps$ or $|f(pm)| &lt; feps$</span>
<a name="l00785"></a><a class="code" href="imesh__imls__surface_8h.html#a57276e630cb4f2e7ff672eaabb1bbbc4">00785</a> <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__point__3d.html">vgl_point_3d&lt;double&gt;</a> <a class="code" href="imesh__imls__surface_8cxx.html#a7e800e3b82fb7acae04101f30e5bc004" title="find the zero crossing point by bisection between positive point pp and negative point pn...">bisect</a>(<span class="keyword">const</span> <a class="code" href="classimesh__imls__surface.html">imesh_imls_surface</a>&amp; f,
<a name="l00786"></a>00786                             <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__point__3d.html">vgl_point_3d&lt;double&gt;</a> pp,
<a name="l00787"></a>00787                             <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__point__3d.html">vgl_point_3d&lt;double&gt;</a> pn,
<a name="l00788"></a>00788                             <span class="keywordtype">double</span> feps, <span class="keywordtype">double</span> xeps)
<a name="l00789"></a>00789 {
<a name="l00790"></a>00790   assert(f(pp) &gt; 0.0);
<a name="l00791"></a>00791   assert(f(pn) &lt; 0.0);
<a name="l00792"></a>00792   <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__point__3d.html">vgl_point_3d&lt;double&gt;</a> pm=<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/vgl__homg__point__1d_8h.html#adee43f992edd6c4c8e46fde8cf9a7576">centre</a>(pp,pn);
<a name="l00793"></a>00793   <span class="keyword">const</span> <span class="keywordtype">unsigned</span> num_itr =
<a name="l00794"></a>00794       <span class="keyword">static_cast&lt;</span><span class="keywordtype">unsigned</span><span class="keyword">&gt;</span>(vcl_ceil(vcl_log((pp-pn).<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/vgl__vector__2d_8h.html#a31c7db8164e71d411a1a821525102dc3">length</a>()
<a name="l00795"></a>00795                                               / xeps)
<a name="l00796"></a>00796                                      / 0.301029995663981)); <span class="comment">// log_2</span>
<a name="l00797"></a>00797   <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__3d.html">vgl_vector_3d&lt;double&gt;</a> dp;
<a name="l00798"></a>00798   <span class="keywordtype">double</span> val = f.<a class="code" href="classimesh__imls__surface.html#ad914e6b71476a610be9df7164ec50b2b" title="evaluate the function and its derivative (returned by reference).">deriv</a>(pm,dp);
<a name="l00799"></a>00799   val /= dp.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__3d.html#aed39c2835939944b8e12a21479ac6880">length</a>();
<a name="l00800"></a>00800   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i=0; i&lt;num_itr; ++i) {
<a name="l00801"></a>00801     <span class="keywordflow">if</span> (vcl_abs(val) &lt; feps)
<a name="l00802"></a>00802       <span class="keywordflow">return</span> pm;
<a name="l00803"></a>00803     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (val &gt; 0.0)
<a name="l00804"></a>00804       pp = pm;
<a name="l00805"></a>00805     <span class="keywordflow">else</span>
<a name="l00806"></a>00806       pn = pm;
<a name="l00807"></a>00807     pm=<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/vgl__homg__point__1d_8h.html#adee43f992edd6c4c8e46fde8cf9a7576">centre</a>(pp,pn);
<a name="l00808"></a>00808     val = f.<a class="code" href="classimesh__imls__surface.html#ad914e6b71476a610be9df7164ec50b2b" title="evaluate the function and its derivative (returned by reference).">deriv</a>(pm,dp);
<a name="l00809"></a>00809     val /= dp.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__3d.html#aed39c2835939944b8e12a21479ac6880">length</a>();
<a name="l00810"></a>00810   }
<a name="l00811"></a>00811   <span class="keywordflow">return</span> pm;
<a name="l00812"></a>00812 }
<a name="l00813"></a>00813 
<a name="l00814"></a>00814 
<a name="l00815"></a>00815 <span class="comment">//: Move the point \a p along the gradient direction until reaching a zero crossing of \a f (within \a eps).</span>
<a name="l00816"></a>00816 <span class="comment">//  Return true if successful</span>
<a name="l00817"></a><a class="code" href="imesh__imls__surface_8h.html#abfd53ac4ea48884b92cc9ecb80ad867a">00817</a> <span class="keywordtype">bool</span> <a class="code" href="imesh__imls__surface_8cxx.html#aa7dea681abf66d5f23f31949a2beb2b7" title="Move the point p along the gradient direction until reaching a zero crossing of f (within eps)...">snap_to_surface</a>(<span class="keyword">const</span> <a class="code" href="classimesh__imls__surface.html">imesh_imls_surface</a>&amp; f,
<a name="l00818"></a>00818                      <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__point__3d.html">vgl_point_3d&lt;double&gt;</a>&amp; p,
<a name="l00819"></a>00819                      <span class="keywordtype">double</span> step, <span class="keywordtype">double</span> eps)
<a name="l00820"></a>00820 {
<a name="l00821"></a>00821   <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__point__3d.html">vgl_point_3d&lt;double&gt;</a> p1(p);
<a name="l00822"></a>00822   <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__3d.html">vgl_vector_3d&lt;double&gt;</a> dp;
<a name="l00823"></a>00823   <span class="keywordtype">double</span> val1 = f.<a class="code" href="classimesh__imls__surface.html#ad914e6b71476a610be9df7164ec50b2b" title="evaluate the function and its derivative (returned by reference).">deriv</a>(p1,dp);
<a name="l00824"></a>00824   <span class="keywordtype">double</span> dl = dp.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__3d.html#aed39c2835939944b8e12a21479ac6880">length</a>();
<a name="l00825"></a>00825   val1 /= dl;
<a name="l00826"></a>00826   <span class="keywordflow">if</span> (vcl_abs(val1) &lt; eps)
<a name="l00827"></a>00827     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00828"></a>00828 
<a name="l00829"></a>00829   <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__point__3d.html">vgl_point_3d&lt;double&gt;</a> p2 = p1 - (step*val1/dl)*dp;
<a name="l00830"></a>00830   dl = dp.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__3d.html#aed39c2835939944b8e12a21479ac6880">length</a>();
<a name="l00831"></a>00831   <span class="keywordtype">double</span> val2 = f.<a class="code" href="classimesh__imls__surface.html#ad914e6b71476a610be9df7164ec50b2b" title="evaluate the function and its derivative (returned by reference).">deriv</a>(p2,dp);
<a name="l00832"></a>00832   val2 /= dl;
<a name="l00833"></a>00833   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i=0;
<a name="l00834"></a>00834   <span class="keywordflow">for</span> (; i&lt;100 &amp;&amp; val1*val2 &gt; 0.0; ++i) {
<a name="l00835"></a>00835     p1 = p2;
<a name="l00836"></a>00836     val1 = val2;
<a name="l00837"></a>00837     p2 -= (step*val2/dl)*dp;
<a name="l00838"></a>00838     val2 = f.<a class="code" href="classimesh__imls__surface.html#ad914e6b71476a610be9df7164ec50b2b" title="evaluate the function and its derivative (returned by reference).">deriv</a>(p2,dp);
<a name="l00839"></a>00839     dl = dp.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__3d.html#aed39c2835939944b8e12a21479ac6880">length</a>();
<a name="l00840"></a>00840     val2 /= dl;
<a name="l00841"></a>00841     <span class="keywordflow">if</span> (vcl_abs(val2) &lt; eps) {
<a name="l00842"></a>00842       p = p2;
<a name="l00843"></a>00843       <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00844"></a>00844     }
<a name="l00845"></a>00845   }
<a name="l00846"></a>00846   <span class="keywordflow">if</span> (i &gt;= 100)
<a name="l00847"></a>00847     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00848"></a>00848 
<a name="l00849"></a>00849   <span class="keywordflow">if</span> (val1 &gt; 0.0)
<a name="l00850"></a>00850     p = <a class="code" href="imesh__imls__surface_8cxx.html#a7e800e3b82fb7acae04101f30e5bc004" title="find the zero crossing point by bisection between positive point pp and negative point pn...">bisect</a>(f,p1,p2,eps);
<a name="l00851"></a>00851   <span class="keywordflow">else</span>
<a name="l00852"></a>00852     p = <a class="code" href="imesh__imls__surface_8cxx.html#a7e800e3b82fb7acae04101f30e5bc004" title="find the zero crossing point by bisection between positive point pp and negative point pn...">bisect</a>(f,p2,p1,eps);
<a name="l00853"></a>00853 
<a name="l00854"></a>00854 
<a name="l00855"></a>00855   <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00856"></a>00856 }
<a name="l00857"></a>00857 
<a name="l00858"></a>00858 
<a name="l00859"></a>00859 <span class="keyword">namespace</span>{
<a name="l00860"></a>00860 <span class="keywordtype">double</span> func(<span class="keyword">const</span> <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__3d.html">vgl_vector_3d&lt;double&gt;</a>&amp; n,
<a name="l00861"></a>00861             <span class="keywordtype">double</span> v,
<a name="l00862"></a>00862             <span class="keyword">const</span> <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__3d.html">vgl_vector_3d&lt;double&gt;</a>&amp; dp)
<a name="l00863"></a>00863 {
<a name="l00864"></a>00864   v *= v;
<a name="l00865"></a>00865   v /= dp.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__3d.html#a9415896a1013a2c7bf6ebda3048cad1e">sqr_length</a>();
<a name="l00866"></a>00866   <span class="keywordtype">double</span> tmp = <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/vgl__vector__2d_8h.html#af8601d1894aed553c33ab9d9a2c5af48">dot_product</a>(n,dp)/dp.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__3d.html#aed39c2835939944b8e12a21479ac6880">length</a>() - 1.0;
<a name="l00867"></a>00867   <span class="keywordflow">return</span> v + tmp*tmp;
<a name="l00868"></a>00868 }
<a name="l00869"></a>00869 
<a name="l00870"></a>00870 <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__3d.html">vgl_vector_3d&lt;double&gt;</a> dfunc(<span class="keyword">const</span> <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__3d.html">vgl_vector_3d&lt;double&gt;</a>&amp; n,
<a name="l00871"></a>00871                             <span class="keywordtype">double</span> v,
<a name="l00872"></a>00872                             <span class="keyword">const</span> <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__3d.html">vgl_vector_3d&lt;double&gt;</a>&amp; dp,
<a name="l00873"></a>00873                             <span class="keyword">const</span> vnl_double_3x3&amp; ddp)
<a name="l00874"></a>00874 {
<a name="l00875"></a>00875   vnl_double_3 nn(n.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__3d.html#a912b0263c344513af0ffa0c07415fe20">x</a>(),n.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__3d.html#af31e8106e9f1aa85bdc70bc40a73dff6">y</a>(),n.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__3d.html#aa655643683e63092c938ea6f2b4459e0">z</a>());
<a name="l00876"></a>00876   vnl_double_3 ndp(dp.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__3d.html#a912b0263c344513af0ffa0c07415fe20">x</a>(), dp.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__3d.html#af31e8106e9f1aa85bdc70bc40a73dff6">y</a>(), dp.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__3d.html#aa655643683e63092c938ea6f2b4459e0">z</a>());
<a name="l00877"></a>00877   <span class="keywordtype">double</span> sqr_len = dp.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__3d.html#a9415896a1013a2c7bf6ebda3048cad1e">sqr_length</a>();
<a name="l00878"></a>00878   <span class="keywordtype">double</span> len = vcl_sqrt(sqr_len);
<a name="l00879"></a>00879   <span class="keywordtype">double</span> n_dot_dp = <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/vgl__vector__2d_8h.html#af8601d1894aed553c33ab9d9a2c5af48">dot_product</a>(nn,ndp);
<a name="l00880"></a>00880   vnl_double_3 df = (2*v/sqr_len)*ndp;
<a name="l00881"></a>00881   df += ddp.transpose() * ( ((-2*v*v/(sqr_len*sqr_len))*ndp) +
<a name="l00882"></a>00882                             (2/len*(n_dot_dp/len - 1)*(nn - (n_dot_dp/sqr_len)*ndp)) );
<a name="l00883"></a>00883   <span class="keywordflow">return</span> <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__3d.html">vgl_vector_3d&lt;double&gt;</a>(df[0],df[1],df[2]);
<a name="l00884"></a>00884 }
<a name="l00885"></a>00885 <span class="comment">// end of namespace</span>
<a name="l00886"></a>00886 }
<a name="l00887"></a>00887 
<a name="l00888"></a>00888 <span class="comment">//: Move the point \a p to minimize $(f^2 + (n*f&#39; - 1)^2)/f&#39;*f&#39;$ a zero crossing of \a f (within \a eps).</span>
<a name="l00889"></a>00889 <span class="comment">//  Return true if successful</span>
<a name="l00890"></a><a class="code" href="imesh__imls__surface_8h.html#a885e522da0c6568459591eab06b4c731">00890</a> <span class="keywordtype">bool</span> <a class="code" href="imesh__imls__surface_8cxx.html#aed563c1049cebece38be50784d6e6b3c" title="Move the point p to minimize $(f^2 + (n*f&#39; - 1)^2)/f&#39;*f&#39;$ a zero crossing of f (within eps)...">snap_to_surface_with_normal</a>(<span class="keyword">const</span> <a class="code" href="classimesh__imls__surface.html">imesh_imls_surface</a>&amp; f,
<a name="l00891"></a>00891                                  <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__point__3d.html">vgl_point_3d&lt;double&gt;</a>&amp; p,
<a name="l00892"></a>00892                                  <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__3d.html">vgl_vector_3d&lt;double&gt;</a> n,
<a name="l00893"></a>00893                                  <span class="keywordtype">double</span> step, <span class="keywordtype">double</span> eps)
<a name="l00894"></a>00894 {
<a name="l00895"></a>00895   <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__point__3d.html">vgl_point_3d&lt;double&gt;</a> p1(p);
<a name="l00896"></a>00896   <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/vgl__vector__2d_8h.html#ac4986a4b72b1d54b872d5863ac35d3e8">normalize</a>(n);
<a name="l00897"></a>00897   <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__3d.html">vgl_vector_3d&lt;double&gt;</a> dp;
<a name="l00898"></a>00898   vnl_double_3x3 ddp;
<a name="l00899"></a>00899   <span class="keywordtype">double</span> val = f.<a class="code" href="classimesh__imls__surface.html#a280d114d72e3436140583d824c4ebdf4" title="evaluate the function and its first and second derivatives (returned by reference).">deriv2</a>(p1, dp, ddp);
<a name="l00900"></a>00900   <span class="keywordtype">double</span> f1 = func(n,val,dp);
<a name="l00901"></a>00901   <span class="keywordflow">if</span> (f1 &lt; eps)
<a name="l00902"></a>00902     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00903"></a>00903 
<a name="l00904"></a>00904   <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__3d.html">vgl_vector_3d&lt;double&gt;</a> df = dfunc(n,val,dp,ddp);
<a name="l00905"></a>00905   <span class="keywordtype">double</span> dl = df.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__3d.html#a9415896a1013a2c7bf6ebda3048cad1e">sqr_length</a>();
<a name="l00906"></a>00906   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i;
<a name="l00907"></a>00907   <span class="keywordflow">for</span> (i=0; i&lt;1000; ++i) {
<a name="l00908"></a>00908     <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__point__3d.html">vgl_point_3d&lt;double&gt;</a> p2 = p1 - (step*f1/dl)*df;
<a name="l00909"></a>00909     val = f.<a class="code" href="classimesh__imls__surface.html#a280d114d72e3436140583d824c4ebdf4" title="evaluate the function and its first and second derivatives (returned by reference).">deriv2</a>(p2,dp,ddp);
<a name="l00910"></a>00910     <span class="keywordtype">double</span> f2 = func(n,val,dp);
<a name="l00911"></a>00911     <span class="comment">//vcl_cout &lt;&lt; i&lt;&lt;&quot; f: &quot;&lt;&lt;f2&lt;&lt;&quot; step: &quot;&lt;&lt; step&lt;&lt;vcl_endl;</span>
<a name="l00912"></a>00912     <span class="keywordflow">if</span> ( f2 &gt; f1) {
<a name="l00913"></a>00913       step /= 2;
<a name="l00914"></a>00914       <span class="keywordflow">continue</span>;
<a name="l00915"></a>00915     }
<a name="l00916"></a>00916     <span class="keywordflow">if</span> (f2 &lt; eps || step &lt; eps) {
<a name="l00917"></a>00917       p = p2;
<a name="l00918"></a>00918       <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00919"></a>00919     }
<a name="l00920"></a>00920     f1 = f2;
<a name="l00921"></a>00921     p1 = p2;
<a name="l00922"></a>00922     df = dfunc(n,val,dp,ddp);
<a name="l00923"></a>00923     dl = df.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__3d.html#a9415896a1013a2c7bf6ebda3048cad1e">sqr_length</a>();
<a name="l00924"></a>00924     step *= 2;
<a name="l00925"></a>00925   }
<a name="l00926"></a>00926   <span class="keywordflow">if</span> (i &gt;= 100)
<a name="l00927"></a>00927     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00928"></a>00928 
<a name="l00929"></a>00929   p = p1;
<a name="l00930"></a>00930   <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00931"></a>00931 }
<a name="l00932"></a>00932 
<a name="l00933"></a>00933 
<a name="l00934"></a>00934 <span class="comment">//: Move the point \a p along direction \a dir until reaching a zero crossing of \a f (within \a eps).</span>
<a name="l00935"></a>00935 <span class="comment">//  Return true if successful</span>
<a name="l00936"></a><a class="code" href="imesh__imls__surface_8h.html#a5c2b460d5d75b21664dba5f2a8192cde">00936</a> <span class="keywordtype">bool</span> <a class="code" href="imesh__imls__surface_8cxx.html#aa7dea681abf66d5f23f31949a2beb2b7" title="Move the point p along the gradient direction until reaching a zero crossing of f (within eps)...">snap_to_surface</a>(<span class="keyword">const</span> <a class="code" href="classimesh__imls__surface.html">imesh_imls_surface</a>&amp; f,
<a name="l00937"></a>00937                      <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__3d.html">vgl_vector_3d&lt;double&gt;</a> dir,
<a name="l00938"></a>00938                      <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__point__3d.html">vgl_point_3d&lt;double&gt;</a>&amp; p,
<a name="l00939"></a>00939                      <span class="keywordtype">double</span> step, <span class="keywordtype">double</span> eps)
<a name="l00940"></a>00940 {
<a name="l00941"></a>00941   <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__point__3d.html">vgl_point_3d&lt;double&gt;</a> p1(p);
<a name="l00942"></a>00942   <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/vgl__vector__2d_8h.html#ac4986a4b72b1d54b872d5863ac35d3e8">normalize</a>(dir);
<a name="l00943"></a>00943   <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__3d.html">vgl_vector_3d&lt;double&gt;</a> dp;
<a name="l00944"></a>00944   <span class="keywordtype">double</span> val1 = f.<a class="code" href="classimesh__imls__surface.html#ad914e6b71476a610be9df7164ec50b2b" title="evaluate the function and its derivative (returned by reference).">deriv</a>(p1,dp);
<a name="l00945"></a>00945   dp = dir * <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/vgl__vector__2d_8h.html#af8601d1894aed553c33ab9d9a2c5af48">dot_product</a>(dp,dir);
<a name="l00946"></a>00946   <span class="keywordtype">double</span> dl = dp.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__3d.html#aed39c2835939944b8e12a21479ac6880">length</a>();
<a name="l00947"></a>00947   val1 /= dl;
<a name="l00948"></a>00948   <span class="keywordflow">if</span> (vcl_abs(val1) &lt; eps)
<a name="l00949"></a>00949     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00950"></a>00950 
<a name="l00951"></a>00951   <a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__point__3d.html">vgl_point_3d&lt;double&gt;</a> p2 = p1 - (step*val1/dl)*dp;
<a name="l00952"></a>00952   dl = dp.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__3d.html#aed39c2835939944b8e12a21479ac6880">length</a>();
<a name="l00953"></a>00953   <span class="keywordtype">double</span> val2 = f.<a class="code" href="classimesh__imls__surface.html#ad914e6b71476a610be9df7164ec50b2b" title="evaluate the function and its derivative (returned by reference).">deriv</a>(p2,dp);
<a name="l00954"></a>00954   val2 /= dl;
<a name="l00955"></a>00955   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i=0;
<a name="l00956"></a>00956   <span class="keywordflow">for</span> (; i&lt;100 &amp;&amp; val1*val2 &gt; 0.0; ++i) {
<a name="l00957"></a>00957     p1 = p2;
<a name="l00958"></a>00958     val1 = val2;
<a name="l00959"></a>00959     p2 -= (step*val2/dl)*dp;
<a name="l00960"></a>00960     val2 = f.<a class="code" href="classimesh__imls__surface.html#ad914e6b71476a610be9df7164ec50b2b" title="evaluate the function and its derivative (returned by reference).">deriv</a>(p2,dp);
<a name="l00961"></a>00961     dp = dir * dot_product(dp,dir);
<a name="l00962"></a>00962     dl = dp.<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__3d.html#aed39c2835939944b8e12a21479ac6880">length</a>();
<a name="l00963"></a>00963     val2 /= dl;
<a name="l00964"></a>00964     <span class="keywordflow">if</span> (vcl_abs(val2) &lt; eps) {
<a name="l00965"></a>00965       p = p2;
<a name="l00966"></a>00966       <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00967"></a>00967     }
<a name="l00968"></a>00968   }
<a name="l00969"></a>00969   <span class="keywordflow">if</span> (i &gt;= 100)
<a name="l00970"></a>00970     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00971"></a>00971 
<a name="l00972"></a>00972   <span class="keywordflow">if</span> (val1 &gt; 0.0)
<a name="l00973"></a>00973     p = <a class="code" href="imesh__imls__surface_8cxx.html#a7e800e3b82fb7acae04101f30e5bc004" title="find the zero crossing point by bisection between positive point pp and negative point pn...">bisect</a>(f,p1,p2,eps);
<a name="l00974"></a>00974   <span class="keywordflow">else</span>
<a name="l00975"></a>00975     p = <a class="code" href="imesh__imls__surface_8cxx.html#a7e800e3b82fb7acae04101f30e5bc004" title="find the zero crossing point by bisection between positive point pp and negative point pn...">bisect</a>(f,p2,p1,eps);
<a name="l00976"></a>00976 
<a name="l00977"></a>00977 
<a name="l00978"></a>00978   <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00979"></a>00979 }
<a name="l00980"></a>00980 
<a name="l00981"></a>00981 <span class="comment">// Explicit instantiation needed in the implementations in this file:</span>
<a name="l00982"></a>00982 <span class="preprocessor">#include &lt;<a class="code" href="imesh__imls__surface_8txx.html">imesh/algo/imesh_imls_surface.txx</a>&gt;</span>
<a name="l00983"></a>00983 <a class="code" href="imesh__imls__surface_8txx.html#a0b8972c3900d652da44c5470ac5f95ca">IMESH_IMLS_SURFACE_INSTANTATE</a>(<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__vector__2d.html">vgl_vector_2d&lt;double&gt;</a>,<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__point__3d.html">vgl_point_3d&lt;double&gt;</a>);
<a name="l00984"></a>00984 <a class="code" href="imesh__imls__surface_8txx.html#a0b8972c3900d652da44c5470ac5f95ca">IMESH_IMLS_SURFACE_INSTANTATE</a>(<a class="code" href="structimesh__imls__surface_1_1integral__data.html" title="a data structure to hold the integral terms.">imesh_imls_surface::integral_data</a>,<a class="codeRef" doxygen="core_vgl.tag:../../../../../core/vgl/html" href="../../../../../core/vgl/html/classvgl__point__3d.html">vgl_point_3d&lt;double&gt;</a>);
</pre></div></div>
</div>


<hr class="footer"/><address class="footer"><small>
Generated on Thu May 2 2013 08:52:54 for contrib/brl/bbas/imesh by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.7.5.1
</small></address>

</body>
</html>
