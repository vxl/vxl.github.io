<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html401/loose.dtd">
<html>
<!-- Created on May, 1 2013 by texi2html 1.76 -->
<!--
Written by: Lionel Cons <Lionel.Cons@cern.ch> (original author)
            Karl Berry  <karl@freefriends.org>
            Olaf Bachmann <obachman@mathematik.uni-kl.de>
            and many others.
Maintained by: Many creative people <dev@texi2html.cvshome.org>
Send bugs and suggestions to <users@texi2html.cvshome.org>

-->
<head>
<title>BOXM2: 2. Boxm2 Data Structures</title>

<meta name="description" content="BOXM2: 2. Boxm2 Data Structures">
<meta name="keywords" content="BOXM2: 2. Boxm2 Data Structures">
<meta name="resource-type" content="document">
<meta name="distribution" content="global">
<meta name="Generator" content="texi2html 1.76">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<style type="text/css">
<!--
a.summary-letter {text-decoration: none}
pre.display {font-family: serif}
pre.format {font-family: serif}
pre.menu-comment {font-family: serif}
pre.menu-preformatted {font-family: serif}
pre.smalldisplay {font-family: serif; font-size: smaller}
pre.smallexample {font-size: smaller}
pre.smallformat {font-family: serif; font-size: smaller}
pre.smalllisp {font-size: smaller}
span.sansserif {font-family:sans-serif; font-weight:normal;}
ul.toc {list-style: none}
-->
</style>


</head>

<body lang="en" bgcolor="#FFFFFF" text="#000000" link="#0000FF" vlink="#800080" alink="#FF0000">

<a name="data"></a>
<a name="SEC7"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="book_1.html#SEC6" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#SEC8" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="book_1.html#SEC1" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="book.html#Top" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="book_3.html#SEC13" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="book.html#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[Contents]</td>
<td valign="middle" align="left">[Index]</td>
<td valign="middle" align="left">[<a href="book_abt.html#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<h1 class="chapter"> 2. Boxm2 Data Structures </h1>



<blockquote><p><strong>Chapter summary</strong>:<br>
Data structures used by the Boxm2 library
</p></blockquote>


<hr size="6">
<a name="SEC8"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#SEC7" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#SEC9" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#SEC7" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#SEC7" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="book_3.html#SEC13" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="book.html#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[Contents]</td>
<td valign="middle" align="left">[Index]</td>
<td valign="middle" align="left">[<a href="book_abt.html#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<h2 class="section"> 2.1 Boxm2 Scene data structures </h2>
<p>The data structures used in boxm2 are optimized to be used both by a CPU and GPU.  
A scene is composed of <code>blocks</code>, which are specified in the <code>scene.xml</code> file.  
Each <code>block</code> is a fixed grid of octrees, also referred to as <code>sub_blocks</code> in 
the code.  The dimension of a <code>sub_block</code> and the number of <code>sub_blocks</code> in 
each block are specified in the <code>scene.xml</code> file.  
</p>
<p>The voxel structure of each block is encoded in its own file which is located in the
directory specified by the <code>scene.xml</code> file.  Each block has a unique 
<code>boxm2_block_id</code>, which consists of three integers.  This block id 
is how blocks and their corresponding data are identified on disk.  
</p>

<hr size="6">
<a name="SEC9"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#SEC8" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#SEC10" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#SEC7" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#SEC8" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="book_3.html#SEC13" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="book.html#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[Contents]</td>
<td valign="middle" align="left">[Index]</td>
<td valign="middle" align="left">[<a href="book_abt.html#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<h3 class="subsection"> 2.1.1 Boxm2 Block: octree based voxel structure </h3>

<p>A <code>boxm2_block</code> contains the following buffers: 
</p><ul class="toc">
<li> <code>boxm2_array_3d&lt;uchar16&gt; trees_</code> : a three-d buffer of bit-encoded octrees.  It's dimensions are indicated in the <code>scene.xml</code> file. 
</li><li> <code>boxm2_array_2d&lt;int&gt;     tree_ptrs_</code> : a two-d buffer that mirrors the location of corresponding data cells.  
</li><li> <code>boxm2_array_1d&lt;ushort&gt;  trees_in_buffers_</code> : a one-d buffer that indicates how many trees are in each row of <code>tree_ptrs</code> (as they may not be full).  
</li><li> <code>boxm2_array_1d&lt;ushort2&gt; mem_ptrs_</code> : a one-d buffer that indicates where data is stored in each row of data buffers.  
</li></ul>

<hr size="6">
<a name="SEC10"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#SEC9" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#SEC11" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#SEC7" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#SEC8" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="book_3.html#SEC13" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="book.html#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[Contents]</td>
<td valign="middle" align="left">[Index]</td>
<td valign="middle" align="left">[<a href="book_abt.html#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<h3 class="subsection"> 2.1.2 bit_trees </h3>
<p>The voxel structure of a block is encoded in the 3d array <code>trees_</code>, which contains bit-encoded
octrees of maximum depth 4.  A bit is reserved for each potential inner node (73 on 
a depth 4 octree), which indicates whether or not that node has children.  This tree is full, 
meaning all nodes either have zero children or 8 children.  The first 10 bytes (index 0-9) 
are reserved to encode the voxel structure.  Bytes (10,11) and (12,13) encode two 
<code>unsigned shorts</code> that index into any data buffer with the same ID as the block.  
This index points to the data that corresponds with the root node of the tree.  From there, 
a simple counting bits algorithm is performed to find the data of a particular cell, 
specified by it's bit_index.  
</p>
<p>These algorithms are implemented in both OpenCL and C++.  The C++ object 
<code>boct_bit_tree2</code> is our latest implementation of the bit encoded octree.  
It is located in <code>src/contrib/brl/bseg/boct/</code>.  
</p>
<p>The structure of the data buffer is described below.  
</p>
<hr size="6">
<a name="SEC11"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#SEC10" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="#SEC12" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#SEC7" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#SEC8" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="book_3.html#SEC13" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="book.html#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[Contents]</td>
<td valign="middle" align="left">[Index]</td>
<td valign="middle" align="left">[<a href="book_abt.html#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<h3 class="subsection"> 2.1.3 Data structures. </h3>
<p>The <code>boxm2_data&lt;T&gt;</code> object is a wrapper around a <code>boxm2_array_1d&lt;T&gt;</code> buffer.  
The template parameter is a <code>boxm2_data_type</code> as specified in the file 
<code>boxm2_data_traits.h</code>.  Currently, we have the following data types implemented:
</p>
<ul class="toc">
<li> BOXM2_ALPHA : data type is float
</li><li> BOXM2_MOG3_GREY : data type is uchar8 (a typedef of <code>vnl_vector_fixed&lt;unsigned char, 8&gt;</code>)
</li><li> BOXM2_NUM_OBS : data type is ushort4 (a typedef of <code>vnl_vector_fixed&lt;unsigned short, 4&gt;</code>)
</li><li> BOXM2_AUX : data type is int4 (a typedef of <code>vnl_vector_fixed&lt;int, 4&gt;</code>)
</li><li> BOXM2_UNKNOWN : whose data type is undefined
</li></ul>

<p>Each data buffer is split into a two dimensional array, whose size is determined by: 
</p><ul class="toc">
<li> number of buffers: determined by the maximum size of a block, as specified in the <code>scene.xml</code> file
</li><li> number cells in each buffer: currently hardcoded to 65536 (maximum value of an <code>unsigned short</code>). 
</li></ul>
<p>The cell size for each data buffer can be statically called by using 
<code>boxm2_data_traits&lt;DATA_TYPE&gt;::datasize()</code>.  
</p>
<p>For any empty scene, the data corresponding to each tree (for the root node) is randomly
distributed among the buffers.  This is to ensure that trees located at surfaces are 
uniformly distributed, allowing for efficient usage of space and maximum growth.   
</p>
<p>The <code>unsigned short</code> encoded in bytes (12,13) of a tree indicate which buffer
its data is in.  The <code>unsigned short</code> encoded in bytes (10,11) indicate the 
offset within the buffer that points to the root node's data.  The tree's data is 
then stored in breadth first search order within the data buffer.  Given the location 
of the tree cell (bit index in [0,585] for a depth 4 tree), and the location of 
its root data, it is a simple bit counting algorithm to find the specified cell's
data.  This algorithm runs in log time on the index of the tree, and is further
accelerated by caching tree bit counts in the OpenCL implementation.  
</p>
<p>Furthermore, all data buffers with the same <code>boxm2_block_id</code> have the same
structure.  This means that any indexing any data buffer with the same 
<code>(buffIndex, buffOffset)</code> will give you the data that corresponds to the 
exact same voxel.  This inherent structure is important, as it allows for 
data modularity accross different algorithms.  
</p>

<hr size="6">
<a name="SEC12"></a>
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#SEC11" title="Previous section in reading order"> &lt; </a>]</td>
<td valign="middle" align="left">[<a href="book_3.html#SEC13" title="Next section in reading order"> &gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="#SEC7" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="#SEC7" title="Up section"> Up </a>]</td>
<td valign="middle" align="left">[<a href="book_3.html#SEC13" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="book.html#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[Contents]</td>
<td valign="middle" align="left">[Index]</td>
<td valign="middle" align="left">[<a href="book_abt.html#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<h2 class="section"> 2.2 Boxm2 Basic </h2>
<p>The sub-library <code>boxm2_basic</code> includes wrappers around buffers that make 
multi-dimensional indexing easy.  We currently have <code>boxm2_array_1d&lt;T&gt;</code>, 
<code>boxm2_array_2d&lt;T&gt;</code>, and <code>boxm2_array_3d&lt;T&gt;</code> implemented.  These arrays 
only allocate memory to assist multi-dimensional indexing, and will not destroy 
the original flat buffer upon destruction.  These wrappers are designed to merely 
wrap memory, not manage it.  
</p>

<hr size="6">
<table cellpadding="1" cellspacing="1" border="0">
<tr><td valign="middle" align="left">[<a href="#SEC7" title="Beginning of this chapter or previous chapter"> &lt;&lt; </a>]</td>
<td valign="middle" align="left">[<a href="book_3.html#SEC13" title="Next chapter"> &gt;&gt; </a>]</td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left"> &nbsp; </td>
<td valign="middle" align="left">[<a href="book.html#Top" title="Cover (top) of document">Top</a>]</td>
<td valign="middle" align="left">[Contents]</td>
<td valign="middle" align="left">[Index]</td>
<td valign="middle" align="left">[<a href="book_abt.html#SEC_About" title="About (help)"> ? </a>]</td>
</tr></table>
<p>
 <font size="-1">
  This document was generated on <i>May, 1 2013</i> using <a href="http://texi2html.cvshome.org/"><i>texi2html 1.76</i></a>.
 </font>
 <br>

</p>
</body>
</html>
