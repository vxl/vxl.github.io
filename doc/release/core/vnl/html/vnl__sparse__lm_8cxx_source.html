<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
"http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
  <title>core/vnl/algo/vnl_sparse_lm.cxx Source File</title>
  <link href="doxygen.css" rel="stylesheet" type="text/css" />
  <link href="tabs.css" rel="stylesheet" type="text/css" />
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
</head>
<body>
<!-- Generated by Doxygen 1.7.5.1 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<div class="title">core/vnl/algo/vnl_sparse_lm.cxx</div>  </div>
</div>
<div class="contents">
<a href="vnl__sparse__lm_8cxx.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">// This is core/vnl/algo/vnl_sparse_lm.cxx</span>
<a name="l00002"></a>00002 <span class="preprocessor">#ifdef VCL_NEEDS_PRAGMA_INTERFACE</span>
<a name="l00003"></a>00003 <span class="preprocessor"></span><span class="preprocessor">#pragma implementation</span>
<a name="l00004"></a>00004 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00005"></a>00005 <span class="preprocessor"></span><span class="comment">//:</span>
<a name="l00006"></a>00006 <span class="comment">// \file</span>
<a name="l00007"></a>00007 <span class="comment">// \author Matt Leotta (Brown)</span>
<a name="l00008"></a>00008 <span class="comment">// \date   April 14, 2005</span>
<a name="l00009"></a>00009 <span class="comment">//</span>
<a name="l00010"></a>00010 <span class="comment">//-----------------------------------------------------------------------------</span>
<a name="l00011"></a>00011 
<a name="l00012"></a>00012 <span class="preprocessor">#include &quot;<a class="code" href="vnl__sparse__lm_8h.html" title="Sparse Levenberg Marquardt nonlinear least squares.">vnl_sparse_lm.h</a>&quot;</span>
<a name="l00013"></a>00013 
<a name="l00014"></a>00014 <span class="preprocessor">#include &lt;vcl_iostream.h&gt;</span>
<a name="l00015"></a>00015 <span class="preprocessor">#include &lt;vcl_iomanip.h&gt;</span>
<a name="l00016"></a>00016 <span class="preprocessor">#include &lt;vcl_algorithm.h&gt;</span>
<a name="l00017"></a>00017 
<a name="l00018"></a>00018 <span class="preprocessor">#include &lt;<a class="code" href="vnl__vector_8h.html">vnl/vnl_vector.h</a>&gt;</span>
<a name="l00019"></a>00019 <span class="preprocessor">#include &lt;<a class="code" href="vnl__matrix_8h.html" title="An ordinary mathematical matrix.">vnl/vnl_matrix.h</a>&gt;</span>
<a name="l00020"></a>00020 <span class="preprocessor">#include &lt;<a class="code" href="vnl__fastops_8h.html" title="Collection of C-style matrix functions.">vnl/vnl_fastops.h</a>&gt;</span>
<a name="l00021"></a>00021 <span class="preprocessor">#include &lt;<a class="code" href="vnl__vector__ref_8h.html" title="vnl_vector using user-supplied storage">vnl/vnl_vector_ref.h</a>&gt;</span>
<a name="l00022"></a>00022 <span class="preprocessor">#include &lt;<a class="code" href="vnl__crs__index_8h.html" title="Compressed Row Storage (CRS) indexing.">vnl/vnl_crs_index.h</a>&gt;</span>
<a name="l00023"></a>00023 <span class="preprocessor">#include &lt;<a class="code" href="vnl__sparse__lst__sqr__function_8h.html" title="Abstract base for sparse least squares functions.">vnl/vnl_sparse_lst_sqr_function.h</a>&gt;</span>
<a name="l00024"></a>00024 
<a name="l00025"></a>00025 <span class="preprocessor">#include &lt;<a class="code" href="vnl__cholesky_8h.html" title="Decomposition of symmetric matrix.">vnl/algo/vnl_cholesky.h</a>&gt;</span>
<a name="l00026"></a>00026 <span class="preprocessor">#include &lt;<a class="code" href="vnl__svd_8h.html" title="Holds the singular value decomposition of a vnl_matrix.">vnl/algo/vnl_svd.h</a>&gt;</span>
<a name="l00027"></a>00027 
<a name="l00028"></a>00028 
<a name="l00029"></a><a class="code" href="classvnl__sparse__lm.html#aec25c2a0f28bccb9b5160faec4e89aa0">00029</a> <span class="comment">//: Initialize with the function object that is to be minimized.</span>
<a name="l00030"></a>00030 <a class="code" href="classvnl__sparse__lm.html#aec25c2a0f28bccb9b5160faec4e89aa0" title="Initialize with the function object that is to be minimized.">vnl_sparse_lm::vnl_sparse_lm</a>(<a class="code" href="classvnl__sparse__lst__sqr__function.html" title="Abstract base for sparse least squares functions.">vnl_sparse_lst_sqr_function</a>&amp; f)
<a name="l00031"></a>00031  : num_a_(f.number_of_a()),
<a name="l00032"></a>00032    num_b_(f.number_of_b()),
<a name="l00033"></a>00033    num_e_(f.number_of_e()),
<a name="l00034"></a>00034    num_nz_(f.residual_indices().num_non_zero()),
<a name="l00035"></a>00035    size_a_(f.index_a(num_a_)),
<a name="l00036"></a>00036    size_b_(f.index_b(num_b_)),
<a name="l00037"></a>00037    size_c_(f.number_of_params_c()),
<a name="l00038"></a>00038    size_e_(f.index_e(num_e_)),
<a name="l00039"></a>00039    A_(num_nz_),
<a name="l00040"></a>00040    B_(num_nz_),
<a name="l00041"></a>00041    C_(num_nz_),
<a name="l00042"></a>00042    U_(num_a_),
<a name="l00043"></a>00043    V_(num_b_),
<a name="l00044"></a>00044    T_(size_c_, size_c_),
<a name="l00045"></a>00045    W_(num_nz_),
<a name="l00046"></a>00046    R_(num_b_),
<a name="l00047"></a>00047    Q_(num_a_),
<a name="l00048"></a>00048    ea_(size_a_),
<a name="l00049"></a>00049    eb_(size_b_),
<a name="l00050"></a>00050    ec_(size_c_),
<a name="l00051"></a>00051    e_(size_e_),
<a name="l00052"></a>00052    weights_(f.has_weights() ? num_e_ : 0, 1.0),
<a name="l00053"></a>00053    inv_V_(num_b_),
<a name="l00054"></a>00054    Y_(num_nz_),
<a name="l00055"></a>00055    Z_(num_a_),
<a name="l00056"></a>00056    Ma_(num_a_),
<a name="l00057"></a>00057    Mb_(num_b_)
<a name="l00058"></a>00058 {
<a name="l00059"></a>00059   <a class="code" href="classvnl__sparse__lm.html#a13a03c95f2e71085a5e71226d35c6744">init</a>(&amp;f);
<a name="l00060"></a>00060 }
<a name="l00061"></a>00061 
<a name="l00062"></a>00062 
<a name="l00063"></a><a class="code" href="classvnl__sparse__lm.html#a13a03c95f2e71085a5e71226d35c6744">00063</a> <span class="comment">// ctor</span>
<a name="l00064"></a>00064 <span class="keywordtype">void</span> <a class="code" href="classvnl__sparse__lm.html#a13a03c95f2e71085a5e71226d35c6744">vnl_sparse_lm::init</a>(<a class="code" href="classvnl__sparse__lst__sqr__function.html" title="Abstract base for sparse least squares functions.">vnl_sparse_lst_sqr_function</a>* f)
<a name="l00065"></a>00065 {
<a name="l00066"></a>00066   <a class="code" href="classvnl__sparse__lm.html#a3173e72fb1678737a0bf8fdccfde103c" title="the function to minimize.">f_</a> = f;
<a name="l00067"></a>00067 
<a name="l00068"></a>00068   <span class="comment">// If changing these defaults, check the help comments in vnl_sparse_lm.h,</span>
<a name="l00069"></a>00069   <span class="comment">// and MAKE SURE they&#39;re consistent.</span>
<a name="l00070"></a>00070   <a class="code" href="classvnl__nonlinear__minimizer.html#a68a7baa2492f61995b0a9edf987acecf" title="Termination tolerance on X (solution vector)">xtol</a> = 1e-15;          <span class="comment">// Termination tolerance on X (solution vector)</span>
<a name="l00071"></a>00071   <a class="code" href="classvnl__nonlinear__minimizer.html#a875dd6fa5b2f3e2188abff6ecd021981" title="Termination maximum number of iterations.">maxfev</a> = 1000;         <span class="comment">// Termination maximum number of iterations.</span>
<a name="l00072"></a>00072   <a class="code" href="classvnl__nonlinear__minimizer.html#a646ecd456764b9100f593710a6474932" title="Termination tolerance on F (sum of squared residuals)">ftol</a> = 1e-15;          <span class="comment">// Termination tolerance on F (sum of squared residuals)</span>
<a name="l00073"></a>00073   <a class="code" href="classvnl__nonlinear__minimizer.html#a4107bc0936bb7b53d28d9d3fe16e5474" title="Termination tolerance on Grad(F)&#39; * F = 0.">gtol</a> = 1e-15;          <span class="comment">// Termination tolerance on Grad(F)&#39; * F = 0</span>
<a name="l00074"></a>00074   <a class="code" href="classvnl__nonlinear__minimizer.html#ac7513bea6836ad5e3633112909b8534b" title="Step length for FD Jacobian.">epsfcn</a> = 0.001;        <span class="comment">// Step length for FD Jacobian</span>
<a name="l00075"></a>00075 
<a name="l00076"></a>00076   <a class="code" href="classvnl__sparse__lm.html#a9b25e881ee4150d137a0da4b5ebd4c24" title="used to compute the initial damping.">tau_</a> = 0.001;
<a name="l00077"></a>00077 
<a name="l00078"></a>00078   <a class="code" href="classvnl__sparse__lm.html#a4dc4c30de9607d46012740f2fffd16fe" title="allocate matrix memory by setting all the matrix sizes.">allocate_matrices</a>();
<a name="l00079"></a>00079 }
<a name="l00080"></a><a class="code" href="classvnl__sparse__lm.html#ada5a8441ecd4d4ee192162b2d835729a">00080</a> 
<a name="l00081"></a>00081 <a class="code" href="classvnl__sparse__lm.html#ada5a8441ecd4d4ee192162b2d835729a" title="Destructor.">vnl_sparse_lm::~vnl_sparse_lm</a>()
<a name="l00082"></a>00082 {
<a name="l00083"></a>00083 }
<a name="l00084"></a>00084 
<a name="l00085"></a>00085 
<a name="l00086"></a>00086 <span class="comment">//: Minimize the function supplied in the constructor until convergence or failure.</span>
<a name="l00087"></a>00087 <span class="comment">//  On return, a, b, and c are such that f(a,b,c) is the lowest value achieved.</span>
<a name="l00088"></a>00088 <span class="comment">//  Returns true for convergence, false for failure.</span>
<a name="l00089"></a>00089 <span class="comment">//  If use_gradient is set to false, a finite difference approximation will be used,</span>
<a name="l00090"></a>00090 <span class="comment">//  even if the Jacobian functions have been provided.</span>
<a name="l00091"></a>00091 <span class="comment">//  If use_weights is set to false, weights will not be computed even if a</span>
<a name="l00092"></a><a class="code" href="classvnl__sparse__lm.html#a48fef0b82a29c0afe7f4769094f88a2d">00092</a> <span class="comment">//  weighting function has been provided.</span>
<a name="l00093"></a>00093 <span class="keywordtype">bool</span> <a class="code" href="classvnl__sparse__lm.html#a48fef0b82a29c0afe7f4769094f88a2d" title="Minimize the function supplied in the constructor until convergence or failure.">vnl_sparse_lm::minimize</a>(<a class="code" href="classvnl__vector.html">vnl_vector&lt;double&gt;</a>&amp; a,
<a name="l00094"></a>00094                              <a class="code" href="classvnl__vector.html">vnl_vector&lt;double&gt;</a>&amp; b,
<a name="l00095"></a>00095                              <a class="code" href="classvnl__vector.html">vnl_vector&lt;double&gt;</a>&amp; c,
<a name="l00096"></a>00096                              <span class="keywordtype">bool</span> use_gradient,
<a name="l00097"></a>00097                              <span class="keywordtype">bool</span> use_weights)
<a name="l00098"></a>00098 {
<a name="l00099"></a>00099   <span class="comment">// verify that the vectors are of the correct size</span>
<a name="l00100"></a>00100   <span class="keywordflow">if</span> (!<a class="code" href="classvnl__sparse__lm.html#af3eead72590fc5a52aba157103aa83d7" title="check vector sizes and verify that they match the problem size.">check_vector_sizes</a>(a,b,c))
<a name="l00101"></a>00101     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00102"></a>00102 
<a name="l00103"></a>00103   <span class="comment">//: Systems to solve will be Sc*dc=sec and Sa*da=sea</span>
<a name="l00104"></a>00104   <a class="code" href="classvnl__matrix.html">vnl_matrix&lt;double&gt;</a> Sc(<a class="code" href="classvnl__sparse__lm.html#a690f0091a073781a62ff1aa43f7d8894">size_c_</a>,<a class="code" href="classvnl__sparse__lm.html#a690f0091a073781a62ff1aa43f7d8894">size_c_</a>), Sa(<a class="code" href="classvnl__sparse__lm.html#af394ea4fb570100da9aca72c112d617d">size_a_</a>, <a class="code" href="classvnl__sparse__lm.html#af394ea4fb570100da9aca72c112d617d">size_a_</a>);
<a name="l00105"></a>00105   <a class="code" href="classvnl__vector.html">vnl_vector&lt;double&gt;</a> sec(<a class="code" href="classvnl__sparse__lm.html#a690f0091a073781a62ff1aa43f7d8894">size_c_</a>), sea(<a class="code" href="classvnl__sparse__lm.html#af394ea4fb570100da9aca72c112d617d">size_a_</a>);
<a name="l00106"></a>00106   <span class="comment">// update vectors</span>
<a name="l00107"></a>00107   <a class="code" href="classvnl__vector.html">vnl_vector&lt;double&gt;</a> da(<a class="code" href="classvnl__sparse__lm.html#af394ea4fb570100da9aca72c112d617d">size_a_</a>), db(<a class="code" href="classvnl__sparse__lm.html#a45d95f1d6e79b3d0bf258a7304190861">size_b_</a>), dc(<a class="code" href="classvnl__sparse__lm.html#a690f0091a073781a62ff1aa43f7d8894">size_c_</a>);
<a name="l00108"></a>00108 
<a name="l00109"></a>00109 
<a name="l00110"></a>00110   <span class="comment">// mu is initialized now because the compiler produces warnings -MM</span>
<a name="l00111"></a>00111   <span class="keywordtype">double</span> mu=0; <span class="comment">// damping term (initialized later)</span>
<a name="l00112"></a>00112   <span class="keywordtype">double</span> nu=2.0;
<a name="l00113"></a>00113   <span class="keywordtype">bool</span> stop = <span class="keyword">false</span>;
<a name="l00114"></a>00114   <span class="comment">// compute the initial residual</span>
<a name="l00115"></a>00115   <a class="code" href="classvnl__sparse__lm.html#a3173e72fb1678737a0bf8fdccfde103c" title="the function to minimize.">f_</a>-&gt;<a class="code" href="classvnl__sparse__lst__sqr__function.html#a6565a0886db607a05d919ce441f46760" title="Compute all residuals.">f</a>(a,b,c,<a class="code" href="classvnl__sparse__lm.html#a053e7f673f412f8688c7c1586c2771e7">e_</a>);
<a name="l00116"></a>00116   <a class="code" href="classvnl__nonlinear__minimizer.html#ad05cb2f9c1bb9c76d237e174b0943156">num_evaluations_</a> = 1;
<a name="l00117"></a>00117 
<a name="l00118"></a>00118   <span class="comment">// Compute and apply the weights if applicable</span>
<a name="l00119"></a>00119   <span class="keywordflow">if</span> (use_weights &amp;&amp; <a class="code" href="classvnl__sparse__lm.html#a3173e72fb1678737a0bf8fdccfde103c" title="the function to minimize.">f_</a>-&gt;<a class="code" href="classvnl__sparse__lst__sqr__function.html#a20a59da3a46d858ac16ccc216c81cffe" title="Return true if the derived class has indicated that.">has_weights</a>())
<a name="l00120"></a>00120   {
<a name="l00121"></a>00121     <a class="code" href="classvnl__sparse__lm.html#a3173e72fb1678737a0bf8fdccfde103c" title="the function to minimize.">f_</a>-&gt;<a class="code" href="classvnl__sparse__lst__sqr__function.html#a356cde9f3976a10132aa29d0a560c4f0" title="If using weighted least squares, compute the weights for each i and j.">compute_weights</a>(a,b,c,<a class="code" href="classvnl__sparse__lm.html#a053e7f673f412f8688c7c1586c2771e7">e_</a>,<a class="code" href="classvnl__sparse__lm.html#a14c1e13c711588df3e1363c707a3e9e2">weights_</a>);
<a name="l00122"></a>00122     <a class="code" href="classvnl__sparse__lm.html#a3173e72fb1678737a0bf8fdccfde103c" title="the function to minimize.">f_</a>-&gt;<a class="code" href="classvnl__sparse__lst__sqr__function.html#a63940159f2acf016c9d0f54ca418dc15" title="If using weighted least squares, apply the weights to residuals f.">apply_weights</a>(<a class="code" href="classvnl__sparse__lm.html#a14c1e13c711588df3e1363c707a3e9e2">weights_</a>, <a class="code" href="classvnl__sparse__lm.html#a053e7f673f412f8688c7c1586c2771e7">e_</a>);
<a name="l00123"></a>00123   }
<a name="l00124"></a>00124 
<a name="l00125"></a>00125   <span class="keywordtype">double</span> sqr_error = <a class="code" href="classvnl__sparse__lm.html#a053e7f673f412f8688c7c1586c2771e7">e_</a>.<a class="code" href="classvnl__vector.html#a51021e6fc0343c16f4faf8fb23ec13c3" title="Return sum of squares of elements.">squared_magnitude</a>();
<a name="l00126"></a>00126   <a class="code" href="classvnl__nonlinear__minimizer.html#ae1319d7d95d1ae3ab54ab3135c170953">start_error_</a> = vcl_sqrt(sqr_error/<a class="code" href="classvnl__sparse__lm.html#a053e7f673f412f8688c7c1586c2771e7">e_</a>.<a class="code" href="classvnl__vector.html#a11191c91a1dbb4e1d8423dad8b110712" title="Return the length, number of elements, dimension of this vector.">size</a>()); <span class="comment">// RMS error</span>
<a name="l00127"></a>00127 
<a name="l00128"></a>00128   <span class="keywordflow">for</span> (<a class="code" href="classvnl__nonlinear__minimizer.html#a1bd527616499cd8eaddbd6fe36d4cfa1">num_iterations_</a>=0; <a class="code" href="classvnl__nonlinear__minimizer.html#a1bd527616499cd8eaddbd6fe36d4cfa1">num_iterations_</a>&lt;(<span class="keywordtype">unsigned</span> int)<a class="code" href="classvnl__nonlinear__minimizer.html#a875dd6fa5b2f3e2188abff6ecd021981" title="Termination maximum number of iterations.">maxfev</a> &amp;&amp; !stop; ++<a class="code" href="classvnl__nonlinear__minimizer.html#a1bd527616499cd8eaddbd6fe36d4cfa1">num_iterations_</a>)
<a name="l00129"></a>00129   {
<a name="l00130"></a>00130     <span class="keywordflow">if</span> (<a class="code" href="classvnl__nonlinear__minimizer.html#a6384f8c4bfa01f6ac48959cf34825623">verbose_</a>)
<a name="l00131"></a>00131       vcl_cout &lt;&lt; <span class="stringliteral">&quot;iteration &quot;</span>&lt;&lt;vcl_setw(4)&lt;&lt;<a class="code" href="classvnl__nonlinear__minimizer.html#a1bd527616499cd8eaddbd6fe36d4cfa1">num_iterations_</a>
<a name="l00132"></a>00132                &lt;&lt; <span class="stringliteral">&quot; RMS error = &quot;</span>&lt;&lt; vcl_setprecision(6)&lt;&lt; vcl_setw(12)&lt;&lt;vcl_sqrt(sqr_error/<a class="code" href="classvnl__sparse__lm.html#a053e7f673f412f8688c7c1586c2771e7">e_</a>.<a class="code" href="classvnl__vector.html#a11191c91a1dbb4e1d8423dad8b110712" title="Return the length, number of elements, dimension of this vector.">size</a>())
<a name="l00133"></a>00133                &lt;&lt; <span class="stringliteral">&quot; mu = &quot;</span>&lt;&lt;vcl_setprecision(6)&lt;&lt; vcl_setw(12) &lt;&lt;mu&lt;&lt; <span class="stringliteral">&quot; nu = &quot;</span>&lt;&lt; nu &lt;&lt; vcl_endl;
<a name="l00134"></a>00134     <span class="keywordflow">if</span> (<a class="code" href="classvnl__nonlinear__minimizer.html#a7318354974934f37492beb178285bd61">trace</a>)
<a name="l00135"></a>00135       <a class="code" href="classvnl__sparse__lm.html#a3173e72fb1678737a0bf8fdccfde103c" title="the function to minimize.">f_</a>-&gt;<a class="code" href="classvnl__sparse__lst__sqr__function.html#ac281578ff13d6c946f7e7317b94d3d4a" title="Called after each LM iteration to print debugging etc.">trace</a>(<a class="code" href="classvnl__nonlinear__minimizer.html#a1bd527616499cd8eaddbd6fe36d4cfa1">num_iterations_</a>,a,b,c,<a class="code" href="classvnl__sparse__lm.html#a053e7f673f412f8688c7c1586c2771e7">e_</a>);
<a name="l00136"></a>00136 
<a name="l00137"></a>00137     <span class="comment">// Compute the Jacobian in block form J = [A|B|C]</span>
<a name="l00138"></a>00138     <span class="comment">// where A, B, and C are sparse and contain subblocks Aij, Bij, and Cij</span>
<a name="l00139"></a>00139     <span class="keywordflow">if</span> (use_gradient &amp;&amp; <a class="code" href="classvnl__sparse__lm.html#a3173e72fb1678737a0bf8fdccfde103c" title="the function to minimize.">f_</a>-&gt;<a class="code" href="classvnl__sparse__lst__sqr__function.html#acf5e879631deb53038845ba96a9966e1" title="Return true if the derived class has indicated that gradf has been implemented.">has_gradient</a>())
<a name="l00140"></a>00140       <a class="code" href="classvnl__sparse__lm.html#a3173e72fb1678737a0bf8fdccfde103c" title="the function to minimize.">f_</a>-&gt;<a class="code" href="classvnl__sparse__lst__sqr__function.html#adff5800a571932385afcb3b05e581cf7" title="Compute the sparse Jacobian in block form.">jac_blocks</a>(a,b,c,<a class="code" href="classvnl__sparse__lm.html#a9483ec57eb8c890e3f2c106fcec0a599" title="Storage for each of the Jacobians A_ij, B_ij, and C_ij.">A_</a>,<a class="code" href="classvnl__sparse__lm.html#aa7486837e098103b25747e770c0986ab">B_</a>,<a class="code" href="classvnl__sparse__lm.html#ac859cfa259b0f356e60b43d441f35d81">C_</a>);
<a name="l00141"></a>00141     <span class="keywordflow">else</span>
<a name="l00142"></a>00142       <a class="code" href="classvnl__sparse__lm.html#a3173e72fb1678737a0bf8fdccfde103c" title="the function to minimize.">f_</a>-&gt;<a class="code" href="classvnl__sparse__lst__sqr__function.html#ac4f5d5929317eee273e899941d293a26" title="Compute the sparse Jacobian in block form using a finite difference approximation.">fd_jac_blocks</a>(a,b,c,<a class="code" href="classvnl__sparse__lm.html#a9483ec57eb8c890e3f2c106fcec0a599" title="Storage for each of the Jacobians A_ij, B_ij, and C_ij.">A_</a>,<a class="code" href="classvnl__sparse__lm.html#aa7486837e098103b25747e770c0986ab">B_</a>,<a class="code" href="classvnl__sparse__lm.html#ac859cfa259b0f356e60b43d441f35d81">C_</a>,<a class="code" href="classvnl__nonlinear__minimizer.html#ac7513bea6836ad5e3633112909b8534b" title="Step length for FD Jacobian.">epsfcn</a>); <span class="comment">// use finite differences</span>
<a name="l00143"></a>00143 
<a name="l00144"></a>00144     <span class="comment">// Apply the weights if applicable</span>
<a name="l00145"></a>00145     <span class="keywordflow">if</span> (use_weights &amp;&amp; <a class="code" href="classvnl__sparse__lm.html#a3173e72fb1678737a0bf8fdccfde103c" title="the function to minimize.">f_</a>-&gt;<a class="code" href="classvnl__sparse__lst__sqr__function.html#a20a59da3a46d858ac16ccc216c81cffe" title="Return true if the derived class has indicated that.">has_weights</a>())
<a name="l00146"></a>00146     {
<a name="l00147"></a>00147       <a class="code" href="classvnl__sparse__lm.html#a3173e72fb1678737a0bf8fdccfde103c" title="the function to minimize.">f_</a>-&gt;<a class="code" href="classvnl__sparse__lst__sqr__function.html#a63940159f2acf016c9d0f54ca418dc15" title="If using weighted least squares, apply the weights to residuals f.">apply_weights</a>(<a class="code" href="classvnl__sparse__lm.html#a14c1e13c711588df3e1363c707a3e9e2">weights_</a>, <a class="code" href="classvnl__sparse__lm.html#a9483ec57eb8c890e3f2c106fcec0a599" title="Storage for each of the Jacobians A_ij, B_ij, and C_ij.">A_</a>,<a class="code" href="classvnl__sparse__lm.html#aa7486837e098103b25747e770c0986ab">B_</a>,<a class="code" href="classvnl__sparse__lm.html#ac859cfa259b0f356e60b43d441f35d81">C_</a>);
<a name="l00148"></a>00148     }
<a name="l00149"></a>00149 
<a name="l00150"></a>00150     <a class="code" href="classvnl__sparse__lm.html#af7a849f471e60d63260eb6685730ada0" title="compute the blocks making up the the normal equations: Jt J d = Jt e.">compute_normal_equations</a>();
<a name="l00151"></a>00151 
<a name="l00152"></a>00152     <span class="comment">// check for convergence in gradient</span>
<a name="l00153"></a>00153     <span class="keywordflow">if</span> (vcl_max(vcl_max(<a class="code" href="classvnl__sparse__lm.html#a507a409cc6e7239b031ef0209f76be19">ea_</a>.<a class="code" href="classvnl__vector.html#a68fc50f5690a03a88566b02fa9757f17" title="Return largest absolute element value.">inf_norm</a>(),<a class="code" href="classvnl__sparse__lm.html#a651698a11965625028830139eb344df0">eb_</a>.<a class="code" href="classvnl__vector.html#a68fc50f5690a03a88566b02fa9757f17" title="Return largest absolute element value.">inf_norm</a>()),<a class="code" href="classvnl__sparse__lm.html#a6220c7736d7e8fcdfc002e2d41219c8b">ec_</a>.<a class="code" href="classvnl__vector.html#a68fc50f5690a03a88566b02fa9757f17" title="Return largest absolute element value.">inf_norm</a>()) &lt;= <a class="code" href="classvnl__nonlinear__minimizer.html#a4107bc0936bb7b53d28d9d3fe16e5474" title="Termination tolerance on Grad(F)&#39; * F = 0.">gtol</a>)
<a name="l00154"></a>00154     {
<a name="l00155"></a>00155       <a class="code" href="classvnl__nonlinear__minimizer.html#a0c15383c3526f88012364ac342d6e7d7">failure_code_</a> = <a class="code" href="classvnl__nonlinear__minimizer.html#a6112004b90f040a90efeebe19286b908abd24866909de4210cf14099817595a9a">CONVERGED_GTOL</a>;
<a name="l00156"></a>00156       stop = <span class="keyword">true</span>;
<a name="l00157"></a>00157       <span class="keywordflow">break</span>;
<a name="l00158"></a>00158     }
<a name="l00159"></a>00159 
<a name="l00160"></a>00160 
<a name="l00161"></a>00161     <span class="keywordtype">double</span> sqr_params = a.<a class="code" href="classvnl__vector.html#a51021e6fc0343c16f4faf8fb23ec13c3" title="Return sum of squares of elements.">squared_magnitude</a>();
<a name="l00162"></a>00162     sqr_params += b.<a class="code" href="classvnl__vector.html#a51021e6fc0343c16f4faf8fb23ec13c3" title="Return sum of squares of elements.">squared_magnitude</a>();
<a name="l00163"></a>00163     sqr_params += c.<a class="code" href="classvnl__vector.html#a51021e6fc0343c16f4faf8fb23ec13c3" title="Return sum of squares of elements.">squared_magnitude</a>();
<a name="l00164"></a>00164 
<a name="l00165"></a>00165     <span class="comment">// Extract the diagonal of J^T*J as a vector</span>
<a name="l00166"></a>00166     <a class="code" href="classvnl__vector.html">vnl_vector&lt;double&gt;</a> diag_UVT = <a class="code" href="classvnl__sparse__lm.html#a8bf228ebd7b3b5ace2b2b4f616add68a" title="extract the vector on the diagonal of Jt J.">extract_diagonal</a>();
<a name="l00167"></a>00167 
<a name="l00168"></a>00168     <span class="comment">// initialize mu if this is the first iteration</span>
<a name="l00169"></a>00169     <span class="comment">// proportional to the diagonal entry with the largest magnitude</span>
<a name="l00170"></a>00170     <span class="keywordflow">if</span> (<a class="code" href="classvnl__nonlinear__minimizer.html#a1bd527616499cd8eaddbd6fe36d4cfa1">num_iterations_</a>==0)
<a name="l00171"></a>00171       mu = <a class="code" href="classvnl__sparse__lm.html#a9b25e881ee4150d137a0da4b5ebd4c24" title="used to compute the initial damping.">tau_</a>*diag_UVT.<a class="code" href="classvnl__vector.html#a68fc50f5690a03a88566b02fa9757f17" title="Return largest absolute element value.">inf_norm</a>();
<a name="l00172"></a>00172 
<a name="l00173"></a>00173     <span class="comment">// Re-solve the system while adapting mu until we decrease error or converge</span>
<a name="l00174"></a>00174     <span class="keywordflow">while</span> (<span class="keyword">true</span>)
<a name="l00175"></a>00175     {
<a name="l00176"></a>00176       <span class="comment">// augment the diagonals with damping term mu</span>
<a name="l00177"></a>00177       <a class="code" href="classvnl__sparse__lm.html#a2e1103f1a563d7655837ef3fc1824ed6" title="set the vector on the diagonal of Jt J.">set_diagonal</a>(diag_UVT + mu);
<a name="l00178"></a>00178 
<a name="l00179"></a>00179       <span class="comment">// compute inv(Vj) and Yij</span>
<a name="l00180"></a>00180       <a class="code" href="classvnl__sparse__lm.html#adbe55fe4063a89ec1a788f31b6f58db7" title="compute all inv(Vi) and Yij.">compute_invV_Y</a>();
<a name="l00181"></a>00181 
<a name="l00182"></a>00182       <span class="keywordflow">if</span> ( <a class="code" href="classvnl__sparse__lm.html#a690f0091a073781a62ff1aa43f7d8894">size_c_</a> &gt; 0 )
<a name="l00183"></a>00183       {
<a name="l00184"></a>00184         <span class="comment">// compute Z = RYt-Q and Sa</span>
<a name="l00185"></a>00185         <a class="code" href="classvnl__sparse__lm.html#a3e870c2360c836c064a33a7285aefedf" title="compute Z and Sa.">compute_Z_Sa</a>(Sa);
<a name="l00186"></a>00186 
<a name="l00187"></a>00187         <span class="comment">// this large inverse is the bottle neck of this algorithm</span>
<a name="l00188"></a>00188         <a class="code" href="classvnl__matrix.html">vnl_matrix&lt;double&gt;</a> H;
<a name="l00189"></a>00189         <a class="code" href="classvnl__cholesky.html" title="Decomposition of symmetric matrix.">vnl_cholesky</a> Sa_cholesky(Sa,<a class="code" href="classvnl__cholesky.html#aaabc2110e510ffa1417a657cbef99efca6ae23c768b154f5a2f128caa4fe05350">vnl_cholesky::quiet</a>);
<a name="l00190"></a>00190         <a class="code" href="classvnl__svd.html" title="Holds the singular value decomposition of a vnl_matrix.">vnl_svd&lt;double&gt;</a> *Sa_svd = 0;
<a name="l00191"></a>00191         <span class="comment">// use SVD as a backup if Cholesky is deficient</span>
<a name="l00192"></a>00192         <span class="keywordflow">if</span> ( Sa_cholesky.<a class="code" href="classvnl__cholesky.html#ade6855bf36ca3b97e79cbf04ee289977" title="A Success/failure flag.">rank_deficiency</a>() &gt; 0 )
<a name="l00193"></a>00193         {
<a name="l00194"></a>00194           Sa_svd = <span class="keyword">new</span> <a class="code" href="classvnl__svd.html" title="Holds the singular value decomposition of a vnl_matrix.">vnl_svd&lt;double&gt;</a>(Sa);
<a name="l00195"></a>00195           H = Sa_svd-&gt;<a class="code" href="classvnl__svd.html#aca07308f7241e6a981813dddb8a8d3cb">inverse</a>();
<a name="l00196"></a>00196         }
<a name="l00197"></a>00197         <span class="keywordflow">else</span>
<a name="l00198"></a>00198           H = Sa_cholesky.<a class="code" href="classvnl__cholesky.html#a6989e61544e1f0a6f5cb304eae762f38">inverse</a>();
<a name="l00199"></a>00199 
<a name="l00200"></a>00200         <span class="comment">// construct the Ma = ZH</span>
<a name="l00201"></a>00201         <a class="code" href="classvnl__sparse__lm.html#a515df600c8a0e3f699466ad0633986b7" title="compute Ma.">compute_Ma</a>(H);
<a name="l00202"></a>00202         <span class="comment">// construct Mb = (R+MaW)inv(V)</span>
<a name="l00203"></a>00203         <a class="code" href="classvnl__sparse__lm.html#a3b5fbf843f069afd6f6049075dcf3c19" title="compute Mb.">compute_Mb</a>();
<a name="l00204"></a>00204 
<a name="l00205"></a>00205         <span class="comment">// use Ma and Mb to solve for dc</span>
<a name="l00206"></a>00206         <a class="code" href="classvnl__sparse__lm.html#ae004c02c3c12bebac2c27e3d936754db" title="solve for dc.">solve_dc</a>(dc);
<a name="l00207"></a>00207 
<a name="l00208"></a>00208         <span class="comment">// compute sea from ea, Z, dc, Y, and eb</span>
<a name="l00209"></a>00209         <a class="code" href="classvnl__sparse__lm.html#a105241d756174e7cebf4816ec70175b5" title="compute sea using ea, Z, dc, Y, and eb.">compute_sea</a>(dc,sea);
<a name="l00210"></a>00210 
<a name="l00211"></a>00211 
<a name="l00212"></a>00212         <span class="keywordflow">if</span> ( Sa_svd )
<a name="l00213"></a>00213           da = Sa_svd-&gt;<a class="code" href="classvnl__svd.html#ac2cbab9e5659cebda7829337d285fbcc" title="Solve the matrix equation M X = B, returning X.">solve</a>(sea);
<a name="l00214"></a>00214         <span class="keywordflow">else</span>
<a name="l00215"></a>00215           da = Sa_cholesky.<a class="code" href="classvnl__cholesky.html#ab7d3309b8b536a8409e6326aca2d9c09" title="Solve LS problem M x = b.">solve</a>(sea);
<a name="l00216"></a>00216         <span class="keyword">delete</span> Sa_svd;
<a name="l00217"></a>00217       }
<a name="l00218"></a>00218       <span class="keywordflow">else</span> <span class="comment">// size_c_ == 0</span>
<a name="l00219"></a>00219       {
<a name="l00220"></a>00220         <span class="comment">// |I -W*inv(V)| * |U  W| * |da| = |I -W*inv(V)| * |ea|</span>
<a name="l00221"></a>00221         <span class="comment">// |0     I    |   |Wt V|   |db|   |0     I    |   |eb|</span>
<a name="l00222"></a>00222         <span class="comment">//</span>
<a name="l00223"></a>00223         <span class="comment">// premultiplying as shown above gives:</span>
<a name="l00224"></a>00224         <span class="comment">// |Sa 0| * |da| = |sea|</span>
<a name="l00225"></a>00225         <span class="comment">// |Wt V|   |db|   |eb |</span>
<a name="l00226"></a>00226         <span class="comment">//</span>
<a name="l00227"></a>00227         <span class="comment">// so we can first solve  Sa*da = sea  and then substitute to find db</span>
<a name="l00228"></a>00228 
<a name="l00229"></a>00229         <span class="comment">// compute Sa and sea</span>
<a name="l00230"></a>00230         <a class="code" href="classvnl__sparse__lm.html#aeb0d0c6adb6e9cce5c87459f4ce3425f" title="compute Sa and sea.">compute_Sa_sea</a>(Sa,sea);
<a name="l00231"></a>00231 
<a name="l00232"></a>00232 <span class="preprocessor">#ifdef DEBUG</span>
<a name="l00233"></a>00233 <span class="preprocessor"></span>        vcl_cout &lt;&lt; <span class="stringliteral">&quot;singular values = &quot;</span>&lt;&lt; <a class="code" href="classvnl__svd.html" title="Holds the singular value decomposition of a vnl_matrix.">vnl_svd&lt;double&gt;</a>(Sa).W() &lt;&lt;vcl_endl;
<a name="l00234"></a>00234 <span class="preprocessor">#endif</span>
<a name="l00235"></a>00235 <span class="preprocessor"></span>        <span class="comment">// We could use a faster solver here, maybe conjugate gradients?</span>
<a name="l00236"></a>00236         <span class="comment">// Solve the system  Sa*da = sea  for da</span>
<a name="l00237"></a>00237 
<a name="l00238"></a>00238         <a class="code" href="classvnl__cholesky.html" title="Decomposition of symmetric matrix.">vnl_cholesky</a> Sa_cholesky(Sa,<a class="code" href="classvnl__cholesky.html#aaabc2110e510ffa1417a657cbef99efca6ae23c768b154f5a2f128caa4fe05350">vnl_cholesky::quiet</a>);
<a name="l00239"></a>00239         <span class="comment">// use SVD as a backup if Cholesky is deficient</span>
<a name="l00240"></a>00240         <span class="keywordflow">if</span> ( Sa_cholesky.<a class="code" href="classvnl__cholesky.html#ade6855bf36ca3b97e79cbf04ee289977" title="A Success/failure flag.">rank_deficiency</a>() &gt; 0 )
<a name="l00241"></a>00241         {
<a name="l00242"></a>00242           <a class="code" href="classvnl__svd.html" title="Holds the singular value decomposition of a vnl_matrix.">vnl_svd&lt;double&gt;</a> Sa_svd(Sa);
<a name="l00243"></a>00243           da = Sa_svd.<a class="code" href="classvnl__svd.html#ac2cbab9e5659cebda7829337d285fbcc" title="Solve the matrix equation M X = B, returning X.">solve</a>(sea);
<a name="l00244"></a>00244         }
<a name="l00245"></a>00245         <span class="keywordflow">else</span>
<a name="l00246"></a>00246           da = Sa_cholesky.<a class="code" href="classvnl__cholesky.html#ab7d3309b8b536a8409e6326aca2d9c09" title="Solve LS problem M x = b.">solve</a>(sea);
<a name="l00247"></a>00247       }
<a name="l00248"></a>00248 
<a name="l00249"></a>00249       <span class="comment">// substitute da and dc to compute db</span>
<a name="l00250"></a>00250       <a class="code" href="classvnl__sparse__lm.html#a2c0d50050a1d51072bf5866ca7ce3ff0" title="back solve to find db using da and dc.">backsolve_db</a>(da, dc, db);
<a name="l00251"></a>00251 
<a name="l00252"></a>00252       <span class="comment">// check for convergence in parameters</span>
<a name="l00253"></a>00253       <span class="comment">// (change in parameters is below a tolerance)</span>
<a name="l00254"></a>00254       <span class="keywordtype">double</span> sqr_delta = da.squared_magnitude();
<a name="l00255"></a>00255       sqr_delta += db.squared_magnitude();
<a name="l00256"></a>00256       sqr_delta += dc.<a class="code" href="classvnl__vector.html#a51021e6fc0343c16f4faf8fb23ec13c3" title="Return sum of squares of elements.">squared_magnitude</a>();
<a name="l00257"></a>00257       <span class="keywordflow">if</span> (sqr_delta &lt; <a class="code" href="classvnl__nonlinear__minimizer.html#a68a7baa2492f61995b0a9edf987acecf" title="Termination tolerance on X (solution vector)">xtol</a>*<a class="code" href="classvnl__nonlinear__minimizer.html#a68a7baa2492f61995b0a9edf987acecf" title="Termination tolerance on X (solution vector)">xtol</a>*sqr_params) {
<a name="l00258"></a>00258         <a class="code" href="classvnl__nonlinear__minimizer.html#a0c15383c3526f88012364ac342d6e7d7">failure_code_</a> = <a class="code" href="classvnl__nonlinear__minimizer.html#a6112004b90f040a90efeebe19286b908a45319c33b31daf7aaa90b164415fcb66">CONVERGED_XTOL</a>;
<a name="l00259"></a>00259         stop = <span class="keyword">true</span>;
<a name="l00260"></a>00260         <span class="keywordflow">break</span>;
<a name="l00261"></a>00261       }
<a name="l00262"></a>00262 
<a name="l00263"></a>00263       <span class="comment">// compute updated parameters and residuals of the new parameters</span>
<a name="l00264"></a>00264       <a class="code" href="classvnl__vector.html">vnl_vector&lt;double&gt;</a> new_a(a-da), new_b(b-db), new_c(c-dc);
<a name="l00265"></a>00265       <a class="code" href="classvnl__vector.html">vnl_vector&lt;double&gt;</a> new_e(<a class="code" href="classvnl__sparse__lm.html#a053e7f673f412f8688c7c1586c2771e7">e_</a>.<a class="code" href="classvnl__vector.html#a11191c91a1dbb4e1d8423dad8b110712" title="Return the length, number of elements, dimension of this vector.">size</a>()), new_weights(<a class="code" href="classvnl__sparse__lm.html#a14c1e13c711588df3e1363c707a3e9e2">weights_</a>.<a class="code" href="classvnl__vector.html#a11191c91a1dbb4e1d8423dad8b110712" title="Return the length, number of elements, dimension of this vector.">size</a>());
<a name="l00266"></a>00266       <a class="code" href="classvnl__sparse__lm.html#a3173e72fb1678737a0bf8fdccfde103c" title="the function to minimize.">f_</a>-&gt;<a class="code" href="classvnl__sparse__lst__sqr__function.html#a6565a0886db607a05d919ce441f46760" title="Compute all residuals.">f</a>(new_a,new_b,new_c,new_e); <span class="comment">// compute the new residual vector</span>
<a name="l00267"></a>00267       ++<a class="code" href="classvnl__nonlinear__minimizer.html#ad05cb2f9c1bb9c76d237e174b0943156">num_evaluations_</a>;
<a name="l00268"></a>00268 
<a name="l00269"></a>00269       <span class="comment">// Compute and apply the weights if applicable</span>
<a name="l00270"></a>00270       <span class="keywordflow">if</span> (use_weights &amp;&amp; <a class="code" href="classvnl__sparse__lm.html#a3173e72fb1678737a0bf8fdccfde103c" title="the function to minimize.">f_</a>-&gt;<a class="code" href="classvnl__sparse__lst__sqr__function.html#a20a59da3a46d858ac16ccc216c81cffe" title="Return true if the derived class has indicated that.">has_weights</a>())
<a name="l00271"></a>00271       {
<a name="l00272"></a>00272         <a class="code" href="classvnl__sparse__lm.html#a3173e72fb1678737a0bf8fdccfde103c" title="the function to minimize.">f_</a>-&gt;<a class="code" href="classvnl__sparse__lst__sqr__function.html#a356cde9f3976a10132aa29d0a560c4f0" title="If using weighted least squares, compute the weights for each i and j.">compute_weights</a>(new_a,new_b,new_c,new_e,new_weights);
<a name="l00273"></a>00273         <a class="code" href="classvnl__sparse__lm.html#a3173e72fb1678737a0bf8fdccfde103c" title="the function to minimize.">f_</a>-&gt;<a class="code" href="classvnl__sparse__lst__sqr__function.html#a63940159f2acf016c9d0f54ca418dc15" title="If using weighted least squares, apply the weights to residuals f.">apply_weights</a>(new_weights, new_e);
<a name="l00274"></a>00274       }
<a name="l00275"></a>00275 
<a name="l00276"></a>00276       <span class="keywordtype">double</span> new_sqr_error = new_e.squared_magnitude();
<a name="l00277"></a>00277 
<a name="l00278"></a>00278       <span class="keywordtype">double</span> dF = sqr_error - new_sqr_error;
<a name="l00279"></a>00279       <span class="keywordtype">double</span> dL = <a class="code" href="vnl__matrix_8h.html#a3a6406941c788eaae99974a3c8b58cee">dot_product</a>(da,(mu*da+<a class="code" href="classvnl__sparse__lm.html#a507a409cc6e7239b031ef0209f76be19">ea_</a>))
<a name="l00280"></a>00280                  +<a class="code" href="vnl__matrix_8h.html#a3a6406941c788eaae99974a3c8b58cee">dot_product</a>(db,(mu*db+<a class="code" href="classvnl__sparse__lm.html#a651698a11965625028830139eb344df0">eb_</a>))
<a name="l00281"></a>00281                  +<a class="code" href="vnl__matrix_8h.html#a3a6406941c788eaae99974a3c8b58cee">dot_product</a>(dc,(mu*dc+<a class="code" href="classvnl__sparse__lm.html#a6220c7736d7e8fcdfc002e2d41219c8b">ec_</a>));
<a name="l00282"></a>00282       <span class="keywordflow">if</span> (dF&gt;0.0 &amp;&amp; dL&gt;0.0) {
<a name="l00283"></a>00283         <span class="keywordtype">double</span> tmp = 2.0*dF/dL-1.0;
<a name="l00284"></a>00284         mu *= vcl_max(1.0/3.0, 1.0 - tmp*tmp*tmp);
<a name="l00285"></a>00285         nu = 2.0;
<a name="l00286"></a>00286         a.<a class="code" href="classvnl__vector.html#accc324e74774e9bce3bbd152e990a002" title="Set this to that and that to this.">swap</a>(new_a);
<a name="l00287"></a>00287         b.<a class="code" href="classvnl__vector.html#accc324e74774e9bce3bbd152e990a002" title="Set this to that and that to this.">swap</a>(new_b);
<a name="l00288"></a>00288         c.<a class="code" href="classvnl__vector.html#accc324e74774e9bce3bbd152e990a002" title="Set this to that and that to this.">swap</a>(new_c);
<a name="l00289"></a>00289         <a class="code" href="classvnl__sparse__lm.html#a053e7f673f412f8688c7c1586c2771e7">e_</a>.<a class="code" href="classvnl__vector.html#accc324e74774e9bce3bbd152e990a002" title="Set this to that and that to this.">swap</a>(new_e);
<a name="l00290"></a>00290         <a class="code" href="classvnl__sparse__lm.html#a14c1e13c711588df3e1363c707a3e9e2">weights_</a>.<a class="code" href="classvnl__vector.html#accc324e74774e9bce3bbd152e990a002" title="Set this to that and that to this.">swap</a>(new_weights);
<a name="l00291"></a>00291         sqr_error = new_sqr_error;
<a name="l00292"></a>00292         <span class="keywordflow">break</span>;
<a name="l00293"></a>00293       }
<a name="l00294"></a>00294 
<a name="l00295"></a>00295       mu *= nu;
<a name="l00296"></a>00296       nu *= 2.0;
<a name="l00297"></a>00297 
<a name="l00298"></a>00298       <span class="keywordflow">if</span> (<a class="code" href="classvnl__nonlinear__minimizer.html#a6384f8c4bfa01f6ac48959cf34825623">verbose_</a>)
<a name="l00299"></a>00299         vcl_cout &lt;&lt;<span class="stringliteral">&quot;               RMS error = &quot;</span>&lt;&lt; vcl_setprecision(6)
<a name="l00300"></a>00300                  &lt;&lt; vcl_setw(12) &lt;&lt; vcl_sqrt(sqr_error/<a class="code" href="classvnl__sparse__lm.html#a053e7f673f412f8688c7c1586c2771e7">e_</a>.<a class="code" href="classvnl__vector.html#a11191c91a1dbb4e1d8423dad8b110712" title="Return the length, number of elements, dimension of this vector.">size</a>())
<a name="l00301"></a>00301                  &lt;&lt; <span class="stringliteral">&quot; mu = &quot;</span> &lt;&lt; vcl_setprecision(6) &lt;&lt; vcl_setw(12) &lt;&lt; mu
<a name="l00302"></a>00302                  &lt;&lt; <span class="stringliteral">&quot; nu = &quot;</span> &lt;&lt; nu &lt;&lt; vcl_endl;
<a name="l00303"></a>00303     }
<a name="l00304"></a>00304   }
<a name="l00305"></a>00305 
<a name="l00306"></a>00306 
<a name="l00307"></a>00307   <a class="code" href="classvnl__nonlinear__minimizer.html#a134feaa367bb5d8303bb70aca6e8f00c">end_error_</a> = vcl_sqrt(sqr_error/<a class="code" href="classvnl__sparse__lm.html#a053e7f673f412f8688c7c1586c2771e7">e_</a>.<a class="code" href="classvnl__vector.html#a11191c91a1dbb4e1d8423dad8b110712" title="Return the length, number of elements, dimension of this vector.">size</a>()); <span class="comment">// RMS error</span>
<a name="l00308"></a>00308 
<a name="l00309"></a>00309   <span class="keywordflow">if</span> ((<span class="keywordtype">int</span>)<a class="code" href="classvnl__nonlinear__minimizer.html#a1bd527616499cd8eaddbd6fe36d4cfa1">num_iterations_</a> &gt;= <a class="code" href="classvnl__nonlinear__minimizer.html#a875dd6fa5b2f3e2188abff6ecd021981" title="Termination maximum number of iterations.">maxfev</a>) {
<a name="l00310"></a>00310     <a class="code" href="classvnl__nonlinear__minimizer.html#a0c15383c3526f88012364ac342d6e7d7">failure_code_</a> = <a class="code" href="classvnl__nonlinear__minimizer.html#a6112004b90f040a90efeebe19286b908ab96caea98f532ef40b8b4d1719efd500">TOO_MANY_ITERATIONS</a>;
<a name="l00311"></a>00311   }
<a name="l00312"></a>00312 
<a name="l00313"></a>00313   <span class="comment">// Translate status code</span>
<a name="l00314"></a>00314   <span class="keywordflow">switch</span> (<a class="code" href="classvnl__nonlinear__minimizer.html#a0c15383c3526f88012364ac342d6e7d7">failure_code_</a>) {
<a name="l00315"></a>00315    <span class="keywordflow">case</span> <a class="code" href="classvnl__nonlinear__minimizer.html#a6112004b90f040a90efeebe19286b908ad7c4949b13390c394061145b8f9078e7">CONVERGED_FTOL</a>:
<a name="l00316"></a>00316    <span class="keywordflow">case</span> <a class="code" href="classvnl__nonlinear__minimizer.html#a6112004b90f040a90efeebe19286b908a45319c33b31daf7aaa90b164415fcb66">CONVERGED_XTOL</a>:
<a name="l00317"></a>00317    <span class="keywordflow">case</span> <a class="code" href="classvnl__nonlinear__minimizer.html#a6112004b90f040a90efeebe19286b908a4d4ae707861a7141868138d75377cd9c">CONVERGED_XFTOL</a>:
<a name="l00318"></a>00318    <span class="keywordflow">case</span> <a class="code" href="classvnl__nonlinear__minimizer.html#a6112004b90f040a90efeebe19286b908abd24866909de4210cf14099817595a9a">CONVERGED_GTOL</a>:
<a name="l00319"></a>00319     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00320"></a>00320    <span class="keywordflow">default</span>:
<a name="l00321"></a>00321     <a class="code" href="classvnl__sparse__lm.html#a4742ac8ed969b666f7ddf875a5ae84ed" title="Provide an ASCII diagnosis of the last minimization on vcl_ostream.">diagnose_outcome</a>();
<a name="l00322"></a>00322     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00323"></a>00323   }
<a name="l00324"></a>00324 }
<a name="l00325"></a>00325 
<a name="l00326"></a>00326 
<a name="l00327"></a><a class="code" href="classvnl__sparse__lm.html#af3eead72590fc5a52aba157103aa83d7">00327</a> <span class="comment">//: check vector sizes and verify that they match the problem size</span>
<a name="l00328"></a>00328 <span class="keywordtype">bool</span> <a class="code" href="classvnl__sparse__lm.html#af3eead72590fc5a52aba157103aa83d7" title="check vector sizes and verify that they match the problem size.">vnl_sparse_lm::check_vector_sizes</a>(<a class="code" href="classvnl__vector.html">vnl_vector&lt;double&gt;</a> <span class="keyword">const</span>&amp; a,
<a name="l00329"></a>00329                                        <a class="code" href="classvnl__vector.html">vnl_vector&lt;double&gt;</a> <span class="keyword">const</span>&amp; b,
<a name="l00330"></a>00330                                        <a class="code" href="classvnl__vector.html">vnl_vector&lt;double&gt;</a> <span class="keyword">const</span>&amp; c)
<a name="l00331"></a>00331 {
<a name="l00332"></a>00332   <span class="keywordflow">if</span> (<a class="code" href="classvnl__sparse__lm.html#af394ea4fb570100da9aca72c112d617d">size_a_</a>+<a class="code" href="classvnl__sparse__lm.html#a45d95f1d6e79b3d0bf258a7304190861">size_b_</a> &gt; <a class="code" href="classvnl__sparse__lm.html#aec6aedb4ee2dc991d46be8ec36920d88">size_e_</a>) {
<a name="l00333"></a>00333     vcl_cerr &lt;&lt; <span class="stringliteral">&quot;vnl_sparse_lm: Number of unknowns(&quot;</span>&lt;&lt;<a class="code" href="classvnl__sparse__lm.html#af394ea4fb570100da9aca72c112d617d">size_a_</a>+<a class="code" href="classvnl__sparse__lm.html#a45d95f1d6e79b3d0bf258a7304190861">size_b_</a>&lt;&lt;<span class="charliteral">&#39;)&#39;</span>
<a name="l00334"></a>00334              &lt;&lt; <span class="stringliteral">&quot; greater than number of data (&quot;</span>&lt;&lt;<a class="code" href="classvnl__sparse__lm.html#aec6aedb4ee2dc991d46be8ec36920d88">size_e_</a>&lt;&lt;<span class="stringliteral">&quot;)\n&quot;</span>;
<a name="l00335"></a>00335     <a class="code" href="classvnl__nonlinear__minimizer.html#a0c15383c3526f88012364ac342d6e7d7">failure_code_</a> = <a class="code" href="classvnl__nonlinear__minimizer.html#a6112004b90f040a90efeebe19286b908acc184b89d8bfed731cac2ed6456cc4ce">ERROR_DODGY_INPUT</a>;
<a name="l00336"></a>00336     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00337"></a>00337   }
<a name="l00338"></a>00338 
<a name="l00339"></a>00339   <span class="keywordflow">if</span> (<span class="keywordtype">int</span>(a.<a class="code" href="classvnl__vector.html#a11191c91a1dbb4e1d8423dad8b110712" title="Return the length, number of elements, dimension of this vector.">size</a>()) != <a class="code" href="classvnl__sparse__lm.html#af394ea4fb570100da9aca72c112d617d">size_a_</a>) {
<a name="l00340"></a>00340     vcl_cerr &lt;&lt; <span class="stringliteral">&quot;vnl_sparse_lm: Input vector \&quot;a\&quot; length (&quot;</span>&lt;&lt;a.<a class="code" href="classvnl__vector.html#a11191c91a1dbb4e1d8423dad8b110712" title="Return the length, number of elements, dimension of this vector.">size</a>()&lt;&lt;<span class="charliteral">&#39;)&#39;</span>
<a name="l00341"></a>00341              &lt;&lt; <span class="stringliteral">&quot; not equal to num parameters in \&quot;a\&quot; (&quot;</span>&lt;&lt;<a class="code" href="classvnl__sparse__lm.html#af394ea4fb570100da9aca72c112d617d">size_a_</a>&lt;&lt;<span class="stringliteral">&quot;)\n&quot;</span>;
<a name="l00342"></a>00342     <a class="code" href="classvnl__nonlinear__minimizer.html#a0c15383c3526f88012364ac342d6e7d7">failure_code_</a> = <a class="code" href="classvnl__nonlinear__minimizer.html#a6112004b90f040a90efeebe19286b908acc184b89d8bfed731cac2ed6456cc4ce">ERROR_DODGY_INPUT</a>;
<a name="l00343"></a>00343     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00344"></a>00344   }
<a name="l00345"></a>00345 
<a name="l00346"></a>00346   <span class="keywordflow">if</span> (<span class="keywordtype">int</span>(b.<a class="code" href="classvnl__vector.html#a11191c91a1dbb4e1d8423dad8b110712" title="Return the length, number of elements, dimension of this vector.">size</a>()) != <a class="code" href="classvnl__sparse__lm.html#a45d95f1d6e79b3d0bf258a7304190861">size_b_</a>) {
<a name="l00347"></a>00347     vcl_cerr &lt;&lt; <span class="stringliteral">&quot;vnl_sparse_lm: Input vector \&quot;b\&quot; length (&quot;</span>&lt;&lt;b.<a class="code" href="classvnl__vector.html#a11191c91a1dbb4e1d8423dad8b110712" title="Return the length, number of elements, dimension of this vector.">size</a>()&lt;&lt;<span class="charliteral">&#39;)&#39;</span>
<a name="l00348"></a>00348              &lt;&lt; <span class="stringliteral">&quot; not equal to num parameters in \&quot;b\&quot; (&quot;</span>&lt;&lt;<a class="code" href="classvnl__sparse__lm.html#a45d95f1d6e79b3d0bf258a7304190861">size_b_</a>&lt;&lt;<span class="stringliteral">&quot;)\n&quot;</span>;
<a name="l00349"></a>00349     <a class="code" href="classvnl__nonlinear__minimizer.html#a0c15383c3526f88012364ac342d6e7d7">failure_code_</a> = <a class="code" href="classvnl__nonlinear__minimizer.html#a6112004b90f040a90efeebe19286b908acc184b89d8bfed731cac2ed6456cc4ce">ERROR_DODGY_INPUT</a>;
<a name="l00350"></a>00350     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00351"></a>00351   }
<a name="l00352"></a>00352 
<a name="l00353"></a>00353   <span class="keywordflow">if</span> (<span class="keywordtype">int</span>(c.<a class="code" href="classvnl__vector.html#a11191c91a1dbb4e1d8423dad8b110712" title="Return the length, number of elements, dimension of this vector.">size</a>()) != <a class="code" href="classvnl__sparse__lm.html#a690f0091a073781a62ff1aa43f7d8894">size_c_</a>) {
<a name="l00354"></a>00354     vcl_cerr &lt;&lt; <span class="stringliteral">&quot;vnl_sparse_lm: Input vector \&quot;c\&quot; length (&quot;</span>&lt;&lt;c.<a class="code" href="classvnl__vector.html#a11191c91a1dbb4e1d8423dad8b110712" title="Return the length, number of elements, dimension of this vector.">size</a>()&lt;&lt;<span class="charliteral">&#39;)&#39;</span>
<a name="l00355"></a>00355              &lt;&lt; <span class="stringliteral">&quot; not equal to num parameters in \&quot;c\&quot; (&quot;</span>&lt;&lt;<a class="code" href="classvnl__sparse__lm.html#a690f0091a073781a62ff1aa43f7d8894">size_c_</a>&lt;&lt;<span class="stringliteral">&quot;)\n&quot;</span>;
<a name="l00356"></a>00356     <a class="code" href="classvnl__nonlinear__minimizer.html#a0c15383c3526f88012364ac342d6e7d7">failure_code_</a> = <a class="code" href="classvnl__nonlinear__minimizer.html#a6112004b90f040a90efeebe19286b908acc184b89d8bfed731cac2ed6456cc4ce">ERROR_DODGY_INPUT</a>;
<a name="l00357"></a>00357     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00358"></a>00358   }
<a name="l00359"></a>00359 
<a name="l00360"></a>00360   <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00361"></a>00361 }
<a name="l00362"></a>00362 
<a name="l00363"></a>00363 
<a name="l00364"></a><a class="code" href="classvnl__sparse__lm.html#a4dc4c30de9607d46012740f2fffd16fe">00364</a> <span class="comment">//: allocate matrix memory by setting all the matrix sizes</span>
<a name="l00365"></a>00365 <span class="keywordtype">void</span> <a class="code" href="classvnl__sparse__lm.html#a4dc4c30de9607d46012740f2fffd16fe" title="allocate matrix memory by setting all the matrix sizes.">vnl_sparse_lm::allocate_matrices</a>()
<a name="l00366"></a>00366 {
<a name="l00367"></a>00367   <span class="comment">// CRS matrix of indices into e, A, B, C, W, Y</span>
<a name="l00368"></a>00368   <span class="keyword">const</span> <a class="code" href="classvnl__crs__index.html" title="Represents the configuration of a sparse matrix but not the data.">vnl_crs_index</a>&amp; crs = <a class="code" href="classvnl__sparse__lm.html#a3173e72fb1678737a0bf8fdccfde103c" title="the function to minimize.">f_</a>-&gt;<a class="code" href="classvnl__sparse__lst__sqr__function.html#a97ed08f452aedd332dc5c866b989f4db" title="Return a const reference to the residual indexer.">residual_indices</a>();
<a name="l00369"></a>00369   <span class="comment">// sparse vector iterator</span>
<a name="l00370"></a>00370   <span class="keyword">typedef</span> vnl_crs_index::sparse_vector::iterator sv_itr;
<a name="l00371"></a>00371 
<a name="l00372"></a>00372   <span class="comment">// Iterate through all i and j to set the size of the matrices and vectors defined above</span>
<a name="l00373"></a>00373   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;<a class="code" href="classvnl__sparse__lm.html#ac60af9d040c144608af84c9ddb9a94d3">num_a_</a>; ++i)
<a name="l00374"></a>00374   {
<a name="l00375"></a>00375     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> ai_size = <a class="code" href="classvnl__sparse__lm.html#a3173e72fb1678737a0bf8fdccfde103c" title="the function to minimize.">f_</a>-&gt;<a class="code" href="classvnl__sparse__lst__sqr__function.html#aa650f3c88ffb9139d6ddcc8f92df95fb" title="Return the number of parameters of a_j.">number_of_params_a</a>(i);
<a name="l00376"></a>00376     <a class="code" href="classvnl__sparse__lm.html#a187c9fd3b1373dc3f836b0b0beb24677" title="Storage for normal equation blocks.">U_</a>[i].set_size(ai_size,ai_size);
<a name="l00377"></a>00377     <a class="code" href="classvnl__sparse__lm.html#a72f8bd531b42be2754499dc67f27e583">Q_</a>[i].set_size(<a class="code" href="classvnl__sparse__lm.html#a690f0091a073781a62ff1aa43f7d8894">size_c_</a>, ai_size);
<a name="l00378"></a>00378     <a class="code" href="classvnl__sparse__lm.html#a1ee20a7a17bcd1ddd07ad474ae3529df">Z_</a>[i].set_size(<a class="code" href="classvnl__sparse__lm.html#a690f0091a073781a62ff1aa43f7d8894">size_c_</a>, ai_size);
<a name="l00379"></a>00379     <a class="code" href="classvnl__sparse__lm.html#a55e185bd955e49034e4d08b20817706a">Ma_</a>[i].set_size(<a class="code" href="classvnl__sparse__lm.html#a690f0091a073781a62ff1aa43f7d8894">size_c_</a>, ai_size);
<a name="l00380"></a>00380 
<a name="l00381"></a>00381     <a class="code" href="classvnl__crs__index.html#a015af1612c1409408234e2b9c7771ba2">vnl_crs_index::sparse_vector</a> row = crs.<a class="code" href="classvnl__crs__index.html#a1d1773106f6efda2257dc21f95d3a13c" title="returns row i as a vector of index-column pairs.">sparse_row</a>(i);
<a name="l00382"></a>00382     <span class="keywordflow">for</span> (sv_itr r_itr=row.begin(); r_itr!=row.end(); ++r_itr)
<a name="l00383"></a>00383     {
<a name="l00384"></a>00384       <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j = r_itr-&gt;second;
<a name="l00385"></a>00385       <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> k = r_itr-&gt;first;
<a name="l00386"></a>00386       <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> bj_size = <a class="code" href="classvnl__sparse__lm.html#a3173e72fb1678737a0bf8fdccfde103c" title="the function to minimize.">f_</a>-&gt;<a class="code" href="classvnl__sparse__lst__sqr__function.html#a2dd2b63684e8e57d9251301f236e77eb" title="Return the number of parameters of b_i.">number_of_params_b</a>(j);
<a name="l00387"></a>00387       <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> eij_size = <a class="code" href="classvnl__sparse__lm.html#a3173e72fb1678737a0bf8fdccfde103c" title="the function to minimize.">f_</a>-&gt;<a class="code" href="classvnl__sparse__lst__sqr__function.html#a9a28f2234d336f4b07947b8f073f3fb9" title="Return the number of residuals in the kth residual vector.">number_of_residuals</a>(k);
<a name="l00388"></a>00388       <a class="code" href="classvnl__sparse__lm.html#a9483ec57eb8c890e3f2c106fcec0a599" title="Storage for each of the Jacobians A_ij, B_ij, and C_ij.">A_</a>[k].set_size(eij_size, ai_size);
<a name="l00389"></a>00389       <a class="code" href="classvnl__sparse__lm.html#aa7486837e098103b25747e770c0986ab">B_</a>[k].set_size(eij_size, bj_size);
<a name="l00390"></a>00390       <a class="code" href="classvnl__sparse__lm.html#ac859cfa259b0f356e60b43d441f35d81">C_</a>[k].set_size(eij_size, <a class="code" href="classvnl__sparse__lm.html#a690f0091a073781a62ff1aa43f7d8894">size_c_</a>);
<a name="l00391"></a>00391       <a class="code" href="classvnl__sparse__lm.html#acc9c39c805c7e4443a31586d8a736bfd">W_</a>[k].set_size(ai_size, bj_size);
<a name="l00392"></a>00392       <a class="code" href="classvnl__sparse__lm.html#a45932b1af4d09bef9df4ae3a02249d99">Y_</a>[k].set_size(ai_size, bj_size);
<a name="l00393"></a>00393     }
<a name="l00394"></a>00394   }
<a name="l00395"></a>00395   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j=0; j&lt;<a class="code" href="classvnl__sparse__lm.html#a6c7f69c6c648a732f019ca5057750779">num_b_</a>; ++j)
<a name="l00396"></a>00396   {
<a name="l00397"></a>00397     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> bj_size = <a class="code" href="classvnl__sparse__lm.html#a3173e72fb1678737a0bf8fdccfde103c" title="the function to minimize.">f_</a>-&gt;<a class="code" href="classvnl__sparse__lst__sqr__function.html#a2dd2b63684e8e57d9251301f236e77eb" title="Return the number of parameters of b_i.">number_of_params_b</a>(j);
<a name="l00398"></a>00398     <a class="code" href="classvnl__sparse__lm.html#a943e65a1486c8ade735deafd57ea6e24">V_</a>[j].set_size(bj_size,bj_size);
<a name="l00399"></a>00399     <a class="code" href="classvnl__sparse__lm.html#a397485b9f5ddbe5ae6972eb0b53238c9">R_</a>[j].set_size(<a class="code" href="classvnl__sparse__lm.html#a690f0091a073781a62ff1aa43f7d8894">size_c_</a>, bj_size);
<a name="l00400"></a>00400     <a class="code" href="classvnl__sparse__lm.html#a90ff71c732175c7d4656ea9ba2efba8a">Mb_</a>[j].set_size(<a class="code" href="classvnl__sparse__lm.html#a690f0091a073781a62ff1aa43f7d8894">size_c_</a>, bj_size);
<a name="l00401"></a>00401     <a class="code" href="classvnl__sparse__lm.html#a82109a87fb505fab059aa50185be70a6">inv_V_</a>[j].set_size(bj_size,bj_size);
<a name="l00402"></a>00402   }
<a name="l00403"></a>00403 }
<a name="l00404"></a>00404 
<a name="l00405"></a>00405 
<a name="l00406"></a><a class="code" href="classvnl__sparse__lm.html#af7a849f471e60d63260eb6685730ada0">00406</a> <span class="comment">//: compute the blocks making up the the normal equations: Jt J d = Jt e</span>
<a name="l00407"></a>00407 <span class="keywordtype">void</span> <a class="code" href="classvnl__sparse__lm.html#af7a849f471e60d63260eb6685730ada0" title="compute the blocks making up the the normal equations: Jt J d = Jt e.">vnl_sparse_lm::compute_normal_equations</a>()
<a name="l00408"></a>00408 {
<a name="l00409"></a>00409   <span class="comment">// CRS matrix of indices into e, A, B, C, W, Y</span>
<a name="l00410"></a>00410   <span class="keyword">const</span> <a class="code" href="classvnl__crs__index.html" title="Represents the configuration of a sparse matrix but not the data.">vnl_crs_index</a>&amp; crs = <a class="code" href="classvnl__sparse__lm.html#a3173e72fb1678737a0bf8fdccfde103c" title="the function to minimize.">f_</a>-&gt;<a class="code" href="classvnl__sparse__lst__sqr__function.html#a97ed08f452aedd332dc5c866b989f4db" title="Return a const reference to the residual indexer.">residual_indices</a>();
<a name="l00411"></a>00411   <span class="comment">// sparse vector iterator</span>
<a name="l00412"></a>00412   <span class="keyword">typedef</span> vnl_crs_index::sparse_vector::iterator sv_itr;
<a name="l00413"></a>00413 
<a name="l00414"></a>00414   <span class="comment">// clear the ea and eb for summation</span>
<a name="l00415"></a>00415   <a class="code" href="classvnl__sparse__lm.html#a507a409cc6e7239b031ef0209f76be19">ea_</a>.<a class="code" href="classvnl__vector.html#a9939177982a578e13b05cc5e80f96a14" title="Set all values to v.">fill</a>(0.0);
<a name="l00416"></a>00416   <a class="code" href="classvnl__sparse__lm.html#a651698a11965625028830139eb344df0">eb_</a>.<a class="code" href="classvnl__vector.html#a9939177982a578e13b05cc5e80f96a14" title="Set all values to v.">fill</a>(0.0);
<a name="l00417"></a>00417   <a class="code" href="classvnl__sparse__lm.html#a6220c7736d7e8fcdfc002e2d41219c8b">ec_</a>.<a class="code" href="classvnl__vector.html#a9939177982a578e13b05cc5e80f96a14" title="Set all values to v.">fill</a>(0.0);
<a name="l00418"></a>00418   <span class="comment">// clear the V for summation</span>
<a name="l00419"></a>00419   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j=0; j&lt;<a class="code" href="classvnl__sparse__lm.html#a3173e72fb1678737a0bf8fdccfde103c" title="the function to minimize.">f_</a>-&gt;<a class="code" href="classvnl__sparse__lst__sqr__function.html#a2d05703e2e6d74c664fae276eb36a1cc" title="Return the number of subsets in b.">number_of_b</a>(); ++j)
<a name="l00420"></a>00420   {
<a name="l00421"></a>00421     <a class="code" href="classvnl__sparse__lm.html#a943e65a1486c8ade735deafd57ea6e24">V_</a>[j].fill(0.0);
<a name="l00422"></a>00422     <a class="code" href="classvnl__sparse__lm.html#a397485b9f5ddbe5ae6972eb0b53238c9">R_</a>[j].fill(0.0);
<a name="l00423"></a>00423   }
<a name="l00424"></a>00424   <a class="code" href="classvnl__sparse__lm.html#afa8300c5448b8f66fc2e7ca0f0ee1b39">T_</a>.<a class="code" href="classvnl__matrix.html#a98da5b87fa05cdab4b7b844ddf8a9074" title="Sets all elements of matrix to specified value, and returns &quot;*this&quot;.">fill</a>(0.0);
<a name="l00425"></a>00425   <span class="comment">// compute blocks T, Q, R, U, V, W, ea, eb, and ec</span>
<a name="l00426"></a>00426   <span class="comment">// JtJ = |T  Q  R|</span>
<a name="l00427"></a>00427   <span class="comment">//       |Qt U  W|  with U and V block diagonal</span>
<a name="l00428"></a>00428   <span class="comment">//       |Rt Wt V|  and W with same sparsity as residuals</span>
<a name="l00429"></a>00429   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i=0; i&lt;<a class="code" href="classvnl__sparse__lm.html#a3173e72fb1678737a0bf8fdccfde103c" title="the function to minimize.">f_</a>-&gt;<a class="code" href="classvnl__sparse__lst__sqr__function.html#a428a60bdd3d570cf65830e023098e326" title="Return the number of subsets in a.">number_of_a</a>(); ++i)
<a name="l00430"></a>00430   {
<a name="l00431"></a>00431     <a class="code" href="classvnl__matrix.html">vnl_matrix&lt;double&gt;</a>&amp; Ui = <a class="code" href="classvnl__sparse__lm.html#a187c9fd3b1373dc3f836b0b0beb24677" title="Storage for normal equation blocks.">U_</a>[i];
<a name="l00432"></a>00432     Ui.<a class="code" href="classvnl__matrix.html#a98da5b87fa05cdab4b7b844ddf8a9074" title="Sets all elements of matrix to specified value, and returns &quot;*this&quot;.">fill</a>(0.0);
<a name="l00433"></a>00433     <a class="code" href="classvnl__matrix.html">vnl_matrix&lt;double&gt;</a>&amp; Qi = <a class="code" href="classvnl__sparse__lm.html#a72f8bd531b42be2754499dc67f27e583">Q_</a>[i];
<a name="l00434"></a>00434     Qi.<a class="code" href="classvnl__matrix.html#a98da5b87fa05cdab4b7b844ddf8a9074" title="Sets all elements of matrix to specified value, and returns &quot;*this&quot;.">fill</a>(0.0);
<a name="l00435"></a>00435     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> ai_size = <a class="code" href="classvnl__sparse__lm.html#a3173e72fb1678737a0bf8fdccfde103c" title="the function to minimize.">f_</a>-&gt;<a class="code" href="classvnl__sparse__lst__sqr__function.html#aa650f3c88ffb9139d6ddcc8f92df95fb" title="Return the number of parameters of a_j.">number_of_params_a</a>(i);
<a name="l00436"></a>00436     <a class="code" href="classvnl__vector__ref.html" title="vnl_vector using user-supplied storage.">vnl_vector_ref&lt;double&gt;</a> eai(ai_size, <a class="code" href="classvnl__sparse__lm.html#a507a409cc6e7239b031ef0209f76be19">ea_</a>.<a class="code" href="classvnl__vector.html#a672822d3a059ac09909cb32a7be004a9" title="Access the contiguous block storing the elements in the vector. O(1).">data_block</a>()+<a class="code" href="classvnl__sparse__lm.html#a3173e72fb1678737a0bf8fdccfde103c" title="the function to minimize.">f_</a>-&gt;<a class="code" href="classvnl__sparse__lst__sqr__function.html#a215ac902994bd0298c6cc73f6026759e" title="return the index of aj in a.">index_a</a>(i));
<a name="l00437"></a>00437 
<a name="l00438"></a>00438     <a class="code" href="classvnl__crs__index.html#a015af1612c1409408234e2b9c7771ba2">vnl_crs_index::sparse_vector</a> row = crs.<a class="code" href="classvnl__crs__index.html#a1d1773106f6efda2257dc21f95d3a13c" title="returns row i as a vector of index-column pairs.">sparse_row</a>(i);
<a name="l00439"></a>00439     <span class="keywordflow">for</span> (sv_itr r_itr=row.<a class="code" href="classvnl__vector.html#ade1c94ab8d54075269ef09d38e38b33b" title="Iterator pointing to start of data.">begin</a>(); r_itr!=row.<a class="code" href="classvnl__vector.html#a49d0ea4f1e8825378c8adfec7de3c863" title="Iterator pointing to element beyond end of data.">end</a>(); ++r_itr)
<a name="l00440"></a>00440     {
<a name="l00441"></a>00441       <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j = r_itr-&gt;second;
<a name="l00442"></a>00442       <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> k = r_itr-&gt;first;;
<a name="l00443"></a>00443       <a class="code" href="classvnl__matrix.html">vnl_matrix&lt;double&gt;</a>&amp; Aij = <a class="code" href="classvnl__sparse__lm.html#a9483ec57eb8c890e3f2c106fcec0a599" title="Storage for each of the Jacobians A_ij, B_ij, and C_ij.">A_</a>[k];
<a name="l00444"></a>00444       <a class="code" href="classvnl__matrix.html">vnl_matrix&lt;double&gt;</a>&amp; Bij = <a class="code" href="classvnl__sparse__lm.html#aa7486837e098103b25747e770c0986ab">B_</a>[k];
<a name="l00445"></a>00445       <a class="code" href="classvnl__matrix.html">vnl_matrix&lt;double&gt;</a>&amp; Cij = <a class="code" href="classvnl__sparse__lm.html#ac859cfa259b0f356e60b43d441f35d81">C_</a>[k];
<a name="l00446"></a>00446       <a class="code" href="classvnl__matrix.html">vnl_matrix&lt;double&gt;</a>&amp; Vj = <a class="code" href="classvnl__sparse__lm.html#a943e65a1486c8ade735deafd57ea6e24">V_</a>[j];
<a name="l00447"></a>00447       <a class="code" href="classvnl__matrix.html">vnl_matrix&lt;double&gt;</a>&amp; Rj = <a class="code" href="classvnl__sparse__lm.html#a397485b9f5ddbe5ae6972eb0b53238c9">R_</a>[j];
<a name="l00448"></a>00448       <a class="code" href="classvnl__vector__ref.html" title="vnl_vector using user-supplied storage.">vnl_vector_ref&lt;double&gt;</a> ebj(Bij.<a class="code" href="classvnl__matrix.html#a4d3c7b58bf1dd7325262a2f6e4e57867" title="Return number of columns.">cols</a>(), <a class="code" href="classvnl__sparse__lm.html#a651698a11965625028830139eb344df0">eb_</a>.<a class="code" href="classvnl__vector.html#a672822d3a059ac09909cb32a7be004a9" title="Access the contiguous block storing the elements in the vector. O(1).">data_block</a>()+<a class="code" href="classvnl__sparse__lm.html#a3173e72fb1678737a0bf8fdccfde103c" title="the function to minimize.">f_</a>-&gt;<a class="code" href="classvnl__sparse__lst__sqr__function.html#a74039f92584458ff8c467f527040d452" title="return the index of bj in b.">index_b</a>(j));
<a name="l00449"></a>00449 
<a name="l00450"></a>00450       <a class="code" href="classvnl__fastops.html#a38c8d3735a9a8da5212d537f128191e8" title="Compute $ X += A^ A$.">vnl_fastops::inc_X_by_AtA</a>(<a class="code" href="classvnl__sparse__lm.html#afa8300c5448b8f66fc2e7ca0f0ee1b39">T_</a>, Cij);       <span class="comment">// T = C^T * C</span>
<a name="l00451"></a>00451       vnl_fastops::inc_X_by_AtA(Ui,Aij);       <span class="comment">// Ui += A_ij^T * A_ij</span>
<a name="l00452"></a>00452       vnl_fastops::inc_X_by_AtA(Vj,Bij);       <span class="comment">// Vj += B_ij^T * B_ij</span>
<a name="l00453"></a>00453       <a class="code" href="classvnl__fastops.html#af29023254826e7b5e2e360bcdc280a6a" title="Compute $A^ B$.">vnl_fastops::AtB</a>(<a class="code" href="classvnl__sparse__lm.html#acc9c39c805c7e4443a31586d8a736bfd">W_</a>[k],Aij,Bij);          <span class="comment">// Wij = A_ij^T * B_ij</span>
<a name="l00454"></a>00454       <a class="code" href="classvnl__fastops.html#a9f4c2d9fcd39acd0806a202a527a21f4" title="Compute $X += A^ B$.">vnl_fastops::inc_X_by_AtB</a>(Qi,Cij,Aij);   <span class="comment">// Qi += C_ij^T * A_ij</span>
<a name="l00455"></a>00455       <a class="code" href="classvnl__fastops.html#a9f4c2d9fcd39acd0806a202a527a21f4" title="Compute $X += A^ B$.">vnl_fastops::inc_X_by_AtB</a>(Rj,Cij,Bij);   <span class="comment">// Rj += C_ij^T * B_ij</span>
<a name="l00456"></a>00456 
<a name="l00457"></a>00457       <a class="code" href="classvnl__vector__ref.html" title="vnl_vector using user-supplied storage.">vnl_vector_ref&lt;double&gt;</a> eij(<a class="code" href="classvnl__sparse__lm.html#a3173e72fb1678737a0bf8fdccfde103c" title="the function to minimize.">f_</a>-&gt;<a class="code" href="classvnl__sparse__lst__sqr__function.html#a9a28f2234d336f4b07947b8f073f3fb9" title="Return the number of residuals in the kth residual vector.">number_of_residuals</a>(k), <a class="code" href="classvnl__sparse__lm.html#a053e7f673f412f8688c7c1586c2771e7">e_</a>.<a class="code" href="classvnl__vector.html#a672822d3a059ac09909cb32a7be004a9" title="Access the contiguous block storing the elements in the vector. O(1).">data_block</a>()+<a class="code" href="classvnl__sparse__lm.html#a3173e72fb1678737a0bf8fdccfde103c" title="the function to minimize.">f_</a>-&gt;<a class="code" href="classvnl__sparse__lst__sqr__function.html#a2c743c05572c84195e9228e7ce60cc1c" title="return the index of ek in e.">index_e</a>(k));
<a name="l00458"></a>00458       <a class="code" href="classvnl__fastops.html#a9f4c2d9fcd39acd0806a202a527a21f4" title="Compute $X += A^ B$.">vnl_fastops::inc_X_by_AtB</a>(eai,Aij,eij);  <span class="comment">// e_a_i += A_ij^T * e_ij</span>
<a name="l00459"></a>00459       vnl_fastops::inc_X_by_AtB(ebj,Bij,eij);  <span class="comment">// e_b_j += B_ij^T * e_ij</span>
<a name="l00460"></a>00460       vnl_fastops::inc_X_by_AtB(<a class="code" href="classvnl__sparse__lm.html#a6220c7736d7e8fcdfc002e2d41219c8b">ec_</a>,Cij,eij);   <span class="comment">// e_c   += C_ij^T * e_ij</span>
<a name="l00461"></a>00461     }
<a name="l00462"></a>00462   }
<a name="l00463"></a>00463 }
<a name="l00464"></a>00464 
<a name="l00465"></a>00465 
<a name="l00466"></a><a class="code" href="classvnl__sparse__lm.html#a8bf228ebd7b3b5ace2b2b4f616add68a">00466</a> <span class="comment">//: extract the vector on the diagonal of Jt J</span>
<a name="l00467"></a>00467 <a class="code" href="classvnl__vector.html">vnl_vector&lt;double&gt;</a> <a class="code" href="classvnl__sparse__lm.html#a8bf228ebd7b3b5ace2b2b4f616add68a" title="extract the vector on the diagonal of Jt J.">vnl_sparse_lm::extract_diagonal</a>()<span class="keyword"> const</span>
<a name="l00468"></a>00468 <span class="keyword"></span>{
<a name="l00469"></a>00469   <span class="comment">// Extract the diagonal of J^T*J as a vector</span>
<a name="l00470"></a>00470   <a class="code" href="classvnl__vector.html">vnl_vector&lt;double&gt;</a> diag_UVT(<a class="code" href="classvnl__sparse__lm.html#af394ea4fb570100da9aca72c112d617d">size_a_</a>+<a class="code" href="classvnl__sparse__lm.html#a45d95f1d6e79b3d0bf258a7304190861">size_b_</a>+<a class="code" href="classvnl__sparse__lm.html#a690f0091a073781a62ff1aa43f7d8894">size_c_</a>);
<a name="l00471"></a>00471   <span class="keywordtype">int</span> z = 0;
<a name="l00472"></a>00472   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;<a class="code" href="classvnl__sparse__lm.html#ac60af9d040c144608af84c9ddb9a94d3">num_a_</a>; ++i) {
<a name="l00473"></a>00473     <span class="keyword">const</span> <a class="code" href="classvnl__matrix.html">vnl_matrix&lt;double&gt;</a>&amp; Ui = <a class="code" href="classvnl__sparse__lm.html#a187c9fd3b1373dc3f836b0b0beb24677" title="Storage for normal equation blocks.">U_</a>[i];
<a name="l00474"></a>00474     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> ii=0; ii&lt;Ui.<a class="code" href="classvnl__matrix.html#a840b1c4c74689f19b0496d476c5cc2d7" title="Return number of rows.">rows</a>(); ++ii)
<a name="l00475"></a>00475       diag_UVT[z++] = Ui(ii,ii);
<a name="l00476"></a>00476   }
<a name="l00477"></a>00477   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j=0; j&lt;<a class="code" href="classvnl__sparse__lm.html#a6c7f69c6c648a732f019ca5057750779">num_b_</a>; ++j) {
<a name="l00478"></a>00478     <span class="keyword">const</span> <a class="code" href="classvnl__matrix.html">vnl_matrix&lt;double&gt;</a>&amp; Vj = <a class="code" href="classvnl__sparse__lm.html#a943e65a1486c8ade735deafd57ea6e24">V_</a>[j];
<a name="l00479"></a>00479     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> ii=0; ii&lt;Vj.<a class="code" href="classvnl__matrix.html#a840b1c4c74689f19b0496d476c5cc2d7" title="Return number of rows.">rows</a>(); ++ii)
<a name="l00480"></a>00480       diag_UVT[z++] = Vj(ii,ii);
<a name="l00481"></a>00481   }
<a name="l00482"></a>00482   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> ii=0; ii&lt;<a class="code" href="classvnl__sparse__lm.html#a690f0091a073781a62ff1aa43f7d8894">size_c_</a>; ++ii)
<a name="l00483"></a>00483     diag_UVT[z++] = <a class="code" href="classvnl__sparse__lm.html#afa8300c5448b8f66fc2e7ca0f0ee1b39">T_</a>(ii,ii);
<a name="l00484"></a>00484 
<a name="l00485"></a>00485   <span class="keywordflow">return</span> diag_UVT;
<a name="l00486"></a>00486 }
<a name="l00487"></a>00487 
<a name="l00488"></a>00488 
<a name="l00489"></a><a class="code" href="classvnl__sparse__lm.html#a2e1103f1a563d7655837ef3fc1824ed6">00489</a> <span class="comment">//: set the vector on the diagonal of Jt J</span>
<a name="l00490"></a>00490 <span class="keywordtype">void</span> <a class="code" href="classvnl__sparse__lm.html#a2e1103f1a563d7655837ef3fc1824ed6" title="set the vector on the diagonal of Jt J.">vnl_sparse_lm::set_diagonal</a>(<span class="keyword">const</span> <a class="code" href="classvnl__vector.html">vnl_vector&lt;double&gt;</a>&amp; diag)
<a name="l00491"></a>00491 {
<a name="l00492"></a>00492   <span class="keywordtype">int</span> z=0;
<a name="l00493"></a>00493   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;<a class="code" href="classvnl__sparse__lm.html#ac60af9d040c144608af84c9ddb9a94d3">num_a_</a>; ++i) {
<a name="l00494"></a>00494     <a class="code" href="classvnl__matrix.html">vnl_matrix&lt;double&gt;</a>&amp; Ui = <a class="code" href="classvnl__sparse__lm.html#a187c9fd3b1373dc3f836b0b0beb24677" title="Storage for normal equation blocks.">U_</a>[i];
<a name="l00495"></a>00495     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> ii=0; ii&lt;Ui.<a class="code" href="classvnl__matrix.html#a840b1c4c74689f19b0496d476c5cc2d7" title="Return number of rows.">rows</a>(); ++ii)
<a name="l00496"></a>00496       Ui(ii,ii) = diag[z++];
<a name="l00497"></a>00497   }
<a name="l00498"></a>00498   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j=0; j&lt;<a class="code" href="classvnl__sparse__lm.html#a6c7f69c6c648a732f019ca5057750779">num_b_</a>; ++j) {
<a name="l00499"></a>00499     <a class="code" href="classvnl__matrix.html">vnl_matrix&lt;double&gt;</a>&amp; Vj = <a class="code" href="classvnl__sparse__lm.html#a943e65a1486c8ade735deafd57ea6e24">V_</a>[j];
<a name="l00500"></a>00500     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> ii=0; ii&lt;Vj.<a class="code" href="classvnl__matrix.html#a840b1c4c74689f19b0496d476c5cc2d7" title="Return number of rows.">rows</a>(); ++ii)
<a name="l00501"></a>00501       Vj(ii,ii) = diag[z++];
<a name="l00502"></a>00502   }
<a name="l00503"></a>00503   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> ii=0; ii&lt;<a class="code" href="classvnl__sparse__lm.html#a690f0091a073781a62ff1aa43f7d8894">size_c_</a>; ++ii)
<a name="l00504"></a>00504     <a class="code" href="classvnl__sparse__lm.html#afa8300c5448b8f66fc2e7ca0f0ee1b39">T_</a>(ii,ii) = diag[z++];
<a name="l00505"></a>00505 }
<a name="l00506"></a>00506 
<a name="l00507"></a>00507 
<a name="l00508"></a><a class="code" href="classvnl__sparse__lm.html#adbe55fe4063a89ec1a788f31b6f58db7">00508</a> <span class="comment">//: compute all inv(Vi) and Yij</span>
<a name="l00509"></a>00509 <span class="keywordtype">void</span> <a class="code" href="classvnl__sparse__lm.html#adbe55fe4063a89ec1a788f31b6f58db7" title="compute all inv(Vi) and Yij.">vnl_sparse_lm::compute_invV_Y</a>()
<a name="l00510"></a>00510 {
<a name="l00511"></a>00511   <span class="comment">// CRS matrix of indices into e, A, B, C, W, Y</span>
<a name="l00512"></a>00512   <span class="keyword">const</span> <a class="code" href="classvnl__crs__index.html" title="Represents the configuration of a sparse matrix but not the data.">vnl_crs_index</a>&amp; crs = <a class="code" href="classvnl__sparse__lm.html#a3173e72fb1678737a0bf8fdccfde103c" title="the function to minimize.">f_</a>-&gt;<a class="code" href="classvnl__sparse__lst__sqr__function.html#a97ed08f452aedd332dc5c866b989f4db" title="Return a const reference to the residual indexer.">residual_indices</a>();
<a name="l00513"></a>00513   <span class="comment">// sparse vector iterator</span>
<a name="l00514"></a>00514   <span class="keyword">typedef</span> vnl_crs_index::sparse_vector::iterator sv_itr;
<a name="l00515"></a>00515 
<a name="l00516"></a>00516   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j=0; j&lt;<a class="code" href="classvnl__sparse__lm.html#a6c7f69c6c648a732f019ca5057750779">num_b_</a>; ++j) {
<a name="l00517"></a>00517     <a class="code" href="classvnl__matrix.html">vnl_matrix&lt;double&gt;</a>&amp; inv_Vj = <a class="code" href="classvnl__sparse__lm.html#a82109a87fb505fab059aa50185be70a6">inv_V_</a>[j];
<a name="l00518"></a>00518     <a class="code" href="classvnl__cholesky.html" title="Decomposition of symmetric matrix.">vnl_cholesky</a> Vj_cholesky(<a class="code" href="classvnl__sparse__lm.html#a943e65a1486c8ade735deafd57ea6e24">V_</a>[j],<a class="code" href="classvnl__cholesky.html#aaabc2110e510ffa1417a657cbef99efca6ae23c768b154f5a2f128caa4fe05350">vnl_cholesky::quiet</a>);
<a name="l00519"></a>00519     <span class="comment">// use SVD as a backup if Cholesky is deficient</span>
<a name="l00520"></a>00520     <span class="keywordflow">if</span> ( Vj_cholesky.<a class="code" href="classvnl__cholesky.html#ade6855bf36ca3b97e79cbf04ee289977" title="A Success/failure flag.">rank_deficiency</a>() &gt; 0 )
<a name="l00521"></a>00521     {
<a name="l00522"></a>00522       <a class="code" href="classvnl__svd.html" title="Holds the singular value decomposition of a vnl_matrix.">vnl_svd&lt;double&gt;</a> Vj_svd(<a class="code" href="classvnl__sparse__lm.html#a943e65a1486c8ade735deafd57ea6e24">V_</a>[j]);
<a name="l00523"></a>00523       inv_Vj = Vj_svd.<a class="code" href="classvnl__svd.html#aca07308f7241e6a981813dddb8a8d3cb">inverse</a>();
<a name="l00524"></a>00524     }
<a name="l00525"></a>00525     <span class="keywordflow">else</span>
<a name="l00526"></a>00526       inv_Vj = Vj_cholesky.<a class="code" href="classvnl__cholesky.html#a6989e61544e1f0a6f5cb304eae762f38">inverse</a>();
<a name="l00527"></a>00527 
<a name="l00528"></a>00528     <a class="code" href="classvnl__crs__index.html#a015af1612c1409408234e2b9c7771ba2">vnl_crs_index::sparse_vector</a> col = crs.<a class="code" href="classvnl__crs__index.html#a716e60963809d8876f7a69f8d2c65ef3" title="returns column j as a vector of index-row pairs.">sparse_col</a>(j);
<a name="l00529"></a>00529     <span class="keywordflow">for</span> (sv_itr c_itr=col.begin(); c_itr!=col.end(); ++c_itr)
<a name="l00530"></a>00530     {
<a name="l00531"></a>00531       <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> k = c_itr-&gt;first;
<a name="l00532"></a>00532       <a class="code" href="classvnl__sparse__lm.html#a45932b1af4d09bef9df4ae3a02249d99">Y_</a>[k] = <a class="code" href="classvnl__sparse__lm.html#acc9c39c805c7e4443a31586d8a736bfd">W_</a>[k]*inv_Vj;  <span class="comment">// Y_ij = W_ij * inv(V_j)</span>
<a name="l00533"></a>00533     }
<a name="l00534"></a>00534   }
<a name="l00535"></a>00535 }
<a name="l00536"></a>00536 
<a name="l00537"></a>00537 
<a name="l00538"></a><a class="code" href="classvnl__sparse__lm.html#a3e870c2360c836c064a33a7285aefedf">00538</a> <span class="comment">// compute Z and Sa</span>
<a name="l00539"></a>00539 <span class="keywordtype">void</span> <a class="code" href="classvnl__sparse__lm.html#a3e870c2360c836c064a33a7285aefedf" title="compute Z and Sa.">vnl_sparse_lm::compute_Z_Sa</a>(<a class="code" href="classvnl__matrix.html">vnl_matrix&lt;double&gt;</a>&amp; Sa)
<a name="l00540"></a>00540 {
<a name="l00541"></a>00541   <span class="comment">// CRS matrix of indices into e, A, B, C, W, Y</span>
<a name="l00542"></a>00542   <span class="keyword">const</span> <a class="code" href="classvnl__crs__index.html" title="Represents the configuration of a sparse matrix but not the data.">vnl_crs_index</a>&amp; crs = <a class="code" href="classvnl__sparse__lm.html#a3173e72fb1678737a0bf8fdccfde103c" title="the function to minimize.">f_</a>-&gt;<a class="code" href="classvnl__sparse__lst__sqr__function.html#a97ed08f452aedd332dc5c866b989f4db" title="Return a const reference to the residual indexer.">residual_indices</a>();
<a name="l00543"></a>00543   <span class="comment">// sparse vector iterator</span>
<a name="l00544"></a>00544   <span class="keyword">typedef</span> vnl_crs_index::sparse_vector::iterator sv_itr;
<a name="l00545"></a>00545 
<a name="l00546"></a>00546   <span class="comment">// compute Z = RYt-Q and Sa</span>
<a name="l00547"></a>00547   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;<a class="code" href="classvnl__sparse__lm.html#ac60af9d040c144608af84c9ddb9a94d3">num_a_</a>; ++i)
<a name="l00548"></a>00548   {
<a name="l00549"></a>00549     <a class="code" href="classvnl__crs__index.html#a015af1612c1409408234e2b9c7771ba2">vnl_crs_index::sparse_vector</a> row_i = crs.<a class="code" href="classvnl__crs__index.html#a1d1773106f6efda2257dc21f95d3a13c" title="returns row i as a vector of index-column pairs.">sparse_row</a>(i);
<a name="l00550"></a>00550     <a class="code" href="classvnl__matrix.html">vnl_matrix&lt;double&gt;</a>&amp; Zi = <a class="code" href="classvnl__sparse__lm.html#a1ee20a7a17bcd1ddd07ad474ae3529df">Z_</a>[i];
<a name="l00551"></a>00551     Zi.<a class="code" href="classvnl__matrix.html#a98da5b87fa05cdab4b7b844ddf8a9074" title="Sets all elements of matrix to specified value, and returns &quot;*this&quot;.">fill</a>(0.0);
<a name="l00552"></a>00552     Zi -= <a class="code" href="classvnl__sparse__lm.html#a72f8bd531b42be2754499dc67f27e583">Q_</a>[i];
<a name="l00553"></a>00553 
<a name="l00554"></a>00554     <span class="comment">// handle the diagonal blocks separately</span>
<a name="l00555"></a>00555     <a class="code" href="classvnl__matrix.html">vnl_matrix&lt;double&gt;</a> Sii(<a class="code" href="classvnl__sparse__lm.html#a187c9fd3b1373dc3f836b0b0beb24677" title="Storage for normal equation blocks.">U_</a>[i]); <span class="comment">// copy Ui to initialize Sii</span>
<a name="l00556"></a>00556     <span class="keywordflow">for</span> (sv_itr ri = row_i.begin(); ri != row_i.end();  ++ri)
<a name="l00557"></a>00557     {
<a name="l00558"></a>00558       <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j = ri-&gt;second;
<a name="l00559"></a>00559       <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> k = ri-&gt;first;
<a name="l00560"></a>00560       <a class="code" href="classvnl__matrix.html">vnl_matrix&lt;double&gt;</a>&amp; Yij = <a class="code" href="classvnl__sparse__lm.html#a45932b1af4d09bef9df4ae3a02249d99">Y_</a>[k];
<a name="l00561"></a>00561       <a class="code" href="classvnl__fastops.html#a1df9d50cfa9e8192d9149bc33cbb7331" title="Compute $X -= A B^$.">vnl_fastops::dec_X_by_ABt</a>(Sii,Yij,<a class="code" href="classvnl__sparse__lm.html#acc9c39c805c7e4443a31586d8a736bfd">W_</a>[k]); <span class="comment">// S_ii -= Y_ij * W_ij^T</span>
<a name="l00562"></a>00562       <a class="code" href="classvnl__fastops.html#aefd8ad5893975e1dba72b37e6427f252" title="Compute $X += A B^$.">vnl_fastops::inc_X_by_ABt</a>(Zi,<a class="code" href="classvnl__sparse__lm.html#a397485b9f5ddbe5ae6972eb0b53238c9">R_</a>[j],Yij);  <span class="comment">// Z_i  += R_j * Y_ij^T</span>
<a name="l00563"></a>00563     }
<a name="l00564"></a>00564     Sa.<a class="code" href="classvnl__matrix.html#a8a46918b792658fd2032ebf9c2294deb" title="Set values of this matrix to those of M, starting at [top,left].">update</a>(Sii,<a class="code" href="classvnl__sparse__lm.html#a3173e72fb1678737a0bf8fdccfde103c" title="the function to minimize.">f_</a>-&gt;<a class="code" href="classvnl__sparse__lst__sqr__function.html#a215ac902994bd0298c6cc73f6026759e" title="return the index of aj in a.">index_a</a>(i),<a class="code" href="classvnl__sparse__lm.html#a3173e72fb1678737a0bf8fdccfde103c" title="the function to minimize.">f_</a>-&gt;<a class="code" href="classvnl__sparse__lst__sqr__function.html#a215ac902994bd0298c6cc73f6026759e" title="return the index of aj in a.">index_a</a>(i));
<a name="l00565"></a>00565 
<a name="l00566"></a>00566     <span class="comment">// handle the (symmetric) off diagonal blocks</span>
<a name="l00567"></a>00567     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> h=i+1; h&lt;<a class="code" href="classvnl__sparse__lm.html#ac60af9d040c144608af84c9ddb9a94d3">num_a_</a>; ++h)
<a name="l00568"></a>00568     {
<a name="l00569"></a>00569       <a class="code" href="classvnl__crs__index.html#a015af1612c1409408234e2b9c7771ba2">vnl_crs_index::sparse_vector</a> row_h = crs.<a class="code" href="classvnl__crs__index.html#a1d1773106f6efda2257dc21f95d3a13c" title="returns row i as a vector of index-column pairs.">sparse_row</a>(h);
<a name="l00570"></a>00570       <a class="code" href="classvnl__matrix.html">vnl_matrix&lt;double&gt;</a> Sih(<a class="code" href="classvnl__sparse__lm.html#a3173e72fb1678737a0bf8fdccfde103c" title="the function to minimize.">f_</a>-&gt;<a class="code" href="classvnl__sparse__lst__sqr__function.html#aa650f3c88ffb9139d6ddcc8f92df95fb" title="Return the number of parameters of a_j.">number_of_params_a</a>(i),
<a name="l00571"></a>00571                              <a class="code" href="classvnl__sparse__lm.html#a3173e72fb1678737a0bf8fdccfde103c" title="the function to minimize.">f_</a>-&gt;<a class="code" href="classvnl__sparse__lst__sqr__function.html#aa650f3c88ffb9139d6ddcc8f92df95fb" title="Return the number of parameters of a_j.">number_of_params_a</a>(h), 0.0);
<a name="l00572"></a>00572 
<a name="l00573"></a>00573       <span class="comment">// iterate through both sparse rows finding matching columns</span>
<a name="l00574"></a>00574       <span class="keywordtype">bool</span> row_done = <span class="keyword">false</span>;
<a name="l00575"></a>00575       <span class="keywordflow">for</span> (sv_itr ri = row_i.begin(), rh = row_h.begin();
<a name="l00576"></a>00576            ri != row_i.end() &amp;&amp; rh != row_h.end();  ++ri, ++rh)
<a name="l00577"></a>00577       {
<a name="l00578"></a>00578         <span class="keywordflow">while</span> (!row_done &amp;&amp; ri-&gt;second != rh-&gt;second)
<a name="l00579"></a>00579         {
<a name="l00580"></a>00580           <span class="keywordflow">while</span> (!row_done &amp;&amp; ri-&gt;second &lt; rh-&gt;second)
<a name="l00581"></a>00581             row_done = (++ri == row_i.end());
<a name="l00582"></a>00582           <span class="keywordflow">while</span> (!row_done &amp;&amp; rh-&gt;second &lt; ri-&gt;second)
<a name="l00583"></a>00583             row_done = (++rh == row_h.end());
<a name="l00584"></a>00584         }
<a name="l00585"></a>00585         <span class="keywordflow">if</span> (row_done)
<a name="l00586"></a>00586           <span class="keywordflow">break</span>;
<a name="l00587"></a>00587         <span class="comment">// S_ih -= Y_ij * W_hj^T</span>
<a name="l00588"></a>00588         <a class="code" href="classvnl__fastops.html#a1df9d50cfa9e8192d9149bc33cbb7331" title="Compute $X -= A B^$.">vnl_fastops::dec_X_by_ABt</a>(Sih,<a class="code" href="classvnl__sparse__lm.html#a45932b1af4d09bef9df4ae3a02249d99">Y_</a>[ri-&gt;first],<a class="code" href="classvnl__sparse__lm.html#acc9c39c805c7e4443a31586d8a736bfd">W_</a>[rh-&gt;first]);
<a name="l00589"></a>00589       }
<a name="l00590"></a>00590       <span class="comment">// this should also be a symmetric matrix</span>
<a name="l00591"></a>00591       Sa.<a class="code" href="classvnl__matrix.html#a8a46918b792658fd2032ebf9c2294deb" title="Set values of this matrix to those of M, starting at [top,left].">update</a>(Sih,<a class="code" href="classvnl__sparse__lm.html#a3173e72fb1678737a0bf8fdccfde103c" title="the function to minimize.">f_</a>-&gt;<a class="code" href="classvnl__sparse__lst__sqr__function.html#a215ac902994bd0298c6cc73f6026759e" title="return the index of aj in a.">index_a</a>(i),<a class="code" href="classvnl__sparse__lm.html#a3173e72fb1678737a0bf8fdccfde103c" title="the function to minimize.">f_</a>-&gt;<a class="code" href="classvnl__sparse__lst__sqr__function.html#a215ac902994bd0298c6cc73f6026759e" title="return the index of aj in a.">index_a</a>(h));
<a name="l00592"></a>00592       Sa.<a class="code" href="classvnl__matrix.html#a8a46918b792658fd2032ebf9c2294deb" title="Set values of this matrix to those of M, starting at [top,left].">update</a>(Sih.<a class="code" href="classvnl__matrix.html#a4ecdc9960874f4c3c4f01dd194305a5f" title="Return transpose.">transpose</a>(),<a class="code" href="classvnl__sparse__lm.html#a3173e72fb1678737a0bf8fdccfde103c" title="the function to minimize.">f_</a>-&gt;<a class="code" href="classvnl__sparse__lst__sqr__function.html#a215ac902994bd0298c6cc73f6026759e" title="return the index of aj in a.">index_a</a>(h),<a class="code" href="classvnl__sparse__lm.html#a3173e72fb1678737a0bf8fdccfde103c" title="the function to minimize.">f_</a>-&gt;<a class="code" href="classvnl__sparse__lst__sqr__function.html#a215ac902994bd0298c6cc73f6026759e" title="return the index of aj in a.">index_a</a>(i));
<a name="l00593"></a>00593     }
<a name="l00594"></a>00594   }
<a name="l00595"></a>00595 }
<a name="l00596"></a>00596 
<a name="l00597"></a>00597 
<a name="l00598"></a><a class="code" href="classvnl__sparse__lm.html#a515df600c8a0e3f699466ad0633986b7">00598</a> <span class="comment">//: compute Ma</span>
<a name="l00599"></a>00599 <span class="keywordtype">void</span> <a class="code" href="classvnl__sparse__lm.html#a515df600c8a0e3f699466ad0633986b7" title="compute Ma.">vnl_sparse_lm::compute_Ma</a>(<span class="keyword">const</span> <a class="code" href="classvnl__matrix.html">vnl_matrix&lt;double&gt;</a>&amp; H)
<a name="l00600"></a>00600 {
<a name="l00601"></a>00601   <span class="comment">// construct Ma = ZH</span>
<a name="l00602"></a>00602   <a class="code" href="classvnl__matrix.html">vnl_matrix&lt;double&gt;</a> Hik;
<a name="l00603"></a>00603   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;<a class="code" href="classvnl__sparse__lm.html#ac60af9d040c144608af84c9ddb9a94d3">num_a_</a>; ++i)
<a name="l00604"></a>00604   {
<a name="l00605"></a>00605     <a class="code" href="classvnl__matrix.html">vnl_matrix&lt;double&gt;</a>&amp; Mai = <a class="code" href="classvnl__sparse__lm.html#a55e185bd955e49034e4d08b20817706a">Ma_</a>[i];
<a name="l00606"></a>00606     Mai.<a class="code" href="classvnl__matrix.html#a98da5b87fa05cdab4b7b844ddf8a9074" title="Sets all elements of matrix to specified value, and returns &quot;*this&quot;.">fill</a>(0.0);
<a name="l00607"></a>00607 
<a name="l00608"></a>00608     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> k=0; k&lt;<a class="code" href="classvnl__sparse__lm.html#ac60af9d040c144608af84c9ddb9a94d3">num_a_</a>; ++k)
<a name="l00609"></a>00609     {
<a name="l00610"></a>00610       Hik.<a class="code" href="classvnl__matrix.html#a1fa1949e6219d0db6e3ad50a32d7e1e0" title="Resize to r rows by c columns. Old data lost.">set_size</a>(<a class="code" href="classvnl__sparse__lm.html#a3173e72fb1678737a0bf8fdccfde103c" title="the function to minimize.">f_</a>-&gt;<a class="code" href="classvnl__sparse__lst__sqr__function.html#aa650f3c88ffb9139d6ddcc8f92df95fb" title="Return the number of parameters of a_j.">number_of_params_a</a>(i), <a class="code" href="classvnl__sparse__lm.html#a3173e72fb1678737a0bf8fdccfde103c" title="the function to minimize.">f_</a>-&gt;<a class="code" href="classvnl__sparse__lst__sqr__function.html#aa650f3c88ffb9139d6ddcc8f92df95fb" title="Return the number of parameters of a_j.">number_of_params_a</a>(k));
<a name="l00611"></a>00611       H.<a class="code" href="classvnl__matrix.html#a6978f66bc36f8936ccbab4716aa40a48" title="Extract a sub-matrix of size r x c, starting at (top,left).">extract</a>(Hik,<a class="code" href="classvnl__sparse__lm.html#a3173e72fb1678737a0bf8fdccfde103c" title="the function to minimize.">f_</a>-&gt;<a class="code" href="classvnl__sparse__lst__sqr__function.html#a215ac902994bd0298c6cc73f6026759e" title="return the index of aj in a.">index_a</a>(i), <a class="code" href="classvnl__sparse__lm.html#a3173e72fb1678737a0bf8fdccfde103c" title="the function to minimize.">f_</a>-&gt;<a class="code" href="classvnl__sparse__lst__sqr__function.html#a215ac902994bd0298c6cc73f6026759e" title="return the index of aj in a.">index_a</a>(k));
<a name="l00612"></a>00612       <a class="code" href="classvnl__fastops.html#a8ca06f631fd27652e85ba999d9385cd4" title="Compute $X += A B$.">vnl_fastops::inc_X_by_AB</a>(Mai, <a class="code" href="classvnl__sparse__lm.html#a1ee20a7a17bcd1ddd07ad474ae3529df">Z_</a>[k], Hik);
<a name="l00613"></a>00613     }
<a name="l00614"></a>00614   }
<a name="l00615"></a>00615 }
<a name="l00616"></a>00616 
<a name="l00617"></a>00617 
<a name="l00618"></a><a class="code" href="classvnl__sparse__lm.html#a3b5fbf843f069afd6f6049075dcf3c19">00618</a> <span class="comment">//: compute Mb</span>
<a name="l00619"></a>00619 <span class="keywordtype">void</span> <a class="code" href="classvnl__sparse__lm.html#a3b5fbf843f069afd6f6049075dcf3c19" title="compute Mb.">vnl_sparse_lm::compute_Mb</a>()
<a name="l00620"></a>00620 {
<a name="l00621"></a>00621   <span class="comment">// CRS matrix of indices into e, A, B, C, W, Y</span>
<a name="l00622"></a>00622   <span class="keyword">const</span> <a class="code" href="classvnl__crs__index.html" title="Represents the configuration of a sparse matrix but not the data.">vnl_crs_index</a>&amp; crs = <a class="code" href="classvnl__sparse__lm.html#a3173e72fb1678737a0bf8fdccfde103c" title="the function to minimize.">f_</a>-&gt;<a class="code" href="classvnl__sparse__lst__sqr__function.html#a97ed08f452aedd332dc5c866b989f4db" title="Return a const reference to the residual indexer.">residual_indices</a>();
<a name="l00623"></a>00623   <span class="comment">// sparse vector iterator</span>
<a name="l00624"></a>00624   <span class="keyword">typedef</span> vnl_crs_index::sparse_vector::iterator sv_itr;
<a name="l00625"></a>00625 
<a name="l00626"></a>00626   <a class="code" href="classvnl__matrix.html">vnl_matrix&lt;double&gt;</a> temp;
<a name="l00627"></a>00627   <span class="comment">// construct Mb = (-R-MaW)inv(V)</span>
<a name="l00628"></a>00628   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j=0; j&lt;<a class="code" href="classvnl__sparse__lm.html#a6c7f69c6c648a732f019ca5057750779">num_b_</a>; ++j)
<a name="l00629"></a>00629   {
<a name="l00630"></a>00630     temp.<a class="code" href="classvnl__matrix.html#a1fa1949e6219d0db6e3ad50a32d7e1e0" title="Resize to r rows by c columns. Old data lost.">set_size</a>(<a class="code" href="classvnl__sparse__lm.html#a690f0091a073781a62ff1aa43f7d8894">size_c_</a>,<a class="code" href="classvnl__sparse__lm.html#a3173e72fb1678737a0bf8fdccfde103c" title="the function to minimize.">f_</a>-&gt;<a class="code" href="classvnl__sparse__lst__sqr__function.html#a2dd2b63684e8e57d9251301f236e77eb" title="Return the number of parameters of b_i.">number_of_params_b</a>(j));
<a name="l00631"></a>00631     temp.<a class="code" href="classvnl__matrix.html#a98da5b87fa05cdab4b7b844ddf8a9074" title="Sets all elements of matrix to specified value, and returns &quot;*this&quot;.">fill</a>(0.0);
<a name="l00632"></a>00632     temp -= <a class="code" href="classvnl__sparse__lm.html#a397485b9f5ddbe5ae6972eb0b53238c9">R_</a>[j];
<a name="l00633"></a>00633 
<a name="l00634"></a>00634     <a class="code" href="classvnl__crs__index.html#a015af1612c1409408234e2b9c7771ba2">vnl_crs_index::sparse_vector</a> col = crs.<a class="code" href="classvnl__crs__index.html#a716e60963809d8876f7a69f8d2c65ef3" title="returns column j as a vector of index-row pairs.">sparse_col</a>(j);
<a name="l00635"></a>00635     <span class="keywordflow">for</span> (sv_itr c_itr=col.begin(); c_itr!=col.end(); ++c_itr)
<a name="l00636"></a>00636     {
<a name="l00637"></a>00637       <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> k = c_itr-&gt;first;
<a name="l00638"></a>00638       <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = c_itr-&gt;second;
<a name="l00639"></a>00639       <a class="code" href="classvnl__fastops.html#ad278579024eca9499569446d6a418cf6" title="Compute $X -= A B$.">vnl_fastops::dec_X_by_AB</a>(temp,<a class="code" href="classvnl__sparse__lm.html#a55e185bd955e49034e4d08b20817706a">Ma_</a>[i],<a class="code" href="classvnl__sparse__lm.html#acc9c39c805c7e4443a31586d8a736bfd">W_</a>[k]);
<a name="l00640"></a>00640     }
<a name="l00641"></a>00641     <a class="code" href="classvnl__fastops.html#a91d5472830161c9b57275973f26cc9db" title="Compute AxB.">vnl_fastops::AB</a>(<a class="code" href="classvnl__sparse__lm.html#a90ff71c732175c7d4656ea9ba2efba8a">Mb_</a>[j],temp,<a class="code" href="classvnl__sparse__lm.html#a82109a87fb505fab059aa50185be70a6">inv_V_</a>[j]);
<a name="l00642"></a>00642   }
<a name="l00643"></a>00643 }
<a name="l00644"></a>00644 
<a name="l00645"></a>00645 
<a name="l00646"></a><a class="code" href="classvnl__sparse__lm.html#ae004c02c3c12bebac2c27e3d936754db">00646</a> <span class="comment">//: solve for dc</span>
<a name="l00647"></a>00647 <span class="keywordtype">void</span> <a class="code" href="classvnl__sparse__lm.html#ae004c02c3c12bebac2c27e3d936754db" title="solve for dc.">vnl_sparse_lm::solve_dc</a>(<a class="code" href="classvnl__vector.html">vnl_vector&lt;double&gt;</a>&amp; dc)
<a name="l00648"></a>00648 {
<a name="l00649"></a>00649   <span class="comment">// sparse vector iterator</span>
<a name="l00650"></a>00650   <span class="keyword">typedef</span> vnl_crs_index::sparse_vector::iterator sv_itr;
<a name="l00651"></a>00651 
<a name="l00652"></a>00652   <a class="code" href="classvnl__matrix.html">vnl_matrix&lt;double&gt;</a> Sc(<a class="code" href="classvnl__sparse__lm.html#afa8300c5448b8f66fc2e7ca0f0ee1b39">T_</a>); <span class="comment">// start with a copy of T</span>
<a name="l00653"></a>00653   <a class="code" href="classvnl__vector.html">vnl_vector&lt;double&gt;</a> sec(<a class="code" href="classvnl__sparse__lm.html#a6220c7736d7e8fcdfc002e2d41219c8b">ec_</a>); <span class="comment">// start with a copy of ec</span>
<a name="l00654"></a>00654 
<a name="l00655"></a>00655   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;<a class="code" href="classvnl__sparse__lm.html#ac60af9d040c144608af84c9ddb9a94d3">num_a_</a>; ++i)
<a name="l00656"></a>00656   {
<a name="l00657"></a>00657     <span class="keyword">const</span> <a class="code" href="classvnl__vector__ref.html" title="vnl_vector using user-supplied storage.">vnl_vector_ref&lt;double&gt;</a> eai(<a class="code" href="classvnl__sparse__lm.html#a3173e72fb1678737a0bf8fdccfde103c" title="the function to minimize.">f_</a>-&gt;<a class="code" href="classvnl__sparse__lst__sqr__function.html#aa650f3c88ffb9139d6ddcc8f92df95fb" title="Return the number of parameters of a_j.">number_of_params_a</a>(i),
<a name="l00658"></a>00658                                      <span class="keyword">const_cast&lt;</span><span class="keywordtype">double</span>*<span class="keyword">&gt;</span>(<a class="code" href="classvnl__sparse__lm.html#a507a409cc6e7239b031ef0209f76be19">ea_</a>.<a class="code" href="classvnl__vector.html#a672822d3a059ac09909cb32a7be004a9" title="Access the contiguous block storing the elements in the vector. O(1).">data_block</a>()+<a class="code" href="classvnl__sparse__lm.html#a3173e72fb1678737a0bf8fdccfde103c" title="the function to minimize.">f_</a>-&gt;<a class="code" href="classvnl__sparse__lst__sqr__function.html#a215ac902994bd0298c6cc73f6026759e" title="return the index of aj in a.">index_a</a>(i)));
<a name="l00659"></a>00659     <a class="code" href="classvnl__fastops.html#aefd8ad5893975e1dba72b37e6427f252" title="Compute $X += A B^$.">vnl_fastops::inc_X_by_ABt</a>(Sc,<a class="code" href="classvnl__sparse__lm.html#a55e185bd955e49034e4d08b20817706a">Ma_</a>[i],<a class="code" href="classvnl__sparse__lm.html#a72f8bd531b42be2754499dc67f27e583">Q_</a>[i]);
<a name="l00660"></a>00660     sec += <a class="code" href="classvnl__sparse__lm.html#a55e185bd955e49034e4d08b20817706a">Ma_</a>[i] * eai;
<a name="l00661"></a>00661   }
<a name="l00662"></a>00662   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j=0; j&lt;<a class="code" href="classvnl__sparse__lm.html#a6c7f69c6c648a732f019ca5057750779">num_b_</a>; ++j)
<a name="l00663"></a>00663   {
<a name="l00664"></a>00664     <span class="keyword">const</span> <a class="code" href="classvnl__vector__ref.html" title="vnl_vector using user-supplied storage.">vnl_vector_ref&lt;double&gt;</a> ebi(<a class="code" href="classvnl__sparse__lm.html#a3173e72fb1678737a0bf8fdccfde103c" title="the function to minimize.">f_</a>-&gt;<a class="code" href="classvnl__sparse__lst__sqr__function.html#a2dd2b63684e8e57d9251301f236e77eb" title="Return the number of parameters of b_i.">number_of_params_b</a>(j),
<a name="l00665"></a>00665                                      <span class="keyword">const_cast&lt;</span><span class="keywordtype">double</span>*<span class="keyword">&gt;</span>(<a class="code" href="classvnl__sparse__lm.html#a651698a11965625028830139eb344df0">eb_</a>.<a class="code" href="classvnl__vector.html#a672822d3a059ac09909cb32a7be004a9" title="Access the contiguous block storing the elements in the vector. O(1).">data_block</a>()+<a class="code" href="classvnl__sparse__lm.html#a3173e72fb1678737a0bf8fdccfde103c" title="the function to minimize.">f_</a>-&gt;<a class="code" href="classvnl__sparse__lst__sqr__function.html#a74039f92584458ff8c467f527040d452" title="return the index of bj in b.">index_b</a>(j)));
<a name="l00666"></a>00666     <a class="code" href="classvnl__fastops.html#aefd8ad5893975e1dba72b37e6427f252" title="Compute $X += A B^$.">vnl_fastops::inc_X_by_ABt</a>(Sc,<a class="code" href="classvnl__sparse__lm.html#a90ff71c732175c7d4656ea9ba2efba8a">Mb_</a>[j],<a class="code" href="classvnl__sparse__lm.html#a397485b9f5ddbe5ae6972eb0b53238c9">R_</a>[j]);
<a name="l00667"></a>00667     sec += <a class="code" href="classvnl__sparse__lm.html#a90ff71c732175c7d4656ea9ba2efba8a">Mb_</a>[j] * ebi;
<a name="l00668"></a>00668   }
<a name="l00669"></a>00669 
<a name="l00670"></a>00670   <span class="keywordflow">if</span> (<a class="code" href="classvnl__sparse__lm.html#a690f0091a073781a62ff1aa43f7d8894">size_c_</a> == 1)
<a name="l00671"></a>00671   {
<a name="l00672"></a>00672     dc[0] = sec[0] / Sc(0,0);
<a name="l00673"></a>00673   }
<a name="l00674"></a>00674   <span class="keywordflow">else</span>
<a name="l00675"></a>00675   {
<a name="l00676"></a>00676     <span class="comment">// Solve Sc*dc = sec for dc</span>
<a name="l00677"></a>00677     <a class="code" href="classvnl__cholesky.html" title="Decomposition of symmetric matrix.">vnl_cholesky</a> Sc_cholesky(Sc,<a class="code" href="classvnl__cholesky.html#aaabc2110e510ffa1417a657cbef99efca6ae23c768b154f5a2f128caa4fe05350">vnl_cholesky::quiet</a>);
<a name="l00678"></a>00678     <span class="comment">// use SVD as a backup if Cholesky is deficient</span>
<a name="l00679"></a>00679     <span class="keywordflow">if</span> ( Sc_cholesky.<a class="code" href="classvnl__cholesky.html#ade6855bf36ca3b97e79cbf04ee289977" title="A Success/failure flag.">rank_deficiency</a>() &gt; 0 )
<a name="l00680"></a>00680     {
<a name="l00681"></a>00681       <a class="code" href="classvnl__svd.html" title="Holds the singular value decomposition of a vnl_matrix.">vnl_svd&lt;double&gt;</a> Sc_svd(Sc);
<a name="l00682"></a>00682       dc = Sc_svd.<a class="code" href="classvnl__svd.html#ac2cbab9e5659cebda7829337d285fbcc" title="Solve the matrix equation M X = B, returning X.">solve</a>(sec);
<a name="l00683"></a>00683     }
<a name="l00684"></a>00684     <span class="keywordflow">else</span>
<a name="l00685"></a>00685       dc = Sc_cholesky.<a class="code" href="classvnl__cholesky.html#ab7d3309b8b536a8409e6326aca2d9c09" title="Solve LS problem M x = b.">solve</a>(sec);
<a name="l00686"></a>00686   }
<a name="l00687"></a>00687 }
<a name="l00688"></a>00688 
<a name="l00689"></a>00689 
<a name="l00690"></a><a class="code" href="classvnl__sparse__lm.html#a105241d756174e7cebf4816ec70175b5">00690</a> <span class="comment">//: compute sea using ea, Z, dc, Y, and eb</span>
<a name="l00691"></a>00691 <span class="keywordtype">void</span> <a class="code" href="classvnl__sparse__lm.html#a105241d756174e7cebf4816ec70175b5" title="compute sea using ea, Z, dc, Y, and eb.">vnl_sparse_lm::compute_sea</a>(<a class="code" href="classvnl__vector.html">vnl_vector&lt;double&gt;</a> <span class="keyword">const</span>&amp; dc,
<a name="l00692"></a>00692                                 <a class="code" href="classvnl__vector.html">vnl_vector&lt;double&gt;</a>&amp; sea)
<a name="l00693"></a>00693 {
<a name="l00694"></a>00694   <span class="comment">// CRS matrix of indices into e, A, B, C, W, Y</span>
<a name="l00695"></a>00695   <span class="keyword">const</span> <a class="code" href="classvnl__crs__index.html" title="Represents the configuration of a sparse matrix but not the data.">vnl_crs_index</a>&amp; crs = <a class="code" href="classvnl__sparse__lm.html#a3173e72fb1678737a0bf8fdccfde103c" title="the function to minimize.">f_</a>-&gt;<a class="code" href="classvnl__sparse__lst__sqr__function.html#a97ed08f452aedd332dc5c866b989f4db" title="Return a const reference to the residual indexer.">residual_indices</a>();
<a name="l00696"></a>00696   <span class="comment">// sparse vector iterator</span>
<a name="l00697"></a>00697   <span class="keyword">typedef</span> vnl_crs_index::sparse_vector::iterator sv_itr;
<a name="l00698"></a>00698 
<a name="l00699"></a>00699   sea = <a class="code" href="classvnl__sparse__lm.html#a507a409cc6e7239b031ef0209f76be19">ea_</a>; <span class="comment">// initialize se to ea_</span>
<a name="l00700"></a>00700   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;<a class="code" href="classvnl__sparse__lm.html#ac60af9d040c144608af84c9ddb9a94d3">num_a_</a>; ++i)
<a name="l00701"></a>00701   {
<a name="l00702"></a>00702     <a class="code" href="classvnl__vector__ref.html" title="vnl_vector using user-supplied storage.">vnl_vector_ref&lt;double&gt;</a> sei(<a class="code" href="classvnl__sparse__lm.html#a3173e72fb1678737a0bf8fdccfde103c" title="the function to minimize.">f_</a>-&gt;<a class="code" href="classvnl__sparse__lst__sqr__function.html#aa650f3c88ffb9139d6ddcc8f92df95fb" title="Return the number of parameters of a_j.">number_of_params_a</a>(i),sea.<a class="code" href="classvnl__vector.html#a672822d3a059ac09909cb32a7be004a9" title="Access the contiguous block storing the elements in the vector. O(1).">data_block</a>()+<a class="code" href="classvnl__sparse__lm.html#a3173e72fb1678737a0bf8fdccfde103c" title="the function to minimize.">f_</a>-&gt;<a class="code" href="classvnl__sparse__lst__sqr__function.html#a215ac902994bd0298c6cc73f6026759e" title="return the index of aj in a.">index_a</a>(i));
<a name="l00703"></a>00703     <a class="code" href="classvnl__crs__index.html#a015af1612c1409408234e2b9c7771ba2">vnl_crs_index::sparse_vector</a> row_i = crs.<a class="code" href="classvnl__crs__index.html#a1d1773106f6efda2257dc21f95d3a13c" title="returns row i as a vector of index-column pairs.">sparse_row</a>(i);
<a name="l00704"></a>00704 
<a name="l00705"></a>00705     <a class="code" href="classvnl__fastops.html#a9f4c2d9fcd39acd0806a202a527a21f4" title="Compute $X += A^ B$.">vnl_fastops::inc_X_by_AtB</a>(sei,<a class="code" href="classvnl__sparse__lm.html#a1ee20a7a17bcd1ddd07ad474ae3529df">Z_</a>[i],dc);
<a name="l00706"></a>00706 
<a name="l00707"></a>00707     <span class="keywordflow">for</span> (sv_itr ri = row_i.<a class="code" href="classvnl__vector.html#ade1c94ab8d54075269ef09d38e38b33b" title="Iterator pointing to start of data.">begin</a>(); ri != row_i.<a class="code" href="classvnl__vector.html#a49d0ea4f1e8825378c8adfec7de3c863" title="Iterator pointing to element beyond end of data.">end</a>();  ++ri)
<a name="l00708"></a>00708     {
<a name="l00709"></a>00709       <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> k = ri-&gt;first;
<a name="l00710"></a>00710       <a class="code" href="classvnl__matrix.html">vnl_matrix&lt;double&gt;</a>&amp; Yij = <a class="code" href="classvnl__sparse__lm.html#a45932b1af4d09bef9df4ae3a02249d99">Y_</a>[k];
<a name="l00711"></a>00711       <a class="code" href="classvnl__vector__ref.html" title="vnl_vector using user-supplied storage.">vnl_vector_ref&lt;double&gt;</a> ebj(Yij.<a class="code" href="classvnl__matrix.html#a4d3c7b58bf1dd7325262a2f6e4e57867" title="Return number of columns.">cols</a>(), <a class="code" href="classvnl__sparse__lm.html#a651698a11965625028830139eb344df0">eb_</a>.<a class="code" href="classvnl__vector.html#a672822d3a059ac09909cb32a7be004a9" title="Access the contiguous block storing the elements in the vector. O(1).">data_block</a>()+<a class="code" href="classvnl__sparse__lm.html#a3173e72fb1678737a0bf8fdccfde103c" title="the function to minimize.">f_</a>-&gt;<a class="code" href="classvnl__sparse__lst__sqr__function.html#a74039f92584458ff8c467f527040d452" title="return the index of bj in b.">index_b</a>(ri-&gt;second));
<a name="l00712"></a>00712       sei -= Yij*ebj;  <span class="comment">// se_i -= Y_ij * e_b_j</span>
<a name="l00713"></a>00713     }
<a name="l00714"></a>00714   }
<a name="l00715"></a>00715 }
<a name="l00716"></a>00716 
<a name="l00717"></a>00717 
<a name="l00718"></a>00718 <span class="comment">//: compute Sa and sea</span>
<a name="l00719"></a><a class="code" href="classvnl__sparse__lm.html#aeb0d0c6adb6e9cce5c87459f4ce3425f">00719</a> <span class="comment">// only used when size_c_ == 0</span>
<a name="l00720"></a>00720 <span class="keywordtype">void</span> <a class="code" href="classvnl__sparse__lm.html#aeb0d0c6adb6e9cce5c87459f4ce3425f" title="compute Sa and sea.">vnl_sparse_lm::compute_Sa_sea</a>(<a class="code" href="classvnl__matrix.html">vnl_matrix&lt;double&gt;</a>&amp; Sa,
<a name="l00721"></a>00721                                    <a class="code" href="classvnl__vector.html">vnl_vector&lt;double&gt;</a>&amp; sea)
<a name="l00722"></a>00722 {
<a name="l00723"></a>00723   <span class="comment">// CRS matrix of indices into e, A, B, C, W, Y</span>
<a name="l00724"></a>00724   <span class="keyword">const</span> <a class="code" href="classvnl__crs__index.html" title="Represents the configuration of a sparse matrix but not the data.">vnl_crs_index</a>&amp; crs = <a class="code" href="classvnl__sparse__lm.html#a3173e72fb1678737a0bf8fdccfde103c" title="the function to minimize.">f_</a>-&gt;<a class="code" href="classvnl__sparse__lst__sqr__function.html#a97ed08f452aedd332dc5c866b989f4db" title="Return a const reference to the residual indexer.">residual_indices</a>();
<a name="l00725"></a>00725   <span class="comment">// sparse vector iterator</span>
<a name="l00726"></a>00726   <span class="keyword">typedef</span> vnl_crs_index::sparse_vector::iterator sv_itr;
<a name="l00727"></a>00727 
<a name="l00728"></a>00728   sea = <a class="code" href="classvnl__sparse__lm.html#a507a409cc6e7239b031ef0209f76be19">ea_</a>; <span class="comment">// initialize se to ea_</span>
<a name="l00729"></a>00729   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;<a class="code" href="classvnl__sparse__lm.html#ac60af9d040c144608af84c9ddb9a94d3">num_a_</a>; ++i)
<a name="l00730"></a>00730   {
<a name="l00731"></a>00731     <a class="code" href="classvnl__vector__ref.html" title="vnl_vector using user-supplied storage.">vnl_vector_ref&lt;double&gt;</a> sei(<a class="code" href="classvnl__sparse__lm.html#a3173e72fb1678737a0bf8fdccfde103c" title="the function to minimize.">f_</a>-&gt;<a class="code" href="classvnl__sparse__lst__sqr__function.html#aa650f3c88ffb9139d6ddcc8f92df95fb" title="Return the number of parameters of a_j.">number_of_params_a</a>(i),sea.<a class="code" href="classvnl__vector.html#a672822d3a059ac09909cb32a7be004a9" title="Access the contiguous block storing the elements in the vector. O(1).">data_block</a>()+<a class="code" href="classvnl__sparse__lm.html#a3173e72fb1678737a0bf8fdccfde103c" title="the function to minimize.">f_</a>-&gt;<a class="code" href="classvnl__sparse__lst__sqr__function.html#a215ac902994bd0298c6cc73f6026759e" title="return the index of aj in a.">index_a</a>(i));
<a name="l00732"></a>00732     <a class="code" href="classvnl__crs__index.html#a015af1612c1409408234e2b9c7771ba2">vnl_crs_index::sparse_vector</a> row_i = crs.<a class="code" href="classvnl__crs__index.html#a1d1773106f6efda2257dc21f95d3a13c" title="returns row i as a vector of index-column pairs.">sparse_row</a>(i);
<a name="l00733"></a>00733 
<a name="l00734"></a>00734     <span class="comment">// handle the diagonal blocks and computation of se separately</span>
<a name="l00735"></a>00735     <a class="code" href="classvnl__matrix.html">vnl_matrix&lt;double&gt;</a> Sii(<a class="code" href="classvnl__sparse__lm.html#a187c9fd3b1373dc3f836b0b0beb24677" title="Storage for normal equation blocks.">U_</a>[i]); <span class="comment">// copy Ui to initialize Sii</span>
<a name="l00736"></a>00736     <span class="keywordflow">for</span> (sv_itr ri = row_i.<a class="code" href="classvnl__vector.html#ade1c94ab8d54075269ef09d38e38b33b" title="Iterator pointing to start of data.">begin</a>(); ri != row_i.<a class="code" href="classvnl__vector.html#a49d0ea4f1e8825378c8adfec7de3c863" title="Iterator pointing to element beyond end of data.">end</a>();  ++ri)
<a name="l00737"></a>00737     {
<a name="l00738"></a>00738       <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> k = ri-&gt;first;
<a name="l00739"></a>00739       <a class="code" href="classvnl__matrix.html">vnl_matrix&lt;double&gt;</a>&amp; Yij = <a class="code" href="classvnl__sparse__lm.html#a45932b1af4d09bef9df4ae3a02249d99">Y_</a>[k];
<a name="l00740"></a>00740       <a class="code" href="classvnl__fastops.html#a1df9d50cfa9e8192d9149bc33cbb7331" title="Compute $X -= A B^$.">vnl_fastops::dec_X_by_ABt</a>(Sii,Yij,<a class="code" href="classvnl__sparse__lm.html#acc9c39c805c7e4443a31586d8a736bfd">W_</a>[k]); <span class="comment">// S_ii -= Y_ij * W_ij^T</span>
<a name="l00741"></a>00741       <a class="code" href="classvnl__vector__ref.html" title="vnl_vector using user-supplied storage.">vnl_vector_ref&lt;double&gt;</a> ebj(Yij.<a class="code" href="classvnl__matrix.html#a4d3c7b58bf1dd7325262a2f6e4e57867" title="Return number of columns.">cols</a>(), <a class="code" href="classvnl__sparse__lm.html#a651698a11965625028830139eb344df0">eb_</a>.<a class="code" href="classvnl__vector.html#a672822d3a059ac09909cb32a7be004a9" title="Access the contiguous block storing the elements in the vector. O(1).">data_block</a>()+<a class="code" href="classvnl__sparse__lm.html#a3173e72fb1678737a0bf8fdccfde103c" title="the function to minimize.">f_</a>-&gt;<a class="code" href="classvnl__sparse__lst__sqr__function.html#a74039f92584458ff8c467f527040d452" title="return the index of bj in b.">index_b</a>(ri-&gt;second));
<a name="l00742"></a>00742       sei -= Yij*ebj;  <span class="comment">// se_i -= Y_ij * e_b_j</span>
<a name="l00743"></a>00743     }
<a name="l00744"></a>00744     Sa.<a class="code" href="classvnl__matrix.html#a8a46918b792658fd2032ebf9c2294deb" title="Set values of this matrix to those of M, starting at [top,left].">update</a>(Sii,<a class="code" href="classvnl__sparse__lm.html#a3173e72fb1678737a0bf8fdccfde103c" title="the function to minimize.">f_</a>-&gt;<a class="code" href="classvnl__sparse__lst__sqr__function.html#a215ac902994bd0298c6cc73f6026759e" title="return the index of aj in a.">index_a</a>(i),<a class="code" href="classvnl__sparse__lm.html#a3173e72fb1678737a0bf8fdccfde103c" title="the function to minimize.">f_</a>-&gt;<a class="code" href="classvnl__sparse__lst__sqr__function.html#a215ac902994bd0298c6cc73f6026759e" title="return the index of aj in a.">index_a</a>(i));
<a name="l00745"></a>00745 
<a name="l00746"></a>00746     <span class="comment">// handle the (symmetric) off diagonal blocks</span>
<a name="l00747"></a>00747     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> h=i+1; h&lt;<a class="code" href="classvnl__sparse__lm.html#ac60af9d040c144608af84c9ddb9a94d3">num_a_</a>; ++h)
<a name="l00748"></a>00748     {
<a name="l00749"></a>00749       <a class="code" href="classvnl__crs__index.html#a015af1612c1409408234e2b9c7771ba2">vnl_crs_index::sparse_vector</a> row_h = crs.<a class="code" href="classvnl__crs__index.html#a1d1773106f6efda2257dc21f95d3a13c" title="returns row i as a vector of index-column pairs.">sparse_row</a>(h);
<a name="l00750"></a>00750       <a class="code" href="classvnl__matrix.html">vnl_matrix&lt;double&gt;</a> Sih(<a class="code" href="classvnl__sparse__lm.html#a3173e72fb1678737a0bf8fdccfde103c" title="the function to minimize.">f_</a>-&gt;<a class="code" href="classvnl__sparse__lst__sqr__function.html#aa650f3c88ffb9139d6ddcc8f92df95fb" title="Return the number of parameters of a_j.">number_of_params_a</a>(i),<a class="code" href="classvnl__sparse__lm.html#a3173e72fb1678737a0bf8fdccfde103c" title="the function to minimize.">f_</a>-&gt;<a class="code" href="classvnl__sparse__lst__sqr__function.html#aa650f3c88ffb9139d6ddcc8f92df95fb" title="Return the number of parameters of a_j.">number_of_params_a</a>(h),0.0);
<a name="l00751"></a>00751 
<a name="l00752"></a>00752       <span class="comment">// iterate through both sparse rows finding matching columns</span>
<a name="l00753"></a>00753       <span class="keywordtype">bool</span> row_done = <span class="keyword">false</span>;
<a name="l00754"></a>00754       <span class="keywordflow">for</span> (sv_itr ri = row_i.<a class="code" href="classvnl__vector.html#ade1c94ab8d54075269ef09d38e38b33b" title="Iterator pointing to start of data.">begin</a>(), rh = row_h.begin();
<a name="l00755"></a>00755            ri != row_i.<a class="code" href="classvnl__vector.html#a49d0ea4f1e8825378c8adfec7de3c863" title="Iterator pointing to element beyond end of data.">end</a>() &amp;&amp; rh != row_h.end();  ++ri, ++rh)
<a name="l00756"></a>00756       {
<a name="l00757"></a>00757         <span class="keywordflow">while</span> (!row_done &amp;&amp; ri-&gt;second != rh-&gt;second)
<a name="l00758"></a>00758         {
<a name="l00759"></a>00759           <span class="keywordflow">while</span> (!row_done &amp;&amp; ri-&gt;second &lt; rh-&gt;second)
<a name="l00760"></a>00760             row_done = (++ri == row_i.<a class="code" href="classvnl__vector.html#a49d0ea4f1e8825378c8adfec7de3c863" title="Iterator pointing to element beyond end of data.">end</a>());
<a name="l00761"></a>00761           <span class="keywordflow">while</span> (!row_done &amp;&amp; rh-&gt;second &lt; ri-&gt;second)
<a name="l00762"></a>00762             row_done = (++rh == row_h.end());
<a name="l00763"></a>00763         }
<a name="l00764"></a>00764         <span class="keywordflow">if</span> (row_done)
<a name="l00765"></a>00765           <span class="keywordflow">break</span>;
<a name="l00766"></a>00766         <span class="comment">// S_ih -= Y_ij * W_hj^T</span>
<a name="l00767"></a>00767         <a class="code" href="classvnl__fastops.html#a1df9d50cfa9e8192d9149bc33cbb7331" title="Compute $X -= A B^$.">vnl_fastops::dec_X_by_ABt</a>(Sih,<a class="code" href="classvnl__sparse__lm.html#a45932b1af4d09bef9df4ae3a02249d99">Y_</a>[ri-&gt;first],<a class="code" href="classvnl__sparse__lm.html#acc9c39c805c7e4443a31586d8a736bfd">W_</a>[rh-&gt;first]);
<a name="l00768"></a>00768       }
<a name="l00769"></a>00769       <span class="comment">// this should also be a symmetric matrix</span>
<a name="l00770"></a>00770       Sa.<a class="code" href="classvnl__matrix.html#a8a46918b792658fd2032ebf9c2294deb" title="Set values of this matrix to those of M, starting at [top,left].">update</a>(Sih,<a class="code" href="classvnl__sparse__lm.html#a3173e72fb1678737a0bf8fdccfde103c" title="the function to minimize.">f_</a>-&gt;<a class="code" href="classvnl__sparse__lst__sqr__function.html#a215ac902994bd0298c6cc73f6026759e" title="return the index of aj in a.">index_a</a>(i),<a class="code" href="classvnl__sparse__lm.html#a3173e72fb1678737a0bf8fdccfde103c" title="the function to minimize.">f_</a>-&gt;<a class="code" href="classvnl__sparse__lst__sqr__function.html#a215ac902994bd0298c6cc73f6026759e" title="return the index of aj in a.">index_a</a>(h));
<a name="l00771"></a>00771       Sa.<a class="code" href="classvnl__matrix.html#a8a46918b792658fd2032ebf9c2294deb" title="Set values of this matrix to those of M, starting at [top,left].">update</a>(Sih.<a class="code" href="classvnl__matrix.html#a4ecdc9960874f4c3c4f01dd194305a5f" title="Return transpose.">transpose</a>(),<a class="code" href="classvnl__sparse__lm.html#a3173e72fb1678737a0bf8fdccfde103c" title="the function to minimize.">f_</a>-&gt;<a class="code" href="classvnl__sparse__lst__sqr__function.html#a215ac902994bd0298c6cc73f6026759e" title="return the index of aj in a.">index_a</a>(h),<a class="code" href="classvnl__sparse__lm.html#a3173e72fb1678737a0bf8fdccfde103c" title="the function to minimize.">f_</a>-&gt;<a class="code" href="classvnl__sparse__lst__sqr__function.html#a215ac902994bd0298c6cc73f6026759e" title="return the index of aj in a.">index_a</a>(i));
<a name="l00772"></a>00772     }
<a name="l00773"></a>00773   }
<a name="l00774"></a>00774 }
<a name="l00775"></a>00775 
<a name="l00776"></a>00776 
<a name="l00777"></a><a class="code" href="classvnl__sparse__lm.html#a2c0d50050a1d51072bf5866ca7ce3ff0">00777</a> <span class="comment">//: back solve to find db using da and dc</span>
<a name="l00778"></a>00778 <span class="keywordtype">void</span> <a class="code" href="classvnl__sparse__lm.html#a2c0d50050a1d51072bf5866ca7ce3ff0" title="back solve to find db using da and dc.">vnl_sparse_lm::backsolve_db</a>(<a class="code" href="classvnl__vector.html">vnl_vector&lt;double&gt;</a> <span class="keyword">const</span>&amp; da,
<a name="l00779"></a>00779                                  <a class="code" href="classvnl__vector.html">vnl_vector&lt;double&gt;</a> <span class="keyword">const</span>&amp; dc,
<a name="l00780"></a>00780                                  <a class="code" href="classvnl__vector.html">vnl_vector&lt;double&gt;</a>&amp; db)
<a name="l00781"></a>00781 {
<a name="l00782"></a>00782   <span class="comment">// CRS matrix of indices into e, A, B, C, W, Y</span>
<a name="l00783"></a>00783   <span class="keyword">const</span> <a class="code" href="classvnl__crs__index.html" title="Represents the configuration of a sparse matrix but not the data.">vnl_crs_index</a>&amp; crs = <a class="code" href="classvnl__sparse__lm.html#a3173e72fb1678737a0bf8fdccfde103c" title="the function to minimize.">f_</a>-&gt;<a class="code" href="classvnl__sparse__lst__sqr__function.html#a97ed08f452aedd332dc5c866b989f4db" title="Return a const reference to the residual indexer.">residual_indices</a>();
<a name="l00784"></a>00784   <span class="comment">// sparse vector iterator</span>
<a name="l00785"></a>00785   <span class="keyword">typedef</span> vnl_crs_index::sparse_vector::iterator sv_itr;
<a name="l00786"></a>00786 
<a name="l00787"></a>00787   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j=0; j&lt;<a class="code" href="classvnl__sparse__lm.html#a6c7f69c6c648a732f019ca5057750779">num_b_</a>; ++j)
<a name="l00788"></a>00788   {
<a name="l00789"></a>00789     <a class="code" href="classvnl__vector.html">vnl_vector&lt;double&gt;</a> seb(<a class="code" href="classvnl__sparse__lm.html#a651698a11965625028830139eb344df0">eb_</a>.<a class="code" href="classvnl__vector.html#a672822d3a059ac09909cb32a7be004a9" title="Access the contiguous block storing the elements in the vector. O(1).">data_block</a>()+<a class="code" href="classvnl__sparse__lm.html#a3173e72fb1678737a0bf8fdccfde103c" title="the function to minimize.">f_</a>-&gt;<a class="code" href="classvnl__sparse__lst__sqr__function.html#a74039f92584458ff8c467f527040d452" title="return the index of bj in b.">index_b</a>(j),<a class="code" href="classvnl__sparse__lm.html#a3173e72fb1678737a0bf8fdccfde103c" title="the function to minimize.">f_</a>-&gt;<a class="code" href="classvnl__sparse__lst__sqr__function.html#a2dd2b63684e8e57d9251301f236e77eb" title="Return the number of parameters of b_i.">number_of_params_b</a>(j));
<a name="l00790"></a>00790     <a class="code" href="classvnl__crs__index.html#a015af1612c1409408234e2b9c7771ba2">vnl_crs_index::sparse_vector</a> col = crs.<a class="code" href="classvnl__crs__index.html#a716e60963809d8876f7a69f8d2c65ef3" title="returns column j as a vector of index-row pairs.">sparse_col</a>(j);
<a name="l00791"></a>00791     <span class="keywordflow">if</span> ( <a class="code" href="classvnl__sparse__lm.html#a690f0091a073781a62ff1aa43f7d8894">size_c_</a> &gt; 0 )
<a name="l00792"></a>00792     {
<a name="l00793"></a>00793       <a class="code" href="classvnl__fastops.html#a9b45146fb14041e35b15290855868ed2" title="Compute $X -= A^ B$.">vnl_fastops::dec_X_by_AtB</a>(seb,<a class="code" href="classvnl__sparse__lm.html#a397485b9f5ddbe5ae6972eb0b53238c9">R_</a>[j],dc);
<a name="l00794"></a>00794     }
<a name="l00795"></a>00795     <span class="keywordflow">for</span> (sv_itr c_itr=col.<a class="code" href="classvnl__vector.html#ade1c94ab8d54075269ef09d38e38b33b" title="Iterator pointing to start of data.">begin</a>(); c_itr!=col.<a class="code" href="classvnl__vector.html#a49d0ea4f1e8825378c8adfec7de3c863" title="Iterator pointing to element beyond end of data.">end</a>(); ++c_itr)
<a name="l00796"></a>00796     {
<a name="l00797"></a>00797       <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> k = c_itr-&gt;first;
<a name="l00798"></a>00798       <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = c_itr-&gt;second;
<a name="l00799"></a>00799       <span class="keyword">const</span> <a class="code" href="classvnl__vector__ref.html" title="vnl_vector using user-supplied storage.">vnl_vector_ref&lt;double&gt;</a> dai(<a class="code" href="classvnl__sparse__lm.html#a3173e72fb1678737a0bf8fdccfde103c" title="the function to minimize.">f_</a>-&gt;<a class="code" href="classvnl__sparse__lst__sqr__function.html#aa650f3c88ffb9139d6ddcc8f92df95fb" title="Return the number of parameters of a_j.">number_of_params_a</a>(i),
<a name="l00800"></a>00800                                        <span class="keyword">const_cast&lt;</span><span class="keywordtype">double</span>*<span class="keyword">&gt;</span>(da.<a class="code" href="classvnl__vector.html#a672822d3a059ac09909cb32a7be004a9" title="Access the contiguous block storing the elements in the vector. O(1).">data_block</a>()+<a class="code" href="classvnl__sparse__lm.html#a3173e72fb1678737a0bf8fdccfde103c" title="the function to minimize.">f_</a>-&gt;<a class="code" href="classvnl__sparse__lst__sqr__function.html#a215ac902994bd0298c6cc73f6026759e" title="return the index of aj in a.">index_a</a>(i)));
<a name="l00801"></a>00801       <a class="code" href="classvnl__fastops.html#a9b45146fb14041e35b15290855868ed2" title="Compute $X -= A^ B$.">vnl_fastops::dec_X_by_AtB</a>(seb,<a class="code" href="classvnl__sparse__lm.html#acc9c39c805c7e4443a31586d8a736bfd">W_</a>[k],dai);
<a name="l00802"></a>00802     }
<a name="l00803"></a>00803     <a class="code" href="classvnl__vector__ref.html" title="vnl_vector using user-supplied storage.">vnl_vector_ref&lt;double&gt;</a> dbi(<a class="code" href="classvnl__sparse__lm.html#a3173e72fb1678737a0bf8fdccfde103c" title="the function to minimize.">f_</a>-&gt;<a class="code" href="classvnl__sparse__lst__sqr__function.html#a2dd2b63684e8e57d9251301f236e77eb" title="Return the number of parameters of b_i.">number_of_params_b</a>(j),db.<a class="code" href="classvnl__vector.html#a672822d3a059ac09909cb32a7be004a9" title="Access the contiguous block storing the elements in the vector. O(1).">data_block</a>()+<a class="code" href="classvnl__sparse__lm.html#a3173e72fb1678737a0bf8fdccfde103c" title="the function to minimize.">f_</a>-&gt;<a class="code" href="classvnl__sparse__lst__sqr__function.html#a74039f92584458ff8c467f527040d452" title="return the index of bj in b.">index_b</a>(j));
<a name="l00804"></a>00804     <a class="code" href="classvnl__fastops.html#ac1700ac17182e4de4e3e3c1758b7383b" title="Compute $A b$ for vector b. out may not be b.">vnl_fastops::Ab</a>(dbi,<a class="code" href="classvnl__sparse__lm.html#a82109a87fb505fab059aa50185be70a6">inv_V_</a>[j],seb);
<a name="l00805"></a>00805   }
<a name="l00806"></a>00806 }
<a name="l00807"></a>00807 
<a name="l00808"></a>00808 <span class="comment">//------------------------------------------------------------------------------</span>
<a name="l00809"></a><a class="code" href="classvnl__sparse__lm.html#a4742ac8ed969b666f7ddf875a5ae84ed">00809</a> 
<a name="l00810"></a>00810 <span class="keywordtype">void</span> <a class="code" href="classvnl__sparse__lm.html#a4742ac8ed969b666f7ddf875a5ae84ed" title="Provide an ASCII diagnosis of the last minimization on vcl_ostream.">vnl_sparse_lm::diagnose_outcome</a>()<span class="keyword"> const</span>
<a name="l00811"></a>00811 <span class="keyword"></span>{
<a name="l00812"></a>00812   <a class="code" href="classvnl__sparse__lm.html#a4742ac8ed969b666f7ddf875a5ae84ed" title="Provide an ASCII diagnosis of the last minimization on vcl_ostream.">diagnose_outcome</a>(vcl_cerr);
<a name="l00813"></a>00813 }
<a name="l00814"></a>00814 
<a name="l00815"></a>00815 <span class="comment">// fsm: should this function be a method on vnl_nonlinear_minimizer?</span>
<a name="l00816"></a><a class="code" href="classvnl__sparse__lm.html#a6f2400268a6f35711f0cb52357249680">00816</a> <span class="comment">// if not, the return codes should be moved into LM.</span>
<a name="l00817"></a>00817 <span class="keywordtype">void</span> <a class="code" href="classvnl__sparse__lm.html#a4742ac8ed969b666f7ddf875a5ae84ed" title="Provide an ASCII diagnosis of the last minimization on vcl_ostream.">vnl_sparse_lm::diagnose_outcome</a>(vcl_ostream&amp; s)<span class="keyword"> const</span>
<a name="l00818"></a>00818 <span class="keyword"></span>{
<a name="l00819"></a>00819 <span class="preprocessor">#define whoami &quot;vnl_sparse_lm&quot;</span>
<a name="l00820"></a>00820 <span class="preprocessor"></span>  <span class="comment">//if (!verbose_) return;</span>
<a name="l00821"></a>00821   <span class="keywordflow">switch</span> (<a class="code" href="classvnl__nonlinear__minimizer.html#a0c15383c3526f88012364ac342d6e7d7">failure_code_</a>)
<a name="l00822"></a>00822   {
<a name="l00823"></a>00823    <span class="keywordflow">case</span> <a class="code" href="classvnl__nonlinear__minimizer.html#a6112004b90f040a90efeebe19286b908a01c34acab3fae8e237148cf2f6f0a5a2">ERROR_FAILURE</a>:
<a name="l00824"></a>00824     s &lt;&lt; (<a class="code" href="vnl__levenberg__marquardt_8cxx.html#ae8aa515a03184c5b29fe1d86b17a9c8f">whoami</a> <span class="stringliteral">&quot;: OIOIOI -- failure in leastsquares function\n&quot;</span>);
<a name="l00825"></a>00825     <span class="keywordflow">break</span>;
<a name="l00826"></a>00826    <span class="keywordflow">case</span> <a class="code" href="classvnl__nonlinear__minimizer.html#a6112004b90f040a90efeebe19286b908acc184b89d8bfed731cac2ed6456cc4ce">ERROR_DODGY_INPUT</a>:
<a name="l00827"></a>00827     s &lt;&lt; (<a class="code" href="vnl__levenberg__marquardt_8cxx.html#ae8aa515a03184c5b29fe1d86b17a9c8f">whoami</a> <span class="stringliteral">&quot;: OIOIOI -- lmdif dodgy input\n&quot;</span>);
<a name="l00828"></a>00828     <span class="keywordflow">break</span>;
<a name="l00829"></a>00829    <span class="keywordflow">case</span> <a class="code" href="classvnl__nonlinear__minimizer.html#a6112004b90f040a90efeebe19286b908ad7c4949b13390c394061145b8f9078e7">CONVERGED_FTOL</a>:
<a name="l00830"></a>00830     s &lt;&lt; (<a class="code" href="vnl__levenberg__marquardt_8cxx.html#ae8aa515a03184c5b29fe1d86b17a9c8f">whoami</a> <span class="stringliteral">&quot;: converged to ftol\n&quot;</span>);
<a name="l00831"></a>00831     <span class="keywordflow">break</span>;
<a name="l00832"></a>00832    <span class="keywordflow">case</span> <a class="code" href="classvnl__nonlinear__minimizer.html#a6112004b90f040a90efeebe19286b908a45319c33b31daf7aaa90b164415fcb66">CONVERGED_XTOL</a>:
<a name="l00833"></a>00833     s &lt;&lt; (<a class="code" href="vnl__levenberg__marquardt_8cxx.html#ae8aa515a03184c5b29fe1d86b17a9c8f">whoami</a> <span class="stringliteral">&quot;: converged to xtol\n&quot;</span>);
<a name="l00834"></a>00834     <span class="keywordflow">break</span>;
<a name="l00835"></a>00835    <span class="keywordflow">case</span> <a class="code" href="classvnl__nonlinear__minimizer.html#a6112004b90f040a90efeebe19286b908a4d4ae707861a7141868138d75377cd9c">CONVERGED_XFTOL</a>:
<a name="l00836"></a>00836     s &lt;&lt; (<a class="code" href="vnl__levenberg__marquardt_8cxx.html#ae8aa515a03184c5b29fe1d86b17a9c8f">whoami</a> <span class="stringliteral">&quot;: converged nicely\n&quot;</span>);
<a name="l00837"></a>00837     <span class="keywordflow">break</span>;
<a name="l00838"></a>00838    <span class="keywordflow">case</span> <a class="code" href="classvnl__nonlinear__minimizer.html#a6112004b90f040a90efeebe19286b908abd24866909de4210cf14099817595a9a">CONVERGED_GTOL</a>:
<a name="l00839"></a>00839     s &lt;&lt; (<a class="code" href="vnl__levenberg__marquardt_8cxx.html#ae8aa515a03184c5b29fe1d86b17a9c8f">whoami</a> <span class="stringliteral">&quot;: converged via gtol\n&quot;</span>);
<a name="l00840"></a>00840     <span class="keywordflow">break</span>;
<a name="l00841"></a>00841    <span class="keywordflow">case</span> <a class="code" href="classvnl__nonlinear__minimizer.html#a6112004b90f040a90efeebe19286b908ab96caea98f532ef40b8b4d1719efd500">TOO_MANY_ITERATIONS</a>:
<a name="l00842"></a>00842     s &lt;&lt; (<a class="code" href="vnl__levenberg__marquardt_8cxx.html#ae8aa515a03184c5b29fe1d86b17a9c8f">whoami</a> <span class="stringliteral">&quot;: too many iterations\n&quot;</span>);
<a name="l00843"></a>00843     <span class="keywordflow">break</span>;
<a name="l00844"></a>00844    <span class="keywordflow">case</span> <a class="code" href="classvnl__nonlinear__minimizer.html#a6112004b90f040a90efeebe19286b908a39afa961a4e88c54ac88a52f53a67020">FAILED_FTOL_TOO_SMALL</a>:
<a name="l00845"></a>00845     s &lt;&lt; (<a class="code" href="vnl__levenberg__marquardt_8cxx.html#ae8aa515a03184c5b29fe1d86b17a9c8f">whoami</a> <span class="stringliteral">&quot;: ftol is too small. no further reduction in the sum of squares is possible.\n&quot;</span>);
<a name="l00846"></a>00846     <span class="keywordflow">break</span>;
<a name="l00847"></a>00847    <span class="keywordflow">case</span> <a class="code" href="classvnl__nonlinear__minimizer.html#a6112004b90f040a90efeebe19286b908a852e8d95c88f8d931658166e035101cd">FAILED_XTOL_TOO_SMALL</a>:
<a name="l00848"></a>00848     s &lt;&lt; (<a class="code" href="vnl__levenberg__marquardt_8cxx.html#ae8aa515a03184c5b29fe1d86b17a9c8f">whoami</a> <span class="stringliteral">&quot;: xtol is too small. no further improvement in the approximate solution x is possible.\n&quot;</span>);
<a name="l00849"></a>00849     <span class="keywordflow">break</span>;
<a name="l00850"></a>00850    <span class="keywordflow">case</span> <a class="code" href="classvnl__nonlinear__minimizer.html#a6112004b90f040a90efeebe19286b908ab2df1ab1ed55da1071a79edb1911be60">FAILED_GTOL_TOO_SMALL</a>:
<a name="l00851"></a>00851     s &lt;&lt; (<a class="code" href="vnl__levenberg__marquardt_8cxx.html#ae8aa515a03184c5b29fe1d86b17a9c8f">whoami</a> <span class="stringliteral">&quot;: gtol is too small. f(a,b) is orthogonal to the columns of the jacobian to machine precision.\n&quot;</span>);
<a name="l00852"></a>00852     <span class="keywordflow">break</span>;
<a name="l00853"></a>00853    <span class="keywordflow">default</span>:
<a name="l00854"></a>00854     s &lt;&lt; (<a class="code" href="vnl__levenberg__marquardt_8cxx.html#ae8aa515a03184c5b29fe1d86b17a9c8f">whoami</a> <span class="stringliteral">&quot;: OIOIOI: unkown info code from lmder.\n&quot;</span>);
<a name="l00855"></a>00855     <span class="keywordflow">break</span>;
<a name="l00856"></a>00856   }
<a name="l00857"></a>00857   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> num_e = <a class="code" href="classvnl__sparse__lm.html#a3173e72fb1678737a0bf8fdccfde103c" title="the function to minimize.">f_</a>-&gt;<a class="code" href="classvnl__sparse__lst__sqr__function.html#a2dcfccfbc708881b8175b6ba5f94c714" title="Return the number of residual vectors.">number_of_e</a>();
<a name="l00858"></a>00858   s &lt;&lt; <a class="code" href="vnl__levenberg__marquardt_8cxx.html#ae8aa515a03184c5b29fe1d86b17a9c8f">whoami</a> <span class="stringliteral">&quot;: &quot;</span> &lt;&lt; <a class="code" href="classvnl__nonlinear__minimizer.html#a1bd527616499cd8eaddbd6fe36d4cfa1">num_iterations_</a> &lt;&lt; <span class="stringliteral">&quot; iterations, &quot;</span>
<a name="l00859"></a>00859     &lt;&lt; <a class="code" href="classvnl__nonlinear__minimizer.html#ad05cb2f9c1bb9c76d237e174b0943156">num_evaluations_</a> &lt;&lt; <span class="stringliteral">&quot; evaluations, &quot;</span>&lt;&lt; num_e &lt;&lt;<span class="stringliteral">&quot; residuals.  RMS error start/end &quot;</span>
<a name="l00860"></a>00860     &lt;&lt; <a class="code" href="classvnl__nonlinear__minimizer.html#a2e0beee46e02b9d6296821235c4fc335" title="Return the error of the function when it was evaluated at the start point of the last minimization...">get_start_error</a>() &lt;&lt; <span class="charliteral">&#39;/&#39;</span> &lt;&lt; <a class="code" href="classvnl__nonlinear__minimizer.html#a462c57db012604eb4e0a9ed31aa1ab9c" title="Return the best error that was achieved by the last minimization, corresponding to the returned x...">get_end_error</a>() &lt;&lt; vcl_endl;
<a name="l00861"></a>00861 <span class="preprocessor">#undef whoami</span>
<a name="l00862"></a>00862 <span class="preprocessor"></span>}
<a name="l00863"></a>00863 
<a name="l00864"></a><a class="code" href="classvnl__sparse__lm.html#a90c7e259e4778311e7fcb4035b68acbc">00864</a> 
<a name="l00865"></a>00865 <a class="code" href="classvnl__matrix.html">vnl_matrix&lt;double&gt;</a> <span class="keyword">const</span>&amp; <a class="code" href="classvnl__sparse__lm.html#a90c7e259e4778311e7fcb4035b68acbc" title="Return J&#39;*J computed at last minimum.">vnl_sparse_lm::get_JtJ</a>()
<a name="l00866"></a>00866 {
<a name="l00867"></a>00867   <span class="keywordflow">return</span> <a class="code" href="classvnl__sparse__lm.html#ab4e1cec70d181de82b263b43ffa85df2">inv_covar_</a>;
<a name="l00868"></a>00868 }
</pre></div></div>
</div>


<hr class="footer"/><address class="footer"><small>
Generated on Wed May 1 2013 17:31:00 for core/vnl by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.7.5.1
</small></address>

</body>
</html>
