<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
"http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
  <title>core/vil/file_formats/vil_nitf2_image.cxx Source File</title>
  <link href="doxygen.css" rel="stylesheet" type="text/css" />
  <link href="tabs.css" rel="stylesheet" type="text/css" />
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
</head>
<body>
<!-- Generated by Doxygen 1.7.5.1 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<div class="title">core/vil/file_formats/vil_nitf2_image.cxx</div>  </div>
</div>
<div class="contents">
<a href="vil__nitf2__image_8cxx.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">// vil_nitf2: Written by Rob Radtke (rob@) and Harry Voorhees (hlv@) of</span>
<a name="l00002"></a>00002 <span class="comment">// Stellar Science Ltd. Co. (stellarscience.com) for</span>
<a name="l00003"></a>00003 <span class="comment">// Air Force Research Laboratory, 2005.</span>
<a name="l00004"></a>00004 
<a name="l00005"></a>00005 <span class="preprocessor">#include &quot;<a class="code" href="vil__nitf2__image_8h.html" title="vil_nitf2: Written by Rob Radtke (rob@) and Harry Voorhees (hlv@) of Stellar Science Ltd...">vil_nitf2_image.h</a>&quot;</span>
<a name="l00006"></a>00006 
<a name="l00007"></a>00007 <span class="comment">//:</span>
<a name="l00008"></a>00008 <span class="comment">// \file</span>
<a name="l00009"></a>00009 
<a name="l00010"></a>00010 <span class="preprocessor">#include &lt;vcl_cassert.h&gt;</span>
<a name="l00011"></a>00011 <span class="preprocessor">#include &lt;vcl_cstring.h&gt;</span> <span class="comment">// for std::memcpy()</span>
<a name="l00012"></a>00012 <span class="preprocessor">#include &lt;vcl_algorithm.h&gt;</span>
<a name="l00013"></a>00013 <span class="preprocessor">#include &lt;vcl_cstdlib.h&gt;</span>
<a name="l00014"></a>00014 <span class="preprocessor">#include &lt;<a class="code" href="vil__stream__fstream_8h.html" title="A vil_stream implementation using vcl_fstream.">vil/vil_stream_fstream.h</a>&gt;</span>
<a name="l00015"></a>00015 <span class="preprocessor">#include &lt;<a class="code" href="vil__image__view_8h.html" title="A base class reference-counting view of some image data.">vil/vil_image_view.h</a>&gt;</span>
<a name="l00016"></a>00016 <span class="preprocessor">#include &lt;<a class="code" href="vil__property_8h.html" title="There is no class or function called vil_property.">vil/vil_property.h</a>&gt;</span>
<a name="l00017"></a>00017 <span class="preprocessor">#include &lt;vil/vil_config.h&gt;</span>
<a name="l00018"></a>00018 <span class="preprocessor">#include &quot;<a class="code" href="vil__nitf2__data__mask__table_8h.html">vil_nitf2_data_mask_table.h</a>&quot;</span>
<a name="l00019"></a>00019 <span class="preprocessor">#include &quot;<a class="code" href="vil__nitf2__des_8h.html">vil_nitf2_des.h</a>&quot;</span>
<a name="l00020"></a>00020 
<a name="l00021"></a>00021 <span class="preprocessor">#if HAS_J2K</span>
<a name="l00022"></a>00022 <span class="preprocessor"></span><span class="preprocessor">#include &quot;<a class="code" href="vil__j2k__image_8h.html" title="vil_j2k: Written by Rob Radtke (rob@) and Harry Voorhees (hlv@) of Stellar Science Ltd...">vil_j2k_image.h</a>&quot;</span>
<a name="l00023"></a>00023 <span class="preprocessor">#endif //HAS_J2K</span>
<a name="l00024"></a>00024 <span class="preprocessor"></span>
<a name="l00025"></a><a class="code" href="vil__nitf2__image_8cxx.html#a6a7850ecbb72e1e42b73aefa00562183">00025</a> <span class="keywordtype">int</span> <a class="code" href="vil__nitf2__image_8cxx.html#a6a7850ecbb72e1e42b73aefa00562183">debug_level</a> = 0;
<a name="l00026"></a>00026 
<a name="l00027"></a>00027 <span class="comment">//--------------------------------------------------------------------------------</span>
<a name="l00028"></a>00028 <span class="comment">// class vil_nitf2_file_format</span>
<a name="l00029"></a>00029 
<a name="l00030"></a>00030 <span class="keyword">static</span> <span class="keywordtype">char</span> <span class="keyword">const</span> nitf2_string[] = <span class="stringliteral">&quot;nitf&quot;</span>;
<a name="l00031"></a>00031 
<a name="l00032"></a><a class="code" href="classvil__nitf2__file__format.html#a39b778235ae850a303bffb41cfdd339e">00032</a> <span class="keywordtype">char</span> <span class="keyword">const</span>* <a class="code" href="classvil__nitf2__file__format.html#a39b778235ae850a303bffb41cfdd339e" title="Return a character string which uniquely identifies this format.">vil_nitf2_file_format::tag</a>()<span class="keyword"> const</span>
<a name="l00033"></a>00033 <span class="keyword"></span>{
<a name="l00034"></a>00034   <span class="keywordflow">return</span> nitf2_string;
<a name="l00035"></a>00035 }
<a name="l00036"></a>00036 
<a name="l00037"></a><a class="code" href="classvil__nitf2__file__format.html#ae54d2fca8fbbe1a0c5f4dec8fb172072">00037</a> <a class="code" href="classvil__smart__ptr.html">vil_image_resource_sptr</a>  <a class="code" href="classvil__nitf2__file__format.html#ae54d2fca8fbbe1a0c5f4dec8fb172072" title="Attempt to make a generic_image which will read from vil_stream vs.">vil_nitf2_file_format::make_input_image</a>(<a class="code" href="classvil__stream.html" title="Stream interface for VIL image loaders.">vil_stream</a> *vs)
<a name="l00038"></a>00038 {
<a name="l00039"></a>00039   <a class="code" href="classvil__nitf2__image.html" title="Class for reading NITF 2.1 imagery files.">vil_nitf2_image</a>* im = <span class="keyword">new</span> <a class="code" href="classvil__nitf2__image.html" title="Class for reading NITF 2.1 imagery files.">vil_nitf2_image</a>( vs );
<a name="l00040"></a>00040   <span class="keywordflow">if</span> ( !im-&gt;<a class="code" href="classvil__nitf2__image.html#a2c5928ece92ea8d297dd3e098f2f9bab">parse_headers</a>() ) {
<a name="l00041"></a>00041     <span class="keyword">delete</span> im;
<a name="l00042"></a>00042     im = 0;
<a name="l00043"></a>00043   }
<a name="l00044"></a>00044   <span class="keywordflow">return</span> im;
<a name="l00045"></a>00045 }
<a name="l00046"></a>00046 
<a name="l00047"></a>00047 <a class="code" href="classvil__smart__ptr.html">vil_image_resource_sptr</a>
<a name="l00048"></a><a class="code" href="classvil__nitf2__file__format.html#ad35637cee664107921aae445e12cdaf6">00048</a>   <a class="code" href="classvil__nitf2__file__format.html#ad35637cee664107921aae445e12cdaf6" title="Make a &quot;generic_image&quot; on which put_section may be applied.">vil_nitf2_file_format::make_output_image</a>(<a class="code" href="classvil__stream.html" title="Stream interface for VIL image loaders.">vil_stream</a>* <span class="comment">/*vs*/</span>,
<a name="l00049"></a>00049                                            <span class="keywordtype">unsigned</span> <span class="comment">/*nx*/</span>,
<a name="l00050"></a>00050                                            <span class="keywordtype">unsigned</span> <span class="comment">/*ny*/</span>,
<a name="l00051"></a>00051                                            <span class="keywordtype">unsigned</span> <span class="comment">/*nplanes*/</span>,
<a name="l00052"></a>00052                                            <span class="keyword">enum</span> <a class="code" href="vil__pixel__format_8h.html#a6f749d91364b0bcb661189f4a154800d" title="Describes the type of the concrete data.">vil_pixel_format</a> <span class="comment">/*format*/</span>)
<a name="l00053"></a>00053 {
<a name="l00054"></a>00054   <span class="comment">//write not supported</span>
<a name="l00055"></a>00055   <span class="keywordflow">return</span> 0;
<a name="l00056"></a>00056 }
<a name="l00057"></a>00057 
<a name="l00058"></a>00058 <span class="comment">//--------------------------------------------------------------------------------</span>
<a name="l00059"></a>00059 <span class="comment">// class vil_nitf2_image</span>
<a name="l00060"></a>00060 
<a name="l00061"></a><a class="code" href="classvil__nitf2__image.html#a2c74c82ea50cb8368c9c9c0c2ee46454">00061</a> <a class="code" href="vil__stream_8h.html#aa5e912c853d0dd23b24eefd6f6e5a3a4">vil_streampos</a> <a class="code" href="classvil__nitf2__image.html#a2c74c82ea50cb8368c9c9c0c2ee46454">vil_nitf2_image::get_offset_to</a>( <a class="code" href="classvil__nitf2__header.html#a21de72b17d4eea0480e9bf80bdc63c07">vil_nitf2_header::section_type</a> sec,
<a name="l00062"></a>00062                                               <a class="code" href="classvil__nitf2__header.html#acb17a244846f74f4212bc2ca1ba1bfd9">vil_nitf2_header::portion_type</a> por,
<a name="l00063"></a>00063                                               <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> index )<span class="keyword"> const</span>
<a name="l00064"></a>00064 <span class="keyword"></span>{
<a name="l00065"></a>00065   <a class="code" href="vil__stream_8h.html#aa5e912c853d0dd23b24eefd6f6e5a3a4">vil_streampos</a> p;
<a name="l00066"></a>00066   <span class="keywordflow">if</span> ( sec == <a class="code" href="classvil__nitf2__header.html#a21de72b17d4eea0480e9bf80bdc63c07a92d21119b3a8d85e25f8368d5de6802f">vil_nitf2_header::enum_file_header</a> ) {
<a name="l00067"></a>00067     <span class="comment">//there is no data section in the file header and</span>
<a name="l00068"></a>00068     <span class="comment">//there is only one</span>
<a name="l00069"></a>00069     assert( por == <a class="code" href="classvil__nitf2__header.html#acb17a244846f74f4212bc2ca1ba1bfd9a95d851814d8da0b9760032dea0f887c2">vil_nitf2_header::enum_subheader</a> );
<a name="l00070"></a>00070     assert( index == 0 );
<a name="l00071"></a>00071     <span class="comment">//file header is the first thing</span>
<a name="l00072"></a>00072     p = 0;
<a name="l00073"></a>00073   }
<a name="l00074"></a>00074   <span class="keywordflow">else</span> {
<a name="l00075"></a>00075     <a class="code" href="classvil__nitf2__header.html#a21de72b17d4eea0480e9bf80bdc63c07">vil_nitf2_header::section_type</a> preceding_section = (<a class="code" href="classvil__nitf2__header.html#a21de72b17d4eea0480e9bf80bdc63c07">vil_nitf2_header::section_type</a>)(sec-1);
<a name="l00076"></a>00076     p = <a class="code" href="classvil__nitf2__image.html#a2c74c82ea50cb8368c9c9c0c2ee46454">get_offset_to</a>( preceding_section, <a class="code" href="classvil__nitf2__header.html#acb17a244846f74f4212bc2ca1ba1bfd9a95d851814d8da0b9760032dea0f887c2">vil_nitf2_header::enum_subheader</a>, 0 ) +
<a name="l00077"></a>00077         <a class="code" href="classvil__nitf2__image.html#a394f261e5bc29ecf1d8abf176bb9ac71">size_to</a>( preceding_section, <a class="code" href="classvil__nitf2__header.html#acb17a244846f74f4212bc2ca1ba1bfd9a95d851814d8da0b9760032dea0f887c2">vil_nitf2_header::enum_subheader</a>, -1 ) +
<a name="l00078"></a>00078         <a class="code" href="classvil__nitf2__image.html#a394f261e5bc29ecf1d8abf176bb9ac71">size_to</a>( sec, por, index );
<a name="l00079"></a>00079   }
<a name="l00080"></a>00080   <span class="keywordflow">return</span> p;
<a name="l00081"></a>00081 }
<a name="l00082"></a>00082 
<a name="l00083"></a><a class="code" href="classvil__nitf2__image.html#a394f261e5bc29ecf1d8abf176bb9ac71">00083</a> <a class="code" href="vil__stream_8h.html#aa5e912c853d0dd23b24eefd6f6e5a3a4">vil_streampos</a> <a class="code" href="classvil__nitf2__image.html#a394f261e5bc29ecf1d8abf176bb9ac71">vil_nitf2_image::size_to</a>(<a class="code" href="classvil__nitf2__header.html#a21de72b17d4eea0480e9bf80bdc63c07">vil_nitf2_header::section_type</a> sec,
<a name="l00084"></a>00084                                        <a class="code" href="classvil__nitf2__header.html#acb17a244846f74f4212bc2ca1ba1bfd9">vil_nitf2_header::portion_type</a> por,
<a name="l00085"></a>00085                                        <span class="keywordtype">int</span> index )<span class="keyword"> const</span>
<a name="l00086"></a>00086 <span class="keyword"></span>{
<a name="l00087"></a>00087   <span class="keywordflow">if</span> ( sec == <a class="code" href="classvil__nitf2__header.html#a21de72b17d4eea0480e9bf80bdc63c07a92d21119b3a8d85e25f8368d5de6802f">vil_nitf2_header::enum_file_header</a> ) {
<a name="l00088"></a>00088     <span class="keywordflow">if</span> ( index == -1 ) {
<a name="l00089"></a>00089       <span class="keywordtype">int</span> file_header_size;
<a name="l00090"></a>00090       <a class="code" href="classvil__nitf2__image.html#a9f399d9b7d273ab05cbed4d49d67bdce">m_file_header</a>.<a class="code" href="classvil__nitf2__header.html#ada6daeb0eb8efc6a44b7d17a8a77b47e">get_property</a>(<span class="stringliteral">&quot;HL&quot;</span>, file_header_size);
<a name="l00091"></a>00091       <span class="keywordflow">return</span> (<a class="code" href="vil__stream_8h.html#aa5e912c853d0dd23b24eefd6f6e5a3a4">vil_streampos</a>)file_header_size;
<a name="l00092"></a>00092     }
<a name="l00093"></a>00093     <span class="keywordflow">else</span> {
<a name="l00094"></a>00094       <span class="keywordflow">return</span> 0;
<a name="l00095"></a>00095     }
<a name="l00096"></a>00096   }
<a name="l00097"></a>00097 
<a name="l00098"></a>00098   <a class="code" href="vil__stream_8h.html#aa5e912c853d0dd23b24eefd6f6e5a3a4">vil_streampos</a> offset = 0;
<a name="l00099"></a>00099   <span class="comment">//if -1 specified, then we want to go past all of them... that is onto the next</span>
<a name="l00100"></a>00100   <span class="comment">//section</span>
<a name="l00101"></a>00101   <span class="keywordtype">bool</span> going_past_end = <span class="keyword">false</span>;
<a name="l00102"></a>00102   <span class="keywordflow">if</span> ( index == -1 ) {
<a name="l00103"></a>00103     <span class="keywordtype">int</span> num_segments;
<a name="l00104"></a>00104     <a class="code" href="classvil__nitf2__image.html#a9f399d9b7d273ab05cbed4d49d67bdce">m_file_header</a>.<a class="code" href="classvil__nitf2__header.html#ada6daeb0eb8efc6a44b7d17a8a77b47e">get_property</a>(<a class="code" href="classvil__nitf2__header.html#a0ec31e0f1a71e4920e3e2fe9393dc4c4">vil_nitf2_header::section_num_tag</a>(sec), num_segments);
<a name="l00105"></a>00105     index = num_segments;
<a name="l00106"></a>00106     going_past_end = <span class="keyword">true</span>;
<a name="l00107"></a>00107   }
<a name="l00108"></a>00108   vcl_string sh = <a class="code" href="classvil__nitf2__header.html#af7bc0af69912c4b35eac09401391fe45">vil_nitf2_header::section_len_header_tag</a>( sec );
<a name="l00109"></a>00109   vcl_string s  = <a class="code" href="classvil__nitf2__header.html#a3b9aebd152a8b8921eeba1463910845e">vil_nitf2_header::section_len_data_tag</a>( sec );
<a name="l00110"></a>00110   <span class="keywordtype">int</span> i;
<a name="l00111"></a>00111   <span class="keywordflow">for</span> (i = 0 ; i &lt; index ; i++) {
<a name="l00112"></a>00112     <span class="keywordtype">int</span> current_header_size;
<a name="l00113"></a>00113     <a class="code" href="classvil__nitf2__image.html#a9f399d9b7d273ab05cbed4d49d67bdce">m_file_header</a>.<a class="code" href="classvil__nitf2__header.html#ada6daeb0eb8efc6a44b7d17a8a77b47e">get_property</a>(sh, i, current_header_size);
<a name="l00114"></a>00114     offset += current_header_size;
<a name="l00115"></a>00115     <span class="keywordflow">if</span> ( sec == <a class="code" href="classvil__nitf2__header.html#a21de72b17d4eea0480e9bf80bdc63c07a7bc500878cac7875e7916a3c700287f4">vil_nitf2_header::enum_image_segments</a> ){
<a name="l00116"></a>00116       <a class="code" href="vil__nitf2_8h.html#ae26b5e7f3369763bb83fcee8c676a9d6">vil_nitf2_long</a> current_data_size;
<a name="l00117"></a>00117       <a class="code" href="classvil__nitf2__image.html#a9f399d9b7d273ab05cbed4d49d67bdce">m_file_header</a>.<a class="code" href="classvil__nitf2__header.html#ada6daeb0eb8efc6a44b7d17a8a77b47e">get_property</a>(s, i, current_data_size);
<a name="l00118"></a>00118       offset += current_data_size;
<a name="l00119"></a>00119     }
<a name="l00120"></a>00120     <span class="keywordflow">else</span> {
<a name="l00121"></a>00121       <span class="keywordtype">int</span> current_data_size;
<a name="l00122"></a>00122       <a class="code" href="classvil__nitf2__image.html#a9f399d9b7d273ab05cbed4d49d67bdce">m_file_header</a>.<a class="code" href="classvil__nitf2__header.html#ada6daeb0eb8efc6a44b7d17a8a77b47e">get_property</a>(s, i, current_data_size);
<a name="l00123"></a>00123       offset += current_data_size;
<a name="l00124"></a>00124     }
<a name="l00125"></a>00125   }
<a name="l00126"></a>00126   <span class="comment">//we are now at the proper index&#39;s subheader... if we need to get to the data</span>
<a name="l00127"></a>00127   <span class="comment">//we&#39;ve got one more jump to do</span>
<a name="l00128"></a>00128   <span class="keywordflow">if</span> ( por == <a class="code" href="classvil__nitf2__header.html#acb17a244846f74f4212bc2ca1ba1bfd9ab0a9cccb7f3c136039feb7bb49523ec4">vil_nitf2_header::enum_data</a> ) {
<a name="l00129"></a>00129     <span class="comment">// if we&#39;ve skipped past all the segments, then it doesn&#39;t make any sense</span>
<a name="l00130"></a>00130     <span class="comment">// to skip to the &quot;data&quot; section</span>
<a name="l00131"></a>00131     <span class="keywordflow">if</span> ( going_past_end ) { assert(!<span class="stringliteral">&quot;skipped past all segments&quot;</span>); <span class="keywordflow">return</span> 0L; }
<a name="l00132"></a>00132     <span class="keywordtype">int</span> current_header_size;
<a name="l00133"></a>00133     <a class="code" href="classvil__nitf2__image.html#a9f399d9b7d273ab05cbed4d49d67bdce">m_file_header</a>.<a class="code" href="classvil__nitf2__header.html#ada6daeb0eb8efc6a44b7d17a8a77b47e">get_property</a>(sh, i, current_header_size);
<a name="l00134"></a>00134     offset += current_header_size;
<a name="l00135"></a>00135   }
<a name="l00136"></a>00136   <span class="keywordflow">return</span> offset;
<a name="l00137"></a>00137 }
<a name="l00138"></a>00138 
<a name="l00139"></a>00139 <a class="code" href="vil__fwd_8h.html#a1ab8bb453c54ad7291c3556612fe32d1">vil_image_view_base_sptr</a> ( *<a class="code" href="classvil__nitf2__image.html#ae6375f2e7919051ddab668e1e9261e91" title="All instances of vil_nitf2_image will use s_decode_jpeg_2000() to decode JPEG 2000 streams if you set...">vil_nitf2_image::s_decode_jpeg_2000</a> )
<a name="l00140"></a>00140 ( <a class="code" href="classvil__stream.html" title="Stream interface for VIL image loaders.">vil_stream</a>* vs, <span class="keywordtype">unsigned</span> i0, <span class="keywordtype">unsigned</span> ni, <span class="keywordtype">unsigned</span> j0, <span class="keywordtype">unsigned</span> nj, <span class="keywordtype">double</span> i_factor, <span class="keywordtype">double</span> j_factor ) = 0;
<a name="l00141"></a>00141 
<a name="l00142"></a><a class="code" href="classvil__nitf2__image.html#aef7b76547973e55e527ce61e63944583">00142</a> <a class="code" href="classvil__nitf2__image.html#aef7b76547973e55e527ce61e63944583" title="Instantiate an image resource, but doesn&#39;t read anything.">vil_nitf2_image::vil_nitf2_image</a>(<a class="code" href="classvil__stream.html" title="Stream interface for VIL image loaders.">vil_stream</a>* is)
<a name="l00143"></a>00143   : m_stream(is),
<a name="l00144"></a>00144     m_current_image_index(0)
<a name="l00145"></a>00145 {
<a name="l00146"></a>00146   <a class="code" href="classvil__nitf2__image.html#a03827b9f7535dde73fe41a46007a1ad9">m_stream</a>-&gt;<a class="code" href="classvil__stream.html#af42d16e949836ad3792712a6aefc3178" title="up/down the reference count.">ref</a>();
<a name="l00147"></a>00147 }
<a name="l00148"></a>00148 
<a name="l00149"></a><a class="code" href="classvil__nitf2__image.html#a6b11fe2734c25ad9c02fce7e3932fc9d">00149</a> <a class="code" href="classvil__nitf2__image.html#aef7b76547973e55e527ce61e63944583" title="Instantiate an image resource, but doesn&#39;t read anything.">vil_nitf2_image::vil_nitf2_image</a>(<span class="keyword">const</span> vcl_string&amp; filePath, <span class="keyword">const</span> <span class="keywordtype">char</span>* mode)
<a name="l00150"></a>00150   : m_current_image_index(0)
<a name="l00151"></a>00151 {
<a name="l00152"></a>00152 <span class="preprocessor">#ifdef VIL_USE_FSTREAM64</span>
<a name="l00153"></a>00153 <span class="preprocessor"></span>  <a class="code" href="classvil__nitf2__image.html#a03827b9f7535dde73fe41a46007a1ad9">m_stream</a> = <span class="keyword">new</span> vil_stream_fstream64(filePath.c_str(), mode);
<a name="l00154"></a>00154 <span class="preprocessor">#else //VIL_USE_FSTREAM64</span>
<a name="l00155"></a>00155 <span class="preprocessor"></span>  <a class="code" href="classvil__nitf2__image.html#a03827b9f7535dde73fe41a46007a1ad9">m_stream</a> = <span class="keyword">new</span> <a class="code" href="classvil__stream__fstream.html" title="A vil_stream implementation using vcl_fstream.">vil_stream_fstream</a>(filePath.c_str(), mode);
<a name="l00156"></a>00156 <span class="preprocessor">#endif //VIL_USE_FSTREAM64</span>
<a name="l00157"></a>00157 <span class="preprocessor"></span>  m_stream-&gt;<a class="code" href="classvil__stream.html#af42d16e949836ad3792712a6aefc3178" title="up/down the reference count.">ref</a>();
<a name="l00158"></a>00158 }
<a name="l00159"></a>00159 
<a name="l00160"></a><a class="code" href="classvil__nitf2__image.html#ad918aeb1d09146e9af4ca9bf6886f7e3">00160</a> <span class="keywordtype">void</span> <a class="code" href="classvil__nitf2__image.html#ad918aeb1d09146e9af4ca9bf6886f7e3">vil_nitf2_image::clear_image_headers</a>()
<a name="l00161"></a>00161 {
<a name="l00162"></a>00162   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0 ; i &lt; <a class="code" href="classvil__nitf2__image.html#aa134d164887a773d42db2d603315bdd6">m_image_headers</a>.size() ; i++) {
<a name="l00163"></a>00163     <span class="keyword">delete</span> <a class="code" href="classvil__nitf2__image.html#aa134d164887a773d42db2d603315bdd6">m_image_headers</a>[i];
<a name="l00164"></a>00164   }
<a name="l00165"></a>00165   <a class="code" href="classvil__nitf2__image.html#aa134d164887a773d42db2d603315bdd6">m_image_headers</a>.clear();
<a name="l00166"></a>00166 }
<a name="l00167"></a>00167 
<a name="l00168"></a><a class="code" href="classvil__nitf2__image.html#aca45b61c8aa5f191635cd1c0a10b4237">00168</a> <span class="keywordtype">void</span> <a class="code" href="classvil__nitf2__image.html#aca45b61c8aa5f191635cd1c0a10b4237">vil_nitf2_image::clear_des</a>()
<a name="l00169"></a>00169 {
<a name="l00170"></a>00170   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0 ; i &lt; <a class="code" href="classvil__nitf2__image.html#a42bf751f30422e067e5bb42a742aa30c">m_des</a>.size() ; i++) {
<a name="l00171"></a>00171     <span class="keyword">delete</span> <a class="code" href="classvil__nitf2__image.html#a42bf751f30422e067e5bb42a742aa30c">m_des</a>[i];
<a name="l00172"></a>00172   }
<a name="l00173"></a>00173   <a class="code" href="classvil__nitf2__image.html#a42bf751f30422e067e5bb42a742aa30c">m_des</a>.clear();
<a name="l00174"></a>00174 }
<a name="l00175"></a>00175 
<a name="l00176"></a>00176 
<a name="l00177"></a><a class="code" href="classvil__nitf2__image.html#a211d3db4bb8e6c3bdaf344ba774324f5">00177</a> <a class="code" href="classvil__nitf2__image.html#a211d3db4bb8e6c3bdaf344ba774324f5">vil_nitf2_image::~vil_nitf2_image</a>()
<a name="l00178"></a>00178 {
<a name="l00179"></a>00179   <a class="code" href="classvil__nitf2__image.html#a03827b9f7535dde73fe41a46007a1ad9">m_stream</a>-&gt;<a class="code" href="classvil__stream.html#af66805a7e1bd2dff8b5d8516facc24b2">unref</a>();
<a name="l00180"></a>00180   <a class="code" href="classvil__nitf2__image.html#ad918aeb1d09146e9af4ca9bf6886f7e3">clear_image_headers</a>();
<a name="l00181"></a>00181   <a class="code" href="classvil__nitf2__image.html#aca45b61c8aa5f191635cd1c0a10b4237">clear_des</a>();
<a name="l00182"></a>00182 }
<a name="l00183"></a>00183 
<a name="l00184"></a><a class="code" href="classvil__nitf2__image.html#a3ef134481abe4da9f233b1c2bc58ffdb">00184</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="classvil__nitf2__image.html#a3ef134481abe4da9f233b1c2bc58ffdb">vil_nitf2_image::current_image</a>()<span class="keyword"> const</span>
<a name="l00185"></a>00185 <span class="keyword"></span>{
<a name="l00186"></a>00186   <span class="keywordflow">return</span> <a class="code" href="classvil__nitf2__image.html#a0a5d803cdef2dc53661f55dc0f5fcb6e">m_current_image_index</a>;
<a name="l00187"></a>00187 }
<a name="l00188"></a>00188 
<a name="l00189"></a><a class="code" href="classvil__nitf2__image.html#aedb2f5b1f593c08ff7a59f2ae657fafa">00189</a> <span class="keywordtype">void</span> <a class="code" href="classvil__nitf2__image.html#aedb2f5b1f593c08ff7a59f2ae657fafa" title="Since the VIL API (eg.">vil_nitf2_image::set_current_image</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> index)
<a name="l00190"></a>00190 {
<a name="l00191"></a>00191   assert(index &lt; <a class="code" href="classvil__nitf2__image.html#aa134d164887a773d42db2d603315bdd6">m_image_headers</a>.size());
<a name="l00192"></a>00192   <a class="code" href="classvil__nitf2__image.html#a0a5d803cdef2dc53661f55dc0f5fcb6e">m_current_image_index</a> = index;
<a name="l00193"></a>00193 }
<a name="l00194"></a>00194 
<a name="l00195"></a><a class="code" href="classvil__nitf2__image.html#aad3a16d21129253ee315c2e6058ee347">00195</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="classvil__nitf2__image.html#aad3a16d21129253ee315c2e6058ee347">vil_nitf2_image::nimages</a>()<span class="keyword"> const</span>
<a name="l00196"></a>00196 <span class="keyword"></span>{
<a name="l00197"></a>00197   <span class="keywordtype">int</span> num_images;
<a name="l00198"></a>00198   <span class="keywordflow">if</span> (<a class="code" href="classvil__nitf2__image.html#a9f399d9b7d273ab05cbed4d49d67bdce">m_file_header</a>.<a class="code" href="classvil__nitf2__header.html#ada6daeb0eb8efc6a44b7d17a8a77b47e">get_property</a>(<span class="stringliteral">&quot;NUMI&quot;</span>, num_images)) <span class="keywordflow">return</span> num_images;
<a name="l00199"></a>00199   <span class="keywordflow">else</span> <span class="keywordflow">return</span> 0;
<a name="l00200"></a>00200 }
<a name="l00201"></a>00201 
<a name="l00202"></a><a class="code" href="classvil__nitf2__image.html#a2c03fd96e72cbd6dc8960e9bf7e6be6f">00202</a> <a class="code" href="vil__stream_8h.html#aa5e912c853d0dd23b24eefd6f6e5a3a4">vil_streampos</a> <a class="code" href="classvil__nitf2__image.html#a2c03fd96e72cbd6dc8960e9bf7e6be6f">vil_nitf2_image::get_offset_to_image_data_block_band</a>(
<a name="l00203"></a>00203   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> image_index, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> block_index_x,<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> block_index_y, <span class="keywordtype">int</span> bandIndex)<span class="keyword"> const</span>
<a name="l00204"></a>00204 <span class="keyword"></span>{
<a name="l00205"></a>00205   <span class="comment">//band index is ignored when i_mode != &quot;S&quot;</span>
<a name="l00206"></a>00206   vcl_string i_mode;
<a name="l00207"></a>00207   <a class="code" href="classvil__nitf2__image.html#a7cbd2adcac7d675a33c6a68dc3bc2c49">current_image_header</a>()-&gt;<a class="code" href="classvil__nitf2__image__subheader.html#ab2db73d2db795da44f1ca580bb672ad6" title="Sets out_value to the value of field specified by tag.">get_property</a>(<span class="stringliteral">&quot;IMODE&quot;</span>, i_mode);
<a name="l00208"></a>00208 
<a name="l00209"></a>00209   <span class="comment">//my image header precedes me.  Find out the offset to that, then add on the size of</span>
<a name="l00210"></a>00210   <span class="comment">//that header... then you have the offset to me (the data)</span>
<a name="l00211"></a>00211   <a class="code" href="vil__stream_8h.html#aa5e912c853d0dd23b24eefd6f6e5a3a4">vil_streampos</a> offset =
<a name="l00212"></a>00212     <a class="code" href="classvil__nitf2__image.html#a2c74c82ea50cb8368c9c9c0c2ee46454">get_offset_to</a>( <a class="code" href="classvil__nitf2__header.html#a21de72b17d4eea0480e9bf80bdc63c07a7bc500878cac7875e7916a3c700287f4">vil_nitf2_header::enum_image_segments</a>, <a class="code" href="classvil__nitf2__header.html#acb17a244846f74f4212bc2ca1ba1bfd9ab0a9cccb7f3c136039feb7bb49523ec4">vil_nitf2_header::enum_data</a>, image_index );
<a name="l00213"></a>00213 <span class="comment"></span>
<a name="l00214"></a>00214 <span class="comment">  //////////////////////////////////////////////////</span>
<a name="l00215"></a>00215 <span class="comment"></span>  <span class="comment">// now get the position to the desired block/band</span><span class="comment"></span>
<a name="l00216"></a>00216 <span class="comment">  //////////////////////////////////////////////////</span>
<a name="l00217"></a>00217 <span class="comment"></span>  <span class="keywordtype">int</span> bits_per_pixel_per_band;
<a name="l00218"></a>00218   <a class="code" href="classvil__nitf2__image.html#a7cbd2adcac7d675a33c6a68dc3bc2c49">current_image_header</a>()-&gt;<a class="code" href="classvil__nitf2__image__subheader.html#ab2db73d2db795da44f1ca580bb672ad6" title="Sets out_value to the value of field specified by tag.">get_property</a>(<span class="stringliteral">&quot;NBPP&quot;</span>, bits_per_pixel_per_band);
<a name="l00219"></a>00219 
<a name="l00220"></a>00220 <span class="preprocessor">#if 0  //Not valid if blocks are partially filled (JLM 11/03/07)</span>
<a name="l00221"></a>00221 <span class="preprocessor"></span>  <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> bytes_per_band = <a class="code" href="classvil__nitf2__image.html#aed66aafd061126fcd1a5a4ddfab0fef7" title="Dimensions: Planes x ni x nj.">ni</a>() * <a class="code" href="classvil__nitf2__image.html#a04188de81e3efe282dea92e849770201" title="Dimensions: Planes x ni x nj.">nj</a>() * bits_per_pixel_per_band / 8;
<a name="l00222"></a>00222 <span class="preprocessor">#endif</span>
<a name="l00223"></a>00223 <span class="preprocessor"></span>  <span class="comment">// New version</span>
<a name="l00224"></a>00224   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> nbi = <a class="code" href="classvil__nitf2__image.html#a6cc711fe72e79ea99015896033897a96" title="Number of blocks in image width.">n_block_i</a>(), nbj = <a class="code" href="classvil__nitf2__image.html#ae6915940406ed10fb70e771cc4efd083" title="Number of blocks in image height.">n_block_j</a>();
<a name="l00225"></a>00225   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> sbi = <a class="code" href="classvil__nitf2__image.html#afc2bb100fc2912e252d6cb72dc2ea0fa" title="Block size in columns.">size_block_i</a>(), sbj = <a class="code" href="classvil__nitf2__image.html#a4b8a7b6fa7f7c7b998a69f3672933c4f" title="Block size in rows.">size_block_j</a>();
<a name="l00226"></a>00226   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> bytes_per_band = nbi*nbj*sbi*sbj*bits_per_pixel_per_band/8;
<a name="l00227"></a>00227 
<a name="l00228"></a>00228   <span class="comment">// What we do here depends on whether we have a data_mask_table or not and</span>
<a name="l00229"></a>00229   <span class="comment">// whether i_mode == &quot;S&quot;.  The most complex case is i_mode != &quot;S&quot; and we have</span>
<a name="l00230"></a>00230   <span class="comment">// a dataMask table.  In that case, we get some information from the table and</span>
<a name="l00231"></a>00231   <span class="comment">// compute some ourselves.  Here are all the possible scenarios handled here:</span>
<a name="l00232"></a>00232   <span class="comment">//   i_mode == &quot;S&quot; and have data_mask_table: just ask data_mask_table for the offset</span>
<a name="l00233"></a>00233   <span class="comment">//   i_mode == &quot;S&quot; and don&#39;t have data_mask_table: compute it ourselves right here</span>
<a name="l00234"></a>00234   <span class="comment">//   i_mode != &quot;S&quot; and have data_mask_table: ask the data_mask_table for offset to the</span>
<a name="l00235"></a>00235   <span class="comment">//      block we want; then compute the offset to the band ourselves here</span>
<a name="l00236"></a>00236   <span class="comment">//   i_mode != &quot;S&quot; and don&#39;t have data_mask_table: compute both band and block offset</span>
<a name="l00237"></a>00237   <span class="comment">//      ourselves here</span>
<a name="l00238"></a>00238   <span class="comment">// If it sounds complex, blame the NITF 2.1 spec for that</span>
<a name="l00239"></a>00239   <span class="keyword">const</span> <a class="code" href="classvil__nitf2__data__mask__table.html" title="This class is responsible for parsing a NITF 2.1 data mask table.">vil_nitf2_data_mask_table</a>* data_mask_table = <a class="code" href="classvil__nitf2__image.html#a7cbd2adcac7d675a33c6a68dc3bc2c49">current_image_header</a>()-&gt;<a class="code" href="classvil__nitf2__image__subheader.html#a4779e539d13587775ba321536962577f">data_mask_table</a>();
<a name="l00240"></a>00240   <span class="keywordflow">if</span> (data_mask_table) {
<a name="l00241"></a>00241     offset += data_mask_table-&gt;<a class="code" href="classvil__nitf2__data__mask__table.html#a0cc77b79a8309180167d728794b6e4f2">blocked_image_data_offset</a>();
<a name="l00242"></a>00242   }
<a name="l00243"></a>00243   <span class="keywordflow">if</span> (data_mask_table &amp;&amp; data_mask_table-&gt;<a class="code" href="classvil__nitf2__data__mask__table.html#a18ddee917359a8cc350fa75f28dcfee7" title="If this function returns true, then you may call.">has_offset_table</a>()) {
<a name="l00244"></a>00244     <span class="comment">//have data mask table</span>
<a name="l00245"></a>00245     <span class="keywordtype">int</span> bI = i_mode == <span class="stringliteral">&quot;S&quot;</span> ? bandIndex : -1;
<a name="l00246"></a>00246     <span class="keywordflow">if</span> (data_mask_table-&gt;<a class="code" href="classvil__nitf2__data__mask__table.html#a246c96e3e589288b81c0797140c88c16" title="Returns true iff this block is present in the data. False otherwise.">block_band_present</a>(block_index_x, block_index_y, bI))
<a name="l00247"></a>00247     {
<a name="l00248"></a>00248       <span class="keywordflow">return</span> 0;
<a name="l00249"></a>00249     }
<a name="l00250"></a>00250     offset += data_mask_table-&gt;<a class="code" href="classvil__nitf2__data__mask__table.html#a53d5273e5c7bb3d810d97bf44fb48e4b" title="if imode == &quot;S&quot;, then the band argument is used and I will return the offset to &#39;band&#39; if imode != ...">block_band_offset</a>(block_index_x, block_index_y, bI);
<a name="l00251"></a>00251   }
<a name="l00252"></a>00252   <span class="keywordflow">else</span> {
<a name="l00253"></a>00253     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> pixels_per_block = <a class="code" href="classvil__nitf2__image.html#afc2bb100fc2912e252d6cb72dc2ea0fa" title="Block size in columns.">size_block_i</a>() * <a class="code" href="classvil__nitf2__image.html#a4b8a7b6fa7f7c7b998a69f3672933c4f" title="Block size in rows.">size_block_j</a>();
<a name="l00254"></a>00254     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> bits_per_band = pixels_per_block * bits_per_pixel_per_band;
<a name="l00255"></a>00255     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> bytes_per_block_per_band = bits_per_band / 8;
<a name="l00256"></a>00256     <span class="comment">//round up if remainder left over (this assumes that band/block boundaries</span>
<a name="l00257"></a>00257     <span class="comment">//always lie on byte boundaries.</span>
<a name="l00258"></a>00258     <span class="keywordflow">if</span> (bits_per_band % 8 != 0) bytes_per_block_per_band++;
<a name="l00259"></a>00259     <span class="keywordflow">if</span> (i_mode == <span class="stringliteral">&quot;S&quot;</span>) {
<a name="l00260"></a>00260       <span class="comment">//i_mode == &quot;S&quot; and not have data_mask_table</span>
<a name="l00261"></a>00261       <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> offset_to_desired_band = bandIndex * bytes_per_band;
<a name="l00262"></a>00262       <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> offset_to_desired_block = bytes_per_block_per_band * (block_index_y * <a class="code" href="classvil__nitf2__image.html#a6cc711fe72e79ea99015896033897a96" title="Number of blocks in image width.">n_block_i</a>() + block_index_x);
<a name="l00263"></a>00263       offset += offset_to_desired_band + offset_to_desired_block;
<a name="l00264"></a>00264     }
<a name="l00265"></a>00265     <span class="keywordflow">else</span> {
<a name="l00266"></a>00266       <span class="comment">//i_mode != &quot;S&quot; and not have data_mask_table</span>
<a name="l00267"></a>00267       <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> block_size_bytes = bytes_per_block_per_band * <a class="code" href="classvil__nitf2__image.html#a414c7041b3b107444614743c8c959baf" title="return the image info of the current image.">nplanes</a>();
<a name="l00268"></a>00268       <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> offset_to_desired_block = block_size_bytes * (block_index_y * <a class="code" href="classvil__nitf2__image.html#a6cc711fe72e79ea99015896033897a96" title="Number of blocks in image width.">n_block_i</a>() + block_index_x);
<a name="l00269"></a>00269       offset += offset_to_desired_block;
<a name="l00270"></a>00270     }
<a name="l00271"></a>00271   }
<a name="l00272"></a>00272   <span class="keywordflow">if</span> (i_mode != <span class="stringliteral">&quot;S&quot;</span>) {
<a name="l00273"></a>00273     <span class="comment">//regardless of whether we had a data_mask_table or not, we&#39;ve only computed</span>
<a name="l00274"></a>00274     <span class="comment">//the offset to the desired block so far.  Now, we add on the offset to</span>
<a name="l00275"></a>00275     <span class="comment">//the desired band.</span>
<a name="l00276"></a>00276     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> offset_to_desired_band = bandIndex * bytes_per_band;
<a name="l00277"></a>00277     offset += offset_to_desired_band;
<a name="l00278"></a>00278   }
<a name="l00279"></a>00279   <span class="keywordflow">return</span> offset;
<a name="l00280"></a>00280 }
<a name="l00281"></a>00281 
<a name="l00282"></a><a class="code" href="classvil__nitf2__image.html#a2c5928ece92ea8d297dd3e098f2f9bab">00282</a> <span class="keywordtype">bool</span> <a class="code" href="classvil__nitf2__image.html#a2c5928ece92ea8d297dd3e098f2f9bab">vil_nitf2_image::parse_headers</a>()
<a name="l00283"></a>00283 {
<a name="l00284"></a>00284   <span class="keywordflow">if</span> (!<a class="code" href="classvil__nitf2__image.html#a03827b9f7535dde73fe41a46007a1ad9">m_stream</a>-&gt;<a class="code" href="classvil__stream.html#a5062b8aff09e290556e784762e436f94" title="Return false if the stream is broken.">ok</a>()) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00285"></a>00285   <span class="comment">//parse file header</span>
<a name="l00286"></a>00286   <a class="code" href="classvil__nitf2__image.html#a03827b9f7535dde73fe41a46007a1ad9">m_stream</a>-&gt;<a class="code" href="classvil__stream.html#ab592f40f2538ea648fc101a0adea1a6d" title="Goto file pointer.">seek</a>(0);
<a name="l00287"></a>00287   <span class="keywordflow">if</span> (!<a class="code" href="classvil__nitf2__image.html#a9f399d9b7d273ab05cbed4d49d67bdce">m_file_header</a>.<a class="code" href="classvil__nitf2__header.html#a52ac87e992002948f0529f7e7ab6bae0">read</a>(<a class="code" href="classvil__nitf2__image.html#a03827b9f7535dde73fe41a46007a1ad9">m_stream</a>)) {
<a name="l00288"></a>00288     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00289"></a>00289   }
<a name="l00290"></a>00290   <span class="comment">//now parse each image header</span>
<a name="l00291"></a>00291   <a class="code" href="classvil__nitf2__image.html#ad918aeb1d09146e9af4ca9bf6886f7e3">clear_image_headers</a>();
<a name="l00292"></a>00292   <a class="code" href="classvil__nitf2__image.html#aa134d164887a773d42db2d603315bdd6">m_image_headers</a>.resize(<a class="code" href="classvil__nitf2__image.html#aad3a16d21129253ee315c2e6058ee347">nimages</a>());
<a name="l00293"></a>00293   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0 ; i &lt; <a class="code" href="classvil__nitf2__image.html#aad3a16d21129253ee315c2e6058ee347">nimages</a>() ; i++) {
<a name="l00294"></a>00294     <a class="code" href="vil__stream_8h.html#aa5e912c853d0dd23b24eefd6f6e5a3a4">vil_streampos</a> offset = <a class="code" href="classvil__nitf2__image.html#a2c74c82ea50cb8368c9c9c0c2ee46454">get_offset_to</a>( <a class="code" href="classvil__nitf2__header.html#a21de72b17d4eea0480e9bf80bdc63c07a7bc500878cac7875e7916a3c700287f4">vil_nitf2_header::enum_image_segments</a>, <a class="code" href="classvil__nitf2__header.html#acb17a244846f74f4212bc2ca1ba1bfd9a95d851814d8da0b9760032dea0f887c2">vil_nitf2_header::enum_subheader</a>, i);
<a name="l00295"></a>00295     <a class="code" href="classvil__nitf2__image.html#a03827b9f7535dde73fe41a46007a1ad9">m_stream</a>-&gt;<a class="code" href="classvil__stream.html#ab592f40f2538ea648fc101a0adea1a6d" title="Goto file pointer.">seek</a>(offset);
<a name="l00296"></a>00296     <a class="code" href="classvil__nitf2__image.html#aa134d164887a773d42db2d603315bdd6">m_image_headers</a>[i] = <span class="keyword">new</span> <a class="code" href="classvil__nitf2__image__subheader.html" title="This class is responsible for parsing a NITF 2.1 image header.">vil_nitf2_image_subheader</a>(<a class="code" href="classvil__nitf2__image.html#a8465dc1c19136940f03003bc8ce66ec6">file_version</a>());
<a name="l00297"></a>00297     <span class="keywordflow">if</span> (!<a class="code" href="classvil__nitf2__image.html#aa134d164887a773d42db2d603315bdd6">m_image_headers</a>[i]-&gt;read(<a class="code" href="classvil__nitf2__image.html#a03827b9f7535dde73fe41a46007a1ad9">m_stream</a>)) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00298"></a>00298   }
<a name="l00299"></a>00299 
<a name="l00300"></a>00300   <span class="comment">//now parse all the DESs (if any)</span>
<a name="l00301"></a>00301   <a class="code" href="classvil__nitf2__image.html#aca45b61c8aa5f191635cd1c0a10b4237">clear_des</a>();
<a name="l00302"></a>00302   <span class="keywordtype">int</span> num_des;
<a name="l00303"></a>00303   <a class="code" href="classvil__nitf2__image.html#a9f399d9b7d273ab05cbed4d49d67bdce">m_file_header</a>.<a class="code" href="classvil__nitf2__header.html#ada6daeb0eb8efc6a44b7d17a8a77b47e">get_property</a>( <span class="stringliteral">&quot;NUMDES&quot;</span>, num_des );
<a name="l00304"></a>00304   <a class="code" href="classvil__nitf2__image.html#a42bf751f30422e067e5bb42a742aa30c">m_des</a>.resize( num_des );
<a name="l00305"></a>00305   <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> j = 0 ; j &lt; num_des ; j++ ){
<a name="l00306"></a>00306     <a class="code" href="vil__stream_8h.html#aa5e912c853d0dd23b24eefd6f6e5a3a4">vil_streampos</a> offset = <a class="code" href="classvil__nitf2__image.html#a2c74c82ea50cb8368c9c9c0c2ee46454">get_offset_to</a>( <a class="code" href="classvil__nitf2__header.html#a21de72b17d4eea0480e9bf80bdc63c07a4c8c5efb80af310d9f2744e10af787cb">vil_nitf2_header::enum_data_extension_segments</a>, <a class="code" href="classvil__nitf2__header.html#acb17a244846f74f4212bc2ca1ba1bfd9a95d851814d8da0b9760032dea0f887c2">vil_nitf2_header::enum_subheader</a>, j);
<a name="l00307"></a>00307     <a class="code" href="classvil__nitf2__image.html#a03827b9f7535dde73fe41a46007a1ad9">m_stream</a>-&gt;<a class="code" href="classvil__stream.html#ab592f40f2538ea648fc101a0adea1a6d" title="Goto file pointer.">seek</a>(offset);
<a name="l00308"></a>00308     <span class="keywordtype">int</span> data_width;
<a name="l00309"></a>00309     <a class="code" href="classvil__nitf2__image.html#a9f399d9b7d273ab05cbed4d49d67bdce">m_file_header</a>.<a class="code" href="classvil__nitf2__header.html#ada6daeb0eb8efc6a44b7d17a8a77b47e">get_property</a>( <span class="stringliteral">&quot;LD&quot;</span>, j, data_width );
<a name="l00310"></a>00310     <a class="code" href="classvil__nitf2__image.html#a42bf751f30422e067e5bb42a742aa30c">m_des</a>[j] = <span class="keyword">new</span> <a class="code" href="classvil__nitf2__des.html">vil_nitf2_des</a>(<a class="code" href="classvil__nitf2__image.html#a8465dc1c19136940f03003bc8ce66ec6">file_version</a>(), data_width);
<a name="l00311"></a>00311     <span class="keywordflow">if</span> (!<a class="code" href="classvil__nitf2__image.html#a42bf751f30422e067e5bb42a742aa30c">m_des</a>[j]-&gt;read(<a class="code" href="classvil__nitf2__image.html#a03827b9f7535dde73fe41a46007a1ad9">m_stream</a>)) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00312"></a>00312   }
<a name="l00313"></a>00313   <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00314"></a>00314 }
<a name="l00315"></a>00315 
<a name="l00316"></a><a class="code" href="classvil__nitf2__image.html#a8465dc1c19136940f03003bc8ce66ec6">00316</a> <a class="code" href="classvil__nitf2__classification.html#ace0db53f02e1d9aa29b2b815213013e5">vil_nitf2_classification::file_version</a> <a class="code" href="classvil__nitf2__image.html#a8465dc1c19136940f03003bc8ce66ec6">vil_nitf2_image::file_version</a>()<span class="keyword"> const</span>
<a name="l00317"></a>00317 <span class="keyword"></span>{
<a name="l00318"></a>00318   <span class="keywordflow">return</span> <a class="code" href="classvil__nitf2__image.html#a9f399d9b7d273ab05cbed4d49d67bdce">m_file_header</a>.<a class="code" href="classvil__nitf2__header.html#a90fae07231d699533a356ac9ae74ed97">file_version</a>();
<a name="l00319"></a>00319 }
<a name="l00320"></a>00320 
<a name="l00321"></a><a class="code" href="classvil__nitf2__image.html#a86315482f46c6522ae26d9f2e7ae9683">00321</a> <span class="keywordtype">char</span> <span class="keyword">const</span> * <a class="code" href="classvil__nitf2__image.html#a86315482f46c6522ae26d9f2e7ae9683" title="returns &quot;nitf vM.N&quot;.">vil_nitf2_image::file_format</a>()<span class="keyword"> const</span>
<a name="l00322"></a>00322 <span class="keyword"></span>{
<a name="l00323"></a>00323 <a class="code" href="classvil__nitf2__classification.html#ace0db53f02e1d9aa29b2b815213013e5">vil_nitf2_classification::file_version</a> <a class="codeRef" doxygen="core_vnl.tag:../../../core/vnl/html/" href="../../../core/vnl/html/vnl__vector_8h.html#a38bf1e5e0427bdeba2b469eea9befc23">v</a> = <a class="code" href="classvil__nitf2__image.html#a8465dc1c19136940f03003bc8ce66ec6">file_version</a>();
<a name="l00324"></a>00324   <span class="keywordflow">switch</span> (v)
<a name="l00325"></a>00325   {
<a name="l00326"></a>00326     <span class="keywordflow">case</span> <a class="code" href="classvil__nitf2__classification.html#ace0db53f02e1d9aa29b2b815213013e5a627c07ff9f8e31be11f2dc218edcc1e3">vil_nitf2_classification::V_UNKNOWN</a> :
<a name="l00327"></a>00327       <span class="keywordflow">return</span> <span class="stringliteral">&quot;unknown&quot;</span>;
<a name="l00328"></a>00328     <span class="keywordflow">case</span> <a class="code" href="classvil__nitf2__classification.html#ace0db53f02e1d9aa29b2b815213013e5ac30293744cc8ace05da0662dda009985">vil_nitf2_classification::V_NITF_10</a> :
<a name="l00329"></a>00329       <span class="keywordflow">return</span> <span class="stringliteral">&quot;nitf10&quot;</span>;
<a name="l00330"></a>00330     <span class="keywordflow">case</span> <a class="code" href="classvil__nitf2__classification.html#ace0db53f02e1d9aa29b2b815213013e5a05817ae4ca225c5a7123f65bd73be280">vil_nitf2_classification::V_NITF_20</a> :
<a name="l00331"></a>00331       <span class="keywordflow">return</span> <span class="stringliteral">&quot;nitf20&quot;</span>;
<a name="l00332"></a>00332     <span class="keywordflow">case</span> <a class="code" href="classvil__nitf2__classification.html#ace0db53f02e1d9aa29b2b815213013e5ab5f66337398f662105f0acef05ebec2d">vil_nitf2_classification::V_NITF_21</a> :
<a name="l00333"></a>00333       <span class="keywordflow">return</span> <span class="stringliteral">&quot;nitf21&quot;</span>;
<a name="l00334"></a>00334     <span class="keywordflow">default</span>:
<a name="l00335"></a>00335       <span class="keywordflow">return</span> <span class="stringliteral">&quot;unknown&quot;</span>;
<a name="l00336"></a>00336   }
<a name="l00337"></a>00337 }
<a name="l00338"></a>00338 
<a name="l00339"></a><a class="code" href="classvil__nitf2__image.html#a7cbd2adcac7d675a33c6a68dc3bc2c49">00339</a> <span class="keyword">const</span> <a class="code" href="classvil__nitf2__image__subheader.html" title="This class is responsible for parsing a NITF 2.1 image header.">vil_nitf2_image_subheader</a>* <a class="code" href="classvil__nitf2__image.html#a7cbd2adcac7d675a33c6a68dc3bc2c49">vil_nitf2_image::current_image_header</a>()<span class="keyword"> const</span>
<a name="l00340"></a>00340 <span class="keyword"></span>{
<a name="l00341"></a>00341   assert(<a class="code" href="classvil__nitf2__image.html#a0a5d803cdef2dc53661f55dc0f5fcb6e">m_current_image_index</a> &lt; <a class="code" href="classvil__nitf2__image.html#aa134d164887a773d42db2d603315bdd6">m_image_headers</a>.size());
<a name="l00342"></a>00342   <span class="keywordflow">return</span> <a class="code" href="classvil__nitf2__image.html#aa134d164887a773d42db2d603315bdd6">m_image_headers</a>[ <a class="code" href="classvil__nitf2__image.html#a0a5d803cdef2dc53661f55dc0f5fcb6e">m_current_image_index</a> ];
<a name="l00343"></a>00343 }
<a name="l00344"></a>00344 
<a name="l00345"></a><a class="code" href="classvil__nitf2__image.html#a414c7041b3b107444614743c8c959baf">00345</a> <span class="keywordtype">unsigned</span> <a class="code" href="classvil__nitf2__image.html#a414c7041b3b107444614743c8c959baf" title="return the image info of the current image.">vil_nitf2_image::nplanes</a>()<span class="keyword"> const</span>
<a name="l00346"></a>00346 <span class="keyword"></span>{
<a name="l00347"></a>00347   <span class="keywordflow">return</span> <a class="code" href="classvil__nitf2__image.html#a7cbd2adcac7d675a33c6a68dc3bc2c49">current_image_header</a>()-&gt;<a class="code" href="classvil__nitf2__image__subheader.html#aa162a52fad8ddd033323c633e95eb8c0">nplanes</a>();
<a name="l00348"></a>00348 }
<a name="l00349"></a>00349 
<a name="l00350"></a><a class="code" href="classvil__nitf2__image.html#aed66aafd061126fcd1a5a4ddfab0fef7">00350</a> <span class="keywordtype">unsigned</span> <a class="code" href="classvil__nitf2__image.html#aed66aafd061126fcd1a5a4ddfab0fef7" title="Dimensions: Planes x ni x nj.">vil_nitf2_image::ni</a>()<span class="keyword"> const</span>
<a name="l00351"></a>00351 <span class="keyword"></span>{
<a name="l00352"></a>00352   <span class="comment">//Note that we are choosing to return the number of significant columns</span>
<a name="l00353"></a>00353   <span class="comment">//rather than NPPBH*NBPR which would be the total number of pixels in the</span>
<a name="l00354"></a>00354   <span class="comment">//image.  if NPPBH*NBPR &gt; NCOLS, then all the extra columns are blanked</span>
<a name="l00355"></a>00355   <span class="comment">//out pad pixels.  Why would anyone want those?</span>
<a name="l00356"></a>00356   <span class="keywordtype">int</span> num_significant_cols;
<a name="l00357"></a>00357   <span class="keywordflow">if</span> (<a class="code" href="classvil__nitf2__image.html#a7cbd2adcac7d675a33c6a68dc3bc2c49">current_image_header</a>()-&gt;<a class="code" href="classvil__nitf2__image.html#a6fb85e934bc1c73a97e4ee93cd8d4ba7" title="Extra property information.">get_property</a>(<span class="stringliteral">&quot;NCOLS&quot;</span>, num_significant_cols))
<a name="l00358"></a>00358   {
<a name="l00359"></a>00359     <span class="keywordflow">return</span> num_significant_cols;
<a name="l00360"></a>00360   }
<a name="l00361"></a>00361   <span class="keywordflow">return</span> 0;
<a name="l00362"></a>00362 }
<a name="l00363"></a>00363 
<a name="l00364"></a><a class="code" href="classvil__nitf2__image.html#a04188de81e3efe282dea92e849770201">00364</a> <span class="keywordtype">unsigned</span> <a class="code" href="classvil__nitf2__image.html#a04188de81e3efe282dea92e849770201" title="Dimensions: Planes x ni x nj.">vil_nitf2_image::nj</a>()<span class="keyword"> const</span>
<a name="l00365"></a>00365 <span class="keyword"></span>{
<a name="l00366"></a>00366   <span class="comment">//Note that we are choosing to return the number of significant rows</span>
<a name="l00367"></a>00367   <span class="comment">//rather than NPPBV*NBPC which would be the total number of pixels in the</span>
<a name="l00368"></a>00368   <span class="comment">//image.  if NPPBV*NBPC &gt; NROWS, then all the extra columns are blanked</span>
<a name="l00369"></a>00369   <span class="comment">//out pad pixels.  Why would anyone want those?</span>
<a name="l00370"></a>00370   <span class="keywordtype">int</span> num_significant_rows;
<a name="l00371"></a>00371   <span class="keywordflow">if</span> (<a class="code" href="classvil__nitf2__image.html#a7cbd2adcac7d675a33c6a68dc3bc2c49">current_image_header</a>()-&gt;<a class="code" href="classvil__nitf2__image.html#a6fb85e934bc1c73a97e4ee93cd8d4ba7" title="Extra property information.">get_property</a>(<span class="stringliteral">&quot;NROWS&quot;</span>, num_significant_rows))
<a name="l00372"></a>00372   {
<a name="l00373"></a>00373     <span class="keywordflow">return</span> num_significant_rows;
<a name="l00374"></a>00374   }
<a name="l00375"></a>00375   <span class="keywordflow">return</span> 0;
<a name="l00376"></a>00376 }
<a name="l00377"></a>00377 
<a name="l00378"></a><a class="code" href="classvil__nitf2__image.html#a16ffcd749afb8821d1baa9b0a34f2005">00378</a> <span class="keyword">enum</span> <a class="code" href="vil__pixel__format_8h.html#a6f749d91364b0bcb661189f4a154800d" title="Describes the type of the concrete data.">vil_pixel_format</a> <a class="code" href="classvil__nitf2__image.html#a16ffcd749afb8821d1baa9b0a34f2005" title="Pixel Format.">vil_nitf2_image::pixel_format</a> ()<span class="keyword"> const</span>
<a name="l00379"></a>00379 <span class="keyword"></span>{
<a name="l00380"></a>00380   vcl_string pixel_type;
<a name="l00381"></a>00381   <span class="keywordtype">int</span> bits_per_pixel;
<a name="l00382"></a>00382   <span class="keywordflow">if</span> (<a class="code" href="classvil__nitf2__image.html#a7cbd2adcac7d675a33c6a68dc3bc2c49">current_image_header</a>()-&gt;<a class="code" href="classvil__nitf2__image.html#a6fb85e934bc1c73a97e4ee93cd8d4ba7" title="Extra property information.">get_property</a>(<span class="stringliteral">&quot;PVTYPE&quot;</span>, pixel_type) &amp;&amp;
<a name="l00383"></a>00383       <a class="code" href="classvil__nitf2__image.html#a7cbd2adcac7d675a33c6a68dc3bc2c49">current_image_header</a>()-&gt;<a class="code" href="classvil__nitf2__image.html#a6fb85e934bc1c73a97e4ee93cd8d4ba7" title="Extra property information.">get_property</a>(<span class="stringliteral">&quot;NBPP&quot;</span>, bits_per_pixel))
<a name="l00384"></a>00384   {
<a name="l00385"></a>00385     <span class="comment">//if bits_per_pixel isn&#39;t divisible by 8, round up to nearest byte</span>
<a name="l00386"></a>00386     <span class="keywordtype">int</span> bytesPerPixel = bits_per_pixel / 8;
<a name="l00387"></a>00387     <span class="keywordflow">if</span> (bits_per_pixel % 8 != 0) bytesPerPixel++;
<a name="l00388"></a>00388     bits_per_pixel = bytesPerPixel * 8;
<a name="l00389"></a>00389     <span class="keywordflow">if</span> (pixel_type == <span class="stringliteral">&quot;INT&quot;</span>) {
<a name="l00390"></a>00390       <span class="keywordflow">if</span> (bits_per_pixel == 8) {
<a name="l00391"></a>00391         <span class="keywordflow">return</span> <a class="code" href="vil__pixel__format_8h.html#a6f749d91364b0bcb661189f4a154800da7e558fc5ba55dbb9c32658e7960b83f4">VIL_PIXEL_FORMAT_BYTE</a>;
<a name="l00392"></a>00392       }
<a name="l00393"></a>00393       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (bits_per_pixel == 16) {
<a name="l00394"></a>00394         <span class="keywordflow">return</span> <a class="code" href="vil__pixel__format_8h.html#a6f749d91364b0bcb661189f4a154800dabecb5c0033517756dc112ccd18f97073">VIL_PIXEL_FORMAT_UINT_16</a>;
<a name="l00395"></a>00395       }
<a name="l00396"></a>00396       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (bits_per_pixel == 32) {
<a name="l00397"></a>00397         <span class="keywordflow">return</span> <a class="code" href="vil__pixel__format_8h.html#a6f749d91364b0bcb661189f4a154800da355f2de6abb4cb81d9ca9cfcad7dd0fa">VIL_PIXEL_FORMAT_UINT_32</a>;
<a name="l00398"></a>00398       }
<a name="l00399"></a>00399 <span class="preprocessor">#if VXL_HAS_INT_64</span>
<a name="l00400"></a>00400 <span class="preprocessor"></span>      <span class="keywordflow">else</span> <span class="keywordflow">if</span> (bits_per_pixel == 64) {
<a name="l00401"></a>00401         <span class="keywordflow">return</span> VIL_PIXEL_FORMAT_UINT_64;
<a name="l00402"></a>00402       }
<a name="l00403"></a>00403 <span class="preprocessor">#endif //VXL_HAS_INT_64</span>
<a name="l00404"></a>00404 <span class="preprocessor"></span>    }
<a name="l00405"></a>00405     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pixel_type == <span class="stringliteral">&quot;B&quot;</span>) {
<a name="l00406"></a>00406       <span class="keywordflow">return</span> <a class="code" href="vil__pixel__format_8h.html#a6f749d91364b0bcb661189f4a154800da270ef8e69c137b9bed10074d2726ffa9">VIL_PIXEL_FORMAT_BOOL</a>;
<a name="l00407"></a>00407     }
<a name="l00408"></a>00408     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pixel_type == <span class="stringliteral">&quot;SI&quot;</span>) {
<a name="l00409"></a>00409       <span class="keywordflow">if</span> (bits_per_pixel == 8) {
<a name="l00410"></a>00410         <span class="keywordflow">return</span> <a class="code" href="vil__pixel__format_8h.html#a6f749d91364b0bcb661189f4a154800da20c3ae85fdecfa20b5ecf12f8894efeb">VIL_PIXEL_FORMAT_SBYTE</a>;
<a name="l00411"></a>00411       }
<a name="l00412"></a>00412       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (bits_per_pixel == 16) {
<a name="l00413"></a>00413         <span class="keywordflow">return</span> <a class="code" href="vil__pixel__format_8h.html#a6f749d91364b0bcb661189f4a154800daba50e1cdc6e602c7e314fa82066027a3">VIL_PIXEL_FORMAT_INT_16</a>;
<a name="l00414"></a>00414       }
<a name="l00415"></a>00415       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (bits_per_pixel == 32) {
<a name="l00416"></a>00416         <span class="keywordflow">return</span> <a class="code" href="vil__pixel__format_8h.html#a6f749d91364b0bcb661189f4a154800da65f175b4a4049f8457bc8c4f772b9f5d">VIL_PIXEL_FORMAT_INT_32</a>;
<a name="l00417"></a>00417       }
<a name="l00418"></a>00418 <span class="preprocessor">#if VXL_HAS_INT_64</span>
<a name="l00419"></a>00419 <span class="preprocessor"></span>      <span class="keywordflow">else</span> <span class="keywordflow">if</span> (bits_per_pixel == 64) {
<a name="l00420"></a>00420         <span class="keywordflow">return</span> VIL_PIXEL_FORMAT_INT_64;
<a name="l00421"></a>00421       }
<a name="l00422"></a>00422 <span class="preprocessor">#endif //VXL_HAS_INT_64</span>
<a name="l00423"></a>00423 <span class="preprocessor"></span>    }
<a name="l00424"></a>00424     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pixel_type == <span class="stringliteral">&quot;R&quot;</span>) {
<a name="l00425"></a>00425       <span class="keywordflow">if</span> (bits_per_pixel == 32) {
<a name="l00426"></a>00426         <span class="keywordflow">return</span> <a class="code" href="vil__pixel__format_8h.html#a6f749d91364b0bcb661189f4a154800da8d2e38094a68770dcad0e6637d5ce3ba">VIL_PIXEL_FORMAT_FLOAT</a>;
<a name="l00427"></a>00427       }
<a name="l00428"></a>00428       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (bits_per_pixel == 64) {
<a name="l00429"></a>00429         <span class="keywordflow">return</span> <a class="code" href="vil__pixel__format_8h.html#a6f749d91364b0bcb661189f4a154800da57e197d362a17a1777b1ff69ee82e8ec">VIL_PIXEL_FORMAT_DOUBLE</a>;
<a name="l00430"></a>00430       }
<a name="l00431"></a>00431     }
<a name="l00432"></a>00432     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pixel_type == <span class="stringliteral">&quot;C&quot;</span>) {
<a name="l00433"></a>00433       <span class="comment">//two 32 bit floats (real followed by complex)</span>
<a name="l00434"></a>00434       <span class="keywordflow">if</span> (bits_per_pixel == 64) {
<a name="l00435"></a>00435         <span class="keywordflow">return</span> <a class="code" href="vil__pixel__format_8h.html#a6f749d91364b0bcb661189f4a154800da0a0fa304f6d2f439026143d225828a24" title="vcl_complex&lt;float&gt; is a scalar for vil&#39;s purposes.">VIL_PIXEL_FORMAT_COMPLEX_FLOAT</a>;
<a name="l00436"></a>00436       }<span class="comment">// else if (bits_per_pixel == 64) {</span>
<a name="l00437"></a>00437        <span class="comment">// return VIL_PIXEL_FORMAT_COMPLEX_DOUBLE;</span>
<a name="l00438"></a>00438       <span class="comment">//}</span>
<a name="l00439"></a>00439     }
<a name="l00440"></a>00440   }
<a name="l00441"></a>00441   <span class="keywordflow">return</span> <a class="code" href="vil__pixel__format_8h.html#a6f749d91364b0bcb661189f4a154800da763ec54acd5a8d28519252c706986209">VIL_PIXEL_FORMAT_UNKNOWN</a>;
<a name="l00442"></a>00442 }
<a name="l00443"></a>00443 
<a name="l00444"></a><a class="code" href="classvil__nitf2__image.html#afc2bb100fc2912e252d6cb72dc2ea0fa">00444</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="classvil__nitf2__image.html#afc2bb100fc2912e252d6cb72dc2ea0fa" title="Block size in columns.">vil_nitf2_image::size_block_i</a>()<span class="keyword"> const</span>
<a name="l00445"></a>00445 <span class="keyword"></span>{
<a name="l00446"></a>00446   <span class="keywordflow">return</span> <a class="code" href="classvil__nitf2__image.html#a7cbd2adcac7d675a33c6a68dc3bc2c49">current_image_header</a>()-&gt;<a class="code" href="classvil__nitf2__image__subheader.html#a2a4b8b6e5faac44d3692eb6bc2582ca6">get_pixels_per_block_x</a>();
<a name="l00447"></a>00447 }
<a name="l00448"></a>00448 
<a name="l00449"></a><a class="code" href="classvil__nitf2__image.html#a4b8a7b6fa7f7c7b998a69f3672933c4f">00449</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="classvil__nitf2__image.html#a4b8a7b6fa7f7c7b998a69f3672933c4f" title="Block size in rows.">vil_nitf2_image::size_block_j</a>()<span class="keyword"> const</span>
<a name="l00450"></a>00450 <span class="keyword"></span>{
<a name="l00451"></a>00451   <span class="keywordflow">return</span> <a class="code" href="classvil__nitf2__image.html#a7cbd2adcac7d675a33c6a68dc3bc2c49">current_image_header</a>()-&gt;<a class="code" href="classvil__nitf2__image__subheader.html#a141b567c4c37932516c6d8779d99d8df">get_pixels_per_block_y</a>();
<a name="l00452"></a>00452 }
<a name="l00453"></a>00453 
<a name="l00454"></a><a class="code" href="classvil__nitf2__image.html#a6cc711fe72e79ea99015896033897a96">00454</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="classvil__nitf2__image.html#a6cc711fe72e79ea99015896033897a96" title="Number of blocks in image width.">vil_nitf2_image::n_block_i</a>()<span class="keyword"> const</span>
<a name="l00455"></a>00455 <span class="keyword"></span>{
<a name="l00456"></a>00456   <span class="keywordflow">return</span> <a class="code" href="classvil__nitf2__image.html#a7cbd2adcac7d675a33c6a68dc3bc2c49">current_image_header</a>()-&gt;<a class="code" href="classvil__nitf2__image__subheader.html#a00e2d42a61743f0efb977d0bea3533e0">get_num_blocks_x</a>();
<a name="l00457"></a>00457 }
<a name="l00458"></a>00458 
<a name="l00459"></a><a class="code" href="classvil__nitf2__image.html#ae6915940406ed10fb70e771cc4efd083">00459</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="classvil__nitf2__image.html#ae6915940406ed10fb70e771cc4efd083" title="Number of blocks in image height.">vil_nitf2_image::n_block_j</a>()<span class="keyword"> const</span>
<a name="l00460"></a>00460 <span class="keyword"></span>{
<a name="l00461"></a>00461   <span class="keywordflow">return</span> <a class="code" href="classvil__nitf2__image.html#a7cbd2adcac7d675a33c6a68dc3bc2c49">current_image_header</a>()-&gt;<a class="code" href="classvil__nitf2__image__subheader.html#a7b507b5a185cac2f1feae396aec9f742">get_num_blocks_y</a>();
<a name="l00462"></a>00462 }
<a name="l00463"></a>00463 
<a name="l00464"></a><a class="code" href="vil__nitf2__image_8cxx.html#a8587d976f5f08a73dfa475165863f143">00464</a> <span class="keywordtype">void</span>  <a class="code" href="vil__nitf2__image_8cxx.html#a8587d976f5f08a73dfa475165863f143">compute_block_and_offset</a>(<span class="keywordtype">unsigned</span> j0, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> block_size,
<a name="l00465"></a>00465                                <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>&amp; block, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>&amp; offset)
<a name="l00466"></a>00466 {
<a name="l00467"></a>00467   block = 0;
<a name="l00468"></a>00468   offset = 0;
<a name="l00469"></a>00469 
<a name="l00470"></a>00470   <span class="keywordflow">if</span> (j0 != 0) {
<a name="l00471"></a>00471     block = (j0 / block_size);
<a name="l00472"></a>00472     <span class="keywordflow">if</span> (j0 &gt; 0 &amp;&amp; j0 % block_size != 0) {
<a name="l00473"></a>00473       offset = j0 - (block * block_size);
<a name="l00474"></a>00474     }
<a name="l00475"></a>00475   }
<a name="l00476"></a>00476 }
<a name="l00477"></a>00477 
<a name="l00478"></a><a class="code" href="classvil__nitf2__image.html#a8c4e656ec3e89ceedbd58f0b935dbf11">00478</a> <span class="keywordtype">bool</span> <a class="code" href="classvil__nitf2__image.html#a8c4e656ec3e89ceedbd58f0b935dbf11">vil_nitf2_image::is_jpeg_2000_compressed</a>()<span class="keyword"> const</span>
<a name="l00479"></a>00479 <span class="keyword"></span>{
<a name="l00480"></a>00480   vcl_string compression_type;
<a name="l00481"></a>00481   <span class="comment">//ISO/IEC BIFF profile BPJ2k01.00 says that M8 is actually invalid</span>
<a name="l00482"></a>00482   <span class="comment">//(ie. you can&#39;t use a data mask with jpeg 2000 compression)</span>
<a name="l00483"></a>00483   <span class="comment">//not sure why it is an option though</span>
<a name="l00484"></a>00484   <span class="keywordflow">return</span> ( <a class="code" href="classvil__nitf2__image.html#a7cbd2adcac7d675a33c6a68dc3bc2c49">current_image_header</a>()-&gt;<a class="code" href="classvil__nitf2__image.html#a6fb85e934bc1c73a97e4ee93cd8d4ba7" title="Extra property information.">get_property</a>(<span class="stringliteral">&quot;IC&quot;</span>, compression_type) ) &amp;&amp;
<a name="l00485"></a>00485          ( compression_type == <span class="stringliteral">&quot;C8&quot;</span> || compression_type == <span class="stringliteral">&quot;M8&quot;</span> );
<a name="l00486"></a>00486 }
<a name="l00487"></a>00487 
<a name="l00488"></a><a class="code" href="classvil__nitf2__image.html#afdc4daedc59290b6be0bc9e396564493">00488</a> <a class="code" href="classvil__smart__ptr.html" title="A templated smart pointer class.">vil_image_view_base_sptr</a> <a class="code" href="classvil__nitf2__image.html#afdc4daedc59290b6be0bc9e396564493">vil_nitf2_image::get_copy_view_decimated_j2k</a>(
<a name="l00489"></a>00489   <span class="keywordtype">unsigned</span> start_i, <span class="keywordtype">unsigned</span> num_i, <span class="keywordtype">unsigned</span> start_j, <span class="keywordtype">unsigned</span> num_j, <span class="keywordtype">double</span> i_factor, <span class="keywordtype">double</span> j_factor )<span class="keyword"> const</span>
<a name="l00490"></a>00490 <span class="keyword"></span>{
<a name="l00491"></a>00491   <span class="comment">// ACCORDING TO DOCUMENTATION, IF PARAMETERS ARE BAD, WE SHOULD RETURN NULL POINTER.</span>
<a name="l00492"></a>00492   <span class="keywordflow">if</span> ((start_i + num_i &gt; <a class="code" href="classvil__nitf2__image.html#aed66aafd061126fcd1a5a4ddfab0fef7" title="Dimensions: Planes x ni x nj.">ni</a>()) || (start_j + num_j &gt; <a class="code" href="classvil__nitf2__image.html#a04188de81e3efe282dea92e849770201" title="Dimensions: Planes x ni x nj.">nj</a>())) {
<a name="l00493"></a>00493     <span class="keywordflow">return</span> 0;
<a name="l00494"></a>00494   }
<a name="l00495"></a>00495   assert( <a class="code" href="classvil__nitf2__image.html#a8c4e656ec3e89ceedbd58f0b935dbf11">is_jpeg_2000_compressed</a>() );
<a name="l00496"></a>00496   <span class="keywordflow">if</span> ( ! <a class="code" href="classvil__nitf2__image.html#ae6375f2e7919051ddab668e1e9261e91" title="All instances of vil_nitf2_image will use s_decode_jpeg_2000() to decode JPEG 2000 streams if you set...">s_decode_jpeg_2000</a> ) {
<a name="l00497"></a>00497 <span class="preprocessor">#if HAS_J2K</span>
<a name="l00498"></a>00498 <span class="preprocessor"></span>    <a class="code" href="classvil__nitf2__image.html#ae6375f2e7919051ddab668e1e9261e91" title="All instances of vil_nitf2_image will use s_decode_jpeg_2000() to decode JPEG 2000 streams if you set...">s_decode_jpeg_2000</a> = <a class="code" href="classvil__nitf2__image.html#ae6375f2e7919051ddab668e1e9261e91" title="All instances of vil_nitf2_image will use s_decode_jpeg_2000() to decode JPEG 2000 streams if you set...">vil_j2k_image::s_decode_jpeg_2000</a>;
<a name="l00499"></a>00499 <span class="preprocessor">#else //HAS_J2K</span>
<a name="l00500"></a>00500 <span class="preprocessor"></span>    <span class="keywordflow">return</span> 0;
<a name="l00501"></a>00501 <span class="preprocessor">#endif //HAS_J2K</span>
<a name="l00502"></a>00502 <span class="preprocessor"></span>  }
<a name="l00503"></a>00503 
<a name="l00504"></a>00504   <span class="comment">//it is my understanding from BIFF profile BPJ2k01.00 that JPEG compressed files</span>
<a name="l00505"></a>00505   <span class="comment">//will only have on image block (ie. it will be clocked within the jp2 codestream),</span>
<a name="l00506"></a>00506   <span class="comment">//so we can just pass all the work off to the vil_j2k_image class</span>
<a name="l00507"></a>00507   <a class="code" href="classvil__nitf2__image.html#a03827b9f7535dde73fe41a46007a1ad9">m_stream</a>-&gt;<a class="code" href="classvil__stream.html#ab592f40f2538ea648fc101a0adea1a6d" title="Goto file pointer.">seek</a>(<a class="code" href="classvil__nitf2__image.html#a2c74c82ea50cb8368c9c9c0c2ee46454">get_offset_to</a>( <a class="code" href="classvil__nitf2__header.html#a21de72b17d4eea0480e9bf80bdc63c07a7bc500878cac7875e7916a3c700287f4">vil_nitf2_header::enum_image_segments</a>, <a class="code" href="classvil__nitf2__header.html#acb17a244846f74f4212bc2ca1ba1bfd9ab0a9cccb7f3c136039feb7bb49523ec4">vil_nitf2_header::enum_data</a>, <a class="code" href="classvil__nitf2__image.html#a0a5d803cdef2dc53661f55dc0f5fcb6e">m_current_image_index</a>));
<a name="l00508"></a>00508   <span class="keywordflow">return</span> <a class="code" href="classvil__nitf2__image.html#ae6375f2e7919051ddab668e1e9261e91" title="All instances of vil_nitf2_image will use s_decode_jpeg_2000() to decode JPEG 2000 streams if you set...">s_decode_jpeg_2000</a>( <a class="code" href="classvil__nitf2__image.html#a03827b9f7535dde73fe41a46007a1ad9">m_stream</a>, start_i, num_i, start_j, num_j, i_factor, j_factor );
<a name="l00509"></a>00509 }
<a name="l00510"></a>00510 
<a name="l00511"></a><a class="code" href="classvil__nitf2__image.html#a4680b12945539b40903b17ff1524d90c">00511</a> <a class="code" href="classvil__smart__ptr.html" title="A templated smart pointer class.">vil_image_view_base_sptr</a> <a class="code" href="classvil__nitf2__image.html#a68345f98d6473d5ffd913289446c0e4f" title="Create a read/write view of a copy of all the data.">vil_nitf2_image::get_copy_view</a>(<span class="keywordtype">unsigned</span> start_i, <span class="keywordtype">unsigned</span> num_i,
<a name="l00512"></a>00512                                                         <span class="keywordtype">unsigned</span> start_j, <span class="keywordtype">unsigned</span> num_j)<span class="keyword"> const</span>
<a name="l00513"></a>00513 <span class="keyword"></span>{
<a name="l00514"></a>00514   <span class="comment">// ACCORDING TO DOCUMENTATION, IF PARAMETERS ARE BAD, WE SHOULD RETURN NULL POINTER.</span>
<a name="l00515"></a>00515   <span class="keywordflow">if</span> ((start_i + num_i &gt; <a class="code" href="classvil__nitf2__image.html#aed66aafd061126fcd1a5a4ddfab0fef7" title="Dimensions: Planes x ni x nj.">ni</a>()) || (start_j + num_j &gt; <a class="code" href="classvil__nitf2__image.html#a04188de81e3efe282dea92e849770201" title="Dimensions: Planes x ni x nj.">nj</a>())) {
<a name="l00516"></a>00516     <span class="keywordflow">return</span> 0;
<a name="l00517"></a>00517   }
<a name="l00518"></a>00518 
<a name="l00519"></a>00519   vcl_string compression_type;
<a name="l00520"></a>00520   <span class="keywordflow">if</span> (!<a class="code" href="classvil__nitf2__image.html#a7cbd2adcac7d675a33c6a68dc3bc2c49">current_image_header</a>()-&gt;<a class="code" href="classvil__nitf2__image.html#a6fb85e934bc1c73a97e4ee93cd8d4ba7" title="Extra property information.">get_property</a>(<span class="stringliteral">&quot;IC&quot;</span>, compression_type)) <span class="keywordflow">return</span> 0;
<a name="l00521"></a>00521 
<a name="l00522"></a>00522   <span class="comment">//right now we only plan to support uncompressed and JPEG2000</span>
<a name="l00523"></a>00523   <span class="keywordflow">if</span> (compression_type == <span class="stringliteral">&quot;NC&quot;</span> || compression_type == <span class="stringliteral">&quot;NM&quot;</span>) {
<a name="l00524"></a>00524     <span class="keywordflow">return</span> <a class="code" href="classvil__nitf2__image.html#a7a1dced56fae643a665b18fc330ec7cb">get_copy_view_uncompressed</a>(start_i, num_i, start_j, num_j);
<a name="l00525"></a>00525   }
<a name="l00526"></a>00526   <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( <a class="code" href="classvil__nitf2__image.html#a8c4e656ec3e89ceedbd58f0b935dbf11">is_jpeg_2000_compressed</a>() ) {
<a name="l00527"></a>00527     <span class="keywordflow">return</span> <a class="code" href="classvil__nitf2__image.html#afdc4daedc59290b6be0bc9e396564493">get_copy_view_decimated_j2k</a>( start_i, num_i, start_j, num_j, 1.0, 1.0 );
<a name="l00528"></a>00528   }
<a name="l00529"></a>00529   <span class="keywordflow">else</span> {
<a name="l00530"></a>00530     <span class="keywordflow">return</span> 0;
<a name="l00531"></a>00531   }
<a name="l00532"></a>00532 }
<a name="l00533"></a>00533 
<a name="l00534"></a><a class="code" href="classvil__nitf2__image.html#a7a1dced56fae643a665b18fc330ec7cb">00534</a> <a class="code" href="classvil__smart__ptr.html" title="A templated smart pointer class.">vil_image_view_base_sptr</a> <a class="code" href="classvil__nitf2__image.html#a7a1dced56fae643a665b18fc330ec7cb">vil_nitf2_image::get_copy_view_uncompressed</a>(<span class="keywordtype">unsigned</span> start_i, <span class="keywordtype">unsigned</span> num_i,
<a name="l00535"></a>00535                                                                      <span class="keywordtype">unsigned</span> start_j, <span class="keywordtype">unsigned</span> num_j)<span class="keyword"> const</span>
<a name="l00536"></a>00536 <span class="keyword"></span>{
<a name="l00537"></a>00537   <span class="keywordflow">return</span> <a class="code" href="classvil__nitf2__image.html#a68345f98d6473d5ffd913289446c0e4f" title="Create a read/write view of a copy of all the data.">vil_blocked_image_resource::get_copy_view</a>(start_i, num_i, start_j, num_j);
<a name="l00538"></a>00538 }
<a name="l00539"></a>00539 
<a name="l00540"></a>00540 <span class="keyword">template</span>&lt; <span class="keyword">class</span> T &gt;
<a name="l00541"></a><a class="code" href="vil__nitf2__image_8cxx.html#a15275294fb958f79572bbd69581ce53f">00541</a> <a class="code" href="classvil__smart__ptr.html">vil_memory_chunk_sptr</a> <a class="code" href="vil__nitf2__image_8cxx.html#a15275294fb958f79572bbd69581ce53f">maybe_byte_align_data</a>(<a class="code" href="classvil__smart__ptr.html">vil_memory_chunk_sptr</a> in_data, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> num_samples,
<a name="l00542"></a>00542                                             <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> in_bits_per_sample, T <span class="comment">/*dummy*/</span>)
<a name="l00543"></a>00543 {
<a name="l00544"></a>00544   <span class="keywordflow">if</span> (in_bits_per_sample != <span class="keyword">sizeof</span>(T)*8) {
<a name="l00545"></a>00545     <a class="code" href="classvil__smart__ptr.html">vil_memory_chunk_sptr</a> new_memory = <span class="keyword">new</span> <a class="code" href="classvil__memory__chunk.html" title="Ref. counted block of data on the heap.">vil_memory_chunk</a>(num_samples*<span class="keyword">sizeof</span>(T), in_data-&gt;pixel_format());
<a name="l00546"></a>00546     <a class="code" href="vil__nitf2__image_8h.html#a762b4b7bc8b75247565da5aec8e3dec2" title="This function will byte align the data in in_data and store the result in out_data.">byte_align_data</a>((T*)in_data-&gt;data(), num_samples, in_bits_per_sample, (T*)new_memory-&gt;data());
<a name="l00547"></a>00547     <span class="keywordflow">return</span> new_memory;
<a name="l00548"></a>00548   }
<a name="l00549"></a>00549   <span class="keywordflow">return</span> in_data;
<a name="l00550"></a>00550 }
<a name="l00551"></a>00551 
<a name="l00552"></a>00552 <span class="comment">// don&#39;t do anything for float and double (bit shifting isn&#39;t allowed)</span>
<a name="l00553"></a><a class="code" href="vil__nitf2__image_8cxx.html#a12e9ef395ebc8ac7adc6b4b769ae8824">00553</a> <span class="keyword">template</span>&lt;&gt; <a class="code" href="classvil__smart__ptr.html">vil_memory_chunk_sptr</a> <a class="code" href="vil__nitf2__image_8cxx.html#a12e9ef395ebc8ac7adc6b4b769ae8824">maybe_byte_align_data&lt;float&gt;</a> (
<a name="l00554"></a>00554   <a class="code" href="classvil__smart__ptr.html">vil_memory_chunk_sptr</a> in_data, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <span class="comment">/* num_samples */</span>, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <span class="comment">/* in_bits_per_sample */</span>, <span class="keywordtype">float</span> <span class="comment">/*dummy*/</span>)
<a name="l00555"></a>00555 { <span class="keywordflow">return</span> in_data; }
<a name="l00556"></a>00556 
<a name="l00557"></a><a class="code" href="vil__nitf2__image_8cxx.html#af68b6b4626922e0e574d760ba7b04062">00557</a> <span class="keyword">template</span>&lt;&gt; <a class="code" href="classvil__smart__ptr.html">vil_memory_chunk_sptr</a> <a class="code" href="vil__nitf2__image_8cxx.html#af68b6b4626922e0e574d760ba7b04062">maybe_byte_align_data&lt;double&gt;</a> (
<a name="l00558"></a>00558   <a class="code" href="classvil__smart__ptr.html">vil_memory_chunk_sptr</a> in_data, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <span class="comment">/* num_samples */</span>, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <span class="comment">/* in_bits_per_sample */</span>, <span class="keywordtype">double</span> <span class="comment">/*dummy*/</span>)
<a name="l00559"></a>00559 { <span class="keywordflow">return</span> in_data; }
<a name="l00560"></a>00560 
<a name="l00561"></a><a class="code" href="vil__nitf2__image_8cxx.html#acb5c1c40b498e2e36b9c7cb024006e2b">00561</a> <span class="keyword">template</span>&lt;&gt; <a class="code" href="classvil__smart__ptr.html">vil_memory_chunk_sptr</a> maybe_byte_align_data&lt; vcl_complex&lt; float &gt; &gt; (
<a name="l00562"></a>00562   <a class="code" href="classvil__smart__ptr.html">vil_memory_chunk_sptr</a> in_data, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <span class="comment">/*num_samples*/</span>, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <span class="comment">/*in_bits_per_sample*/</span>, vcl_complex&lt;float&gt; <span class="comment">/*dummy*/</span>)
<a name="l00563"></a>00563 { <span class="keywordflow">return</span> in_data; }
<a name="l00564"></a>00564 
<a name="l00565"></a>00565 
<a name="l00566"></a>00566 <span class="comment">//:</span>
<a name="l00567"></a>00567 <span class="comment">//  This function handles the case where the actual bits per pixel per band</span>
<a name="l00568"></a>00568 <span class="comment">//  is less then the actual bpppb AND where the data is vcl_left justified.  This</span>
<a name="l00569"></a>00569 <span class="comment">//  shifts the data so that it is right justified.</span>
<a name="l00570"></a>00570 <span class="comment">//  As of now, this function is untests as I don&#39;t have any vcl_left justified data</span>
<a name="l00571"></a>00571 <span class="comment">//  (the NITF spec discourages using it -- probably because it is such a PITA)</span>
<a name="l00572"></a>00572 <span class="keyword">template</span>&lt; <span class="keyword">class</span> T &gt;
<a name="l00573"></a><a class="code" href="vil__nitf2__image_8cxx.html#a1dab26379b36148743020d3bf62fa090">00573</a> <span class="keywordtype">void</span> <a class="code" href="vil__nitf2__image_8cxx.html#a1dab26379b36148743020d3bf62fa090" title="This function handles the case where the actual bits per pixel per band is less then the actual bpppb...">right_justify</a>(T* data, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> num_samples, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> bitsToMove)
<a name="l00574"></a>00574 {
<a name="l00575"></a>00575   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0 ; i &lt; num_samples ; i++) {
<a name="l00576"></a>00576     data[i] = data[i] &gt;&gt; bitsToMove;
<a name="l00577"></a>00577   }
<a name="l00578"></a>00578 }
<a name="l00579"></a>00579 
<a name="l00580"></a>00580 <span class="comment">//don&#39;t do anything for bool, float and double (bit shifting isn&#39;t allowed)</span>
<a name="l00581"></a><a class="code" href="vil__nitf2__image_8cxx.html#a51632507757e792a793a5e54e08d440e">00581</a> <span class="keyword">template</span>&lt;&gt; <span class="keywordtype">void</span> <a class="code" href="vil__nitf2__image_8cxx.html#a51632507757e792a793a5e54e08d440e">right_justify&lt;bool&gt;</a>(<span class="keywordtype">bool</span>* <span class="comment">/* data */</span>, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <span class="comment">/* num_samples */</span>, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <span class="comment">/* bitsToMove */</span>) {}
<a name="l00582"></a><a class="code" href="vil__nitf2__image_8cxx.html#a4de4376a8eaa54f21d48fdcee88b2caf">00582</a> <span class="keyword">template</span>&lt;&gt; <span class="keywordtype">void</span> <a class="code" href="vil__nitf2__image_8cxx.html#a4de4376a8eaa54f21d48fdcee88b2caf">right_justify&lt;float&gt;</a>(<span class="keywordtype">float</span>* <span class="comment">/* data */</span>, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <span class="comment">/* num_samples */</span>, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <span class="comment">/* bitsToMove */</span>) {}
<a name="l00583"></a><a class="code" href="vil__nitf2__image_8cxx.html#a26584395fa818b54e1d4f9c89af989eb">00583</a> <span class="keyword">template</span>&lt;&gt; <span class="keywordtype">void</span> <a class="code" href="vil__nitf2__image_8cxx.html#a26584395fa818b54e1d4f9c89af989eb">right_justify&lt;double&gt;</a>(<span class="keywordtype">double</span>* <span class="comment">/* data */</span>, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <span class="comment">/* num_samples */</span>, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <span class="comment">/* bitsToMove */</span>) {}
<a name="l00584"></a><a class="code" href="vil__nitf2__image_8cxx.html#a9338dfbfe3911822f5b9b19618749a0c">00584</a> <span class="keyword">template</span>&lt;&gt; <span class="keywordtype">void</span> right_justify&lt; vcl_complex&lt; float &gt; &gt;(vcl_complex&lt; float &gt;* <span class="comment">/*data*/</span>, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <span class="comment">/*num_samples*/</span>,
<a name="l00585"></a>00585                                                       <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <span class="comment">/* bitsToMove */</span>) {}
<a name="l00586"></a>00586 
<a name="l00587"></a>00587 <span class="keyword">template</span>&lt; <span class="keyword">class</span> T &gt;
<a name="l00588"></a><a class="code" href="vil__nitf2__image_8cxx.html#a0aef9a179da437619869d597f53a2c99">00588</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="vil__nitf2__image_8cxx.html#a0aef9a179da437619869d597f53a2c99">get_index</a>(T in_val)
<a name="l00589"></a>00589 { <span class="keywordflow">return</span> (T)in_val; }
<a name="l00590"></a>00590 
<a name="l00591"></a><a class="code" href="vil__nitf2__image_8cxx.html#a3a66ff537d48241f186c5dbc29f2f46c">00591</a> <span class="keyword">template</span>&lt;&gt; <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="vil__nitf2__image_8cxx.html#a3a66ff537d48241f186c5dbc29f2f46c">get_index&lt;bool&gt;</a>(<span class="keywordtype">bool</span> in_val)
<a name="l00592"></a>00592 { <span class="keywordflow">return</span> in_val ? 1 : 0; }
<a name="l00593"></a>00593 
<a name="l00594"></a>00594 <span class="keyword">template</span>&lt; <span class="keyword">class</span> T &gt;
<a name="l00595"></a><a class="code" href="vil__nitf2__image_8cxx.html#ab33038eed49f07fe7d2c4c7329e6269f">00595</a> <a class="code" href="classvil__smart__ptr.html">vil_image_view_base_sptr</a> <a class="code" href="vil__nitf2__image_8cxx.html#ab33038eed49f07fe7d2c4c7329e6269f">get_block_vcl_internal</a>(<a class="code" href="vil__pixel__format_8h.html#a6f749d91364b0bcb661189f4a154800d" title="Describes the type of the concrete data.">vil_pixel_format</a> pix_format, <a class="code" href="classvil__smart__ptr.html">vil_memory_chunk_sptr</a> image_memory,
<a name="l00596"></a>00596                                                 <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> pixels_per_block_x, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> pixels_per_block_y,
<a name="l00597"></a>00597                                                 <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> nplanes,
<a name="l00598"></a>00598                                                 <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i_step, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j_step, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> plane_step,
<a name="l00599"></a>00599                                                 <span class="keywordtype">bool</span> need_to_right_justify,
<a name="l00600"></a>00600                                                 <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> extra_bits, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> bits_per_pixel_per_band,
<a name="l00601"></a>00601                                                 <span class="keywordtype">bool</span> data_is_all_blank, <span class="keyword">const</span> <a class="code" href="classvil__nitf2__image__subheader.html" title="This class is responsible for parsing a NITF 2.1 image header.">vil_nitf2_image_subheader</a>* <span class="comment">/*image_header*/</span>, T dummy)
<a name="l00602"></a>00602 {
<a name="l00603"></a>00603   <span class="comment">//may have to byte align data (only valid for integer type data)</span>
<a name="l00604"></a>00604   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> num_samples = pixels_per_block_x * pixels_per_block_y * nplanes; <span class="comment">//all bands of image</span>
<a name="l00605"></a>00605 
<a name="l00606"></a>00606   <span class="keywordflow">if</span> (data_is_all_blank) {
<a name="l00607"></a>00607     <span class="comment">//this entire block is blank</span>
<a name="l00608"></a>00608     T* data_ptr = <span class="keyword">reinterpret_cast&lt;</span>T*<span class="keyword">&gt;</span>(image_memory-&gt;data());
<a name="l00609"></a>00609     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0 ;
<a name="l00610"></a>00610          i &lt; pixels_per_block_x * pixels_per_block_y * nplanes ;
<a name="l00611"></a>00611          i++)
<a name="l00612"></a>00612     {
<a name="l00613"></a>00613       data_ptr[i] = (T)0;
<a name="l00614"></a>00614     }
<a name="l00615"></a>00615   }
<a name="l00616"></a>00616   <span class="keywordflow">else</span> {
<a name="l00617"></a>00617     <span class="comment">//in the rare case where the actual number of bits per pixel value (ABPP) is less than the number of bits</span>
<a name="l00618"></a>00618     <span class="comment">//used in the data (NBPP) AND the data is vcl_left justified... then we correct that here</span>
<a name="l00619"></a>00619     <span class="keywordflow">if</span> (need_to_right_justify)
<a name="l00620"></a>00620       right_justify&lt;T&gt;(<span class="keyword">static_cast&lt;</span>T*<span class="keyword">&gt;</span>(image_memory-&gt;data()), (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)(image_memory-&gt;size()/<span class="keyword">sizeof</span>(T)), extra_bits);
<a name="l00621"></a>00621     <span class="comment">//Nitf files store data in big endian... little endian machines need to convert</span>
<a name="l00622"></a>00622     <a class="code" href="classvil__nitf2__data__mask__table.html#ae02ded7f56ae9b2b449ca8d7960e2803">vil_nitf2_data_mask_table::maybe_endian_swap</a>(static_cast&lt; char* &gt;(image_memory-&gt;data()), (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)(image_memory-&gt;size()), pix_format);
<a name="l00623"></a>00623     <span class="comment">//if the data is not byte aligned (ie. the actual bits per pixel per band is not divisible</span>
<a name="l00624"></a>00624     <span class="comment">//by 8),then we need to correct that</span>
<a name="l00625"></a>00625     image_memory = <a class="code" href="vil__nitf2__image_8cxx.html#a15275294fb958f79572bbd69581ce53f">maybe_byte_align_data</a>(image_memory, num_samples, bits_per_pixel_per_band, dummy);
<a name="l00626"></a>00626   }
<a name="l00627"></a>00627 
<a name="l00628"></a>00628   <a class="code" href="classvil__image__view.html" title="Concrete view of image data of type T held in memory.">vil_image_view&lt; T &gt;</a>* result =
<a name="l00629"></a>00629     <span class="keyword">new</span> <a class="code" href="classvil__image__view.html" title="Concrete view of image data of type T held in memory.">vil_image_view&lt; T &gt;</a> (image_memory, <span class="keyword">reinterpret_cast&lt;</span>T*<span class="keyword">&gt;</span>(image_memory-&gt;data()),
<a name="l00630"></a>00630                               pixels_per_block_x, pixels_per_block_y, nplanes, i_step, j_step, plane_step);
<a name="l00631"></a>00631 
<a name="l00632"></a>00632   <span class="keywordflow">return</span> result;
<a name="l00633"></a>00633 }
<a name="l00634"></a>00634 
<a name="l00635"></a><a class="code" href="classvil__nitf2__image.html#a1865219716193aee81732500540aec60">00635</a> <a class="code" href="classvil__smart__ptr.html" title="A templated smart pointer class.">vil_image_view_base_sptr</a> <a class="code" href="classvil__nitf2__image.html#a1865219716193aee81732500540aec60">vil_nitf2_image::get_block_j2k</a>( <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> blockIndexX, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> blockIndexY )<span class="keyword"> const</span>
<a name="l00636"></a>00636 <span class="keyword"></span>{
<a name="l00637"></a>00637   <span class="keywordflow">if</span> ( ! <a class="code" href="classvil__nitf2__image.html#a8c4e656ec3e89ceedbd58f0b935dbf11">is_jpeg_2000_compressed</a>() ) <span class="keywordflow">return</span> 0;
<a name="l00638"></a>00638   <span class="keywordflow">if</span> ( blockIndexX &gt;= <a class="code" href="classvil__nitf2__image.html#a6cc711fe72e79ea99015896033897a96" title="Number of blocks in image width.">n_block_i</a>() ) <span class="keywordflow">return</span> 0;
<a name="l00639"></a>00639   <span class="keywordflow">if</span> ( blockIndexY &gt;= <a class="code" href="classvil__nitf2__image.html#ae6915940406ed10fb70e771cc4efd083" title="Number of blocks in image height.">n_block_j</a>() ) <span class="keywordflow">return</span> 0;
<a name="l00640"></a>00640 
<a name="l00641"></a>00641   <span class="comment">//sometimes blocks don&#39;t align nicely with the image edge.  I&#39;m not sure</span>
<a name="l00642"></a>00642   <span class="comment">//if this is a bug in the file or if we need to handle it.  Anyway,</span>
<a name="l00643"></a>00643   <span class="comment">//we handle it by using vcl_min.  test file named p0_11xa,ntf exhibits</span>
<a name="l00644"></a>00644   <span class="comment">//this issue</span>
<a name="l00645"></a>00645   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i0 = vcl_min( blockIndexX * <a class="code" href="classvil__nitf2__image.html#afc2bb100fc2912e252d6cb72dc2ea0fa" title="Block size in columns.">size_block_i</a>(), <a class="code" href="classvil__nitf2__image.html#aed66aafd061126fcd1a5a4ddfab0fef7" title="Dimensions: Planes x ni x nj.">ni</a>() );
<a name="l00646"></a>00646   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> num_i = vcl_min( <a class="code" href="classvil__nitf2__image.html#afc2bb100fc2912e252d6cb72dc2ea0fa" title="Block size in columns.">size_block_i</a>(), <a class="code" href="classvil__nitf2__image.html#aed66aafd061126fcd1a5a4ddfab0fef7" title="Dimensions: Planes x ni x nj.">ni</a>() - i0 );
<a name="l00647"></a>00647   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j0 = vcl_min( blockIndexY * <a class="code" href="classvil__nitf2__image.html#a4b8a7b6fa7f7c7b998a69f3672933c4f" title="Block size in rows.">size_block_j</a>(), <a class="code" href="classvil__nitf2__image.html#a04188de81e3efe282dea92e849770201" title="Dimensions: Planes x ni x nj.">nj</a>() );
<a name="l00648"></a>00648   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> num_j = vcl_min( <a class="code" href="classvil__nitf2__image.html#a4b8a7b6fa7f7c7b998a69f3672933c4f" title="Block size in rows.">size_block_j</a>(), <a class="code" href="classvil__nitf2__image.html#a04188de81e3efe282dea92e849770201" title="Dimensions: Planes x ni x nj.">nj</a>() - j0 );
<a name="l00649"></a>00649   <span class="keywordflow">return</span> <a class="code" href="classvil__nitf2__image.html#a68345f98d6473d5ffd913289446c0e4f" title="Create a read/write view of a copy of all the data.">get_copy_view</a>( i0, num_i, j0, num_j );
<a name="l00650"></a>00650 }
<a name="l00651"></a>00651 
<a name="l00652"></a><a class="code" href="classvil__nitf2__image.html#add7c14fce180475533355725ed1e3b2a">00652</a> <a class="code" href="classvil__smart__ptr.html" title="A templated smart pointer class.">vil_image_view_base_sptr</a> <a class="code" href="classvil__nitf2__image.html#add7c14fce180475533355725ed1e3b2a">vil_nitf2_image::get_block</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> block_index_x, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> block_index_y)<span class="keyword"> const</span>
<a name="l00653"></a>00653 <span class="keyword"></span>{
<a name="l00654"></a>00654   <span class="keywordflow">if</span> (<a class="code" href="classvil__nitf2__image.html#a16ffcd749afb8821d1baa9b0a34f2005" title="Pixel Format.">pixel_format</a>() == <a class="code" href="vil__pixel__format_8h.html#a6f749d91364b0bcb661189f4a154800da763ec54acd5a8d28519252c706986209">VIL_PIXEL_FORMAT_UNKNOWN</a>) <span class="keywordflow">return</span> 0;
<a name="l00655"></a>00655 
<a name="l00656"></a>00656   <span class="keywordflow">if</span> ( <a class="code" href="classvil__nitf2__image.html#a8c4e656ec3e89ceedbd58f0b935dbf11">is_jpeg_2000_compressed</a>() ) {
<a name="l00657"></a>00657     <span class="keywordflow">return</span> <a class="code" href="classvil__nitf2__image.html#a1865219716193aee81732500540aec60">get_block_j2k</a>( block_index_x, block_index_y );
<a name="l00658"></a>00658   }
<a name="l00659"></a>00659 
<a name="l00660"></a>00660   vcl_string image_mode_type;
<a name="l00661"></a>00661   <span class="keywordflow">if</span> (!<a class="code" href="classvil__nitf2__image.html#a7cbd2adcac7d675a33c6a68dc3bc2c49">current_image_header</a>()-&gt;<a class="code" href="classvil__nitf2__image.html#a6fb85e934bc1c73a97e4ee93cd8d4ba7" title="Extra property information.">get_property</a>(<span class="stringliteral">&quot;IMODE&quot;</span>, image_mode_type)) <span class="keywordflow">return</span> 0;
<a name="l00662"></a>00662 
<a name="l00663"></a>00663   <span class="comment">//calculate the start position of the block that we need</span>
<a name="l00664"></a>00664   <span class="keywordtype">int</span> bits_per_pixel_per_band, actualBitsPerPixelPerBand;
<a name="l00665"></a>00665   vcl_string bitJustification;
<a name="l00666"></a>00666   <span class="keywordflow">if</span> (!<a class="code" href="classvil__nitf2__image.html#a7cbd2adcac7d675a33c6a68dc3bc2c49">current_image_header</a>()-&gt;<a class="code" href="classvil__nitf2__image.html#a6fb85e934bc1c73a97e4ee93cd8d4ba7" title="Extra property information.">get_property</a>(<span class="stringliteral">&quot;NBPP&quot;</span>, bits_per_pixel_per_band) ||
<a name="l00667"></a>00667       !<a class="code" href="classvil__nitf2__image.html#a7cbd2adcac7d675a33c6a68dc3bc2c49">current_image_header</a>()-&gt;<a class="code" href="classvil__nitf2__image.html#a6fb85e934bc1c73a97e4ee93cd8d4ba7" title="Extra property information.">get_property</a>(<span class="stringliteral">&quot;ABPP&quot;</span>, actualBitsPerPixelPerBand) ||
<a name="l00668"></a>00668       !<a class="code" href="classvil__nitf2__image.html#a7cbd2adcac7d675a33c6a68dc3bc2c49">current_image_header</a>()-&gt;<a class="code" href="classvil__nitf2__image.html#a6fb85e934bc1c73a97e4ee93cd8d4ba7" title="Extra property information.">get_property</a>(<span class="stringliteral">&quot;PJUST&quot;</span>, bitJustification)) {
<a name="l00669"></a>00669     <span class="keywordflow">return</span> 0;
<a name="l00670"></a>00670   }
<a name="l00671"></a>00671   <span class="keywordtype">int</span> extra_bits = bits_per_pixel_per_band - actualBitsPerPixelPerBand;
<a name="l00672"></a>00672   <span class="keywordtype">bool</span> need_to_right_justify = bitJustification == <span class="stringliteral">&quot;L&quot;</span> &amp;&amp; (extra_bits &gt; 0);
<a name="l00673"></a>00673 
<a name="l00674"></a>00674   <span class="comment">//bytes per pixel... round up to nearest byte</span>
<a name="l00675"></a>00675   <span class="comment">//unsigned int bytesPerPixelPerBand = bits_per_pixel_per_band / 8;</span>
<a name="l00676"></a>00676   <span class="comment">//if (bits_per_pixel_per_band % 8 != 0) bytesPerPixelPerBand++;</span>
<a name="l00677"></a>00677 
<a name="l00678"></a>00678   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> pixels_per_block = <a class="code" href="classvil__nitf2__image.html#afc2bb100fc2912e252d6cb72dc2ea0fa" title="Block size in columns.">size_block_i</a>() * <a class="code" href="classvil__nitf2__image.html#a4b8a7b6fa7f7c7b998a69f3672933c4f" title="Block size in rows.">size_block_j</a>();
<a name="l00679"></a>00679   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> bits_per_band = pixels_per_block * bits_per_pixel_per_band;
<a name="l00680"></a>00680   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> bytes_per_block_per_band = bits_per_band / 8;
<a name="l00681"></a>00681   <span class="keywordflow">if</span> (bits_per_band % 8 != 0) bytes_per_block_per_band++;     <span class="comment">//round up if remainder vcl_left over</span>
<a name="l00682"></a>00682   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> block_size_bytes = bytes_per_block_per_band * <a class="code" href="classvil__nitf2__image.html#a414c7041b3b107444614743c8c959baf" title="return the image info of the current image.">nplanes</a>();
<a name="l00683"></a>00683   <span class="comment">//allocate the memory that we need</span>
<a name="l00684"></a>00684   <a class="code" href="classvil__smart__ptr.html">vil_memory_chunk_sptr</a> image_memory = <span class="keyword">new</span> <a class="code" href="classvil__memory__chunk.html" title="Ref. counted block of data on the heap.">vil_memory_chunk</a>(block_size_bytes, <a class="code" href="classvil__nitf2__image.html#a16ffcd749afb8821d1baa9b0a34f2005" title="Pixel Format.">pixel_format</a>());
<a name="l00685"></a>00685 
<a name="l00686"></a>00686 
<a name="l00687"></a>00687   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i_step(0), j_step(0), plane_step(0);
<a name="l00688"></a>00688   <span class="keywordtype">bool</span> data_is_all_blank = <span class="keyword">false</span>;
<a name="l00689"></a>00689   <span class="keywordflow">if</span> (image_mode_type == <span class="stringliteral">&quot;S&quot;</span>) {
<a name="l00690"></a>00690 <span class="preprocessor">#if 0 // NOT USED</span>
<a name="l00691"></a>00691 <span class="preprocessor"></span>    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> bytes_per_band = <a class="code" href="classvil__nitf2__image.html#aed66aafd061126fcd1a5a4ddfab0fef7" title="Dimensions: Planes x ni x nj.">ni</a>() * <a class="code" href="classvil__nitf2__image.html#a04188de81e3efe282dea92e849770201" title="Dimensions: Planes x ni x nj.">nj</a>() * bits_per_pixel_per_band / 8;
<a name="l00692"></a>00692     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> offset_to_desired_block = bytes_per_block_per_band * (block_index_y * <a class="code" href="classvil__nitf2__image.html#a6cc711fe72e79ea99015896033897a96" title="Number of blocks in image width.">n_block_i</a>() + block_index_x);
<a name="l00693"></a>00693 <span class="preprocessor">#endif // 0</span>
<a name="l00694"></a>00694 <span class="preprocessor"></span>    <span class="comment">//blocks are not contiguous... we&#39;ll have to do one read for each band</span>
<a name="l00695"></a>00695     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0 ; i &lt; <a class="code" href="classvil__nitf2__image.html#a414c7041b3b107444614743c8c959baf" title="return the image info of the current image.">nplanes</a>() ; i++) {
<a name="l00696"></a>00696       <a class="code" href="vil__stream_8h.html#aa5e912c853d0dd23b24eefd6f6e5a3a4">vil_streampos</a> current_offset = <a class="code" href="classvil__nitf2__image.html#a2c03fd96e72cbd6dc8960e9bf7e6be6f">get_offset_to_image_data_block_band</a>(<a class="code" href="classvil__nitf2__image.html#a0a5d803cdef2dc53661f55dc0f5fcb6e">m_current_image_index</a>, block_index_x, block_index_y, i);
<a name="l00697"></a>00697       <span class="keywordflow">if</span> (current_offset == 0) {
<a name="l00698"></a>00698         <span class="comment">//this block isn&#39;t in the stream (ie. it&#39;s all blank)... just blank out the memory</span>
<a name="l00699"></a>00699         data_is_all_blank = <span class="keyword">true</span>;
<a name="l00700"></a>00700       }
<a name="l00701"></a>00701       <span class="keywordflow">else</span> {
<a name="l00702"></a>00702         <a class="code" href="classvil__nitf2__image.html#a03827b9f7535dde73fe41a46007a1ad9">m_stream</a>-&gt;<a class="code" href="classvil__stream.html#ab592f40f2538ea648fc101a0adea1a6d" title="Goto file pointer.">seek</a>(current_offset);
<a name="l00703"></a>00703         <span class="keywordtype">char</span>* position_to_read_to = <span class="keyword">static_cast&lt;</span><span class="keywordtype">char</span>*<span class="keyword">&gt;</span>(image_memory-&gt;data());
<a name="l00704"></a>00704         position_to_read_to += i*bytes_per_block_per_band;
<a name="l00705"></a>00705         <span class="keywordflow">if</span> (<a class="code" href="classvil__nitf2__image.html#a03827b9f7535dde73fe41a46007a1ad9">m_stream</a>-&gt;<a class="code" href="classvil__stream.html#a7c3585371cfe43aae4b5293fbafb9b52" title="Read n bytes into buf. Returns number of bytes read.">read</a>((<span class="keywordtype">void</span>*)position_to_read_to, bytes_per_block_per_band) != <span class="keyword">static_cast&lt;</span><span class="keywordtype">int</span><span class="keyword">&gt;</span>(bytes_per_block_per_band)) {
<a name="l00706"></a>00706           <span class="keywordflow">return</span> 0;
<a name="l00707"></a>00707         }
<a name="l00708"></a>00708       }
<a name="l00709"></a>00709     }
<a name="l00710"></a>00710     i_step = 1;
<a name="l00711"></a>00711     j_step = <a class="code" href="classvil__nitf2__image.html#afc2bb100fc2912e252d6cb72dc2ea0fa" title="Block size in columns.">size_block_i</a>();
<a name="l00712"></a>00712     plane_step = <a class="code" href="classvil__nitf2__image.html#afc2bb100fc2912e252d6cb72dc2ea0fa" title="Block size in columns.">size_block_i</a>() * <a class="code" href="classvil__nitf2__image.html#a4b8a7b6fa7f7c7b998a69f3672933c4f" title="Block size in rows.">size_block_j</a>();
<a name="l00713"></a>00713   }
<a name="l00714"></a>00714   <span class="keywordflow">else</span> {
<a name="l00715"></a>00715     <span class="comment">//calculate the offset we need</span>
<a name="l00716"></a>00716     <a class="code" href="vil__stream_8h.html#aa5e912c853d0dd23b24eefd6f6e5a3a4">vil_streampos</a> current_offset = <a class="code" href="classvil__nitf2__image.html#a2c03fd96e72cbd6dc8960e9bf7e6be6f">get_offset_to_image_data_block_band</a>(<a class="code" href="classvil__nitf2__image.html#a0a5d803cdef2dc53661f55dc0f5fcb6e">m_current_image_index</a>, block_index_x, block_index_y, 0);
<a name="l00717"></a>00717     <span class="keywordflow">if</span> (current_offset == 0) {
<a name="l00718"></a>00718       <span class="comment">//this block isn&#39;t in the stream (ie. it&#39;s all blank)... just blank out the memory</span>
<a name="l00719"></a>00719       data_is_all_blank = <span class="keyword">true</span>;
<a name="l00720"></a>00720     }
<a name="l00721"></a>00721     <span class="keywordflow">else</span> {
<a name="l00722"></a>00722       <span class="comment">//seek to the correct position in the stream</span>
<a name="l00723"></a>00723       <a class="code" href="classvil__nitf2__image.html#a03827b9f7535dde73fe41a46007a1ad9">m_stream</a>-&gt;<a class="code" href="classvil__stream.html#ab592f40f2538ea648fc101a0adea1a6d" title="Goto file pointer.">seek</a>(current_offset);
<a name="l00724"></a>00724       <span class="comment">//read in the data</span>
<a name="l00725"></a>00725       <span class="keywordflow">if</span> (<a class="code" href="classvil__nitf2__image.html#a03827b9f7535dde73fe41a46007a1ad9">m_stream</a>-&gt;<a class="code" href="classvil__stream.html#a7c3585371cfe43aae4b5293fbafb9b52" title="Read n bytes into buf. Returns number of bytes read.">read</a>(image_memory-&gt;data(), block_size_bytes) != static_cast&lt;int&gt;(block_size_bytes)) {
<a name="l00726"></a>00726         <span class="keywordflow">return</span> 0;
<a name="l00727"></a>00727       }
<a name="l00728"></a>00728     }
<a name="l00729"></a>00729 
<a name="l00730"></a>00730     <span class="comment">//figure out the layout of the data in the memory chunk we just read in</span>
<a name="l00731"></a>00731     <span class="keywordflow">if</span> (image_mode_type == <span class="stringliteral">&quot;B&quot;</span>) {
<a name="l00732"></a>00732       <span class="comment">//band interleaved by Block</span>
<a name="l00733"></a>00733       i_step = 1;
<a name="l00734"></a>00734       j_step = <a class="code" href="classvil__nitf2__image.html#afc2bb100fc2912e252d6cb72dc2ea0fa" title="Block size in columns.">size_block_i</a>();
<a name="l00735"></a>00735       plane_step = <a class="code" href="classvil__nitf2__image.html#afc2bb100fc2912e252d6cb72dc2ea0fa" title="Block size in columns.">size_block_i</a>() * <a class="code" href="classvil__nitf2__image.html#a4b8a7b6fa7f7c7b998a69f3672933c4f" title="Block size in rows.">size_block_j</a>();
<a name="l00736"></a>00736     }
<a name="l00737"></a>00737     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (image_mode_type == <span class="stringliteral">&quot;P&quot;</span>) {
<a name="l00738"></a>00738       <span class="comment">//band interleaved by Pixel</span>
<a name="l00739"></a>00739       i_step = <a class="code" href="classvil__nitf2__image.html#a414c7041b3b107444614743c8c959baf" title="return the image info of the current image.">nplanes</a>();
<a name="l00740"></a>00740       j_step = <a class="code" href="classvil__nitf2__image.html#a414c7041b3b107444614743c8c959baf" title="return the image info of the current image.">nplanes</a>() * <a class="code" href="classvil__nitf2__image.html#afc2bb100fc2912e252d6cb72dc2ea0fa" title="Block size in columns.">size_block_i</a>();
<a name="l00741"></a>00741       plane_step = 1;
<a name="l00742"></a>00742     }
<a name="l00743"></a>00743     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (image_mode_type == <span class="stringliteral">&quot;R&quot;</span>) {
<a name="l00744"></a>00744       <span class="comment">//band interleaved by Row</span>
<a name="l00745"></a>00745       i_step = 1;
<a name="l00746"></a>00746       j_step = <a class="code" href="classvil__nitf2__image.html#a414c7041b3b107444614743c8c959baf" title="return the image info of the current image.">nplanes</a>() * <a class="code" href="classvil__nitf2__image.html#afc2bb100fc2912e252d6cb72dc2ea0fa" title="Block size in columns.">size_block_i</a>();
<a name="l00747"></a>00747       plane_step = <a class="code" href="classvil__nitf2__image.html#afc2bb100fc2912e252d6cb72dc2ea0fa" title="Block size in columns.">size_block_i</a>();
<a name="l00748"></a>00748     }
<a name="l00749"></a>00749   }
<a name="l00750"></a>00750 
<a name="l00751"></a>00751   <span class="comment">//create image view of the data</span>
<a name="l00752"></a>00752   <a class="code" href="classvil__smart__ptr.html" title="A templated smart pointer class.">vil_image_view_base_sptr</a> view = 0;
<a name="l00753"></a>00753   <span class="keywordflow">switch</span> (<a class="code" href="vil__pixel__format_8cxx.html#a0589722cd843f9c7790df385fbb29a13" title="Return the number of components in pixel format f.">vil_pixel_format_component_format</a>(image_memory-&gt;pixel_format()))
<a name="l00754"></a>00754   {
<a name="l00755"></a>00755 <span class="preprocessor">#define GET_BLOCK_CASE(FORMAT, T)\</span>
<a name="l00756"></a>00756 <span class="preprocessor">   case FORMAT:{ \</span>
<a name="l00757"></a>00757 <span class="preprocessor">    T t= (T)0; \</span>
<a name="l00758"></a>00758 <span class="preprocessor">    return get_block_vcl_internal(\</span>
<a name="l00759"></a>00759 <span class="preprocessor">       FORMAT, image_memory, size_block_i(),size_block_j(), nplanes(),\</span>
<a name="l00760"></a>00760 <span class="preprocessor">       i_step, j_step, plane_step, need_to_right_justify, extra_bits, bits_per_pixel_per_band,\</span>
<a name="l00761"></a>00761 <span class="preprocessor">       data_is_all_blank, current_image_header(), t);\</span>
<a name="l00762"></a>00762 <span class="preprocessor">   } break</span>
<a name="l00763"></a>00763 <span class="preprocessor"></span>
<a name="l00764"></a>00764     <a class="code" href="vil__nitf2__image_8cxx.html#aec1eb4c5ddc17a16dc81c96aa986c865">GET_BLOCK_CASE</a>(<a class="code" href="vil__pixel__format_8h.html#a6f749d91364b0bcb661189f4a154800da7e558fc5ba55dbb9c32658e7960b83f4">VIL_PIXEL_FORMAT_BYTE</a>, vxl_byte);
<a name="l00765"></a>00765     <a class="code" href="vil__nitf2__image_8cxx.html#aec1eb4c5ddc17a16dc81c96aa986c865">GET_BLOCK_CASE</a>(<a class="code" href="vil__pixel__format_8h.html#a6f749d91364b0bcb661189f4a154800da20c3ae85fdecfa20b5ecf12f8894efeb">VIL_PIXEL_FORMAT_SBYTE</a>, vxl_sbyte);
<a name="l00766"></a>00766 
<a name="l00767"></a>00767 <span class="preprocessor">#if VXL_HAS_INT_64</span>
<a name="l00768"></a>00768 <span class="preprocessor"></span>    <a class="code" href="vil__nitf2__image_8cxx.html#aec1eb4c5ddc17a16dc81c96aa986c865">GET_BLOCK_CASE</a>(VIL_PIXEL_FORMAT_UINT_64, vxl_uint_64);
<a name="l00769"></a>00769     <a class="code" href="vil__nitf2__image_8cxx.html#aec1eb4c5ddc17a16dc81c96aa986c865">GET_BLOCK_CASE</a>(VIL_PIXEL_FORMAT_INT_64, vxl_int_64);
<a name="l00770"></a>00770 <span class="preprocessor">#endif</span>
<a name="l00771"></a>00771 <span class="preprocessor"></span>    <a class="code" href="vil__nitf2__image_8cxx.html#aec1eb4c5ddc17a16dc81c96aa986c865">GET_BLOCK_CASE</a>(<a class="code" href="vil__pixel__format_8h.html#a6f749d91364b0bcb661189f4a154800da355f2de6abb4cb81d9ca9cfcad7dd0fa">VIL_PIXEL_FORMAT_UINT_32</a>, vxl_uint_32);
<a name="l00772"></a>00772     <a class="code" href="vil__nitf2__image_8cxx.html#aec1eb4c5ddc17a16dc81c96aa986c865">GET_BLOCK_CASE</a>(<a class="code" href="vil__pixel__format_8h.html#a6f749d91364b0bcb661189f4a154800da65f175b4a4049f8457bc8c4f772b9f5d">VIL_PIXEL_FORMAT_INT_32</a>, vxl_int_32);
<a name="l00773"></a>00773     <a class="code" href="vil__nitf2__image_8cxx.html#aec1eb4c5ddc17a16dc81c96aa986c865">GET_BLOCK_CASE</a>(<a class="code" href="vil__pixel__format_8h.html#a6f749d91364b0bcb661189f4a154800dabecb5c0033517756dc112ccd18f97073">VIL_PIXEL_FORMAT_UINT_16</a>, vxl_uint_16);
<a name="l00774"></a>00774     <a class="code" href="vil__nitf2__image_8cxx.html#aec1eb4c5ddc17a16dc81c96aa986c865">GET_BLOCK_CASE</a>(<a class="code" href="vil__pixel__format_8h.html#a6f749d91364b0bcb661189f4a154800daba50e1cdc6e602c7e314fa82066027a3">VIL_PIXEL_FORMAT_INT_16</a>, vxl_int_16);
<a name="l00775"></a>00775     <a class="code" href="vil__nitf2__image_8cxx.html#aec1eb4c5ddc17a16dc81c96aa986c865">GET_BLOCK_CASE</a>(<a class="code" href="vil__pixel__format_8h.html#a6f749d91364b0bcb661189f4a154800da270ef8e69c137b9bed10074d2726ffa9">VIL_PIXEL_FORMAT_BOOL</a>, <span class="keywordtype">bool</span>);
<a name="l00776"></a>00776     <a class="code" href="vil__nitf2__image_8cxx.html#aec1eb4c5ddc17a16dc81c96aa986c865">GET_BLOCK_CASE</a>(<a class="code" href="vil__pixel__format_8h.html#a6f749d91364b0bcb661189f4a154800da8d2e38094a68770dcad0e6637d5ce3ba">VIL_PIXEL_FORMAT_FLOAT</a>, <span class="keywordtype">float</span>);
<a name="l00777"></a>00777     <a class="code" href="vil__nitf2__image_8cxx.html#aec1eb4c5ddc17a16dc81c96aa986c865">GET_BLOCK_CASE</a>(<a class="code" href="vil__pixel__format_8h.html#a6f749d91364b0bcb661189f4a154800da57e197d362a17a1777b1ff69ee82e8ec">VIL_PIXEL_FORMAT_DOUBLE</a>, <span class="keywordtype">double</span>);
<a name="l00778"></a>00778     <a class="code" href="vil__nitf2__image_8cxx.html#aec1eb4c5ddc17a16dc81c96aa986c865">GET_BLOCK_CASE</a>(<a class="code" href="vil__pixel__format_8h.html#a6f749d91364b0bcb661189f4a154800da0a0fa304f6d2f439026143d225828a24" title="vcl_complex&lt;float&gt; is a scalar for vil&#39;s purposes.">VIL_PIXEL_FORMAT_COMPLEX_FLOAT</a>, vcl_complex&lt;float&gt;);
<a name="l00779"></a>00779 <span class="preprocessor">#undef GET_BLOCK_CASE</span>
<a name="l00780"></a>00780 <span class="preprocessor"></span>
<a name="l00781"></a>00781    <span class="keywordflow">default</span>:
<a name="l00782"></a>00782     assert(!<span class="stringliteral">&quot;Unknown vil data type.&quot;</span>);
<a name="l00783"></a>00783     <span class="keywordflow">break</span>;
<a name="l00784"></a>00784   }
<a name="l00785"></a>00785   <span class="keywordflow">return</span> view;
<a name="l00786"></a>00786 }
<a name="l00787"></a>00787 
<a name="l00788"></a><a class="code" href="vil__nitf2__image_8h.html#a9f4d6ff98d1c97833108e66b22281404">00788</a> <span class="keyword">template</span>&lt;&gt; <span class="keywordtype">bool</span>* <a class="code" href="vil__nitf2__image_8cxx.html#a9f4d6ff98d1c97833108e66b22281404">byte_align_data&lt;bool&gt;</a>(<span class="keywordtype">bool</span>* in_data, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> num_samples, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> in_bits_per_sample, <span class="keywordtype">bool</span>* out_data)
<a name="l00789"></a>00789 {
<a name="l00790"></a>00790   <span class="keywordflow">switch</span> (<span class="keyword">sizeof</span>(<span class="keywordtype">bool</span>))
<a name="l00791"></a>00791   {
<a name="l00792"></a>00792    <span class="keywordflow">case</span> 1:
<a name="l00793"></a>00793     <a class="code" href="vil__nitf2__image_8h.html#a762b4b7bc8b75247565da5aec8e3dec2" title="This function will byte align the data in in_data and store the result in out_data.">byte_align_data</a>((vxl_byte*)in_data, num_samples, in_bits_per_sample, (vxl_byte*)out_data);
<a name="l00794"></a>00794     <span class="keywordflow">break</span>;
<a name="l00795"></a>00795    <span class="keywordflow">case</span> 2:
<a name="l00796"></a>00796     <a class="code" href="vil__nitf2__image_8h.html#a762b4b7bc8b75247565da5aec8e3dec2" title="This function will byte align the data in in_data and store the result in out_data.">byte_align_data</a>((vxl_uint_16*)in_data, num_samples, in_bits_per_sample, (vxl_uint_16*)out_data);
<a name="l00797"></a>00797     <span class="keywordflow">break</span>;
<a name="l00798"></a>00798    <span class="keywordflow">case</span> 4:
<a name="l00799"></a>00799     <a class="code" href="vil__nitf2__image_8h.html#a762b4b7bc8b75247565da5aec8e3dec2" title="This function will byte align the data in in_data and store the result in out_data.">byte_align_data</a>((vxl_uint_32*)in_data, num_samples, in_bits_per_sample, (vxl_uint_32*)out_data);
<a name="l00800"></a>00800     <span class="keywordflow">break</span>;
<a name="l00801"></a>00801 <span class="preprocessor">#if VXL_HAS_INT_64</span>
<a name="l00802"></a>00802 <span class="preprocessor"></span>   <span class="keywordflow">case</span> 8:
<a name="l00803"></a>00803     <a class="code" href="vil__nitf2__image_8h.html#a762b4b7bc8b75247565da5aec8e3dec2" title="This function will byte align the data in in_data and store the result in out_data.">byte_align_data</a>((vxl_uint_64*)in_data, num_samples, in_bits_per_sample, (vxl_uint_64*)out_data);
<a name="l00804"></a>00804     <span class="keywordflow">break</span>;
<a name="l00805"></a>00805 <span class="preprocessor">#endif //VXL_HAS_INT_64</span>
<a name="l00806"></a>00806 <span class="preprocessor"></span>   <span class="keywordflow">default</span>:
<a name="l00807"></a>00807     assert(!<span class="stringliteral">&quot;Unsupported size of bool.&quot;</span>);
<a name="l00808"></a>00808   }
<a name="l00809"></a>00809 
<a name="l00810"></a>00810 <span class="preprocessor">#if 0</span>
<a name="l00811"></a>00811 <span class="preprocessor"></span>  <span class="comment">// diagnostic info</span>
<a name="l00812"></a>00812   vcl_cout &lt;&lt; <span class="stringliteral">&quot;\nBools: &quot;</span>;
<a name="l00813"></a>00813   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0 ; i &lt; num_samples ; i++) {
<a name="l00814"></a>00814     vcl_cout &lt;&lt; (out_data[i] ?  <span class="charliteral">&#39;1&#39;</span> : <span class="charliteral">&#39;0&#39;</span>);
<a name="l00815"></a>00815   }
<a name="l00816"></a>00816   vcl_cout &lt;&lt; vcl_endl;
<a name="l00817"></a>00817 <span class="preprocessor">#endif //0</span>
<a name="l00818"></a>00818 <span class="preprocessor"></span>  <span class="keywordflow">return</span> out_data;
<a name="l00819"></a>00819 }
<a name="l00820"></a>00820 
<a name="l00821"></a><a class="code" href="classvil__nitf2__image.html#a6fb85e934bc1c73a97e4ee93cd8d4ba7">00821</a> <span class="keywordtype">bool</span> <a class="code" href="classvil__nitf2__image.html#a6fb85e934bc1c73a97e4ee93cd8d4ba7" title="Extra property information.">vil_nitf2_image::get_property</a> (<span class="keywordtype">char</span> <span class="keyword">const</span> *tag, <span class="keywordtype">void</span> *property_value)<span class="keyword"> const</span>
<a name="l00822"></a>00822 <span class="keyword"></span>{
<a name="l00823"></a>00823   <span class="keywordflow">if</span> (vcl_strcmp(<a class="code" href="vil__property_8h.html#a3e1d0bb174b339a17f35f977fa0a4e05" title="For unblocked images, the following properties are not implemented.">vil_property_size_block_i</a>, tag)==0)
<a name="l00824"></a>00824   {
<a name="l00825"></a>00825     <span class="keywordflow">if</span> (property_value)
<a name="l00826"></a>00826       *<span class="keyword">static_cast&lt;</span><span class="keywordtype">unsigned</span>*<span class="keyword">&gt;</span>(property_value) = this-&gt;<a class="code" href="classvil__nitf2__image.html#afc2bb100fc2912e252d6cb72dc2ea0fa" title="Block size in columns.">size_block_i</a>();
<a name="l00827"></a>00827     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00828"></a>00828   }
<a name="l00829"></a>00829 
<a name="l00830"></a>00830   <span class="keywordflow">if</span> (vcl_strcmp(<a class="code" href="vil__property_8h.html#afb6da66a543860685b1ff4f9df87245d" title="Block size in rows.">vil_property_size_block_j</a>, tag)==0)
<a name="l00831"></a>00831   {
<a name="l00832"></a>00832     <span class="keywordflow">if</span> (property_value)
<a name="l00833"></a>00833       *<span class="keyword">static_cast&lt;</span><span class="keywordtype">unsigned</span>*<span class="keyword">&gt;</span>(property_value) = this-&gt;<a class="code" href="classvil__nitf2__image.html#a4b8a7b6fa7f7c7b998a69f3672933c4f" title="Block size in rows.">size_block_j</a>();
<a name="l00834"></a>00834     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00835"></a>00835   }
<a name="l00836"></a>00836   vcl_string result;
<a name="l00837"></a>00837   <span class="keywordflow">if</span> (<a class="code" href="classvil__nitf2__image.html#a9f399d9b7d273ab05cbed4d49d67bdce">m_file_header</a>.<a class="code" href="classvil__nitf2__header.html#ada6daeb0eb8efc6a44b7d17a8a77b47e">get_property</a>(tag, result) ||
<a name="l00838"></a>00838       (<a class="code" href="classvil__nitf2__image.html#a7cbd2adcac7d675a33c6a68dc3bc2c49">current_image_header</a>() &amp;&amp; <a class="code" href="classvil__nitf2__image.html#a7cbd2adcac7d675a33c6a68dc3bc2c49">current_image_header</a>()-&gt;<a class="code" href="classvil__nitf2__image__subheader.html#ab2db73d2db795da44f1ca580bb672ad6" title="Sets out_value to the value of field specified by tag.">get_property</a>(tag, result)))
<a name="l00839"></a>00839   {
<a name="l00840"></a>00840     property_value = vcl_malloc(result.size());
<a name="l00841"></a>00841     vcl_memcpy(property_value, result.c_str(), result.size());
<a name="l00842"></a>00842     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00843"></a>00843   }
<a name="l00844"></a>00844   <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00845"></a>00845  }
<a name="l00846"></a>00846 
<a name="l00847"></a><a class="code" href="classvil__nitf2__image.html#a30c42c1ebd93e19dd4b48890d3924452">00847</a> <a class="code" href="classvil__nitf2__field_1_1field__tree.html">vil_nitf2_field::field_tree</a>* <a class="code" href="classvil__nitf2__image.html#a30c42c1ebd93e19dd4b48890d3924452">vil_nitf2_image::get_tree</a>( )<span class="keyword"> const</span>
<a name="l00848"></a>00848 <span class="keyword"></span>{
<a name="l00849"></a>00849   <a class="code" href="classvil__nitf2__field_1_1field__tree.html">vil_nitf2_field::field_tree</a>* t = <span class="keyword">new</span> <a class="code" href="classvil__nitf2__field_1_1field__tree.html">vil_nitf2_field::field_tree</a>;
<a name="l00850"></a>00850   t-&gt;<a class="code" href="classvil__nitf2__field_1_1field__tree.html#a482d165f8609bd628e345fd1da0a2bae">columns</a>.push_back( <span class="stringliteral">&quot;NITF File&quot;</span> );
<a name="l00851"></a>00851   t-&gt;<a class="code" href="classvil__nitf2__field_1_1field__tree.html#a6a6e1c90f1f6ed7b485d888dd881726f">children</a>.push_back( <a class="code" href="classvil__nitf2__image.html#a7091548e0717139bd2689b395339fb11">get_header</a>().<a class="code" href="classvil__nitf2__image.html#a30c42c1ebd93e19dd4b48890d3924452">get_tree</a>() );
<a name="l00852"></a>00852   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i;
<a name="l00853"></a>00853   <span class="keywordflow">for</span> ( i = 0 ; i &lt; <a class="code" href="classvil__nitf2__image.html#aa134d164887a773d42db2d603315bdd6">m_image_headers</a>.size() ; i++ ){
<a name="l00854"></a>00854     t-&gt;<a class="code" href="classvil__nitf2__field_1_1field__tree.html#a6a6e1c90f1f6ed7b485d888dd881726f">children</a>.push_back( <a class="code" href="classvil__nitf2__image.html#aa134d164887a773d42db2d603315bdd6">m_image_headers</a>[i]-&gt;<a class="code" href="classvil__nitf2__image.html#a30c42c1ebd93e19dd4b48890d3924452">get_tree</a>(i+1) );
<a name="l00855"></a>00855   }
<a name="l00856"></a>00856   <span class="keywordflow">for</span> ( i = 0 ; i &lt; <a class="code" href="classvil__nitf2__image.html#a42bf751f30422e067e5bb42a742aa30c">m_des</a>.size() ; i++ ){
<a name="l00857"></a>00857     t-&gt;<a class="code" href="classvil__nitf2__field_1_1field__tree.html#a6a6e1c90f1f6ed7b485d888dd881726f">children</a>.push_back( <a class="code" href="classvil__nitf2__image.html#a42bf751f30422e067e5bb42a742aa30c">m_des</a>[i]-&gt;<a class="code" href="classvil__nitf2__image.html#a30c42c1ebd93e19dd4b48890d3924452">get_tree</a>(i+1) );
<a name="l00858"></a>00858   }
<a name="l00859"></a>00859   <span class="keywordflow">return</span> t;
<a name="l00860"></a>00860 }
<a name="l00861"></a>00861 
</pre></div></div>
</div>


<hr class="footer"/><address class="footer"><small>
Generated on Wed May 1 2013 17:31:46 for core/vil by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.7.5.1
</small></address>

</body>
</html>
