<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
"http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
  <title>core/vpgl/algo/vpgl_camera_convert.cxx Source File</title>
  <link href="doxygen.css" rel="stylesheet" type="text/css" />
  <link href="tabs.css" rel="stylesheet" type="text/css" />
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
</head>
<body>
<!-- Generated by Doxygen 1.7.5.1 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<div class="title">core/vpgl/algo/vpgl_camera_convert.cxx</div>  </div>
</div>
<div class="contents">
<a href="vpgl__camera__convert_8cxx.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">// This is core/vpgl/algo/vpgl_camera_convert.cxx</span>
<a name="l00002"></a>00002 <span class="preprocessor">#ifndef vpgl_camera_convert_cxx_</span>
<a name="l00003"></a><a class="code" href="vpgl__camera__convert_8cxx.html#adcd97fa10b12bd80063bfca4c814837a">00003</a> <span class="preprocessor"></span><span class="preprocessor">#define vpgl_camera_convert_cxx_</span>
<a name="l00004"></a>00004 <span class="preprocessor"></span>
<a name="l00005"></a>00005 <span class="preprocessor">#include &quot;<a class="code" href="vpgl__camera__convert_8h.html" title="Several routines for converting camera types.">vpgl_camera_convert.h</a>&quot;</span>
<a name="l00006"></a>00006 <span class="comment">//:</span>
<a name="l00007"></a>00007 <span class="comment">// \file</span>
<a name="l00008"></a>00008 <span class="preprocessor">#include &lt;vcl_iostream.h&gt;</span>
<a name="l00009"></a>00009 <span class="preprocessor">#include &lt;vcl_cassert.h&gt;</span>
<a name="l00010"></a>00010 <span class="preprocessor">#include &lt;vcl_cstdlib.h&gt;</span> <span class="comment">// for rand()</span>
<a name="l00011"></a>00011 <span class="preprocessor">#include &lt;vcl_cmath.h&gt;</span> <span class="comment">// for std::pow()</span>
<a name="l00012"></a>00012 <span class="preprocessor">#include &lt;<a class="codeRef" doxygen="core_vnl.tag:../../../core/vnl/html/" href="../../../core/vnl/html/vnl__numeric__traits_8h.html">vnl/vnl_numeric_traits.h</a>&gt;</span>
<a name="l00013"></a>00013 <span class="preprocessor">#include &lt;<a class="codeRef" doxygen="core_vnl.tag:../../../core/vnl/html/" href="../../../core/vnl/html/vnl__det_8h.html">vnl/vnl_det.h</a>&gt;</span>
<a name="l00014"></a>00014 <span class="preprocessor">#include &lt;<a class="codeRef" doxygen="core_vnl.tag:../../../core/vnl/html/" href="../../../core/vnl/html/vnl__vector__fixed_8h.html">vnl/vnl_vector_fixed.h</a>&gt;</span>
<a name="l00015"></a>00015 <span class="preprocessor">#include &lt;<a class="codeRef" doxygen="core_vnl.tag:../../../core/vnl/html/" href="../../../core/vnl/html/vnl__matrix__fixed_8h.html">vnl/vnl_matrix_fixed.h</a>&gt;</span>
<a name="l00016"></a>00016 <span class="preprocessor">#include &lt;<a class="codeRef" doxygen="core_vnl.tag:../../../core/vnl/html/" href="../../../core/vnl/html/vnl__svd_8h.html">vnl/algo/vnl_svd.h</a>&gt;</span>
<a name="l00017"></a>00017 <span class="preprocessor">#include &lt;<a class="codeRef" doxygen="core_vnl.tag:../../../core/vnl/html/" href="../../../core/vnl/html/vnl__qr_8h.html">vnl/algo/vnl_qr.h</a>&gt;</span>
<a name="l00018"></a>00018 <span class="preprocessor">#include &lt;<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/vgl__rotation__3d_8h.html">vgl/algo/vgl_rotation_3d.h</a>&gt;</span>
<a name="l00019"></a>00019 <span class="preprocessor">#include &lt;<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/vgl__h__matrix__3d_8h.html">vgl/algo/vgl_h_matrix_3d.h</a>&gt;</span>
<a name="l00020"></a>00020 <span class="preprocessor">#include &lt;<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/vgl__homg__point__3d_8h.html">vgl/vgl_homg_point_3d.h</a>&gt;</span>
<a name="l00021"></a>00021 <span class="preprocessor">#include &lt;<a class="code" href="vpgl__ortho__procrustes_8h.html" title="Solve min(R,s) ||X-s(RY+t)||, where R is a rotation matrix, X,Y are 3-d points, s is a scalar and t i...">vpgl/algo/vpgl_ortho_procrustes.h</a>&gt;</span>
<a name="l00022"></a>00022 <span class="preprocessor">#include &lt;<a class="code" href="vpgl__optimize__camera_8h.html" title="Methods for projecting geometric structures onto the image.">vpgl/algo/vpgl_optimize_camera.h</a>&gt;</span>
<a name="l00023"></a>00023 <span class="preprocessor">#include &lt;<a class="code" href="vpgl__camera__compute_8h.html" title="Several routines for computing different kinds of cameras from world-point correspondences.">vpgl/algo/vpgl_camera_compute.h</a>&gt;</span>
<a name="l00024"></a>00024 <span class="preprocessor">#include &lt;<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/vgl__point__2d_8h.html">vgl/vgl_point_2d.h</a>&gt;</span>
<a name="l00025"></a>00025 <span class="preprocessor">#include &lt;<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/vgl__point__3d_8h.html">vgl/vgl_point_3d.h</a>&gt;</span>
<a name="l00026"></a>00026 <span class="preprocessor">#include &lt;<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/vgl__box__3d_8h.html">vgl/vgl_box_3d.h</a>&gt;</span>
<a name="l00027"></a>00027 <span class="preprocessor">#include &lt;<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/vgl__homg__point__2d_8h.html">vgl/vgl_homg_point_2d.h</a>&gt;</span>
<a name="l00028"></a>00028 <span class="preprocessor">#include &lt;<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/vgl__ray__3d_8h.html">vgl/vgl_ray_3d.h</a>&gt;</span>
<a name="l00029"></a>00029 <span class="preprocessor">#include &lt;<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/vgl__plane__3d_8h.html">vgl/vgl_plane_3d.h</a>&gt;</span>
<a name="l00030"></a>00030 <span class="preprocessor">#include &lt;<a class="codeRef" doxygen="core_vbl.tag:../../../core/vbl/html/" href="../../../core/vbl/html/vbl__array__2d_8h.html">vbl/vbl_array_2d.h</a>&gt;</span>
<a name="l00031"></a>00031 <span class="preprocessor">#include &lt;<a class="code" href="vpgl__lvcs_8h.html" title="A geographic coordinate system.">vpgl/vpgl_lvcs.h</a>&gt;</span>
<a name="l00032"></a>00032 <span class="preprocessor">#include &lt;<a class="code" href="vpgl__backproject_8h.html" title="Methods for back_projecting from cameras to 3-d geometric structures.">vpgl/algo/vpgl_backproject.h</a>&gt;</span>
<a name="l00033"></a>00033 
<a name="l00034"></a>00034 
<a name="l00035"></a>00035 <span class="keyword">static</span> vcl_vector&lt;double&gt;
<a name="l00036"></a>00036 pvector(<span class="keyword">const</span> <span class="keywordtype">double</span> x, <span class="keyword">const</span> <span class="keywordtype">double</span> y, <span class="keyword">const</span> <span class="keywordtype">double</span> z)
<a name="l00037"></a>00037 {
<a name="l00038"></a>00038   <span class="comment">//fill the vector</span>
<a name="l00039"></a>00039   vcl_vector&lt;double&gt; pv(20);
<a name="l00040"></a>00040   pv[0]= x*x*x;
<a name="l00041"></a>00041   pv[1]= x*x*y;
<a name="l00042"></a>00042   pv[2]= x*x*z;
<a name="l00043"></a>00043   pv[3]= x*x;
<a name="l00044"></a>00044   pv[4]= x*y*y;
<a name="l00045"></a>00045   pv[5]= x*y*z;
<a name="l00046"></a>00046   pv[6]= x*y;
<a name="l00047"></a>00047   pv[7]= x*z*z;
<a name="l00048"></a>00048   pv[8]= x*z;
<a name="l00049"></a>00049   pv[9]= x;
<a name="l00050"></a>00050   pv[10]= y*y*y;
<a name="l00051"></a>00051   pv[11]= y*y*z;
<a name="l00052"></a>00052   pv[12]= y*y;
<a name="l00053"></a>00053   pv[13]= y*z*z;
<a name="l00054"></a>00054   pv[14]= y*z;
<a name="l00055"></a>00055   pv[15]= y;
<a name="l00056"></a>00056   pv[16]= z*z*z;
<a name="l00057"></a>00057   pv[17]= z*z;
<a name="l00058"></a>00058   pv[18]= z;
<a name="l00059"></a>00059   pv[19]= 1;
<a name="l00060"></a>00060   <span class="keywordflow">return</span> pv;
<a name="l00061"></a>00061 }
<a name="l00062"></a>00062 
<a name="l00063"></a>00063 <span class="keyword">static</span> vcl_vector&lt;double&gt;
<a name="l00064"></a>00064 power_vector_dx(<span class="keyword">const</span> <span class="keywordtype">double</span> x, <span class="keyword">const</span> <span class="keywordtype">double</span> y, <span class="keyword">const</span> <span class="keywordtype">double</span> z)
<a name="l00065"></a>00065 {
<a name="l00066"></a>00066   <span class="comment">//fill the vector</span>
<a name="l00067"></a>00067   vcl_vector&lt;double&gt; pv(20, 0.0);
<a name="l00068"></a>00068   pv[0]= 3*x*x;
<a name="l00069"></a>00069   pv[1]= 2*x*y;
<a name="l00070"></a>00070   pv[2]= 2*x*z;
<a name="l00071"></a>00071   pv[3]= 2*x;
<a name="l00072"></a>00072   pv[4]= y*y;
<a name="l00073"></a>00073   pv[5]= y*z;
<a name="l00074"></a>00074   pv[6]= y;
<a name="l00075"></a>00075   pv[7]= z*z;
<a name="l00076"></a>00076   pv[8]= z;
<a name="l00077"></a>00077   pv[9]= 1;
<a name="l00078"></a>00078   <span class="keywordflow">return</span> pv;
<a name="l00079"></a>00079 }
<a name="l00080"></a>00080 
<a name="l00081"></a>00081 <span class="keyword">static</span> vcl_vector&lt;double&gt;
<a name="l00082"></a>00082 power_vector_dy(<span class="keyword">const</span> <span class="keywordtype">double</span> x, <span class="keyword">const</span> <span class="keywordtype">double</span> y, <span class="keyword">const</span> <span class="keywordtype">double</span> z)
<a name="l00083"></a>00083 {
<a name="l00084"></a>00084   <span class="comment">//fill the vector</span>
<a name="l00085"></a>00085   vcl_vector&lt;double&gt; pv(20, 0.0);
<a name="l00086"></a>00086   pv[1]= x*x;
<a name="l00087"></a>00087   pv[4]= 2*x*y;
<a name="l00088"></a>00088   pv[5]= x*z;
<a name="l00089"></a>00089   pv[6]= x;
<a name="l00090"></a>00090   pv[10]= 3*y*y;
<a name="l00091"></a>00091   pv[11]= 2*y*z;
<a name="l00092"></a>00092   pv[12]= 2*y;
<a name="l00093"></a>00093   pv[13]= z*z;
<a name="l00094"></a>00094   pv[14]= z;
<a name="l00095"></a>00095   pv[15]= 1;
<a name="l00096"></a>00096   <span class="keywordflow">return</span> pv;
<a name="l00097"></a>00097 }
<a name="l00098"></a>00098 
<a name="l00099"></a>00099 <span class="keyword">static</span> vcl_vector&lt;double&gt;
<a name="l00100"></a>00100 power_vector_dz(<span class="keyword">const</span> <span class="keywordtype">double</span> x, <span class="keyword">const</span> <span class="keywordtype">double</span> y, <span class="keyword">const</span> <span class="keywordtype">double</span> z)
<a name="l00101"></a>00101 {
<a name="l00102"></a>00102   <span class="comment">//fill the vector</span>
<a name="l00103"></a>00103   vcl_vector&lt;double&gt; pv(20, 0.0);
<a name="l00104"></a>00104   pv[2]= x*x;
<a name="l00105"></a>00105   pv[5]= x*y;
<a name="l00106"></a>00106   pv[7]= 2*x*z;
<a name="l00107"></a>00107   pv[8]= x;
<a name="l00108"></a>00108   pv[11]= y*y;
<a name="l00109"></a>00109   pv[13]= 2*y*z;
<a name="l00110"></a>00110   pv[14]= y;
<a name="l00111"></a>00111   pv[16]= 3*z*z;
<a name="l00112"></a>00112   pv[17]= 2*z;
<a name="l00113"></a>00113   pv[18]= 1;
<a name="l00114"></a>00114   <span class="keywordflow">return</span> pv;
<a name="l00115"></a>00115 }
<a name="l00116"></a>00116 
<a name="l00117"></a>00117 <span class="comment">//convert the value of the polynomial</span>
<a name="l00118"></a>00118 <span class="keyword">static</span> <span class="keywordtype">double</span> pval(vcl_vector&lt;double&gt; <span class="keyword">const</span>&amp; pv, vcl_vector&lt;double&gt;<span class="keyword">const</span>&amp; coef)
<a name="l00119"></a>00119 {
<a name="l00120"></a>00120   <span class="keywordtype">double</span> sum = 0.0;
<a name="l00121"></a>00121   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> i = 0; i&lt;20; ++i)
<a name="l00122"></a>00122     sum += pv[i]*coef[i];
<a name="l00123"></a>00123   <span class="keywordflow">return</span> sum;
<a name="l00124"></a>00124 }
<a name="l00125"></a>00125 
<a name="l00126"></a>00126 <span class="comment">// Find an approximate projective camera that approximates a rational camera</span>
<a name="l00127"></a>00127 <span class="comment">// at the world center.</span>
<a name="l00128"></a>00128 <span class="keywordtype">bool</span> <a class="code" href="classvpgl__proj__camera__convert.html#a8da5d09167a5d35c7a8522804f569aac" title="Find a projective camera that best approximates the rational camera at the world center (lon (deg)...">vpgl_proj_camera_convert::</a>
<a name="l00129"></a><a class="code" href="classvpgl__proj__camera__convert.html#a8da5d09167a5d35c7a8522804f569aac">00129</a> <a class="code" href="classvpgl__proj__camera__convert.html#a8da5d09167a5d35c7a8522804f569aac" title="Find a projective camera that best approximates the rational camera at the world center (lon (deg)...">convert</a>( <a class="code" href="classvpgl__rational__camera.html">vpgl_rational_camera&lt;double&gt;</a> <span class="keyword">const</span>&amp; rat_cam,
<a name="l00130"></a>00130          <a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__3d.html">vgl_point_3d&lt;double&gt;</a> <span class="keyword">const</span>&amp; world_center,
<a name="l00131"></a>00131          <a class="code" href="classvpgl__proj__camera.html">vpgl_proj_camera&lt;double&gt;</a>&amp; camera)
<a name="l00132"></a>00132 {
<a name="l00133"></a>00133   <span class="keywordtype">double</span> x0 = world_center.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__3d.html#a1ad910614a911c7d322c086438d6441d">x</a>(), y0 = world_center.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__3d.html#a6fcfebd50c3f8570fafd49df0687feb2">y</a>(), z0 = world_center.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__3d.html#a477066fab00b63b2641305fb7e41fb62">z</a>();
<a name="l00134"></a>00134   <span class="comment">//normalized world center</span>
<a name="l00135"></a>00135   <span class="keywordtype">double</span> nx0 =
<a name="l00136"></a>00136     rat_cam.<a class="code" href="classvpgl__rational__camera.html#afa3c213ae12b61b50b814d29f43e5ab6" title="get a specific scale_offset.">scl_off</a>(<a class="code" href="classvpgl__rational__camera.html">vpgl_rational_camera&lt;double&gt;::X_INDX</a>).normalize(x0);
<a name="l00137"></a>00137   <span class="keywordtype">double</span> ny0 =
<a name="l00138"></a>00138     rat_cam.<a class="code" href="classvpgl__rational__camera.html#afa3c213ae12b61b50b814d29f43e5ab6" title="get a specific scale_offset.">scl_off</a>(<a class="code" href="classvpgl__rational__camera.html">vpgl_rational_camera&lt;double&gt;::Y_INDX</a>).normalize(y0);
<a name="l00139"></a>00139   <span class="keywordtype">double</span> nz0 =
<a name="l00140"></a>00140     rat_cam.<a class="code" href="classvpgl__rational__camera.html#afa3c213ae12b61b50b814d29f43e5ab6" title="get a specific scale_offset.">scl_off</a>(<a class="code" href="classvpgl__rational__camera.html">vpgl_rational_camera&lt;double&gt;::Z_INDX</a>).normalize(z0);
<a name="l00141"></a>00141 
<a name="l00142"></a>00142   <span class="comment">// get the rational coefficients</span>
<a name="l00143"></a>00143   vcl_vector&lt;vcl_vector&lt;double&gt; &gt; coeffs = rat_cam.<a class="code" href="classvpgl__rational__camera.html#a2ef81c24b718412ecc4675b218b7aae5" title="get the rational polynomial coefficients in a vcl array.">coefficients</a>();
<a name="l00144"></a>00144   vcl_vector&lt;double&gt; neu_u = coeffs[0];
<a name="l00145"></a>00145   vcl_vector&lt;double&gt; den_u = coeffs[1];
<a name="l00146"></a>00146   vcl_vector&lt;double&gt; neu_v = coeffs[2];
<a name="l00147"></a>00147   vcl_vector&lt;double&gt; den_v = coeffs[3];
<a name="l00148"></a>00148 
<a name="l00149"></a>00149   <span class="comment">// normalize for numerical precision</span>
<a name="l00150"></a>00150   <span class="keywordtype">double</span> nmax_u = -vnl_numeric_traits&lt;double&gt;::maxval;
<a name="l00151"></a>00151   <span class="keywordtype">double</span> dmax_u  = nmax_u, nmax_v = nmax_u,dmax_v = nmax_u;
<a name="l00152"></a>00152   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> i = 0; i&lt;20; ++i)
<a name="l00153"></a>00153   {
<a name="l00154"></a>00154     <span class="keywordflow">if</span> (vcl_fabs(neu_u[i])&gt;nmax_u)
<a name="l00155"></a>00155       nmax_u=vcl_fabs(neu_u[i]);
<a name="l00156"></a>00156     <span class="keywordflow">if</span> (vcl_fabs(den_u[i])&gt;dmax_u)
<a name="l00157"></a>00157       dmax_u=vcl_fabs(den_u[i]);
<a name="l00158"></a>00158     <span class="keywordflow">if</span> (vcl_fabs(neu_v[i])&gt;nmax_v)
<a name="l00159"></a>00159       nmax_v=vcl_fabs(neu_v[i]);
<a name="l00160"></a>00160     <span class="keywordflow">if</span> (vcl_fabs(den_v[i])&gt;dmax_v)
<a name="l00161"></a>00161       dmax_v=vcl_fabs(den_v[i]);
<a name="l00162"></a>00162   }
<a name="l00163"></a>00163   <span class="comment">// Normalize polys so that ratio of numerator and denominator is unchanged</span>
<a name="l00164"></a>00164   <span class="keywordtype">double</span> norm_u = nmax_u, norm_v = nmax_v;
<a name="l00165"></a>00165   <span class="keywordflow">if</span> (norm_u&lt;dmax_u) norm_u = dmax_u;
<a name="l00166"></a>00166   <span class="keywordflow">if</span> (norm_v&lt;dmax_v) norm_v = dmax_v;
<a name="l00167"></a>00167   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> i = 0; i&lt;20; ++i)
<a name="l00168"></a>00168   {
<a name="l00169"></a>00169     neu_u[i] /= norm_u; den_u[i] /= norm_u;
<a name="l00170"></a>00170     neu_v[i] /= norm_v; den_v[i] /= norm_v;
<a name="l00171"></a>00171   }
<a name="l00172"></a>00172 
<a name="l00173"></a>00173   <span class="comment">// Convert linear approximations to each poly</span>
<a name="l00174"></a>00174   <span class="comment">//lin_p(x, y, z)=p(0,0,0) + (dp/dx)(x-nx0) + (dp/dy)(y-ny0) + (dp/dz)(z-nz0)</span>
<a name="l00175"></a>00175   vcl_vector&lt;double&gt; pv0 = pvector(nx0,ny0,nz0);
<a name="l00176"></a>00176   <span class="keywordtype">double</span> neu_u_0 = pval(pv0,neu_u), den_u_0 = pval(pv0,den_u);
<a name="l00177"></a>00177   <span class="keywordtype">double</span> neu_v_0 = pval(pv0,neu_v), den_v_0 = pval(pv0,den_v);
<a name="l00178"></a>00178   vcl_vector&lt;double&gt; pv_dx0 = power_vector_dx(nx0,ny0,nz0);
<a name="l00179"></a>00179   <span class="keywordtype">double</span> neu_u_dx0 = pval(pv_dx0,neu_u), den_u_dx0 = pval(pv_dx0,den_u);
<a name="l00180"></a>00180   <span class="keywordtype">double</span> neu_v_dx0 = pval(pv_dx0,neu_v), den_v_dx0 = pval(pv_dx0,den_v);
<a name="l00181"></a>00181   vcl_vector&lt;double&gt; pv_dy0 = power_vector_dy(nx0,ny0,nz0);
<a name="l00182"></a>00182   <span class="keywordtype">double</span> neu_u_dy0 = pval(pv_dy0,neu_u), den_u_dy0 = pval(pv_dy0,den_u);
<a name="l00183"></a>00183   <span class="keywordtype">double</span> neu_v_dy0 = pval(pv_dy0,neu_v), den_v_dy0 = pval(pv_dy0,den_v);
<a name="l00184"></a>00184   vcl_vector&lt;double&gt; pv_dz0 = power_vector_dz(nx0,ny0,nz0);
<a name="l00185"></a>00185   <span class="keywordtype">double</span> neu_u_dz0 = pval(pv_dz0,neu_u), den_u_dz0 = pval(pv_dz0,den_u);
<a name="l00186"></a>00186   <span class="keywordtype">double</span> neu_v_dz0 = pval(pv_dz0,neu_v), den_v_dz0 = pval(pv_dz0,den_v);
<a name="l00187"></a>00187 
<a name="l00188"></a>00188   <span class="comment">//Construct the matrix to convert the center of projection</span>
<a name="l00189"></a>00189   <a class="codeRef" doxygen="core_vnl.tag:../../../core/vnl/html/" href="../../../core/vnl/html/classvnl__matrix.html">vnl_matrix&lt;double&gt;</a> C(4,4);
<a name="l00190"></a>00190   C[0][0]=neu_u_dx0; C[0][1]=neu_u_dy0; C[0][2]=neu_u_dz0; C[0][3]=neu_u_0;
<a name="l00191"></a>00191   C[1][0]=den_u_dx0; C[1][1]=den_u_dy0; C[1][2]=den_u_dz0; C[1][3]=den_u_0;
<a name="l00192"></a>00192   C[2][0]=neu_v_dx0; C[2][1]=neu_v_dy0; C[2][2]=neu_v_dz0; C[2][3]=neu_v_0;
<a name="l00193"></a>00193   C[3][0]=den_v_dx0; C[3][1]=den_v_dy0; C[3][2]=den_v_dz0; C[3][3]=den_v_0;
<a name="l00194"></a>00194 
<a name="l00195"></a>00195   <a class="codeRef" doxygen="core_vnl.tag:../../../core/vnl/html/" href="../../../core/vnl/html/classvnl__svd.html">vnl_svd&lt;double&gt;</a> svd(C);
<a name="l00196"></a>00196   <a class="codeRef" doxygen="core_vnl.tag:../../../core/vnl/html/" href="../../../core/vnl/html/classvnl__vector.html">vnl_vector&lt;double&gt;</a> nv = svd.<a class="codeRef" doxygen="core_vnl.tag:../../../core/vnl/html/" href="../../../core/vnl/html/classvnl__svd.html#a52518dc5059d83519f396452b60fa1ad">nullvector</a>();
<a name="l00197"></a>00197   <span class="comment">//assume not at infinity</span>
<a name="l00198"></a>00198   nv/=nv[3];
<a name="l00199"></a>00199 <span class="preprocessor">#if 1</span>
<a name="l00200"></a>00200 <span class="preprocessor"></span>  vcl_cout &lt;&lt; <span class="stringliteral">&quot;Center of projection\n&quot;</span> &lt;&lt; nv &lt;&lt; <span class="charliteral">&#39;\n&#39;</span>
<a name="l00201"></a>00201            &lt;&lt; <span class="stringliteral">&quot;Residual\n&quot;</span> &lt;&lt; C*nv &lt;&lt; <span class="charliteral">&#39;\n&#39;</span>;
<a name="l00202"></a>00202 <span class="preprocessor">#endif</span>
<a name="l00203"></a>00203 <span class="preprocessor"></span>  <span class="comment">//Normalize with respect to the principal plane normal (principal ray)</span>
<a name="l00204"></a>00204   <span class="keywordtype">double</span> ndu = vcl_sqrt(den_u_dx0*den_u_dx0 + den_u_dy0*den_u_dy0 +
<a name="l00205"></a>00205                         den_u_dz0*den_u_dz0);
<a name="l00206"></a>00206   <span class="keywordtype">double</span> ndv = vcl_sqrt(den_v_dx0*den_v_dx0 + den_v_dy0*den_v_dy0 +
<a name="l00207"></a>00207                         den_v_dz0*den_v_dz0);
<a name="l00208"></a>00208 
<a name="l00209"></a>00209   <span class="comment">// determine if the projection is affine</span>
<a name="l00210"></a>00210   <span class="keywordflow">if</span> (ndu/vcl_fabs(den_u_0)&lt;1.0e-10||ndv/vcl_fabs(den_v_0)&lt;1.0e-10)
<a name="l00211"></a>00211   {
<a name="l00212"></a>00212     vcl_cout &lt;&lt; <span class="stringliteral">&quot;Camera is nearly affine - approximation not implemented!\n&quot;</span>;
<a name="l00213"></a>00213     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00214"></a>00214   }
<a name="l00215"></a>00215   <span class="comment">//Construct M by joined scale factor vector</span>
<a name="l00216"></a>00216   vnl_matrix_fixed&lt;double, 3, 3&gt; M;
<a name="l00217"></a>00217   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> i = 0; i&lt;3; ++i)
<a name="l00218"></a>00218   {
<a name="l00219"></a>00219     M[0][i]=C[0][i]/ndu;
<a name="l00220"></a>00220     M[1][i]=C[2][i]/ndv;
<a name="l00221"></a>00221     M[2][i]=(C[1][i]/ndu + C[3][i]/ndv)/2;
<a name="l00222"></a>00222   }
<a name="l00223"></a>00223 <span class="preprocessor">#if 1</span>
<a name="l00224"></a>00224 <span class="preprocessor"></span>  vcl_cout &lt;&lt; <span class="stringliteral">&quot;M matrix\n&quot;</span> &lt;&lt; M &lt;&lt; <span class="charliteral">&#39;\n&#39;</span>;
<a name="l00225"></a>00225 
<a name="l00226"></a>00226   vnl_matrix_fixed&lt;double,3,3&gt; Mf;
<a name="l00227"></a>00227   <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> i = 0; i &lt; 3; ++i )
<a name="l00228"></a>00228     <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> j = 0; j &lt; 3; ++j )
<a name="l00229"></a>00229       Mf(i,j) = M(2-j,2-i);
<a name="l00230"></a>00230   <a class="codeRef" doxygen="core_vnl.tag:../../../core/vnl/html/" href="../../../core/vnl/html/classvnl__qr.html">vnl_qr&lt;double&gt;</a> QR( Mf.as_ref() );
<a name="l00231"></a>00231   vnl_matrix_fixed&lt;double,3,3&gt; q,r,Qf,Rf, uq,ur;
<a name="l00232"></a>00232   q = QR.<a class="codeRef" doxygen="core_vnl.tag:../../../core/vnl/html/" href="../../../core/vnl/html/classvnl__qr.html#aa431a82b37aafa19e9aa8d9228c5243d">Q</a>();
<a name="l00233"></a>00233   r = QR.<a class="codeRef" doxygen="core_vnl.tag:../../../core/vnl/html/" href="../../../core/vnl/html/classvnl__qr.html#aed8d5789e633f9901c71fa92721911c6">R</a>();
<a name="l00234"></a>00234   <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> i = 0; i &lt; 3; ++i ) {
<a name="l00235"></a>00235     <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> j = 0; j &lt; 3; ++j ) {
<a name="l00236"></a>00236       Qf(i,j) = q(2-j,2-i);
<a name="l00237"></a>00237       Rf(i,j) = r(2-j,2-i);
<a name="l00238"></a>00238     }
<a name="l00239"></a>00239   }
<a name="l00240"></a>00240   vcl_cout &lt;&lt; <span class="stringliteral">&quot;Flipped Rotation\n&quot;</span> &lt;&lt; Qf &lt;&lt; <span class="charliteral">&#39;\n&#39;</span>
<a name="l00241"></a>00241            &lt;&lt; <span class="stringliteral">&quot;Flipped Upper Triangular\n&quot;</span> &lt;&lt; Rf &lt;&lt; <span class="charliteral">&#39;\n&#39;</span>;
<a name="l00242"></a>00242   <a class="codeRef" doxygen="core_vnl.tag:../../../core/vnl/html/" href="../../../core/vnl/html/classvnl__qr.html">vnl_qr&lt;double&gt;</a> uqr(M.as_ref());
<a name="l00243"></a>00243   uq = uqr.<a class="codeRef" doxygen="core_vnl.tag:../../../core/vnl/html/" href="../../../core/vnl/html/classvnl__qr.html#aa431a82b37aafa19e9aa8d9228c5243d">Q</a>();
<a name="l00244"></a>00244   ur = uqr.<a class="codeRef" doxygen="core_vnl.tag:../../../core/vnl/html/" href="../../../core/vnl/html/classvnl__qr.html#aed8d5789e633f9901c71fa92721911c6">R</a>();
<a name="l00245"></a>00245   vcl_cout &lt;&lt; <span class="stringliteral">&quot;UnFlipped Rotation\n&quot;</span> &lt;&lt; uq &lt;&lt; <span class="charliteral">&#39;\n&#39;</span>
<a name="l00246"></a>00246            &lt;&lt; <span class="stringliteral">&quot;UnFlipped Upper Triangular\n&quot;</span> &lt;&lt; ur &lt;&lt; <span class="charliteral">&#39;\n&#39;</span>
<a name="l00247"></a>00247            &lt;&lt; <span class="stringliteral">&quot;Det uq &quot;</span> &lt;&lt; vnl_det&lt;double&gt;(uq) &lt;&lt; <span class="charliteral">&#39;\n&#39;</span>;
<a name="l00248"></a>00248   <span class="comment">//Normalized denominators</span>
<a name="l00249"></a>00249   <a class="codeRef" doxygen="core_vnl.tag:../../../core/vnl/html/" href="../../../core/vnl/html/classvnl__vector.html">vnl_vector&lt;double&gt;</a> c1(3), c3(3);
<a name="l00250"></a>00250   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> i = 0; i&lt;3; ++i) {
<a name="l00251"></a>00251     c1[i]=C[1][i]/ndu;
<a name="l00252"></a>00252     c3[i]=C[3][i]/ndv;
<a name="l00253"></a>00253   }
<a name="l00254"></a>00254 
<a name="l00255"></a>00255   vcl_cout &lt;&lt; <span class="stringliteral">&quot;Denominators\n&quot;</span>
<a name="l00256"></a>00256            &lt;&lt; <span class="stringliteral">&quot;C1 &quot;</span> &lt;&lt; c1
<a name="l00257"></a>00257            &lt;&lt; <span class="stringliteral">&quot;C3 &quot;</span> &lt;&lt; c3;
<a name="l00258"></a>00258 <span class="preprocessor">#endif</span>
<a name="l00259"></a>00259 <span class="preprocessor"></span>  <span class="comment">//convert p3 the fourth column of the projection matrix</span>
<a name="l00260"></a>00260   <a class="codeRef" doxygen="core_vnl.tag:../../../core/vnl/html/" href="../../../core/vnl/html/classvnl__vector__fixed.html">vnl_vector_fixed&lt;double, 3&gt;</a> c;
<a name="l00261"></a>00261   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> i = 0; i&lt;3; ++i)
<a name="l00262"></a>00262     c[i]=nv[i];
<a name="l00263"></a>00263   <a class="codeRef" doxygen="core_vnl.tag:../../../core/vnl/html/" href="../../../core/vnl/html/classvnl__vector__fixed.html">vnl_vector_fixed&lt;double, 3&gt;</a> p3 = -M*c;
<a name="l00264"></a>00264   <span class="comment">//Form the full projection matrix</span>
<a name="l00265"></a>00265   vnl_matrix_fixed&lt;double, 3, 4&gt; pmatrix;
<a name="l00266"></a>00266   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> r = 0; r&lt;3; ++r)
<a name="l00267"></a>00267     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> c = 0; c&lt;3; ++c)
<a name="l00268"></a>00268       pmatrix[r][c] = M[r][c];
<a name="l00269"></a>00269   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> r = 0; r&lt;3; ++r)
<a name="l00270"></a>00270     pmatrix[r][3] = p3[r];
<a name="l00271"></a>00271   <span class="comment">//account for the image scale and offsets</span>
<a name="l00272"></a>00272   <span class="keywordtype">double</span> uscale = rat_cam.<a class="code" href="classvpgl__rational__camera.html#a9ef2e185dcae658e081e3372486de6d0" title="get a specific scale value.">scale</a>(<a class="code" href="classvpgl__rational__camera.html">vpgl_rational_camera&lt;double&gt;::U_INDX</a>);
<a name="l00273"></a>00273   <span class="keywordtype">double</span> uoff = rat_cam.<a class="code" href="classvpgl__rational__camera.html#aaa6a9ba6d813e18314314e3fd8a04f85" title="get a specific offset value.">offset</a>(<a class="code" href="classvpgl__rational__camera.html">vpgl_rational_camera&lt;double&gt;::U_INDX</a>);
<a name="l00274"></a>00274   <span class="keywordtype">double</span> vscale = rat_cam.<a class="code" href="classvpgl__rational__camera.html#a9ef2e185dcae658e081e3372486de6d0" title="get a specific scale value.">scale</a>(<a class="code" href="classvpgl__rational__camera.html">vpgl_rational_camera&lt;double&gt;::V_INDX</a>);
<a name="l00275"></a>00275   <span class="keywordtype">double</span> voff = rat_cam.<a class="code" href="classvpgl__rational__camera.html#aaa6a9ba6d813e18314314e3fd8a04f85" title="get a specific offset value.">offset</a>(<a class="code" href="classvpgl__rational__camera.html">vpgl_rational_camera&lt;double&gt;::V_INDX</a>);
<a name="l00276"></a>00276   vnl_matrix_fixed&lt;double, 3, 3&gt; Kr;
<a name="l00277"></a>00277   Kr.fill(0.0);
<a name="l00278"></a>00278   Kr[0][0]=uscale;   Kr[0][2]=uoff;
<a name="l00279"></a>00279   Kr[1][1]=vscale;   Kr[1][2]=voff;
<a name="l00280"></a>00280   Kr[2][2]=1.0;
<a name="l00281"></a>00281 <span class="preprocessor">#if 1</span>
<a name="l00282"></a>00282 <span class="preprocessor"></span>  vcl_cout &lt;&lt; <span class="stringliteral">&quot;Kr\n&quot;</span> &lt;&lt; Kr &lt;&lt; <span class="charliteral">&#39;\n&#39;</span>;
<a name="l00283"></a>00283   vnl_matrix_fixed&lt;double,3,3&gt; KRf, KR=Kr*uq;
<a name="l00284"></a>00284   <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> i = 0; i &lt; 3; ++i )
<a name="l00285"></a>00285     <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> j = 0; j &lt; 3; ++j )
<a name="l00286"></a>00286       KRf(i,j) = KR(2-j,2-i);
<a name="l00287"></a>00287   <a class="codeRef" doxygen="core_vnl.tag:../../../core/vnl/html/" href="../../../core/vnl/html/classvnl__qr.html">vnl_qr&lt;double&gt;</a> krQR( KRf.as_ref() );
<a name="l00288"></a>00288   vnl_matrix_fixed&lt;double,3,3&gt; krq,krr,krQf,krRf;
<a name="l00289"></a>00289   krq = krQR.<a class="codeRef" doxygen="core_vnl.tag:../../../core/vnl/html/" href="../../../core/vnl/html/classvnl__qr.html#aa431a82b37aafa19e9aa8d9228c5243d">Q</a>();
<a name="l00290"></a>00290   krr = krQR.<a class="codeRef" doxygen="core_vnl.tag:../../../core/vnl/html/" href="../../../core/vnl/html/classvnl__qr.html#aed8d5789e633f9901c71fa92721911c6">R</a>();
<a name="l00291"></a>00291   <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> i = 0; i &lt; 3; ++i ) {
<a name="l00292"></a>00292     <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> j = 0; j &lt; 3; ++j ) {
<a name="l00293"></a>00293       krQf(i,j) = krq(2-j,2-i);
<a name="l00294"></a>00294       krRf(i,j) = krr(2-j,2-i);
<a name="l00295"></a>00295     }
<a name="l00296"></a>00296   }
<a name="l00297"></a>00297   vcl_cout &lt;&lt; <span class="stringliteral">&quot;Flipped Rotation (KR)\n&quot;</span> &lt;&lt; krQf &lt;&lt; <span class="charliteral">&#39;\n&#39;</span>
<a name="l00298"></a>00298            &lt;&lt; <span class="stringliteral">&quot;Flipped Upper Triangular (KR)\n&quot;</span> &lt;&lt; krRf &lt;&lt; <span class="charliteral">&#39;\n&#39;</span>;
<a name="l00299"></a>00299 
<a name="l00300"></a>00300   <span class="keywordtype">int</span> r0pos = krRf(0,0) &gt; 0 ? 1 : -1;
<a name="l00301"></a>00301   <span class="keywordtype">int</span> r1pos = krRf(1,1) &gt; 0 ? 1 : -1;
<a name="l00302"></a>00302   <span class="keywordtype">int</span> r2pos = krRf(2,2) &gt; 0 ? 1 : -1;
<a name="l00303"></a>00303   <span class="keywordtype">int</span> diag[3] = { r0pos, r1pos, r2pos };
<a name="l00304"></a>00304   vnl_matrix_fixed&lt;double,3,3&gt; K1,R1;
<a name="l00305"></a>00305   <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> i = 0; i &lt; 3; ++i ) {
<a name="l00306"></a>00306     <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> j = 0; j &lt; 3; ++j ) {
<a name="l00307"></a>00307       K1(i,j) = diag[j]*krRf(i,j);
<a name="l00308"></a>00308       R1(i,j) = diag[i]*krQf(i,j);
<a name="l00309"></a>00309     }
<a name="l00310"></a>00310   }
<a name="l00311"></a>00311   K1 = K1/K1(2,2);
<a name="l00312"></a>00312   vcl_cout &lt;&lt; <span class="stringliteral">&quot;K1\n&quot;</span> &lt;&lt; K1 &lt;&lt;<span class="charliteral">&#39;\n&#39;</span>
<a name="l00313"></a>00313            &lt;&lt; <span class="stringliteral">&quot;R1\n&quot;</span> &lt;&lt; R1 &lt;&lt; <span class="charliteral">&#39;\n&#39;</span>
<a name="l00314"></a>00314            &lt;&lt; <span class="stringliteral">&quot;Det R1 &quot;</span> &lt;&lt; vnl_det&lt;double&gt;(R1) &lt;&lt; <span class="charliteral">&#39;\n&#39;</span>;
<a name="l00315"></a>00315 <span class="preprocessor">#endif</span>
<a name="l00316"></a>00316 <span class="preprocessor"></span>
<a name="l00317"></a>00317   <span class="comment">//Need to offset x0, y0 and z0 as well.</span>
<a name="l00318"></a>00318   vnl_matrix_fixed&lt;double, 4, 4&gt; T;
<a name="l00319"></a>00319   T.fill(0.0);
<a name="l00320"></a>00320   T[0][0]=1.0; T[1][1]=1.0; T[2][2]=1.0; T[3][3]=1.0;
<a name="l00321"></a>00321   T[0][3] = -nx0; T[1][3]= -ny0; T[2][3]=-nz0;
<a name="l00322"></a>00322   pmatrix = Kr*pmatrix*T;
<a name="l00323"></a>00323 <span class="preprocessor">#if 0</span>
<a name="l00324"></a>00324 <span class="preprocessor"></span>  vcl_cout &lt;&lt; <span class="stringliteral">&quot;P Matrix\n&quot;</span> &lt;&lt; pmatrix &lt;&lt; <span class="charliteral">&#39;\n&#39;</span>;
<a name="l00325"></a>00325 <span class="preprocessor">#endif</span>
<a name="l00326"></a>00326 <span class="preprocessor"></span>  camera.<a class="code" href="classvpgl__proj__camera.html#aba0e291507ac9f7ff75e12cb06c5fd33" title="Setters mirror the constructors and return true if the setting was successful.">set_matrix</a>(pmatrix);
<a name="l00327"></a>00327   <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00328"></a>00328 }
<a name="l00329"></a>00329 
<a name="l00330"></a>00330 <span class="comment">//:obtain a scaling transformation to normalize world geographic coordinates</span>
<a name="l00331"></a>00331 <span class="comment">//The resulting values will be on the range [-1, 1]</span>
<a name="l00332"></a>00332 <span class="comment">//The transform is valid anywhere the rational camera is valid</span>
<a name="l00333"></a>00333 <a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__h__matrix__3d.html">vgl_h_matrix_3d&lt;double&gt;</a>
<a name="l00334"></a><a class="code" href="classvpgl__proj__camera__convert.html#a1113c2768510f0ff7bf519c8ae91613d">00334</a> <a class="code" href="classvpgl__proj__camera__convert.html#a1113c2768510f0ff7bf519c8ae91613d" title="An auxiliary matrix that transforms (normalizes) world points prior to projection by a projective cam...">vpgl_proj_camera_convert::norm_trans</a>(<a class="code" href="classvpgl__rational__camera.html">vpgl_rational_camera&lt;double&gt;</a> <span class="keyword">const</span>&amp; rat_cam)
<a name="l00335"></a>00335 {
<a name="l00336"></a>00336   <span class="keywordtype">double</span> xscale = rat_cam.<a class="code" href="classvpgl__rational__camera.html#a9ef2e185dcae658e081e3372486de6d0" title="get a specific scale value.">scale</a>(<a class="code" href="classvpgl__rational__camera.html">vpgl_rational_camera&lt;double&gt;::X_INDX</a>);
<a name="l00337"></a>00337   <span class="keywordtype">double</span> xoff = rat_cam.<a class="code" href="classvpgl__rational__camera.html#aaa6a9ba6d813e18314314e3fd8a04f85" title="get a specific offset value.">offset</a>(<a class="code" href="classvpgl__rational__camera.html">vpgl_rational_camera&lt;double&gt;::X_INDX</a>);
<a name="l00338"></a>00338   <span class="keywordtype">double</span> yscale = rat_cam.<a class="code" href="classvpgl__rational__camera.html#a9ef2e185dcae658e081e3372486de6d0" title="get a specific scale value.">scale</a>(<a class="code" href="classvpgl__rational__camera.html">vpgl_rational_camera&lt;double&gt;::Y_INDX</a>);
<a name="l00339"></a>00339   <span class="keywordtype">double</span> yoff = rat_cam.<a class="code" href="classvpgl__rational__camera.html#aaa6a9ba6d813e18314314e3fd8a04f85" title="get a specific offset value.">offset</a>(<a class="code" href="classvpgl__rational__camera.html">vpgl_rational_camera&lt;double&gt;::Y_INDX</a>);
<a name="l00340"></a>00340   <span class="keywordtype">double</span> zscale = rat_cam.<a class="code" href="classvpgl__rational__camera.html#a9ef2e185dcae658e081e3372486de6d0" title="get a specific scale value.">scale</a>(<a class="code" href="classvpgl__rational__camera.html">vpgl_rational_camera&lt;double&gt;::Z_INDX</a>);
<a name="l00341"></a>00341   <span class="keywordtype">double</span> zoff = rat_cam.<a class="code" href="classvpgl__rational__camera.html#aaa6a9ba6d813e18314314e3fd8a04f85" title="get a specific offset value.">offset</a>(<a class="code" href="classvpgl__rational__camera.html">vpgl_rational_camera&lt;double&gt;::Z_INDX</a>);
<a name="l00342"></a>00342   <a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__h__matrix__3d.html">vgl_h_matrix_3d&lt;double&gt;</a> T;
<a name="l00343"></a>00343   T.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__h__matrix__3d.html#a49a1abaf04b491809448c2d7464be473">set_identity</a>();
<a name="l00344"></a>00344   T.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__h__matrix__3d.html#a10e0d23912489e39105f48373061f2c4">set</a>(0,0,1/xscale); T.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__h__matrix__3d.html#a10e0d23912489e39105f48373061f2c4">set</a>(1,1,1/yscale); T.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__h__matrix__3d.html#a10e0d23912489e39105f48373061f2c4">set</a>(2,2,1/zscale);
<a name="l00345"></a>00345   T.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__h__matrix__3d.html#a10e0d23912489e39105f48373061f2c4">set</a>(0,3, -xoff/xscale);   T.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__h__matrix__3d.html#a10e0d23912489e39105f48373061f2c4">set</a>(1,3, -yoff/yscale);
<a name="l00346"></a>00346   T.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__h__matrix__3d.html#a10e0d23912489e39105f48373061f2c4">set</a>(2,3, -zoff/zscale);
<a name="l00347"></a>00347   <span class="keywordflow">return</span> T;
<a name="l00348"></a>00348 }
<a name="l00349"></a>00349 
<a name="l00350"></a>00350 
<a name="l00351"></a>00351 <span class="keywordtype">bool</span> <a class="code" href="classvpgl__perspective__camera__convert.html#a11d7d97ecb8a7b9f911022abe6b12154" title="Convert from a rational camera.">vpgl_perspective_camera_convert::</a>
<a name="l00352"></a><a class="code" href="classvpgl__perspective__camera__convert.html#a11d7d97ecb8a7b9f911022abe6b12154">00352</a> <a class="code" href="classvpgl__perspective__camera__convert.html#a11d7d97ecb8a7b9f911022abe6b12154" title="Convert from a rational camera.">convert</a>( <a class="code" href="classvpgl__rational__camera.html">vpgl_rational_camera&lt;double&gt;</a> <span class="keyword">const</span>&amp; rat_cam,
<a name="l00353"></a>00353          <a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__box__3d.html">vgl_box_3d&lt;double&gt;</a> <span class="keyword">const</span>&amp; approximation_volume,
<a name="l00354"></a>00354          <a class="code" href="classvpgl__perspective__camera.html" title="This class implements the perspective camera class as described in Hartley &amp; Zisserman as a finite ca...">vpgl_perspective_camera&lt;double&gt;</a>&amp; camera,
<a name="l00355"></a>00355          <a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__h__matrix__3d.html">vgl_h_matrix_3d&lt;double&gt;</a>&amp; norm_trans)
<a name="l00356"></a>00356 {
<a name="l00357"></a>00357   <a class="code" href="classvpgl__scale__offset.html">vpgl_scale_offset&lt;double&gt;</a> sou =
<a name="l00358"></a>00358     rat_cam.<a class="code" href="classvpgl__rational__camera.html#afa3c213ae12b61b50b814d29f43e5ab6" title="get a specific scale_offset.">scl_off</a>(<a class="code" href="classvpgl__rational__camera.html">vpgl_rational_camera&lt;double&gt;::U_INDX</a>);
<a name="l00359"></a>00359   <a class="code" href="classvpgl__scale__offset.html">vpgl_scale_offset&lt;double&gt;</a> sov =
<a name="l00360"></a>00360     rat_cam.<a class="code" href="classvpgl__rational__camera.html#afa3c213ae12b61b50b814d29f43e5ab6" title="get a specific scale_offset.">scl_off</a>(<a class="code" href="classvpgl__rational__camera.html">vpgl_rational_camera&lt;double&gt;::V_INDX</a>);
<a name="l00361"></a>00361   <a class="code" href="classvpgl__scale__offset.html">vpgl_scale_offset&lt;double&gt;</a> sox =
<a name="l00362"></a>00362     rat_cam.<a class="code" href="classvpgl__rational__camera.html#afa3c213ae12b61b50b814d29f43e5ab6" title="get a specific scale_offset.">scl_off</a>(<a class="code" href="classvpgl__rational__camera.html">vpgl_rational_camera&lt;double&gt;::X_INDX</a>);
<a name="l00363"></a>00363   <a class="code" href="classvpgl__scale__offset.html">vpgl_scale_offset&lt;double&gt;</a> soy =
<a name="l00364"></a>00364     rat_cam.<a class="code" href="classvpgl__rational__camera.html#afa3c213ae12b61b50b814d29f43e5ab6" title="get a specific scale_offset.">scl_off</a>(<a class="code" href="classvpgl__rational__camera.html">vpgl_rational_camera&lt;double&gt;::Y_INDX</a>);
<a name="l00365"></a>00365   <a class="code" href="classvpgl__scale__offset.html">vpgl_scale_offset&lt;double&gt;</a> soz =
<a name="l00366"></a>00366     rat_cam.<a class="code" href="classvpgl__rational__camera.html#afa3c213ae12b61b50b814d29f43e5ab6" title="get a specific scale_offset.">scl_off</a>(<a class="code" href="classvpgl__rational__camera.html">vpgl_rational_camera&lt;double&gt;::Z_INDX</a>);
<a name="l00367"></a>00367   <span class="keywordtype">unsigned</span> ni = <span class="keyword">static_cast&lt;</span><span class="keywordtype">unsigned</span><span class="keyword">&gt;</span>(2*sou.<a class="code" href="classvpgl__scale__offset.html#aac5d47af86f9e0c846f23091a45ab27c">scale</a>());<span class="comment">//# image columns</span>
<a name="l00368"></a>00368   <span class="keywordtype">unsigned</span> nj = <span class="keyword">static_cast&lt;</span><span class="keywordtype">unsigned</span><span class="keyword">&gt;</span>(2*sov.<a class="code" href="classvpgl__scale__offset.html#aac5d47af86f9e0c846f23091a45ab27c">scale</a>());<span class="comment">//# image rows</span>
<a name="l00369"></a>00369   norm_trans.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__h__matrix__3d.html#a49a1abaf04b491809448c2d7464be473">set_identity</a>();
<a name="l00370"></a>00370   norm_trans.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__h__matrix__3d.html#a10e0d23912489e39105f48373061f2c4">set</a>(0,0,1/sox.<a class="code" href="classvpgl__scale__offset.html#aac5d47af86f9e0c846f23091a45ab27c">scale</a>()); norm_trans.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__h__matrix__3d.html#a10e0d23912489e39105f48373061f2c4">set</a>(1,1,1/soy.<a class="code" href="classvpgl__scale__offset.html#aac5d47af86f9e0c846f23091a45ab27c">scale</a>());
<a name="l00371"></a>00371   norm_trans.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__h__matrix__3d.html#a10e0d23912489e39105f48373061f2c4">set</a>(2,2,1/soz.<a class="code" href="classvpgl__scale__offset.html#aac5d47af86f9e0c846f23091a45ab27c">scale</a>());
<a name="l00372"></a>00372   norm_trans.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__h__matrix__3d.html#a10e0d23912489e39105f48373061f2c4">set</a>(0,3, -sox.<a class="code" href="classvpgl__scale__offset.html#a72ef4752915ec2ca39379aa93b8f3cb3">offset</a>()/sox.<a class="code" href="classvpgl__scale__offset.html#aac5d47af86f9e0c846f23091a45ab27c">scale</a>());
<a name="l00373"></a>00373   norm_trans.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__h__matrix__3d.html#a10e0d23912489e39105f48373061f2c4">set</a>(1,3, -soy.<a class="code" href="classvpgl__scale__offset.html#a72ef4752915ec2ca39379aa93b8f3cb3">offset</a>()/soy.<a class="code" href="classvpgl__scale__offset.html#aac5d47af86f9e0c846f23091a45ab27c">scale</a>());
<a name="l00374"></a>00374   norm_trans.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__h__matrix__3d.html#a10e0d23912489e39105f48373061f2c4">set</a>(2,3, -soz.<a class="code" href="classvpgl__scale__offset.html#a72ef4752915ec2ca39379aa93b8f3cb3">offset</a>()/soz.<a class="code" href="classvpgl__scale__offset.html#aac5d47af86f9e0c846f23091a45ab27c">scale</a>());
<a name="l00375"></a>00375 
<a name="l00376"></a>00376   <a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__3d.html">vgl_point_3d&lt;double&gt;</a> minp = approximation_volume.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__box__3d.html#a30469701fd79722e5302451ad3684b14">min_point</a>();
<a name="l00377"></a>00377   <a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__3d.html">vgl_point_3d&lt;double&gt;</a> maxp = approximation_volume.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__box__3d.html#a75819f3087de7397c401c603b1a62495">max_point</a>();
<a name="l00378"></a>00378   <span class="keywordtype">double</span> xmin = minp.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__3d.html#a1ad910614a911c7d322c086438d6441d">x</a>(), ymin = minp.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__3d.html#a6fcfebd50c3f8570fafd49df0687feb2">y</a>(), zmin = minp.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__3d.html#a477066fab00b63b2641305fb7e41fb62">z</a>();
<a name="l00379"></a>00379   <span class="keywordtype">double</span> xrange = maxp.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__3d.html#a1ad910614a911c7d322c086438d6441d">x</a>()-xmin, yrange = maxp.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__3d.html#a6fcfebd50c3f8570fafd49df0687feb2">y</a>()-ymin,
<a name="l00380"></a>00380     zrange = maxp.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__3d.html#a477066fab00b63b2641305fb7e41fb62">z</a>()-zmin;
<a name="l00381"></a>00381   <span class="keywordflow">if</span> (xrange&lt;0||yrange&lt;0||zrange&lt;0)
<a name="l00382"></a>00382     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00383"></a>00383   <span class="comment">//Randomly generate points</span>
<a name="l00384"></a>00384   <span class="keywordtype">unsigned</span> n = 100;
<a name="l00385"></a>00385   vcl_vector&lt;vgl_point_3d&lt;double&gt; &gt; world_pts;
<a name="l00386"></a>00386   <span class="keywordtype">unsigned</span> count = 0, ntrials = 0;
<a name="l00387"></a>00387   <span class="keywordflow">while</span> (count&lt;n)
<a name="l00388"></a>00388   {
<a name="l00389"></a>00389     ntrials++;
<a name="l00390"></a>00390     <span class="keywordtype">double</span> rx = xrange*(vcl_rand()/(RAND_MAX+1.0));
<a name="l00391"></a>00391     <span class="keywordtype">double</span> ry = yrange*(vcl_rand()/(RAND_MAX+1.0));
<a name="l00392"></a>00392     <span class="keywordtype">double</span> rz = zrange*(vcl_rand()/(RAND_MAX+1.0));
<a name="l00393"></a>00393     <a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__3d.html">vgl_point_3d&lt;double&gt;</a> wp(xmin+rx, ymin+ry, zmin+rz);
<a name="l00394"></a>00394     <a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__2d.html">vgl_point_2d&lt;double&gt;</a> ip = rat_cam.<a class="code" href="classvpgl__rational__camera.html#a5b712c1ea84ed7bcc07b556383da368a" title="The generic camera interface. u represents image column, v image row.">project</a>(wp);
<a name="l00395"></a>00395     <span class="keywordflow">if</span> (ip.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__2d.html#a3d0455536dcb130f284c3eeaba1ae960">x</a>()&lt;0||ip.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__2d.html#a3d0455536dcb130f284c3eeaba1ae960">x</a>()&gt;ni||ip.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__2d.html#a25dfe52017f7614103d028639125ff91">y</a>()&lt;0||ip.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__2d.html#a25dfe52017f7614103d028639125ff91">y</a>()&gt;nj)
<a name="l00396"></a>00396       <span class="keywordflow">continue</span>;
<a name="l00397"></a>00397     world_pts.push_back(wp);
<a name="l00398"></a>00398     count++;
<a name="l00399"></a>00399   }
<a name="l00400"></a>00400   vcl_cout &lt;&lt; <span class="stringliteral">&quot;Ntrials &quot;</span> &lt;&lt; ntrials &lt;&lt; <span class="charliteral">&#39;\n&#39;</span>;
<a name="l00401"></a>00401 
<a name="l00402"></a>00402   <span class="comment">//Normalize world and image points to the range [-1,1]</span>
<a name="l00403"></a>00403   vcl_vector&lt;vgl_point_3d&lt;double&gt; &gt; norm_world_pts;
<a name="l00404"></a>00404   vcl_vector&lt;vgl_point_2d&lt;double&gt; &gt; image_pts, norm_image_pts;
<a name="l00405"></a>00405   <span class="keywordtype">unsigned</span> N = world_pts.size();
<a name="l00406"></a>00406   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> i = 0; i&lt;N; ++i)
<a name="l00407"></a>00407   {
<a name="l00408"></a>00408     <a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__3d.html">vgl_point_3d&lt;double&gt;</a> wp = world_pts[i];
<a name="l00409"></a>00409     <a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__2d.html">vgl_point_2d&lt;double&gt;</a> ip = rat_cam.<a class="code" href="classvpgl__rational__camera.html#a5b712c1ea84ed7bcc07b556383da368a" title="The generic camera interface. u represents image column, v image row.">project</a>(wp);
<a name="l00410"></a>00410     image_pts.push_back(ip);
<a name="l00411"></a>00411     <a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__2d.html">vgl_point_2d&lt;double&gt;</a> nip(sou.<a class="code" href="classvpgl__scale__offset.html#a3173362f51c6caaabeabd34264e39773">normalize</a>(ip.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__2d.html#a3d0455536dcb130f284c3eeaba1ae960">x</a>()), sov.<a class="code" href="classvpgl__scale__offset.html#a3173362f51c6caaabeabd34264e39773">normalize</a>(ip.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__2d.html#a25dfe52017f7614103d028639125ff91">y</a>()));
<a name="l00412"></a>00412     norm_image_pts.push_back(nip);
<a name="l00413"></a>00413     <a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__3d.html">vgl_point_3d&lt;double&gt;</a> nwp(sox.<a class="code" href="classvpgl__scale__offset.html#a3173362f51c6caaabeabd34264e39773">normalize</a>(wp.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__3d.html#a1ad910614a911c7d322c086438d6441d">x</a>()),
<a name="l00414"></a>00414                              soy.<a class="code" href="classvpgl__scale__offset.html#a3173362f51c6caaabeabd34264e39773">normalize</a>(wp.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__3d.html#a6fcfebd50c3f8570fafd49df0687feb2">y</a>()),
<a name="l00415"></a>00415                              soz.<a class="code" href="classvpgl__scale__offset.html#a3173362f51c6caaabeabd34264e39773">normalize</a>(wp.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__3d.html#a477066fab00b63b2641305fb7e41fb62">z</a>()));
<a name="l00416"></a>00416     norm_world_pts.push_back(nwp);
<a name="l00417"></a>00417   }
<a name="l00418"></a>00418   <span class="comment">//Assume identity calibration matrix initially, since image point</span>
<a name="l00419"></a>00419   <span class="comment">//normalization remove any scale and offset from image coordinates</span>
<a name="l00420"></a>00420   vnl_matrix_fixed&lt;double, 3, 3&gt; kk;
<a name="l00421"></a>00421   kk.fill(0);
<a name="l00422"></a>00422   kk[0][0]= 1.0;
<a name="l00423"></a>00423   kk[1][1]= 1.0;
<a name="l00424"></a>00424   kk[2][2]=1.0;
<a name="l00425"></a>00425   <span class="comment">//Convert solution for rotation and translation and calibration matrix of</span>
<a name="l00426"></a>00426   <span class="comment">//the perspective camera</span>
<a name="l00427"></a>00427   <a class="code" href="classvpgl__calibration__matrix.html">vpgl_calibration_matrix&lt;double&gt;</a> K(kk);
<a name="l00428"></a>00428   <span class="keywordflow">if</span> (! <a class="code" href="classvpgl__perspective__camera__compute.html#a0fc4c1c3473826f3fe684b390261abdf" title="Compute from two sets of corresponding points.">vpgl_perspective_camera_compute::compute</a>(norm_image_pts,
<a name="l00429"></a>00429                                                  norm_world_pts,
<a name="l00430"></a>00430                                                  K, camera))
<a name="l00431"></a>00431     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00432"></a>00432   vcl_cout &lt;&lt; camera &lt;&lt; <span class="charliteral">&#39;\n&#39;</span>;
<a name="l00433"></a>00433   <span class="comment">//form the full camera by premultiplying by the image normalization</span>
<a name="l00434"></a>00434   <a class="code" href="classvpgl__calibration__matrix.html">vpgl_calibration_matrix&lt;double&gt;</a> Kmin = camera.get_calibration();
<a name="l00435"></a>00435   vnl_matrix_fixed&lt;double, 3, 3&gt; kk_min;
<a name="l00436"></a>00436   kk_min = Kmin.<a class="code" href="classvpgl__calibration__matrix.html#a955a3096bcf8f52d3510824d95d04b1d" title="Get the calibration matrix.">get_matrix</a>();
<a name="l00437"></a>00437   kk[0][0]= sou.<a class="code" href="classvpgl__scale__offset.html#aac5d47af86f9e0c846f23091a45ab27c">scale</a>(); kk[0][2]= sou.<a class="code" href="classvpgl__scale__offset.html#a72ef4752915ec2ca39379aa93b8f3cb3">offset</a>();
<a name="l00438"></a>00438   kk[1][1]= sov.<a class="code" href="classvpgl__scale__offset.html#aac5d47af86f9e0c846f23091a45ab27c">scale</a>(); kk[1][2]= sov.<a class="code" href="classvpgl__scale__offset.html#a72ef4752915ec2ca39379aa93b8f3cb3">offset</a>();
<a name="l00439"></a>00439   kk *= kk_min;
<a name="l00440"></a>00440   camera.set_calibration(kk);
<a name="l00441"></a>00441 
<a name="l00442"></a>00442   <span class="comment">//project the points approximated</span>
<a name="l00443"></a>00443   <span class="keywordtype">double</span> err_max = 0, err_min = 1e10;
<a name="l00444"></a>00444   <a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__3d.html">vgl_point_3d&lt;double&gt;</a> min_pt, max_pt;
<a name="l00445"></a>00445   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> i = 0; i&lt;N; ++i)
<a name="l00446"></a>00446   {
<a name="l00447"></a>00447     <a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__3d.html">vgl_point_3d&lt;double&gt;</a> nwp = norm_world_pts[i];
<a name="l00448"></a>00448     <span class="keywordtype">double</span> U ,V;
<a name="l00449"></a>00449     camera.project(nwp.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__3d.html#a1ad910614a911c7d322c086438d6441d">x</a>(), nwp.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__3d.html#a6fcfebd50c3f8570fafd49df0687feb2">y</a>(), nwp.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__3d.html#a477066fab00b63b2641305fb7e41fb62">z</a>(), U, V);
<a name="l00450"></a>00450     <a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__2d.html">vgl_point_2d&lt;double&gt;</a> ip = image_pts[i];
<a name="l00451"></a>00451     <span class="keywordtype">double</span> error = vcl_sqrt((ip.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__2d.html#a3d0455536dcb130f284c3eeaba1ae960">x</a>()-U)*(ip.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__2d.html#a3d0455536dcb130f284c3eeaba1ae960">x</a>()-U) + (ip.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__2d.html#a25dfe52017f7614103d028639125ff91">y</a>()-V)*(ip.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__2d.html#a25dfe52017f7614103d028639125ff91">y</a>()-V));
<a name="l00452"></a>00452     <span class="keywordflow">if</span> ( error &gt; err_max )
<a name="l00453"></a>00453     {
<a name="l00454"></a>00454       err_max = error;
<a name="l00455"></a>00455       max_pt = world_pts[i];
<a name="l00456"></a>00456     }
<a name="l00457"></a>00457     <span class="keywordflow">if</span> (error &lt; err_min)
<a name="l00458"></a>00458     {
<a name="l00459"></a>00459       err_min = error;
<a name="l00460"></a>00460       min_pt = world_pts[i];
<a name="l00461"></a>00461     }
<a name="l00462"></a>00462   }
<a name="l00463"></a>00463   vcl_cout &lt;&lt; <span class="stringliteral">&quot;Max Error = &quot;</span> &lt;&lt; err_max &lt;&lt; <span class="stringliteral">&quot; at &quot;</span> &lt;&lt; max_pt &lt;&lt; <span class="charliteral">&#39;\n&#39;</span>
<a name="l00464"></a>00464            &lt;&lt; <span class="stringliteral">&quot;Min Error = &quot;</span> &lt;&lt; err_min &lt;&lt; <span class="stringliteral">&quot; at &quot;</span> &lt;&lt; min_pt &lt;&lt; <span class="charliteral">&#39;\n&#39;</span>
<a name="l00465"></a>00465            &lt;&lt; <span class="stringliteral">&quot;final cam\n&quot;</span> &lt;&lt; camera &lt;&lt; <span class="charliteral">&#39;\n&#39;</span>;
<a name="l00466"></a>00466   <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00467"></a>00467 }
<a name="l00468"></a>00468 
<a name="l00469"></a>00469 
<a name="l00470"></a>00470 <span class="keywordtype">bool</span> <a class="code" href="classvpgl__perspective__camera__convert.html#aeef31a1f84c657b2f367634cee814d0d" title="Convert from rational camera using a local Euclidean coordinate system.">vpgl_perspective_camera_convert::</a>
<a name="l00471"></a><a class="code" href="classvpgl__perspective__camera__convert.html#aeef31a1f84c657b2f367634cee814d0d">00471</a> <a class="code" href="classvpgl__perspective__camera__convert.html#aeef31a1f84c657b2f367634cee814d0d" title="Convert from rational camera using a local Euclidean coordinate system.">convert_local</a>( <a class="code" href="classvpgl__rational__camera.html">vpgl_rational_camera&lt;double&gt;</a> <span class="keyword">const</span>&amp; rat_cam,
<a name="l00472"></a>00472                <a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__box__3d.html">vgl_box_3d&lt;double&gt;</a> <span class="keyword">const</span>&amp; approximation_volume,
<a name="l00473"></a>00473                <a class="code" href="classvpgl__perspective__camera.html" title="This class implements the perspective camera class as described in Hartley &amp; Zisserman as a finite ca...">vpgl_perspective_camera&lt;double&gt;</a>&amp; camera,
<a name="l00474"></a>00474                <a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__h__matrix__3d.html">vgl_h_matrix_3d&lt;double&gt;</a>&amp; norm_trans)
<a name="l00475"></a>00475 {
<a name="l00476"></a>00476   <span class="comment">// Set up the geo converter.</span>
<a name="l00477"></a>00477   <span class="keywordtype">double</span> lon_low = approximation_volume.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__box__3d.html#ab79a05c37774165ce3cae19ccbcc549c">min_x</a>();
<a name="l00478"></a>00478   <span class="keywordtype">double</span> lat_low = approximation_volume.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__box__3d.html#a23726177791036bd1b7ef4db11553abe">min_y</a>();
<a name="l00479"></a>00479 <span class="preprocessor">#ifdef DEBUG</span>
<a name="l00480"></a>00480 <span class="preprocessor"></span>  <span class="keywordtype">double</span> lon_high = approximation_volume.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__box__3d.html#afacb5c402d085e4f899b9468f3ea710d">max_x</a>();
<a name="l00481"></a>00481   <span class="keywordtype">double</span> lat_high = approximation_volume.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__box__3d.html#aa3b803c856fcdacd649625c2454c02cf">max_y</a>();
<a name="l00482"></a>00482   assert( lat_low &lt; lat_high &amp;&amp; lon_low &lt; lon_high );
<a name="l00483"></a>00483 <span class="preprocessor">#endif</span>
<a name="l00484"></a>00484 <span class="preprocessor"></span>  <a class="code" href="classvpgl__lvcs.html">vpgl_lvcs</a> lvcs_converter( lat_low, lon_low,
<a name="l00485"></a>00485                             .5*(approximation_volume.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__box__3d.html#a51ff4f78a35a326eb2fd95a82ca47f3d">min_z</a>()+approximation_volume.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__box__3d.html#a6d1e762f48d0420bc28f1e17e9da0f6e">max_z</a>()),
<a name="l00486"></a>00486                             <a class="code" href="classvpgl__lvcs.html#a06d3da6c2b421a25c020691b4408c889a2b85b0a63d1a734dee492fb2d7c8a0f1">vpgl_lvcs::wgs84</a>, <a class="code" href="classvpgl__lvcs.html#a80232aa32d6c668976cd97dd6c28b7c2ac567d209a5a79daf7b971dd85a1c6c52">vpgl_lvcs::DEG</a> );
<a name="l00487"></a>00487 
<a name="l00488"></a>00488   <span class="comment">// Get a new local bounding box.</span>
<a name="l00489"></a>00489   <span class="keywordtype">double</span> min_lx=1e99, min_ly=1e99, min_lz=1e99, max_lx=0, max_ly=0, max_lz=0;
<a name="l00490"></a>00490   <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> cx = 0; cx &lt; 2; ++cx ) {
<a name="l00491"></a>00491     <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> cy = 0; cy &lt; 2; ++cy ) {
<a name="l00492"></a>00492       <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> cz = 0; cz &lt; 2; ++cz ) {
<a name="l00493"></a>00493         <a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__3d.html">vgl_point_3d&lt;double&gt;</a> wc(approximation_volume.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__box__3d.html#ab79a05c37774165ce3cae19ccbcc549c">min_x</a>()*cx + approximation_volume.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__box__3d.html#afacb5c402d085e4f899b9468f3ea710d">max_x</a>()*(1-cx),
<a name="l00494"></a>00494                                 approximation_volume.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__box__3d.html#a23726177791036bd1b7ef4db11553abe">min_y</a>()*cy + approximation_volume.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__box__3d.html#aa3b803c856fcdacd649625c2454c02cf">max_y</a>()*(1-cy),
<a name="l00495"></a>00495                                 approximation_volume.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__box__3d.html#a51ff4f78a35a326eb2fd95a82ca47f3d">min_z</a>()*cz + approximation_volume.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__box__3d.html#a6d1e762f48d0420bc28f1e17e9da0f6e">max_z</a>()*(1-cz) );
<a name="l00496"></a>00496         <span class="keywordtype">double</span> lcx, lcy, lcz;
<a name="l00497"></a>00497         lvcs_converter.<a class="code" href="classvpgl__lvcs.html#add1b745007d39b8fd28e0aaa2f69d927" title="Converts pointin, given in a global coord system described by global_cs_name, to pointout in the loca...">global_to_local</a>(wc.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__3d.html#a1ad910614a911c7d322c086438d6441d">x</a>(), wc.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__3d.html#a6fcfebd50c3f8570fafd49df0687feb2">y</a>(), wc.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__3d.html#a477066fab00b63b2641305fb7e41fb62">z</a>(), <a class="code" href="classvpgl__lvcs.html#a06d3da6c2b421a25c020691b4408c889a2b85b0a63d1a734dee492fb2d7c8a0f1">vpgl_lvcs::wgs84</a>, lcx, lcy, lcz );
<a name="l00498"></a>00498         <a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__3d.html">vgl_point_3d&lt;double&gt;</a> wc_loc( lcx, lcy, lcz );
<a name="l00499"></a>00499         <span class="keywordflow">if</span> ( cx == 0 &amp;&amp; cy == 0 &amp;&amp; cz == 0 ) {
<a name="l00500"></a>00500           min_lx = wc_loc.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__3d.html#a1ad910614a911c7d322c086438d6441d">x</a>(); max_lx = wc_loc.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__3d.html#a1ad910614a911c7d322c086438d6441d">x</a>();
<a name="l00501"></a>00501           min_ly = wc_loc.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__3d.html#a6fcfebd50c3f8570fafd49df0687feb2">y</a>(); max_ly = wc_loc.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__3d.html#a6fcfebd50c3f8570fafd49df0687feb2">y</a>();
<a name="l00502"></a>00502           min_lz = wc_loc.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__3d.html#a477066fab00b63b2641305fb7e41fb62">z</a>(); max_lz = wc_loc.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__3d.html#a477066fab00b63b2641305fb7e41fb62">z</a>();
<a name="l00503"></a>00503           <span class="keywordflow">continue</span>;
<a name="l00504"></a>00504         }
<a name="l00505"></a>00505         <span class="keywordflow">if</span> ( wc_loc.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__3d.html#a1ad910614a911c7d322c086438d6441d">x</a>() &lt; min_lx ) min_lx = wc_loc.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__3d.html#a1ad910614a911c7d322c086438d6441d">x</a>();
<a name="l00506"></a>00506         <span class="keywordflow">if</span> ( wc_loc.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__3d.html#a6fcfebd50c3f8570fafd49df0687feb2">y</a>() &lt; min_ly ) min_ly = wc_loc.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__3d.html#a6fcfebd50c3f8570fafd49df0687feb2">y</a>();
<a name="l00507"></a>00507         <span class="keywordflow">if</span> ( wc_loc.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__3d.html#a477066fab00b63b2641305fb7e41fb62">z</a>() &lt; min_lz ) min_lz = wc_loc.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__3d.html#a477066fab00b63b2641305fb7e41fb62">z</a>();
<a name="l00508"></a>00508         <span class="keywordflow">if</span> ( wc_loc.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__3d.html#a1ad910614a911c7d322c086438d6441d">x</a>() &gt; max_lx ) max_lx = wc_loc.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__3d.html#a1ad910614a911c7d322c086438d6441d">x</a>();
<a name="l00509"></a>00509         <span class="keywordflow">if</span> ( wc_loc.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__3d.html#a6fcfebd50c3f8570fafd49df0687feb2">y</a>() &gt; max_ly ) max_ly = wc_loc.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__3d.html#a6fcfebd50c3f8570fafd49df0687feb2">y</a>();
<a name="l00510"></a>00510         <span class="keywordflow">if</span> ( wc_loc.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__3d.html#a477066fab00b63b2641305fb7e41fb62">z</a>() &gt; max_lz ) max_lz = wc_loc.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__3d.html#a477066fab00b63b2641305fb7e41fb62">z</a>();
<a name="l00511"></a>00511       }
<a name="l00512"></a>00512     }
<a name="l00513"></a>00513   }
<a name="l00514"></a>00514   <span class="keywordtype">double</span> dlx = max_lx-min_lx, dly = max_ly-min_ly, dlz = max_lz-min_lz;
<a name="l00515"></a>00515 
<a name="l00516"></a>00516   norm_trans.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__h__matrix__3d.html#a49a1abaf04b491809448c2d7464be473">set_identity</a>();
<a name="l00517"></a>00517   norm_trans.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__h__matrix__3d.html#a10e0d23912489e39105f48373061f2c4">set</a>(0,0,2/dlx); norm_trans.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__h__matrix__3d.html#a10e0d23912489e39105f48373061f2c4">set</a>(1,1,2/dly); norm_trans.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__h__matrix__3d.html#a10e0d23912489e39105f48373061f2c4">set</a>(2,2,2/dlz);
<a name="l00518"></a>00518   norm_trans.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__h__matrix__3d.html#a10e0d23912489e39105f48373061f2c4">set</a>(0,3, -1-2*min_lx/dlx );
<a name="l00519"></a>00519   norm_trans.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__h__matrix__3d.html#a10e0d23912489e39105f48373061f2c4">set</a>(1,3, -1-2*min_ly/dly);
<a name="l00520"></a>00520   norm_trans.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__h__matrix__3d.html#a10e0d23912489e39105f48373061f2c4">set</a>(2,3, -1-2*min_lz/dlz);
<a name="l00521"></a>00521 
<a name="l00522"></a>00522   <a class="code" href="classvpgl__scale__offset.html">vpgl_scale_offset&lt;double&gt;</a> sou =
<a name="l00523"></a>00523     rat_cam.<a class="code" href="classvpgl__rational__camera.html#afa3c213ae12b61b50b814d29f43e5ab6" title="get a specific scale_offset.">scl_off</a>(<a class="code" href="classvpgl__rational__camera.html">vpgl_rational_camera&lt;double&gt;::U_INDX</a>);
<a name="l00524"></a>00524   <a class="code" href="classvpgl__scale__offset.html">vpgl_scale_offset&lt;double&gt;</a> sov =
<a name="l00525"></a>00525     rat_cam.<a class="code" href="classvpgl__rational__camera.html#afa3c213ae12b61b50b814d29f43e5ab6" title="get a specific scale_offset.">scl_off</a>(<a class="code" href="classvpgl__rational__camera.html">vpgl_rational_camera&lt;double&gt;::V_INDX</a>);
<a name="l00526"></a>00526   <a class="code" href="classvpgl__scale__offset.html">vpgl_scale_offset&lt;double&gt;</a> sox =
<a name="l00527"></a>00527     rat_cam.<a class="code" href="classvpgl__rational__camera.html#afa3c213ae12b61b50b814d29f43e5ab6" title="get a specific scale_offset.">scl_off</a>(<a class="code" href="classvpgl__rational__camera.html">vpgl_rational_camera&lt;double&gt;::X_INDX</a>);
<a name="l00528"></a>00528   <a class="code" href="classvpgl__scale__offset.html">vpgl_scale_offset&lt;double&gt;</a> soy =
<a name="l00529"></a>00529     rat_cam.<a class="code" href="classvpgl__rational__camera.html#afa3c213ae12b61b50b814d29f43e5ab6" title="get a specific scale_offset.">scl_off</a>(<a class="code" href="classvpgl__rational__camera.html">vpgl_rational_camera&lt;double&gt;::Y_INDX</a>);
<a name="l00530"></a>00530   <a class="code" href="classvpgl__scale__offset.html">vpgl_scale_offset&lt;double&gt;</a> soz =
<a name="l00531"></a>00531     rat_cam.<a class="code" href="classvpgl__rational__camera.html#afa3c213ae12b61b50b814d29f43e5ab6" title="get a specific scale_offset.">scl_off</a>(<a class="code" href="classvpgl__rational__camera.html">vpgl_rational_camera&lt;double&gt;::Z_INDX</a>);
<a name="l00532"></a>00532   <span class="keywordtype">unsigned</span> ni = <span class="keyword">static_cast&lt;</span><span class="keywordtype">unsigned</span><span class="keyword">&gt;</span>(2*sou.<a class="code" href="classvpgl__scale__offset.html#aac5d47af86f9e0c846f23091a45ab27c">scale</a>());<span class="comment">//# image columns</span>
<a name="l00533"></a>00533   <span class="keywordtype">unsigned</span> nj = <span class="keyword">static_cast&lt;</span><span class="keywordtype">unsigned</span><span class="keyword">&gt;</span>(2*sov.<a class="code" href="classvpgl__scale__offset.html#aac5d47af86f9e0c846f23091a45ab27c">scale</a>());<span class="comment">//# image rows</span>
<a name="l00534"></a>00534 
<a name="l00535"></a>00535   <a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__3d.html">vgl_point_3d&lt;double&gt;</a> minp = approximation_volume.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__box__3d.html#a30469701fd79722e5302451ad3684b14">min_point</a>();
<a name="l00536"></a>00536   <a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__3d.html">vgl_point_3d&lt;double&gt;</a> maxp = approximation_volume.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__box__3d.html#a75819f3087de7397c401c603b1a62495">max_point</a>();
<a name="l00537"></a>00537   <span class="keywordtype">double</span> xmin = minp.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__3d.html#a1ad910614a911c7d322c086438d6441d">x</a>(), ymin = minp.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__3d.html#a6fcfebd50c3f8570fafd49df0687feb2">y</a>(), zmin = minp.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__3d.html#a477066fab00b63b2641305fb7e41fb62">z</a>();
<a name="l00538"></a>00538   <span class="keywordtype">double</span> xrange = maxp.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__3d.html#a1ad910614a911c7d322c086438d6441d">x</a>()-xmin,
<a name="l00539"></a>00539          yrange = maxp.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__3d.html#a6fcfebd50c3f8570fafd49df0687feb2">y</a>()-ymin,
<a name="l00540"></a>00540          zrange = maxp.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__3d.html#a477066fab00b63b2641305fb7e41fb62">z</a>()-zmin;
<a name="l00541"></a>00541   <span class="keywordflow">if</span> (xrange&lt;0||yrange&lt;0||zrange&lt;0)
<a name="l00542"></a>00542     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00543"></a>00543   <span class="comment">//Randomly generate points</span>
<a name="l00544"></a>00544   <span class="keywordtype">unsigned</span> n = 100;
<a name="l00545"></a>00545   vcl_vector&lt;vgl_point_3d&lt;double&gt; &gt; world_pts;
<a name="l00546"></a>00546   <span class="keywordtype">unsigned</span> count = 0, ntrials = 0;
<a name="l00547"></a>00547   <span class="keywordflow">while</span> (count&lt;n)
<a name="l00548"></a>00548   {
<a name="l00549"></a>00549     ++ntrials;
<a name="l00550"></a>00550     <span class="keywordtype">double</span> rx = xrange*(vcl_rand()/(RAND_MAX+1.0));
<a name="l00551"></a>00551     <span class="keywordtype">double</span> ry = yrange*(vcl_rand()/(RAND_MAX+1.0));
<a name="l00552"></a>00552     <span class="keywordtype">double</span> rz = zrange*(vcl_rand()/(RAND_MAX+1.0));
<a name="l00553"></a>00553     <a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__3d.html">vgl_point_3d&lt;double&gt;</a> wp(xmin+rx, ymin+ry, zmin+rz);
<a name="l00554"></a>00554     <a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__2d.html">vgl_point_2d&lt;double&gt;</a> ip = rat_cam.<a class="code" href="classvpgl__rational__camera.html#a5b712c1ea84ed7bcc07b556383da368a" title="The generic camera interface. u represents image column, v image row.">project</a>(wp);
<a name="l00555"></a>00555     <span class="keywordflow">if</span> (ip.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__2d.html#a3d0455536dcb130f284c3eeaba1ae960">x</a>()&lt;0||ip.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__2d.html#a3d0455536dcb130f284c3eeaba1ae960">x</a>()&gt;ni||ip.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__2d.html#a25dfe52017f7614103d028639125ff91">y</a>()&lt;0||ip.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__2d.html#a25dfe52017f7614103d028639125ff91">y</a>()&gt;nj)
<a name="l00556"></a>00556       <span class="keywordflow">continue</span>;
<a name="l00557"></a>00557     world_pts.push_back(wp);
<a name="l00558"></a>00558     count++;
<a name="l00559"></a>00559   }
<a name="l00560"></a>00560   vcl_cout &lt;&lt; <span class="stringliteral">&quot;Ntrials &quot;</span> &lt;&lt; ntrials &lt;&lt; <span class="charliteral">&#39;\n&#39;</span>;
<a name="l00561"></a>00561 
<a name="l00562"></a>00562   <span class="comment">//Normalize world and image points to the range [-1,1]</span>
<a name="l00563"></a>00563   vcl_vector&lt;vgl_point_3d&lt;double&gt; &gt; norm_world_pts;
<a name="l00564"></a>00564   vcl_vector&lt;vgl_point_2d&lt;double&gt; &gt; image_pts, norm_image_pts;
<a name="l00565"></a>00565   <span class="keywordtype">unsigned</span> N = world_pts.size();
<a name="l00566"></a>00566   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> i = 0; i&lt;N; ++i)
<a name="l00567"></a>00567   {
<a name="l00568"></a>00568     <a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__3d.html">vgl_point_3d&lt;double&gt;</a> wp = world_pts[i];
<a name="l00569"></a>00569     <a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__2d.html">vgl_point_2d&lt;double&gt;</a> ip = rat_cam.<a class="code" href="classvpgl__rational__camera.html#a5b712c1ea84ed7bcc07b556383da368a" title="The generic camera interface. u represents image column, v image row.">project</a>(wp);
<a name="l00570"></a>00570     image_pts.push_back(ip);
<a name="l00571"></a>00571     <a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__2d.html">vgl_point_2d&lt;double&gt;</a> nip(sou.<a class="code" href="classvpgl__scale__offset.html#a3173362f51c6caaabeabd34264e39773">normalize</a>(ip.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__2d.html#a3d0455536dcb130f284c3eeaba1ae960">x</a>()), sov.<a class="code" href="classvpgl__scale__offset.html#a3173362f51c6caaabeabd34264e39773">normalize</a>(ip.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__2d.html#a25dfe52017f7614103d028639125ff91">y</a>()));
<a name="l00572"></a>00572     norm_image_pts.push_back(nip);
<a name="l00573"></a>00573 
<a name="l00574"></a>00574     <span class="comment">// Convert to local coords.</span>
<a name="l00575"></a>00575     <span class="keywordtype">double</span> lcx, lcy, lcz;
<a name="l00576"></a>00576     lvcs_converter.<a class="code" href="classvpgl__lvcs.html#add1b745007d39b8fd28e0aaa2f69d927" title="Converts pointin, given in a global coord system described by global_cs_name, to pointout in the loca...">global_to_local</a>(wp.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__3d.html#a1ad910614a911c7d322c086438d6441d">x</a>(), wp.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__3d.html#a6fcfebd50c3f8570fafd49df0687feb2">y</a>(), wp.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__3d.html#a477066fab00b63b2641305fb7e41fb62">z</a>(), <a class="code" href="classvpgl__lvcs.html#a06d3da6c2b421a25c020691b4408c889a2b85b0a63d1a734dee492fb2d7c8a0f1">vpgl_lvcs::wgs84</a>, lcx, lcy, lcz );
<a name="l00577"></a>00577     <a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__homg__point__3d.html">vgl_homg_point_3d&lt;double&gt;</a> wp_loc( lcx, lcy, lcz );
<a name="l00578"></a>00578 
<a name="l00579"></a>00579     <a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__homg__point__3d.html">vgl_homg_point_3d&lt;double&gt;</a> nwp = norm_trans*wp_loc;
<a name="l00580"></a>00580     assert(   vcl_fabs(nwp.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__homg__point__3d.html#aceac2a4dfd00dc600196eb9b9279f5fd">x</a>()) &lt;= 1
<a name="l00581"></a>00581            &amp;&amp; vcl_fabs(nwp.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__homg__point__3d.html#a054f0d10a7c37b4aebcae08daf66c185">y</a>()) &lt;= 1
<a name="l00582"></a>00582            &amp;&amp; vcl_fabs(nwp.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__homg__point__3d.html#a7084d86ca9aeca00cf6c9b87bc2bfc92">z</a>()) &lt;= 1 );
<a name="l00583"></a>00583     norm_world_pts.push_back(<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__3d.html">vgl_point_3d&lt;double&gt;</a>(nwp) );
<a name="l00584"></a>00584   }
<a name="l00585"></a>00585   <span class="comment">//Assume identity calibration matrix initially, since image point</span>
<a name="l00586"></a>00586   <span class="comment">//normalization remove any scale and offset from image coordinates</span>
<a name="l00587"></a>00587   vnl_matrix_fixed&lt;double, 3, 3&gt; kk;
<a name="l00588"></a>00588   kk.fill(0);
<a name="l00589"></a>00589   kk[0][0]= 1.0;
<a name="l00590"></a>00590   kk[1][1]= 1.0;
<a name="l00591"></a>00591   kk[2][2]=1.0;
<a name="l00592"></a>00592   <span class="comment">//Convert solution for rotation and translation and calibration matrix of</span>
<a name="l00593"></a>00593   <span class="comment">//the perspective camera</span>
<a name="l00594"></a>00594   <a class="code" href="classvpgl__calibration__matrix.html">vpgl_calibration_matrix&lt;double&gt;</a> K(kk);
<a name="l00595"></a>00595   <span class="keywordflow">if</span> (! <a class="code" href="classvpgl__perspective__camera__compute.html#a0fc4c1c3473826f3fe684b390261abdf" title="Compute from two sets of corresponding points.">vpgl_perspective_camera_compute::compute</a>(norm_image_pts,
<a name="l00596"></a>00596                                                  norm_world_pts,
<a name="l00597"></a>00597                                                  K, camera))
<a name="l00598"></a>00598     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00599"></a>00599   vcl_cout &lt;&lt; camera &lt;&lt; <span class="charliteral">&#39;\n&#39;</span>;
<a name="l00600"></a>00600   <span class="comment">//form the full camera by premultiplying by the image normalization</span>
<a name="l00601"></a>00601   <a class="code" href="classvpgl__calibration__matrix.html">vpgl_calibration_matrix&lt;double&gt;</a> Kmin = camera.get_calibration();
<a name="l00602"></a>00602   vnl_matrix_fixed&lt;double, 3, 3&gt; kk_min;
<a name="l00603"></a>00603   kk_min = Kmin.<a class="code" href="classvpgl__calibration__matrix.html#a955a3096bcf8f52d3510824d95d04b1d" title="Get the calibration matrix.">get_matrix</a>();
<a name="l00604"></a>00604   kk[0][0]= sou.<a class="code" href="classvpgl__scale__offset.html#aac5d47af86f9e0c846f23091a45ab27c">scale</a>(); kk[0][2]= sou.<a class="code" href="classvpgl__scale__offset.html#a72ef4752915ec2ca39379aa93b8f3cb3">offset</a>();
<a name="l00605"></a>00605   kk[1][1]= sov.<a class="code" href="classvpgl__scale__offset.html#aac5d47af86f9e0c846f23091a45ab27c">scale</a>(); kk[1][2]= sov.<a class="code" href="classvpgl__scale__offset.html#a72ef4752915ec2ca39379aa93b8f3cb3">offset</a>();
<a name="l00606"></a>00606   kk *= kk_min;
<a name="l00607"></a>00607   camera.set_calibration(kk);
<a name="l00608"></a>00608 
<a name="l00609"></a>00609   <span class="comment">//project the points approximated</span>
<a name="l00610"></a>00610   <span class="keywordtype">double</span> err_max = 0, err_min = 1e10;
<a name="l00611"></a>00611   <a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__3d.html">vgl_point_3d&lt;double&gt;</a> min_pt, max_pt;
<a name="l00612"></a>00612   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> i = 0; i&lt;N; ++i)
<a name="l00613"></a>00613   {
<a name="l00614"></a>00614     <a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__3d.html">vgl_point_3d&lt;double&gt;</a> nwp = norm_world_pts[i];
<a name="l00615"></a>00615     <span class="keywordtype">double</span> U ,V;
<a name="l00616"></a>00616     camera.project(nwp.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__3d.html#a1ad910614a911c7d322c086438d6441d">x</a>(), nwp.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__3d.html#a6fcfebd50c3f8570fafd49df0687feb2">y</a>(), nwp.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__3d.html#a477066fab00b63b2641305fb7e41fb62">z</a>(), U, V);
<a name="l00617"></a>00617     <a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__2d.html">vgl_point_2d&lt;double&gt;</a> ip = image_pts[i];
<a name="l00618"></a>00618     <span class="keywordtype">double</span> error = vcl_sqrt((ip.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__2d.html#a3d0455536dcb130f284c3eeaba1ae960">x</a>()-U)*(ip.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__2d.html#a3d0455536dcb130f284c3eeaba1ae960">x</a>()-U) + (ip.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__2d.html#a25dfe52017f7614103d028639125ff91">y</a>()-V)*(ip.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__2d.html#a25dfe52017f7614103d028639125ff91">y</a>()-V));
<a name="l00619"></a>00619     <span class="keywordflow">if</span> ( error &gt; err_max )
<a name="l00620"></a>00620     {
<a name="l00621"></a>00621       err_max = error;
<a name="l00622"></a>00622       max_pt = world_pts[i];
<a name="l00623"></a>00623     }
<a name="l00624"></a>00624     <span class="keywordflow">if</span> (error &lt; err_min)
<a name="l00625"></a>00625     {
<a name="l00626"></a>00626       err_min = error;
<a name="l00627"></a>00627       min_pt = world_pts[i];
<a name="l00628"></a>00628     }
<a name="l00629"></a>00629   }
<a name="l00630"></a>00630   vcl_cout &lt;&lt; <span class="stringliteral">&quot;Max Error = &quot;</span> &lt;&lt; err_max &lt;&lt; <span class="stringliteral">&quot; at &quot;</span> &lt;&lt; max_pt &lt;&lt; <span class="charliteral">&#39;\n&#39;</span>
<a name="l00631"></a>00631            &lt;&lt; <span class="stringliteral">&quot;Min Error = &quot;</span> &lt;&lt; err_min &lt;&lt; <span class="stringliteral">&quot; at &quot;</span> &lt;&lt; min_pt &lt;&lt; <span class="charliteral">&#39;\n&#39;</span>
<a name="l00632"></a>00632            &lt;&lt; <span class="stringliteral">&quot;final cam\n&quot;</span> &lt;&lt; camera &lt;&lt; <span class="charliteral">&#39;\n&#39;</span>;
<a name="l00633"></a>00633   <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00634"></a>00634 }
<a name="l00635"></a>00635 
<a name="l00636"></a>00636 <span class="comment">//</span>
<a name="l00637"></a>00637 <span class="comment">//linear interpolation based on a set of 4 neighboring rays</span>
<a name="l00638"></a>00638 <span class="comment">//          X</span>
<a name="l00639"></a>00639 <span class="comment">//        X r X</span>
<a name="l00640"></a>00640 <span class="comment">//          X</span>
<a name="l00641"></a>00641 <span class="comment">// ray r at the center pixel is interpolated from the neighboring X&#39;s</span>
<a name="l00642"></a>00642 <span class="comment">// as shown. This method is used to test if ray interpolation</span>
<a name="l00643"></a>00643 <span class="comment">// is sufficiently accurate</span>
<a name="l00644"></a>00644 <span class="comment">//</span>
<a name="l00645"></a>00645 <span class="keyword">static</span> <span class="keywordtype">bool</span> interp_ray(vcl_vector&lt;<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__ray__3d.html">vgl_ray_3d&lt;double&gt;</a> &gt; <span class="keyword">const</span>&amp; ray_nbrs,
<a name="l00646"></a>00646                        <a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__ray__3d.html">vgl_ray_3d&lt;double&gt;</a> &amp; intrp_ray)
<a name="l00647"></a>00647 {
<a name="l00648"></a>00648   <span class="keywordtype">unsigned</span> nrays = ray_nbrs.size();
<a name="l00649"></a>00649   <span class="keywordflow">if</span> (nrays!=4) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00650"></a>00650   <a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__ray__3d.html">vgl_ray_3d&lt;double&gt;</a> r0 = ray_nbrs[0], r1 = ray_nbrs[1];
<a name="l00651"></a>00651   <a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__ray__3d.html">vgl_ray_3d&lt;double&gt;</a> r2 = ray_nbrs[2], r3 = ray_nbrs[3];
<a name="l00652"></a>00652   <a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__3d.html">vgl_point_3d&lt;double&gt;</a> org0 = r0.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__ray__3d.html#ad4ea7c060cf71c338578456a98a162d1">origin</a>(), org1 = r1.origin();
<a name="l00653"></a>00653   <a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__3d.html">vgl_point_3d&lt;double&gt;</a> org2 = r2.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__ray__3d.html#ad4ea7c060cf71c338578456a98a162d1">origin</a>(), org3 = r3.origin();
<a name="l00654"></a>00654   <a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__vector__3d.html">vgl_vector_3d&lt;double&gt;</a> dir0 = r0.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__ray__3d.html#ac1194361067f4de72511417e3e380168">direction</a>(), dir1 = r1.direction();
<a name="l00655"></a>00655   <a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__vector__3d.html">vgl_vector_3d&lt;double&gt;</a> dir2 = r2.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__ray__3d.html#ac1194361067f4de72511417e3e380168">direction</a>(), dir3 = r3.direction();
<a name="l00656"></a>00656   <span class="comment">// first order partial derivatives</span>
<a name="l00657"></a>00657   <a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__vector__3d.html">vgl_vector_3d&lt;double&gt;</a> dodu = 0.5*(org2-org1);
<a name="l00658"></a>00658   <a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__vector__3d.html">vgl_vector_3d&lt;double&gt;</a> dodv = 0.5*(org3-org0);
<a name="l00659"></a>00659   <a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__vector__3d.html">vgl_vector_3d&lt;double&gt;</a> dddu = 0.5*(dir2-dir1);
<a name="l00660"></a>00660   <a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__vector__3d.html">vgl_vector_3d&lt;double&gt;</a> dddv = 0.5*(dir3-dir0);
<a name="l00661"></a>00661   <a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__3d.html">vgl_point_3d&lt;double&gt;</a> temp = org1 + dodu + dodv;
<a name="l00662"></a>00662   <span class="keywordtype">double</span> ox = 0.5*(org0.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__3d.html#a1ad910614a911c7d322c086438d6441d">x</a>()+ temp.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__3d.html#a1ad910614a911c7d322c086438d6441d">x</a>());
<a name="l00663"></a>00663   <span class="keywordtype">double</span> oy = 0.5*(org0.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__3d.html#a6fcfebd50c3f8570fafd49df0687feb2">y</a>()+ temp.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__3d.html#a6fcfebd50c3f8570fafd49df0687feb2">y</a>());
<a name="l00664"></a>00664   <span class="keywordtype">double</span> oz = 0.5*(org0.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__3d.html#a477066fab00b63b2641305fb7e41fb62">z</a>()+ temp.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__3d.html#a477066fab00b63b2641305fb7e41fb62">z</a>());
<a name="l00665"></a>00665   <a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__3d.html">vgl_point_3d&lt;double&gt;</a> iorg(ox, oy, oz);
<a name="l00666"></a>00666   <a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__vector__3d.html">vgl_vector_3d&lt;double&gt;</a> idir = 0.5*(dir1 + dddu + dir0 + dddv);
<a name="l00667"></a>00667   intrp_ray.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__ray__3d.html#a18444bfcb5247ae1db420fb132737553">set</a>(iorg, idir);
<a name="l00668"></a>00668   <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00669"></a>00669 }
<a name="l00670"></a>00670 
<a name="l00671"></a>00671 <span class="comment">// convert tolerances on ray origin and ray direction to test interpolation</span>
<a name="l00672"></a>00672 <span class="keyword">static</span> <span class="keywordtype">bool</span> ray_tol(<a class="code" href="classvpgl__local__rational__camera.html">vpgl_local_rational_camera&lt;double&gt;</a> <span class="keyword">const</span>&amp; rat_cam,
<a name="l00673"></a>00673                     <span class="keywordtype">double</span> mid_u, <span class="keywordtype">double</span> mid_v,
<a name="l00674"></a>00674                     <a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__plane__3d.html">vgl_plane_3d&lt;double&gt;</a> <span class="keyword">const</span>&amp; high,
<a name="l00675"></a>00675                     <a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__3d.html">vgl_point_3d&lt;double&gt;</a> <span class="keyword">const</span>&amp; high_guess,
<a name="l00676"></a>00676                     <a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__plane__3d.html">vgl_plane_3d&lt;double&gt;</a> <span class="keyword">const</span>&amp; low,
<a name="l00677"></a>00677                     <a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__3d.html">vgl_point_3d&lt;double&gt;</a> <span class="keyword">const</span>&amp; low_guess,
<a name="l00678"></a>00678                     <span class="keywordtype">double</span>&amp; org_tol, <span class="keywordtype">double</span>&amp; dir_tol)
<a name="l00679"></a>00679 {
<a name="l00680"></a>00680   <a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__2d.html">vgl_point_2d&lt;double&gt;</a> ip(mid_u,mid_v);
<a name="l00681"></a>00681   <a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__3d.html">vgl_point_3d&lt;double&gt;</a> high_pt, low_pt, low_pt_pix;
<a name="l00682"></a>00682   <span class="keywordflow">if</span> (!<a class="code" href="classvpgl__backproject.html#a37fbaf599317f3b38cbae21037d513ef" title="Generic camera interfaces (pointer for abstract class).">vpgl_backproject::bproj_plane</a>(&amp;rat_cam, ip, high, high_guess, high_pt))
<a name="l00683"></a>00683     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00684"></a>00684   <span class="keywordflow">if</span> (!<a class="code" href="classvpgl__backproject.html#a37fbaf599317f3b38cbae21037d513ef" title="Generic camera interfaces (pointer for abstract class).">vpgl_backproject::bproj_plane</a>(&amp;rat_cam, ip, low, low_guess, low_pt))
<a name="l00685"></a>00685     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00686"></a>00686   <span class="comment">//move 1 pixel</span>
<a name="l00687"></a>00687   ip.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__3d.html#a9214f0889950e12c7db9dfc6fbbcdd1a">set</a>(mid_u+1.0, mid_v+1.0);
<a name="l00688"></a>00688   <span class="keywordflow">if</span> (!<a class="code" href="classvpgl__backproject.html#a37fbaf599317f3b38cbae21037d513ef" title="Generic camera interfaces (pointer for abstract class).">vpgl_backproject::bproj_plane</a>(&amp;rat_cam, ip, low, low_pt, low_pt_pix))
<a name="l00689"></a>00689     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00690"></a>00690   <span class="comment">// Ground Sampling Distance</span>
<a name="l00691"></a>00691   <span class="keywordtype">double</span> gsd = (low_pt-low_pt_pix).<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/vgl__vector__2d_8h.html#a31c7db8164e71d411a1a821525102dc3">length</a>();
<a name="l00692"></a>00692   <span class="comment">// tolerance</span>
<a name="l00693"></a>00693   <span class="keywordtype">double</span> tfact = 0.001;
<a name="l00694"></a>00694   org_tol = tfact*gsd;
<a name="l00695"></a>00695   <a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__vector__3d.html">vgl_vector_3d&lt;double&gt;</a> dir0 = low_pt-high_pt;
<a name="l00696"></a>00696   <a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__vector__3d.html">vgl_vector_3d&lt;double&gt;</a> dir1 = low_pt_pix-high_pt;
<a name="l00697"></a>00697   <span class="keywordtype">double</span> ang = <a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/vgl__ray__3d_8h.html#ae53346bdf60e6149c8a61547e0cd38e8">angle</a>(dir0, dir1);
<a name="l00698"></a>00698   dir_tol = tfact*ang;
<a name="l00699"></a>00699   <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00700"></a>00700 }
<a name="l00701"></a>00701 
<a name="l00702"></a>00702 <span class="comment">// produce rays at sub pixel locations by interpolating four neighbors</span>
<a name="l00703"></a>00703 <span class="comment">//</span>
<a name="l00704"></a>00704 <span class="comment">//            X  &lt;- r0</span>
<a name="l00705"></a>00705 <span class="comment">//         _______</span>
<a name="l00706"></a>00706 <span class="comment">//        | o   o |</span>
<a name="l00707"></a>00707 <span class="comment">// r1-&gt; X |       | X &lt;-r2</span>
<a name="l00708"></a>00708 <span class="comment">//        | o   o |</span>
<a name="l00709"></a>00709 <span class="comment">//         -------</span>
<a name="l00710"></a>00710 <span class="comment">//            X &lt;- r3</span>
<a name="l00711"></a>00711 <span class="comment">// the interporlated rays are indicated by the o&#39;s</span>
<a name="l00712"></a>00712 <span class="comment">// the neighbor rays are shown as X&#39;s</span>
<a name="l00713"></a>00713 <span class="comment">// This method is used to populate higher resolution layers of the</span>
<a name="l00714"></a>00714 <span class="comment">// ray pyramid</span>
<a name="l00715"></a>00715 
<a name="l00716"></a>00716 <span class="keywordtype">bool</span> <a class="code" href="classvpgl__generic__camera__convert.html#a4bd35d98f89c110cd45c1b7fdca47786" title="interpolate rays to fill next higher resolution pyramid layer.">vpgl_generic_camera_convert::</a>
<a name="l00717"></a><a class="code" href="classvpgl__generic__camera__convert.html#a4bd35d98f89c110cd45c1b7fdca47786">00717</a> <a class="code" href="classvpgl__generic__camera__convert.html#a4bd35d98f89c110cd45c1b7fdca47786" title="interpolate rays to fill next higher resolution pyramid layer.">upsample_rays</a>(vcl_vector&lt;<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__ray__3d.html">vgl_ray_3d&lt;double&gt;</a> &gt; <span class="keyword">const</span>&amp; ray_nbrs,
<a name="l00718"></a>00718               <a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__ray__3d.html">vgl_ray_3d&lt;double&gt;</a> <span class="keyword">const</span>&amp; ray,
<a name="l00719"></a>00719               vcl_vector&lt;<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__ray__3d.html">vgl_ray_3d&lt;double&gt;</a> &gt;&amp; interp_rays)
<a name="l00720"></a>00720 {
<a name="l00721"></a>00721   <span class="keywordtype">unsigned</span> nrays = ray_nbrs.size();
<a name="l00722"></a>00722   <span class="keywordflow">if</span> (nrays!=4) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00723"></a>00723   <a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__ray__3d.html">vgl_ray_3d&lt;double&gt;</a> r00 = ray_nbrs[0],
<a name="l00724"></a>00724                      r01 = ray_nbrs[1];
<a name="l00725"></a>00725   <a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__ray__3d.html">vgl_ray_3d&lt;double&gt;</a> r10 = ray_nbrs[2],
<a name="l00726"></a>00726                      r11 = ray_nbrs[3];
<a name="l00727"></a>00727   <a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__3d.html">vgl_point_3d&lt;double&gt;</a> org = ray.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__ray__3d.html#ad4ea7c060cf71c338578456a98a162d1">origin</a>();
<a name="l00728"></a>00728   <a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__vector__3d.html">vgl_vector_3d&lt;double&gt;</a> dir = ray.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__ray__3d.html#ac1194361067f4de72511417e3e380168">direction</a>();
<a name="l00729"></a>00729   <a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__3d.html">vgl_point_3d&lt;double&gt;</a> org00 = r00.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__ray__3d.html#ad4ea7c060cf71c338578456a98a162d1">origin</a>(),
<a name="l00730"></a>00730                        org01 = r01.origin();
<a name="l00731"></a>00731   <a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__3d.html">vgl_point_3d&lt;double&gt;</a> org10 = r10.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__ray__3d.html#ad4ea7c060cf71c338578456a98a162d1">origin</a>(),
<a name="l00732"></a>00732                        org11 = r11.origin();
<a name="l00733"></a>00733   <a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__vector__3d.html">vgl_vector_3d&lt;double&gt;</a> dir00 = r00.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__ray__3d.html#ac1194361067f4de72511417e3e380168">direction</a>(), dir01 = r01.direction();
<a name="l00734"></a>00734   <a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__vector__3d.html">vgl_vector_3d&lt;double&gt;</a> dir10 = r10.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__ray__3d.html#ac1194361067f4de72511417e3e380168">direction</a>(), dir11 = r11.direction();
<a name="l00735"></a>00735 
<a name="l00736"></a>00736   <span class="comment">//first sub ray</span>
<a name="l00737"></a>00737   interp_rays[0] = ray;
<a name="l00738"></a>00738 
<a name="l00739"></a>00739   <span class="comment">//second sub ray</span>
<a name="l00740"></a>00740   <a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__3d.html">vgl_point_3d&lt;double&gt;</a>  iorg = org00+ (org01-org00)*0.5;
<a name="l00741"></a>00741   <a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__vector__3d.html">vgl_vector_3d&lt;double&gt;</a> idir = dir00*0.5 + dir01*0.5;
<a name="l00742"></a>00742   interp_rays[1].<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__vector__3d.html#a116e3e1800f2c00537fe08f7e544edb8">set</a>(iorg, idir);
<a name="l00743"></a>00743 
<a name="l00744"></a>00744   <span class="comment">//third sub ray</span>
<a name="l00745"></a>00745   iorg = org00+ (org10-org00)*0.5;
<a name="l00746"></a>00746   idir = 0.5*dir00 + 0.5*dir10;
<a name="l00747"></a>00747   interp_rays[2].<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__vector__3d.html#a116e3e1800f2c00537fe08f7e544edb8">set</a>(iorg, idir);
<a name="l00748"></a>00748 
<a name="l00749"></a>00749   <span class="comment">//fourth sub ray</span>
<a name="l00750"></a>00750   iorg = org00+0.25*(org01-org00) + 0.25*(org10-org00)+ 0.25*(org11-org00);
<a name="l00751"></a>00751   idir = 0.25*dir00 + 0.25*dir01+ 0.25*dir10+0.25*dir11;
<a name="l00752"></a>00752   interp_rays[3].<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__vector__3d.html#a116e3e1800f2c00537fe08f7e544edb8">set</a>(iorg, idir);
<a name="l00753"></a>00753 
<a name="l00754"></a>00754   <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00755"></a>00755 }
<a name="l00756"></a>00756 
<a name="l00757"></a>00757 <span class="comment">// r0 and r1 are rays spaced a unit grid distane apart (either row or col)</span>
<a name="l00758"></a>00758 <span class="comment">// r is the interpolated ray at n_grid unit distances past r1</span>
<a name="l00759"></a>00759 <a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__ray__3d.html">vgl_ray_3d&lt;double&gt;</a>
<a name="l00760"></a><a class="code" href="classvpgl__generic__camera__convert.html#af1a4e53d7bc8d326f7ded60ab55d0333">00760</a> <a class="code" href="classvpgl__generic__camera__convert.html#af1a4e53d7bc8d326f7ded60ab55d0333" title="interpolate a span of rays base on a linear interpolation. n_grid is the step distance from r1...">vpgl_generic_camera_convert::interp_pair</a>(<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__ray__3d.html">vgl_ray_3d&lt;double&gt;</a> <span class="keyword">const</span>&amp; r0,
<a name="l00761"></a>00761                                          <a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__ray__3d.html">vgl_ray_3d&lt;double&gt;</a> <span class="keyword">const</span>&amp; r1,
<a name="l00762"></a>00762                                          <span class="keywordtype">double</span> n_grid)
<a name="l00763"></a>00763 {
<a name="l00764"></a>00764   <a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__vector__3d.html">vgl_vector_3d&lt;double&gt;</a> v01 = r1.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__ray__3d.html#ad4ea7c060cf71c338578456a98a162d1">origin</a>()-r0.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__ray__3d.html#ad4ea7c060cf71c338578456a98a162d1">origin</a>();
<a name="l00765"></a>00765   <a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__3d.html">vgl_point_3d&lt;double&gt;</a> intp_org = r1.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__ray__3d.html#ad4ea7c060cf71c338578456a98a162d1">origin</a>()+ n_grid*v01;
<a name="l00766"></a>00766   <a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__vector__3d.html">vgl_vector_3d&lt;double&gt;</a> d01 = r1.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__ray__3d.html#ac1194361067f4de72511417e3e380168">direction</a>()-r0.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__ray__3d.html#ac1194361067f4de72511417e3e380168">direction</a>();
<a name="l00767"></a>00767   <a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__vector__3d.html">vgl_vector_3d&lt;double&gt;</a> intp_dir = r1.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__ray__3d.html#ac1194361067f4de72511417e3e380168">direction</a>()+ n_grid*d01;
<a name="l00768"></a>00768   <span class="keywordflow">return</span> <a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__ray__3d.html">vgl_ray_3d&lt;double&gt;</a>(intp_org, intp_dir);
<a name="l00769"></a>00769 }
<a name="l00770"></a>00770 
<a name="l00771"></a>00771 <span class="comment">//</span>
<a name="l00772"></a>00772 <span class="comment">// convert a generic camera from a local rational camera</span>
<a name="l00773"></a>00773 <span class="comment">// the approach is to form a pyramid and convert rays by</span>
<a name="l00774"></a>00774 <span class="comment">// back-projecting to top and bottom planes of the valid</span>
<a name="l00775"></a>00775 <span class="comment">// elevations of the rational camera. Successive higher resolution</span>
<a name="l00776"></a>00776 <span class="comment">// layers of the pyramid are populated until the interpolation of</span>
<a name="l00777"></a>00777 <span class="comment">// a ray by the four adjacent neighbors is sufficiently accurate</span>
<a name="l00778"></a>00778 <span class="comment">// The remaining layers of the pyramid are filled in by interpolation</span>
<a name="l00779"></a>00779 <span class="comment">//</span>
<a name="l00780"></a>00780 <span class="keywordtype">bool</span> <a class="code" href="classvpgl__generic__camera__convert.html#af7ce4b0bc0f3a26713743c670cdf384d" title="Convert a local rational camera to a generic camera.">vpgl_generic_camera_convert::</a>
<a name="l00781"></a><a class="code" href="classvpgl__generic__camera__convert.html#af7ce4b0bc0f3a26713743c670cdf384d">00781</a> <a class="code" href="classvpgl__generic__camera__convert.html#af7ce4b0bc0f3a26713743c670cdf384d" title="Convert a local rational camera to a generic camera.">convert</a>( <a class="code" href="classvpgl__local__rational__camera.html">vpgl_local_rational_camera&lt;double&gt;</a> <span class="keyword">const</span>&amp; rat_cam,
<a name="l00782"></a>00782          <span class="keywordtype">int</span> ni, <span class="keywordtype">int</span> nj, <a class="code" href="classvpgl__generic__camera.html">vpgl_generic_camera&lt;double&gt;</a> &amp; gen_cam, <span class="keywordtype">unsigned</span> level)
<a name="l00783"></a>00783 {
<a name="l00784"></a>00784   <span class="comment">// get z bounds</span>
<a name="l00785"></a>00785   <span class="keywordtype">double</span> zoff = rat_cam.<a class="code" href="classvpgl__rational__camera.html#aaa6a9ba6d813e18314314e3fd8a04f85" title="get a specific offset value.">offset</a>(<a class="code" href="classvpgl__rational__camera.html">vpgl_rational_camera&lt;double&gt;::Z_INDX</a>);
<a name="l00786"></a>00786   <span class="keywordtype">double</span> zscl = rat_cam.<a class="code" href="classvpgl__rational__camera.html#a9ef2e185dcae658e081e3372486de6d0" title="get a specific scale value.">scale</a>(<a class="code" href="classvpgl__rational__camera.html">vpgl_rational_camera&lt;double&gt;::Z_INDX</a>);
<a name="l00787"></a>00787   <span class="comment">// construct high and low planes</span>
<a name="l00788"></a>00788   <span class="comment">// NOTE: z_scale seems to usually be much larger than actual dimensions of scene, which</span>
<a name="l00789"></a>00789   <span class="comment">//       sometimes causes trouble for vpgl_backproj_plane, which causes the conversion to fail.</span>
<a name="l00790"></a>00790   <span class="comment">//       Using half scale value for now, but maybe we should consider taking &quot;top&quot; and &quot;bottom&quot;</span>
<a name="l00791"></a>00791   <span class="comment">//       z values as user-specified inputs.  -dec 15 Nov 2011</span>
<a name="l00792"></a>00792   <span class="keywordtype">double</span> el_low = zoff-zscl/2;
<a name="l00793"></a>00793   <span class="keywordtype">double</span> el_high = zoff+zscl/2;
<a name="l00794"></a>00794   <span class="keywordtype">double</span> lon = rat_cam.<a class="code" href="classvpgl__rational__camera.html#aaa6a9ba6d813e18314314e3fd8a04f85" title="get a specific offset value.">offset</a>(<a class="code" href="classvpgl__rational__camera.html">vpgl_rational_camera&lt;double&gt;::X_INDX</a>);
<a name="l00795"></a>00795   <span class="keywordtype">double</span> lat = rat_cam.<a class="code" href="classvpgl__rational__camera.html#aaa6a9ba6d813e18314314e3fd8a04f85" title="get a specific offset value.">offset</a>(<a class="code" href="classvpgl__rational__camera.html">vpgl_rational_camera&lt;double&gt;::Y_INDX</a>);
<a name="l00796"></a>00796   <span class="keywordtype">double</span> x,y, z_low, z_high;
<a name="l00797"></a>00797   <span class="comment">// convert high and low elevations to local z values</span>
<a name="l00798"></a>00798   rat_cam.<a class="code" href="classvpgl__local__rational__camera.html#a57e9b344891646390719e9c6a251b3e9">lvcs</a>().<a class="code" href="classvpgl__lvcs.html#add1b745007d39b8fd28e0aaa2f69d927" title="Converts pointin, given in a global coord system described by global_cs_name, to pointout in the loca...">global_to_local</a>(lon,lat,el_low,<a class="code" href="classvpgl__lvcs.html#a06d3da6c2b421a25c020691b4408c889a2b85b0a63d1a734dee492fb2d7c8a0f1">vpgl_lvcs::wgs84</a>,x,y,z_low,<a class="code" href="classvpgl__lvcs.html#a80232aa32d6c668976cd97dd6c28b7c2ac567d209a5a79daf7b971dd85a1c6c52">vpgl_lvcs::DEG</a>);
<a name="l00799"></a>00799   rat_cam.<a class="code" href="classvpgl__local__rational__camera.html#a57e9b344891646390719e9c6a251b3e9">lvcs</a>().<a class="code" href="classvpgl__lvcs.html#add1b745007d39b8fd28e0aaa2f69d927" title="Converts pointin, given in a global coord system described by global_cs_name, to pointout in the loca...">global_to_local</a>(lon,lat,el_high,<a class="code" href="classvpgl__lvcs.html#a06d3da6c2b421a25c020691b4408c889a2b85b0a63d1a734dee492fb2d7c8a0f1">vpgl_lvcs::wgs84</a>,x,y,z_high,<a class="code" href="classvpgl__lvcs.html#a80232aa32d6c668976cd97dd6c28b7c2ac567d209a5a79daf7b971dd85a1c6c52">vpgl_lvcs::DEG</a>);
<a name="l00800"></a>00800 
<a name="l00801"></a>00801   <span class="keywordflow">return</span> <a class="code" href="classvpgl__generic__camera__convert.html#af7ce4b0bc0f3a26713743c670cdf384d" title="Convert a local rational camera to a generic camera.">convert</a>(rat_cam, ni, nj, gen_cam, z_low, z_high, level);
<a name="l00802"></a>00802 }
<a name="l00803"></a>00803 
<a name="l00804"></a>00804 <span class="comment">//</span>
<a name="l00805"></a>00805 <span class="comment">// convert a generic camera from a local rational camera</span>
<a name="l00806"></a>00806 <span class="comment">// the approach is to form a pyramid and convert rays by</span>
<a name="l00807"></a>00807 <span class="comment">// back-projecting to top and bottom planes of the valid</span>
<a name="l00808"></a>00808 <span class="comment">// elevations of the rational camera. Successive higher resolution</span>
<a name="l00809"></a>00809 <span class="comment">// layers of the pyramid are populated until the interpolation of</span>
<a name="l00810"></a>00810 <span class="comment">// a ray by the four adjacent neighbors is sufficiently accurate</span>
<a name="l00811"></a>00811 <span class="comment">// The remaining layers of the pyramid are filled in by interpolation</span>
<a name="l00812"></a>00812 <span class="comment">//</span>
<a name="l00813"></a>00813 <span class="keywordtype">bool</span> <a class="code" href="classvpgl__generic__camera__convert.html#af7ce4b0bc0f3a26713743c670cdf384d" title="Convert a local rational camera to a generic camera.">vpgl_generic_camera_convert::</a>
<a name="l00814"></a><a class="code" href="classvpgl__generic__camera__convert.html#a9b41b240c6a91fa7871555778a94cd12">00814</a> <a class="code" href="classvpgl__generic__camera__convert.html#af7ce4b0bc0f3a26713743c670cdf384d" title="Convert a local rational camera to a generic camera.">convert</a>( <a class="code" href="classvpgl__local__rational__camera.html">vpgl_local_rational_camera&lt;double&gt;</a> <span class="keyword">const</span>&amp; rat_cam,
<a name="l00815"></a>00815          <span class="keywordtype">int</span> ni, <span class="keywordtype">int</span> nj, <a class="code" href="classvpgl__generic__camera.html">vpgl_generic_camera&lt;double&gt;</a> &amp; gen_cam,
<a name="l00816"></a>00816          <span class="keywordtype">double</span> local_z_min, <span class="keywordtype">double</span> local_z_max, <span class="keywordtype">unsigned</span> level)
<a name="l00817"></a>00817 {
<a name="l00818"></a>00818   <a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__plane__3d.html">vgl_plane_3d&lt;double&gt;</a> high(0.0, 0.0, 1.0, -local_z_max);
<a name="l00819"></a>00819   <a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__plane__3d.html">vgl_plane_3d&lt;double&gt;</a> low(0.0, 0.0, 1.0, -local_z_min);
<a name="l00820"></a>00820 
<a name="l00821"></a>00821   <span class="comment">// initial guess for backprojection to planes</span>
<a name="l00822"></a>00822   <a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__3d.html">vgl_point_3d&lt;double&gt;</a> org(0.0, 0.0, local_z_max), endpt(0.0, 0.0, local_z_min);
<a name="l00823"></a>00823 
<a name="l00824"></a>00824   <span class="comment">// initialize the ray pyramid</span>
<a name="l00825"></a>00825   <span class="comment">// convert the required number of levels</span>
<a name="l00826"></a>00826   <span class="keywordtype">double</span> dim = ni;
<a name="l00827"></a>00827   <span class="keywordflow">if</span> (nj&lt;ni)
<a name="l00828"></a>00828     dim = nj;
<a name="l00829"></a>00829   <span class="keywordtype">double</span> lv = vcl_log(dim)/vcl_log(2.0);
<a name="l00830"></a>00830   <span class="keywordtype">int</span> n_levels = <span class="keyword">static_cast&lt;</span><span class="keywordtype">int</span><span class="keyword">&gt;</span>(lv+1.0);<span class="comment">// round up</span>
<a name="l00831"></a>00831   <span class="keywordflow">if</span> (dim*vcl_pow(0.5, static_cast&lt;double&gt;(n_levels-1)) &lt; 3.0) n_levels--;
<a name="l00832"></a>00832   <span class="comment">// construct pyramid of ray indices</span>
<a name="l00833"></a>00833   <span class="comment">// the row and column dimensions at each level</span>
<a name="l00834"></a>00834   vcl_vector&lt;int&gt; nr(n_levels,0), nc(n_levels,0);
<a name="l00835"></a>00835   <span class="comment">// the scale factor at each level (to transform back to level 0)</span>
<a name="l00836"></a>00836   vcl_vector&lt;double&gt; scl(n_levels,1.0);
<a name="l00837"></a>00837   vcl_vector&lt;vbl_array_2d&lt;vgl_ray_3d&lt;double&gt; &gt; &gt; ray_pyr(n_levels);
<a name="l00838"></a>00838   ray_pyr[0].resize(nj, ni);
<a name="l00839"></a>00839   ray_pyr[0].fill(<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__ray__3d.html">vgl_ray_3d&lt;double&gt;</a>(<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__3d.html">vgl_point_3d&lt;double&gt;</a>(0,0,0),<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__vector__3d.html">vgl_vector_3d&lt;double&gt;</a>(0,0,1)));
<a name="l00840"></a>00840   nr[0]=nj;   nc[0]=ni; scl[0]=1.0;
<a name="l00841"></a>00841   <span class="keywordtype">int</span> di = (ni+1)/2+1,
<a name="l00842"></a>00842       dj = (nj+1)/2+1;
<a name="l00843"></a>00843 
<a name="l00844"></a>00844   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=1; i&lt;n_levels; ++i)
<a name="l00845"></a>00845   {
<a name="l00846"></a>00846     ray_pyr[i].resize(dj,di);
<a name="l00847"></a>00847     ray_pyr[i].fill(<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__ray__3d.html">vgl_ray_3d&lt;double&gt;</a>(<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__3d.html">vgl_point_3d&lt;double&gt;</a>(0,0,0),
<a name="l00848"></a>00848                                        <a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__vector__3d.html">vgl_vector_3d&lt;double&gt;</a>(0,0,1)));
<a name="l00849"></a>00849     nr[i]=dj;
<a name="l00850"></a>00850     nc[i]=di;
<a name="l00851"></a>00851     scl[i]=2.0*scl[i-1];
<a name="l00852"></a>00852     di = (di+1)/2+1;
<a name="l00853"></a>00853     dj = (dj+1)/2+1;
<a name="l00854"></a>00854   }
<a name="l00855"></a>00855   <span class="comment">// convert the ray interpolation tolerances</span>
<a name="l00856"></a>00856   <span class="keywordtype">double</span> org_tol = 0.0;
<a name="l00857"></a>00857   <span class="keywordtype">double</span> ang_tol = 0.0;
<a name="l00858"></a>00858   <span class="keywordtype">double</span> max_org_err = 0.0, max_ang_err = 0.0;
<a name="l00859"></a>00859   <span class="keywordflow">if</span> (!ray_tol(rat_cam, ni/2.0, nj/2.0, high,
<a name="l00860"></a>00860                org, low, endpt, org_tol, ang_tol))
<a name="l00861"></a>00861     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00862"></a>00862   <span class="keywordtype">bool</span> need_interp = <span class="keyword">true</span>;
<a name="l00863"></a>00863   <span class="keywordtype">int</span> lev = n_levels-1;
<a name="l00864"></a>00864   <span class="keywordflow">for</span> (; lev&gt;=0&amp;&amp;need_interp; --lev) {
<a name="l00865"></a>00865     <span class="comment">// set rays at current pyramid level</span>
<a name="l00866"></a>00866     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j =0; j&lt;nr[lev]; ++j) {
<a name="l00867"></a>00867       <span class="keywordtype">int</span> sj = <span class="keyword">static_cast&lt;</span><span class="keywordtype">int</span><span class="keyword">&gt;</span>(scl[lev]*j);
<a name="l00868"></a>00868       <span class="comment">//if (sj&gt;=nj) sj = nj;</span>
<a name="l00869"></a>00869       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i =0;i&lt;nc[lev]; ++i)
<a name="l00870"></a>00870       {
<a name="l00871"></a>00871         <span class="keywordtype">int</span> si = <span class="keyword">static_cast&lt;</span><span class="keywordtype">int</span><span class="keyword">&gt;</span>(scl[lev]*i);
<a name="l00872"></a>00872         <span class="comment">//if (si&gt;=ni) si = ni;</span>
<a name="l00873"></a>00873         <a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__2d.html">vgl_point_2d&lt;double&gt;</a> ip(si,sj);
<a name="l00874"></a>00874 <span class="preprocessor">#if 1  // use result from previous pyramid level to initialize guess</span>
<a name="l00875"></a>00875 <span class="preprocessor"></span>        <a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__3d.html">vgl_point_3d&lt;double&gt;</a> prev_org(0.0,0.0,local_z_max);
<a name="l00876"></a>00876         <a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__3d.html">vgl_point_3d&lt;double&gt;</a> prev_endpt(0.0, 0.0, local_z_min);
<a name="l00877"></a>00877         <span class="comment">// initialize guess with</span>
<a name="l00878"></a>00878         <span class="keywordflow">if</span> (lev &lt; n_levels-1) {
<a name="l00879"></a>00879           <span class="keywordtype">double</span> rel_scale = scl[lev]/scl[lev+1];
<a name="l00880"></a>00880           <span class="keywordtype">int</span> i_above = <span class="keyword">static_cast&lt;</span><span class="keywordtype">int</span><span class="keyword">&gt;</span>(rel_scale * i);
<a name="l00881"></a>00881           <span class="keywordtype">int</span> j_above = <span class="keyword">static_cast&lt;</span><span class="keywordtype">int</span><span class="keyword">&gt;</span>(rel_scale * j);
<a name="l00882"></a>00882 
<a name="l00883"></a>00883           prev_org = ray_pyr[lev+1][j_above][i_above].origin();
<a name="l00884"></a>00884           <a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__vector__3d.html">vgl_vector_3d&lt;double&gt;</a> prev_dir = ray_pyr[lev+1][j_above][i_above].direction();
<a name="l00885"></a>00885           <span class="comment">// find endpoint</span>
<a name="l00886"></a>00886           <span class="keywordtype">double</span> ray_len = (local_z_min - prev_org.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__3d.html#a477066fab00b63b2641305fb7e41fb62">z</a>()) / prev_dir.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__vector__3d.html#aa655643683e63092c938ea6f2b4459e0">z</a>();
<a name="l00887"></a>00887           prev_endpt = prev_org + (prev_dir * ray_len);
<a name="l00888"></a>00888         }
<a name="l00889"></a>00889         <span class="keyword">const</span> <span class="keywordtype">double</span> error_tol = 0.25; <span class="comment">// allow projection error of 0.25 pixel</span>
<a name="l00890"></a>00890         <span class="keywordflow">if</span> (!<a class="code" href="classvpgl__backproject.html#a37fbaf599317f3b38cbae21037d513ef" title="Generic camera interfaces (pointer for abstract class).">vpgl_backproject::bproj_plane</a>(&amp;rat_cam, ip, high, prev_org, org, error_tol))
<a name="l00891"></a>00891           <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00892"></a>00892         <span class="keywordflow">if</span> (!<a class="code" href="classvpgl__backproject.html#a37fbaf599317f3b38cbae21037d513ef" title="Generic camera interfaces (pointer for abstract class).">vpgl_backproject::bproj_plane</a>(&amp;rat_cam, ip, low, prev_endpt, endpt, error_tol))
<a name="l00893"></a>00893           <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00894"></a>00894 <span class="preprocessor">#else // 0</span>
<a name="l00895"></a>00895 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (!<a class="code" href="classvpgl__backproject.html#a37fbaf599317f3b38cbae21037d513ef" title="Generic camera interfaces (pointer for abstract class).">vpgl_backproject::bproj_plane</a>(&amp;rat_cam, ip, high, <a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__3d.html">vgl_point_3d&lt;double&gt;</a>(0.0,0.0,0.0), org))
<a name="l00896"></a>00896           <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00897"></a>00897         <span class="keywordflow">if</span> (!<a class="code" href="classvpgl__backproject.html#a37fbaf599317f3b38cbae21037d513ef" title="Generic camera interfaces (pointer for abstract class).">vpgl_backproject::bproj_plane</a>(&amp;rat_cam, ip, low, <a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__3d.html">vgl_point_3d&lt;double&gt;</a>(0.0,0.0,0.0), endpt))
<a name="l00898"></a>00898           <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00899"></a>00899 <span class="preprocessor">#endif</span>
<a name="l00900"></a>00900 <span class="preprocessor"></span>        <a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__vector__3d.html">vgl_vector_3d&lt;double&gt;</a> dir = endpt-org;
<a name="l00901"></a>00901         ray_pyr[lev][j][i].<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__3d.html#a9214f0889950e12c7db9dfc6fbbcdd1a">set</a>(org, dir);
<a name="l00902"></a>00902       }
<a name="l00903"></a>00903     }
<a name="l00904"></a>00904 
<a name="l00905"></a>00905     <span class="comment">// check for interpolation accuracy at the current level</span>
<a name="l00906"></a>00906     <span class="comment">// scan through the array and find largest discrepancy in</span>
<a name="l00907"></a>00907     <span class="comment">// ray origin and ray direction</span>
<a name="l00908"></a>00908     need_interp = <span class="keyword">false</span>;
<a name="l00909"></a>00909     max_org_err = 0.0; max_ang_err = 0.0;
<a name="l00910"></a>00910     vcl_vector&lt;vgl_ray_3d&lt;double&gt; &gt; ray_nbrs(4);
<a name="l00911"></a>00911     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j =1; j&lt;(nr[lev]-1)&amp;&amp;!need_interp; ++j) {
<a name="l00912"></a>00912       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i =1;(i&lt;nc[lev]-1)&amp;&amp;!need_interp; ++i) {
<a name="l00913"></a>00913         <a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__ray__3d.html">vgl_ray_3d&lt;double&gt;</a> ray = ray_pyr[lev][j][i];
<a name="l00914"></a>00914         <span class="comment">//</span>
<a name="l00915"></a>00915         <span class="comment">//collect 4-neighbors of ray</span>
<a name="l00916"></a>00916         <span class="comment">//</span>
<a name="l00917"></a>00917         <span class="comment">//        0</span>
<a name="l00918"></a>00918         <span class="comment">//      1 x 2</span>
<a name="l00919"></a>00919         <span class="comment">//        3</span>
<a name="l00920"></a>00920         <span class="comment">//</span>
<a name="l00921"></a>00921         ray_nbrs[0]=ray_pyr[lev][j-1][i];
<a name="l00922"></a>00922         ray_nbrs[1]=ray_pyr[lev][j][i-1];
<a name="l00923"></a>00923         ray_nbrs[2]=ray_pyr[lev][j][i+1];
<a name="l00924"></a>00924         ray_nbrs[3]=ray_pyr[lev][j+1][i];
<a name="l00925"></a>00925         <span class="comment">//interpolate using neighbors</span>
<a name="l00926"></a>00926         <a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__ray__3d.html">vgl_ray_3d&lt;double&gt;</a> intp_ray;
<a name="l00927"></a>00927         <span class="keywordflow">if</span> (!interp_ray(ray_nbrs, intp_ray))
<a name="l00928"></a>00928           <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00929"></a>00929         <span class="keywordtype">double</span> dorg = (ray.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__ray__3d.html#ad4ea7c060cf71c338578456a98a162d1">origin</a>()-intp_ray.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__ray__3d.html#ad4ea7c060cf71c338578456a98a162d1">origin</a>()).<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/vgl__vector__2d_8h.html#a31c7db8164e71d411a1a821525102dc3">length</a>();
<a name="l00930"></a>00930         <span class="keywordtype">double</span> dang = <a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/vgl__ray__3d_8h.html#ae53346bdf60e6149c8a61547e0cd38e8">angle</a>(ray.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__ray__3d.html#ac1194361067f4de72511417e3e380168">direction</a>(), intp_ray.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__ray__3d.html#ac1194361067f4de72511417e3e380168">direction</a>());
<a name="l00931"></a>00931         <span class="keywordflow">if</span> (dorg&gt;max_org_err) max_org_err = dorg;
<a name="l00932"></a>00932         <span class="keywordflow">if</span> (dang&gt;max_ang_err) max_ang_err = dang;
<a name="l00933"></a>00933         need_interp = max_org_err&gt;org_tol || max_ang_err&gt;ang_tol;
<a name="l00934"></a>00934       }
<a name="l00935"></a>00935     }
<a name="l00936"></a>00936   }
<a name="l00937"></a>00937   <span class="comment">// found level where interpolation is within tolerance</span>
<a name="l00938"></a>00938   <span class="comment">// fill in values at lower levels</span>
<a name="l00939"></a>00939   <span class="keywordflow">for</span> (++lev; lev&gt;0; --lev) {
<a name="l00940"></a>00940     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> ncr = nc[lev];
<a name="l00941"></a>00941     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> nrb = nr[lev];
<a name="l00942"></a>00942     <a class="codeRef" doxygen="core_vbl.tag:../../../core/vbl/html/" href="../../../core/vbl/html/classvbl__array__2d.html">vbl_array_2d&lt;vgl_ray_3d&lt;double&gt;</a> &gt;&amp; clev = ray_pyr[lev];
<a name="l00943"></a>00943     <a class="codeRef" doxygen="core_vbl.tag:../../../core/vbl/html/" href="../../../core/vbl/html/classvbl__array__2d.html">vbl_array_2d&lt;vgl_ray_3d&lt;double&gt;</a> &gt;&amp; nlev = ray_pyr[lev-1];
<a name="l00944"></a>00944     vcl_vector&lt;vgl_ray_3d&lt;double&gt; &gt; ray_nbrs(4);
<a name="l00945"></a>00945     vcl_vector&lt;vgl_ray_3d&lt;double&gt; &gt; interp_rays(4);
<a name="l00946"></a>00946     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j = 0; j&lt;nrb; ++j)
<a name="l00947"></a>00947       <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i&lt;ncr; ++i) {
<a name="l00948"></a>00948         ray_nbrs[0] = clev[j][i];
<a name="l00949"></a>00949         ray_nbrs[1] = clev[j][i];
<a name="l00950"></a>00950         ray_nbrs[2] = clev[j][i];
<a name="l00951"></a>00951         ray_nbrs[3] = clev[j][i];
<a name="l00952"></a>00952         <span class="keywordflow">if</span> (i+1&lt;ncr) ray_nbrs[1] = clev[j][i+1];
<a name="l00953"></a>00953         <span class="keywordflow">if</span> (j+1&lt;nrb) ray_nbrs[2] = clev[j+1][i];
<a name="l00954"></a>00954         <span class="keywordflow">if</span> (i+1&lt;ncr &amp;&amp; j+1&lt;nrb) ray_nbrs[3] = clev[j+1][i+1];
<a name="l00955"></a>00955         <span class="keywordflow">if</span> (!<a class="code" href="classvpgl__generic__camera__convert.html#a4bd35d98f89c110cd45c1b7fdca47786" title="interpolate rays to fill next higher resolution pyramid layer.">upsample_rays</a>(ray_nbrs, clev[j][i], interp_rays))
<a name="l00956"></a>00956           <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00957"></a>00957         <span class="keywordflow">if</span> (2*i&lt;nlev.<a class="codeRef" doxygen="core_vbl.tag:../../../core/vbl/html/" href="../../../core/vbl/html/classvbl__array__2d.html#a5d1d6d4ecc26eff6b99e456078924be6">cols</a>() &amp;&amp; 2*j&lt;nlev.<a class="codeRef" doxygen="core_vbl.tag:../../../core/vbl/html/" href="../../../core/vbl/html/classvbl__array__2d.html#abe25ab10299a0b1c6a075895bfb85fe6">rows</a>())
<a name="l00958"></a>00958         {
<a name="l00959"></a>00959           nlev[2*j][2*i]    =interp_rays[0];
<a name="l00960"></a>00960           <span class="keywordflow">if</span> (2*i+1&lt;nlev.<a class="codeRef" doxygen="core_vbl.tag:../../../core/vbl/html/" href="../../../core/vbl/html/classvbl__array__2d.html#a5d1d6d4ecc26eff6b99e456078924be6">cols</a>())                      nlev[2*j][2*i+1]  =interp_rays[1];
<a name="l00961"></a>00961           <span class="keywordflow">if</span> (2*j+1&lt;nlev.<a class="codeRef" doxygen="core_vbl.tag:../../../core/vbl/html/" href="../../../core/vbl/html/classvbl__array__2d.html#abe25ab10299a0b1c6a075895bfb85fe6">rows</a>())                      nlev[2*j+1][2*i]  =interp_rays[2];
<a name="l00962"></a>00962           <span class="keywordflow">if</span> (2*i+1&lt;nlev.<a class="codeRef" doxygen="core_vbl.tag:../../../core/vbl/html/" href="../../../core/vbl/html/classvbl__array__2d.html#a5d1d6d4ecc26eff6b99e456078924be6">cols</a>() &amp;&amp; 2*j+1&lt;nlev.<a class="codeRef" doxygen="core_vbl.tag:../../../core/vbl/html/" href="../../../core/vbl/html/classvbl__array__2d.html#abe25ab10299a0b1c6a075895bfb85fe6">rows</a>()) nlev[2*j+1][2*i+1]=interp_rays[3];
<a name="l00963"></a>00963         }
<a name="l00964"></a>00964       }
<a name="l00965"></a>00965   }
<a name="l00966"></a>00966   <span class="keywordflow">if</span> ((<span class="keywordtype">int</span>)level &lt; n_levels) {
<a name="l00967"></a>00967     gen_cam = <a class="code" href="classvpgl__generic__camera.html">vpgl_generic_camera&lt;double&gt;</a>(ray_pyr[level]);
<a name="l00968"></a>00968     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00969"></a>00969   }
<a name="l00970"></a>00970   <span class="keywordflow">else</span>
<a name="l00971"></a>00971     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00972"></a>00972 }
<a name="l00973"></a>00973 
<a name="l00974"></a>00974 <span class="keywordtype">bool</span> <a class="code" href="classvpgl__generic__camera__convert.html#af7ce4b0bc0f3a26713743c670cdf384d" title="Convert a local rational camera to a generic camera.">vpgl_generic_camera_convert::</a>
<a name="l00975"></a><a class="code" href="classvpgl__generic__camera__convert.html#a37e79c703c7fcd8fc039914f82ae70f6">00975</a> <a class="code" href="classvpgl__generic__camera__convert.html#af7ce4b0bc0f3a26713743c670cdf384d" title="Convert a local rational camera to a generic camera.">convert</a>( <a class="code" href="classvpgl__proj__camera.html">vpgl_proj_camera&lt;double&gt;</a> <span class="keyword">const</span>&amp; prj_cam, <span class="keywordtype">int</span> ni, <span class="keywordtype">int</span> nj,
<a name="l00976"></a>00976          <a class="code" href="classvpgl__generic__camera.html">vpgl_generic_camera&lt;double&gt;</a> &amp; gen_cam, <span class="keywordtype">unsigned</span> level)
<a name="l00977"></a>00977 {
<a name="l00978"></a>00978   <a class="codeRef" doxygen="core_vbl.tag:../../../core/vbl/html/" href="../../../core/vbl/html/classvbl__array__2d.html">vbl_array_2d&lt;vgl_ray_3d&lt;double&gt;</a> &gt; rays(nj, ni);
<a name="l00979"></a>00979   <a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__ray__3d.html">vgl_ray_3d&lt;double&gt;</a> ray;
<a name="l00980"></a>00980   <a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__homg__point__2d.html">vgl_homg_point_2d&lt;double&gt;</a> ipt;
<a name="l00981"></a>00981   <span class="keywordtype">double</span> scale = (level &lt; 32) ? <span class="keywordtype">double</span>(1L&lt;&lt;level) : vcl_pow(2.0,static_cast&lt;double&gt;(level));
<a name="l00982"></a>00982   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = 0; j&lt;nj; ++j)
<a name="l00983"></a>00983     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i&lt;ni; ++i) {
<a name="l00984"></a>00984       ipt.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__homg__point__2d.html#ad09a7a39599211ec304cfcaa3e98ff17">set</a>(i*scale, j*scale, 1.0);
<a name="l00985"></a>00985       ray = prj_cam.<a class="code" href="classvpgl__proj__camera.html#a38a3490e6224c01a1ce771d92a8ec0d9" title="Find the 3d ray that goes through the camera center and the provided image point.">backproject_ray</a>(ipt);
<a name="l00986"></a>00986       rays[j][i]=ray;
<a name="l00987"></a>00987     }
<a name="l00988"></a>00988   gen_cam = <a class="code" href="classvpgl__generic__camera.html">vpgl_generic_camera&lt;double&gt;</a>(rays);
<a name="l00989"></a>00989   <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00990"></a>00990 }
<a name="l00991"></a>00991 
<a name="l00992"></a>00992 <span class="keywordtype">bool</span> <a class="code" href="classvpgl__generic__camera__convert.html#af7ce4b0bc0f3a26713743c670cdf384d" title="Convert a local rational camera to a generic camera.">vpgl_generic_camera_convert::</a>
<a name="l00993"></a><a class="code" href="classvpgl__generic__camera__convert.html#a80eb58c7e49d8d69b2f82a2331f2c554">00993</a> <a class="code" href="classvpgl__generic__camera__convert.html#af7ce4b0bc0f3a26713743c670cdf384d" title="Convert a local rational camera to a generic camera.">convert</a>( <a class="code" href="classvpgl__perspective__camera.html" title="This class implements the perspective camera class as described in Hartley &amp; Zisserman as a finite ca...">vpgl_perspective_camera&lt;double&gt;</a> <span class="keyword">const</span>&amp; per_cam, <span class="keywordtype">int</span> ni, <span class="keywordtype">int</span> nj,
<a name="l00994"></a>00994          <a class="code" href="classvpgl__generic__camera.html">vpgl_generic_camera&lt;double&gt;</a> &amp; gen_cam, <span class="keywordtype">unsigned</span> level)
<a name="l00995"></a>00995 {
<a name="l00996"></a>00996   <a class="codeRef" doxygen="core_vbl.tag:../../../core/vbl/html/" href="../../../core/vbl/html/classvbl__array__2d.html">vbl_array_2d&lt;vgl_ray_3d&lt;double&gt;</a> &gt; rays(nj, ni);
<a name="l00997"></a>00997   <a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__ray__3d.html">vgl_ray_3d&lt;double&gt;</a> ray;
<a name="l00998"></a>00998   <a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__homg__point__2d.html">vgl_homg_point_2d&lt;double&gt;</a> ipt;
<a name="l00999"></a>00999   <span class="keywordtype">double</span> scale = (level &lt; 32) ? <span class="keywordtype">double</span>(1L&lt;&lt;level) : vcl_pow(2.0,static_cast&lt;double&gt;(level));
<a name="l01000"></a>01000   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = 0; j&lt;nj; ++j)
<a name="l01001"></a>01001     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i&lt;ni; ++i) {
<a name="l01002"></a>01002       ipt.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__homg__point__2d.html#ad09a7a39599211ec304cfcaa3e98ff17">set</a>(i*scale, j*scale, 1.0);
<a name="l01003"></a>01003       ray = per_cam.<a class="code" href="classvpgl__perspective__camera.html#ab780b8c2f609362e889f4185b1fe6381" title="Finite ray backprojection.">backproject_ray</a>(ipt);
<a name="l01004"></a>01004       rays[j][i]=ray;
<a name="l01005"></a>01005     }
<a name="l01006"></a>01006   gen_cam = <a class="code" href="classvpgl__generic__camera.html">vpgl_generic_camera&lt;double&gt;</a>(rays);
<a name="l01007"></a>01007   <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l01008"></a>01008 }
<a name="l01009"></a>01009 
<a name="l01010"></a>01010 <span class="keywordtype">bool</span> <a class="code" href="classvpgl__generic__camera__convert.html#a42acb57fe2cfc22f87516241ebfd584b">vpgl_generic_camera_convert::</a>
<a name="l01011"></a><a class="code" href="classvpgl__generic__camera__convert.html#a42acb57fe2cfc22f87516241ebfd584b">01011</a> <a class="code" href="classvpgl__generic__camera__convert.html#a42acb57fe2cfc22f87516241ebfd584b">convert_with_margin</a>( <a class="code" href="classvpgl__perspective__camera.html" title="This class implements the perspective camera class as described in Hartley &amp; Zisserman as a finite ca...">vpgl_perspective_camera&lt;double&gt;</a> <span class="keyword">const</span>&amp; per_cam, <span class="keywordtype">int</span> ni, <span class="keywordtype">int</span> nj,
<a name="l01012"></a>01012                      <a class="code" href="classvpgl__generic__camera.html">vpgl_generic_camera&lt;double&gt;</a> &amp; gen_cam, <span class="keywordtype">int</span> margin, <span class="keywordtype">unsigned</span> level)
<a name="l01013"></a>01013 {
<a name="l01014"></a>01014   <a class="codeRef" doxygen="core_vbl.tag:../../../core/vbl/html/" href="../../../core/vbl/html/classvbl__array__2d.html">vbl_array_2d&lt;vgl_ray_3d&lt;double&gt;</a> &gt; rays(nj+2*margin, ni+2*margin);
<a name="l01015"></a>01015   <a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__ray__3d.html">vgl_ray_3d&lt;double&gt;</a> ray;
<a name="l01016"></a>01016   <a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__homg__point__2d.html">vgl_homg_point_2d&lt;double&gt;</a> ipt;
<a name="l01017"></a>01017   <span class="keywordtype">double</span> scale = (level &lt; 32) ? <span class="keywordtype">double</span>(1L&lt;&lt;level) : vcl_pow(2.0,static_cast&lt;double&gt;(level));
<a name="l01018"></a>01018   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = -margin; j&lt;nj+margin; ++j)
<a name="l01019"></a>01019     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = -margin; i&lt;ni+margin; ++i) {
<a name="l01020"></a>01020       ipt.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__homg__point__2d.html#ad09a7a39599211ec304cfcaa3e98ff17">set</a>(i*scale, j*scale, 1.0);
<a name="l01021"></a>01021       ray = per_cam.<a class="code" href="classvpgl__perspective__camera.html#ab780b8c2f609362e889f4185b1fe6381" title="Finite ray backprojection.">backproject_ray</a>(ipt);
<a name="l01022"></a>01022       rays[j+margin][i+margin]=ray;
<a name="l01023"></a>01023     }
<a name="l01024"></a>01024   gen_cam = <a class="code" href="classvpgl__generic__camera.html">vpgl_generic_camera&lt;double&gt;</a>(rays);
<a name="l01025"></a>01025   <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l01026"></a>01026 }
<a name="l01027"></a>01027 
<a name="l01028"></a>01028 
<a name="l01029"></a>01029 <span class="comment">// the affine camera defines a principal plane which is</span>
<a name="l01030"></a>01030 <span class="comment">// far enough from the scene origin so that all the scene</span>
<a name="l01031"></a>01031 <span class="comment">// geometry is in front of the plane. The backproject function</span>
<a name="l01032"></a>01032 <span class="comment">// finds constructs finite ray origins on the principal plane.</span>
<a name="l01033"></a>01033 <span class="keywordtype">bool</span> <a class="code" href="classvpgl__generic__camera__convert.html#af7ce4b0bc0f3a26713743c670cdf384d" title="Convert a local rational camera to a generic camera.">vpgl_generic_camera_convert::</a>
<a name="l01034"></a><a class="code" href="classvpgl__generic__camera__convert.html#a9775f452b1deb0a0df5f4fcfa70fc4df">01034</a> <a class="code" href="classvpgl__generic__camera__convert.html#af7ce4b0bc0f3a26713743c670cdf384d" title="Convert a local rational camera to a generic camera.">convert</a>( <a class="code" href="classvpgl__affine__camera.html">vpgl_affine_camera&lt;double&gt;</a> <span class="keyword">const</span>&amp; aff_cam, <span class="keywordtype">int</span> ni, <span class="keywordtype">int</span> nj,
<a name="l01035"></a>01035          <a class="code" href="classvpgl__generic__camera.html">vpgl_generic_camera&lt;double&gt;</a> &amp; gen_cam, <span class="keywordtype">unsigned</span> level)
<a name="l01036"></a>01036 {
<a name="l01037"></a>01037   <span class="keywordtype">double</span> scale = (level &lt; 32) ? <span class="keywordtype">double</span>(1L&lt;&lt;level) : vcl_pow(2.0,static_cast&lt;double&gt;(level));
<a name="l01038"></a>01038   <span class="comment">// is an ideal point defining the ray direction</span>
<a name="l01039"></a>01039   <a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__homg__point__3d.html">vgl_homg_point_3d&lt;double&gt;</a> cent = aff_cam.<a class="code" href="classvpgl__affine__camera.html#a3ba7d0cbd61624c175d376e83cb00767" title="Find the 3d coordinates of the center of the camera. Will be an ideal point with the sense of the ray...">camera_center</a>();
<a name="l01040"></a>01040   <a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__vector__3d.html">vgl_vector_3d&lt;double&gt;</a> dir(cent.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__homg__point__3d.html#aceac2a4dfd00dc600196eb9b9279f5fd">x</a>(), cent.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__homg__point__3d.html#a054f0d10a7c37b4aebcae08daf66c185">y</a>(), cent.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__homg__point__3d.html#a7084d86ca9aeca00cf6c9b87bc2bfc92">z</a>());
<a name="l01041"></a>01041   <a class="codeRef" doxygen="core_vbl.tag:../../../core/vbl/html/" href="../../../core/vbl/html/classvbl__array__2d.html">vbl_array_2d&lt;vgl_ray_3d&lt;double&gt;</a> &gt; rays(nj, ni);
<a name="l01042"></a>01042   <a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__homg__point__3d.html">vgl_homg_point_3d&lt;double&gt;</a> horg;
<a name="l01043"></a>01043   <a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__3d.html">vgl_point_3d&lt;double&gt;</a> org;
<a name="l01044"></a>01044   <a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__homg__point__2d.html">vgl_homg_point_2d&lt;double&gt;</a> ipt;
<a name="l01045"></a>01045   <a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__homg__line__3d__2__points.html">vgl_homg_line_3d_2_points&lt;double&gt;</a> hline;
<a name="l01046"></a>01046   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = 0; j&lt;nj; ++j)
<a name="l01047"></a>01047     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i&lt;ni; ++i) {
<a name="l01048"></a>01048       ipt.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__homg__point__2d.html#ad09a7a39599211ec304cfcaa3e98ff17">set</a>(i*scale, j*scale, 1.0);
<a name="l01049"></a>01049       hline = aff_cam.<a class="code" href="classvpgl__affine__camera.html#adc0c223996c39b13199140a966ce4a65" title="Find the 3d ray that goes through the camera center.">backproject</a>(ipt);
<a name="l01050"></a>01050       horg = hline.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__homg__line__3d__2__points.html#ae6cb92dfc72a233387f8160a7134960c">point_finite</a>();
<a name="l01051"></a>01051       org.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__3d.html#a9214f0889950e12c7db9dfc6fbbcdd1a">set</a>(horg.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__homg__point__3d.html#aceac2a4dfd00dc600196eb9b9279f5fd">x</a>()/horg.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__homg__point__3d.html#a446ca3aacd4e1a50921dba2a76403d17">w</a>(), horg.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__homg__point__3d.html#a054f0d10a7c37b4aebcae08daf66c185">y</a>()/horg.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__homg__point__3d.html#a446ca3aacd4e1a50921dba2a76403d17">w</a>(), horg.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__homg__point__3d.html#a7084d86ca9aeca00cf6c9b87bc2bfc92">z</a>()/horg.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__homg__point__3d.html#a446ca3aacd4e1a50921dba2a76403d17">w</a>());
<a name="l01052"></a>01052       rays[j][i].<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__vector__3d.html#a116e3e1800f2c00537fe08f7e544edb8">set</a>(org, dir);
<a name="l01053"></a>01053     }
<a name="l01054"></a>01054   gen_cam = <a class="code" href="classvpgl__generic__camera.html">vpgl_generic_camera&lt;double&gt;</a>(rays);
<a name="l01055"></a>01055   <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l01056"></a>01056 }
<a name="l01057"></a>01057 
<a name="l01058"></a>01058 <span class="keywordtype">bool</span> <a class="code" href="classvpgl__generic__camera__convert.html#af7ce4b0bc0f3a26713743c670cdf384d" title="Convert a local rational camera to a generic camera.">vpgl_generic_camera_convert::</a>
<a name="l01059"></a><a class="code" href="classvpgl__generic__camera__convert.html#afec69761872e41660de2ca6470d7513b">01059</a> <a class="code" href="classvpgl__generic__camera__convert.html#af7ce4b0bc0f3a26713743c670cdf384d" title="Convert a local rational camera to a generic camera.">convert</a>( <a class="codeRef" doxygen="core_vbl.tag:../../../core/vbl/html/" href="../../../core/vbl/html/classvbl__smart__ptr.html">vpgl_camera_double_sptr</a> <span class="keyword">const</span>&amp; camera, <span class="keywordtype">int</span> ni, <span class="keywordtype">int</span> nj,
<a name="l01060"></a>01060          <a class="code" href="classvpgl__generic__camera.html">vpgl_generic_camera&lt;double&gt;</a> &amp; gen_cam, <span class="keywordtype">unsigned</span> level)
<a name="l01061"></a>01061 {
<a name="l01062"></a>01062   <span class="keywordflow">if</span> (<a class="code" href="classvpgl__local__rational__camera.html">vpgl_local_rational_camera&lt;double&gt;</a>* cam =
<a name="l01063"></a>01063       <span class="keyword">dynamic_cast&lt;</span><a class="code" href="classvpgl__local__rational__camera.html">vpgl_local_rational_camera&lt;double&gt;</a>*<span class="keyword">&gt;</span>(camera.<a class="codeRef" doxygen="core_vbl.tag:../../../core/vbl/html/" href="../../../core/vbl/html/classvbl__smart__ptr.html#ac1582cca2892f1cce5a9d57f3c13a472">ptr</a>()))
<a name="l01064"></a>01064     <span class="keywordflow">return</span> <a class="code" href="classvpgl__generic__camera__convert.html#af7ce4b0bc0f3a26713743c670cdf384d" title="Convert a local rational camera to a generic camera.">vpgl_generic_camera_convert::convert</a>(*cam, ni, nj, gen_cam, level);
<a name="l01065"></a>01065 
<a name="l01066"></a>01066   <span class="keywordflow">if</span> (<a class="code" href="classvpgl__perspective__camera.html" title="This class implements the perspective camera class as described in Hartley &amp; Zisserman as a finite ca...">vpgl_perspective_camera&lt;double&gt;</a>* cam =
<a name="l01067"></a>01067     <span class="keyword">dynamic_cast&lt;</span><a class="code" href="classvpgl__perspective__camera.html" title="This class implements the perspective camera class as described in Hartley &amp; Zisserman as a finite ca...">vpgl_perspective_camera&lt;double&gt;</a>*<span class="keyword">&gt;</span>(camera.<a class="codeRef" doxygen="core_vbl.tag:../../../core/vbl/html/" href="../../../core/vbl/html/classvbl__smart__ptr.html#ac1582cca2892f1cce5a9d57f3c13a472">ptr</a>())) {
<a name="l01068"></a>01068       <span class="keywordflow">return</span> <a class="code" href="classvpgl__generic__camera__convert.html#af7ce4b0bc0f3a26713743c670cdf384d" title="Convert a local rational camera to a generic camera.">vpgl_generic_camera_convert::convert</a>(*cam, ni, nj, gen_cam, level);
<a name="l01069"></a>01069   }
<a name="l01070"></a>01070 
<a name="l01071"></a>01071   <span class="keywordflow">if</span> (<a class="code" href="classvpgl__proj__camera.html">vpgl_proj_camera&lt;double&gt;</a>* cam =
<a name="l01072"></a>01072     <span class="keyword">dynamic_cast&lt;</span><a class="code" href="classvpgl__proj__camera.html">vpgl_proj_camera&lt;double&gt;</a>*<span class="keyword">&gt;</span>(camera.<a class="codeRef" doxygen="core_vbl.tag:../../../core/vbl/html/" href="../../../core/vbl/html/classvbl__smart__ptr.html#ac1582cca2892f1cce5a9d57f3c13a472">ptr</a>())) {
<a name="l01073"></a>01073       <span class="keywordflow">return</span> <a class="code" href="classvpgl__generic__camera__convert.html#af7ce4b0bc0f3a26713743c670cdf384d" title="Convert a local rational camera to a generic camera.">vpgl_generic_camera_convert::convert</a>(*cam, ni, nj, gen_cam, level);
<a name="l01074"></a>01074   }
<a name="l01075"></a>01075 
<a name="l01076"></a>01076   <span class="keywordflow">if</span> (<a class="code" href="classvpgl__affine__camera.html">vpgl_affine_camera&lt;double&gt;</a>* cam =
<a name="l01077"></a>01077       <span class="keyword">dynamic_cast&lt;</span><a class="code" href="classvpgl__affine__camera.html">vpgl_affine_camera&lt;double&gt;</a>*<span class="keyword">&gt;</span>(camera.<a class="codeRef" doxygen="core_vbl.tag:../../../core/vbl/html/" href="../../../core/vbl/html/classvbl__smart__ptr.html#ac1582cca2892f1cce5a9d57f3c13a472">ptr</a>()))
<a name="l01078"></a>01078     <span class="keywordflow">return</span> <a class="code" href="classvpgl__generic__camera__convert.html#af7ce4b0bc0f3a26713743c670cdf384d" title="Convert a local rational camera to a generic camera.">vpgl_generic_camera_convert::convert</a>(*cam, ni, nj, gen_cam, level);
<a name="l01079"></a>01079 
<a name="l01080"></a>01080   <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01081"></a>01081 }
<a name="l01082"></a>01082 
<a name="l01083"></a>01083 <span class="comment">//: Convert a geocam (transformtaion matrix read from a geotiff header + an lvcs) to a generic camera</span>
<a name="l01084"></a><a class="code" href="classvpgl__generic__camera__convert.html#ade698826b5582271a6479d2d46bfe9de">01084</a> <span class="keywordtype">bool</span> <a class="code" href="classvpgl__generic__camera__convert.html#af7ce4b0bc0f3a26713743c670cdf384d" title="Convert a local rational camera to a generic camera.">vpgl_generic_camera_convert::convert</a>( <a class="code" href="classvpgl__geo__camera.html">vpgl_geo_camera</a>&amp; geocam, <span class="keywordtype">int</span> ni, <span class="keywordtype">int</span> nj, <span class="keywordtype">double</span> height,
<a name="l01085"></a>01085                                            <a class="code" href="classvpgl__generic__camera.html">vpgl_generic_camera&lt;double&gt;</a> &amp; gen_cam, <span class="keywordtype">unsigned</span> level)
<a name="l01086"></a>01086 {
<a name="l01087"></a>01087   <span class="keywordtype">double</span> scale = (level &lt; 32) ? <span class="keywordtype">double</span>(1L&lt;&lt;level) : vcl_pow(2.0,static_cast&lt;double&gt;(level));
<a name="l01088"></a>01088 
<a name="l01089"></a>01089   <span class="comment">//: all rays have the same direction</span>
<a name="l01090"></a>01090   <a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__vector__3d.html">vgl_vector_3d&lt;double&gt;</a> dir(0.0, 0.0, -1.0);
<a name="l01091"></a>01091 
<a name="l01092"></a>01092   <a class="codeRef" doxygen="core_vbl.tag:../../../core/vbl/html/" href="../../../core/vbl/html/classvbl__array__2d.html">vbl_array_2d&lt;vgl_ray_3d&lt;double&gt;</a> &gt; rays(nj, ni);
<a name="l01093"></a>01093   <a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__3d.html">vgl_point_3d&lt;double&gt;</a> org;
<a name="l01094"></a>01094 
<a name="l01095"></a>01095   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = 0; j&lt;nj; ++j)
<a name="l01096"></a>01096     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i&lt;ni; ++i) {
<a name="l01097"></a>01097       <span class="keywordtype">double</span> x,y,z;
<a name="l01098"></a>01098       geocam.<a class="code" href="classvpgl__geo__camera.html#a8a21f5bc5557705b51728b7229d80067" title="backprojects an image point into local coordinates (based on lvcs_).">backproject</a>(i*scale, j*scale,x,y,z);
<a name="l01099"></a>01099       org.<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__3d.html#a9214f0889950e12c7db9dfc6fbbcdd1a">set</a>(x, y, height);
<a name="l01100"></a>01100       rays[j][i].set(org, dir);
<a name="l01101"></a>01101     }
<a name="l01102"></a>01102   gen_cam = <a class="code" href="classvpgl__generic__camera.html">vpgl_generic_camera&lt;double&gt;</a>(rays);
<a name="l01103"></a>01103   <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l01104"></a>01104 }
<a name="l01105"></a>01105 
<a name="l01106"></a>01106 
<a name="l01107"></a>01107 <span class="preprocessor">#endif // vpgl_camera_convert_cxx_</span>
</pre></div></div>
</div>


<hr class="footer"/><address class="footer"><small>
Generated on Wed May 1 2013 17:32:16 for core/vpgl by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.7.5.1
</small></address>

</body>
</html>
