<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
"http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
  <title>core/vpgl/algo/vpgl_bundle_adjust_lsqr.cxx Source File</title>
  <link href="doxygen.css" rel="stylesheet" type="text/css" />
  <link href="tabs.css" rel="stylesheet" type="text/css" />
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
</head>
<body>
<!-- Generated by Doxygen 1.7.5.1 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<div class="title">core/vpgl/algo/vpgl_bundle_adjust_lsqr.cxx</div>  </div>
</div>
<div class="contents">
<a href="vpgl__bundle__adjust__lsqr_8cxx.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">// This is vpgl/algo/vpgl_bundle_adjust_lsqr.cxx</span>
<a name="l00002"></a>00002 <span class="preprocessor">#include &quot;<a class="code" href="vpgl__bundle__adjust__lsqr_8h.html" title="Bundle adjustment sparse least squares base class.">vpgl_bundle_adjust_lsqr.h</a>&quot;</span>
<a name="l00003"></a>00003 <span class="comment">//:</span>
<a name="l00004"></a>00004 <span class="comment">// \file</span>
<a name="l00005"></a>00005 
<a name="l00006"></a>00006 <span class="preprocessor">#include &lt;<a class="codeRef" doxygen="core_vnl.tag:../../../core/vnl/html/" href="../../../core/vnl/html/vnl__vector__ref_8h.html">vnl/vnl_vector_ref.h</a>&gt;</span>
<a name="l00007"></a>00007 <span class="preprocessor">#include &lt;<a class="codeRef" doxygen="core_vnl.tag:../../../core/vnl/html/" href="../../../core/vnl/html/vnl__double__3_8h.html">vnl/vnl_double_3.h</a>&gt;</span>
<a name="l00008"></a>00008 
<a name="l00009"></a>00009 <span class="preprocessor">#include &lt;vcl_iostream.h&gt;</span>
<a name="l00010"></a>00010 <span class="preprocessor">#include &lt;vcl_algorithm.h&gt;</span>
<a name="l00011"></a>00011 <span class="preprocessor">#include &lt;vcl_cassert.h&gt;</span>
<a name="l00012"></a>00012 
<a name="l00013"></a>00013 
<a name="l00014"></a>00014 <span class="comment">//: Constructor</span>
<a name="l00015"></a>00015 <a class="code" href="classvpgl__bundle__adjust__lsqr.html#a321a36739a9befb9bf48a11bf7881e00" title="Constructor.">vpgl_bundle_adjust_lsqr::</a>
<a name="l00016"></a><a class="code" href="classvpgl__bundle__adjust__lsqr.html#a321a36739a9befb9bf48a11bf7881e00">00016</a> <a class="code" href="classvpgl__bundle__adjust__lsqr.html#a321a36739a9befb9bf48a11bf7881e00" title="Constructor.">vpgl_bundle_adjust_lsqr</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> num_params_per_a,
<a name="l00017"></a>00017                         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> num_params_per_b,
<a name="l00018"></a>00018                         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> num_params_c,
<a name="l00019"></a>00019                         <span class="keyword">const</span> vcl_vector&lt;<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__2d.html">vgl_point_2d&lt;double&gt;</a> &gt;&amp; image_points,
<a name="l00020"></a>00020                         <span class="keyword">const</span> vcl_vector&lt;vcl_vector&lt;bool&gt; &gt;&amp; mask)
<a name="l00021"></a>00021  : <a class="codeRef" doxygen="core_vnl.tag:../../../core/vnl/html/" href="../../../core/vnl/html/classvnl__sparse__lst__sqr__function.html">vnl_sparse_lst_sqr_function</a>(mask.size(),num_params_per_a,
<a name="l00022"></a>00022                                mask[0].size(),num_params_per_b,
<a name="l00023"></a>00023                                num_params_c,mask,2,use_gradient,use_weights),
<a name="l00024"></a>00024    image_points_(image_points),
<a name="l00025"></a>00025    use_covars_(false),
<a name="l00026"></a>00026    scale2_(1.0),
<a name="l00027"></a>00027    iteration_count_(0)
<a name="l00028"></a>00028 {
<a name="l00029"></a>00029 }
<a name="l00030"></a>00030 
<a name="l00031"></a>00031 
<a name="l00032"></a>00032 <span class="comment">//: Constructor</span>
<a name="l00033"></a>00033 <span class="comment">//  Each image point is assigned an inverse covariance (error projector) matrix</span>
<a name="l00034"></a>00034 <span class="comment">// \note image points are not homogeneous because they require finite points to</span>
<a name="l00035"></a>00035 <span class="comment">//       measure projection error</span>
<a name="l00036"></a>00036 <a class="code" href="classvpgl__bundle__adjust__lsqr.html#a321a36739a9befb9bf48a11bf7881e00" title="Constructor.">vpgl_bundle_adjust_lsqr::</a>
<a name="l00037"></a><a class="code" href="classvpgl__bundle__adjust__lsqr.html#a6fc5499db6688b47e9140e8d5cf082c8">00037</a> <a class="code" href="classvpgl__bundle__adjust__lsqr.html#a321a36739a9befb9bf48a11bf7881e00" title="Constructor.">vpgl_bundle_adjust_lsqr</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> num_params_per_a,
<a name="l00038"></a>00038                         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> num_params_per_b,
<a name="l00039"></a>00039                         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> num_params_c,
<a name="l00040"></a>00040                         <span class="keyword">const</span> vcl_vector&lt;<a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/classvgl__point__2d.html">vgl_point_2d&lt;double&gt;</a> &gt;&amp; image_points,
<a name="l00041"></a>00041                         <span class="keyword">const</span> vcl_vector&lt;<a class="codeRef" doxygen="core_vnl.tag:../../../core/vnl/html/" href="../../../core/vnl/html/classvnl__matrix.html">vnl_matrix&lt;double&gt;</a> &gt;&amp; inv_covars,
<a name="l00042"></a>00042                         <span class="keyword">const</span> vcl_vector&lt;vcl_vector&lt;bool&gt; &gt;&amp; mask)
<a name="l00043"></a>00043  : <a class="codeRef" doxygen="core_vnl.tag:../../../core/vnl/html/" href="../../../core/vnl/html/classvnl__sparse__lst__sqr__function.html">vnl_sparse_lst_sqr_function</a>(mask.size(),num_params_per_a,
<a name="l00044"></a>00044                                mask[0].size(),num_params_per_b,
<a name="l00045"></a>00045                                num_params_c,mask,2,use_gradient,use_weights),
<a name="l00046"></a>00046    image_points_(image_points),
<a name="l00047"></a>00047    use_covars_(true),
<a name="l00048"></a>00048    scale2_(1.0),
<a name="l00049"></a>00049    iteration_count_(0)
<a name="l00050"></a>00050 {
<a name="l00051"></a>00051   assert(image_points.size() == inv_covars.size());
<a name="l00052"></a>00052   <a class="codeRef" doxygen="core_vnl.tag:../../../core/vnl/html/" href="../../../core/vnl/html/classvnl__matrix.html">vnl_matrix&lt;double&gt;</a> U(2,2,0.0);
<a name="l00053"></a>00053   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> i=0; i&lt;inv_covars.size(); ++i)
<a name="l00054"></a>00054   {
<a name="l00055"></a>00055     <span class="keyword">const</span> <a class="codeRef" doxygen="core_vnl.tag:../../../core/vnl/html/" href="../../../core/vnl/html/classvnl__matrix.html">vnl_matrix&lt;double&gt;</a>&amp; S = inv_covars[i];
<a name="l00056"></a>00056     <span class="keywordflow">if</span> (S(0,0) &gt; 0.0) {
<a name="l00057"></a>00057       U(0,0) = vcl_sqrt(S(0,0));
<a name="l00058"></a>00058       U(0,1) = S(0,1)/U(0,0);
<a name="l00059"></a>00059       <span class="keywordtype">double</span> U11 = S(1,1)-S(0,1)*S(0,1)/S(0,0);
<a name="l00060"></a>00060       U(1,1) = (U11&gt;0.0)?vcl_sqrt(U11):0.0;
<a name="l00061"></a>00061     }
<a name="l00062"></a>00062     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (S(1,1) &gt; 0.0) {
<a name="l00063"></a>00063       assert(S(0,1) == 0.0);
<a name="l00064"></a>00064       U(0,0) = 0.0;
<a name="l00065"></a>00065       U(0,1) = 0.0;
<a name="l00066"></a>00066       U(1,1) = vcl_sqrt(S(1,1));
<a name="l00067"></a>00067     }
<a name="l00068"></a>00068     <span class="keywordflow">else</span> {
<a name="l00069"></a>00069       vcl_cout &lt;&lt; <span class="stringliteral">&quot;warning: not positive definite&quot;</span>&lt;&lt;vcl_endl;
<a name="l00070"></a>00070       U.fill(0.0);
<a name="l00071"></a>00071     }
<a name="l00072"></a>00072     <a class="code" href="classvpgl__bundle__adjust__lsqr.html#ae78d890799ebc552dc1d563f916e81c6" title="The Cholesky factored inverse covariances for each image point.">factored_inv_covars_</a>.push_back(U);
<a name="l00073"></a>00073   }
<a name="l00074"></a>00074 }
<a name="l00075"></a>00075 
<a name="l00076"></a>00076 
<a name="l00077"></a>00077 <span class="comment">//: Compute all the reprojection errors</span>
<a name="l00078"></a>00078 <span class="comment">//  Given the parameter vectors a, b, and c, compute the vector of residuals e.</span>
<a name="l00079"></a>00079 <span class="comment">//  e has been sized appropriately before the call.</span>
<a name="l00080"></a>00080 <span class="comment">//  The parameters in a for each camera are {wx, wy, wz, tx, ty, tz}</span>
<a name="l00081"></a>00081 <span class="comment">//  where w is the Rodrigues vector of the rotation and t is the translation.</span>
<a name="l00082"></a>00082 <span class="comment">//  The parameters in b for each 3D point are {px, py, pz}</span>
<a name="l00083"></a>00083 <span class="comment">//  the non-homogeneous position.</span>
<a name="l00084"></a>00084 <span class="keywordtype">void</span>
<a name="l00085"></a><a class="code" href="classvpgl__bundle__adjust__lsqr.html#aa8781a654fdc26e61c8a1403efec5bc2">00085</a> <a class="code" href="classvpgl__bundle__adjust__lsqr.html#aa8781a654fdc26e61c8a1403efec5bc2" title="Compute all the reprojection errors.">vpgl_bundle_adjust_lsqr::f</a>(<a class="codeRef" doxygen="core_vnl.tag:../../../core/vnl/html/" href="../../../core/vnl/html/classvnl__vector.html">vnl_vector&lt;double&gt;</a> <span class="keyword">const</span>&amp; a,
<a name="l00086"></a>00086                            <a class="codeRef" doxygen="core_vnl.tag:../../../core/vnl/html/" href="../../../core/vnl/html/classvnl__vector.html">vnl_vector&lt;double&gt;</a> <span class="keyword">const</span>&amp; b,
<a name="l00087"></a>00087                            <a class="codeRef" doxygen="core_vnl.tag:../../../core/vnl/html/" href="../../../core/vnl/html/classvnl__vector.html">vnl_vector&lt;double&gt;</a> <span class="keyword">const</span>&amp; c,
<a name="l00088"></a>00088                            <a class="codeRef" doxygen="core_vnl.tag:../../../core/vnl/html/" href="../../../core/vnl/html/classvnl__vector.html">vnl_vector&lt;double&gt;</a>&amp; e)
<a name="l00089"></a>00089 {
<a name="l00090"></a>00090   <span class="keyword">typedef</span> vnl_crs_index::sparse_vector::iterator sv_itr;
<a name="l00091"></a>00091   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i=0; i&lt;<a class="codeRef" doxygen="core_vnl.tag:../../../core/vnl/html/" href="../../../core/vnl/html/classvnl__sparse__lst__sqr__function.html#a428a60bdd3d570cf65830e023098e326">number_of_a</a>(); ++i)
<a name="l00092"></a>00092   {
<a name="l00093"></a>00093     <span class="comment">//: Construct the ith camera</span>
<a name="l00094"></a>00094     <a class="codeRef" doxygen="core_vnl.tag:../../../core/vnl/html/" href="../../../core/vnl/html/vnl__double__3x4_8h.html#af8f70e1a680571bb6a7064d7ab37e805">vnl_double_3x4</a> Pi = <a class="code" href="classvpgl__bundle__adjust__lsqr.html#a8cb230e10231dd8cfc17b33f3b478b96" title="construct the">param_to_cam_matrix</a>(i,a,c);
<a name="l00095"></a>00095 
<a name="l00096"></a>00096     <a class="codeRef" doxygen="core_vnl.tag:../../../core/vnl/html/" href="../../../core/vnl/html/classvnl__crs__index.html#a015af1612c1409408234e2b9c7771ba2">vnl_crs_index::sparse_vector</a> row = <a class="codeRef" doxygen="core_vnl.tag:../../../core/vnl/html/" href="../../../core/vnl/html/classvnl__sparse__lst__sqr__function.html#a77c2fb0d7101cc684355b3864986245a">residual_indices_</a>.<a class="codeRef" doxygen="core_vnl.tag:../../../core/vnl/html/" href="../../../core/vnl/html/classvnl__crs__index.html#a1d1773106f6efda2257dc21f95d3a13c">sparse_row</a>(i);
<a name="l00097"></a>00097     <span class="keywordflow">for</span> (sv_itr r_itr=row.begin(); r_itr!=row.end(); ++r_itr)
<a name="l00098"></a>00098     {
<a name="l00099"></a>00099       <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j = r_itr-&gt;second;
<a name="l00100"></a>00100       <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> k = r_itr-&gt;first;
<a name="l00101"></a>00101 
<a name="l00102"></a>00102       <span class="comment">// Construct the jth point</span>
<a name="l00103"></a>00103       <a class="codeRef" doxygen="core_vnl.tag:../../../core/vnl/html/" href="../../../core/vnl/html/classvnl__vector__fixed.html">vnl_vector_fixed&lt;double,4&gt;</a> Xj = <a class="code" href="classvpgl__bundle__adjust__lsqr.html#a78f3936fe6b531c4d967858a8e946eaa" title="construct the">param_to_pt_vector</a>(j,b,c);
<a name="l00104"></a>00104 
<a name="l00105"></a>00105       <span class="comment">// Project jth point with the ith camera</span>
<a name="l00106"></a>00106       <a class="codeRef" doxygen="core_vnl.tag:../../../core/vnl/html/" href="../../../core/vnl/html/classvnl__vector__fixed.html">vnl_vector_fixed&lt;double,3&gt;</a> xij = Pi*Xj;
<a name="l00107"></a>00107 
<a name="l00108"></a>00108       <span class="keywordtype">double</span>* eij = e.<a class="codeRef" doxygen="core_vnl.tag:../../../core/vnl/html/" href="../../../core/vnl/html/classvnl__vector.html#a672822d3a059ac09909cb32a7be004a9">data_block</a>()+<a class="codeRef" doxygen="core_vnl.tag:../../../core/vnl/html/" href="../../../core/vnl/html/classvnl__sparse__lst__sqr__function.html#a2c743c05572c84195e9228e7ce60cc1c">index_e</a>(k);
<a name="l00109"></a>00109       eij[0] = xij[0]/xij[2] - <a class="code" href="classvpgl__bundle__adjust__lsqr.html#a8414b43eeef8a046697f19200ce9f69b" title="The corresponding points in the image.">image_points_</a>[k].x();
<a name="l00110"></a>00110       eij[1] = xij[1]/xij[2] - <a class="code" href="classvpgl__bundle__adjust__lsqr.html#a8414b43eeef8a046697f19200ce9f69b" title="The corresponding points in the image.">image_points_</a>[k].y();
<a name="l00111"></a>00111       <span class="keywordflow">if</span> (<a class="code" href="classvpgl__bundle__adjust__lsqr.html#a9f6115b617536cc3a4e76ad16486ebe6" title="Flag to enable covariance weighted errors.">use_covars_</a>){
<a name="l00112"></a>00112         <span class="comment">// multiple this error by upper triangular Sij</span>
<a name="l00113"></a>00113         <span class="keyword">const</span> <a class="codeRef" doxygen="core_vnl.tag:../../../core/vnl/html/" href="../../../core/vnl/html/classvnl__matrix.html">vnl_matrix&lt;double&gt;</a>&amp; Sij = <a class="code" href="classvpgl__bundle__adjust__lsqr.html#ae78d890799ebc552dc1d563f916e81c6" title="The Cholesky factored inverse covariances for each image point.">factored_inv_covars_</a>[k];
<a name="l00114"></a>00114         eij[0] *= Sij(0,0);
<a name="l00115"></a>00115         eij[0] += eij[1]*Sij(0,1);
<a name="l00116"></a>00116         eij[1] *= Sij(1,1);
<a name="l00117"></a>00117       }
<a name="l00118"></a>00118     }
<a name="l00119"></a>00119   }
<a name="l00120"></a>00120 }
<a name="l00121"></a>00121 
<a name="l00122"></a>00122 
<a name="l00123"></a>00123 <span class="comment">//: Compute the residuals from the ith component of a and the jth component of b.</span>
<a name="l00124"></a>00124 <span class="comment">//  This is not normally used because f() has a self-contained efficient implementation</span>
<a name="l00125"></a>00125 <span class="comment">//  It is used for finite-differencing if the gradient is marked as unavailable</span>
<a name="l00126"></a>00126 <span class="keywordtype">void</span>
<a name="l00127"></a><a class="code" href="classvpgl__bundle__adjust__lsqr.html#af1c3c515439c505b0f6e62b3b0a11f58">00127</a> <a class="code" href="classvpgl__bundle__adjust__lsqr.html#af1c3c515439c505b0f6e62b3b0a11f58" title="Compute the residuals from the ith component of a, the jth component of b, and all of c...">vpgl_bundle_adjust_lsqr::fij</a>(<span class="keywordtype">int</span> i, <span class="keywordtype">int</span> j,
<a name="l00128"></a>00128                              <a class="codeRef" doxygen="core_vnl.tag:../../../core/vnl/html/" href="../../../core/vnl/html/classvnl__vector.html">vnl_vector&lt;double&gt;</a> <span class="keyword">const</span>&amp; ai,
<a name="l00129"></a>00129                              <a class="codeRef" doxygen="core_vnl.tag:../../../core/vnl/html/" href="../../../core/vnl/html/classvnl__vector.html">vnl_vector&lt;double&gt;</a> <span class="keyword">const</span>&amp; bj,
<a name="l00130"></a>00130                              <a class="codeRef" doxygen="core_vnl.tag:../../../core/vnl/html/" href="../../../core/vnl/html/classvnl__vector.html">vnl_vector&lt;double&gt;</a> <span class="keyword">const</span>&amp; c,
<a name="l00131"></a>00131                              <a class="codeRef" doxygen="core_vnl.tag:../../../core/vnl/html/" href="../../../core/vnl/html/classvnl__vector.html">vnl_vector&lt;double&gt;</a>&amp; fij)
<a name="l00132"></a>00132 {
<a name="l00133"></a>00133   <span class="comment">//: Construct the ith camera</span>
<a name="l00134"></a>00134   <a class="codeRef" doxygen="core_vnl.tag:../../../core/vnl/html/" href="../../../core/vnl/html/vnl__double__3x4_8h.html#af8f70e1a680571bb6a7064d7ab37e805">vnl_double_3x4</a> Pi = <a class="code" href="classvpgl__bundle__adjust__lsqr.html#a8cb230e10231dd8cfc17b33f3b478b96" title="construct the">param_to_cam_matrix</a>(i,ai.<a class="codeRef" doxygen="core_vnl.tag:../../../core/vnl/html/" href="../../../core/vnl/html/classvnl__vector.html#a672822d3a059ac09909cb32a7be004a9">data_block</a>(),c);
<a name="l00135"></a>00135 
<a name="l00136"></a>00136   <span class="comment">// Construct the jth point</span>
<a name="l00137"></a>00137   <a class="codeRef" doxygen="core_vnl.tag:../../../core/vnl/html/" href="../../../core/vnl/html/classvnl__vector__fixed.html">vnl_vector_fixed&lt;double,4&gt;</a> Xj = <a class="code" href="classvpgl__bundle__adjust__lsqr.html#a78f3936fe6b531c4d967858a8e946eaa" title="construct the">param_to_pt_vector</a>(j,bj.<a class="codeRef" doxygen="core_vnl.tag:../../../core/vnl/html/" href="../../../core/vnl/html/classvnl__vector.html#a672822d3a059ac09909cb32a7be004a9">data_block</a>(),c);
<a name="l00138"></a>00138 
<a name="l00139"></a>00139   <span class="comment">// Project jth point with the ith camera</span>
<a name="l00140"></a>00140   <a class="codeRef" doxygen="core_vnl.tag:../../../core/vnl/html/" href="../../../core/vnl/html/classvnl__vector__fixed.html">vnl_vector_fixed&lt;double,3&gt;</a> xij = Pi*Xj;
<a name="l00141"></a>00141 
<a name="l00142"></a>00142   <span class="keywordtype">int</span> k = <a class="codeRef" doxygen="core_vnl.tag:../../../core/vnl/html/" href="../../../core/vnl/html/classvnl__sparse__lst__sqr__function.html#a77c2fb0d7101cc684355b3864986245a">residual_indices_</a>(i,j);
<a name="l00143"></a>00143   fij[0] = xij[0]/xij[2] - <a class="code" href="classvpgl__bundle__adjust__lsqr.html#a8414b43eeef8a046697f19200ce9f69b" title="The corresponding points in the image.">image_points_</a>[k].x();
<a name="l00144"></a>00144   fij[1] = xij[1]/xij[2] - <a class="code" href="classvpgl__bundle__adjust__lsqr.html#a8414b43eeef8a046697f19200ce9f69b" title="The corresponding points in the image.">image_points_</a>[k].y();
<a name="l00145"></a>00145   <span class="keywordflow">if</span> (<a class="code" href="classvpgl__bundle__adjust__lsqr.html#a9f6115b617536cc3a4e76ad16486ebe6" title="Flag to enable covariance weighted errors.">use_covars_</a>){
<a name="l00146"></a>00146     <span class="comment">// multiple this error by upper triangular Sij</span>
<a name="l00147"></a>00147     <span class="keyword">const</span> <a class="codeRef" doxygen="core_vnl.tag:../../../core/vnl/html/" href="../../../core/vnl/html/classvnl__matrix.html">vnl_matrix&lt;double&gt;</a>&amp; Sij = <a class="code" href="classvpgl__bundle__adjust__lsqr.html#ae78d890799ebc552dc1d563f916e81c6" title="The Cholesky factored inverse covariances for each image point.">factored_inv_covars_</a>[k];
<a name="l00148"></a>00148     fij[0] *= Sij(0,0);
<a name="l00149"></a>00149     fij[0] += fij[1]*Sij(0,1);
<a name="l00150"></a>00150     fij[1] *= Sij(1,1);
<a name="l00151"></a>00151   }
<a name="l00152"></a>00152 }
<a name="l00153"></a>00153 
<a name="l00154"></a>00154 
<a name="l00155"></a>00155 <span class="comment">//: Compute the sparse Jacobian in block form.</span>
<a name="l00156"></a>00156 <span class="keywordtype">void</span>
<a name="l00157"></a><a class="code" href="classvpgl__bundle__adjust__lsqr.html#a982d220602f9d60c2321403a3d91fffa">00157</a> <a class="code" href="classvpgl__bundle__adjust__lsqr.html#a982d220602f9d60c2321403a3d91fffa" title="Compute the sparse Jacobian in block form.">vpgl_bundle_adjust_lsqr::jac_blocks</a>(<a class="codeRef" doxygen="core_vnl.tag:../../../core/vnl/html/" href="../../../core/vnl/html/classvnl__vector.html">vnl_vector&lt;double&gt;</a> <span class="keyword">const</span>&amp; a,
<a name="l00158"></a>00158                                     <a class="codeRef" doxygen="core_vnl.tag:../../../core/vnl/html/" href="../../../core/vnl/html/classvnl__vector.html">vnl_vector&lt;double&gt;</a> <span class="keyword">const</span>&amp; b,
<a name="l00159"></a>00159                                     <a class="codeRef" doxygen="core_vnl.tag:../../../core/vnl/html/" href="../../../core/vnl/html/classvnl__vector.html">vnl_vector&lt;double&gt;</a> <span class="keyword">const</span>&amp; c,
<a name="l00160"></a>00160                                     vcl_vector&lt;<a class="codeRef" doxygen="core_vnl.tag:../../../core/vnl/html/" href="../../../core/vnl/html/classvnl__matrix.html">vnl_matrix&lt;double&gt;</a> &gt;&amp; A,
<a name="l00161"></a>00161                                     vcl_vector&lt;<a class="codeRef" doxygen="core_vnl.tag:../../../core/vnl/html/" href="../../../core/vnl/html/classvnl__matrix.html">vnl_matrix&lt;double&gt;</a> &gt;&amp; B,
<a name="l00162"></a>00162                                     vcl_vector&lt;<a class="codeRef" doxygen="core_vnl.tag:../../../core/vnl/html/" href="../../../core/vnl/html/classvnl__matrix.html">vnl_matrix&lt;double&gt;</a> &gt;&amp; C)
<a name="l00163"></a>00163 {
<a name="l00164"></a>00164   <span class="keyword">typedef</span> vnl_crs_index::sparse_vector::iterator sv_itr;
<a name="l00165"></a>00165   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i=0; i&lt;<a class="codeRef" doxygen="core_vnl.tag:../../../core/vnl/html/" href="../../../core/vnl/html/classvnl__sparse__lst__sqr__function.html#a428a60bdd3d570cf65830e023098e326">number_of_a</a>(); ++i)
<a name="l00166"></a>00166   {
<a name="l00167"></a>00167     <span class="comment">//: Construct the ith camera</span>
<a name="l00168"></a>00168     <a class="codeRef" doxygen="core_vnl.tag:../../../core/vnl/html/" href="../../../core/vnl/html/vnl__double__3x4_8h.html#af8f70e1a680571bb6a7064d7ab37e805">vnl_double_3x4</a> Pi = <a class="code" href="classvpgl__bundle__adjust__lsqr.html#a8cb230e10231dd8cfc17b33f3b478b96" title="construct the">param_to_cam_matrix</a>(i,a,c);
<a name="l00169"></a>00169 
<a name="l00170"></a>00170     <span class="comment">// This is semi const incorrect - there is no vnl_vector_ref_const</span>
<a name="l00171"></a>00171     <span class="keyword">const</span> <a class="codeRef" doxygen="core_vnl.tag:../../../core/vnl/html/" href="../../../core/vnl/html/classvnl__vector__ref.html">vnl_vector_ref&lt;double&gt;</a> ai(<a class="codeRef" doxygen="core_vnl.tag:../../../core/vnl/html/" href="../../../core/vnl/html/classvnl__sparse__lst__sqr__function.html#aa650f3c88ffb9139d6ddcc8f92df95fb">number_of_params_a</a>(i),
<a name="l00172"></a>00172                                     const_cast&lt;double*&gt;(a.<a class="codeRef" doxygen="core_vnl.tag:../../../core/vnl/html/" href="../../../core/vnl/html/classvnl__vector.html#a672822d3a059ac09909cb32a7be004a9">data_block</a>())+<a class="codeRef" doxygen="core_vnl.tag:../../../core/vnl/html/" href="../../../core/vnl/html/classvnl__sparse__lst__sqr__function.html#a215ac902994bd0298c6cc73f6026759e">index_a</a>(i));
<a name="l00173"></a>00173 
<a name="l00174"></a>00174     <a class="codeRef" doxygen="core_vnl.tag:../../../core/vnl/html/" href="../../../core/vnl/html/classvnl__crs__index.html#a015af1612c1409408234e2b9c7771ba2">vnl_crs_index::sparse_vector</a> row = <a class="codeRef" doxygen="core_vnl.tag:../../../core/vnl/html/" href="../../../core/vnl/html/classvnl__sparse__lst__sqr__function.html#a77c2fb0d7101cc684355b3864986245a">residual_indices_</a>.<a class="codeRef" doxygen="core_vnl.tag:../../../core/vnl/html/" href="../../../core/vnl/html/classvnl__crs__index.html#a1d1773106f6efda2257dc21f95d3a13c">sparse_row</a>(i);
<a name="l00175"></a>00175     <span class="keywordflow">for</span> (sv_itr r_itr=row.<a class="codeRef" doxygen="core_vnl.tag:../../../core/vnl/html/" href="../../../core/vnl/html/classvnl__vector.html#ade1c94ab8d54075269ef09d38e38b33b">begin</a>(); r_itr!=row.<a class="codeRef" doxygen="core_vnl.tag:../../../core/vnl/html/" href="../../../core/vnl/html/classvnl__vector.html#a49d0ea4f1e8825378c8adfec7de3c863">end</a>(); ++r_itr)
<a name="l00176"></a>00176     {
<a name="l00177"></a>00177       <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j = r_itr-&gt;second;
<a name="l00178"></a>00178       <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> k = r_itr-&gt;first;
<a name="l00179"></a>00179       <span class="comment">// This is semi const incorrect - there is no vnl_vector_ref_const</span>
<a name="l00180"></a>00180       <span class="keyword">const</span> <a class="codeRef" doxygen="core_vnl.tag:../../../core/vnl/html/" href="../../../core/vnl/html/classvnl__vector__ref.html">vnl_vector_ref&lt;double&gt;</a> bj(<a class="codeRef" doxygen="core_vnl.tag:../../../core/vnl/html/" href="../../../core/vnl/html/classvnl__sparse__lst__sqr__function.html#a2dd2b63684e8e57d9251301f236e77eb">number_of_params_b</a>(j),
<a name="l00181"></a>00181                                       const_cast&lt;double*&gt;(b.<a class="codeRef" doxygen="core_vnl.tag:../../../core/vnl/html/" href="../../../core/vnl/html/classvnl__vector.html#a672822d3a059ac09909cb32a7be004a9">data_block</a>())+<a class="codeRef" doxygen="core_vnl.tag:../../../core/vnl/html/" href="../../../core/vnl/html/classvnl__sparse__lst__sqr__function.html#a74039f92584458ff8c467f527040d452">index_b</a>(j));
<a name="l00182"></a>00182 
<a name="l00183"></a>00183       <a class="code" href="classvpgl__bundle__adjust__lsqr.html#af0b18f7dc3e1ba45d1cfca982a1d4b62" title="compute the Jacobian Aij.">jac_Aij</a>(i,j,Pi,ai,bj,c,A[k]); <span class="comment">// compute Jacobian A_ij</span>
<a name="l00184"></a>00184       <a class="code" href="classvpgl__bundle__adjust__lsqr.html#aa19fab18bbccc3f4d86d4d32318dc352" title="compute the Jacobian Bij.">jac_Bij</a>(i,j,Pi,ai,bj,c,B[k]); <span class="comment">// compute Jacobian B_ij</span>
<a name="l00185"></a>00185       <a class="code" href="classvpgl__bundle__adjust__lsqr.html#ae4065a298ee81a64df0d71bc7e65be3c" title="compute the Jacobian Cij.">jac_Cij</a>(i,j,Pi,ai,bj,c,C[k]); <span class="comment">// compute Jacobian C_ij</span>
<a name="l00186"></a>00186       <span class="keywordflow">if</span> (<a class="code" href="classvpgl__bundle__adjust__lsqr.html#a9f6115b617536cc3a4e76ad16486ebe6" title="Flag to enable covariance weighted errors.">use_covars_</a>){
<a name="l00187"></a>00187         <span class="keyword">const</span> <a class="codeRef" doxygen="core_vnl.tag:../../../core/vnl/html/" href="../../../core/vnl/html/classvnl__matrix.html">vnl_matrix&lt;double&gt;</a>&amp; Sij = <a class="code" href="classvpgl__bundle__adjust__lsqr.html#ae78d890799ebc552dc1d563f916e81c6" title="The Cholesky factored inverse covariances for each image point.">factored_inv_covars_</a>[k];
<a name="l00188"></a>00188         A[k] = Sij*A[k];
<a name="l00189"></a>00189         B[k] = Sij*B[k];
<a name="l00190"></a>00190         C[k] = Sij*C[k];
<a name="l00191"></a>00191       }
<a name="l00192"></a>00192     }
<a name="l00193"></a>00193   }
<a name="l00194"></a>00194 }
<a name="l00195"></a>00195 
<a name="l00196"></a>00196 
<a name="l00197"></a>00197 <span class="keywordtype">void</span>
<a name="l00198"></a><a class="code" href="classvpgl__bundle__adjust__lsqr.html#a88fc308da2bda0be57ef0075a5a3ea5e">00198</a> <a class="code" href="classvpgl__bundle__adjust__lsqr.html#a88fc308da2bda0be57ef0075a5a3ea5e" title="Use an M-estimator to compute weights.">vpgl_bundle_adjust_lsqr::compute_weight_ij</a>(<span class="keywordtype">int</span> <span class="comment">/*i*/</span>, <span class="keywordtype">int</span> <span class="comment">/*j*/</span>,
<a name="l00199"></a>00199                                            <a class="codeRef" doxygen="core_vnl.tag:../../../core/vnl/html/" href="../../../core/vnl/html/classvnl__vector.html">vnl_vector&lt;double&gt;</a> <span class="keyword">const</span>&amp; <span class="comment">/*ai*/</span>,
<a name="l00200"></a>00200                                            <a class="codeRef" doxygen="core_vnl.tag:../../../core/vnl/html/" href="../../../core/vnl/html/classvnl__vector.html">vnl_vector&lt;double&gt;</a> <span class="keyword">const</span>&amp; <span class="comment">/*bj*/</span>,
<a name="l00201"></a>00201                                            <a class="codeRef" doxygen="core_vnl.tag:../../../core/vnl/html/" href="../../../core/vnl/html/classvnl__vector.html">vnl_vector&lt;double&gt;</a> <span class="keyword">const</span>&amp; <span class="comment">/*c*/</span>,
<a name="l00202"></a>00202                                            <a class="codeRef" doxygen="core_vnl.tag:../../../core/vnl/html/" href="../../../core/vnl/html/classvnl__vector.html">vnl_vector&lt;double&gt;</a> <span class="keyword">const</span>&amp; fij,
<a name="l00203"></a>00203                                            <span class="keywordtype">double</span>&amp; weight)
<a name="l00204"></a>00204 {
<a name="l00205"></a>00205   <span class="keywordtype">double</span> u2 = fij.<a class="codeRef" doxygen="core_vnl.tag:../../../core/vnl/html/" href="../../../core/vnl/html/classvnl__vector.html#a51021e6fc0343c16f4faf8fb23ec13c3">squared_magnitude</a>()/<a class="code" href="classvpgl__bundle__adjust__lsqr.html#a35a0f5267d793d6266f710291061a7ce" title="The square of the scale of the robust estimator.">scale2_</a>;
<a name="l00206"></a>00206 
<a name="l00207"></a>00207   <span class="comment">// Beaton-Tukey</span>
<a name="l00208"></a>00208   weight = (u2 &gt; 1.0) ? 0.0 : 1 - u2;
<a name="l00209"></a>00209 
<a name="l00210"></a>00210   <span class="comment">// Cauchy</span>
<a name="l00211"></a>00211   <span class="comment">//weight = vcl_sqrt(1 / (1 + u2));</span>
<a name="l00212"></a>00212 }
<a name="l00213"></a>00213 
<a name="l00214"></a>00214 
<a name="l00215"></a>00215 <span class="comment">//: compute the 2x3 Jacobian of camera projection with respect to point location df/dpt where $f(pt) = P*pt$</span>
<a name="l00216"></a>00216 <span class="keywordtype">void</span> <a class="code" href="classvpgl__bundle__adjust__lsqr.html#a2f308daecddbdaac995de298d16cca7b" title="compute the 2x3 Jacobian of camera projection with respect to point location df/dpt where $f(pt) = P*...">vpgl_bundle_adjust_lsqr::</a>
<a name="l00217"></a><a class="code" href="classvpgl__bundle__adjust__lsqr.html#a2f308daecddbdaac995de298d16cca7b">00217</a> <a class="code" href="classvpgl__bundle__adjust__lsqr.html#a2f308daecddbdaac995de298d16cca7b" title="compute the 2x3 Jacobian of camera projection with respect to point location df/dpt where $f(pt) = P*...">jac_inhomg_3d_point</a>(<a class="codeRef" doxygen="core_vnl.tag:../../../core/vnl/html/" href="../../../core/vnl/html/vnl__double__3x4_8h.html#af8f70e1a680571bb6a7064d7ab37e805">vnl_double_3x4</a> <span class="keyword">const</span>&amp; P,
<a name="l00218"></a>00218                     <a class="codeRef" doxygen="core_vnl.tag:../../../core/vnl/html/" href="../../../core/vnl/html/classvnl__vector.html">vnl_vector&lt;double&gt;</a> <span class="keyword">const</span>&amp; pt,
<a name="l00219"></a>00219                     <a class="codeRef" doxygen="core_vnl.tag:../../../core/vnl/html/" href="../../../core/vnl/html/classvnl__matrix.html">vnl_matrix&lt;double&gt;</a>&amp; J)
<a name="l00220"></a>00220 {
<a name="l00221"></a>00221   <span class="keywordtype">double</span> denom = P(2,0)*pt[0] + P(2,1)*pt[1] + P(2,2)*pt[2] + P(2,3);
<a name="l00222"></a>00222   denom *= denom;
<a name="l00223"></a>00223 
<a name="l00224"></a>00224   <span class="keywordtype">double</span> txy = P(0,0)*P(2,1) - P(0,1)*P(2,0);
<a name="l00225"></a>00225   <span class="keywordtype">double</span> txz = P(0,0)*P(2,2) - P(0,2)*P(2,0);
<a name="l00226"></a>00226   <span class="keywordtype">double</span> tyz = P(0,1)*P(2,2) - P(0,2)*P(2,1);
<a name="l00227"></a>00227   <span class="keywordtype">double</span> tx  = P(0,0)*P(2,3) - P(0,3)*P(2,0);
<a name="l00228"></a>00228   <span class="keywordtype">double</span> ty  = P(0,1)*P(2,3) - P(0,3)*P(2,1);
<a name="l00229"></a>00229   <span class="keywordtype">double</span> tz  = P(0,2)*P(2,3) - P(0,3)*P(2,2);
<a name="l00230"></a>00230 
<a name="l00231"></a>00231   J(0,0) = ( txy*pt[1] + txz*pt[2] + tx) / denom;
<a name="l00232"></a>00232   J(0,1) = (-txy*pt[0] + tyz*pt[2] + ty) / denom;
<a name="l00233"></a>00233   J(0,2) = (-txz*pt[0] - tyz*pt[1] + tz) / denom;
<a name="l00234"></a>00234 
<a name="l00235"></a>00235   txy = P(1,0)*P(2,1) - P(1,1)*P(2,0);
<a name="l00236"></a>00236   txz = P(1,0)*P(2,2) - P(1,2)*P(2,0);
<a name="l00237"></a>00237   tyz = P(1,1)*P(2,2) - P(1,2)*P(2,1);
<a name="l00238"></a>00238   tx  = P(1,0)*P(2,3) - P(1,3)*P(2,0);
<a name="l00239"></a>00239   ty  = P(1,1)*P(2,3) - P(1,3)*P(2,1);
<a name="l00240"></a>00240   tz  = P(1,2)*P(2,3) - P(1,3)*P(2,2);
<a name="l00241"></a>00241 
<a name="l00242"></a>00242   J(1,0) = ( txy*pt[1] + txz*pt[2] + tx) / denom;
<a name="l00243"></a>00243   J(1,1) = (-txy*pt[0] + tyz*pt[2] + ty) / denom;
<a name="l00244"></a>00244   J(1,2) = (-txz*pt[0] - tyz*pt[1] + tz) / denom;
<a name="l00245"></a>00245 }
<a name="l00246"></a>00246 
<a name="l00247"></a>00247 
<a name="l00248"></a>00248 <span class="comment">//: compute the 2x3 Jacobian of camera projection with respect to camera center df/dC where $f(C) = [M | -M*C]*pt$</span>
<a name="l00249"></a><a class="code" href="classvpgl__bundle__adjust__lsqr.html#a7efcf8346e5e51b0f32051942f1abd76">00249</a> <span class="keywordtype">void</span> <a class="code" href="classvpgl__bundle__adjust__lsqr.html#a7efcf8346e5e51b0f32051942f1abd76" title="compute the 2x3 Jacobian of camera projection with respect to camera center df/dC where $f(C) = [M | ...">vpgl_bundle_adjust_lsqr::jac_camera_center</a>(<a class="codeRef" doxygen="core_vnl.tag:../../../core/vnl/html/" href="../../../core/vnl/html/vnl__double__3x3_8h.html#a6f4fae33245645d430d5cf35a5ef607c">vnl_double_3x3</a> <span class="keyword">const</span>&amp; M,
<a name="l00250"></a>00250                                                 <a class="codeRef" doxygen="core_vnl.tag:../../../core/vnl/html/" href="../../../core/vnl/html/classvnl__vector.html">vnl_vector&lt;double&gt;</a> <span class="keyword">const</span>&amp; C,
<a name="l00251"></a>00251                                                 <a class="codeRef" doxygen="core_vnl.tag:../../../core/vnl/html/" href="../../../core/vnl/html/classvnl__vector.html">vnl_vector&lt;double&gt;</a> <span class="keyword">const</span>&amp; pt,
<a name="l00252"></a>00252                                                 <a class="codeRef" doxygen="core_vnl.tag:../../../core/vnl/html/" href="../../../core/vnl/html/classvnl__matrix.html">vnl_matrix&lt;double&gt;</a>&amp; J)
<a name="l00253"></a>00253 {
<a name="l00254"></a>00254   <span class="comment">// compute by swapping the role of the camera center and point position</span>
<a name="l00255"></a>00255   <span class="comment">// then reused the jac_inhomg_3d_point code</span>
<a name="l00256"></a>00256   <a class="codeRef" doxygen="core_vnl.tag:../../../core/vnl/html/" href="../../../core/vnl/html/vnl__double__3x4_8h.html#af8f70e1a680571bb6a7064d7ab37e805">vnl_double_3x4</a> P;
<a name="l00257"></a>00257   P.update(M);
<a name="l00258"></a>00258   P.set_column(3,-(M*pt));
<a name="l00259"></a>00259   <a class="code" href="classvpgl__bundle__adjust__lsqr.html#a2f308daecddbdaac995de298d16cca7b" title="compute the 2x3 Jacobian of camera projection with respect to point location df/dpt where $f(pt) = P*...">jac_inhomg_3d_point</a>(P,C,J);
<a name="l00260"></a>00260 }
<a name="l00261"></a>00261 
<a name="l00262"></a>00262 
<a name="l00263"></a>00263 <span class="comment">//: compute the 2x3 Jacobian of camera projection with respect to camera rotation df/dr where $f(r) = K*rod_to_matrix(r)*[I | -C]*pt$</span>
<a name="l00264"></a>00264 <span class="comment">//  Here r is a Rodrigues vector, K is an upper triangular calibration matrix</span>
<a name="l00265"></a><a class="code" href="classvpgl__bundle__adjust__lsqr.html#ab1322570b766b493da049b07ea0dae81">00265</a> <span class="keywordtype">void</span> <a class="code" href="classvpgl__bundle__adjust__lsqr.html#ab1322570b766b493da049b07ea0dae81" title="compute the 2x3 Jacobian of camera projection with respect to camera rotation df/dr where $f(r) = K*r...">vpgl_bundle_adjust_lsqr::jac_camera_rotation</a>(<a class="codeRef" doxygen="core_vnl.tag:../../../core/vnl/html/" href="../../../core/vnl/html/vnl__double__3x3_8h.html#a6f4fae33245645d430d5cf35a5ef607c">vnl_double_3x3</a> <span class="keyword">const</span>&amp; K,
<a name="l00266"></a>00266                                                   <a class="codeRef" doxygen="core_vnl.tag:../../../core/vnl/html/" href="../../../core/vnl/html/classvnl__vector.html">vnl_vector&lt;double&gt;</a> <span class="keyword">const</span>&amp; C,
<a name="l00267"></a>00267                                                   <a class="codeRef" doxygen="core_vnl.tag:../../../core/vnl/html/" href="../../../core/vnl/html/classvnl__vector.html">vnl_vector&lt;double&gt;</a> <span class="keyword">const</span>&amp; r,
<a name="l00268"></a>00268                                                   <a class="codeRef" doxygen="core_vnl.tag:../../../core/vnl/html/" href="../../../core/vnl/html/classvnl__vector.html">vnl_vector&lt;double&gt;</a> <span class="keyword">const</span>&amp; pt,
<a name="l00269"></a>00269                                                   <a class="codeRef" doxygen="core_vnl.tag:../../../core/vnl/html/" href="../../../core/vnl/html/classvnl__matrix.html">vnl_matrix&lt;double&gt;</a>&amp; J)
<a name="l00270"></a>00270 {
<a name="l00271"></a>00271   vnl_double_3 t(pt[0]-C[0], pt[1]-C[1], pt[2]-C[2]);
<a name="l00272"></a>00272 
<a name="l00273"></a>00273   <span class="keyword">const</span> <span class="keywordtype">double</span>&amp; x = r[0];
<a name="l00274"></a>00274   <span class="keyword">const</span> <span class="keywordtype">double</span>&amp; y = r[1];
<a name="l00275"></a>00275   <span class="keyword">const</span> <span class="keywordtype">double</span>&amp; z = r[2];
<a name="l00276"></a>00276   <span class="keywordtype">double</span> x2 = x*x, y2 = y*y, z2 = z*z;
<a name="l00277"></a>00277   <span class="keywordtype">double</span> m2 = x2 + y2 + z2;
<a name="l00278"></a>00278 
<a name="l00279"></a>00279   <span class="comment">// special case for the identity rotation</span>
<a name="l00280"></a>00280   <span class="keywordflow">if</span> (m2 == 0.0)
<a name="l00281"></a>00281   {
<a name="l00282"></a>00282     <span class="keywordtype">double</span> inv_tz2 = 1.0/(t[2]*t[2]);
<a name="l00283"></a>00283     J(0,0) = -t[0]*t[1] * inv_tz2;
<a name="l00284"></a>00284     J(1,0) = -1 - t[1]*t[1] * inv_tz2;
<a name="l00285"></a>00285     J(0,1) = 1 + t[0]*t[0] * inv_tz2;
<a name="l00286"></a>00286     J(1,1) = t[0]*t[1] * inv_tz2;
<a name="l00287"></a>00287     J(0,2) = -t[1] / t[2];
<a name="l00288"></a>00288     J(1,2) = t[0] / t[2];
<a name="l00289"></a>00289   }
<a name="l00290"></a>00290   <span class="keywordflow">else</span>
<a name="l00291"></a>00291   {
<a name="l00292"></a>00292     <span class="keywordtype">double</span> <a class="codeRef" doxygen="core_vnl.tag:../../../core/vnl/html/" href="../../../core/vnl/html/vnl__vector_8h.html#a00626facb4f86efb8618a4c5f5c3c5f8">m</a> = vcl_sqrt(m2);  <span class="comment">// Rodrigues magnitude = rotation angle</span>
<a name="l00293"></a>00293     <span class="keywordtype">double</span> c = vcl_cos(m);
<a name="l00294"></a>00294     <span class="keywordtype">double</span> s = vcl_sin(m);
<a name="l00295"></a>00295 
<a name="l00296"></a>00296     <span class="comment">// common trig terms</span>
<a name="l00297"></a>00297     <span class="keywordtype">double</span> ct = (1-c)/m2;
<a name="l00298"></a>00298     <span class="keywordtype">double</span> st = s/m;
<a name="l00299"></a>00299 
<a name="l00300"></a>00300     <span class="comment">// derivative coefficients for common trig terms</span>
<a name="l00301"></a>00301     <span class="comment">// ds = d/dx_i{st}/x_i</span>
<a name="l00302"></a>00302     <span class="comment">// dc = d/dx_i{ct}/x_i</span>
<a name="l00303"></a>00303     <span class="keywordtype">double</span> dct = s/(m*m2);
<a name="l00304"></a>00304     <span class="keywordtype">double</span> dst = c/m2 - dct;
<a name="l00305"></a>00305     dct -=  2*(1-c)/(m2*m2);
<a name="l00306"></a>00306 
<a name="l00307"></a>00307     <span class="keywordtype">double</span> utc = t[2]*x*z + t[1]*x*y - t[0]*(y2+z2);
<a name="l00308"></a>00308     <span class="keywordtype">double</span> uts = t[2]*y - t[1]*z;
<a name="l00309"></a>00309     <span class="keywordtype">double</span> vtc = t[0]*x*y + t[2]*y*z - t[1]*(x2+z2);
<a name="l00310"></a>00310     <span class="keywordtype">double</span> vts = t[0]*z - t[2]*x;
<a name="l00311"></a>00311     <span class="keywordtype">double</span> wtc = t[0]*x*z + t[1]*y*z - t[2]*(x2+y2);
<a name="l00312"></a>00312     <span class="keywordtype">double</span> wts = t[1]*x - t[0]*y;
<a name="l00313"></a>00313 
<a name="l00314"></a>00314     <span class="comment">// projection of the point into normalized homogeneous coordinates</span>
<a name="l00315"></a>00315     <span class="comment">// should be equal to inv(K)*P*[pt|1]</span>
<a name="l00316"></a>00316     <span class="keywordtype">double</span> u = ct*utc + st*uts + t[0];
<a name="l00317"></a>00317     <span class="keywordtype">double</span> <a class="codeRef" doxygen="core_vgl.tag:../../../core/vgl/html/" href="../../../core/vgl/html/vgl__vector__2d_8h.html#a38bf1e5e0427bdeba2b469eea9befc23">v</a> = ct*vtc + st*vts + t[1];
<a name="l00318"></a>00318     <span class="keywordtype">double</span> w = ct*wtc + st*wts + t[2];
<a name="l00319"></a>00319 
<a name="l00320"></a>00320     <span class="keywordtype">double</span> w2 = w*w;
<a name="l00321"></a>00321 
<a name="l00322"></a>00322     <span class="keywordtype">double</span> dw = dct*x*wtc + ct*(t[0]*z - 2*t[2]*x)
<a name="l00323"></a>00323               + dst*x*wts + st*t[1];
<a name="l00324"></a>00324     J(0,0) = (w*(dct*x*utc + ct*(t[2]*z + t[1]*y)
<a name="l00325"></a>00325                   + dst*x*uts) - u*dw)/w2;
<a name="l00326"></a>00326     J(1,0) = (w*(dct*x*vtc + ct*(t[0]*y - 2*t[1]*x)
<a name="l00327"></a>00327                   + dst*x*vts - st*t[2]) - v*dw)/w2;
<a name="l00328"></a>00328 
<a name="l00329"></a>00329     dw = dct*y*wtc + ct*(t[1]*z - 2*t[2]*y)
<a name="l00330"></a>00330         + dst*y*wts - st*t[0];
<a name="l00331"></a>00331     J(0,1) = (w*(dct*y*utc + ct*(t[1]*x - 2*t[0]*y)
<a name="l00332"></a>00332                   + dst*y*uts + st*t[2]) - u*dw)/w2;
<a name="l00333"></a>00333     J(1,1) = (w*(dct*y*vtc + ct*(t[0]*x + t[2]*z)
<a name="l00334"></a>00334                   + dst*y*vts) - v*dw)/w2;
<a name="l00335"></a>00335 
<a name="l00336"></a>00336     dw = dct*z*wtc + ct*(t[0]*x + t[1]*y)
<a name="l00337"></a>00337         + dst*z*wts;
<a name="l00338"></a>00338     J(0,2) = (w*(dct*z*utc + ct*(t[2]*x - 2*t[0]*z)
<a name="l00339"></a>00339                   + dst*z*uts - st*t[1]) - u*dw)/w2;
<a name="l00340"></a>00340     J(1,2) = (w*(dct*z*vtc + ct*(t[2]*y - 2*t[1]*z)
<a name="l00341"></a>00341                   + dst*z*vts + st*t[0]) - v*dw)/w2;
<a name="l00342"></a>00342   }
<a name="l00343"></a>00343 
<a name="l00344"></a>00344   <span class="comment">// account for the calibration matrix</span>
<a name="l00345"></a>00345   J(0,0) *= K(0,0);
<a name="l00346"></a>00346   J(0,0) += J(1,0)*K(0,1);
<a name="l00347"></a>00347   J(1,0) *= K(1,1);
<a name="l00348"></a>00348   J(0,1) *= K(0,0);
<a name="l00349"></a>00349   J(0,1) += J(1,1)*K(0,1);
<a name="l00350"></a>00350   J(1,1) *= K(1,1);
<a name="l00351"></a>00351   J(0,2) *= K(0,0);
<a name="l00352"></a>00352   J(0,2) += J(1,2)*K(0,1);
<a name="l00353"></a>00353   J(1,2) *= K(1,1);
<a name="l00354"></a>00354 }
<a name="l00355"></a>00355 
<a name="l00356"></a>00356 
<a name="l00357"></a>00357 <span class="comment">//: Fast conversion of rotation from Rodrigues vector to matrix</span>
<a name="l00358"></a>00358 <a class="codeRef" doxygen="core_vnl.tag:../../../core/vnl/html/" href="../../../core/vnl/html/vnl__double__3x3_8h.html#a6f4fae33245645d430d5cf35a5ef607c">vnl_double_3x3</a>
<a name="l00359"></a><a class="code" href="classvpgl__bundle__adjust__lsqr.html#ab9543f9a398ba387c495a625c9b4c0cd">00359</a> <a class="code" href="classvpgl__bundle__adjust__lsqr.html#ab9543f9a398ba387c495a625c9b4c0cd" title="Fast conversion of rotation from Rodrigues vector to matrix.">vpgl_bundle_adjust_lsqr::rod_to_matrix</a>(<a class="codeRef" doxygen="core_vnl.tag:../../../core/vnl/html/" href="../../../core/vnl/html/classvnl__vector.html">vnl_vector&lt;double&gt;</a> <span class="keyword">const</span>&amp; r)
<a name="l00360"></a>00360 {
<a name="l00361"></a>00361   <span class="keywordtype">double</span> x2 = r[0]*r[0], y2 = r[1]*r[1], z2 = r[2]*r[2];
<a name="l00362"></a>00362   <span class="keywordtype">double</span> <a class="codeRef" doxygen="core_vnl.tag:../../../core/vnl/html/" href="../../../core/vnl/html/vnl__vector_8h.html#a00626facb4f86efb8618a4c5f5c3c5f8">m</a> = x2 + y2 + z2;
<a name="l00363"></a>00363   <span class="keywordtype">double</span> theta = vcl_sqrt(m);
<a name="l00364"></a>00364   <span class="keywordtype">double</span> s = vcl_sin(theta) / theta;
<a name="l00365"></a>00365   <span class="keywordtype">double</span> c = (1 - vcl_cos(theta)) / m;
<a name="l00366"></a>00366 
<a name="l00367"></a>00367   vnl_matrix_fixed&lt;double,3,3&gt; R(0.0);
<a name="l00368"></a>00368   R(0,0) = R(1,1) = R(2,2) = 1.0;
<a name="l00369"></a>00369   <span class="keywordflow">if</span> (m == 0.0)
<a name="l00370"></a>00370     <span class="keywordflow">return</span> R;
<a name="l00371"></a>00371 
<a name="l00372"></a>00372   R(0,0) -= (y2 + z2) * c;
<a name="l00373"></a>00373   R(1,1) -= (x2 + z2) * c;
<a name="l00374"></a>00374   R(2,2) -= (x2 + y2) * c;
<a name="l00375"></a>00375   R(0,1) = R(1,0) = r[0]*r[1]*c;
<a name="l00376"></a>00376   R(0,2) = R(2,0) = r[0]*r[2]*c;
<a name="l00377"></a>00377   R(1,2) = R(2,1) = r[1]*r[2]*c;
<a name="l00378"></a>00378 
<a name="l00379"></a>00379   <span class="keywordtype">double</span> t = r[0]*s;
<a name="l00380"></a>00380   R(1,2) -= t;
<a name="l00381"></a>00381   R(2,1) += t;
<a name="l00382"></a>00382   t = r[1]*s;
<a name="l00383"></a>00383   R(0,2) += t;
<a name="l00384"></a>00384   R(2,0) -= t;
<a name="l00385"></a>00385   t = r[2]*s;
<a name="l00386"></a>00386   R(0,1) -= t;
<a name="l00387"></a>00387   R(1,0) += t;
<a name="l00388"></a>00388 
<a name="l00389"></a>00389   <span class="keywordflow">return</span> R;
<a name="l00390"></a>00390 }
<a name="l00391"></a>00391 
</pre></div></div>
</div>


<hr class="footer"/><address class="footer"><small>
Generated on Wed May 1 2013 17:32:16 for core/vpgl by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.7.5.1
</small></address>

</body>
</html>
